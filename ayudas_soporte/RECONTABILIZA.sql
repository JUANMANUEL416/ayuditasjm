DROP PROC SPKH_CONTABILIZA_PROC_FECHAS
GO
CREATE PROC DBO.SPKH_CONTABILIZA_PROC_FECHAS
@PROCEDENCIA      VARCHAR(20),
@FECHAINI         DATETIME,
@FECHAFIN         DATETIME,
@USUARIO          VARCHAR(12),
@SYS_COMPUTERNAME VARCHAR(254), 
@COMPANIA         VARCHAR(2), 
@SEDE             VARCHAR(5)
AS
DECLARE @NROCOMPROBANTE VARCHAR(20)
DECLARE @REFERENCIA1    VARCHAR(40)
DECLARE @REFERENCIA2    VARCHAR(20)
DECLARE @ANO            VARCHAR(4)
DECLARE @MES            VARCHAR(2)
DECLARE @NOREFERENCIA   VARCHAR(20)
BEGIN
   IF @PROCEDENCIA = 'CAJA'
   BEGIN
      DECLARE @CLASE_FAC VARCHAR(5)
      DECLARE @CODCAJA   VARCHAR(4)
      DECLARE @CNSFACJ   VARCHAR(20)
      DECLARE FCJ_CURSOR CURSOR FOR
      SELECT FCJ.CODCAJA, FCJ.CNSFACJ, CLASE_FAC
      FROM   FCJ 
      WHERE  COALESCE(FCJ.DEAPERTURA,0) = 0 
      AND    COALESCE(FCJ.CERRADA,0)    = 1 
      AND    FCJ.ESTADO                <> 'A'
      AND    FCJ.FECHA                 >= @FECHAINI
      AND    FCJ.FECHA                  < @FECHAFIN
      AND    COALESCE(FCJ.CONTABILIZADA,0) = 0
      ORDER BY FCJ.FECHA
        
      OPEN FCJ_CURSOR
      FETCH NEXT FROM FCJ_CURSOR
      INTO @CODCAJA, @CNSFACJ, @CLASE_FAC
      
      WHILE @@FETCH_STATUS = 0
      BEGIN
         PRINT 'NROCOMPROBANTE='+@NROCOMPROBANTE
         IF @CLASE_FAC = 'COBRO'
         BEGIN
            EXEC SPK_CONTAB_CAJA_ING @CNSFACJ, @CODCAJA, @USUARIO ,@SYS_COMPUTERNAME, @COMPANIA, @SEDE, ''
         END   
         ELSE
         BEGIN
            IF @CLASE_FAC = 'PAGO'
            BEGIN
               EXEC SPK_CONTAB_CAJA_EGR @CNSFACJ, @CODCAJA, @USUARIO ,@SYS_COMPUTERNAME, @COMPANIA, @SEDE, ''
            END
         END

         FETCH NEXT FROM FCJ_CURSOR
         INTO @CODCAJA, @CNSFACJ, @CLASE_FAC
      END
      CLOSE FCJ_CURSOR
      DEALLOCATE FCJ_CURSOR
   END
END
GO   
