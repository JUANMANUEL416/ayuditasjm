/**************************************************************************************************/
IF EXISTS (SELECT name FROM sysobjects WHERE name = 'SPKH_FECHA_TARIFAS' AND type = 'P')
   DROP PROCEDURE SPKH_FECHA_TARIFAS
GO
/**************************************************************************************************/
CREATE PROC DBO.SPKH_FECHA_TARIFAS
AS
DECLARE @IDTARIFA    VARCHAR(5)
DECLARE @ITEM        INT
DECLARE @FECHAULT    DATETIME
DECLARE @FECHATARIFA DATETIME
DECLARE @VECES       INT
DECLARE @IDSERVICIO  VARCHAR(20)
DECLARE @NOITEM      INT
DECLARE @VECES2      INT
DECLARE @FECHAFINTARDV DATETIME
BEGIN
   SELECT @FECHAULT = DBO.FNK_DIA_DEL_MES(YEAR(GETDATE()),12,'ULTIMO')
   
   --SELECT @FECHAULT
   DECLARE TAR_CURSOR CURSOR FOR    
   SELECT IDTARIFA, ITEM, FECHAFIN FROM TARF
   --WHERE  YEAR(FECHAFIN)  = YEAR(@FECHAULT)
   --AND    MONTH(FECHAFIN) = MONTH(@FECHAULT)
   --AND    DAY(FECHAFIN)   = DAY(@FECHAULT)
   OPEN TAR_CURSOR    
   FETCH NEXT FROM TAR_CURSOR    
   INTO @IDTARIFA, @ITEM, @FECHATARIFA
   WHILE @@FETCH_STATUS = 0    
   BEGIN               
      SELECT @VECES = COALESCE(COUNT(*),0) FROM TARF WHERE IDTARIFA = @IDTARIFA AND FECHAINI > @FECHAULT
      IF @VECES = 0
      BEGIN
         UPDATE TARF SET FECHAFIN = FECHAFIN + 365   
         WHERE  IDTARIFA = @IDTARIFA
         AND    ITEM     = @ITEM
      END

      DECLARE TARDV_CURSOR CURSOR FOR    
      SELECT IDSERVICIO, NOITEM, FECHAFIN FROM TARDV WHERE IDTARIFA = @IDTARIFA
      OPEN TARDV_CURSOR    
      FETCH NEXT FROM TARDV_CURSOR    
      INTO @IDSERVICIO, @NOITEM, @FECHAFINTARDV
      WHILE @@FETCH_STATUS = 0    
      BEGIN               
         SELECT @VECES2 = COALESCE(COUNT(*),0) 
         FROM   TARDV   
         WHERE  IDTARIFA   = @IDTARIFA   
         AND    IDSERVICIO = @IDSERVICIO
         AND    FECHAINI   > @FECHAFINTARDV
         IF @VECES2 = 0
         BEGIN
            
            UPDATE TARDV SET FECHAFIN = @FECHAULT + 365
            WHERE  IDTARIFA = @IDTARIFA   
            AND    IDSERVICIO = @IDSERVICIO
            AND    NOITEM     = @NOITEM
         END
         FETCH NEXT FROM TARDV_CURSOR    
         INTO @IDSERVICIO, @NOITEM, @FECHAFINTARDV
      END
      CLOSE TARDV_CURSOR
      DEALLOCATE TARDV_CURSOR
      
      FETCH NEXT FROM TAR_CURSOR    
      INTO @IDTARIFA, @ITEM, @FECHATARIFA
   END
   CLOSE TAR_CURSOR
   DEALLOCATE TAR_CURSOR
END
GO

--BEGIN TRAN
--EXEC SPKH_FECHA_TARIFAS
--ROLLBACK

