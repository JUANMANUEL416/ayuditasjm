SELECT HADMF.* FROM   HADMF
WHERE  HADMF.N_FACTURA NOT IN (SELECT N_FACTURA FROM FTR WHERE ESTADO <> 'A')
AND    HADMF.ESTADO <> 'A'

SELECT FACTURADA, * FROM HADM WHERE NOADMISION = '0100000393'

SELECT HPRED.FACTURADA, HPRED.N_FACTURA, *
FROM   HPRED INNER JOIN HPRE ON HPRED.NOPRESTACION = HPRE.NOPRESTACION
WHERE  HPRE.NOADMISION = '0100000393'

SELECT * FROM FTR WHERE N_FACTURA = 'FH73402'
SELECT * FROM FTRD WHERE N_FACTURA = 'FH73402'
SELECT * FROM IMPFTR WHERE NOADMISION = '0100000393'

SELECT * FROM HCOB WHERE NOADMISION = '0100000393'
SELECT * FROM HCOBD WHERE NOADMISION = '0100000393'

SELECT * FROM FTR WHERE N_FACTURA = 'FH73401' --2010-11-10 00:00:00.000
SELECT * FROM FTR WHERE N_FACTURA = 'FH73403'

SELECT * FROM 


FTR
HCOBD
BEGIN TRAN
EXEC SPKH_CREA_FTR_TENIENDO_FTRD '0100000393', 'FH73402', '10/11/2010'
COMMIT
ROLLBACK

"FK_FTR_FTRLLAVE1"
SELECT HADM.IDAFILIADO, AFI.TIPOAFILIADO2, AFI.IDAFI_TITULAR 
FROM   HADM INNER JOIN AFI ON HADM.IDAFILIADO = AFI.IDAFILIADO
WHERE  NOADMISION = '0100000393'

SELECT * FROM AFI WHERE IDAFILIADO = '14039445'
SELECT * FROM TER WHERE IDTERCERO = '14039445'

SELECT * FROM HCINP

--001 
DROP PROC
SPKH_CREA_FTR_TENIENDO_FTRD
GO
CREATE PROC DBO.SPKH_CREA_FTR_TENIENDO_FTRD
@NOADMISION VARCHAR(16),
@NVOCONSEC  VARCHAR(16),
@FECHAFAC   DATETIME
AS
DECLARE @CNSFTR      VARCHAR(40)
DECLARE @IDAFILIADO  VARCHAR(20)
DECLARE @IDTERCERO   VARCHAR(20)
DECLARE @IDTERCEROF  VARCHAR(20)
DECLARE @IDPLAN      VARCHAR(6)
DECLARE @CCOSTO_ALTA VARCHAR(20)
DECLARE @IDAREA_ALTA VARCHAR(20)
DECLARE @IDTERPART   VARCHAR(20)
DECLARE @TV          VARCHAR(7)
DECLARE @ESMENOR     INT
DECLARE @DV          SMALLINT
DECLARE @TTEC        VARCHAR(10)
DECLARE @CUENTACXC   VARCHAR(16)
DECLARE @VRTOTAL           DECIMAL(14,2)
DECLARE @VRSERV            DECIMAL(14,2)
DECLARE @VRCOPA            DECIMAL(14,2)
DECLARE @VRPACO            DECIMAL(14,2)
--
DECLARE @VRDTO             DECIMAL(14,2)
DECLARE @VRABONO           DECIMAL(14,2)
DECLARE @TOTALFACTURA      DECIMAL(14,2)
DECLARE @EC                SMALLINT
DECLARE @USUARIO           VARCHAR(12)
--
DECLARE @CODUNG            VARCHAR(2)
DECLARE @CODPRG            VARCHAR(2)
DECLARE @DATO              VARCHAR(20)  
DECLARE @DATO3             VARCHAR(20)
BEGIN
      SELECT @CODUNG = DBO.FNK_CODUNG_CODPRG(@USUARIO,'CODUNG') 
      SELECT @CODPRG = DBO.FNK_CODUNG_CODPRG(@USUARIO,'CODPRG')
      SELECT @USUARIO = 'EBECHARA'
      
      SELECT @DATO = DATO FROM USVGS WHERE IDVARIABLE = 'IDMONEDABASE'                    
      SELECT @DATO3 = LEFT(DATO,20) FROM USVGS WHERE IDVARIABLE = 'IDFDEPFACTURACION'
            
      SELECT @CNSFTR     = CNSFTR FROM FTRD WHERE N_FACTURA = @NVOCONSEC

      SELECT @IDAFILIADO  = IDAFILIADO, @IDTERCERO = IDTERCERO, @IDPLAN = IDPLAN, @IDAREA_ALTA = IDAREA_ALTA, 
             @CCOSTO_ALTA = CCOSTO_ALTA  
      FROM   HADM WHERE NOADMISION = @NOADMISION

      SELECT @DV = COALESCE(DIASVTO,30), @TTEC = TIPOTERCONTABLE
      FROM   PPT WHERE IDTERCERO = @IDTERCERO AND IDPLAN = @IDPLAN
      
      SELECT @CUENTACXC = CUENTA FROM TTEC
      WHERE TIPO = @TTEC
        
      SELECT @TV = 'Credito'
      
      SELECT @EC = COALESCE(ENVIODICAJA,0) FROM TER WHERE IDTERCERO = @IDTERCERO
                        
      SELECT @IDTERPART     = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJTERCEROEXTERNO'
      --SELECT @IDPLANPART    = DATO FROM USVGS WHERE IDVARIABLE = 'IDPLANPART'
      --SELECT @TIPO_ADM_ATE  = DATO FROM USVGS WHERE IDVARIABLE = 'TIPO_ADM_ATE'
             
      IF @IDTERCERO = @IDTERPART 
      BEGIN   
         SELECT @TV = 'Contado'           
         SELECT @IDTERCEROF = @IDAFILIADO
		   SELECT @ESMENOR = ISNULL(MENOR_DE_EDAD,0) FROM AFI WHERE IDAFILIADO = @IDAFILIADO
         IF @ESMENOR = 1
         BEGIN
            SELECT @IDTERCEROF = IDAFI_TITULAR FROM  AFI WHERE IDAFILIADO = @IDAFILIADO
         END		
      END 
      ELSE
      BEGIN
         SELECT @IDTERCEROF = @IDTERCERO
		   SELECT @ESMENOR = ISNULL(MENOR_DE_EDAD,0) FROM AFI WHERE IDAFILIADO = @IDAFILIADO
		   IF @ESMENOR = 1
		   BEGIN
		      SELECT @IDTERCEROF = IDAFI_TITULAR FROM  AFI WHERE IDAFILIADO = @IDAFILIADO
		   END	
      END
           
      INSERT INTO FTR(CNSFCT, COMPANIA, CLASE, IDTERCERO, N_FACTURA, F_FACTURA, F_VENCE,
                      VR_TOTAL, COBRADOR, VENDEDOR, MONEDA, OCOMPRA, ESTADO, F_CANCELADO,
                      IDAFILIADO, EMPLEADO, NOREFERENCIA, PROCEDENCIA, TIPOFAC, OBSERVACION,
                      TIPOVENTA, VALORCOPAGO, DESCUENTO, VALORPCOMP, CREDITO, INDCARTERA,
                      INDCXC, MARCACONT, CONTABILIZADA, NROCOMPROBANTE, MARCA, INDASIGCXC,
                      IMPRESO, VALORSERVICIOS, CLASEANULACION, CNSLOG, USUARIOFACTURA, FECHAFAC,
                      MIVA, PIVA, VR_ABONOS, IDPLAN, FECHAPASOCXC, TIPOFIN, CNSFMAS, IDAREA_ALTA,
                      CCOSTO_ALTA, IDDEP, TIPOTTEC, CUENTACXC, CODUNG , CODPRG) 
      SELECT @CNSFTR, '01', 'C', @IDTERCEROF, @NVOCONSEC, @FECHAFAC, @FECHAFAC + @DV,
             0, NULL, NULL, LEFT(DBO.FNK_VALORVARIABLE('IDMONEDABASE'),2), NULL, 'P', NULL,   
             @IDAFILIADO, @USUARIO, @NOADMISION, 'SALUD', 'I', '', @TV, 0, 0, 0, 0, 
             0, 0, 0, 0, NULL, 0, 0, 0, 0, NULL, NULL, @USUARIO, GETDATE(), 0, 0, 0, 
             @IDPLAN, NULL, 'C', NULL, @IDAREA_ALTA, @CCOSTO_ALTA, DBO.FNK_VALORVARIABLE('IDFDEPFACTURACION'), @TTEC,
             @CUENTACXC, @CODUNG, @CODPRG
             
      SELECT @VRTOTAL = SUM(VR_TOTAL), @VRSERV = SUM(VLR_SERVICI), @VRCOPA = SUM(VLR_COPAGOS),
             @VRPACO  = SUM(VLR_PAGCOMP)
      FROM   FTRD 
      WHERE  N_FACTURA = @NVOCONSEC
            
      SELECT @VRCOPA = ROUND(@VRCOPA, 0)
            
	  -- MOD. JQUIROGA 20090425 - Manejo de Copago Externo
      UPDATE FTR SET VALORSERVICIOS = @VRSERV, VALORPCOMP = @VRPACO, COPAGO_INT = @VRCOPA, 
				 COPAGO_EXT = (SELECT ISNULL(VLR_COPAGOEXTERNO,0) FROM HADM WHERE NOADMISION = @NOADMISION),
				 VALORCOPAGO = @VRCOPA - (SELECT ISNULL(VLR_COPAGOEXTERNO,0) FROM HADM WHERE NOADMISION = @NOADMISION),
                     VR_TOTAL = @VRTOTAL
      WHERE  N_FACTURA = @NVOCONSEC

      -- CALCULO DE DESCUENTO   
      PRINT 'TERCERO DEL DESCUENTO = ' + @IDTERCERO
      SELECT @VRDTO = 0
      SELECT @VRABONO  = ISNULL(SUM(QXDING.VALOR),0) FROM QXDING 
      WHERE  NOINGRESO = @NOADMISION 
      AND    DEVUELTO  = 0   
                  
      UPDATE FTR SET DESCUENTO = @VRDTO, VR_ABONOS = @VRABONO
      WHERE  N_FACTURA = @NVOCONSEC
             
      SELECT @TOTALFACTURA = VALORSERVICIOS - VALORCOPAGO - VALORPCOMP -DESCUENTO -- OJO QUITE MENOS ABONOS
      FROM FTR WHERE N_FACTURA = @NVOCONSEC                                       -- OJO
            
      IF @TOTALFACTURA >= 0
      BEGIN
         UPDATE FTR SET VR_TOTAL = VALORSERVICIOS - VALORCOPAGO - VALORPCOMP -DESCUENTO -- OJO QUITE MENOS ABONOS
         WHERE  N_FACTURA = @NVOCONSEC      
      END
      ELSE
      BEGIN
         UPDATE FTR SET VR_TOTAL = 0
         WHERE  N_FACTURA = @NVOCONSEC    
      END
      
       INSERT INTO HCOBD (NOADMISION, COB_IDTERCERO, N_FACTURA, COB_VLRCUBRE, COB_OBSERVACION, FECHA)
       SELECT HADM.NOADMISION, HADM.IDTERCERO, FTR.N_FACTURA, FTR.VR_TOTAL, '', DBO.FNK_FECHA_SIN_MLS(GETDATE())
       FROM   HADM, FTR
       WHERE  HADM.NOADMISION = @NOADMISION
       AND    FTR.PROCEDENCIA = 'SALUD'
       AND    FTR.ESTADO     <> 'A'
       AND    ISNULL(FTR.TIPOANULACION,'') <> 'NC'
       AND    FTR.NOREFERENCIA = @NOADMISION         
      
END
GO    
