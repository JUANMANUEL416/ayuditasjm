
DROP TABLE #B
SELECT * FROM #B WHERE N_fACTURA='441725'
SELECT * INTO #B FROM PLANOFAS WHERE NOT EXISTS(SELECT * FROM FTR WHERE FTR.N_FACTURA=PLANOFAS.N_FACTURA)

SELECT * INTO #A FROM FTR WHERE SI=1  AND CNSFCT='SI00066873'

SELECT * INTO #C FROM PLANOFAS WHERE N_FACTURA='441725'

SELECT N_FACTURA, COUNT(*) FROM PLANOFAS
GROUP BY N_FACTURA
HAVING COUNT(*)>1

SELECT * FROM #A
SELECT DBO.FNK_COLUMNAS_TABLAS('FTR')


INSERT INTO FTR
SELECT CNSFCT+CAST(ROW_NUMBER() OVER(ORDER  BY #B.N_FACTURA  ASC) AS VARCHAR(4)), COMPANIA, CLASE, #B.IDTERCERO, #B.N_FACTURA, FFACTURA, FFACTURA+30, VRLFACTURA, COBRADOR, VENDEDOR, MONEDA, OCOMPRA, ESTADO, F_CANCELADO, IDAFILIADO, EMPLEADO, NOREFERENCIA, PROCEDENCIA, TIPOFAC, OBSERVACION, TIPOVENTA, TIPOCOPAGO, VALORCOPAGO, DESCUENTO, VALORPCOMP, CREDITO, INDCARTERA, INDCXC, MARCA, INDASIGCXC, MARCACONT, CONTABILIZADA, NROCOMPROBANTE, IMPRESO, VRLFACTURA, CLASEANULACION, CNSLOG, USUARIOFACTURA, FECHAFAC, MIVA, PIVA, VIVA, VR_ABONOS, IDPLAN, FECHAPASOCXC, TIPOFIN, CNSFMAS, IDAREA_ALTA, CCOSTO_ALTA, IDDEP, VLRNOTADB, VLRNOTACR, TIPOTTEC, RAZONANULACION, #B.CUENTACXC, IDAREA_FTR, CCOSTO_FTR, INDASIGENT, PLANDEPAGO, CUOTAS, FECHA_PP, PERIODODIAS, BANCO, TIPO_CUENTA, CTA_BCO, TIPOANULACION, CODUNG, CODPRG, CAPITADA, CP_CONVENIO, CP_MODALIDAD, CP_MES, CP_VLR_SERVICIOS, CP_VLR_COPAGOS, SYS_COMPUTERNAME, ITFC, CNSITFC, CP_VLR_PAGCOMP, PREFACTURA, COPAGO_INT, COPAGO_EXT, ALTOCOSTO, NROCONTROL, PAQUETE, CUENTACXC_RAD, ENPRESUPUESTO, CONSECUTIVOPTO, RECO, N_FACTURA_REEMPLAZA, IDSEDE, EQUIMARCA, SI, RDIAN, CNSRESOL, CASTIGADA, FACTURA_R, ENFACTORING, IDFACTORING, FECHACAP_INI, FECHACAP_FIN, CTAVIGENCIAANTE, FACTE, CNSRESOLFE, PREFIJODIANFE, CNSDIANFEFROM #B,#A---SELECT * INTO #D FROM FTRD WHERE CNSFTR='SI00066873'SELECT DBO.FNK_COLUMNAS_TABLAS('FTRD')INSERT INTO FTRDSELECT CNSFTR+CAST(ROW_NUMBER() OVER(ORDER  BY #B.N_FACTURA  ASC) AS VARCHAR(4)), IDPROVEEDOR, N_CUOTA, #B.FFACTURA, DB_CR, AREAPRESTACION, AREAFUNCONT, UBICACION, #B.VRLFACTURA, IMPUTACION, CCOSTO, PREFIJO, ANEXO, REFERENCIA, IDCIRUGIA, CANTIDAD, VALOR, #B.VRLFACTURA, VLR_COPAGOS, VLR_PAGCOMP, NOADMISION, NOPRESTACION, NOITEM, #B.N_FACTURA, SUBCCOSTO, PCOSTO, FECHAPREST, VLRNOTADB, VLRNOTACR, TIPO, IDIMPUESTO, IDCLASE, ITEM, VLRIMPUESTO, PIVA, VIVA, TIPOCONTRATOARS, ARSTIPOCONTRATO, ANO, MES, NAFILIADOS, IDPLAN, CODUNG, CODPRG, CUENTA_FIMPDV, ITFC, CNSITFC, CODEVAL, IDEMEDICA, PAQUETE, CUENTACR, #B.VRLFACTURA, IDARTICULO, NOLOTEFROM #B,#D---SELECT * INTO #E FROM #B WHERE F_RADICADO IS NOT NULLSELECT * FROM ENT WHERE CNSENTREGA='0100001311'SELECT * FROM ENTD WHERE CNSENTREGA='0100001311'INSERT INTO ENTDSELECT '0100001311',N_FACTURA,'FACTURAS',0,'','',VRLFACTURA,''  FROM #ESELECT * FROM #GSELECT  DISTINCT IDTERCERO INTO #G FROM #EDELETE #G WHERE IDTERCERO='9297634'SELECT * INTO #F FROM FCXC WHERE CNSCXC ='SI00000086'SELECT DBO.FNK_COLUMNAS_TABLAS('FCXC')SELECT DBO.FNK_NROCONCEROS_IZQUIERDAINSERT  INTO FCXCSELECT DBO.FNK_NROCONCEROS_IZQUIERDA(86+ROW_NUMBER() OVER(ORDER  BY #G.IDTERCERO  ASC),8,'SI'), FECHACXC, #G.IDTERCERO, IDMENSAJERO, F_VENCE, 0, F_RECIBIDO, QUIENRECIBIO, NOREFERENCIAEXT, USUARIO, COMPANIA, VALORDEVUELTO, CERRADA, TIENEGLOSAS, TIENEDEVOLUCION, CNSANT, ANTIGUA, VALORCXC, DEDUCCIONES, VALORCXCNETO, VLRPAGOS, VLRNOTADB, VLRNOTACR, SALDO, SALDONETO, VLRGLOSAS, VLRGLOSAS_R, VLREXTRA, OBSERVACION, NROCOMPROBANTE, PROCEDENCIA, ENPRESUPUESTO, MARCAFAC, ITFC, CNSITFC, CONTABILIZADA, OBSCARTA, CNSRP, IDSEDE, MODALIDAD, ATENCION, MES, ANO, REGIMEN, NROGUIA, USUCIERRA, F_CIERRA, ESTADO, COORFACTURACION, COORCARTERAFROM #F,#G-----SELECT  * FROM PLANOFAS WHERE NOT EXISTS(SELECT * FROM FTR WHERE FTR.N_FACTURA=PLANOFAS.N_FACTURA)SELECT * FROM PLANOFAS WHERE NOT EXISTS(SELECT * FROM FCXCD WHERE FCXCD.N_FACTURA=PLANOFAS.N_FACTURA)INSERT INTO ENTDSELECT '0100001312',N_FACTURA,'FACTURAS',0,'','',VRLFACTURA,'',FFACTURA  FROM #H ORDER BY FFACTURA DESCSELECT DISTINCT IDTERCERO INTO #I FROM #HINSERT  INTO FCXCSELECT DBO.FNK_NROCONCEROS_IZQUIERDA(102+ROW_NUMBER() OVER(ORDER  BY #I.IDTERCERO  ASC),8,'SI'), FECHACXC, #I.IDTERCERO, IDMENSAJERO, F_VENCE, 0, F_RECIBIDO, QUIENRECIBIO, NOREFERENCIAEXT, USUARIO, COMPANIA, VALORDEVUELTO, CERRADA, TIENEGLOSAS, TIENEDEVOLUCION, CNSANT, ANTIGUA, VALORCXC, DEDUCCIONES, VALORCXCNETO, VLRPAGOS, VLRNOTADB, VLRNOTACR, SALDO, SALDONETO, VLRGLOSAS, VLRGLOSAS_R, VLREXTRA, OBSERVACION, NROCOMPROBANTE, PROCEDENCIA, ENPRESUPUESTO, MARCAFAC, ITFC, CNSITFC, CONTABILIZADA, OBSCARTA, CNSRP, IDSEDE, MODALIDAD, ATENCION, MES, ANO, REGIMEN, NROGUIA, USUCIERRA, F_CIERRA, ESTADO, COORFACTURACION, COORCARTERAFROM #F,#IUPDATE FTR SET F_FACTURA='01/08/2018',F_VENCE='31/08/2018' WHERE N_FACTURA IN('441572','441401','441403','441377','440884','441375','405077')---COMPARACION DE SALDOSSELECT PLANOFAS.N_FACTURA,PLANOFAS.VRLFACTURA AS SALDOPLANO,FTR.VR_TOTAL AS SALDOK,(PLANOFAS.VRLFACTURA-FTR.VR_TOTAL) AS DIFE --INTO #JFROM PLANOFAS INNER JOIN FTR ON PLANOFAS.N_FACTURA=FTR.N_FACTURAWHERE PLANOFAS.VRLFACTURA<>FTR.VR_TOTALSELECT * FROM PLANOFAS WHERE SALDO<=0SELECT PLANOFAS.N_FACTURA,PLANOFAS.VRLFACTURA AS SALDOPLANO,FCXCD.VALORFACTURANETO AS SALDOK,(PLANOFAS.VRLFACTURA-FCXCD.VALORFACTURANETO) AS DIFE --INTO #JFROM PLANOFAS INNER JOIN FCXCD ON PLANOFAS.N_FACTURA=FCXCD.N_FACTURAWHERE PLANOFAS.PAGADO <>FCXCD.VLRPAGOSSELECT PLANOFAS.PAGADO,FCXCD.VLRPAGOSFROM PLANOFAS INNER JOIN FCXCD ON PLANOFAS.N_FACTURA=FCXCD.N_FACTURAWHERE PLANOFAS.PAGADO <>FCXCD.VLRPAGOSSELECT PLANOFAS.ACEPTADO,FCXCD.VLRNOTACRFROM PLANOFAS INNER JOIN FCXCD ON PLANOFAS.N_FACTURA=FCXCD.N_FACTURAWHERE PLANOFAS.ACEPTADO-FCXCD.VLRNOTACR >100AND  PLANOFAS.ACEPTADO-FCXCD.VLRNOTACR >-100SELECT PLANOFAS.SALDO,FCXCD.SALDONETOFROM PLANOFAS INNER JOIN FCXCD ON PLANOFAS.N_FACTURA=FCXCD.N_FACTURAWHERE  PLANOFAS.SALDO-FCXCD.SALDONETO >100AND  PLANOFAS.SALDO-FCXCD.SALDONETO >-100SELECT PLANOFAS.GLOSAREP,FCXCD.VLRGLOSAS_RFROM PLANOFAS INNER JOIN FCXCD ON PLANOFAS.N_FACTURA=FCXCD.N_FACTURAWHERE PLANOFAS.GLOSAREP<>FCXCD.VLRGLOSAS_RSELECT * FROM #J WHERE DIFE <100 AND DIFE>-100DELETE #J WHERE DIFE <100 AND DIFE>-100ALTER TABLE #J ADD VLRPAGO DECIMAL(14,2)DROP TABLE #KUPDATE #J SET VLRPAGOSELECT J.CNSCXC,J.N_FACTURA,J.DIFE,SUM(FPAGD.VLRFACTURA)PAGADO INTO #K --,FPAG.INGRESOFROM FPAG INNER JOIN FPAGD ON FPAG.CNSFPAG=FPAGD.CNSFPAG		  INNER JOIN #J J  ON FPAGD.CNSCXC=J.CNSCXC AND FPAGD.N_FACTURA=J.N_FACTURA WHERE FPAG.INGRESO='GLOSAS'GROUP BY J.CNSCXC,J.N_FACTURA,J.DIFE--,FPAG.INGRESO--SELECT 'EXEC SPK_RELIQUIDA_FTR '''+CNSCXC+''','''+N_FACTURA+'''' FROM #K WHERE DIFE-PAGADO=0SELECT * FROM #K WHERE DIFE-PAGADO=0ROLLBACKEXEC SPK_RELIQUIDA_FTRBEGIN TRANDELETE FPAGDFROM FPAGD INNER JOIN #K K ON FPAGD.CNSCXC=K.CNSCXC AND FPAGD.N_FACTURA=K.N_FACTURA		   INNER JOIN FPAG ON FPAG.CNSFPAG=FPAGD.CNSFPAGWHERE DIFE-PAGADO=0AND FPAG.INGRESO='BANCOS'COMMIT