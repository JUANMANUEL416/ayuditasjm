DECLARE @FECHA          DATETIME
DECLARE @NVOCONSEC      VARCHAR(20)='0200000002'
DECLARE @NVOCONSEC1     VARCHAR(20)='0222000000003442'  
DECLARE @NVOCONSEC2     VARCHAR(20)
DECLARE @DETALLE        VARCHAR(80)  
DECLARE @OK             INT
DECLARE @FOFI           DECIMAL(14,2)
DECLARE @CODCAJERO      VARCHAR(20)
DECLARE @CCOSTO         VARCHAR(20)
DECLARE @IDAREA         VARCHAR(20)
DECLARE @ITEM           INT = 1
DECLARE @CNSFACJ        VARCHAR(20)
DECLARE @CUENTACM       VARCHAR(16)
DECLARE @VALORTOTAL     DECIMAL(14,2)
DECLARE @ITEMFCJD       SMALLINT
DECLARE @CONCEPTO       VARCHAR(10)
DECLARE @VALORI         DECIMAL(14,2)
DECLARE @VALORT         DECIMAL(14,2)
DECLARE @CUECREDITO     VARCHAR(16)
DECLARE @COMPROBANTECM  VARCHAR(2)
DECLARE @COMPROBANTECM1 VARCHAR(20) 
DECLARE @CNSCMREE       VARCHAR(20)='0200000003'
DECLARE @IDTERCERO      VARCHAR(20)
DECLARE @CIUDAD         VARCHAR(5)
DECLARE @RESPONSABLE    VARCHAR(20)
DECLARE @N_FACTURA      VARCHAR(20)
DECLARE @COMPANIA       VARCHAR(2)='01'
DECLARE @USUARIO        VARCHAR(20)='0200000377'


   DECLARE CM_CURSOR CURSOR FOR      
   SELECT FCJD.CNSFACJ, FCJD.ITEM, CPCJ.CUENTA, ISNULL(FCJD.VALORTOTAL,0), FCJD.CONCEPTO, FCJD.AREAFUNCIONAL, ISNULL(FCJD.ESIMPTOGEN,0), -- MOD.JQUIROGA 20090808 (ISNULL(FCJD.ESIMPTOGEN,0))
          FCJ.CCOSTO, FCJ.IDTERCERO
   FROM   FCJD INNER JOIN FCJ  ON FCJD.CODCAJA  = FCJ.CODCAJA AND FCJD.CNSFACJ = FCJ.CNSFACJ
               INNER JOIN CPCJ ON FCJD.CONCEPTO = CPCJ.CODIGO   
   WHERE  FCJ.CNSCMREE  =  @CNSCMREE
   AND    FCJ.CLASE_FAC =  'PAGO'
   AND    FCJ.ESTADO    <> 'A'   
   
   OPEN CM_CURSOR  
   FETCH NEXT FROM CM_CURSOR  
   INTO @CNSFACJ, @ITEMFCJD, @CUENTACM, @VALORTOTAL, @CONCEPTO, @IDAREA, @OK, @CCOSTO, @IDTERCERO 
   WHILE @@FETCH_STATUS = 0  
   BEGIN        
      SELECT @ITEM = @ITEM +1
      SELECT @DETALLE = DESCRIPCION FROM CPCJ WHERE CODIGO = @CONCEPTO
      IF @OK = 1
      BEGIN
         SELECT @VALORI = @VALORI + @VALORTOTAL
      END
      
      IF @OK = 0
      BEGIN
         
         SELECT @VALORTOTAL = @VALORTOTAL - ISNULL(SUM(VALORTOTAL),0)
         FROM   FCJD 
         WHERE  CNSFACJ    = @CNSFACJ
         AND    ITEM       = @ITEMFCJD
         AND    ESIMPTOGEN = 1
         
         SELECT @VALORT = @VALORT + @VALORTOTAL      
         
         INSERT INTO FCXPD ( CNSFCXP, ITEM, IDSERVICIO, CANTIDAD, VALOR, ESTADO, N_PRESUP, ITEM_PRESUP, IDCLASEIMP, VLR_DESCUENTO,
                             VLR_IVA, VLR_NETO, NOLOTE, IDGRUPOSER, PREFIJO, CCOSTO, CCOSTO2, IDAREAH, IDAREA, NROCOMPROBANTE,
                             CUENTA_SER, VLR_GLOSAS, CUENTA_GLO, PROCEDENCIA, CODUNG, CODPRG )
         SELECT @NVOCONSEC, @ITEM, @CONCEPTO, 1, @VALORTOTAL, 'P', @CNSFACJ, @ITEMFCJD, CASE @OK WHEN 1 THEN '1' ELSE '0' END,
                0, 0, @VALORTOTAL, NULL, NULL, NULL, 
                @CCOSTO, NULL, NULL, @IDAREA, NULL, @CUENTACM, 0, NULL, 'CAJAMENOR', NULL, NULL
      END
      -- TEMPORAL DE CONTABILIZACION
      INSERT INTO MCHE( NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, REFERENCIA1, REFERENCIA2, 
                       REFERENCIA3, N_FACTURA, F_FACTURAREF, F_VENCE, GENERA, CLASE_GENERA, CNSPAGO, ITEMREF, USUARIO, FECHA, PREFIJO,
                       IDAREA, CLASECONT, ESTADO, PROCESO, VALOR_PORCIMP, BASE_IMP, PROCEDENCIA, REFERENCIA_PRO, CONCILIADO, CNSFCXCXP,
                       CODUNG, CODPRG, ERROR, IDOPERACION, FECHACONCILIACION, IDPROVEEDOR, ENPRESUPUESTO )
      SELECT @NVOCONSEC1, @COMPANIA, CASE @OK WHEN 1 THEN 'CR' ELSE 'DB' END, @CUENTACM, @IDTERCERO, @CCOSTO,
             @DETALLE, @VALORTOTAL, @CNSFACJ, @ITEMFCJD, NULL, NULL, NULL, NULL, 'Movimiento', NULL, NULL, NULL, @USUARIO, @FECHA, 
             @CONCEPTO, @IDAREA, 'S', '0', 'REEMBOLSO_CM', NULL, NULL, 'CAJAMENOR', @CNSFACJ, 0, NULL, NULL, NULL, NULL, NULL,
             NULL, NULL, 0 
      
      FETCH NEXT FROM CM_CURSOR  
      INTO @CNSFACJ, @ITEMFCJD, @CUENTACM, @VALORTOTAL, @CONCEPTO, @IDAREA, @OK, @CCOSTO, @IDTERCERO  
   END
   CLOSE CM_CURSOR
   DEALLOCATE CM_CURSOR
   EXEC SPK_CALCULOVALORESCXP @NVOCONSEC