IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FN_SION_DESCIFRAR' AND XTYPE='FN')
BEGIN
   DROP FUNCTION FN_SION_DESCIFRAR
END
GO
CREATE FUNCTION DBO.FN_SION_DESCIFRAR (@CLAVE VARCHAR(100)) 
RETURNS VARCHAR(100) 
WITH ENCRYPTION
AS
BEGIN
	DECLARE @TEXTO VARCHAR(100)=''
	DECLARE @POSICION INT
	DECLARE @LONGITUD INT
	SET @POSICION = 1
	SET @LONGITUD = LEN(@CLAVE)

	DECLARE @CLAVEENCRIPTADO VARCHAR(100)='ENCRIPTADOSION'
	DECLARE @POSICIONENCRIPTADA INT=1
	WHILE @POSICION <= @LONGITUD
	BEGIN
		SELECT @TEXTO = @TEXTO + CHAR(ASCII(SUBSTRING(@CLAVE, @POSICION, 1))^ASCII(SUBSTRING(@CLAVEENCRIPTADO, @POSICIONENCRIPTADA, 1)))
		SET @POSICION = @POSICION + 1
		SET @POSICIONENCRIPTADA=CASE WHEN LEN(@CLAVEENCRIPTADO)<@POSICIONENCRIPTADA+1 THEN 1 ELSE @POSICIONENCRIPTADA+1 END
	END

	RETURN @TEXTO
END