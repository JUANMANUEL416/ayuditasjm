IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME = 'SPK_EXPORT_TO_EXCEL_BCP' AND TYPE = 'P')
BEGIN
   DROP PROCEDURE SPK_EXPORT_TO_EXCEL_BCP
END
GO
CREATE  PROCEDURE SPK_EXPORT_TO_EXCEL_BCP      
@TABLENAME SYSNAME,      
@RUTA VARCHAR(1000),  
@FILENAME VARCHAR(500),
@DATOS    VARCHAR(100)     
AS      
DECLARE @SQLCMD VARCHAR(1000)      
DECLARE @SQLSHELL VARCHAR(1000)   
BEGIN  
   SELECT @SQLCMD = 'SELECT * FROM '+@TABLENAME       
   SELECT @SQLSHELL = 'EXEC XP_CMDSHELL ' +CHAR(39) +'BCP' +' "'+@SQLCMD+'"'+  ' QUERYOUT '+ '"'+@RUTA+@FILENAME+'"' +' -c -w, -T "'+CHAR(39)        
   IF COALESCE(@DATOS,'')<>''
   BEGIN
      SELECT @SQLSHELL = 'EXEC XP_CMDSHELL ' +CHAR(39) +'BCP' +' "'+@SQLCMD+'"'+  ' QUERYOUT '+ '"'+@RUTA+@FILENAME+'"'+' -c -w, -T '+@DATOS+''+CHAR(39)        
   END
   
   --PRINT @SQLSHELL
     
   EXECUTE  (@SQLSHELL)      

END 