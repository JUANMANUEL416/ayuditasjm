SELECT CIT.CONSECUTIVO,CIT.FECHA,CIT.IDAFILIADO,CIT.IDSERVICIO,SER.DESCSERVICIO,CIT.IDMEDICO,MED.NOMBRE,COALESCE(CIT.VALORTOTAL,0) VALOR_CITA,COALESCE(CIT.VALORCOPAGO,0)VALOR_COPAGO,FACTURADA,COALESCE(CIT.N_FACTURA,'SIN_FACTURA')N_FACTURA,
CASE WHEN CIT.CODCAJA='TFCJ' THEN 'Sin Traer' ELSE COALESCE(CIT.CODCAJA,'') END CODCAJA,CASE WHEN CIT.CODCAJA='TFCJ' THEN 'Sin Traer' ELSE COALESCE(CIT.NORECIBOCAJA,'') END NRORECIBO,'CITAS' PROCE
FROM CIT LEFT JOIN FTR ON CIT.N_FACTURA=FTR.N_FACTURA
         LEFT JOIN FCJ ON CIT.CODCAJA=FCJ.CODCAJA AND CIT.NORECIBOCAJA=FCJ.CNSFACJ
         LEFT JOIN AFI ON CIT.IDAFILIADO=AFI.IDAFILIADO
         LEFT JOIN SER ON CIT.IDSERVICIO=SER.IDSERVICIO
         LEFT JOIN MED ON CIT.IDMEDICO=MED.IDMEDICO
WHERE CIT.FECHA>=@1FECHAINI
AND CIT.FECHA<@2FECHAFIN
AND COALESCE(CIT.IDAFILIADO,'')<>''
AND COALESCE(CIT.CUMPLIDA,0)=1
UNION ALL
SELECT CIT.NOAUT,CIT.FECHA,CIT.IDAFILIADO,CIT.PREFIJO,PRE.NOM_PREFIJO,'','',COALESCE(CIT.VALORTOTAL,0) VALOR_CITA,COALESCE(CIT.VALORCOPAGO,0)VALOR_COPAGO,FACTURADA,COALESCE(CIT.N_FACTURA,'SIN_FACTURA')N_FACTURA,
CASE WHEN CIT.TIPOCAJA='TFCJ' AND COALESCE(CIT.VALORCOPAGO,0)>0 THEN 'Sin Traer' ELSE COALESCE(CIT.CODCAJA,'')  END CODCAJA,CASE WHEN CIT.TIPOCAJA='TFCJ' AND COALESCE(CIT.VALORCOPAGO,0)>0 THEN 'Sin Traer' ELSE COALESCE(CIT.NORECIBOCAJA,'') END NRORECIBO,'C.EXTER'
FROM AUT CIT LEFT JOIN FTR ON CIT.N_FACTURA=FTR.N_FACTURA
         LEFT JOIN FCJ ON CIT.CODCAJA=FCJ.CODCAJA AND CIT.NORECIBOCAJA=FCJ.CNSFACJ
         LEFT JOIN AFI ON CIT.IDAFILIADO=AFI.IDAFILIADO
         LEFT JOIN PRE ON CIT.PREFIJO=PRE.PREFIJO
WHERE CIT.FECHA>=@1FECHAINI
AND CIT.FECHA<@2FECHAFIN
AND CIT.ESTADO='Pendiente'
