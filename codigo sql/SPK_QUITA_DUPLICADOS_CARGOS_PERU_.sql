IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME = 'SPK_QUITA_DUPLICADOS_CARGOS_PERU' AND TYPE = 'P')
BEGIN
   DROP PROCEDURE SPK_QUITA_DUPLICADOS_CARGOS_PERU
END
GO
CREATE PROCEDURE DBO.SPK_QUITA_DUPLICADOS_CARGOS_PERU 
@IDSERVICIO  VARCHAR(20)  
WITH ENCRYPTION
AS  
DECLARE @EXISTE INT
DECLARE @EXIS   BIT
BEGIN  
   IF EXISTS( SELECT *  FROM HPRE INNER JOIN HPRED ON HPRE.NOPRESTACION=HPRED.NOPRESTACION
               WHERE HPRED.IDSERVICIO=@IDSERVICIO
               AND HPRED.FACTURADA=0
               AND COALESCE(HPRED.NOCOBRABLE,0)=0
               AND COALESCE(HPRED.ANULADO,0)=0
               GROUP BY HPRE.NOADMISION,HPRED.IDSERVICIO
               HAVING COUNT(*)>1
            )
   BEGIN
      SELECT @EXIS=1
      WHILE @EXIS =1
      BEGIN
         if (OBJECT_ID('tempdb.dbo.#A','U')) is not null
         drop table #A

         SELECT HPRE.NOADMISION,HPRED.IDSERVICIO INTO #A
         FROM HPRE INNER JOIN HPRED ON HPRE.NOPRESTACION=HPRED.NOPRESTACION
         WHERE HPRED.IDSERVICIO=@IDSERVICIO
         AND HPRED.FACTURADA=0
         AND COALESCE(HPRED.NOCOBRABLE,0)=0
         AND COALESCE(HPRED.ANULADO,0)=0
         GROUP BY HPRE.NOADMISION,HPRED.IDSERVICIO
         HAVING COUNT(*)>1

         if (OBJECT_ID('tempdb.dbo.#B','U')) is not null
         drop table #B

         SELECT HPRE.NOADMISION,MIN(HPRED.NOPRESTACION)NOPRESTACION INTO #B
         FROM HPRE INNER JOIN HPRED ON HPRE.NOPRESTACION=HPRED.NOPRESTACION
         WHERE EXISTS(SELECT * FROM #A WHERE #A.NOADMISION=HPRE.NOADMISION AND HPRED.IDSERVICIO=#A.IDSERVICIO)
         AND HPRED.FACTURADA=0
         AND HPRED.IDSERVICIO=@IDSERVICIO
         AND COALESCE(HPRED.NOCOBRABLE,0)=0
         AND COALESCE(HPRED.ANULADO,0)=0
         GROUP BY HPRE.NOADMISION
         ORDER BY NOADMISION

         if (OBJECT_ID('tempdb.dbo.#C','U')) is not null
         drop table #C

         SELECT NOPRESTACION,MIN(NOITEM)NOITEM INTO #C
         FROM HPRED 
         WHERE EXISTS(SELECT * FROM #B WHERE #B.NOPRESTACION=HPRED.NOPRESTACION)
         AND HPRED.FACTURADA=0
         AND HPRED.IDSERVICIO=@IDSERVICIO
         AND COALESCE(HPRED.NOCOBRABLE,0)=0
         AND COALESCE(HPRED.ANULADO,0)=0
         GROUP BY NOPRESTACION

         UPDATE HPRED SET NOCOBRABLE=1,ANULADO=1
         FROM HPRED  INNER JOIN #C ON HPRED.NOPRESTACION=#C.NOPRESTACION AND HPRED.NOITEM=#C.NOITEM
         
         IF NOT EXISTS( SELECT *  FROM HPRE INNER JOIN HPRED ON HPRE.NOPRESTACION=HPRED.NOPRESTACION
                     WHERE HPRED.IDSERVICIO=@IDSERVICIO
                     AND HPRED.FACTURADA=0
                     AND COALESCE(HPRED.NOCOBRABLE,0)=0
                     AND COALESCE(HPRED.ANULADO,0)=0
                     GROUP BY HPRE.NOADMISION,HPRED.IDSERVICIO
                     HAVING COUNT(*)>1
                  )
         BEGIN
            SELECT @EXIS=0
         END
     END
   END
END