
SELECT CONSECUTIVO,CIT.FECHA,CIT.IDMEDICO,CIT.IDAFILIADO,CIT.IDSERVICIO,SER.DESCSERVICIO,
CIT.FACTURABLE,CIT.FACTURADA,COALESCE(CIT.N_FACTURA,'SINFACTURA')N_FACTURA,COALESCE(CIT.VALORTOTAL,0)VALORTOTAL,COALESCE(CIT.VALORCOPAGO,0)VALORCOPAGO,
CASE WHEN COALESCE(CIT.VALORCOPAGO,0)>0 THEN
   CASE WHEN CIT.TIPOCAJA='TFCJ' THEN 'SIN RECUADO' WHEN CIT.TIPOCAJA='FCJ' THEN 
        CASE WHEN EXISTS(SELECT * FROM FCJ WHERE CODCAJA=CIT.CODCAJA AND CNSFACJ=CIT.NORECIBOCAJA AND ESTADO='P' AND CERRADA=1)
        THEN 'Recaudado'
        WHEN EXISTS(SELECT * FROM FCJ WHERE CODCAJA=CIT.CODCAJA AND CNSFACJ=CIT.NORECIBOCAJA AND ESTADO='P' AND CERRADA=0)
        THEN 'RecibosinCerrar'
         WHEN EXISTS(SELECT * FROM FCJ WHERE CODCAJA=CIT.CODCAJA AND CNSFACJ=CIT.NORECIBOCAJA AND ESTADO='A')
         THEN 'Anulado'
         ELSE 'OtroEstado' END
         ELSE 'SinGenerar'
    END
    ELSE 'SIN COPAGO'  
END 'RECIBOCAJA'
FROM CIT INNER JOIN AFI ON CIT.IDAFILIADO=AFI.IDAFILIADO
         INNER JOIN SER ON CIT.IDSERVICIO=SER.IDSERVICIO
WHERE VALORCOPAGO>0
AND COALESCE(CUMPLIDA,0)=1
ORDER BY FECHA