


SELECT IDTERCERO, COUNT(*) FROM FTR 
WHERE ESTADO='P' AND COALESCE(TIPOANULACION,'')<>'NC'
GROUP BY IDTERCERO
ORDER BY COUNT(*)DESC


SELECT CNSFCT,N_FACTURA FROM FTR WHERE IDTERCERO='830039670'


SELECT MAX(CNSFCT) FROM FTR  WHERE CNSFCT LIKE '0100%'
SELECT MAX(CNSFTR) FROM FTRD  WHERE CNSFTR LIKE '0100%'
SELECT MAX(N_FACTURA) FROM FTR  WHERE CNSFCT LIKE '0100%'

DECLARE @CNSFCT    VARCHAR(20)
DECLARE @N_FACTURA VARCHAR(20)
DECLARE @CNSFCT_N  VARCHAR(20)
DECLARE @N_FACTURA_N VARCHAR(20)
DECLARE @CNS_FACT    INT
DECLARE @CNS_CNSF    VARCHAR(20)
DECLARE @CNS_FTR     VARCHAR(20)

SET @CNS_CNSF='0100014705'
SET @CNS_FACT='21967'
SET @CNS_FTR='0100014705'

DECLARE PG_CURSOR CURSOR FOR  
SELECT TOP 1 CNSFCT,N_FACTURA FROM FTR WHERE IDTERCERO='899999026'   AND N_FACTURA<>'06_007883'
OPEN PG_CURSOR    
FETCH NEXT FROM PG_CURSOR    
INTO  @CNSFCT,@N_FACTURA
WHILE @@FETCH_STATUS = 0    
BEGIN
   PRINT 'CAMBIANDO FACTURA NRo.::::::::::'+@N_FACTURA
   SELECT * INTO #F FROM FTR WHERE N_FACTURA=@N_FACTURA
   SELECT * INTO #FD FROM FTRD WHERE N_FACTURA=@N_FACTURA
   
   SELECT @CNS_CNSF=@CNS_CNSF+1,@CNS_FACT=@CNS_FACT+1,@CNS_FTR='0'+LTRIM(RTRIM((STR(@CNS_FTR+1)))) 
      
   SELECT  @N_FACTURA_N='06_0'+LTRIM(RTRIM((STR(@CNS_FACT)))),@CNSFCT_N='0'+LTRIM(RTRIM((STR(@CNS_CNSF)))) 
   
   PRINT 'ESTA ES LA FACTURA NUEVA :::::::::::::'+@N_FACTURA_N
   
   UPDATE #F  SET CNSFCT=@CNSFCT_N,N_FACTURA=@N_FACTURA_N
   UPDATE #FD SET CNSFTR=@CNS_FTR,N_FACTURA=@N_FACTURA_N
   
   INSERT INTO FTR 
   SELECT * FROM #F
   
   INSERT INTO FTRD 
   SELECT * FROM #FD
   
   DROP TABLE #F
   DROP TABLE #FD
    
FETCH NEXT FROM PG_CURSOR    
INTO @CNSFCT,@N_FACTURA
END
CLOSE PG_CURSOR
DEALLOCATE PG_CURSOR


SELECT * FROM FTR WHERE N_FACTURA='06_0     21957'

--FTRDLLAVE
INSERT INTO FTRD
SELECT * FROM #FD

SELECT * FROM FTRD WHERE CNSFTR='100014703'

SELECT * FROM FTRD WHERE N_FACTURA='06_021968'
SELECT * FROM FTR WHERE N_FACTURA='06_021968'


SELECT 