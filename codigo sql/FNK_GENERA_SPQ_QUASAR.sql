IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FNK_GENERA_SPQ_QUASAR' AND XTYPE='FN')
BEGIN
   DROP FUNCTION FNK_GENERA_SPQ_QUASAR
END
GO
CREATE FUNCTION DBO.FNK_GENERA_SPQ_QUASAR(@TABLA VARCHAR(20),@LLAVE VARCHAR(20))
RETURNS VARCHAR(MAX)
AS
BEGIN
   DECLARE @TEXT VARCHAR(MAX)
   SELECT @TEXT  ='CREATE OR ALTER PROCEDURE DBO.SPQ_'+@TABLA+CHAR(13)
   SELECT @TEXT=@TEXT+'@JSON NVARCHAR(MAX) '+CHAR(13)
   SELECT @TEXT=@TEXT+'WITH ENCRYPTION'+CHAR(13)
   SELECT @TEXT=@TEXT+'AS  '+CHAR(13)
   SELECT @TEXT=@TEXT+'DECLARE @PARAMETROS     NVARCHAR(MAX), @MODELO  NVARCHAR(MAX), @METODO  VARCHAR(100),@USUARIO VARCHAR(20), @PRIMARY VARCHAR(20)'+CHAR(13)
   SELECT @TEXT=@TEXT+'BEGIN '+CHAR(13)
   SELECT @TEXT=@TEXT+'   SELECT @MODELO=MODELO, @METODO=METODO, @USUARIO=USUARIO,@PARAMETROS=PARAMETROS '+CHAR(13)
   SELECT @TEXT=@TEXT+'   FROM OPENJSON (@json) '+CHAR(13)
   SELECT @TEXT=@TEXT+'   WITH ( '+CHAR(13)
   SELECT @TEXT=@TEXT+'            MODELO         VARCHAR(100)      ''$.MODELO'', '+CHAR(13)
   SELECT @TEXT=@TEXT+'            METODO         VARCHAR(100)      ''$.METODO'', '+CHAR(13)
   SELECT @TEXT=@TEXT+'            USUARIO        VARCHAR(20)       ''$.USUARIO'', '+CHAR(13)
   SELECT @TEXT=@TEXT+'            PARAMETROS     NVARCHAR(MAX)  AS JSON '+CHAR(13)
   SELECT @TEXT=@TEXT+'   ) '+CHAR(13)
   SELECT @TEXT=@TEXT+'   '+CHAR(13)
   SELECT @TEXT=@TEXT+'   IF @METODO = ''INSERTAR'' '+CHAR(13)
   SELECT @TEXT=@TEXT+'   BEGIN   '+CHAR(13)
   SELECT @TEXT=@TEXT+'       SELECT @PRIMARY='+@LLAVE+CHAR(13)
   SELECT @TEXT=@TEXT+'       FROM OPENJSON (@PARAMETROS) WITH ( '+CHAR(13)
   SELECT @TEXT=@TEXT+'       '+@LLAVE+' VARCHAR(20) ''$.'+@LLAVE+''')'+CHAR(13)                    
   SELECT @TEXT=@TEXT+'      INSERT INTO '+@TABLA+'( '+(SELECT DBO.FNK_COLUMNAS_TABLAS(@TABLA))+')'+CHAR(13)
   SELECT @TEXT=@TEXT+'      SELECT '+(SELECT DBO.FNK_COLUMNAS_TABLAS(@TABLA))+CHAR(13)
   SELECT @TEXT=@TEXT+'       FROM OPENJSON (@PARAMETROS) WITH ( ' 
   SELECT @TEXT=@TEXT+'       '+(SELECT DBO.FNK_COLUMNAS_TABLAS_QUASAR(@TABLA,5))+')'+CHAR(13)
   SELECT @TEXT=@TEXT+'       '+CHAR(13)
   SELECT @TEXT=@TEXT+'       IF EXISTS(SELECT * FROM '+@TABLA+' WHERE '+@LLAVE+'= @PRIMARY ) '+CHAR(13)
   SELECT @TEXT=@TEXT+'       BEGIN '+CHAR(13)
   SELECT @TEXT=@TEXT+'          SELECT ''OK'' RESULTADO, @PRIMARY '+@LLAVE+CHAR(13)
   SELECT @TEXT=@TEXT+'       END '+CHAR(13)
   SELECT @TEXT=@TEXT+'       ELSE '+CHAR(13)
   SELECT @TEXT=@TEXT+'       BEGIN '+CHAR(13)
   SELECT @TEXT=@TEXT+'          SELECT ''ERROR'' RESULTADO, @PRIMARY '+@LLAVE+CHAR(13)
   SELECT @TEXT=@TEXT+'       END '+CHAR(13)
   SELECT @TEXT=@TEXT+'   END '+CHAR(13)
   SELECT @TEXT=@TEXT+'   IF @METODO=''CONSULTAUNO'' '+CHAR(13)
   SELECT @TEXT=@TEXT+'   BEGIN '+CHAR(13)
   SELECT @TEXT=@TEXT+'      SELECT @PRIMARY = '+@LLAVE +CHAR(13)
	SELECT @TEXT=@TEXT+'      FROM OPENJSON (@PARAMETROS) WITH ( '+CHAR(13)
   SELECT @TEXT=@TEXT+'           '+@LLAVE+'  VARCHAR(20)    ''$.'+@LLAVE+''')'+CHAR(13)
   SELECT @TEXT=@TEXT+'     '+CHAR(13)
   SELECT @TEXT=@TEXT+'      SELECT '+(SELECT DBO.FNK_COLUMNAS_TABLAS(@TABLA))+CHAR(13)
   SELECT @TEXT=@TEXT+'      FROM '+@TABLA +CHAR(13)
   SELECT @TEXT=@TEXT+'      WHERE '+@LLAVE+'= CASE WHEN COALESCE(@PRIMARY,'''')='''' THEN '+@LLAVE+' ELSE @PRIMARY END '+CHAR(13)
   SELECT @TEXT=@TEXT+'   END '+CHAR(13)
   SELECT @TEXT=@TEXT+'   '+CHAR(13)
   SELECT @TEXT=@TEXT+'   IF @METODO = ''EDITAR'' '+CHAR(13)
   SELECT @TEXT=@TEXT+'   BEGIN '+CHAR(13)
   SELECT @TEXT=@TEXT+'      UPDATE '+@TABLA+' SET '+(SELECT DBO.FNK_COLUMNAS_TABLAS_QUASAR(@TABLA,6))+CHAR(13)
   SELECT @TEXT=@TEXT+'      FROM '+@TABLA+' INNER JOIN ( SELECT '+(SELECT @LLAVE+'OR, '+DBO.FNK_COLUMNAS_TABLAS(@TABLA))+CHAR(13)
   SELECT @TEXT=@TEXT+'                                   FROM OPENJSON (@PARAMETROS) WITH ( '+CHAR(13)
   SELECT @TEXT=@TEXT+'                                   '+@LLAVE+'OR VARCHAR(20)''$.'+@LLAVE+'OR'','+CHAR(13)
   SELECT @TEXT=@TEXT+'                                   '+(SELECT DBO.FNK_COLUMNAS_TABLAS_QUASAR(@TABLA,5))+CHAR(13)
   SELECT @TEXT=@TEXT+'           ))AS  JS ON '+@TABLA+'.'+@LLAVE+' =JS.'+@LLAVE+'OR '+CHAR(13)
   SELECT @TEXT=@TEXT+'   '+CHAR(13)
   SELECT @TEXT=@TEXT+'       IF EXISTS(SELECT * FROM '+@TABLA+' WHERE '+@LLAVE+'= @PRIMARY ) '+CHAR(13)
   SELECT @TEXT=@TEXT+'       BEGIN '+CHAR(13)
   SELECT @TEXT=@TEXT+'          SELECT ''OK'' RESULTADO, @PRIMARY '+@LLAVE+CHAR(13)
   SELECT @TEXT=@TEXT+'       END '+CHAR(13)
   SELECT @TEXT=@TEXT+'       ELSE '+CHAR(13)
   SELECT @TEXT=@TEXT+'       BEGIN '+CHAR(13)
   SELECT @TEXT=@TEXT+'          SELECT ''ERROR'' RESULTADO, @PRIMARY '+@LLAVE+CHAR(13)
   SELECT @TEXT=@TEXT+'       END '+CHAR(13)
   SELECT @TEXT=@TEXT+'   END '+CHAR(13)
   SELECT @TEXT=@TEXT+'   IF @METODO = ''BORRAR'' '+CHAR(13)
   SELECT @TEXT=@TEXT+'   BEGIN '+CHAR(13)
   SELECT @TEXT=@TEXT+'       SELECT @PRIMARY='+@LLAVE+CHAR(13)
   SELECT @TEXT=@TEXT+'       FROM OPENJSON (@PARAMETROS) WITH ( '+CHAR(13)
   SELECT @TEXT=@TEXT+'       '+@LLAVE+' VARCHAR(20) ''$.'+@LLAVE+''')'+CHAR(13) 
   SELECT @TEXT=@TEXT+'       DELETE '+@TABLA+' WHERE '+@LLAVE+'=@PRIMARY '+CHAR(13) 
   SELECT @TEXT=@TEXT+'       IF NOT  EXISTS(SELECT * FROM '+@TABLA+' WHERE '+@LLAVE+'= @PRIMARY ) '+CHAR(13)
   SELECT @TEXT=@TEXT+'       BEGIN '+CHAR(13)
   SELECT @TEXT=@TEXT+'          SELECT ''OK'' RESULTADO, @PRIMARY '+@LLAVE+CHAR(13)
   SELECT @TEXT=@TEXT+'       END '+CHAR(13)
   SELECT @TEXT=@TEXT+'       ELSE '+CHAR(13)
   SELECT @TEXT=@TEXT+'       BEGIN '+CHAR(13)
   SELECT @TEXT=@TEXT+'          SELECT ''ERROR'' RESULTADO, @PRIMARY '+@LLAVE+CHAR(13)
   SELECT @TEXT=@TEXT+'       END '+CHAR(13)
   SELECT @TEXT=@TEXT+'    END '+CHAR(13)
   SELECT @TEXT=@TEXT+'END '+CHAR(13)

   RETURN @TEXT
END
