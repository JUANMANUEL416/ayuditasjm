
DECLARE @N_FACTURA  VARCHAR(20)=''
DECLARE @N_FACTURAX VARCHAR(20)=''

DECLARE @XML NVARCHAR(MAX)
DECLARE @XML1 NVARCHAR(MAX)
DECLARE @XML2 NVARCHAR(MAX)
DECLARE @XML3 VARCHAR(MAX)
DECLARE @XMLD VARCHAR(8000)
DECLARE @XMLF VARCHAR(8000)
DECLARE @XMLI VARCHAR(8000)
DECLARE @CODDOC VARCHAR(4)
DECLARE @PREFACT VARCHAR(4)
DECLARE @NFACTURA VARCHAR(20)
DECLARE @F_EMISION VARCHAR(10)
DECLARE @H_EMISION VARCHAR(8)
DECLARE @F_VENCE   VARCHAR(10)
DECLARE @TIPODOC   VARCHAR(2)
DECLARE @CODPAIS1  VARCHAR(3)
DECLARE @PERINICIAL  VARCHAR(10)
DECLARE @PERFINAL  VARCHAR(10)
DECLARE @NOADMISION  VARCHAR(20)
DECLARE @GUIA1  VARCHAR(20)
DECLARE @TGUIA1 VARCHAR(2)
DECLARE @GUIA2  VARCHAR(20)
DECLARE @TGUIA2 VARCHAR(2)
DECLARE @NITEMISOR VARCHAR(20)
DECLARE @DVEMISIOR VARCHAR(1)
DECLARE @RAZONSOCIALEMI VARCHAR(125)
DECLARE @CODPOSTALEMI VARCHAR(10)
DECLARE @DIRECCIOEMI VARCHAR(255)
DECLARE @CIUDADEMI   VARCHAR(45)
DECLARE @DEPAREMI   VARCHAR(45)
DECLARE @DISTRIEMI   VARCHAR(45)
DECLARE @PAISEMI   VARCHAR(2)
DECLARE @NITRECEP VARCHAR(20)
DECLARE @DVRECEP VARCHAR(1)
DECLARE @RAZONSOCIALRECEP VARCHAR(125)
DECLARE @CODPOSTALRECEP VARCHAR(10)
DECLARE @DIRECCIORECEP VARCHAR(255)
DECLARE @CIUDADRECEP   VARCHAR(45)
DECLARE @DEPARRECEP   VARCHAR(45)
DECLARE @DISTRIRECEP  VARCHAR(45)
DECLARE @PAISRECEP   VARCHAR(2)
DECLARE @CODSUNAT   VARCHAR(4)
DECLARE @VR_BRUTO DECIMAL(14,2)
DECLARE @VR_AFECTO DECIMAL(14,2)
DECLARE @VR_INAFECTO DECIMAL(14,2)
DECLARE @VR_COPAFECTO DECIMAL(14,2)
DECLARE @VR_COPINAFECTO DECIMAL(14,2)
DECLARE @VR_IVA DECIMAL(14,2)
DECLARE @NOMBREI VARCHAR(1)
DECLARE @CODIMP  VARCHAR(4)
DECLARE @IMP     VARCHAR(4)
DECLARE @CODINTER VARCHAR(4)
DECLARE @VR_BRUTO1 DECIMAL(14,2)
DECLARE @VR_NETO DECIMAL(14,2)
DECLARE @VR_IVA1 DECIMAL(14,2)
DECLARE @PVIVA   DECIMAL(7,2)
DECLARE @VR_LETRAS VARCHAR(2048)
DECLARE @DNI   VARCHAR(20)
DECLARE @NOMBEPTE VARCHAR(120)
DECLARE @VRCOPAGO DECIMAL(14,2)
DECLARE @LEYENDA VARCHAR(520)
DECLARE @BOLETA TABLE(N_FACTURA VARCHAR(20), VALOR DECIMAL(14,2),ID INT IDENTITY(1,1))
DECLARE @OBSERVACION VARCHAR(255)
DECLARE @NBOLE INT
DECLARE @B     INT
DECLARE @PORCO DECIMAL(7,4)
DECLARE @PORCOAFE DECIMAL(7,4)
DECLARE @PORCOINA DECIMAL(7,4)
DECLARE @ITEM VARCHAR(4)
DECLARE @CANTIDAD VARCHAR(4)
DECLARE @VALOR1 VARCHAR(20)
DECLARE @VALOR2 VARCHAR(20)
DECLARE @VALOR3 VARCHAR(20)
DECLARE @VALOR4 VARCHAR(20)
DECLARE @VALOR5 VARCHAR(20)
DECLARE @VALOR6 VARCHAR(20)
DECLARE @ANEXO VARCHAR(255)
DECLARE @REFERENCIA VARCHAR(20)
DECLARE @VALOR7 VARCHAR(20)
DECLARE @RPTA TABLE(ID INT,DATOS VARCHAR(500))
DECLARE @OK VARCHAR(10)
DECLARE @ERROR VARCHAR(500)
DECLARE @RUTAP VARCHAR(500)
DECLARE @AFECTA SMALLINT
DECLARE @MIXTA BIT
DECLARE @X1 BIT
DECLARE @NEWID VARCHAR(100)
DECLARE @RUTA VARCHAR(100)
DECLARE @SQL  VARCHAR(MAX)
DECLARE @FACTEP VARCHAR(10)
DECLARE @ESPAQ BIT
DECLARE @TIPOFACT VARCHAR(2) --INDIVIDUAL,MASIVA
BEGIN  

   SELECT @FACTEP=FTR.FACTEP,@CODDOC='0101',@X1=0,@PREFACT=REPLACE(FDIAN.PREFIJO,'-',''),@NFACTURA=FTR.N_FACTURA,@F_EMISION=REPLACE(CONVERT(VARCHAR,F_FACTURA,102),'.','-'),
   @H_EMISION=REPLACE(CONVERT(VARCHAR,F_FACTURA,108),'.','-'),@F_VENCE= REPLACE(CONVERT(VARCHAR,F_VENCE,102),'.','-'),@TIPODOC= CASE WHEN TIPOFIN='N' THEN '03' ELSE '01' END,@CODPAIS1='PEN',
   @PERINICIAL=REPLACE(CONVERT(VARCHAR,CAST('01/'+CASE WHEN MONTH(F_FACTURA)<10 THEN '0' ELSE '' END+CAST(MONTH(F_FACTURA) AS VARCHAR(2))+'/'+CAST(YEAR(F_FACTURA) AS VARCHAR(4))AS DATETIME),102),'.','-'),
   @PERFINAL=REPLACE(CONVERT(VARCHAR,CAST('01/'+CASE WHEN MONTH(F_FACTURA)<10 THEN '0' ELSE '' END+CAST(MONTH(F_FACTURA) AS VARCHAR(2))+'/'+CAST(YEAR(F_FACTURA) AS VARCHAR(4)) AS DATETIME)+29,102),'.','-'),
   @NOADMISION=FTR.NOREFERENCIA,@GUIA1='T001-00000001',@TGUIA1='09',@GUIA2='T001-00000002',@TGUIA2='99',
   @DNI=CASE WHEN LEN( AFI.DOCIDAFILIADO)=8 THEN  AFI.DOCIDAFILIADO 
		     WHEN LEN(AFI.DOCIDAFILIADO)<8 THEN REPLACE(SPACE(8-LEN(AFI.DOCIDAFILIADO)),SPACE(1),0)+AFI.DOCIDAFILIADO
			 ELSE RIGHT(AFI.DOCIDAFILIADO,8)
	   END,
   @NOMBEPTE=dbo.FNK_LIMPIATEXTO(AFI.NOMBREAFI,'0-9 A-Z().;:,'),
   @VRCOPAGO=FTR.VALORCOPAGO,@AFECTA=CASE WHEN FTR.VIVA>0 THEN 1 ELSE 0 END,
   @TIPOFACT=FTR.TIPOFAC
   FROM FTR INNER JOIN FDIAN ON FTR.CNSRESOL=FDIAN.CNSRESOL
            LEFT  JOIN AFI  ON FTR.IDAFILIADO=AFI.IDAFILIADO
   WHERE FTR.N_FACTURA=@N_FACTURA
   AND FDIAN.PROCEDENCIA=CASE WHEN FTR.TIPOFIN='N' THEN 'BOLE' ELSE 'FTR' END

   IF COALESCE(@FACTEP,'')='OK'
   BEGIN
	   PRINT 'Ya fue enviada a ACEPTA'
      RETURN
   END


   SELECT @NITEMISOR= NIT,@DVEMISIOR=6,@RAZONSOCIALEMI=dbo.FNK_LIMPIATEXTO(RAZONSOCIAL,'0-9 A-Z().;:,'),@CODPOSTALEMI='150101',@DIRECCIOEMI=DIRECCION,@CIUDADEMI=CIU.NOMBRE,
   @DEPAREMI=DEP.NOMBRE,@DISTRIEMI='',@PAISEMI='PE'
   FROM TER LEFT JOIN CIU ON TER.CIUDAD=CIU.CIUDAD
           LEFT JOIN DEP ON CIU.DPTO =DEP.DPTO
   WHERE IDTERCERO=DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO')


   SELECT @NITRECEP=CASE WHEN FTR.IDTERCERO=FTR.IDAFILIADO AND COALESCE(TER.RUC,'')<> '' AND FTR.TIPOFIN='C' THEN RUC ELSE NIT END ,
          @DVRECEP=CASE WHEN FTR.IDTERCERO=FTR.IDAFILIADO AND COALESCE(TER.RUC,'')<> '' AND FTR.TIPOFIN='C'  THEN 6 ELSE CONVERT(VARCHAR(1),CONVERT(INT,COALESCE(TGEN.VALOR1,0))) END,
          @RAZONSOCIALRECEP=dbo.FNK_LIMPIATEXTO(RAZONSOCIAL,'0-9 A-Z().;:,'),@CODPOSTALRECEP='150101',@DIRECCIORECEP=DIRECCION,@CIUDADRECEP=CIU.NOMBRE,
   @DEPARRECEP=DEP.NOMBRE,@DISTRIRECEP='',@PAISRECEP='PE',@CODSUNAT='0000'
   FROM FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
            LEFT JOIN CIU ON TER.CIUDAD=CIU.CIUDAD
            LEFT JOIN DEP ON CIU.DPTO =DEP.DPTO
            LEFT JOIN TGEN ON TER.TIPO_ID =TGEN.CODIGO AND TGEN.TABLA='General' AND TGEN.CAMPO='TIPOIDSUNAT'
   WHERE FTR.N_FACTURA=@N_FACTURA

   IF @DVRECEP='1' AND LEN(@NITRECEP)<>8
   BEGIN
	  SELECT @NITRECEP=CASE WHEN LEN(@NITRECEP)=8 THEN  @NITRECEP
		     WHEN LEN(@NITRECEP)<8 THEN REPLACE(SPACE(8-LEN(@NITRECEP)),SPACE(1),0)+@NITRECEP
			 ELSE RIGHT(@NITRECEP,8) END
   END

   SELECT @LEYENDA='SITEDS:'+CAST(COALESCE(dbo.FNK_LIMPIATEXTO(VENDEDOR,'0-9 A-Z'),'') AS VARCHAR(20)) FROM FTR WHERE N_FACTURA=@N_FACTURA

   SELECT @ESPAQ= CASE WHEN COUNT(*)>0 THEN 1 ELSE 0 END FROM FTRD WHERE N_FACTURA=@N_FACTURA AND COALESCE(PAQUETE,0)=2


	SELECT @LEYENDA=@LEYENDA+CASE WHEN COALESCE(PPT.PSEDEAT,0)=1 THEN '  // TIPO CONVENIO:'+ CASE WHEN @ESPAQ= 1 THEN  CAST(SUBSTRING(PPT.RESUMEN,1,50)  AS VARCHAR(50)) ELSE 'PAGO POR SERVICIO' END+' // SEDE ATENCION: '+COALESCE(SEDEAT,'00') ELSE '' END	
         FROM FTR LEFT JOIN HADMAUT ON FTR.VENDEDOR=HADMAUT.AUTORIZACION 
			 LEFT JOIN PPT ON FTR.IDTERCERO=PPT.IDTERCERO AND FTR.IDPLAN=PPT.IDPLAN
	WHERE FTR.N_FACTURA=@N_FACTURA
	AND HADMAUT.NOADMISION=@NOADMISION

   IF COALESCE(@ESPAQ,0)=1 
   BEGIN
      DECLARE @DATOSERPAQ VARCHAR(255)
      DECLARE @IDSERPAQ    VARCHAR(20)
      SELECT @DATOSERPAQ=LTRIM(RTRIM(OBS)),@IDSERPAQ=IDSERVICIOPAQUETE FROM HADM WHERE NOADMISION=@NOADMISION
      IF @DATOSERPAQ IS NULL OR LEN(COALESCE(@DATOSERPAQ,''))=0
      BEGIN
         SELECT @DATOSERPAQ=NULL
      END
   END

   SELECT @VR_IVA=VIVA,@NOMBREI='S',@CODIMP='1000',@IMP='IGV',@CODINTER='VAT'
   FROM FTR 
   WHERE FTR.N_FACTURA=@N_FACTURA

   SELECT  @VR_BRUTO=SUM((COALESCE(VALOR,0)*COALESCE(CANTIDAD,0))),@VR_BRUTO1=SUM((COALESCE(VALOR,0)*COALESCE(CANTIDAD,0))+CASE WHEN COALESCE(PIVA,0)>0 THEN  (COALESCE(VALOR,0)*COALESCE(CANTIDAD,0))*(PIVA/100)ELSE 0 END)
   FROM FTRD 
   WHERE FTRD.N_FACTURA=@N_FACTURA
   AND COALESCE(PAQUETE,0)<>2

   SELECT
   @VR_AFECTO=SUM(CASE WHEN COALESCE(PIVA,0)>0 THEN (COALESCE(VALOR,0)*COALESCE(CANTIDAD,0))-(COALESCE(FTRD.VLR_COPAGOS,0)) ELSE 0 END),
   @VR_INAFECTO=SUM(CASE WHEN COALESCE(PIVA,0)=0 THEN (COALESCE(VALOR,0)*COALESCE(CANTIDAD,0))-(COALESCE(FTRD.VLR_COPAGOS,0)) ELSE 0 END),
	@VR_COPAFECTO=SUM(CASE WHEN COALESCE(PIVA,0)>0 THEN COALESCE(FTRD.VLR_COPAGOS,0) ELSE 0 END ),
	@VR_COPINAFECTO=SUM(CASE WHEN COALESCE(PIVA,0)=0 THEN COALESCE(FTRD.VLR_COPAGOS,0) ELSE 0 END )
   FROM FTRD 
   WHERE FTRD.N_FACTURA=@N_FACTURA
   AND COALESCE(PAQUETE,0)<>2


   IF COALESCE(@VR_AFECTO,0)>0 AND COALESCE(@VR_INAFECTO,0)>0
   BEGIN
      SELECT @MIXTA=1
      SELECT @PORCOAFE=(@VR_COPAFECTO*100/@VR_AFECTO)/100,@PORCOINA=(@VR_COPINAFECTO*100/@VR_INAFECTO)/100
   END
   ELSE
   BEGIN
      SELECT @MIXTA=0,@PORCOAFE=0,@PORCOINA=0
   END


   SELECT @VR_NETO=VR_TOTAL,@VR_IVA1=COALESCE(VIVA,0),@VR_LETRAS= DBO.FNK_DE_VALORES_A_LETRAS(VR_TOTAL)
   FROM FTR 
   WHERE FTR.N_FACTURA=@N_FACTURA

   IF COALESCE(@VRCOPAGO,0)>0
   BEGIN
      SELECT @PORCO=(@VRCOPAGO*100/@VR_BRUTO)/100
   END
   ELSE
   BEGIN
      SELECT @PORCO=0.00
   END
   
   IF NOT EXISTS (SELECT * FROM FTR WHERE FTR.TIPOFIN='N' AND N_FACTURA=@N_FACTURA)
   BEGIN
      INSERT INTO @BOLETA(N_FACTURA,VALOR)
      SELECT HPRED.N_FACTURAH,SUM(COALESCE(HPRED.VALORCOPAGO,0))
      FROM FTRD INNER JOIN HPRED ON FTRD.NOPRESTACION=HPRED.NOPRESTACION AND HPRED.NOITEM=FTRD.NOITEM AND HPRED.N_FACTURA=FTRD.N_FACTURA
      WHERE FTRD.N_FACTURA=@N_FACTURA
      AND COALESCE(HPRED.N_FACTURAH,'')<>'' AND COALESCE(HPRED.VALORCOPAGO,0)>0
      GROUP BY HPRED.N_FACTURAH

      SELECT @OBSERVACION=''
      IF(SELECT COUNT(*) FROM @BOLETA)>0
      BEGIN
         SELECT @NBOLE=COUNT(*), @B=1 FROM @BOLETA

         SELECT @OBSERVACION='Boletas de Venta:'
         WHILE(@B<=@NBOLE)
         BEGIN
            SELECT @OBSERVACION=@OBSERVACION+' '+N_FACTURA+'  Valor: s/'+CONVERT(VARCHAR(20),VALOR)  FROM @BOLETA WHERE ID=@B AND  N_FACTURA<>'B001-ACEPTA'
            SELECT @B=@B+1
         END
      END
      ELSE
      BEGIN
         SELECT @OBSERVACION='Factura sin Boleta '
      END
   END
   --   END

   --      ELSE
   --      BEGIN
			--   SELECT @VR_BRUTO=@VR_BRUTO-@VRCOPAGO
   --         SELECT @VRCOPAGO=0.00
   --         SELECT @PORCO=0.00
			--   SELECT @X1=1
   --         --DECLARE @TCOPAGO DECIMAL(14,2)
   --         --SELECT @TCOPAGO=SUM(VALOR) FROM @BOLETA
   --         --SELECT @OBSERVACION='Valor Copago: s/'+CONVERT(VARCHAR(20),@TCOPAGO)
   --      END
   --   END
   --END
   --ELSE
   --BEGIN
      
   --END

   SELECT @VR_LETRAS=@VR_LETRAS+' SOLES'

   SELECT @XML='<?xml version="1.0" encoding="ISO-8859-1" standalone="no"?>'
   SELECT @XML=@XML+'<Invoice>' 
   SELECT @XML=@XML+'<ProfileID>'+@CODDOC+'</ProfileID>'
   SELECT @XML=@XML+'<ID>'+@N_FACTURAX+'</ID>'
   SELECT @XML=@XML+'<IssueDate>'+@F_EMISION+'</IssueDate>'
   SELECT @XML=@XML+'<IssueTime>'+@H_EMISION+'</IssueTime>'
   SELECT @XML=@XML+'<DueDate>'+@F_VENCE+'</DueDate>'
   SELECT @XML=@XML+'<InvoiceTypeCode>'+@TIPODOC+'</InvoiceTypeCode>'
   SELECT @XML=@XML+'<DocumentCurrencyCode>'+@CODPAIS1+'</DocumentCurrencyCode>'
   SELECT @XML=@XML+'<InvoicePeriod>'
   SELECT @XML=@XML+'<StartDate>'+@PERINICIAL+'</StartDate>'
   SELECT @XML=@XML+'<EndDate>'+@PERFINAL+'</EndDate>'
   SELECT @XML=@XML+'</InvoicePeriod>'
   SELECT @XML=@XML+'<OrderReference>'
   SELECT @XML=@XML+'<ID>'+@NOADMISION+'</ID>'
   SELECT @XML=@XML+'</OrderReference>'
   SELECT @XML=@XML+'<DespatchDocumentReference>'
   SELECT @XML=@XML+'<ID>'+@GUIA1+'</ID>'
   SELECT @XML=@XML+'<DocumentTypeCode>'+@TGUIA1+'</DocumentTypeCode>'
   SELECT @XML=@XML+'</DespatchDocumentReference>'
   SELECT @XML=@XML+'<AdditionalDocumentReference>'
   SELECT @XML=@XML+'<ID>'+@GUIA2+'</ID>'
   SELECT @XML=@XML+'<DocumentTypeCode>'+@TGUIA2+'</DocumentTypeCode>'
   SELECT @XML=@XML+'</AdditionalDocumentReference>'
   SELECT @XML=@XML+'<AccountingSupplierParty>'
   PRINT 'Encabezado...'+'xml'+@XML
   SELECT @XML=@XML+'<CustomerAssignedAccountID>'+@NITEMISOR+'</CustomerAssignedAccountID>'
   SELECT @XML=@XML+'<AdditionalAccountID>'+@DVEMISIOR+'</AdditionalAccountID>'
   SELECT @XML=@XML+'<Party>'
   SELECT @XML=@XML+'<PartyName>'
   SELECT @XML=@XML+'<Name>'+@RAZONSOCIALEMI+'</Name>'
   SELECT @XML=@XML+'</PartyName>'
   SELECT @XML=@XML+'<PostalAddress>'
   SELECT @XML=@XML+'<RegistrationAddress>'
   SELECT @XML=@XML+'<ID>'+@CODPOSTALEMI+'</ID>'
   SELECT @XML=@XML+'<AddressTypeCode>0000</AddressTypeCode>'
   SELECT @XML=@XML+'<StreetName>'+@DIRECCIOEMI+'</StreetName>'
   SELECT @XML=@XML+'<CitySubdivisionName>-</CitySubdivisionName>'
   SELECT @XML=@XML+'<CityName>'+@CIUDADEMI+'</CityName>'
   SELECT @XML=@XML+'<CountrySubentity>'+@DEPAREMI+'</CountrySubentity>'
   SELECT @XML=@XML+'<District>'+@DISTRIEMI+'</District>'
   SELECT @XML=@XML+'<Country>'
   SELECT @XML=@XML+'<IdentificationCode>PE</IdentificationCode>'
   SELECT @XML=@XML+'</Country>'
   SELECT @XML=@XML+'</RegistrationAddress>'
   SELECT @XML=@XML+'</PostalAddress>'
   SELECT @XML=@XML+'<PartyLegalEntity>'
   SELECT @XML=@XML+'<RegistrationName>'+REPLACE(@RAZONSOCIALEMI,CHAR(13),'')+'</RegistrationName>'
   SELECT @XML=@XML+'</PartyLegalEntity>'
   SELECT @XML=@XML+'</Party>'
   SELECT @XML=@XML+'</AccountingSupplierParty>'
   SELECT @XML=@XML+'<AccountingCustomerParty>'
   PRINT 'emisor...'+'xml'+@XML

   SELECT @XML=@XML+'<CustomerAssignedAccountID>'+@NITRECEP+'</CustomerAssignedAccountID>'
   SELECT @XML=@XML+'<AdditionalAccountID>'+@DVRECEP+'</AdditionalAccountID>'
   SELECT @XML=@XML+'<Party>'
   SELECT @XML=@XML+'<PostalAddress>'
   SELECT @XML=@XML+'<RegistrationAddress>'
   SELECT @XML=@XML+'<ID>'+@CODPOSTALRECEP+'</ID>'
   SELECT @XML=@XML+'<AddressTypeCode>0000</AddressTypeCode>'
   SELECT @XML=@XML+'<StreetName>'+@DIRECCIORECEP+'</StreetName>'
   SELECT @XML=@XML+'<CitySubdivisionName>-</CitySubdivisionName>'
   SELECT @XML=@XML+'<CityName>'+@CIUDADRECEP+'</CityName>'
   SELECT @XML=@XML+'<CountrySubentity>'+@DEPARRECEP+'</CountrySubentity>'
   SELECT @XML=@XML+'<District>'+@DISTRIRECEP+'</District>'
   SELECT @XML=@XML+'<Country>'
   SELECT @XML=@XML+'<IdentificationCode>PE</IdentificationCode>'
   SELECT @XML=@XML+'</Country>'
   SELECT @XML=@XML+'</RegistrationAddress>'
   SELECT @XML=@XML+'</PostalAddress>'
   SELECT @XML=@XML+'<PartyLegalEntity>'
   SELECT @XML=@XML+'<RegistrationName>'+REPLACE(@RAZONSOCIALRECEP,CHAR(13),'')+'</RegistrationName>'
   SELECT @XML=@XML+'</PartyLegalEntity>'
   SELECT @XML=@XML+'</Party>'
   PRINT 'Recpetor...'+'xml'+@XML

   SELECT @XML=@XML+'</AccountingCustomerParty>'
	SELECT @XML=@XML+'<PaymentForm>'
	SELECT @XML=@XML+'<PaymentMeansID>Contado</PaymentMeansID>'
	SELECT @XML=@XML+'</PaymentForm>'
   --SELECT @XML=@XML+'</AccountingCustomerParty>'
   SELECT @XML=@XML+'<TaxTotal>'
   SELECT @XML=@XML+'<TaxSubtotal>'
   IF @MIXTA=0
   BEGIN
      SELECT @XML=@XML+'<TaxableAmount>'+CONVERT(VARCHAR(20),@VR_NETO+CASE WHEN @AFECTA=0 THEN @VRCOPAGO ELSE 0 END -@VR_IVA1)+'</TaxableAmount>'
      SELECT @XML=@XML+'<TaxAmount>'+CONVERT(VARCHAR(20),@VR_IVA)+'</TaxAmount>'
      SELECT @XML=@XML+'<TaxCategory>'
   END
   ELSE
   BEGIN
      SELECT @XML=@XML+'<TaxableAmount>'+CONVERT(VARCHAR(20),@VR_AFECTO)+'</TaxableAmount>'
      SELECT @XML=@XML+'<TaxAmount>'+CONVERT(VARCHAR(20),@VR_IVA)+'</TaxAmount>'
      SELECT @XML=@XML+'<TaxCategory>'      
   END

   IF @AFECTA=1 
   BEGIN
      SELECT @XML=@XML+'<ID>'+@NOMBREI+'</ID>'
      SELECT @XML=@XML+'<TaxScheme>'
      SELECT @XML=@XML+'<ID>'+@CODIMP+'</ID>'
      SELECT @XML=@XML+'<Name>'+@IMP+'</Name>'
      SELECT @XML=@XML+'<TaxTypeCode>'+@CODINTER+'</TaxTypeCode>'
      SELECT @XML=@XML+'</TaxScheme>'
      IF @MIXTA=1
      BEGIN
         SELECT @XML=@XML+'</TaxCategory>'
         SELECT @XML=@XML+'</TaxSubtotal>'
         SELECT @XML=@XML+'</TaxTotal>'
         SELECT @XML=@XML+'<TaxTotal>'
         SELECT @XML=@XML+'<TaxSubtotal>'
         SELECT @XML=@XML+'<TaxableAmount>'+CONVERT(VARCHAR(20),@VR_INAFECTO+@VR_COPINAFECTO)+'</TaxableAmount>'
         SELECT @XML=@XML+'<TaxAmount>'+CONVERT(VARCHAR(20),0)+'</TaxAmount>'
         SELECT @XML=@XML+'<TaxCategory>'
		   SELECT @XML=@XML+'<ID>O</ID>'
		   SELECT @XML=@XML+'<TaxScheme>'
		   SELECT @XML=@XML+'<ID>9998</ID>'
		   SELECT @XML=@XML+'<Name>INA</Name>'
		   SELECT @XML=@XML+'<TaxTypeCode>FRE</TaxTypeCode>'
		   SELECT @XML=@XML+'</TaxScheme>' 
      END
   END
   ELSE
   BEGIN
		SELECT @XML=@XML+'<ID>O</ID>'
		SELECT @XML=@XML+'<TaxScheme>'
		SELECT @XML=@XML+'<ID>9998</ID>'
		SELECT @XML=@XML+'<Name>INA</Name>'
		SELECT @XML=@XML+'<TaxTypeCode>FRE</TaxTypeCode>'
		SELECT @XML=@XML+'</TaxScheme>'
   END
   SELECT @XML=@XML+'</TaxCategory>'
   SELECT @XML=@XML+'</TaxSubtotal>'
   SELECT @XML=@XML+'</TaxTotal>'

   IF COALESCE(@PORCO,0)>0 
   BEGIN
      IF @MIXTA=0
      BEGIN
         SELECT @XML=@XML+'<AllowanceCharge>'
         SELECT @XML=@XML+'<ChargeIndicator>false</ChargeIndicator>'
         IF @AFECTA=1
         BEGIN
            SELECT @XML=@XML+'<AllowanceChargeReasonCode>02</AllowanceChargeReasonCode>'
         END
         ELSE
         BEGIN
            SELECT @XML=@XML+'<AllowanceChargeReasonCode>03</AllowanceChargeReasonCode>'
         END
         SELECT @XML=@XML+'<MultiplierFactorNumeric>'+CONVERT(VARCHAR(20),@PORCO)+'</MultiplierFactorNumeric>' 
         SELECT @XML=@XML+'<Amount>'+CONVERT(VARCHAR(20),@VRCOPAGO)+'</Amount>'
         SELECT @XML=@XML+'<BaseAmount>'+CONVERT(VARCHAR(20),@VR_BRUTO)+'</BaseAmount>'
         SELECT @XML=@XML+'</AllowanceCharge>'  
      END
      ELSE
      BEGIN
         IF COALESCE(@VR_COPAFECTO,0)>0
         BEGIN
            SELECT @XML=@XML+'<AllowanceCharge>'
            SELECT @XML=@XML+'<ChargeIndicator>false</ChargeIndicator>'
            SELECT @XML=@XML+'<AllowanceChargeReasonCode>02</AllowanceChargeReasonCode>'
            SELECT @XML=@XML+'<MultiplierFactorNumeric>'+CONVERT(VARCHAR(20),@PORCOAFE)+'</MultiplierFactorNumeric>' 
            SELECT @XML=@XML+'<Amount>'+CONVERT(VARCHAR(20),@VR_COPAFECTO)+'</Amount>'
            SELECT @XML=@XML+'<BaseAmount>'+CONVERT(VARCHAR(20),@VR_AFECTO+@VR_COPAFECTO)+'</BaseAmount>'
            SELECT @XML=@XML+'</AllowanceCharge>'
         END
         IF COALESCE(@VR_COPINAFECTO,0)>0 
         BEGIN
            SELECT @XML=@XML+'<AllowanceCharge>'
            SELECT @XML=@XML+'<ChargeIndicator>false</ChargeIndicator>'
            SELECT @XML=@XML+'<AllowanceChargeReasonCode>03</AllowanceChargeReasonCode>'
            SELECT @XML=@XML+'<MultiplierFactorNumeric>'+CONVERT(VARCHAR(20),@PORCOINA)+'</MultiplierFactorNumeric>' 
            SELECT @XML=@XML+'<Amount>'+CONVERT(VARCHAR(20),@VR_COPINAFECTO)+'</Amount>'
            SELECT @XML=@XML+'<BaseAmount>'+CONVERT(VARCHAR(20),@VR_INAFECTO+@VR_COPINAFECTO)+'</BaseAmount>'
            SELECT @XML=@XML+'</AllowanceCharge>'
         END
      END
   END
   
   IF @MIXTA=0
   BEGIN
      SELECT @XML=@XML+'<LegalMonetaryTotal>'
      SELECT @XML=@XML+'<LineExtensionAmount>'+CONVERT(VARCHAR(20),@VR_BRUTO - CASE WHEN @AFECTA=0 THEN 0 ELSE COALESCE(@VRCOPAGO,0) END)+'</LineExtensionAmount>'
      SELECT @XML=@XML+'<TaxInclusiveAmount>'+CONVERT(VARCHAR(20),@VR_NETO+ CASE WHEN @AFECTA=1 THEN 0 ELSE COALESCE(@VRCOPAGO,0) END)+'</TaxInclusiveAmount>'
      IF COALESCE(@PORCO,0)>0 AND @AFECTA=0
      BEGIN
         SELECT @XML=@XML+' <AllowanceTotalAmount>'+CONVERT(VARCHAR(20),@VRCOPAGO)+'</AllowanceTotalAmount>'
      END
      SELECT @XML=@XML+'<PayableAmount>'+CONVERT(VARCHAR(20),@VR_NETO)+'</PayableAmount>'
      SELECT @XML=@XML+'<TaxAmount>'+CONVERT(VARCHAR(20),@VR_IVA1)+'</TaxAmount>'
      SELECT @XML=@XML+'</LegalMonetaryTotal>'
   END
   ELSE
   BEGIN
      SELECT @XML=@XML+'<LegalMonetaryTotal>'
      SELECT @XML=@XML+'<LineExtensionAmount>'+CONVERT(VARCHAR(20),@VR_BRUTO - COALESCE(@VR_COPAFECTO,0))+'</LineExtensionAmount>'
      SELECT @XML=@XML+'<TaxInclusiveAmount>'+CONVERT(VARCHAR(20),@VR_NETO+ COALESCE(@VR_COPINAFECTO ,0))+'</TaxInclusiveAmount>'
      SELECT @XML=@XML+' <AllowanceTotalAmount>'+CONVERT(VARCHAR(20),@VRCOPAGO)+'</AllowanceTotalAmount>'
      SELECT @XML=@XML+'<PayableAmount>'+CONVERT(VARCHAR(20),@VR_NETO)+'</PayableAmount>'
      SELECT @XML=@XML+'<TaxAmount>'+CONVERT(VARCHAR(20), @VR_IVA1)+'</TaxAmount>'
      SELECT @XML=@XML+'</LegalMonetaryTotal>'
   END  
   PRINT 'ANTES DE LOS DETALLES...'+'xml'+@XML

   PRINT 'DETALLES DE LA FACTURA' --FTRD
   IF @TIPOFACT<>'M'
   BEGIN
      SELECT @XML1=''
      DECLARE @N_CUOTA INT 
	   DECLARE XMLFTRD_CURSOR CURSOR FOR
      SELECT N_CUOTA FROM FTRD WHERE N_FACTURA=@N_FACTURA AND COALESCE(FTRD.PAQUETE,0)<>2
      AND COALESCE(VR_TOTAL,0)>0
      ORDER BY N_CUOTA ASC
	   OPEN XMLFTRD_CURSOR    
	   FETCH NEXT FROM XMLFTRD_CURSOR    
	   INTO @N_CUOTA
	   WHILE @@FETCH_STATUS = 0    
	   BEGIN 
         SELECT @ITEM=CONVERT(varchar(3),N_CUOTA),@CANTIDAD=CONVERT(varchar(4),CONVERT(INT,CEILING(FTRD.CANTIDAD))),
                @VALOR1=CONVERT(VARCHAR(20),CONVERT(DECIMAL(14,2),(COALESCE(VALOR,0)*COALESCE(FTRD.CANTIDAD,0))))- CASE WHEN COALESCE(PIVA,0)=0 AND @X1=1 THEN FTRD.VLR_COPAGOS ELSE 0 END,
                @VALOR2=CONVERT(VARCHAR(20),CONVERT(DECIMAL(14,2),((COALESCE(VALOR,0)*COALESCE(FTRD.CANTIDAD,0))- CASE WHEN  COALESCE(PIVA,0)=0 AND @X1=1 THEN FTRD.VLR_COPAGOS ELSE 0 END)*(CASE WHEN COALESCE(PIVA,0)>0 THEN PIVA/100 ELSE 0 END))),
                @VALOR3=CONVERT(VARCHAR(20),CONVERT(DECIMAL(14,2),COALESCE(VALOR,0)-(CASE WHEN  COALESCE(PIVA,0)=0  AND @X1=1 THEN FTRD.VLR_COPAGOS/FTRD.CANTIDAD ELSE 0 END) +CASE WHEN COALESCE(PIVA,0)>0  THEN (COALESCE(VALOR,0)*(CASE WHEN COALESCE(PIVA,0)>0 THEN PIVA/100 ELSE 0 END)) ELSE 0 END)),
                @VALOR4=CONVERT(VARCHAR(20),CONVERT(DECIMAL(14,2),COALESCE(VALOR,0)*(COALESCE(FTRD.CANTIDAD,0))))- CASE WHEN  COALESCE(PIVA,0)=0 AND @X1=1 THEN FTRD.VLR_COPAGOS ELSE 0 END,
                @VALOR5=CONVERT(VARCHAR(20),CONVERT(DECIMAL(14,2),((COALESCE(VALOR,0)*COALESCE(FTRD.CANTIDAD,0))- CASE WHEN  COALESCE(PIVA,0)=0 AND @X1=1 THEN FTRD.VLR_COPAGOS ELSE 0 END)*(CASE WHEN COALESCE(PIVA,0)>0 THEN PIVA/100 ELSE 1 END))),
                @VALOR6=CONVERT(VARCHAR(20),CONVERT(INT,COALESCE(PIVA,0))),
                @ANEXO= dbo.FNK_LIMPIATEXTO(SER.DESCRIPCION_CUPS,'0-9 A-Z '),
                @REFERENCIA=dbo.FNK_LIMPIATEXTO(SER.CODCUPS,'0-9 A-Z '),
                @VALOR7=CONVERT(VARCHAR(20),ROUND(COALESCE(VALOR,0),2,0))
                ,@AFECTA=CASE WHEN COALESCE(PIVA,0)>0 AND COALESCE(VIVA,0)>0 THEN 1 ELSE 0 END
         FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
         WHERE N_FACTURA=@N_FACTURA
         AND N_CUOTA=@N_CUOTA

         --IF @ESPAQ=1 AND @REFERENCIA=@IDSERPAQ AND @DATOSERPAQ IS NOT NULL
         --BEGIN
         --   SELECT @ANEXO=@DATOSERPAQ
         --END

         SELECT   @XML1=@XML1+'<InvoiceLine>'
		   SELECT   @XML1=@XML1+'<ID>'+@ITEM+'</ID>'
		   SELECT   @XML1=@XML1+'<InvoicedQuantity>'+@CANTIDAD+'</InvoicedQuantity>'
		   SELECT   @XML1=@XML1+'<UnitCode>NIU</UnitCode>'
		   SELECT   @XML1=@XML1+'<LineExtensionAmount>'+@VALOR1+'</LineExtensionAmount>'
		   SELECT   @XML1=@XML1+'<TaxAmount>'+@VALOR2+'</TaxAmount>'
		   SELECT   @XML1=@XML1+'<PricingReference>'
		   SELECT   @XML1=@XML1+'<AlternativeConditionPrice>'
		   SELECT   @XML1=@XML1+'<PriceAmount>'+@VALOR3+'</PriceAmount>'
		   SELECT   @XML1=@XML1+'<PriceTypeCode>01</PriceTypeCode>'
		   SELECT   @XML1=@XML1+'</AlternativeConditionPrice>'
		   SELECT   @XML1=@XML1+'</PricingReference>'
		   SELECT   @XML1=@XML1+'<TaxTotal>'
		   SELECT   @XML1=@XML1+'<TaxSubtotal>'
		   SELECT   @XML1=@XML1+'<TaxableAmount>'+@VALOR4+' </TaxableAmount>'
         IF @AFECTA=1
         BEGIN
		      SELECT   @XML1=@XML1+'<TaxAmount>'+@VALOR2+'</TaxAmount>'
         END
         ELSE
         BEGIN
            SELECT   @XML1=@XML1+'<TaxAmount>0.00</TaxAmount>'
         END
		   SELECT   @XML1=@XML1+'<TaxCategory>'
         IF @AFECTA=1
         BEGIN
		      SELECT   @XML1=@XML1+'<ID>S</ID>'
         END
         ELSE
         BEGIN
            SELECT   @XML1=@XML1+'<ID>O</ID>'
         END
		   SELECT   @XML1=@XML1+'<Percent>'+@VALOR6+'</Percent>'
         IF @AFECTA=1
         BEGIN
		      SELECT   @XML1=@XML1+'<TaxExemptionReasonCode>10</TaxExemptionReasonCode>'
         END
         ELSE
         BEGIN
            SELECT   @XML1=@XML1+'<TaxExemptionReasonCode>30</TaxExemptionReasonCode>'
         END
		   SELECT   @XML1=@XML1+'<TaxScheme>'
         IF @AFECTA=1
         BEGIN
		      SELECT   @XML1=@XML1+'<ID>1000</ID>'
		      SELECT   @XML1=@XML1+'<Name>IGV</Name>'
		      SELECT   @XML1=@XML1+'<TaxTypeCode>VAT</TaxTypeCode>'
         END
         ELSE
         BEGIN
      	   SELECT   @XML1=@XML1+'<ID>9998</ID>'
			   SELECT   @XML1=@XML1+'<Name>INA</Name>'
		      SELECT   @XML1=@XML1+'<TaxTypeCode>FRE</TaxTypeCode>'
         END
		   SELECT   @XML1=@XML1+'</TaxScheme>'
		   SELECT   @XML1=@XML1+'</TaxCategory>'
		   SELECT   @XML1=@XML1+'</TaxSubtotal>'
		   SELECT   @XML1=@XML1+'</TaxTotal>'
		   SELECT   @XML1=@XML1+'<Item>'
		   SELECT   @XML1=@XML1+'<Description>'+COALESCE(REPLACE(@ANEXO,CHAR(13),''),'')+'</Description>'
		   SELECT   @XML1=@XML1+'<SellersItemIdentification>'
		   SELECT   @XML1=@XML1+'<ID>'+@REFERENCIA +'</ID>'
		   SELECT   @XML1=@XML1+'</SellersItemIdentification>'
		   SELECT   @XML1=@XML1+'<CommodityClassification>'
		   SELECT   @XML1=@XML1+'<ItemClassificationCode>80131501</ItemClassificationCode>'
		   SELECT   @XML1=@XML1+'</CommodityClassification>'
		   SELECT   @XML1=@XML1+'</Item>'
		   SELECT   @XML1=@XML1+'<Price>'
		   SELECT   @XML1=@XML1+'<PriceAmount>'+@VALOR7+'</PriceAmount>'
		   SELECT   @XML1=@XML1+'</Price>'
	      SELECT   @XML1=@XML1+'</InvoiceLine>'
         --PRINT '@XML DETALLE '+@ITEM+' -- '+@XML
	   FETCH NEXT FROM XMLFTRD_CURSOR    
	   INTO @N_CUOTA
	   END
	   CLOSE XMLFTRD_CURSOR
	   DEALLOCATE XMLFTRD_CURSOR
   END
   ELSE
   BEGIN

      SELECT @ITEM=1,@CANTIDAD=1,
               @VALOR1=CONVERT(VARCHAR(20),CONVERT(DECIMAL(14,2),VALORSERVICIOS))- CASE WHEN COALESCE(PIVA,0)=0 AND @X1=1 THEN VALORCOPAGO ELSE 0 END,
               @VALOR2=CONVERT(VARCHAR(20),CONVERT(DECIMAL(14,2),(VALORSERVICIOS - CASE WHEN  COALESCE(PIVA,0)=0 AND @X1=1 THEN VALORCOPAGO ELSE 0 END)*(CASE WHEN COALESCE(PIVA,0)>0 THEN PIVA/100 ELSE 0 END))),
               @VALOR3=CONVERT(VARCHAR(20),CONVERT(DECIMAL(14,2),VALORSERVICIOS-(CASE WHEN  COALESCE(PIVA,0)=0  AND @X1=1 THEN VALORCOPAGO ELSE 0 END) +CASE WHEN COALESCE(PIVA,0)>0  THEN (COALESCE(VALORSERVICIOS,0)*(CASE WHEN COALESCE(PIVA,0)>0 THEN PIVA/100 ELSE 0 END)) ELSE 0 END)),
               @VALOR4=CONVERT(VARCHAR(20),CONVERT(DECIMAL(14,2),COALESCE(VALORSERVICIOS,0)*(COALESCE(1,0))))- CASE WHEN  COALESCE(PIVA,0)=0 AND @X1=1 THEN VALORCOPAGO ELSE 0 END,
               @VALOR5=CONVERT(VARCHAR(20),CONVERT(DECIMAL(14,2),((COALESCE(VALORSERVICIOS,0)*COALESCE(1,0))- CASE WHEN  COALESCE(PIVA,0)=0 AND @X1=1 THEN VALORCOPAGO ELSE 0 END)*(CASE WHEN COALESCE(PIVA,0)>0 THEN PIVA/100 ELSE 1 END))),
               @VALOR6=CONVERT(VARCHAR(20),CONVERT(INT,COALESCE(PIVA,0))),
               @ANEXO= dbo.FNK_LIMPIATEXTO(OBSERVACION,'0-9 A-Z '),
               @REFERENCIA=dbo.FNK_LIMPIATEXTO('001','0-9 A-Z '),
               @VALOR7=CONVERT(VARCHAR(20),ROUND(COALESCE(VALORSERVICIOS,0),2,0))
               ,@AFECTA=CASE WHEN COALESCE(PIVA,0)>0 AND COALESCE(VIVA,0)>0 THEN 1 ELSE 0 END
         FROM FTR WHERE N_FACTURA=@N_FACTURA

         SELECT @XML1=''

         SELECT   @XML1=@XML1+'<InvoiceLine>'
		   SELECT   @XML1=@XML1+'<ID>'+@ITEM+'</ID>'
		   SELECT   @XML1=@XML1+'<InvoicedQuantity>'+@CANTIDAD+'</InvoicedQuantity>'
		   SELECT   @XML1=@XML1+'<UnitCode>NIU</UnitCode>'
		   SELECT   @XML1=@XML1+'<LineExtensionAmount>'+@VALOR1+'</LineExtensionAmount>'
		   SELECT   @XML1=@XML1+'<TaxAmount>'+@VALOR2+'</TaxAmount>'
		   SELECT   @XML1=@XML1+'<PricingReference>'
		   SELECT   @XML1=@XML1+'<AlternativeConditionPrice>'
		   SELECT   @XML1=@XML1+'<PriceAmount>'+@VALOR3+'</PriceAmount>'
		   SELECT   @XML1=@XML1+'<PriceTypeCode>01</PriceTypeCode>'
		   SELECT   @XML1=@XML1+'</AlternativeConditionPrice>'
		   SELECT   @XML1=@XML1+'</PricingReference>'
		   SELECT   @XML1=@XML1+'<TaxTotal>'
		   SELECT   @XML1=@XML1+'<TaxSubtotal>'
		   SELECT   @XML1=@XML1+'<TaxableAmount>'+@VALOR4+' </TaxableAmount>'
         IF @AFECTA=1
         BEGIN
		      SELECT   @XML1=@XML1+'<TaxAmount>'+@VALOR2+'</TaxAmount>'
         END
         ELSE
         BEGIN
            SELECT   @XML1=@XML1+'<TaxAmount>0.00</TaxAmount>'
         END
		   SELECT   @XML1=@XML1+'<TaxCategory>'
         IF @AFECTA=1
         BEGIN
		      SELECT   @XML1=@XML1+'<ID>S</ID>'
         END
         ELSE
         BEGIN
            SELECT   @XML1=@XML1+'<ID>O</ID>'
         END
		   SELECT   @XML1=@XML1+'<Percent>'+@VALOR6+'</Percent>'
         IF @AFECTA=1
         BEGIN
		      SELECT   @XML1=@XML1+'<TaxExemptionReasonCode>10</TaxExemptionReasonCode>'
         END
         ELSE
         BEGIN
            SELECT   @XML1=@XML1+'<TaxExemptionReasonCode>30</TaxExemptionReasonCode>'
         END
		   SELECT   @XML1=@XML1+'<TaxScheme>'
         IF @AFECTA=1
         BEGIN
		      SELECT   @XML1=@XML1+'<ID>1000</ID>'
		      SELECT   @XML1=@XML1+'<Name>IGV</Name>'
		      SELECT   @XML1=@XML1+'<TaxTypeCode>VAT</TaxTypeCode>'
         END
         ELSE
         BEGIN
      	   SELECT   @XML1=@XML1+'<ID>9998</ID>'
			   SELECT   @XML1=@XML1+'<Name>INA</Name>'
		      SELECT   @XML1=@XML1+'<TaxTypeCode>FRE</TaxTypeCode>'
         END
		   SELECT   @XML1=@XML1+'</TaxScheme>'
		   SELECT   @XML1=@XML1+'</TaxCategory>'
		   SELECT   @XML1=@XML1+'</TaxSubtotal>'
		   SELECT   @XML1=@XML1+'</TaxTotal>'
		   SELECT   @XML1=@XML1+'<Item>'
		   SELECT   @XML1=@XML1+'<Description>'+COALESCE(REPLACE(@ANEXO,CHAR(13),''),'')+'</Description>'
		   SELECT   @XML1=@XML1+'<SellersItemIdentification>'
		   SELECT   @XML1=@XML1+'<ID>'+@REFERENCIA +'</ID>'
		   SELECT   @XML1=@XML1+'</SellersItemIdentification>'
		   SELECT   @XML1=@XML1+'<CommodityClassification>'
		   SELECT   @XML1=@XML1+'<ItemClassificationCode>80131501</ItemClassificationCode>'
		   SELECT   @XML1=@XML1+'</CommodityClassification>'
		   SELECT   @XML1=@XML1+'</Item>'
		   SELECT   @XML1=@XML1+'<Price>'
		   SELECT   @XML1=@XML1+'<PriceAmount>'+@VALOR7+'</PriceAmount>'
		   SELECT   @XML1=@XML1+'</Price>'
	      SELECT   @XML1=@XML1+'</InvoiceLine>'
   END
   PRINT '@XML DESPUES DE LOS DETALLES ='+@XML
   SELECT @XML2=''
  -- SELECT  @XML2=@XML2+' '+LTRIM(RTRIM(@XML1))
   SELECT  @XML2=@XML2+'<AdditionalInformation>'
	SELECT  @XML2=@XML2+'<AdditionalProperty>'
   SELECT  @XML2=@XML2+'<ID>1000</ID>'
   SELECT  @XML2=@XML2+'<Value>'+@VR_LETRAS+'</Value>'
   SELECT  @XML2=@XML2+'</AdditionalProperty>'
   SELECT  @XML2=@XML2+'</AdditionalInformation>'
   SELECT  @XML2=@XML2+'<Adjuntos>'
   SELECT  @XML2=@XML2+'<Paciente>'+COALESCE(@NOMBEPTE,'Sin_nombre')+'</Paciente>'
   SELECT  @XML2=@XML2+'<DNIPaciente>'+COALESCE(@DNI,'Sin_Dni')+'</DNIPaciente>'
   SELECT  @XML2=@XML2+'<Leyenda1>'+COALESCE(@LEYENDA,'')+'</Leyenda1>'
   SELECT  @XML2=@XML2+'<SubTotal>'+CONVERT(VARCHAR(20),(COALESCE(@VR_BRUTO,0)))+'</SubTotal>'
   IF COALESCE(@VRCOPAGO,0)>0
   BEGIN
      SELECT  @XML2=@XML2+'<TotalDescuento>'+CONVERT(VARCHAR(20),COALESCE(@VRCOPAGO,0))+'</TotalDescuento>'
   END
   IF LEN(LTRIM(RTRIM(@OBSERVACION)))>3
   BEGIN
      SELECT  @XML2=@XML2+'<Observacion>'+COALESCE(@OBSERVACION,'')+'</Observacion>'
   END
   SELECT  @XML2=@XML2+'</Adjuntos>'
   SELECT  @XML2=@XML2+'</Invoice>'

   
   SELECT @XML=REPLACE(@XML,'#','')
   SELECT @XML1=REPLACE(@XML1,'#','')
   SELECT @XML2=REPLACE(@XML2,'#','')
   SELECT @XML=REPLACE(@XML,CHAR(13),'')
   SELECT @XML1=REPLACE(@XML1,CHAR(13),'')
   SELECT @XML2=REPLACE(@XML2,CHAR(13),'')
   SELECT @XML=REPLACE(@XML,CHAR(10),'')
   SELECT @XML1=REPLACE(@XML1,CHAR(10),'')
   SELECT @XML2=REPLACE(@XML2,CHAR(10),'')


   -- PRINT 'TOTAL CARACTERS... '+LTRIM(RTRIM(STR(LEN(@XML))))
   -- PRINT 'TOTAL CARACTERS... '+LTRIM(RTRIM(STR(LEN(@XML1))))
   -- PRINT 'TOTAL CARACTERS... '+LTRIM(RTRIM(STR(LEN(@XML2))))

   --PRINT 'DEFINITIVO...'+CHAR(13)+LTRIM(RTRIM(@XML))
   --PRINT SUBSTRING(LTRIM(RTRIM(@XML1)),1,4000)
   --PRINT CHAR(13)
   --PRINT SUBSTRING(LTRIM(RTRIM(@XML1)),4001,8000)
   --PRINT LTRIM(RTRIM(@XML2))

   SELECT @XML=LTRIM(RTRIM(@XML))+LTRIM(RTRIM(@XML1))+LTRIM(RTRIM(@XML2))

   --CONSUMIR EL SERVICIO DE ACEPTA
   IF LEN(@XML)<=0
   BEGIN
      RAISERROR ('XLM no fue generado Correctamente',16,1)
      RETURN
   END
   IF RIGHT(LTRIM(RTRIM(@XML)),10)<>'</Invoice>'
   BEGIN
      RAISERROR ('XLM no fue generado Correctamente Falta ',16,1)
      RETURN
   END
   PRINT 'XML COMPLETO...'+'xml'+@XML

END