IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME = 'SPK_CREAMOV_BANCO_DATAFONO' AND TYPE = 'P')
BEGIN
   DROP PROCEDURE SPK_CREAMOV_BANCO_DATAFONO
END
GO
CREATE PROCEDURE DBO.SPK_CREAMOV_BANCO_DATAFONO
@CODCAJA VARCHAR(10),
@CNSFACJ VARCHAR(20)
WITH ENCRYPTION
AS  
DECLARE @TIPOPAGO VARCHAR(6)
DECLARE @BANCO VARCHAR(20)
DECLARE @SUCURSAL VARCHAR(10)
DECLARE @CTA_BCO VARCHAR(20)
DECLARE @CNSDOC VARCHAR(20)
DECLARE @NUMERODOCUMENTO VARCHAR(20)
DECLARE @RECBCO BIT
DECLARE @DATOEFE VARCHAR(10)
DECLARE @DATOCHQ VARCHAR(10)
DECLARE @VALOR DECIMAL(14,2)
DECLARE @ITEMBMOV INT
DECLARE @USUARIO VARCHAR(20)
DECLARE @SYS_COMPUTERNAME VARCHAR(255)
DECLARE @NROCOMPROBANTE VARCHAR(20)
DECLARE @FECHA DATETIME
DECLARE @IDTERCERO VARCHAR(20)
DECLARE @OBS VARCHAR(1024)
BEGIN
   
   SELECT @DATOCHQ = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJFPACHEQUE'
   SELECT @DATOEFE = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJFPAEFECTIVO'

   SELECT @IDTERCERO=IDAFILIADO,@USUARIO=USUARIO,@SYS_COMPUTERNAME=SYS_ComputerName,@FECHA=FECHA,@NROCOMPROBANTE=NROCOMPROBANTE,
          @OBS=OBSERVACION
   FROM FCJ 
   WHERE CODCAJA=@CODCAJA AND CNSFACJ=@CNSFACJ

   DECLARE PCJ_CURSOR CURSOR FOR  
   SELECT  PCJ.TIPOPAGO, PCJ.VALOR, PCJ.BANCO, PCJ.SUCURSAL, PCJ.CTA_BCO, 
            PCJ.CNSDOC, PCJ.NUMERODOCUMENTO, COALESCE(FPA.REQBCO,0) 
   FROM    PCJ LEFT JOIN FPA ON PCJ.TIPOPAGO = FPA.FORMAPAGO
   WHERE PCJ.CODCAJA=@CODCAJA
   AND PCJ.CNSFACJ=@CNSFACJ
   AND COALESCE(FPA.REQBCO,0)=1
   AND COALESCE(FPA.DATAFONO,0)=1
   OPEN    PCJ_CURSOR  
   FETCH NEXT FROM PCJ_CURSOR  
   INTO    @TIPOPAGO, @VALOR, @BANCO, @SUCURSAL, @CTA_BCO, @CNSDOC, @NUMERODOCUMENTO, @RECBCO
   WHILE @@FETCH_STATUS = 0  
   BEGIN  

      SELECT @ITEMBMOV = COALESCE(MAX(ITEM),0)+1 FROM BMOV 
      WHERE  CTA_BCO = @CTA_BCO AND SUCURSAL=@SUCURSAL 
      AND    BANCO   = @BANCO 

      IF  @ITEMBMOV IS NULL
      SELECT @ITEMBMOV = 1
      INSERT INTO BMOV(BANCO, SUCURSAL, CTA_BCO, ITEM, FECHAOPERACION,
                        NODOCUMENTO, NOTRANSFOPER, IDOPERACION, VLROPERACION,
                        DESCRIPCION, USUARIO, SYS_ComputerName, SALDOANTES,
                        SALDODESP, TIPOCOBROFIN, PROCEDENCIA, ESTADO, CONTABILIZADA, NROCOMPROBANTE,
                        CODCAJA, CNSFACJ) 
      SELECT @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV, @FECHA,
            @CNSFACJ, NULL, DBO.FNK_VALORVARIABLE('IDOFINCAJADB'), 0, @OBS,
            @USUARIO, @SYS_COMPUTERNAME, 0, 0, NULL, 'CAJA', 'C', 1, @NROCOMPROBANTE,
            @CODCAJA, @CNSFACJ
                    
      INSERT INTO BMOVD(BANCO, SUCURSAL, CTA_BCO, ITEM, RENGLON, FORMAPAGO,
                        BANCODOC, NODOCUMENTO, VLRITEM, PROCEDENCIA, CODCAJA,
                        CNSFACJ, IDTERCERO) 
      SELECT @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV, 1, 
            @TIPOPAGO, @BANCO, @NUMERODOCUMENTO,  @VALOR, 'CAJA', @CODCAJA, @CNSFACJ, @IDTERCERO
                    
      EXEC SPK_TOT_BMOV @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV 
      --EXEC SPK_OK_BMOV @CSGBANCO, @CSGSUCURSAL, @CSGCTA_BCO, @ITEMBMOV,@USUARIO,@SYS_COMPUTERNAME,@COMPANIA,@SEDE,@NROCOMPROBANTE
      EXEC SPK_OK_BMOV @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV,@USUARIO,@SYS_COMPUTERNAME,'01','01',@NROCOMPROBANTE
              
     
      FETCH NEXT FROM PCJ_CURSOR  
      INTO @TIPOPAGO, @VALOR, @BANCO, @SUCURSAL, @CTA_BCO, @CNSDOC, @NUMERODOCUMENTO, @RECBCO
   END            
   CLOSE PCJ_CURSOR  
   DEALLOCATE PCJ_CURSOR 
END

       