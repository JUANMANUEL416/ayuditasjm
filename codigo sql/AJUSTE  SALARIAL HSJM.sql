-- 4.5
-- 
SELECT * FROM NEMPFD WHERE CNSPAGO='01201604P30-2'
   --01201602P30-1
DELETE NEMPFD WHERE CNSPAGO='01201308P30-3'

SELECT
NUMDOC,ITEM,ROUND(AVG(LINEA),0)LINEA,CODCONCEPTO,DETALLE,SUM(VALOR)VALOR,SUM(VALOR_EMPRESA)VALOR_EMPRESA,SUM(VALOR100P)VALOR100P,
AVG(CANTIDAD)CANTIDAD,' 'IDTRANSPRESTAMO,' 'NUMDOCPRESTAMO,0 AS NUMCUOTA,CODPRF,IDTERCERO,AVG(PSOBREINGRESOS)PSOBREINGRESOS,
INCLUIR_EXCLUIR,LIQUIDAR,INFO,BASE_PRESTACIONES,CODCONCEPTO_PADRE,LINEA_PADRE,VALHORASLAB,GENERANOVEFU,CODNOVEFU,SUM(BASE_CALCULO)BASE_CALCULO INTO #VVVV
FROM NEMPFD A INNER JOIN NPER B ON A.CNSPAGO=B.CNSPAGO
WHERE A.CNSPAGO IN('01201604P30-1','01201603P30-1','01201602P30-1','01201602P30-1','D8201601P30-1','D9201602P30-1','E1201603P30-1','E2201604P30-1')--CODNOMINA IN('01','56','57','58','59','60','61') AND MES>='01' AND MES<='06' AND ANO='2012'
GROUP BY NUMDOC,CODCONCEPTO,DETALLE,ITEM,CODPRF,IDTERCERO,INCLUIR_EXCLUIR,LIQUIDAR,INFO,BASE_PRESTACIONES,CODCONCEPTO_PADRE,
LINEA_PADRE,VALHORASLAB,GENERANOVEFU,CODNOVEFU


SELECT * FROM #VVVV

DROP TABLE #VVVV

--01201208P30-2

DELETE NEMPFD WHERE CNSPAGO='01201208P30-2'

UPDATE #VVVV SET VALOR=VALOR*0.0777,VALOR_EMPRESA=VALOR_EMPRESA*0.0777,VALOR100P=VALOR100P*0.0777,BASE_CALCULO=BASE_CALCULO*0.0777

UPDATE #VVVV SET VALOR=ROUND(VALOR,2),VALOR_EMPRESA=ROUND(VALOR_EMPRESA,2),VALOR100P=ROUND(VALOR100P,2),BASE_CALCULO=ROUND(BASE_CALCULO,0),CANTIDAD=ROUND(CANTIDAD,0)

DELETE #VVVV WHERE CODCONCEPTO IN('500','002','553')

SELECT  * FROM #VVVV WHERE CODCONCEPTO='003'

UPDATE #VVVV SET VALOR=6083*4,VALOR100P=6083*4,BASE_CALCULO=6083*4 WHERE CODCONCEPTO='003'


SELECT  DISTINCT NUMDOC FROM #VVVV WHERE NUMDOC NOT IN(SELECT NUMDOC FROM NEMPF WHERE CNSPAGO='01201403P30-2' )

DELETE #VVVV WHERE  NUMDOC NOT IN(SELECT NUMDOC FROM CCC )

SELECT * INTO VVVV1 FROM #VVVV

DROP TABLE VVVV1

SELECT NUMDOC,ITEM, LINEA, CODCONCEPTO 
FROM #VVVV
GROUP BY NUMDOC,ITEM, LINEA, CODCONCEPTO 
HAVING COUNT(*)>1

SELECT  * FROM #VVVV WHERE NUMDOC='17840100' AND CODCONCEPTO='003'
ORDER BY LINEA,CODCONCEPTO

DELETE #VVVV WHERE INCLUIR_eXCLUIR='Incluir'

UPDATE #VVVV SET VALOR=VALOR+6346.530000,BASE_CALCULO=+BASE_CALCULO+6346.530000  WHERE NUMDOC='17849802' AND CODCONCEPTO='506' AND IDTERCERO='800224808'

DELETE #VVVV  WHERE NUMDOC='17849802' AND CODCONCEPTO='506' AND IDTERCERO='900336004'

SELECT * FROM #VVVV WHERE CODCONCEPTO='005' AND DETALLE = 'NULL'

INSERT INTO NEMPFD(
NUMDOC,CNSPAGO,ITEM,LINEA,CODCONCEPTO,DETALLE,VALOR,VALOR_EMPRESA,VALOR100P,CANTIDAD,IDTRANSPRESTAMO,NUMDOCPRESTAMO,NUMCUOTA,
CODPRF,IDTERCERO,PSOBREINGRESOS,INCLUIR_EXCLUIR,LIQUIDAR,INFO,BASE_PRESTACIONES,CODCONCEPTO_PADRE,LINEA_PADRE,
VALHORASLAB,GENERANOVEFU,CODNOVEFU,BASE_CALCULO)
SELECT
NUMDOC,'01201604P30-2',ITEM,LINEA,CODCONCEPTO,DETALLE,VALOR,VALOR_EMPRESA,VALOR100P,CANTIDAD,IDTRANSPRESTAMO,NUMDOCPRESTAMO,NUMCUOTA,CODPRF,IDTERCERO,
PSOBREINGRESOS,INCLUIR_EXCLUIR,LIQUIDAR,INFO,BASE_PRESTACIONES,CODCONCEPTO_PADRE,LINEA_PADRE,VALHORASLAB,GENERANOVEFU,CODNOVEFU,BASE_CALCULO
FROM #A 
--WHERE NUMDOC IN(SELECT NUMDOC FROM #B )


SELECT   TOP 1 * INTO #A FROM NEMPF WHERE CNSPAGO='01201208P30-2'

SELECT  * FROM #A

SELECT DISTINCT NUMDOC INTO #B FROM #VVVV WHERE NUMDOC NOT IN(SELECT NUMDOC FROM NEMPF WHERE CNSPAGO='01201403P30-2' )

DELETE  FROM NEMPF WHERE  CNSPAGO='01201208P30-2' AND COALESCE(VALOR_NETO,0)=0

INSERT INTO NEMPF
SELECT DISTINCT NUMDOC,'01201604P30-2','CAR00001',NULL,NULL,NULL,NULL,NULL,NULL,NULL  
 FROM #VVVV WHERE NUMDOC NOT IN(SELECT NUMDOC FROM NEMPF WHERE CNSPAGO='01201604P30-2' )
 
 
 SELECT  * INTO #A FROM #VVVV WHERE NUMDOC='36551064' AND CODCONCEPTO='031'
 
 SELECT  *  FROM NEMPFD WHERE NUMDOC='84039983' AND CODCONCEPTO='900_M' AND CNSPAGO='01201208P30-2'
 
 UPDATE  NEMPFD  SET VALOR=299000  WHERE NUMDOC='84039983' AND CODCONCEPTO='900_M' AND CNSPAGO='01201208P30-2'
 
 UPDATE #C SET NUMDOC='42496798',VALOR=113000
 INSERT INTO NEMPFD
 SELECT  * FROM #C
 
 UPDATE NEMPFD SET IDTERCERO=NUMDOC WHERE NUMDOC='42496798'  AND CODCONCEPTO='900_M' AND CNSPAGO='01201208P30-2'
 
 SELECT * INTO VVVV1 FROM NEMPFD WHERE CNSPAGO='01201208P30-2'
 
 --INSERTANDO CONCEPTOS MANUALES DE PRIMAS
 
 
 SELECT * INTO #B FROM NPERC WHERE CNSPAGO='03201306P365-1'
 
-- DELETE NPERC WHERE CNSPAGO='01201308P30-3'
INSERT INTO #A
SELECT TOP 2 * FROM NEMPFD WHERE CNSPAGO='01201308P30-3' AND CODCONCEPTO='006'

SELECT * FROM #A
SELECT * FROM #B

ALTER TABLE #B DROP COLUMN AUTOITEM

ALTER TABLE #A ADD CNS INT IDENTITY (1,1)
ALTER TABLE #B ADD CNS INT IDENTITY (1,1)

UPDATE #A SET NUMDOC=B.NUMDOC,CODCONCEPTO=B.CODCONCEPTO,VALOR=ROUND(B.VALOR*0.0402,2),VALOR100P=ROUND(B.VALOR*0.0402,2),IDTERCERO=B.NUMDOC,BASE_CALCULO=ROUND(B.VALOR*0.0402,2)
FROM #A A INNER JOIN #B B ON A.CNS=B.CNS


ALTER TABLE #A DROP COLUMN CNS


INSERT INTO NEMPFD
SELECT * FROM #A


   DECLARE @CNSPAGO VARCHAR(20)
   DECLARE @NUMDOC  VARCHAR(20)
   DECLARE PG_CURSOR CURSOR FOR
   SELECT DISTINCT CNSPAGO,NUMDOC FROM NEMPF WHERE CNSPAGO='01201604P30-2'      
   OPEN PG_CURSOR    
   FETCH NEXT FROM PG_CURSOR    
   INTO @CNSPAGO,@NUMDOC
   WHILE @@FETCH_STATUS = 0    
   BEGIN 
   EXEC SPK_CALCULAR_NEMPF @CNSPAGO,@NUMDOC
   FETCH NEXT FROM PG_CURSOR    
   INTO @CNSPAGO,@NUMDOC
   END
   CLOSE PG_CURSOR
   DEALLOCATE PG_CURSOR


EXEC  DBO.SPK_GENCXP_NOMINA '01201604P30-2','01','01','SOPORTEIX','SOPORTE'

 DELETE FCXPD 
   FROM   FCXPD INNER JOIN FCXP  ON FCXPD.CNSFCXP = FCXP.CNSFCXP 
                 LEFT JOIN FCXPP ON  FCXP.CNSFCXP = FCXPP.CNSFCXP
   WHERE  FCXP.PROCEDENCIA  = 'Nomina' 
   AND    FCXP.NOREFERENCIA = '01201604P30-2' 
   AND    FCXPP.CNSFCXP IS NULL

   DELETE FCXP 
   FROM   FCXP LEFT JOIN FCXPP ON FCXP.CNSFCXP = FCXPP.CNSFCXP
   WHERE  FCXP.PROCEDENCIA  = 'Nomina' 
   AND    FCXP.NOREFERENCIA = '01201604P30-2' 
   AND    FCXPP.CNSFCXP IS NULL


SELECT CODCONCEPTO,ITEM,ROW_NUMBER() OVER(PARTITION BY CODCONCEPTO ORDER BY ITEM DESC)NRO INTO #A
 FROM NCOND
ORDER BY CODCONCEPTO ASC


DELETE #A  WHERE NRO>1

UPDATE NEMPFD SET ITEMCONCEPTO=B.ITEM
FROM NEMPFD A INNER JOIN #A B ON A.CODCONCEPTO=B.CODCONCEPTO
WHERE A.CNSPAGO=''

DELETE FCXPP WHERE CNSFCXP IN(SELECT CNSFCXP FROM FCXP WHERE NOREFERENCIA='01201308P30-3')

SELECT * FROM #A

UPDATE #A SET CODCONCEPTO='102',VALOR=1928589,CANTIDAD=30,VALOR100P=1928589,BASE_CALCULO=1928589

INSERT INTO NEMPFD
SELECT NUMDOC,'01201403P30-2',ITEM,LINEA,CODCONCEPTO,DETALLE,VALOR,VALOR_EMPRESA,VALOR100P,CANTIDAD,IDTRANSPRESTAMO,NUMDOCPRESTAMO,NUMCUOTA,CODPRF,IDTERCERO,
PSOBREINGRESOS,INCLUIR_EXCLUIR,LIQUIDAR,INFO,BASE_PRESTACIONES,CODCONCEPTO_PADRE,LINEA_PADRE,VALHORASLAB,GENERANOVEFU,CODNOVEFU,BASE_CALCULO FROM #A