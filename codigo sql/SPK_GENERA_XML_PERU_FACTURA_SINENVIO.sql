IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME = 'SPK_GENERA_XML_PERU_FACTURA_SINENVIO' AND TYPE = 'P')
BEGIN
   DROP PROCEDURE SPK_GENERA_XML_PERU_FACTURA_SINENVIO
END
GO
CREATE PROCEDURE DBO.SPK_GENERA_XML_PERU_FACTURA_SINENVIO 
@N_FACTURA  VARCHAR(20),
@N_FACTURAX VARCHAR(20)
WITH ENCRYPTION
AS 
DECLARE @XML VARCHAR(MAX)
DECLARE @XML1 VARCHAR(8000)
DECLARE @XML2 VARCHAR(8000)
DECLARE @XML3 VARCHAR(8000)
DECLARE @XMLD VARCHAR(8000)
DECLARE @XMLF VARCHAR(8000)
DECLARE @XMLI VARCHAR(8000)
DECLARE @CODDOC VARCHAR(4)
DECLARE @PREFACT VARCHAR(4)
DECLARE @NFACTURA VARCHAR(20)
DECLARE @F_EMISION VARCHAR(10)
DECLARE @H_EMISION VARCHAR(8)
DECLARE @F_VENCE   VARCHAR(10)
DECLARE @TIPODOC   VARCHAR(2)
DECLARE @CODPAIS1  VARCHAR(3)
DECLARE @PERINICIAL  VARCHAR(10)
DECLARE @PERFINAL  VARCHAR(10)
DECLARE @NOADMISION  VARCHAR(20)
DECLARE @GUIA1  VARCHAR(20)
DECLARE @TGUIA1 VARCHAR(2)
DECLARE @GUIA2  VARCHAR(20)
DECLARE @TGUIA2 VARCHAR(2)
DECLARE @NITEMISOR VARCHAR(20)
DECLARE @DVEMISIOR VARCHAR(1)
DECLARE @RAZONSOCIALEMI VARCHAR(125)
DECLARE @CODPOSTALEMI VARCHAR(10)
DECLARE @DIRECCIOEMI VARCHAR(255)
DECLARE @CIUDADEMI   VARCHAR(45)
DECLARE @DEPAREMI   VARCHAR(45)
DECLARE @DISTRIEMI   VARCHAR(45)
DECLARE @PAISEMI   VARCHAR(2)
DECLARE @NITRECEP VARCHAR(20)
DECLARE @DVRECEP VARCHAR(1)
DECLARE @RAZONSOCIALRECEP VARCHAR(125)
DECLARE @CODPOSTALRECEP VARCHAR(10)
DECLARE @DIRECCIORECEP VARCHAR(255)
DECLARE @CIUDADRECEP   VARCHAR(45)
DECLARE @DEPARRECEP   VARCHAR(45)
DECLARE @DISTRIRECEP  VARCHAR(45)
DECLARE @PAISRECEP   VARCHAR(2)
DECLARE @CODSUNAT   VARCHAR(4)
DECLARE @VR_BRUTO DECIMAL(14,2)
DECLARE @VR_IVA DECIMAL(14,2)
DECLARE @NOMBREI VARCHAR(1)
DECLARE @CODIMP  VARCHAR(4)
DECLARE @IMP     VARCHAR(4)
DECLARE @CODINTER VARCHAR(4)
DECLARE @VR_BRUTO1 DECIMAL(14,2)
DECLARE @VR_NETO DECIMAL(14,2)
DECLARE @VR_IVA1 DECIMAL(14,2)
DECLARE @PVIVA   DECIMAL(7,2)
DECLARE @VR_LETRAS VARCHAR(2048)
DECLARE @DNI   VARCHAR(20)
DECLARE @NOMBEPTE VARCHAR(120)
DECLARE @VRCOPAGO DECIMAL(14,2)
DECLARE @LEYENDA VARCHAR(20)
DECLARE @BOLETA TABLE(N_FACTURA VARCHAR(20), VALOR DECIMAL(14,2),ID INT IDENTITY(1,1))
DECLARE @OBSERVACION VARCHAR(255)
DECLARE @NBOLE INT
DECLARE @B     INT
DECLARE @PORCO DECIMAL(7,2)
DECLARE @ITEM VARCHAR(4)
DECLARE @CANTIDAD VARCHAR(4)
DECLARE @VALOR1 VARCHAR(20)
DECLARE @VALOR2 VARCHAR(20)
DECLARE @VALOR3 VARCHAR(20)
DECLARE @VALOR4 VARCHAR(20)
DECLARE @VALOR5 VARCHAR(20)
DECLARE @VALOR6 VARCHAR(20)
DECLARE @ANEXO VARCHAR(255)
DECLARE @REFERENCIA VARCHAR(20)
DECLARE @VALOR7 VARCHAR(20)
DECLARE @RPTA TABLE(ID INT,DATOS VARCHAR(500))
DECLARE @OK VARCHAR(10)
DECLARE @ERROR VARCHAR(500)
DECLARE @RUTAP VARCHAR(500)
DECLARE @AFECTA SMALLINT
DECLARE @X1 BIT
BEGIN  

   SELECT @CODDOC='0101',@X1=0,@PREFACT=REPLACE(FDIAN.PREFIJO,'-',''),@NFACTURA=FTR.N_FACTURA,@F_EMISION=REPLACE(CONVERT(VARCHAR,F_FACTURA,102),'.','-'),
   @H_EMISION=REPLACE(CONVERT(VARCHAR,F_FACTURA,108),'.','-'),@F_VENCE= REPLACE(CONVERT(VARCHAR,F_VENCE,102),'.','-'),@TIPODOC= CASE WHEN TIPOFIN='N' THEN '03' ELSE '01' END,@CODPAIS1='PEN',
   @PERINICIAL=REPLACE(CONVERT(VARCHAR,CAST('01/'+CASE WHEN MONTH(F_FACTURA)<10 THEN '0' ELSE '' END+CAST(MONTH(F_FACTURA) AS VARCHAR(2))+'/'+CAST(YEAR(F_FACTURA) AS VARCHAR(4))AS DATETIME),102),'.','-'),
   @PERFINAL=REPLACE(CONVERT(VARCHAR,CAST('01/'+CASE WHEN MONTH(F_FACTURA)<10 THEN '0' ELSE '' END+CAST(MONTH(F_FACTURA)+CASE WHEN MONTH(F_FACTURA)<12 THEN 1 ELSE 0 END AS VARCHAR(2))+'/'+CAST(YEAR(F_FACTURA) AS VARCHAR(4)) AS DATETIME)-1,102),'.','-'),
   @NOADMISION=FTR.NOREFERENCIA,@GUIA1='T001-00000001',@TGUIA1='09',@GUIA2='T001-00000002',@TGUIA2='99',@DNI=AFI.DOCIDAFILIADO,@NOMBEPTE=dbo.FNK_LIMPIATEXTO(AFI.NOMBREAFI,'0-9 A-Z().;:,'),
   @VRCOPAGO=FTR.VALORCOPAGO,@AFECTA=CASE WHEN FTR.VIVA>0 THEN 1 ELSE 0 END
   FROM FTR INNER JOIN FDIAN ON FTR.CNSRESOL=FDIAN.CNSRESOL
            LEFT  JOIN AFI  ON FTR.IDAFILIADO=AFI.IDAFILIADO
   WHERE FTR.N_FACTURA=@N_FACTURA
   AND FDIAN.PROCEDENCIA=CASE WHEN FTR.TIPOFIN='N' THEN 'BOLE' ELSE 'FTR' END


   SELECT @NITEMISOR= NIT,@DVEMISIOR=6,@RAZONSOCIALEMI=dbo.FNK_LIMPIATEXTO(RAZONSOCIAL,'0-9 A-Z().;:,'),@CODPOSTALEMI='150101',@DIRECCIOEMI=DIRECCION,@CIUDADEMI=CIU.NOMBRE,
   @DEPAREMI=DEP.NOMBRE,@DISTRIEMI='',@PAISEMI='PE'
   FROM TER LEFT JOIN CIU ON TER.CIUDAD=CIU.CIUDAD
           LEFT JOIN DEP ON CIU.DPTO =DEP.DPTO
   WHERE IDTERCERO=DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO')


   SELECT @NITRECEP=NIT,@DVRECEP=CONVERT(VARCHAR(1),CONVERT(INT,COALESCE(TGEN.VALOR1,0))),@RAZONSOCIALRECEP=dbo.FNK_LIMPIATEXTO(RAZONSOCIAL,'0-9 A-Z().;:,'),@CODPOSTALRECEP='150101',@DIRECCIORECEP=DIRECCION,@CIUDADRECEP=CIU.NOMBRE,
   @DEPARRECEP=DEP.NOMBRE,@DISTRIRECEP='',@PAISRECEP='PE',@CODSUNAT='0000'
   FROM FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
            LEFT JOIN CIU ON TER.CIUDAD=CIU.CIUDAD
            LEFT JOIN DEP ON CIU.DPTO =DEP.DPTO
            LEFT JOIN TGEN ON TER.TIPO_ID =TGEN.CODIGO AND TGEN.TABLA='General' AND TGEN.CAMPO='TIPOIDSUNAT'
   WHERE FTR.N_FACTURA=@N_FACTURA

   SELECT @LEYENDA='SITEDS:'+CAST(COALESCE(dbo.FNK_LIMPIATEXTO(VENDEDOR,'0-9 A-Z'),'') AS VARCHAR(20)) FROM FTR WHERE N_FACTURA=@N_FACTURA

   SELECT @VR_IVA=VIVA,@NOMBREI='S',@CODIMP='1000',@IMP='IGV',@CODINTER='VAT'
   FROM FTR 
   WHERE FTR.N_FACTURA=@N_FACTURA

   SELECT  @VR_BRUTO=SUM((COALESCE(VALOR,0)*COALESCE(CANTIDAD,0))),@VR_BRUTO1=SUM((COALESCE(VALOR,0)*COALESCE(CANTIDAD,0))+CASE WHEN COALESCE(PIVA,0)>0 THEN  (COALESCE(VALOR,0)*COALESCE(CANTIDAD,0))*(PIVA/100)ELSE 0 END)
   FROM FTRD 
   WHERE FTRD.N_FACTURA=@N_FACTURA

   SELECT @VR_NETO=VR_TOTAL,@VR_IVA1=COALESCE(VIVA,0),@VR_LETRAS= DBO.FNK_DE_VALORES_A_LETRAS(VR_TOTAL)
   FROM FTR 
   WHERE FTR.N_FACTURA=@N_FACTURA

   IF COALESCE(@VRCOPAGO,0)>0
   BEGIN
      SELECT @PORCO=(@VRCOPAGO*100/@VR_BRUTO)/100
   END
   ELSE
   BEGIN
      SELECT @PORCO=0.00
   END
   
   IF NOT EXISTS (SELECT * FROM FTR WHERE FTR.TIPOFIN='N' AND N_FACTURA=@N_FACTURA)
   BEGIN
      INSERT INTO @BOLETA(N_FACTURA,VALOR)
      SELECT HPRED.N_FACTURAH,SUM(COALESCE(HPRED.VALORCOPAGO,0))
      FROM FTRD INNER JOIN HPRED ON FTRD.NOPRESTACION=HPRED.NOPRESTACION AND HPRED.NOITEM=FTRD.NOITEM AND HPRED.N_FACTURA=FTRD.N_FACTURA
      WHERE FTRD.N_FACTURA=@N_FACTURA
      AND COALESCE(HPRED.N_FACTURAH,'')<>'' AND COALESCE(HPRED.VALORCOPAGO,0)>0
      GROUP BY HPRED.N_FACTURAH

      IF(SELECT COUNT(*) FROM @BOLETA)>0
      BEGIN
         SELECT @NBOLE=COUNT(*), @B=1 FROM @BOLETA
         IF NOT EXISTS(SELECT * FROM @BOLETA WHERE N_FACTURA='B001-ACEPTA')
         BEGIN
            SELECT @OBSERVACION='Boletas de Venta:'
            WHILE(@B<=@NBOLE)
            BEGIN
               SELECT @OBSERVACION=@OBSERVACION+' '+N_FACTURA+'  Valor: s/'+CONVERT(VARCHAR(20),VALOR)  FROM @BOLETA WHERE ID=@B
               SELECT @B=@B+1
            END
         END
         ELSE
         BEGIN
            SELECT @OBSERVACION=''
			SELECT @VR_BRUTO=@VR_BRUTO-@VRCOPAGO
            SELECT @VRCOPAGO=0.00
            SELECT @PORCO=0.00
			SELECT @X1=1
            --DECLARE @TCOPAGO DECIMAL(14,2)
            --SELECT @TCOPAGO=SUM(VALOR) FROM @BOLETA
            --SELECT @OBSERVACION='Valor Copago: s/'+CONVERT(VARCHAR(20),@TCOPAGO)
         END
      END
   END
   ELSE
   BEGIN
      SELECT @OBSERVACION='Factura sin Boleta '
   END

   SELECT @VR_LETRAS=@VR_LETRAS+' SOLES'

   SELECT @XML='<?xml version="1.0" encoding="ISO-8859-1" standalone="no"?>'
   SELECT @XML=@XML+'<Invoice>'
   SELECT @XML=@XML+'<ProfileID>'+@CODDOC+'</ProfileID>'
   SELECT @XML=@XML+'<ID>'+@N_FACTURAX+'</ID>'
   SELECT @XML=@XML+'<IssueDate>'+@F_EMISION+'</IssueDate>'
   SELECT @XML=@XML+'<IssueTime>'+@H_EMISION+'</IssueTime>'
   SELECT @XML=@XML+'<DueDate>'+@F_VENCE+'</DueDate>'
   SELECT @XML=@XML+'<InvoiceTypeCode>'+@TIPODOC+'</InvoiceTypeCode>'
   SELECT @XML=@XML+'<DocumentCurrencyCode>'+@CODPAIS1+'</DocumentCurrencyCode>'
   SELECT @XML=@XML+'<InvoicePeriod>'
   pRINT '@XML'+@XML
   SELECT @XML=@XML+'<StartDate>'+@PERINICIAL+'</StartDate>'
   SELECT @XML=@XML+'<EndDate>'+@PERFINAL+'</EndDate>'
   SELECT @XML=@XML+'</InvoicePeriod>'
   SELECT @XML=@XML+'<OrderReference>'
   SELECT @XML=@XML+'<ID>'+@NOADMISION+'</ID>'
   SELECT @XML=@XML+'</OrderReference>'
   SELECT @XML=@XML+'<DespatchDocumentReference>'
   SELECT @XML=@XML+'<ID>'+@GUIA1+'</ID>'
   SELECT @XML=@XML+'<DocumentTypeCode>'+@TGUIA1+'</DocumentTypeCode>'
   SELECT @XML=@XML+'</DespatchDocumentReference>'
   SELECT @XML=@XML+'<AdditionalDocumentReference>'
   SELECT @XML=@XML+'<ID>'+@GUIA2+'</ID>'
   SELECT @XML=@XML+'<DocumentTypeCode>'+@TGUIA2+'</DocumentTypeCode>'
   SELECT @XML=@XML+'</AdditionalDocumentReference> '
   SELECT @XML=@XML+'<AccountingSupplierParty>'
   SELECT @XML=@XML+'<CustomerAssignedAccountID>'+@NITEMISOR+'</CustomerAssignedAccountID> '
   SELECT @XML=@XML+'<AdditionalAccountID>'+@DVEMISIOR+'</AdditionalAccountID> '
   SELECT @XML=@XML+'<Party> '
   SELECT @XML=@XML+'<PartyName>'
   SELECT @XML=@XML+'<Name>'+@RAZONSOCIALEMI+'</Name>'
   SELECT @XML=@XML+'</PartyName>'
   SELECT @XML=@XML+'<PostalAddress>  '
   SELECT @XML=@XML+'<RegistrationAddress>'
   SELECT @XML=@XML+'<ID>'+@CODPOSTALEMI+'</ID>'
   SELECT @XML=@XML+'<AddressTypeCode>0000</AddressTypeCode> '
   SELECT @XML=@XML+'<StreetName>'+@DIRECCIOEMI+'</StreetName> '
   SELECT @XML=@XML+'<CitySubdivisionName>CitySubdivisionName</CitySubdivisionName> '
   SELECT @XML=@XML+'<CityName>'+@CIUDADRECEP+'</CityName> '
   SELECT @XML=@XML+'<CountrySubentity>'+@DEPAREMI+'</CountrySubentity> '
   SELECT @XML=@XML+'<District>'+@DISTRIEMI+'</District> '
   SELECT @XML=@XML+'<Country>'
   SELECT @XML=@XML+'<IdentificationCode>PE</IdentificationCode>'
   SELECT @XML=@XML+'</Country> '
   SELECT @XML=@XML+'</RegistrationAddress> '
   SELECT @XML=@XML+'</PostalAddress>'
   SELECT @XML=@XML+'<PartyLegalEntity>'
   SELECT @XML=@XML+'<RegistrationName>'+REPLACE(@RAZONSOCIALEMI,CHAR(13),'')+'</RegistrationName>'
   SELECT @XML=@XML+'</PartyLegalEntity>'
   SELECT @XML=@XML+'</Party>'
   SELECT @XML=@XML+'</AccountingSupplierParty>'
   SELECT @XML=@XML+'<AccountingCustomerParty>'
   SELECT @XML=@XML+'<CustomerAssignedAccountID>'+@NITRECEP+'</CustomerAssignedAccountID> '
   SELECT @XML=@XML+'<AdditionalAccountID>'+@DVRECEP+'</AdditionalAccountID> '
   SELECT @XML=@XML+'<Party>'
   SELECT @XML=@XML+'<PostalAddress> '
   SELECT @XML=@XML+'<RegistrationAddress>'
   SELECT @XML=@XML+'<ID>'+@CODPOSTALRECEP+'</ID>'
   SELECT @XML=@XML+'<AddressTypeCode>0000</AddressTypeCode> '
   SELECT @XML=@XML+'<StreetName>'+@DIRECCIORECEP+'</StreetName> '
   SELECT @XML=@XML+'<CitySubdivisionName>CitySubdivisionName</CitySubdivisionName> '
   SELECT @XML=@XML+'<CityName>'+@CIUDADRECEP+'</CityName> '
   SELECT @XML=@XML+'<CountrySubentity>'+@DEPARRECEP+'</CountrySubentity> '
   SELECT @XML=@XML+'<District>'+@DISTRIRECEP+'</District> '
   SELECT @XML=@XML+'<Country>'
   SELECT @XML=@XML+'<IdentificationCode>PE</IdentificationCode>'
   SELECT @XML=@XML+'</Country> '
   SELECT @XML=@XML+'</RegistrationAddress> '
   SELECT @XML=@XML+'</PostalAddress>'
   SELECT @XML=@XML+'<PartyLegalEntity>'
   SELECT @XML=@XML+'<RegistrationName>'+REPLACE(@RAZONSOCIALRECEP,CHAR(13),'')+'</RegistrationName>'
   SELECT @XML=@XML+'</PartyLegalEntity>'
   SELECT @XML=@XML+'</Party> '
   SELECT @XML=@XML+'</AccountingCustomerParty> '
   SELECT @XML=@XML+'<AllowanceCharge>'
   SELECT @XML=@XML+'<ChargeIndicator>false</ChargeIndicator>'
   SELECT @XML=@XML+'<AllowanceChargeReasonCode>02</AllowanceChargeReasonCode>'
   SELECT @XML=@XML+'<MultiplierFactorNumeric>'+CONVERT(VARCHAR(20),@PORCO)+'</MultiplierFactorNumeric>' 
   SELECT @XML=@XML+'<Amount>'+CONVERT(VARCHAR(20),@VRCOPAGO)+'</Amount>'
   SELECT @XML=@XML+'<BaseAmount>'+CONVERT(VARCHAR(20),@VR_BRUTO)+'</BaseAmount>'
   SELECT @XML=@XML+'</AllowanceCharge>'
   SELECT @XML=@XML+'<TaxTotal>'
   SELECT @XML=@XML+'<TaxSubtotal>'
   SELECT @XML=@XML+'<TaxableAmount>'+CONVERT(VARCHAR(20),@VR_NETO-@VR_IVA1)+'</TaxableAmount>'
   SELECT @XML=@XML+'<TaxAmount>'+CONVERT(VARCHAR(20),@VR_IVA)+'</TaxAmount>'
   SELECT @XML=@XML+'<TaxCategory>'
   IF @AFECTA=1
   BEGIN
      SELECT @XML=@XML+'<ID>'+@NOMBREI+'</ID>'
      SELECT @XML=@XML+'<TaxScheme>'
      SELECT @XML=@XML+'<ID>'+@CODIMP+'</ID>'
      SELECT @XML=@XML+'<Name>'+@IMP+'</Name>'
      SELECT @XML=@XML+'<TaxTypeCode>'+@CODINTER+'</TaxTypeCode>'
      SELECT @XML=@XML+'</TaxScheme>'
   END
   ELSE
   BEGIN
		SELECT @XML=@XML+'<ID>O</ID>'
		SELECT @XML=@XML+'<TaxScheme>'
		SELECT @XML=@XML+'<ID>9998</ID>'
		SELECT @XML=@XML+'<Name>INA</Name>'
		SELECT @XML=@XML+'<TaxTypeCode>FRE</TaxTypeCode>'
		SELECT @XML=@XML+'</TaxScheme>'
   END
   SELECT @XML=@XML+'</TaxCategory>'
   SELECT @XML=@XML+'</TaxSubtotal> '
   SELECT @XML=@XML+'</TaxTotal>'
   SELECT @XML=@XML+'<LegalMonetaryTotal>'
   SELECT @XML=@XML+'<LineExtensionAmount>'+CONVERT(VARCHAR(20),@VR_BRUTO)+'</LineExtensionAmount>'
   SELECT @XML=@XML+'<TaxInclusiveAmount>'+CONVERT(VARCHAR(20),@VR_BRUTO1)+'</TaxInclusiveAmount> '
   SELECT @XML=@XML+'<PayableAmount>'+CONVERT(VARCHAR(20),@VR_NETO)+'</PayableAmount>'
   SELECT @XML=@XML+'<TaxAmount>'+CONVERT(VARCHAR(20),@VR_IVA1)+'</TaxAmount>'
   SELECT @XML=@XML+'</LegalMonetaryTotal> '
   
   --PRINT '@XML ANTES DE LOS DETALLES ='+@XML

   PRINT 'DETALLES DE LA FACTURA' --FTRD
   SELECT @XMLD=''
   DECLARE @N_CUOTA INT 
	DECLARE XMLFTRD_CURSOR CURSOR FOR
   SELECT N_CUOTA FROM FTRD WHERE N_FACTURA=@N_FACTURA
   ORDER BY N_CUOTA ASC
	OPEN XMLFTRD_CURSOR    
	FETCH NEXT FROM XMLFTRD_CURSOR    
	INTO @N_CUOTA
	WHILE @@FETCH_STATUS = 0    
	BEGIN 
     PRINT '@X1='+STR(@X1)
      SELECT @ITEM=CONVERT(varchar(3),N_CUOTA),@CANTIDAD=CONVERT(varchar(4),CONVERT(INT,FTRD.CANTIDAD)),
             @VALOR1=CONVERT(VARCHAR(20),CONVERT(DECIMAL(14,2),(COALESCE(VALOR,0)*COALESCE(FTRD.CANTIDAD,0))))- CASE WHEN @X1=1 THEN FTRD.VLR_COPAGOS ELSE 0 END,
             @VALOR2=CONVERT(VARCHAR(20),CONVERT(DECIMAL(14,2),((COALESCE(VALOR,0)*COALESCE(FTRD.CANTIDAD,0))- CASE WHEN @X1=1 THEN FTRD.VLR_COPAGOS ELSE 0 END)*(CASE WHEN COALESCE(PIVA,0)>0 THEN PIVA/100 ELSE 0 END))),
             @VALOR3=CONVERT(VARCHAR(20),CONVERT(DECIMAL(14,2),COALESCE(VALOR,0)-(CASE WHEN @X1=1 THEN FTRD.VLR_COPAGOS/FTRD.CANTIDAD ELSE 0 END) +CASE WHEN COALESCE(PIVA,0)>0  THEN (COALESCE(VALOR,0)*(CASE WHEN COALESCE(PIVA,0)>0 THEN PIVA/100 ELSE 0 END)) ELSE 0 END)),
             @VALOR4=CONVERT(VARCHAR(20),CONVERT(DECIMAL(14,2),COALESCE(VALOR,0)*(COALESCE(FTRD.CANTIDAD,0))))- CASE WHEN @X1=1 THEN FTRD.VLR_COPAGOS ELSE 0 END,
             @VALOR5=CONVERT(VARCHAR(20),CONVERT(DECIMAL(14,2),((COALESCE(VALOR,0)*COALESCE(FTRD.CANTIDAD,0))- CASE WHEN @X1=1 THEN FTRD.VLR_COPAGOS ELSE 0 END)*(CASE WHEN COALESCE(PIVA,0)>0 THEN PIVA/100 ELSE 1 END))),
             @VALOR6=CONVERT(VARCHAR(20),CONVERT(INT,COALESCE(PIVA,0))),
             @ANEXO= dbo.FNK_LIMPIATEXTO(SER.DESCRIPCION_CUPS,'0-9 A-Z'),
             @REFERENCIA=dbo.FNK_LIMPIATEXTO(SER.CODCUPS,'0-9 A-Z'),
             @VALOR7=CONVERT(VARCHAR(20),ROUND(COALESCE(VALOR,0),2,0))
      FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
      WHERE N_FACTURA=@N_FACTURA
      AND N_CUOTA=@N_CUOTA


      SELECT   @XML=@XML+'<InvoiceLine>'
		SELECT   @XML=@XML+'<ID>'+@ITEM+'</ID>'
		SELECT   @XML=@XML+'<InvoicedQuantity>'+@CANTIDAD+'</InvoicedQuantity>'
		SELECT   @XML=@XML+'<UnitCode>NIU</UnitCode>'
		SELECT   @XML=@XML+'<LineExtensionAmount>'+@VALOR1+'</LineExtensionAmount>'
		SELECT   @XML=@XML+'<TaxAmount>'+@VALOR2+'</TaxAmount>'
		SELECT   @XML=@XML+'<PricingReference>'
		SELECT   @XML=@XML+'<AlternativeConditionPrice>'
		SELECT   @XML=@XML+'<PriceAmount>'+@VALOR3+'</PriceAmount>'
		SELECT   @XML=@XML+'<PriceTypeCode>01</PriceTypeCode>'
		SELECT   @XML=@XML+'</AlternativeConditionPrice>'
		SELECT   @XML=@XML+'</PricingReference>'
		SELECT   @XML=@XML+'<TaxTotal>'
		SELECT   @XML=@XML+'<TaxSubtotal>'
		SELECT   @XML=@XML+'<TaxableAmount>'+@VALOR4+' </TaxableAmount>'
      IF @AFECTA=1
      BEGIN
		   SELECT   @XML=@XML+'<TaxAmount>'+@VALOR5+'</TaxAmount>'
      END
      ELSE
      BEGIN
         SELECT   @XML=@XML+'<TaxAmount>0.00</TaxAmount>'
      END
		SELECT   @XML=@XML+'<TaxCategory>'
		SELECT   @XML=@XML+'<ID>S</ID>'
		SELECT   @XML=@XML+'<Percent>'+@VALOR6+'</Percent>'
      IF @AFECTA=1
      BEGIN
		   SELECT   @XML=@XML+'<TaxExemptionReasonCode>10</TaxExemptionReasonCode>'
      END
      ELSE
      BEGIN
         SELECT   @XML=@XML+'<TaxExemptionReasonCode>30</TaxExemptionReasonCode>'
      END
		SELECT   @XML=@XML+'<TaxScheme>'
      IF @AFECTA=1
      BEGIN
		   SELECT   @XML=@XML+'<ID>1000</ID>'
		   SELECT   @XML=@XML+'<Name>IGV</Name>'
		   SELECT   @XML=@XML+'<TaxTypeCode>VAT</TaxTypeCode>'
      END
      ELSE
      BEGIN
      	SELECT   @XML=@XML+'<ID>9998</ID>'
			SELECT   @XML=@XML+'<Name>INA</Name>'
		   SELECT   @XML=@XML+'<TaxTypeCode>FRE</TaxTypeCode>'
      END
		SELECT   @XML=@XML+'</TaxScheme>'
		SELECT   @XML=@XML+'</TaxCategory>'
		SELECT   @XML=@XML+'</TaxSubtotal>'
		SELECT   @XML=@XML+'</TaxTotal>'
		SELECT   @XML=@XML+'<Item>'
		SELECT   @XML=@XML+'<Description>'+@ANEXO+'</Description>'
		SELECT   @XML=@XML+'<SellersItemIdentification>'
		SELECT   @XML=@XML+'<ID>'+@REFERENCIA +'</ID>'
		SELECT   @XML=@XML+'</SellersItemIdentification>'
		SELECT   @XML=@XML+'<CommodityClassification>'
		SELECT   @XML=@XML+'<ItemClassificationCode>80131501</ItemClassificationCode>'
		SELECT   @XML=@XML+'</CommodityClassification>'
		SELECT   @XML=@XML+'</Item>'
		SELECT   @XML=@XML+'<Price>'
		SELECT   @XML=@XML+'<PriceAmount>'+@VALOR7+'</PriceAmount>'
		SELECT   @XML=@XML+'</Price>'
	   SELECT   @XML=@XML+'</InvoiceLine>'
      --PRINT '@XML DETALLE '+@ITEM+' -- '+@XML
	FETCH NEXT FROM XMLFTRD_CURSOR    
	INTO @N_CUOTA
	END
	CLOSE XMLFTRD_CURSOR
	DEALLOCATE XMLFTRD_CURSOR

   --PRINT '@XML DESPUES DE LOS DETALLES ='+@XML

   SELECT  @XML=@XML+'<AdditionalInformation> '
	SELECT  @XML=@XML+'<AdditionalProperty>'
   SELECT  @XML=@XML+'<ID>1000</ID>'
   SELECT  @XML=@XML+'<Value>'+@VR_LETRAS+'</Value>'
   SELECT  @XML=@XML+'</AdditionalProperty>'
   SELECT  @XML=@XML+'</AdditionalInformation>'
   SELECT  @XML=@XML+'<Adjuntos>'
   SELECT  @XML=@XML+'<Paciente>'+COALESCE(@NOMBEPTE,'Sin_nombre')+'</Paciente>'
   SELECT  @XML=@XML+'<DNIPaciente>'+COALESCE(@DNI,'Sin_Dni')+'</DNIPaciente>'
   SELECT  @XML=@XML+'<Leyenda1>'+COALESCE(@LEYENDA,'')+'</Leyenda1>'
   SELECT  @XML=@XML+'<SubTotal>'+CONVERT(VARCHAR(20),(COALESCE(@VR_BRUTO,0)))+'</SubTotal>'
   IF COALESCE(@VRCOPAGO,0)>0
   BEGIN
      SELECT  @XML=@XML+'<TotalDescuento>'+CONVERT(VARCHAR(20),COALESCE(@VRCOPAGO,0))+'</TotalDescuento>'
   END
   SELECT  @XML=@XML+'<Observacion>'+COALESCE(@OBSERVACION,'')+'</Observacion>'
   SELECT  @XML=@XML+'</Adjuntos>'
   SELECT  @XML=@XML+'</Invoice>'


   SELECT  @XML= dbo.FNK_LIMPIATEXTO(@XML,'0-9 A-Z < > / = ')
   SELECT  @XML=REPLACE(@XML,CHAR(13),'')
   SELECT  @XML=REPLACE(@XML,CHAR(10),' ')
   PRINT 'DEFINITIVO...'+LTRIM(RTRIM(@XML))
   --CONSUMIR EL SERVICIO DE ACEPTA
   IF LEN(@XML)<=0
   BEGIN
      RAISERROR ('XLM no fue generado Correctamente',16,1)
      RETURN
   END
   IF RIGHT(LTRIM(RTRIM(@XML)),10)<>'</Invoice>'
   BEGIN
      RAISERROR ('XLM no fue generado Correctamente Falta ',16,1)
      RETURN
   END
   RETURN
   DECLARE @sUrl VARCHAR(MAX) 
   DECLARE @obj INT
   DECLARE @valorDeRegreso INT
   DECLARE @response VARCHAR(8000)
   DECLARE @src VARCHAR(255)
   DECLARE @desc VARCHAR(255)
   DECLARE @URLFACT VARCHAR(255)

   SELECT @URLFACT=DBO.FNK_VALORVARIABLE('URLFACT_ELE_PRODPERU')

   SELECT @sUrl =@URLFACT+'?docid='+@N_FACTURAX+'&comando=emitir&parametros=&datos='+@XML

   --PRINT '@sUrl='+@sUrl
   --RETURN
   EXEC sys.sp_OACreate 'MSXML2.ServerXMLHttp', @obj OUT
   EXEC sys.sp_OAMethod @obj, 'Open', NULL, 'GET', @sUrl, false
   EXEC sys.sp_OAMethod @obj, 'send'
   EXEC sys.sp_OAMethod @obj, 'responseText', @response OUTPUT
   EXEC sys.sp_OADestroy @obj
 --  SELECT @response [response]

   INSERT INTO @RPTA
   SELECT  * FROM dbo.FNK_EXPLODE(@response,'|')

   SELECT @OK=DATOS FROM @RPTA WHERE ID=1
   IF @OK='OK'
   BEGIN

      SELECT @RUTAP=RIGHT(DATOS,LEN(DATOS)-8) FROM @RPTA WHERE ID=14
	   SELECT @URLFACT=DATOS FROM @RPTA WHERE ID=13
      UPDATE FTR SET FACTEP='OK',RUTARPTA=REPLACE(@RUTAP,'/','\'),RAZONANULACION=NULL,LINKFACTURA=@URLFACT WHERE N_FACTURA=@N_FACTURA

   END
   ELSE
   BEGIN
       SELECT @ERROR=DATOS FROM @RPTA WHERE ID=7
       UPDATE FTR SET FACTEP='ERROR',RAZONANULACION=@ERROR WHERE N_FACTURA=@N_FACTURA
   END

END
