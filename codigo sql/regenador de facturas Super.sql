--SELECT  TOP 1 * FROM #A
-- ALTER TABLE #A ADD N_FACTURAN VARCHAR(20)

--UPDATE #A SET N_FACTURAN='F003-00066619' WHERE N_FACTURA='F003-00066366'
 
DECLARE 
@N_FACTURA VARCHAR(20),
@COMPANIA VARCHAR(2),
@SEDE VARCHAR(2),
@USUARIO VARCHAR(20),
@RAZONCAMBIO VARCHAR(120),
@SYS_COMPUTERNAME VARCHAR(100),
@USUARIO2 VARCHAR(20),
@NOADMISION VARCHAR(20),
@NIT              VARCHAR(20),
@CNSRPDX          VARCHAR(20),
@ITEM             INT,
@TFECHA           SMALLINT = 0,
@FECHAFAC         DATETIME = NULL,
@N_FACTURAN   VARCHAR(20)

	DECLARE PGJM_CURSOR CURSOR FOR  
	SELECT N_FACTURA FROM #A WHERE N_FACTURAN IS NULL
	OPEN PGJM_CURSOR    
	FETCH NEXT FROM PGJM_CURSOR    
	INTO @N_FACTURA
	WHILE @@FETCH_STATUS = 0    
	BEGIN 
		SELECT @COMPANIA='01',@SEDE=IDSEDE,@USUARIO=USUARIOFACTURA,@USUARIO2='SOPORTE',@SYS_COMPUTERNAME=SYS_COMPUTERNAME,
		@RAZONCAMBIO='Factura Rechazada por la SUNAT',@NOADMISION=NOREFERENCIA
		FROM FTR WHERE N_FACTURA=@N_FACTURA 

		PRINT '@USUARIO='+COALESCE(@USUARIO,'NADA')
		PRINT '@NOADMISION='+COALESCE(@NOADMISION,'NADA')

		PRINT 'CAMBIO ESTADO DE FACTEP'
		UPDATE FTR SET FACTEP='ERROR',RAZONANULACION='Factura Rechazada por la SUNAT' WHERE N_FACTURA=@N_FACTURA

		PRINT 'ANULO FACTURA'
		EXEC SPK_ANULA_FACT @N_FACTURA,@COMPANIA,@SEDE,@USUARIO,@RAZONCAMBIO,@SYS_COMPUTERNAME,@USUARIO2

		PRINT 'MARCO HPRED'

		UPDATE HPRED SET MARCA=1,USUARIOMARCA=@USUARIO
		FROM HPRED INNER JOIN FTRD ON HPRED.NOPRESTACION=FTRD.NOPRESTACION AND FTRD.NOITEM=HPRED.NOITEM
		WHERE FTRD.N_FACTURA=@N_FACTURA
		AND FTRD.NOADMISION=@NOADMISION

		SELECT @CNSRPDX=SPACE(20)
		EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE, '@RPDX', @CNSRPDX OUTPUT  
		SELECT @CNSRPDX = @SEDE + REPLACE(SPACE(8 - LEN(@CNSRPDX))+LTRIM(RTRIM(@CNSRPDX)),SPACE(1),0)
		PRINT '@CNSFTR='+COALESCE(@CNSRPDX,'')

		PRINT 'PREPARO'

		EXEC SPK_AFACTURAR @NOADMISION,@CNSRPDX,@USUARIO

		SELECT @ITEM= ITEM  FROM RPDX WHERE CNS=@CNSRPDX

		PRINT '@ITEM='+STR(COALESCE(@ITEM,0))

		SELECT @NIT= DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO')

		EXEC SPK_FACTURA_ADMISION_DOMI @NOADMISION,@NIT,@COMPANIA,@SEDE,@USUARIO,@SYS_COMPUTERNAME,@CNSRPDX,@ITEM,@TFECHA,@FECHAFAC

		SELECT @N_FACTURAN=HPRED.N_FACTURA
		FROM HPRED INNER JOIN FTRD ON HPRED.NOPRESTACION=FTRD.NOPRESTACION AND FTRD.NOITEM=HPRED.NOITEM
		WHERE FTRD.N_FACTURA=@N_FACTURA
		AND FTRD.NOADMISION=@NOADMISION

		UPDATE #A SET N_FACTURAN=@N_FACTURAN WHERE N_FACTURA=@N_FACTURA

FETCH NEXT FROM PGJM_CURSOR    
INTO @N_FACTURA
END
CLOSE PGJM_CURSOR
DEALLOCATE PGJM_CURSOR


--SELECT  * FROM HADMF WHERE NOADMISION='0100071358' AND N_FACTURA='F003-00066366'

--ROLLBACK

--SELECT * FROM RPDX WHERE CNS='0100392875'
--SELECT FACTURADA,MARCA,USUARIOMARCA
--FROM HPRED INNER JOIN FTRD ON HPRED.NOPRESTACION=FTRD.NOPRESTACION AND FTRD.NOITEM=HPRED.NOITEM
--WHERE FTRD.N_FACTURA='F003-00066366'
--AND FTRD.NOADMISION='0100071358'

--COMMIT

SELECT  * FROM #A