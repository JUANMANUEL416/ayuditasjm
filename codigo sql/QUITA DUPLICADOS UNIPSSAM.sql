use KUNIPSSAM

SELECT NOADMISION,PREFIJO,CONVERT(DATE,FECHA)FECHA,CONSECUTIVOHCA INTO #A
FROM HPRE 
WHERE FECHA>='31/01/2024'
AND COALESCE(CONSECUTIVOHCA,'')<>''
GROUP BY NOADMISION,PREFIJO,CONVERT(DATE,FECHA),CONSECUTIVOHCA 
HAVING COUNT(*)>1

SELECT NOADMISION,PREFIJO,CONVERT(DATE,FECHA)FECHA,CONSECUTIVOHCA INTO #A
FROM HPRE 
WHERE FECHA>='01/01/2023'
AND COALESCE(CONSECUTIVOHCA,'')<>''
GROUP BY NOADMISION,PREFIJO,CONVERT(DATE,FECHA),CONSECUTIVOHCA 
HAVING COUNT(*)>1



SELECT  * FROM HPRE WHERE CONSECUTIVOHCA='0200019688'

DROP TABLE #B


SELECT NOADMISION,NOPRESTACION,CONVERT(DATE,FECHA)FECHA,PREFIJO,ROW_NUMBER() OVER(PARTITION BY NOADMISION,
CONVERT(DATE,FECHA),PREFIJO ORDER BY NOADMISION, CONVERT(DATE,FECHA) DESC)NRO INTO #B
FROM HPRE 
WHERE  FECHA >='31/01/2025'
AND HPRE.PROCEDENCIA='HCA'
AND NOT EXISTS(SELECT * FROM HPRED WHERE COALESCE(HPRED.FACTURADA,0)=1 AND HPRED.NOPRESTACION=HPRE.NOPRESTACION)


DELETE #B WHERE NRO =1

SELECT  * FROM #B

DELETE HPRED WHERE NOPRESTACION IN(SELECT  NOPRESTACION FROM #B) AND COALESCE(FACTURADA,0)=0
DELETE HPRE WHERE NOPRESTACION IN(SELECT  NOPRESTACION FROM #B)

SELECT  * FROM HPRE WHERE NOPRESTACION='0200047867'

SELECT 
FROM HPRE INNER JOIN HPRED ON HPRE.NOPRESTACION=HPRED.NOPRESTACION
WHERE HPRE.IDTERCEROCA=''


SELECT  * FROM CIT WHERE CONSECUTIVO='0200007562' 

UPDATE CIT SET VALORCOPAGO=0,GENEROCAJA=0 WHERE CONSECUTIVO='0200007562' 

DROP TABLE #A

SELECT NOPRESTACION,NOITEM,REFERENCIA,CANTIDAD,VALOR,VLR_COPAGOS,VLR_SERVICI,FTRD.VR_TOTAL ,FTR.N_FACTURA, NOADMISION,PREFIJO,FECHAPREST,FTR.IDTERCERO,FTR.IDPLAN INTO #A 
FROM FTRD INNER JOIN FTR ON FTRD.N_FACTURA=FTR.N_FACTURA
WHERE NOT EXISTS(SELECT * FROM HPRED WHERE HPRED.NOPRESTACION=FTRD.NOPRESTACION AND FTRD.NOITEM=HPRED.NOITEM )
AND FTRD.FECHA>='31/01/2024'
--AND FTR.N_FACTURA='UV10602'
AND FTR.ESTADO='P'
AND COALESCE(FTR.TIPOANULACION,'')<>'NC'
AND FTRD.NOADMISION<>FTRD.NOPRESTACION


SELECT * FROM F

SELECT  * FROM KPUNIPSSAM.DBO.FTR WHERE N_fACTURA='UV7991'

INSERT INTO HPRED (NOPRESTACION,NOITEM,IDSERVICIO,CANTIDAD,VALOR,VALORCOPAGO,VALOREXCEDENTE,FACTURADA,N_FACTURA)
SELECT DISTINCT NOPRESTACION,NOITEM,REFERENCIA,CANTIDAD,VALOR,VLR_COPAGOS,(CANTIDAD*VALOR)-COALESCE(VLR_COPAGOS,0),1,N_FACTURA FROM #A
WHERE  NOT EXISTS(SELECT * FROM HPRED WHERE HPRED.NOPRESTACION=#A.NOPRESTACION AND HPRED.NOITEM=#A.NOITEM)

SELECT * FROM #A WHERE NOPRESTACION='0300012017' AND NOITEM=3
SELECT * FROM FTRD WHERE NOPRESTACION='0300012017' AND NOITEM=3

SELECT * FROM FTR WHERE N_FACTURA='UV10590'

SELECT DISTINCT NOPRESTACION,NOADMISION,PREFIJO,FECHAPREST FROM #A
WHERE NOT EXISTS(SELECT  * FROM HPRE WHERE #A.NOPRESTACION=HPRE.NOPRESTACION)

DROP TABLE #B
SELECT TOP 1  * INTO #B FROM HPRE WHERE COALESCE(PROCEDENCIA,'')=''

SELECT  DBO.FNK_COLUMNAS_TABLAS('HPRE')

INSERT INTO HPRE
SELECT DISTINCT #A.NOPRESTACION, #A.NOADMISION, #A.FECHAPREST, #A.IDPLAN, IDAREAH, NIVELATENCION, IDAREA, IDSEDE, ALTOCOSTO, NO_ITEMES, VALORTOTAL, VALORCOPAGO, VALOREXEDENTE, IMPRESO, AUTORIZADOPOR, NUMAUTORIZA, FECHAAUTORIZA, 
AUTORIZADO, USUARIO, CERRADA, VALORPCOMP, CIRUGIA, PCUBRIMIENTO, CLASEORDEN, CONSECUTIVO, ESDEINV, PEDIDOINV, CNSMOV, INDDEVOLUCION, #A.PREFIJO, CCOSTO, SUBCCOSTO, FINALIDAD, 
AMBITO, PERSONAL_AT, DXPPAL, DXRELACIONADO, COMPLICACION, FORMAQX, ESCONSULTA, IDAREAEQUIPO, IMPRESOP, IDMEDICO, COBRARA,#A.IDTERCERO, CONSECUTIVOHCA, ITEMRED, ENLAB, ITFC, 
CNSITFC, SYS_COMPUTERNAME, CNSLABCOR, CODEVAL, IDAREAAUX, INDLABCORE, CCOSTOAUX, CONTABILIZADA, NROCOMPROBANTE, MARCACONT, NOPLANTILLA, SINCRONIZADO, ANULADO, PROCEDENCIA, VALIDADO, 
TIPOHISTORIA, CODOM, CONTABNIIF, NROCOMPROBANTENIIF, REVAUD, USUREVAUD, F_REVAUD, #B.FECHA_SH, COMERCIAL
FROM #A,#B
WHERE NOT EXISTS(SELECT * FROM HPRE WHERE HPRE.NOPRESTACION=#A.NOPRESTACION)




SELECT  * FROM  NPLTCA WHERE IDPLANTILLA='001'


INSERT INTO NPLTCA
SELECT '007',CODCARGO,NIVEL,GRADO FROM  NPLTCA WHERE IDPLANTILLA='001'



SELECT  * FROM  FTRD WHERE N_FACTURA='UV8728'

UPDATE FTR SET PDF=0 WHERE N_FACTURA IN('UV10246','UV10739','UV10742','UV10743')

SELECT FTRD.NOPRESTACION,NOITEM INTO #F FROM FTRD WHERE N_FACTURA='UV10602'
SELECT NOPRESTACION,NOITEM INTO #G FROM HPRED WHERE N_FACTURA='UV10602'

SELECT NOPRESTACION,NOITEM,REFERENCIA,CANTIDAD,VALOR,VLR_COPAGOS,VLR_SERVICI,FTRD.VR_TOTAL ,FTR.N_FACTURA, NOADMISION,PREFIJO,FECHAPREST,FTR.IDTERCERO,FTR.IDPLAN --INTO #A 
FROM FTRD INNER JOIN FTR ON FTRD.N_FACTURA=FTR.N_FACTURA
WHERE NOT EXISTS(SELECT * FROM HPRED WHERE HPRED.NOPRESTACION=FTRD.NOPRESTACION AND FTRD.NOITEM=HPRED.NOITEM AND FTRD.N_FACTURA=HPRED.N_FACTURA)
AND FTRD.N_FACTURA='UV10602'
AND FTRD.NOADMISION<>FTRD.NOPRESTACION

SELECT * FROM #F WHERE NOT EXISTS(SELECT * FROM #G WHERE #F.NOPRESTACION=#G.NOPRESTACION AND #F.NOITEM=#G.NOITEM)

SELECT * FROM HPRE INNER JOIN HPRED ON HPRE.NOPRESTACION=HPRED.NOPRESTACION
WHERE HPRE.FECHA>='31/01/2024'
AND COALESCE(FACTURADA,0)=0
AND HPRED.IDSERVICIO IN('931001','941400','944101','944102','890315','990113')

DELETE HPRED FROM HPRE INNER JOIN HPRED ON HPRE.NOPRESTACION=HPRED.NOPRESTACION
WHERE HPRE.FECHA>='31/01/2024'
AND COALESCE(FACTURADA,0)=0
AND HPRED.IDSERVICIO IN('931001','941400','944101','944102','890315','990113')

DELETE HPRE WHERE NOT EXISTS(SELECT * FROM HPRED WHERE HPRE.NOPRESTACION=HPRED.NOPRESTACION)

SELECT HPRED.NOPRESTACION,HPRED.NOITEM,HPRED.IDSERVICIO,ROW_NUMBER() OVER(ORDER  BY HPRED.IDSERVICIO ASC) ID INTO #A
FROM HPRE INNER JOIN HPRED ON HPRE.NOPRESTACION=HPRED.NOPRESTACION
WHERE HPRE.NOADMISION='0500000372'
AND HPRED.IDSERVICIO='943102'


DELETE HPRED FROM HPRED INNER JOIN #A ON HPRED.NOPRESTACION=#A.NOPRESTACION AND HPRED.NOITEM=#A.NOITEM