IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='SPK_HCASER_SERTOT' AND XTYPE='P')
BEGIN
   DROP PROCEDURE SPK_HCASER_SERTOT
END

GO
CREATE PROCEDURE DBO.SPK_HCASER_SERTOT
@CONSECUTIVO VARCHAR(16),
@NOADMISION  VARCHAR(16),
@CLASEPLANTILLA VARCHAR(8) 
WITH ENCRYPTION
AS
DECLARE 
   @FECHA DATETIME,
   @IDTERCERO VARCHAR(16),
   @IDPLAN    VARCHAR(10), 
   @IDSERVICIO VARCHAR(20), 
   @CANTDEFAULT DECIMAL(14,2), 
   @AUTOMATICO TINYINT, 
   @DIARIAS SMALLINT,
   @PROCEDENCIA VARCHAR(5),
   @IDEMEDICA VARCHAR(5),
   @CONSECUTIVOCIT VARCHAR(20),
   @ATENCION VARCHAR(12),
   @IX VARCHAR(20),
   @SEXO VARCHAR(12)
BEGIN
   SELECT @FECHA=CONVERT(DATE,GETDATE())
   SELECT @IX=dbo.FNK_VALORVARIABLE('IXCOUNTRY')

   SELECT @PROCEDENCIA=HCA.PROCEDENCIA, @IDEMEDICA=MED.IDEMEDICA, @CONSECUTIVOCIT= CASE WHEN COALESCE(HCA. PROCEDENCIA,'')<> 'QX' THEN  @NOADMISION ELSE ISNULL(CONSECUTIVOCIT,'') END , @SEXO=AFI.SEXO
   FROM HCA 
    INNER JOIN AFI ON AFI.IDAFILIADO=HCA.IDAFILIADO
    LEFT JOIN MED ON MED.IDMEDICO=HCA.IDMEDICO
   WHERE HCA.CONSECUTIVO=@CONSECUTIVO

   IF @PROCEDENCIA='QX'
   BEGIN
      SELECT @IDTERCERO=IDTERCERO,@IDPLAN=IDPLAN FROM HADM WHERE NOADMISION=@NOADMISION
      IF @CONSECUTIVOCIT<>''
         SELECT @ATENCION=SER.ATENCION
         FROM CIT INNER JOIN SER ON SER.IDSERVICIO=CIT.IDSERVICIO
         WHERE CONSECUTIVO=@CONSECUTIVOCIT
   END
   ELSE
   BEGIN
      SELECT @IDTERCERO=IDTERCEROCA,@IDPLAN=IDPLAN FROM CIT WHERE CONSECUTIVO=@NOADMISION
   END

   IF @IDTERCERO IS NULL
   BEGIN
      SELECT @IDTERCERO=IDADMINISTRADORA, @IDPLAN=IDPLAN FROM AFI WHERE IDAFILIADO=(SELECT IDAFILIADO FROM HCA WHERE CONSECUTIVO=@CONSECUTIVO)
   END

   PRINT '@IDTERCERO ='+@IDTERCERO+' @IDPLAN ='+@IDPLAN

   DECLARE HC CURSOR FOR
   SELECT DISTINCT A.IDSERVICIO, CANTDEFAULT, AUTOMATICO, COALESCE(DIARIAS ,0)
   FROM   MPLSER A INNER JOIN CPPAF B ON A.IDSERVICIO = B.IDSERVICIO
                   INNER JOIN SER C ON C.IDSERVICIO=A.IDSERVICIO
   WHERE  B.IDPLAN         = @IDPLAN 
   AND    COALESCE(B.IDTERCEROCA,'') = CASE WHEN B.COBRARA = 'O' THEN COALESCE(B.IDTERCEROCA,'') ELSE @IDTERCERO END 
   AND    A.CLASEPLANTILLA = @CLASEPLANTILLA 
   AND    ISNULL(C.IDEMEDICA,'')=(CASE ISNULL(C.IDEMEDICA,'') WHEN '' THEN ISNULL(C.IDEMEDICA,'') ELSE @IDEMEDICA END)
   AND    ISNULL(REPLACE(C.ATENCION,'Todos',''),'')=(CASE ISNULL(REPLACE(C.ATENCION,'Todos',''),'') WHEN '' THEN ISNULL(REPLACE(C.ATENCION,'Todos',''),'') ELSE @ATENCION END)
   --AND    ISNULL(REPLACE(C.ATENCION,'Todos',''),'')=(CASE ISNULL(REPLACE(C.ATENCION,'Todos',''),'') WHEN '' THEN (CASE @IX WHEN 'PERU' THEN 'Domiciliaria' ELSE ISNULL(REPLACE(C.ATENCION,'Todos',''),'') END) ELSE @ATENCION END)
   AND   (COALESCE(A.SEXO,'Ambos')=@SEXO OR COALESCE(A.SEXO,'Ambos')='Ambos') 
   --AND A.IDSERVICIO = ( CASE WHEN @PROCEDENCIA <> 'QX'  --SE CAMBIA SELECT YA QUE EXISTE CONSECUTIVOCIT = '' EN CIT.CONSECUTIVO
   --                          THEN ( SELECT IDSERVICIO FROM CIT WHERE CONSECUTIVO = @CONSECUTIVOCIT )
   --                          ELSE A.IDSERVICIO 
   --                     END )

   OPEN HC
   FETCH NEXT FROM HC
   INTO @IDSERVICIO, @CANTDEFAULT, @AUTOMATICO, @DIARIAS
   WHILE @@FETCH_STATUS = 0
   BEGIN
      IF @DIARIAS = 0 
      BEGIN
          INSERT INTO HCASER (CONSECUTIVO, IDSERVICIO, CANTIDAD, AUTOMATICO)
          SELECT @CONSECUTIVO, @IDSERVICIO, @CANTDEFAULT, @AUTOMATICO
      END
      ELSE
      BEGIN
         IF (SELECT COUNT(*) 
             FROM   HCA INNER JOIN HCASER ON HCA.CONSECUTIVO = HCASER.CONSECUTIVO
             WHERE  HCA.NOADMISION     =  @NOADMISION
             AND    HCA.CLASEPLANTILLA =  @CLASEPLANTILLA
             AND    HCA.CONSECUTIVO    <> @CONSECUTIVO
             AND    HCASER.IDSERVICIO  =  @IDSERVICIO
             AND    CONVERT(DATE,HCA.FECHA)=@FECHA
             AND    COALESCE(HCASER.NOPRESTACION,'') <> '' ) < @DIARIAS
         BEGIN
             IF dbo.FNK_VALORVARIABLE('IXCOUNTRY')='PERU'
             BEGIN
                 SELECT @IDPLAN=IDPLAN FROM CIT WHERE CONSECUTIVO=@CONSECUTIVOCIT
                 IF @IDPLAN IN ('PAQ027','PAR028')
                 BEGIN
                    IF NOT EXISTS (SELECT 1 FROM HPRE INNER JOIN HPRED ON HPRE.NOPRESTACION=HPRED.NOPRESTACION WHERE HPRE.NOADMISION=@NOADMISION AND HPRED.IDSERVICIO=@IDSERVICIO AND ISNULL(HPRED.ANULADO,0)=0)
                    BEGIN
                        INSERT INTO HCASER (CONSECUTIVO, IDSERVICIO, CANTIDAD, AUTOMATICO)
                        SELECT @CONSECUTIVO, @IDSERVICIO, @CANTDEFAULT, @AUTOMATICO
                    END
                 END
                 ELSE
                 BEGIN
                     INSERT INTO HCASER (CONSECUTIVO, IDSERVICIO, CANTIDAD, AUTOMATICO)
                     SELECT @CONSECUTIVO, @IDSERVICIO, @CANTDEFAULT, @AUTOMATICO
                 END
             END
             ELSE
             BEGIN
                 INSERT INTO HCASER (CONSECUTIVO, IDSERVICIO, CANTIDAD, AUTOMATICO)
                 SELECT @CONSECUTIVO, @IDSERVICIO, @CANTDEFAULT, @AUTOMATICO
             END
         END
      END
      FETCH NEXT FROM HC
      INTO @IDSERVICIO, @CANTDEFAULT, @AUTOMATICO, @DIARIAS
   END
   CLOSE HC
   DEALLOCATE HC
END

