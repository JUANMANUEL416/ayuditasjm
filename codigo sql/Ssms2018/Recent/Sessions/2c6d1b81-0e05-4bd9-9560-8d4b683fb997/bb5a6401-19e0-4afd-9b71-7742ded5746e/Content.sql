IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='SPK_NC_CONTAB_FTR' AND XTYPE='P')
BEGIN
   DROP PROCEDURE SPK_NC_CONTAB_FTR
END
GO
CREATE PROCEDURE DBO.SPK_NC_CONTAB_FTR
@N_FACTURA           VARCHAR(16),
@COMPANIA            VARCHAR(2),
@USUARIO             VARCHAR(12),
@SYS_COMPUTERNAME    VARCHAR(254),
@SEDE                VARCHAR(5),
@NROCOMPROBANTE      VARCHAR(20) 
WITH ENCRYPTION
AS
DECLARE @NVOCONSEC	   VARCHAR(20)
DECLARE @MAUX		      VARCHAR(20)
DECLARE @MREAL		      VARCHAR(20)
DECLARE @ASAUX		      VARCHAR(20)
DECLARE @ANO		      VARCHAR(4)
DECLARE @MES		      INT
DECLARE @OK		         INT
DECLARE @DONDE          INT
DECLARE @NOREFERENCIA   VARCHAR(20)
DECLARE @PROCEDENCIA    VARCHAR(10)
DECLARE @TIPOFAC	      VARCHAR(1) 
DECLARE @TIPO		      VARCHAR(2) 
DECLARE @CUENTA         VARCHAR(16)
DECLARE @CUENTA_KMCO    VARCHAR(16)
DECLARE @VR_TOTAL       FLOAT ,        @CUESINDETA    VARCHAR(20),   @PASO BIT,     @PGP SMALLINT
DECLARE @VALORCOPAGO    DECIMAL(14,2), @DESCUENTO	   DECIMAL(14,2), @VALORPCOMP	   DECIMAL(14,2), @VALORSERVICIOS DECIMAL(14,2)
DECLARE @VR_ABONOS	   DECIMAL(14,2), @VR_IVA   	   DECIMAL(14,2), @TIPOCOPAGO	   VARCHAR(20)
DECLARE @TIPO_DED	      VARCHAR(20),   @IDMODELOCONT   VARCHAR(2)
DECLARE @TIPO_T         VARCHAR(2),    @CUENTA_T       VARCHAR(16), @IDAREA_T       VARCHAR(10), @CCOSTO_T       VARCHAR(20)
DECLARE @IDTERCERO_T    VARCHAR(20),   @PREFIJO_T      VARCHAR(6),  @ESTADO         VARCHAR(1)
DECLARE @COM            VARCHAR(2),    @PREFIJO_USCXS  VARCHAR(10), @FECHATRA       DATETIME
DECLARE @MIVA           SMALLINT,      @PIVA           DECIMAL(14,2), @IDAFILIADO     VARCHAR(20)
DECLARE @IDCATEGORIA    VARCHAR(10),   @VLR_IMPUESTOS  DECIMAL(14,2), @IDIMPUESTO     VARCHAR(20), @IDCLASE        VARCHAR(20)
DECLARE @VALORFTRI      DECIMAL(14,2), @VALOR_IMP      DECIMAL(14,2), @ABONOS_MCH     DECIMAL(14,2), @NROASIENTO     DECIMAL(14,0)
DECLARE @CAPITADA       SMALLINT,      @CNSFTR         VARCHAR(40),   @PYG            DECIMAL(14,2), @DIFECOPAGOS DECIMAL(14,2)
DECLARE @CODUNG         VARCHAR(2),   @CODPRG          VARCHAR(2), @VLR_COPAGOEXT  DECIMAL(14,2), @CONTABILIZADA  SMALLINT
DECLARE @ESTADOMCPE     VARCHAR(1),   @DIFERENCIA      DECIMAL(14,2), @IMPAUTOCREE  VARCHAR(11), @FACTORCREE DECIMAL(14,2)
DECLARE @CNSCXC_AUT VARCHAR(20),      @IDTERCERO  VARCHAR(20),      @IDTERCEROAFI  VARCHAR(20),         @FECHA      DATETIME,     @VALORTOTAL DECIMAL(14,2)
DECLARE @NOADMISION VARCHAR(20),      @ADICIONALPTE SMALLINT, @VLRPYG DECIMAL(14,2), @VRTOTALSERCAP DECIMAL (14,2), @VALORFTR DECIMAL(14,2), @TOTALCUEIN INT
DECLARE @VLRINSERT DECIMAL(14,2)     ,@I INT        ,@VALORCR DECIMAL(14,2)         ,@DIF     DECIMAL(14,2)       ,@VALORI   DECIMAL(14,2) ,@FALTANTE DECIMAL(14,2),@VLRDEBITOS DECIMAL(14,2)
BEGIN
   PRINT 'AQUI ENTRE A SPK_NC_CONTAB_FTR'
   IF UPPER(DBO.FNK_VALORVARIABLE('CONTAB_IMP_FTR')) = 'SI'
   BEGIN
      IF UPPER(DBO.FNK_VALORVARIABLE('ANTIPO_IMP_RESTA_FTR'))='NO'
      BEGIN 
         IF NOT EXISTS(SELECT * FROM CUE WHERE CUENTA=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('CUENTA_CR_ANTIMPUEST'))) AND TIPO='Detalle')
         BEGIN
            PRINT 'No Existe la Cuenta Credito de Anticipo de Impuestos No se puede Continuar'
            RETURN
         END 
      END
   END
    SELECT @ANO= YEAR(F_FACTURA),  @MES= MONTH(F_FACTURA) FROM FTR WHERE N_FACTURA = @N_FACTURA
   IF NOT EXISTS(SELECT COMPANIA,ANO,MES FROM PRI WHERE COMPANIA=@COMPANIA AND ANO=@ANO AND MES=@MES)
   BEGIN
      /*JEDM:09.AGO.2011 NO DEJAMOS CREAR AUTOMATICAMENTE EL PERIODO COMO ERA ANTES*/
      PRINT 'Periodo Contable no Existe no se Puede Contabilizar '
      RAISERROR('Periodo Contable no Existe no se Puede Contabilizar ', 16, 1)
      RETURN
   END
   ELSE
   BEGIN
      IF (SELECT COALESCE(CERRADO,0) FROM PRI WHERE COMPANIA=@COMPANIA AND ANO=@ANO AND MES=@MES) = 1
      BEGIN
         /*JEDM:09.AGO.2011 NO DEJAMOS CONTABILIZAR SI EL PERIODO CONTABLE ESTA CERRADO*/
         PRINT 'Periodo Contable Esta Cerrado, No se Puede Contabilizar '
         RAISERROR('Periodo Contable Esta Cerrado, No se Puede Contabilizar ', 16, 1)
         RETURN        
      END
   END
   SELECT @PGP=0
   
   IF (SELECT ISNULL(CAPITADA,0) FROM FTR WHERE N_FACTURA = @N_FACTURA)=1 --AND  @PGP=0
   BEGIN
      PRINT '-- Factura financiera Capitada' 
	  SELECT @CNSFTR=CNSFCT FROM FTR WHERE N_FACTURA=@N_FACTURA 
      UPDATE FTR SET CP_VLR_SERVICIOS = V.VALORTOTAL, CP_VLR_COPAGOS   =ROUND(CASE WHEN COALESCE(COPAPROPIO,0)=1 THEN CP_VLR_COPAGOS ELSE V.VALORCOPAGO END,0), CP_VLR_PAGCOMP = 0
	  ,COPAGO_INT=ROUND(CASE WHEN COALESCE(COPAPROPIO,0)=1 THEN V.VALORCOPAGO-CP_VLR_COPAGOS ELSE 0  END,0)
      FROM (SELECT VALORTOTAL = SUM(VALORTOTAL), VALORCOPAGO = SUM(VLR_COPAGO), VALORPCOMP = SUM(vlr_pagcomp)   
            FROM FTRDC WHERE CNSFTR = @CNSFTR) V  
      WHERE CNSFCT = @CNSFTR 

      SELECT @DIFECOPAGOS=CASE WHEN COALESCE(COPAPROPIO,0)=1 THEN COALESCE(COPAGO_INT,0) ELSE 0 END
      FROM FTR WHERE N_FACTURA = @N_FACTURA
      PRINT '@DIFECOPAGOS ='+STR(@DIFECOPAGOS)
      SELECT @PGP=2
   END
   IF EXISTS(SELECT * FROM PPT INNER JOIN FTR ON FTR.IDTERCERO=PPT.IDTERCERO AND FTR.IDPLAN=PPT.IDPLAN WHERE FTR.N_FACTURA=@N_FACTURA AND COALESCE(PPT.PGP,0)=1)
   BEGIN
      SELECT @PGP=1
   END
   SELECT @CONTABILIZADA = CONTABILIZADA,@DIFERENCIA=CASE WHEN VALORSERVICIOS<VALORCOPAGO THEN VALORCOPAGO-VALORSERVICIOS ELSE 0 END FROM FTR WHERE N_FACTURA = @N_FACTURA
   SET @IDMODELOCONT = DBO.FNK_VALORVARIABLE('IDMODELOCONTABLE')
   PRINT '@NROCOMPROBANTE:' + ISNULL(@NROCOMPROBANTE,'') -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
   IF ISNULL(@NROCOMPROBANTE,'') = '' -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
   BEGIN
      SELECT @PROCEDENCIA    = PROCEDENCIA, @NOREFERENCIA = NOREFERENCIA, @TIPOFAC = TIPOFAC, @OK = CONTABILIZADA,
             @VR_TOTAL       = CASE COALESCE(PAQUETE,0) WHEN 0 THEN VR_TOTAL ELSE VALORSERVICIOS END,    
             @VALORCOPAGO	  = CASE WHEN COALESCE(CAPITADA,0)=0 THEN COALESCE(VALORCOPAGO,0) ELSE COALESCE(CP_VLR_COPAGOS,0) END,
             @DESCUENTO	     = DESCUENTO,
             @VALORPCOMP	  = CASE WHEN CAPITADA=0 THEN VALORPCOMP ELSE CP_VLR_PAGCOMP END,
             @VALORSERVICIOS = VALORSERVICIOS,   @VR_ABONOS	     = VR_ABONOS,
             @TIPOCOPAGO	  = TIPOCOPAGO,       @ESTADO         = ESTADO,
             @FECHATRA       = F_FACTURA,
             @MIVA           = MIVA,             @PIVA           = PIVA,
             @CAPITADA       = ISNULL(CAPITADA,0),
             @CNSFTR         = CNSFCT,           @CODUNG         = CODUNG, @CODPRG         = CODPRG
      FROM FTR WHERE N_FACTURA = @N_FACTURA

	  IF (SELECT COUNT(1) FROM MCP WHERE PROCEDENCIA='FACTURA' AND NOREFERENCIA=@N_FACTURA AND ESTADO=2 AND COALESCE(ANULADO,0)=0)>0
	  BEGIN
		PRINT 'ME REGRESO POSIBLE DUPLICIDAD POR FAVOR REVISAR' --20230215 OSOLANO
		RETURN
	  END

      --SE REVISA SI LOS COMPROBANTES SE TOMAN DE ACUERDO A SEDE
      IF (SELECT DBO.FNK_VALORVARIABLE('COMPROBMULTISEDE')) = 'SI'
         SELECT @COM = RTRIM(LTRIM(COMMS.COMPROBANTE)) FROM COMMS WHERE IDSEDE = @SEDE AND COMMS.CLASE = 'FACTURA' AND TIPO = 'FACTURA'
      ELSE
         SET @COM = RTRIM(LTRIM(DBO.FNK_VALORVARIABLE('IDCON_TCOM_FTR')))
      SET @MAUX = SPACE(20) -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
      EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@MCP',@MAUX OUTPUT -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
      SELECT @MAUX = @SEDE + REPLACE(SPACE(8 - CASE WHEN LEN(@MAUX) > 8 THEN 8 ELSE LEN(@MAUX) END) +LTRIM(RTRIM(@MAUX)),SPACE(1),0) -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
      PRINT '@MAUX:' + ISNULL(@MAUX,'') -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
   END
   ELSE
   BEGIN
      IF EXISTS(SELECT * FROM MCP WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND ESTADO=2)
      BEGIN
         RETURN
      END
      PRINT 'SI NRO COMPROBANTE DIFERENTE DE BLANCO'
      SELECT @MAUX = @NROCOMPROBANTE
      SELECT @COM  = COMPROBANTE FROM MCPE WHERE NROCOMPROBANTE = @MAUX
      SELECT @PROCEDENCIA    = PROCEDENCIA, @NOREFERENCIA = NOREFERENCIA, @TIPOFAC = TIPOFAC, @OK = CONTABILIZADA,
             @VR_TOTAL       = CASE COALESCE(PAQUETE,0) WHEN 0 THEN VR_TOTAL ELSE VALORSERVICIOS END,    
             @VALORCOPAGO	  = CASE WHEN COALESCE(CAPITADA,0)=0 THEN COALESCE(VALORCOPAGO,0) ELSE CASE WHEN COPAPROPIO=1 THEN COALESCE(COPAGO_INT,0) ELSE COALESCE(CP_VLR_COPAGOS,0) END END,
             @DESCUENTO	     = DESCUENTO,
             @VALORPCOMP	  = CASE WHEN CAPITADA=0 THEN VALORPCOMP ELSE CP_VLR_PAGCOMP END,
             @VALORSERVICIOS = VALORSERVICIOS,  @VR_ABONOS	    = VR_ABONOS,        @TIPOCOPAGO	 = TIPOCOPAGO, @ESTADO         = ESTADO,
             @ANO            = YEAR(F_FACTURA), @MES            = MONTH(F_FACTURA), @FECHATRA    = F_FACTURA,
             @MIVA           = MIVA,            @PIVA           = PIVA,             @CAPITADA    = ISNULL(CAPITADA,0),
             @CNSFTR         = CNSFCT,          @CODUNG         = CODUNG,           @CODPRG         = CODPRG
      FROM FTR WHERE N_FACTURA = @N_FACTURA


      SELECT @DONDE=COUNT(*) FROM MCP WHERE NROCOMPROBANTE=@NROCOMPROBANTE
      IF @DONDE>0
      BEGIN
         SELECT @COM=COMPROBANTE  FROM MCP WHERE  NROCOMPROBANTE = @NROCOMPROBANTE

         DELETE MCH WHERE NROCOMPROBANTE = @NROCOMPROBANTE
         DELETE MCP WHERE NROCOMPROBANTE = @NROCOMPROBANTE
      END   
      DELETE MCHE WHERE NROCOMPROBANTE = @MAUX  
      DELETE MCPE WHERE NROCOMPROBANTE = @MAUX  
   END
   

   
   IF UPPER(DBO.FNK_VALORVARIABLE('CONTAB_IMP_FTR')) = 'SI'
   BEGIN
      PRINT 'Determinando Valor de Impuestos...'   
      SET   @VLR_IMPUESTOS = 0
      DECLARE CUR_IMP CURSOR FOR
      SELECT FTRI.IDIMPUESTO, FTRI.IDCLASE, FTRI.VALORFTRI, FTRI.VALOR 
      FROM   FTR INNER JOIN FTRI ON FTR.N_FACTURA = FTRI.N_FACTURA 
      WHERE  FTRI.VALOR > 0
      AND    FTR.N_FACTURA = @N_FACTURA
      
      OPEN CUR_IMP      
      FETCH NEXT FROM CUR_IMP
      INTO @IDIMPUESTO, @IDCLASE, @VALORFTRI, @VALOR_IMP        
      WHILE @@FETCH_STATUS = 0
      BEGIN
         SELECT @VLR_IMPUESTOS = @VLR_IMPUESTOS + @VALOR_IMP
         FROM   FTR, 
                FNK_CALCULO_IMPUESTO(@IDIMPUESTO, @IDCLASE, @VALORSERVICIOS, @FECHATRA) I LEFT JOIN FIMP ON IDIMPUESTO = @IDIMPUESTO 
         WHERE  N_FACTURA = @N_FACTURA
         FETCH NEXT FROM CUR_IMP
         INTO @IDIMPUESTO, @IDCLASE, @VALORFTRI, @VALOR_IMP 
      END
      CLOSE CUR_IMP
      DEALLOCATE CUR_IMP
   END
   --------- FACTURAS ARS -----------
   IF @PROCEDENCIA='ARS'
   BEGIN
      PRINT 'ARS'     
      DECLARE @idalterna AS VARCHAR (20)
      SET @idalterna = ( SELECT CNT.IDALTERNA   FROM CNT INNER JOIN FTRD ON FTRD.NOADMISION = CNT.IDCONTRATO 
    						                           INNER JOIN FTR  ON FTR.CNSFCT      = FTRD.CNSFTR
                         WHERE  FTR.N_FACTURA = @N_FACTURA )
      ----------------------------------------------------------------------------------------
      IF @NOREFERENCIA='REC-IPS' OR @NOREFERENCIA='INC-UPC' OR @NOREFERENCIA='PER-NOV' OR @NOREFERENCIA='MANUAL'
      BEGIN
         EXEC  SPK_CONTAB_FTR_ARSPROC @N_FACTURA, @COMPANIA, @USUARIO, @SYS_COMPUTERNAME, @SEDE, '' 
      END 
      ELSE
      BEGIN
         INSERT INTO MCPE(NROCOMPROBANTE, COMPANIA, PROCEDENCIA, NOREFERENCIA, ANO, MES, FECHACONTABLE, TOTALDEBITO,
                          TOTALCREDITO, REFERENCIA1, REFERENCIA2, USUARIO, FECHA, LOTE, OBSERVACION, IDSEDE, ESTADO, 
                          COMPROBANTE, IDTERCERO)
	    SELECT @MAUX, @COMPANIA, 'FACTURA', @N_FACTURA, @ANO, @MES, CAST(STR(DAY(F_FACTURA))+'/'+LTRIM(STR(@MES))+'/'+@ANO AS DATETIME),
		      0, 0, FTR.NOREFERENCIA, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), NULL, 'FACTURA DE VENTA No. '+FTR.N_FACTURA, 
		      @SEDE, 0, @COM, (CASE WHEN FTR.IDTERCERO IS NULL THEN '' ELSE FTR.IDTERCERO END)
	    FROM   FTR 
         WHERE  FTR.N_FACTURA = @N_FACTURA
	    
         IF @ESTADO='A' 
         BEGIN 
            UPDATE MCP SET ESTADO='2', ANULADO=1, TOTALDEBITO=0, TOTALCREDITO=0 
            WHERE COMPANIA=@COMPANIA AND NROCOMPROBANTE=@MAUX
            UPDATE FTR SET CONTABILIZADA=1, MARCACONT=0, NROCOMPROBANTE=@MAUX WHERE N_FACTURA = @N_FACTURA
            RETURN
	    END
      	           
         PRINT 'Contabilizando Debitos....'
         PRINT 'Servicios.'
         INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
                          REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, CLASECONT, 
                          ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO,
                          N_FACTURA, F_FACTURAREF, F_VENCE)
         SELECT @MAUX, @COMPANIA, 'DB', CNTCF.CUENTA_DB, CNT.IDTERCERO, CNT.CCOSTO, 
                RTRIM(TER.RAZONSOCIAL)+',  FACTURA No. '+@N_FACTURA+' - '+CNTCF.DESCCONCEPTO+', FUENTE: '+FTRD.REFERENCIA, 
		      SUM(FTRD.VR_TOTAL), FTRD.NOADMISION, FTRD.REFERENCIA, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
		      FTRD.NOPRESTACION, NULL, 'S', 1, 'CXC', 'Movimiento', 'FACTURA', @N_FACTURA,
		      @N_FACTURA, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE)
         FROM   FTR INNER JOIN FTRD  ON FTR.CNSFCT = FTRD.CNSFTR
                     LEFT JOIN CNTPC ON FTRD.NOADMISION      = CNTPC.IDCONTRATO 
                                    AND FTRD.NOPRESTACION    = CNTPC.IDCONCEPTO 
							 AND FTRD.REFERENCIA      = CNTPC.CODIGOINTERNO 
							 AND FTRD.TIPOCONTRATOARS = CNTPC.TIPOCONTRATOARS 
							 AND FTRD.ARSTIPOCONTRATO = CNTPC.ARSTIPOCONTRATO 
							 AND FTRD.ANO             = CNTPC.ANO 
							 AND FTRD.MES             = CNTPC.MES 
			      LEFT JOIN   CNT ON CNTPC.IDCONTRATO     = CNT.IDCONTRATO 
			      LEFT JOIN   TER ON CNT.IDTERCERO        = TER.IDTERCERO 
				 LEFT JOIN CNTCF ON FTRD.TIPOCONTRATOARS = CNTCF.TIPOCONTRATOARS 
				                AND FTRD.ARSTIPOCONTRATO = CNTCF.ARSTIPOCONTRATO 
				                AND FTRD.NOPRESTACION    = CNTCF.IDCONCEPTO
         WHERE  FTR.N_FACTURA = @N_FACTURA
         GROUP BY CNTCF.CUENTA_DB, CNT.IDTERCERO, CNT.CCOSTO, TER.RAZONSOCIAL, FTRD.NOADMISION, CNTCF.DESCCONCEPTO, 
	             FTRD.REFERENCIA, FTRD.NOPRESTACION, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE)
   	          
	    PRINT 'Cuenta de Orden.'
         INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
	                     REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, CLASECONT, 
                          ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE)
	    SELECT @MAUX, @COMPANIA, 'DB', CNTCF.CUENTAORDEN_DB, CNT.IDTERCERO, CNT.CCOSTO, 
		      'CUENTA DE ORDEN, FACTURA No. '+@N_FACTURA, SUM(FTRD.VR_TOTAL), FTRD.NOADMISION, NULL, NULL, @USUARIO, 
		      DBO.FNK_FECHA_SIN_MLS(GETDATE()), NULL, NULL, 'P', 1, 'CUEORDEN', 'Movimiento','FACTURA', @N_FACTURA,
		      @N_FACTURA, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE)
         FROM FTRD INNER JOIN FTR   ON FTR.CNSFCT = FTRD.CNSFTR
                    LEFT JOIN CNTPC ON FTRD.NOADMISION      = CNTPC.IDCONTRATO 
                                   AND FTRD.NOPRESTACION    = CNTPC.IDCONCEPTO 
                                   AND FTRD.REFERENCIA      = CNTPC.CODIGOINTERNO 
                                   AND FTRD.TIPOCONTRATOARS = CNTPC.TIPOCONTRATOARS 
                                   AND FTRD.ARSTIPOCONTRATO = CNTPC.ARSTIPOCONTRATO 
                                   AND FTRD.ANO             = CNTPC.ANO 
                                   AND FTRD.MES             = CNTPC.MES 
                    LEFT JOIN CNT   ON CNTPC.IDCONTRATO     = CNT.IDCONTRATO 
                    LEFT JOIN TER   ON CNT.IDTERCERO        = TER.IDTERCERO 
                    LEFT JOIN CNTCF ON FTRD.TIPOCONTRATOARS = CNTCF.TIPOCONTRATOARS 
                                   AND FTRD.ARSTIPOCONTRATO = CNTCF.ARSTIPOCONTRATO 
                                   AND FTRD.NOPRESTACION    = CNTCF.IDCONCEPTO
         WHERE  FTR.N_FACTURA = @N_FACTURA
	    GROUP BY CNTCF.CUENTAORDEN_DB, CNT.IDTERCERO, CNT.CCOSTO, FTRD.NOADMISION, 
			    DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE)
   	  
	    PRINT 'Contabilizando Creditos....'
	    PRINT 'Venta.'
	    INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
	 				REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, CLASECONT, 
					ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE, IDPROVEEDOR)
	    SELECT @MAUX, @COMPANIA, 'CR', CNTCF.CUENTA_CR, CNT.IDTERCERO, CNT.CCOSTO, 
		     CNTCF.DESCCONCEPTO+', FUENTE: '+FTRD.REFERENCIA, FTRD.VR_TOTAL,
		     FTRD.NOADMISION, FTRD.REFERENCIA, FTRD.NOITEM, @USUARIO, 
		     DBO.FNK_FECHA_SIN_MLS(GETDATE()), FTRD.NOPRESTACION, NULL, 'S', 1, 'VENTAS', 'Movimiento',
		     'FACTURA', @N_FACTURA,
		     @N_FACTURA, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), FTRD.IDPROVEEDOR
	    FROM   FTRD INNER JOIN FTR   ON FTRD.CNSFTR          = FTR.CNSFCT
                     LEFT JOIN CNTPC ON FTRD.NOADMISION      = CNTPC.IDCONTRATO 
                                    AND FTRD.NOPRESTACION    = CNTPC.IDCONCEPTO 
                                    AND FTRD.REFERENCIA      = CNTPC.CODIGOINTERNO 
                                    AND FTRD.TIPOCONTRATOARS = CNTPC.TIPOCONTRATOARS 
                                    AND FTRD.ARSTIPOCONTRATO = CNTPC.ARSTIPOCONTRATO 
                                    AND FTRD.ANO             = CNTPC.ANO 
                                    AND FTRD.MES             = CNTPC.MES 
                     LEFT JOIN CNT   ON CNTPC.IDCONTRATO     = CNT.IDCONTRATO 
                     LEFT JOIN TER   ON CNT.IDTERCERO        = TER.IDTERCERO 
                     LEFT JOIN CNTCF ON FTRD.TIPOCONTRATOARS = CNTCF.TIPOCONTRATOARS 
                                    AND FTRD.ARSTIPOCONTRATO = CNTCF.ARSTIPOCONTRATO 
                                    AND FTRD.NOPRESTACION    = CNTCF.IDCONCEPTO
         WHERE  FTR.N_FACTURA = @N_FACTURA
         PRINT 'Cuenta de Orden.'
	    INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
					REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, CLASECONT, 
					ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE)
	    SELECT @MAUX, @COMPANIA, 'CR', CNTCF.CUENTAORDEN_CR, CNT.IDTERCERO, CNT.CCOSTO, 
		      'CUENTA DE ORDEN, FACTURA No. '+@N_FACTURA, SUM(FTRD.VR_TOTAL), FTRD.NOADMISION, NULL, NULL, @USUARIO, 
		      DBO.FNK_FECHA_SIN_MLS(GETDATE()), NULL, NULL, 'P', 1, 'CUEORDEN', 'Movimiento','FACTURA', @N_FACTURA,
		      @N_FACTURA, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE)
	    FROM   FTRD INNER JOIN FTR   ON FTRD.CNSFTR          = FTR.CNSFCT
                     LEFT JOIN CNTPC ON FTRD.NOADMISION      = CNTPC.IDCONTRATO 
                                    AND FTRD.NOPRESTACION    = CNTPC.IDCONCEPTO 
                                    AND FTRD.REFERENCIA      = CNTPC.CODIGOINTERNO 
                                    AND FTRD.TIPOCONTRATOARS = CNTPC.TIPOCONTRATOARS 
                                    AND FTRD.ARSTIPOCONTRATO = CNTPC.ARSTIPOCONTRATO 
                                    AND FTRD.ANO             = CNTPC.ANO 
                                    AND FTRD.MES             = CNTPC.MES 
                     LEFT JOIN CNT   ON CNTPC.IDCONTRATO     = CNT.IDCONTRATO 
                     LEFT JOIN TER   ON CNT.IDTERCERO        = TER.IDTERCERO 
                     LEFT JOIN CNTCF ON FTRD.TIPOCONTRATOARS = CNTCF.TIPOCONTRATOARS 
                                    AND FTRD.ARSTIPOCONTRATO = CNTCF.ARSTIPOCONTRATO 
                                    AND FTRD.NOPRESTACION    = CNTCF.IDCONCEPTO
         WHERE  FTR.N_FACTURA = @N_FACTURA
	    GROUP BY CNTCF.CUENTAORDEN_CR, CNT.IDTERCERO, CNT.CCOSTO, FTRD.NOADMISION, 
			    DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE)
	 END
   END
   ELSE
   BEGIN
      --------- FACTURAS IPS -----------
      --COMPROBANTE CONTABLE (MCPE)
      PRINT 'NROCOMPROBANTE = '+@MAUX
      INSERT INTO MCPE(NROCOMPROBANTE, COMPANIA, PROCEDENCIA, NOREFERENCIA, ANO, MES, FECHACONTABLE, TOTALDEBITO,
                       TOTALCREDITO, REFERENCIA1, REFERENCIA2, USUARIO, FECHA, LOTE, OBSERVACION, IDSEDE, ESTADO, 
                       COMPROBANTE, IDTERCERO)
      SELECT @MAUX, @COMPANIA, 'FACTURA', @N_FACTURA, @ANO, @MES, 
             CAST(STR(DAY(FTR.F_FACTURA))+'/'+LTRIM(STR(@MES))+'/'+@ANO AS DATETIME),
             0, 0, FTR.NOREFERENCIA, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), NULL, 
             'FACTURAMOS VENTA A '+RTRIM(TER.RAZONSOCIAL), 
             @SEDE, 0, @COM, (CASE WHEN FTR.IDTERCERO IS NULL THEN '' ELSE FTR.IDTERCERO END)
      FROM   FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
      WHERE  FTR.N_FACTURA = @N_FACTURA
      
      CREATE TABLE #T (TIPO           VARCHAR(2)     COLLATE database_default,
                     CUENTA         VARCHAR(16)    COLLATE database_default,
                     IDAREA         VARCHAR(20)    COLLATE database_default,
                     CCOSTO         VARCHAR(20)    COLLATE database_default,
                     VLR_TOTAL      DECIMAL(14,2), VLR_SERVICI    DECIMAL(14,2), VLR_COPAGOS    DECIMAL(14,2),
                     VLR_PAGCOMP    DECIMAL(14,2), VLR_DESCUENTO  DECIMAL(14,2), VLR_ABONOS	   DECIMAL(14,2),
                     VLR_IVA   	   DECIMAL(14,2), VLR_IMPUESTOS  DECIMAL(14,2),
                     IDPLAN         VARCHAR(6)     COLLATE database_default, IDAFILIADO     VARCHAR(20)    COLLATE database_default,
                     NOMBREAFILIADO VARCHAR(100)   COLLATE database_default, NOINGRESO      VARCHAR(20)    COLLATE database_default,
                     CODUNG         VARCHAR(5)     COLLATE database_default, CODPRG         VARCHAR(20)    COLLATE database_default)     
      CREATE TABLE #D (N_FACTURA      VARCHAR(16)    COLLATE database_default,
                     F_FACTURA      DATETIME,    F_VENCE        DATETIME,
                     IDTERCERO	   VARCHAR(20)    COLLATE database_default,
                     PREFIJO	      VARCHAR(6)     COLLATE database_default,
                     IDAREA         VARCHAR(20)    COLLATE database_default,
                     CCOSTO         VARCHAR(20)     COLLATE database_default,
                     VALOR          DECIMAL(14,2), 
                     CODUNG         VARCHAR(5)     COLLATE database_default,
                     CODPRG         VARCHAR(20)    COLLATE database_default)
      -- DEDUCCIONES
      IF (@PROCEDENCIA IN ('FINANCIERO','CE','CI','ACTIVOS')) --OR (@NOREFERENCIA='MASIVA')
      BEGIN
         PRINT 'Llenando Temporal para Deducciones FINANCIERO, CE, CI, ACTIVOS'
         IF @PROCEDENCIA='CE'
         BEGIN
            PRINT @PROCEDENCIA
            INSERT INTO #T (TIPO, CUENTA, IDAREA, CCOSTO, VLR_TOTAL, VLR_SERVICI, VLR_COPAGOS, VLR_PAGCOMP, 
                            VLR_DESCUENTO, VLR_ABONOS, IDPLAN, IDAFILIADO, NOMBREAFILIADO, VLR_IVA, VLR_IMPUESTOS, NOINGRESO,
                            CODUNG, CODPRG)
            SELECT 'DB', ISNULL(ISNULL(FTR.CUENTACXC,TTEC.CUENTA),TTEC2.CUENTA), 
                   '', '', 0 AS VLR_TOTAL, 
                   SUM(FTRD.VLR_SERVICI) AS VLR_SERVICI, SUM(FTRD.VLR_COPAGOS) AS VLR_COPAGOS, 
                   SUM(FTRD.VLR_PAGCOMP) AS VLR_PAGCOMP, 0 AS VLR_DESCUENTO, 0 AS VLR_ABONOS,
                   AUT.IDPLAN,AUT.IDAFILIADO,(CASE WHEN EXISTS(SELECT PAPELLIDO+' '+SAPELLIDO+' '+PNOMBRE+' '+SNOMBRE  --STORRES SE CAMBIA AUT.IDAFILIADO POR AFI.DOCIDAFILIADO
                                              FROM AFI 
                                              WHERE AFI.IDAFILIADO=AUT.IDAFILIADO) THEN 
                                                (SELECT LEFT(PAPELLIDO+' '+SAPELLIDO+' '+PNOMBRE+' '+SNOMBRE,40) 
                                                 FROM AFI 
                                                 WHERE AFI.IDAFILIADO=AUT.IDAFILIADO) ELSE '' END), SUM(COALESCE(FTRD.VIVA,0)), 0, FTRD.NOADMISION,
                   COALESCE(FTRD.CODUNG,''), COALESCE(FTRD.CODPRG,'')                
            FROM   FTR LEFT JOIN FTRD ON FTR.N_FACTURA = FTRD.N_FACTURA 
                       LEFT JOIN TTEC ON TTEC.TIPO     = FTR.TIPOTTEC 
                                     AND TTEC.TIPOMOV  = 'DB' 
                       LEFT JOIN AUT  ON AUT.NOAUT = FTRD.NOADMISION 
                       LEFT JOIN AUTD ON AUT.IDAUT = AUTD.IDAUT 
                                     AND FTRD.REFERENCIA  = AUTD.IDSERVICIO 
                       LEFT JOIN PPT  ON FTR.IDTERCERO    = PPT.IDTERCERO 
                                     AND FTR.IDPLAN       = PPT.IDPLAN 
                       LEFT JOIN TTEC TTEC2 ON TTEC2.TIPO = PPT.TIPOTERCONTABLE 
                       LEFT JOIN AFI ON AUT.IDAFILIADO = AFI.IDAFILIADO --STORRES SE REALIZA UNION DE TABLA PARA AFI 
            WHERE  FTR.N_FACTURA = @N_FACTURA
            GROUP BY TTEC.TIPOMOV, TTEC.CUENTA, AUT.IDPLAN, FTRD.NOADMISION, AUT.IDAFILIADO,
                     FTR.CUENTACXC, TTEC2.CUENTA, COALESCE(FTRD.CODUNG,''), COALESCE(FTRD.CODPRG,'') --STORRES SE AGREGA AFI.DOCIDAFILIADO
         END
         ELSE
            IF @PROCEDENCIA='CI'
            BEGIN
               PRINT @PROCEDENCIA
               INSERT INTO #T (TIPO, CUENTA, IDAREA, CCOSTO, VLR_TOTAL, VLR_SERVICI, VLR_COPAGOS, VLR_PAGCOMP, 
                          VLR_DESCUENTO, VLR_ABONOS, IDPLAN, IDAFILIADO, NOMBREAFILIADO, VLR_IVA, VLR_IMPUESTOS, NOINGRESO, 
                          CODUNG, CODPRG)
               SELECT 'DB', ISNULL(ISNULL(FTR.CUENTACXC,TTEC.CUENTA),TTEC2.CUENTA), 
                       '', '', 0 AS VLR_TOTAL, 
                       SUM(FTRD.VLR_SERVICI) AS VLR_SERVICI, SUM(FTRD.VLR_COPAGOS) AS VLR_COPAGOS, 
                       SUM(FTRD.VLR_PAGCOMP) AS VLR_PAGCOMP, 0 AS VLR_DESCUENTO, 0 AS VLR_ABONOS,
                       CIT.IDPLAN,CIT.IDAFILIADO,(CASE WHEN EXISTS(SELECT PAPELLIDO+' '+SAPELLIDO+' '+PNOMBRE+' '+SNOMBRE  --STORRES SE CAMBIA AUT.IDAFILIADO POR AFI.DOCIDAFILIADO
                                                  FROM AFI 
                                                  WHERE AFI.IDAFILIADO=CIT.IDAFILIADO) THEN 
                                                    (SELECT LEFT(PAPELLIDO+' '+SAPELLIDO+' '+PNOMBRE+' '+SNOMBRE,40) 
                                                     FROM AFI 
                                                     WHERE AFI.IDAFILIADO=CIT.IDAFILIADO) ELSE '' END), SUM(COALESCE(FTRD.VIVA,0)), 0, FTRD.NOADMISION,
                     COALESCE(FTRD.CODUNG,''), COALESCE(FTRD.CODPRG,'') 
               FROM	  FTR INNER JOIN FTRD ON FTR.N_FACTURA   = FTRD.N_FACTURA 
                           LEFT JOIN TTEC ON TTEC.TIPO       = FTR.TIPOTTEC 
                                         AND TTEC.TIPOMOV='DB' 
                           LEFT JOIN CIT  ON CIT.CONSECUTIVO  = FTRD.NOADMISION 
                           LEFT JOIN PPT  ON FTR.IDTERCERO    = PPT.IDTERCERO 
                                         AND FTR.IDPLAN       = PPT.IDPLAN 
                           LEFT JOIN TTEC TTEC2 ON TTEC2.TIPO = PPT.TIPOTERCONTABLE 
                           LEFT JOIN AFI ON CIT.IDAFILIADO = AFI.IDAFILIADO --STORRES SE REALIZA UNION DE TABLA PARA AFI 
               WHERE  FTR.N_FACTURA = @N_FACTURA
               AND    COALESCE(FTRD.PAQUETE,0)=CASE WHEN COALESCE(FTR.PAQUETE,0)=0  AND FTR.PROCEDENCIA='CI' AND COALESCE(FTR.CNSFMAS,'')<>'' THEN 0 ELSE COALESCE(FTRD.PAQUETE,0)  END
               GROUP BY TTEC.TIPOMOV, TTEC.CUENTA, CIT.IDPLAN, CIT.IDAFILIADO, FTRD.NOADMISION,
                        FTR.CUENTACXC, TTEC2.CUENTA, COALESCE ( FTRD.CODUNG,''), COALESCE( FTRD.CODPRG,'') --STORRES SE AGREGA AFI.DOCIDAFILIADO
            END
            ELSE
            BEGIN
               PRINT @PROCEDENCIA
               IF @CAPITADA = 0
               BEGIN
                  -- Factura Financiera Evento
                  INSERT INTO #T (TIPO, CUENTA, IDAREA, CCOSTO, VLR_TOTAL, VLR_SERVICI, VLR_COPAGOS, VLR_PAGCOMP, 
                            VLR_DESCUENTO, VLR_ABONOS, IDPLAN, VLR_IVA, VLR_IMPUESTOS, NOINGRESO, CODUNG, CODPRG)
                  SELECT 'DB' TIPO, ISNULL(TTEC1.CUENTA,TTEC2.CUENTA), '', '', 0 AS VLR_TOTAL, 
                   SUM(FTRD.VLR_SERVICI) AS VLR_SERVICI, SUM(FTRD.VLR_COPAGOS) AS VLR_COPAGOS, 
                   SUM(FTRD.VLR_PAGCOMP) AS VLR_PAGCOMP, 0 AS VLR_DESCUENTO, 0 AS VLR_ABONOS, FTR.IDPLAN, SUM(COALESCE(FTRD.VIVA,0)), 0, FTRD.NOADMISION,
                   COALESCE ( FTRD.CODUNG,''), COALESCE( FTRD.CODPRG,'')
                  FROM   FTR INNER JOIN FTRD ON FTR.CNSFCT    = FTRD.CNSFTR 
                             LEFT JOIN  TTEC TTEC1 ON TTEC1.TIPO    = FTR.TIPOTTEC 
                             LEFT JOIN  PPT        ON FTR.IDTERCERO = PPT.IDTERCERO AND FTR.IDPLAN = PPT.IDPLAN 
                             LEFT JOIN  TTEC TTEC2 ON TTEC2.TIPO    = PPT.TIPOTERCONTABLE
                  WHERE  FTR.N_FACTURA = @N_FACTURA
                  GROUP BY ISNULL(TTEC1.CUENTA,TTEC2.CUENTA), FTR.IDPLAN,  FTRD.NOADMISION, 
                     COALESCE ( FTRD.CODUNG,''), COALESCE( FTRD.CODPRG,'')
               END
               ELSE
               BEGIN
			         PRINT 'ENTRE AQUI INSERTE CUENTA CARTERA PARA CAPITADA'
                  INSERT INTO #T (TIPO, CUENTA, IDAREA, CCOSTO, VLR_TOTAL, VLR_SERVICI, VLR_COPAGOS, VLR_PAGCOMP, 
                             VLR_DESCUENTO, VLR_ABONOS, IDPLAN, VLR_IVA, VLR_IMPUESTOS, NOINGRESO, CODUNG, CODPRG)
                  SELECT 'DB' TIPO, TTEC1.CUENTA, '', '', 0 AS VLR_TOTAL, 
                    SUM(FTRD.VLR_SERVICI) AS VLR_SERVICI, ROUND(CASE WHEN COALESCE(FTR.COPAPROPIO,0)=1 THEN CP_VLR_COPAGOS ELSE SUM(FTRD.VLR_COPAGOS) END,0) VLR_COPAGOS, 
                    FTR.CP_VLR_PAGCOMP, 0 AS VLR_DESCUENTO, 0 AS VLR_ABONOS, FTRD.IDPLAN, SUM(COALESCE(FTRD.VIVA,0)), 0, '',
                    COALESCE ( FTRD.CODUNG,''), COALESCE( FTRD.CODPRG,'')
                  FROM   FTR INNER JOIN FTRD ON FTR.CNSFCT=FTRD.CNSFTR 
                              LEFT JOIN PPT ON FTR.IDTERCERO = PPT.IDTERCERO AND FTRD.IDPLAN = PPT.IDPLAN 
                              LEFT JOIN TTEC TTEC1 ON TTEC1.TIPO = PPT.TIPOTERCONTABLE
                  WHERE  FTR.N_FACTURA = @N_FACTURA
                  GROUP BY TTEC1.CUENTA, FTRD.IDPLAN, COALESCE ( FTRD.CODUNG,''), COALESCE( FTRD.CODPRG,''),COALESCE(FTR.COPAPROPIO,0),FTR.CP_VLR_COPAGOS,
                            FTR.CP_VLR_PAGCOMP 
               END
            END
      END
      ELSE
      BEGIN
         PRINT 'Llenando Temporal para Deducciones no SON FINANCIERO,CE,CI,ACTIVOS'
         IF @PROCEDENCIA = 'SALUD' AND @TIPOFAC = 'M'
         BEGIN
            PRINT 'MASIVA - SALUD'
            INSERT INTO #T (TIPO, CUENTA, IDAREA, CCOSTO, VLR_TOTAL, VLR_SERVICI, VLR_COPAGOS, VLR_PAGCOMP, 
                            VLR_DESCUENTO, VLR_ABONOS, IDPLAN, IDAFILIADO, NOMBREAFILIADO, VLR_IVA, VLR_IMPUESTOS, NOINGRESO,
                            CODUNG, CODPRG)
            SELECT 'DB', ISNULL(CUE.CUENTA,TTEC.CUENTA), '', '', 0 AS VLR_TOTAL, 
                   SUM(FTRD.VLR_SERVICI) AS VLR_SERVICI, SUM(FTRD.VLR_COPAGOS) AS VLR_COPAGOS, 
                   SUM(FTRD.VLR_PAGCOMP) AS VLR_PAGCOMP, 0 AS VLR_DESCUENTO, 0 AS VLR_ABONOS,
                   HADM.IDPLAN, 'MASIVA', 'MASIVA', 
                   SUM(COALESCE(FTRD.VIVA,0)), 0, 'MASIVA', COALESCE ( FTRD.CODUNG,''), COALESCE( FTRD.CODPRG,'')
            FROM   FTR INNER JOIN FTRD ON FTR.N_FACTURA   = FTRD.N_FACTURA 
                        LEFT JOIN  HADM       ON HADM.NOADMISION = FTRD.NOADMISION 
                        LEFT JOIN  AFI        ON HADM.IDAFILIADO = AFI.IDAFILIADO 
                        LEFT JOIN  CUE        ON CUE.CUENTA      = FTR.CUENTACXC AND CUE.COMPANIA = @COMPANIA 
                        LEFT JOIN  PPT        ON FTR.IDTERCERO   = PPT.IDTERCERO AND FTR.IDPLAN   = PPT.IDPLAN 
                        LEFT JOIN  TTEC       ON TTEC.TIPO       = PPT.TIPOTERCONTABLE
            WHERE  FTR.N_FACTURA = @N_FACTURA
            GROUP BY ISNULL(CUE.CUENTA,TTEC.CUENTA), HADM.IDPLAN, COALESCE ( FTRD.CODUNG,''), COALESCE( FTRD.CODPRG,'')
         END
         ELSE
         BEGIN
            SELECT @ADICIONALPTE=0
            IF (SELECT COALESCE(FTR.PAQUETE,0) FROM FTR WHERE N_FACTURA =@N_FACTURA)=1
            BEGIN
               SELECT @ADICIONALPTE= CASE WHEN EXISTS(SELECT * FROM FTRD  WHERE N_FACTURA=@N_FACTURA AND COALESCE(PAQUETE,0)=3 ) THEN 0 ELSE 1 END
            END
            INSERT INTO #T (TIPO, CUENTA, IDAREA, CCOSTO, VLR_TOTAL, VLR_SERVICI, VLR_COPAGOS, VLR_PAGCOMP, 
                          VLR_DESCUENTO, VLR_ABONOS, IDPLAN, IDAFILIADO, NOMBREAFILIADO, VLR_IVA, VLR_IMPUESTOS, NOINGRESO,
                          CODUNG, CODPRG)
            SELECT 'DB', ISNULL(CUE.CUENTA,TTEC.CUENTA), '', '', 0 AS VLR_TOTAL, 
                   SUM(FTRD.VLR_SERVICI) AS VLR_SERVICI, SUM(FTRD.VLR_COPAGOS) AS VLR_COPAGOS, 
                   SUM(FTRD.VLR_PAGCOMP) AS VLR_PAGCOMP, 0 AS VLR_DESCUENTO, 0 AS VLR_ABONOS,
                   HADM.IDPLAN, HADM.IDAFILIADO, LEFT(AFI.PAPELLIDO+' '+AFI.SAPELLIDO+' '+AFI.PNOMBRE+' '+AFI.SNOMBRE,100), --STORRES SE CAMBIA AFI.IDAFILIADO POR AFI.DOCIDAFILIADO
                   SUM(COALESCE(FTRD.VIVA,0)), 0, FTRD.NOADMISION, COALESCE ( FTRD.CODUNG,''), COALESCE( FTRD.CODPRG,'')
            FROM   FTR INNER JOIN FTRD ON FTR.N_FACTURA   = FTRD.N_FACTURA 
                        LEFT JOIN  HADM       ON HADM.NOADMISION = FTRD.NOADMISION 
                        LEFT JOIN  AFI        ON HADM.IDAFILIADO = AFI.IDAFILIADO 
                        LEFT JOIN  CUE        ON CUE.CUENTA      = FTR.CUENTACXC AND CUE.COMPANIA = @COMPANIA 
                        LEFT JOIN  PPT        ON FTR.IDTERCERO   = PPT.IDTERCERO AND FTR.IDPLAN   = PPT.IDPLAN 
                        LEFT JOIN  TTEC       ON TTEC.TIPO       = PPT.TIPOTERCONTABLE
            WHERE (COALESCE(FTRD.PAQUETE,0) = CASE WHEN COALESCE(FTR.PAQUETE,0)=1 THEN 1 ELSE 0 END OR  COALESCE(FTRD.PAQUETE,0) = CASE WHEN COALESCE(FTR.PAQUETE,0)=1 THEN 3 ELSE 0 END) 
            AND    FTR.N_FACTURA = @N_FACTURA
            GROUP BY ISNULL(CUE.CUENTA,TTEC.CUENTA), HADM.IDPLAN, HADM.IDAFILIADO, AFI.PAPELLIDO, AFI.SAPELLIDO, AFI.PNOMBRE, AFI.SNOMBRE, 
                     FTRD.NOADMISION, COALESCE ( FTRD.CODUNG,''), COALESCE( FTRD.CODPRG,'')

            --WHERE  COALESCE(FTRD.PAQUETE,0) = CASE WHEN  COALESCE(FTR.PAQUETE,0)=0 AND @ADICIONALPTE=0 THEN COALESCE(FTRD.PAQUETE,0) 
            --                                       WHEN  COALESCE(FTR.PAQUETE,0)=1 AND @ADICIONALPTE=0  THEN 1 
            --                                       WHEN COALESCE(FTR.PAQUETE,0)=1 AND @ADICIONALPTE=1 THEN  3 
            --                                  ELSE 3 END   -- JEDM:09.AGO.2011 PAQUETE
         END 
      END
          
      IF @VR_ABONOS>0
      BEGIN 
         PRINT 'Llenando Temporal de Deducciones con Abonos'
         UPDATE #T SET VLR_ABONOS=(VLR_SERVICI*100/@VALORSERVICIOS)*@VR_ABONOS/100
          
         SELECT TOP 1 @TIPO_T=TIPO, @CUENTA_T=CUENTA, @IDAREA_T=IDAREA, @CCOSTO_T=CCOSTO
         FROM #T ORDER BY VLR_ABONOS DESC
          
         UPDATE #T SET VLR_ABONOS=VLR_ABONOS+(@VR_ABONOS-(SELECT SUM(VLR_ABONOS) FROM #T))
         WHERE TIPO=@TIPO_T AND CUENTA=@CUENTA_T AND IDAREA=@IDAREA_T AND CCOSTO=@CCOSTO_T
      END
      IF @DESCUENTO > 0
      BEGIN 
         PRINT 'Llenando Temporal de Deducciones con Descuentos '
         UPDATE #T SET VLR_DESCUENTO = (VLR_SERVICI*100/@VALORSERVICIOS)*@DESCUENTO/100
         
         SELECT TOP 1 @TIPO_T=TIPO, @CUENTA_T=CUENTA, @IDAREA_T=IDAREA, @CCOSTO_T=CCOSTO
         FROM #T ORDER BY VLR_DESCUENTO DESC
          
         UPDATE #T SET VLR_DESCUENTO = VLR_DESCUENTO+(@DESCUENTO-(SELECT SUM(VLR_DESCUENTO) FROM #T))
         WHERE TIPO=@TIPO_T AND CUENTA=@CUENTA_T AND IDAREA=@IDAREA_T AND CCOSTO=@CCOSTO_T
         
         PRINT 'Llenando Temporal para Descuentos'
         INSERT INTO #D (N_FACTURA,F_FACTURA,F_VENCE,IDTERCERO,PREFIJO,IDAREA,CCOSTO,VALOR, CODUNG, CODPRG)
         SELECT FTR.N_FACTURA,FTR.F_FACTURA,FTR.F_VENCE,FTR.IDTERCERO,FTRD.PREFIJO, FTRD.AREAPRESTACION,
                FTRD.CCOSTO, SUM(((FTRD.VLR_SERVICI-(ISNULL(FTRD.VIVA,0)))*100/@VALORSERVICIOS)*@DESCUENTO/100),
                FTRD.CODUNG, FTRD.CODPRG
         FROM   FTR INNER JOIN FTRD ON FTR.CNSFCT = FTRD.CNSFTR
         WHERE  FTR.N_FACTURA = @N_FACTURA
         GROUP BY FTR.N_FACTURA,FTR.F_FACTURA,FTR.F_VENCE,FTR.IDTERCERO,FTRD.PREFIJO,
                  FTRD.CODUNG, FTRD.CODPRG, FTRD.AREAPRESTACION,
                  FTRD.CCOSTO
         
         SELECT TOP 1 @IDTERCERO_T=IDTERCERO, @PREFIJO_T=PREFIJO, @IDAREA_T=IDAREA, @CCOSTO_T=CCOSTO
         FROM #D ORDER BY VALOR DESC
         
         UPDATE #D SET VALOR=VALOR+(@DESCUENTO-(SELECT SUM(VALOR) FROM #D))
         WHERE IDTERCERO=@IDTERCERO_T AND PREFIJO=@PREFIJO_T AND IDAREA=@IDAREA_T AND CCOSTO=@CCOSTO_T
      END
     
      IF @VLR_IMPUESTOS > 0
      BEGIN
         PRINT 'Actualizando Impuestos en #T '
         UPDATE #T SET VLR_IMPUESTOS=(VLR_SERVICI*100/@VALORSERVICIOS)*@VLR_IMPUESTOS/100
          
         SELECT TOP 1 @TIPO_T=TIPO, @CUENTA_T=CUENTA, @IDAREA_T=IDAREA, @CCOSTO_T=CCOSTO
         FROM #T ORDER BY VLR_IMPUESTOS DESC
         
         UPDATE #T SET VLR_IMPUESTOS=VLR_IMPUESTOS+(@VLR_IMPUESTOS-(SELECT SUM(VLR_IMPUESTOS) FROM #T))
         WHERE TIPO=@TIPO_T AND CUENTA=@CUENTA_T AND IDAREA=@IDAREA_T AND CCOSTO=@CCOSTO_T
		 
      END
      PRINT 'Actualiza Valor VLR_TOTAL en Tabla #T'
      SELECT @VR_TOTAL=SUM(VLR_TOTAL) FROM #T

      PRINT '@VR_TOTAL ANTES DE ANTIPO_IMP_RESTA_FTR ='+STR(@VR_TOTAL)
      PRINT '@VLR_IMPUESTOS='+STR(@VLR_IMPUESTOS)
      IF UPPER(DBO.FNK_VALORVARIABLE('ANTIPO_IMP_RESTA_FTR')) = 'NO' 
      BEGIN
	  	 SELECT  @VLRPYG=COALESCE(VR_TOTAL- CP_VLR_SERVICIOS,0) ,@VRTOTALSERCAP=COALESCE(CP_VLR_SERVICIOS,0)  FROM FTR WHERE N_FACTURA=@N_FACTURA

		 IF (@CAPITADA)=0
		 BEGIN
				 PRINT 'VARIABLE EN NO L ENTONCES NO RESTO  EL VALOR '
				 UPDATE #T SET VLR_TOTAL= COALESCE(VLR_SERVICI,0)-COALESCE(VLR_COPAGOS,0)-COALESCE(VLR_PAGCOMP,0)-COALESCE(VLR_DESCUENTO,0)
		 END 
		 ELSE IF @VLRPYG<0 AND @CAPITADA=1
		 BEGIN
				 PRINT 'VARIABLE EN NO L ENTONCES NO RESTO  EL VALOR '
				 UPDATE #T SET VLR_TOTAL= CASE WHEN @VRTOTALSERCAP=0 THEN  COALESCE(VLR_SERVICI,0) ELSE COALESCE(@VRTOTALSERCAP,0) END-
				 COALESCE(VLR_COPAGOS,0)-COALESCE(VLR_PAGCOMP,0)-COALESCE(VLR_DESCUENTO,0)- CASE WHEN @VLRPYG<0 THEN ABS(@VLRPYG) ELSE 0 END 
		 END 
		 ELSE 
		 BEGIN 
		 UPDATE #T SET VLR_TOTAL= COALESCE(VLR_SERVICI,0)-COALESCE(VLR_COPAGOS,0)-COALESCE(VLR_PAGCOMP,0)-COALESCE(VLR_DESCUENTO,0)
		 END
      END
      ELSE
      BEGIN
         PRINT 'DIFERENTE A NO LE QUITO EL VALOR A LA 13 PARA DEJARO EN EL DE IMPUESTO'
         UPDATE #T SET VLR_TOTAL= COALESCE(VLR_SERVICI,0)-COALESCE(VLR_COPAGOS,0)-COALESCE(VLR_PAGCOMP,0)-COALESCE(VLR_DESCUENTO,0)-COALESCE(VLR_IMPUESTOS,0)
      END

      SELECT @VR_TOTAL=SUM(VLR_TOTAL) FROM #T

      PRINT '@VR_TOTAL  DESPUES DE LA RESTA='+STR(@VR_TOTAL)
      
      PRINT 'Valida el Abono de la Factura sobre VLR_TOTAL'
      IF (SELECT SUM(VLR_TOTAL-VLR_ABONOS) FROM #T)<0
      BEGIN
       --UPDATE #T SET VLR_TOTAL=0,VLR_ABONOS=@VR_TOTAL
         UPDATE #T SET VLR_ABONOS=VLR_TOTAL
         UPDATE #T SET VLR_TOTAL=0
      END
      ELSE 
      BEGIN
         UPDATE #T SET VLR_TOTAL=VLR_TOTAL+CASE WHEN  DBO.FNK_VALORVARIABLE('BASE_IVA_SERVICIOS')='SINIVA' THEN  VLR_IVA  ELSE 0 END  -VLR_ABONOS
      END     
      PRINT 'Crea el Afiliado como Tercero con la categoria de Afiliado'
      SELECT TOP 1 @IDAFILIADO = IDAFILIADO FROM FTR WHERE N_FACTURA=@N_FACTURA
      SET @IDCATEGORIA = DBO.FNK_VALORVARIABLE('TERCATAFILIADO')      
	   -- MOD.JQUIROGA 20090620 CREA IDAFILIADO COMO TERCERO
	   IF @PROCEDENCIA <> 'FINANCIERO'  AND   @PROCEDENCIA<>'INVENTARIO'
	   BEGIN
         PRINT 'Inserta Tercero con SPK_INSERT_TERDEAFI '+@IDAFILIADO+','+@IDCATEGORIA
         EXEC SPK_INSERT_TERDEAFI @IDAFILIADO, @IDCATEGORIA

	   END 
      SELECT @IDTERCEROAFI=RUC FROM AFI WHERE IDAFILIADO=@IDAFILIADO
      --COMPROBANTE CONTABLE (MCHE)   
      DECLARE @DDD DECIMAL(14,2)
      SELECT @DDD = COUNT(*) FROM #T
      PRINT 'REGISTROS EN #T=' + STR(@DDD) 
                 
      PRINT  'Contabilizando CXC ...'
      
      INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                       REFERENCIA2, REFERENCIA3, ITEMREF, USUARIO, FECHA, IDAREA, CLASECONT, ESTADO, PROCESO,
                       GENERA,N_FACTURA,F_FACTURAREF,F_VENCE, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
      SELECT @MAUX, @COMPANIA,CASE WHEN SUM(#T.VLR_TOTAL) < 0 THEN 'CR' ELSE  #T.TIPO END ,
             CASE WHEN SUM(#T.VLR_TOTAL) < 0 THEN DBO.FNK_VALORVARIABLE('PYG_COPAGOMAYORSER') ELSE   #T.CUENTA END, FTR.IDTERCERO, 
             #T.CCOSTO, 
             RTRIM(TER.RAZONSOCIAL)+
             ', FA '+FTR.N_FACTURA+' PLAN: '+(SELECT DESCPLAN FROM PLN WHERE PLN.IDPLAN=#T.IDPLAN)+
             ', AFILIADO: '+ISNULL(#T.NOMBREAFILIADO,''), 
             CASE COALESCE(FTR.PAQUETE,0) WHEN 0 THEN CASE WHEN  SUM(#T.VLR_TOTAL) <0 THEN ABS(SUM(#T.VLR_TOTAL)) ELSE SUM(#T.VLR_TOTAL) END ELSE FTR.VR_TOTAL END,   --JEDM:09.AGO.2011 PAQUETE
             FTR.N_FACTURA, FTR.NOREFERENCIA, #T.IDAFILIADO, NULL, @USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()),
             #T.IDAREA, 'S', 1, 'CXC', 'Movimiento', FTR.N_FACTURA, 
             DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),'FACTURA',@N_FACTURA,
             #T.CODUNG, #T.CODPRG
      FROM   FTR, #T, TER  
      WHERE  FTR.IDTERCERO = TER.IDTERCERO 
      AND    FTR.N_FACTURA = @N_FACTURA
      AND    #T.VLR_TOTAL<>0
      GROUP  BY #T.TIPO,#T.CUENTA,FTR.IDTERCERO,#T.CCOSTO,
               FTR.N_FACTURA,#T.IDAREA,TER.RAZONSOCIAL, FTR.PAQUETE, FTR.VR_TOTAL,
               FTR.NOREFERENCIA, #T.IDAFILIADO,#T.IDPLAN,#T.NOMBREAFILIADO,
               DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), #T.CODUNG, #T.CODPRG

         SELECT @VR_TOTAL=SUM(VALOR) FROM MCHE WHERE NROCOMPROBANTE=@MAUX AND TIPO='DB'

         PRINT '@VR_TOTAL MCHE ANTES DE EMPEZAR LOS COPATOS Y OTROS ='+STR(@VR_TOTAL)

      PRINT 'Contabilizando Abonos...' 
      
      IF @VR_ABONOS>0
      BEGIN 
         PRINT @VR_ABONOS	
         SET @TIPO_DED = 'FTR_ABONOS'
         INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, IDAREA, 
                         DETALLE, VALOR ,REFERENCIA1,REFERENCIA2, ITEMREF, USUARIO, FECHA, 
                         ESTADO, PROCESO, CLASECONT, GENERA, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO,
                         CODUNG, CODPRG)
         SELECT @MAUX, @COMPANIA, #T.TIPO, KCDE.CUENTA, X.IDTERCERO, 
                #T.CCOSTO, #T.IDAREA, 
                'ABONO A FACTURA No.'+FTR.N_FACTURA, SUM((X.VALOR*#T.VLR_ABONOS)/@VR_ABONOS), 
                FTR.N_FACTURA, NULL, NULL,
                @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), 1, 'ABONOS','S', 'Movimiento',
                RTRIM(X.CODCAJA)+X.CNSFACJ, DBO.FNK_FECHA_SIN_HORA(X.FECHA), 
                DBO.FNK_FECHA_SIN_HORA(X.FECHA),'FACTURA',@N_FACTURA, #T.CODUNG, #T.CODPRG
         FROM   VWK_RCJ_LEG X INNER JOIN FTR ON X.NOINGRESO=FTR.NOREFERENCIA 
                                            AND X.DEVUELTO=0 
                              INNER JOIN KCDE ON KCDE.TIPO=@TIPO_DED 
                                             AND KCDE.IDMODELOCONT=@IDMODELOCONT 
                              INNER JOIN #T ON #T.VLR_ABONOS>0
         WHERE  FTR.N_FACTURA = @N_FACTURA
         GROUP BY KCDE.CUENTA, X.IDTERCERO, 
                  #T.CCOSTO, #T.IDAREA, FTR.N_FACTURA,X.CNSFACJ, 
                  DBO.FNK_FECHA_SIN_HORA(X.FECHA), #T.TIPO, X.CODCAJA, #T.CODUNG, #T.CODPRG
         
         SELECT @ABONOS_MCH = SUM(VALOR) FROM MCHE WHERE NROCOMPROBANTE=@MAUX AND PROCESO='ABONOS' AND TIPO='DB'
         IF @ABONOS_MCH<>@VR_ABONOS
         BEGIN
            SELECT TOP 1 @NROASIENTO=NROASIENTO 
            FROM MCHE WHERE NROCOMPROBANTE=@MAUX AND PROCESO='ABONOS' AND TIPO='DB' ORDER BY VALOR DESC
             
            UPDATE MCHE SET VALOR = VALOR + (@VR_ABONOS - @ABONOS_MCH) WHERE NROASIENTO = @NROASIENTO          
         END
      END
      PRINT 'Contabilizando Pagos Compartidos...' 
      IF @VALORPCOMP>0
      BEGIN 
         SET @TIPO_DED='FTR_PAGCOMP'--DBO.FNK_VALORVARIABLE('IDTIPODED_DEDUCIBLES')
         PRINT @TIPO_DED
         PRINT @VALORPCOMP
         
         IF @CAPITADA = 0
         BEGIN
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, IDAREA, DETALLE,
                             VALOR ,REFERENCIA1,REFERENCIA2, ITEMREF, USUARIO, FECHA, ESTADO, PROCESO, 
                             CLASECONT, GENERA, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, 
                             CODUNG, CODPRG)
            SELECT @MAUX, @COMPANIA, #T.TIPO, KCDE.CUENTA, 
                   CASE WHEN #T.IDAFILIADO IS NULL OR #T.IDAFILIADO='' THEN FTR.IDTERCERO ELSE #T.IDAFILIADO END, 
                   #T.CCOSTO, #T.IDAREA, 'DEPOSITO POR PAGO COMPARTIDO.',#T.VLR_PAGCOMP, FTR.N_FACTURA, NULL, NULL, 
                   @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), 1, 'PAGCOMP','S', 'Movimiento',
                   #T.NOINGRESO, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),'FACTURA',@N_FACTURA, 
                   #T.CODUNG, #T.CODPRG
            FROM   FTR, KCDE, #T 
            WHERE  KCDE.TIPO         = @TIPO_DED 
            AND    KCDE.IDMODELOCONT = @IDMODELOCONT 
            AND    #T.VLR_PAGCOMP > 0
            AND    FTR.N_FACTURA = @N_FACTURA
         END
         ELSE
         BEGIN
		      PRINT 'ENTRE A CREAR PAGO COMPARTIDO'
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, IDAREA, DETALLE,
                             VALOR ,REFERENCIA1,REFERENCIA2, ITEMREF, USUARIO, FECHA, ESTADO, PROCESO, 
                             CLASECONT, GENERA, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, 
                             CODUNG, CODPRG)
            SELECT @MAUX, @COMPANIA, 'DB', KCDE.CUENTA, CASE WHEN ISNULL(FTR.IDAFILIADO,'')='' THEN FTR.IDTERCERO ELSE FTR.IDAFILIADO END, 
                   FTRDC.CCOSTO, FTRDC.IDAREA, 'DEPOSITO POR PAGO COMPARTIDO.', SUM(FTRDC.VLR_PAGCOMP), FTR.N_FACTURA, NULL, NULL, 
                   @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), 1, 'PAGCOMP','S', 'Movimiento',
                   FTRDC.NOADMISION, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 'FACTURA', @N_FACTURA, 
                   FTR.CODUNG, FTR.CODPRG
            FROM   FTR, KCDE, FTRDC 
            WHERE  FTR.CNSFCT  = FTRDC.CNSFTR 
            AND    KCDE.TIPO   = @TIPO_DED 
            AND    KCDE.IDMODELOCONT = @IDMODELOCONT
            AND    FTR.N_FACTURA = @N_FACTURA
            GROUP BY KCDE.CUENTA, FTR.IDAFILIADO, FTR.IDTERCERO, 
                  FTRDC.CCOSTO, FTRDC.IDAREA, FTR.N_FACTURA, FTRDC.NOADMISION, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),
                  FTR.CODUNG, FTR.CODPRG
            HAVING SUM(FTRDC.VLR_PAGCOMP)>0
         END
      END
      
      PRINT 'Contabilizando Bonos, Copagos o Cuotas Moderadoras...'
      PRINT '@VALORCOPAGO='+STR(COALESCE(@VALORCOPAGO,0))
      IF ABS(@VALORCOPAGO)>0 AND DBO.FNK_VALORVARIABLE('IXCOUNTRY')<>'PERU'
      BEGIN 
         SET @TIPO_DED='FTR_COPAGOS'
         PRINT 'COPAGOS...'
         IF @CAPITADA = 0
         BEGIN
			IF @TIPOFAC='M' AND @PROCEDENCIA='SALUD'
			BEGIN
				INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, IDAREA, DETALLE, 
								VALOR ,REFERENCIA1,REFERENCIA2, ITEMREF, USUARIO, FECHA, ESTADO, PROCESO, 
								CLASECONT, GENERA, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, 
								CODUNG, CODPRG)
				SELECT @MAUX, @COMPANIA, 'DB', KCDE.CUENTA,COALESCE(AFI.RUC,HADM.IDAFILIADO), 
						FTRD.CCOSTO, FTRD.AREAPRESTACION, 'COPAGOS PACIENTE '+(AFI.IDAFILIADO+' '+AFI.PNOMBRE+' '+COALESCE(AFI.SNOMBRE,'')+' '+AFI.PAPELLIDO+' '+COALESCE(AFI.SAPELLIDO,'')),
						SUM(FTRD.VLR_COPAGOS), FTR.N_FACTURA, NULL, NULL,  
						@USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), 1, 'BON_COP_MOD','S', 'Movimiento',
						HADM.NOADMISION, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),'FACTURA',@N_FACTURA, 
						FTR.CODUNG, FTR.CODPRG
				FROM   FTR, FTRD,KCDE,HADM,AFI
				WHERE  KCDE.TIPO=@TIPO_DED 
				AND    KCDE.IDMODELOCONT=@IDMODELOCONT 
				AND    FTRD.N_FACTURA=FTR.N_FACTURA
				AND    FTRD.NOADMISION=HADM.NOADMISION
				AND    AFI.IDAFILIADO=HADM.IDAFILIADO
				AND    FTR.N_FACTURA = @N_FACTURA
				AND    COALESCE(FTRD.VLR_COPAGOS,0)>0
				GROUP BY KCDE.CUENTA, HADM.IDAFILIADO, FTRD.CCOSTO, FTRD.AREAPRESTACION, 
						(AFI.IDAFILIADO+' '+AFI.PNOMBRE+' '+COALESCE(AFI.SNOMBRE,'')+' '+AFI.PAPELLIDO+' '+COALESCE(AFI.SAPELLIDO,''))
						,FTR.N_fACTURA,HADM.NOADMISION,COALESCE(AFI.RUC,HADM.IDAFILIADO),
						DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA),DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),FTR.CODUNG, FTR.CODPRG
			END
			ELSE
			BEGIN
            PRINT 'POR ACA VOY A BUSCAR EL COAPGO'
				INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, IDAREA, DETALLE, 
								VALOR ,REFERENCIA1,REFERENCIA2, ITEMREF, USUARIO, FECHA, ESTADO, PROCESO, 
								CLASECONT, GENERA, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, 
								CODUNG, CODPRG)
				SELECT @MAUX, @COMPANIA, #T.TIPO, KCDE.CUENTA,@IDTERCEROAFI, 
						#T.CCOSTO, #T.IDAREA, 'COPAGOS', #T.VLR_COPAGOS, FTR.N_FACTURA, NULL, NULL, 
						@USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), 1, 'BON_COP_MOD','S', 'Movimiento',
						#T.NOINGRESO, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),'FACTURA',@N_FACTURA, 
						#T.CODUNG, #T.CODPRG
				FROM   FTR, KCDE, #T
				WHERE  KCDE.TIPO=@TIPO_DED 
				AND    KCDE.IDMODELOCONT=@IDMODELOCONT 
				AND    #T.VLR_COPAGOS>0
				AND    FTR.N_FACTURA = @N_FACTURA
			END
         END
         ELSE
         BEGIN
			   PRINT 'VOY POR EL COPAGO DE CAPITA----'
            PRINT 'CREANDO LOS TERCEROS TIPO AFILIADO'
            DECLARE @AFI_RUC VARCHAR(20)
            DECLARE AFIRUC_CURSOR CURSOR FOR 
            SELECT 
                   CASE FTRDC.PROCEDENCIA
                   WHEN 'HADM' THEN (SELECT COALESCE(AFI.IDAFILIADO,HADM.IDAFILIADO) FROM HADM INNER JOIN AFI ON HADM.IDAFILIADO=AFI.IDAFILIADO WHERE NOADMISION=FTRDC.NOADMISION)
                   WHEN 'AUT'  THEN (SELECT COALESCE(AFI.IDAFILIADO,AUT.IDAFILIADO)  FROM AUT INNER JOIN AFI ON AUT.IDAFILIADO=AFI.IDAFILIADO WHERE IDAUT=FTRDC.NOADMISION)
                   WHEN 'CIT'  THEN (SELECT COALESCE(AFI.IDAFILIADO,CIT.IDAFILIADO)  FROM CIT INNER JOIN AFI ON CIT.IDAFILIADO=AFI.IDAFILIADO WHERE CONSECUTIVO=FTRDC.NOADMISION)
                   END IDAFILIADO
            FROM   FTR, KCDE, FTRDC 
            WHERE  FTR.CNSFCT = FTRDC.CNSFTR 
            AND    KCDE.TIPO  = @TIPO_DED 
            AND    KCDE.IDMODELOCONT = @IDMODELOCONT
            AND    FTR.N_FACTURA     = @N_FACTURA

            OPEN AFIRUC_CURSOR    
            FETCH NEXT FROM AFIRUC_CURSOR    
            INTO @AFI_RUC
            WHILE @@FETCH_STATUS = 0    
            BEGIN 
               PRINT 'Inserta Tercero con SPK_INSERT_TERDEAFI '+@IDAFILIADO+','+@IDCATEGORIA
               EXEC SPK_INSERT_TERDEAFI @IDAFILIADO, 'AFI'
               FETCH NEXT FROM AFIRUC_CURSOR    
               INTO @AFI_RUC
            END
            CLOSE AFIRUC_CURSOR
            DEALLOCATE AFIRUC_CURSOR



            --IF NOT EXISTS(SELECT * FROM )
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, IDAREA, DETALLE,
                            VALOR ,REFERENCIA1,REFERENCIA2, ITEMREF, USUARIO, FECHA, ESTADO, PROCESO, 
                            CLASECONT, GENERA, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, 
                            CODUNG, CODPRG)
            SELECT @MAUX, @COMPANIA, 'DB', KCDE.CUENTA, 
                   CASE FTRDC.PROCEDENCIA
                   WHEN 'HADM' THEN (SELECT COALESCE(AFI.RUC,AFI.IDAFILIADO,HADM.IDAFILIADO) FROM HADM INNER JOIN AFI ON HADM.IDAFILIADO=AFI.IDAFILIADO WHERE NOADMISION=FTRDC.NOADMISION)
                   WHEN 'AUT'  THEN (SELECT COALESCE(AFI.RUC,AFI.IDAFILIADO,AUT.IDAFILIADO)  FROM AUT INNER JOIN AFI ON AUT.IDAFILIADO=AFI.IDAFILIADO WHERE IDAUT=FTRDC.NOADMISION)
                   WHEN 'CIT'  THEN (SELECT COALESCE(AFI.RUC,AFI.IDAFILIADO,CIT.IDAFILIADO)  FROM CIT INNER JOIN AFI ON CIT.IDAFILIADO=AFI.IDAFILIADO WHERE CONSECUTIVO=FTRDC.NOADMISION)
                   END,
                   FTRDC.CCOSTO, FTRDC.IDAREA, 'COPAGOS.', ROUND(SUM(FTRDC.VLR_COPAGO),0), FTR.N_FACTURA, NULL, NULL, 
                   @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), 1, 'PAGCOMP','S', 'Movimiento',
                   FTRDC.NOADMISION, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 'FACTURA', @N_FACTURA, 
                   FTR.CODUNG, FTR.CODPRG
            FROM   FTR, KCDE, FTRDC 
            WHERE  FTR.CNSFCT = FTRDC.CNSFTR 
            AND    KCDE.TIPO  = @TIPO_DED 
            AND    KCDE.IDMODELOCONT = @IDMODELOCONT
            AND    FTR.N_FACTURA     = @N_FACTURA
            GROUP  BY KCDE.CUENTA, FTR.IDAFILIADO, FTR.IDTERCERO, 
                   FTRDC.CCOSTO, FTRDC.IDAREA, FTR.N_FACTURA, FTRDC.NOADMISION, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),
                   FTR.CODUNG, FTR.CODPRG, FTRDC.PROCEDENCIA
            HAVING SUM(FTRDC.VLR_COPAGO)>0

			   UPDATE MCHE SET IDTERCERO=TER.IDTERCERO
			   FROM MCHE
			   LEFT JOIN AFI ON AFI.IDAFILIADO=MCHE.IDTERCERO
			   LEFT JOIN TER ON TER.NIT=AFI.DOCIDAFILIADO
			   WHERE NROCOMPROBANTE=@MAUX AND PROCESO='PAGCOMP' 
            AND NOT EXISTS(SELECT 1 FROM TER WHERE IDTERCERO=MCHE.IDTERCERO AND COALESCE(IDTERCERO,'')<>'')


         END    
      END
      PRINT 'Contabilizando el Descuento por Prefijo. '+STR(@DESCUENTO)
      IF @DESCUENTO>0
      BEGIN
         INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, DETALLE, VALOR, REFERENCIA1,
      		               REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, CCOSTO, CLASECONT, 
                         ESTADO, PROCESO, GENERA, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, 
                         CODUNG, CODPRG)
         SELECT @MAUX, @COMPANIA, KMCOM.TIPO, KMCOM.CUENTA, #D.IDTERCERO, 
                'DESCUENTOS', SUM(#D.VALOR), #D.N_FACTURA, NULL, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
                KMCOM.PREFIJO, KMCOM.IDAREA, KMCOM.CCOSTO, KMCOM.CLASECONT, 1, 'DESCUENTOS', 'Movimiento',
                #D.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#D.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(#D.F_VENCE),'FACTURA',@N_FACTURA, 
                #D.CODUNG, #D.CODPRG
         FROM   #D, KMCOM
         WHERE  #D.PREFIJO = KMCOM.PREFIJO AND KMCOM.CCOSTO=#D.CCOSTO AND   -- se quito el idarea   AND KMCOM.IDAREA=#D.IDAREA 
                KMCOM.IDTIPOCONT='DESCUENTOS' AND KMCOM.CLASECONT='P' AND KMCOM.TIPO='DB' AND #D.VALOR>0
         GROUP BY KMCOM.TIPO,KMCOM.CUENTA,#D.IDTERCERO, KMCOM.PREFIJO,KMCOM.IDAREA, KMCOM.CCOSTO, 
                KMCOM.CLASECONT, #D.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#D.F_FACTURA), 
                DBO.FNK_FECHA_SIN_HORA(#D.F_VENCE), #D.CODUNG, #D.CODPRG
         
         INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, DETALLE, VALOR, REFERENCIA1,
                          REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, CCOSTO, CLASECONT, 
                          ESTADO, PROCESO, GENERA, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO,
                          CODUNG, CODPRG)
         SELECT @MAUX, @COMPANIA, 'DB','NO DEF.KMCOM',#D.IDTERCERO,'DESCUENTOS',SUM(#D.VALOR), #D.N_FACTURA,
                NULL,NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()),#D.PREFIJO, #D.IDAREA, #D.CCOSTO, 'P', 0,
                'DESCUENTOS', 'Movimiento', #D.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#D.F_FACTURA), 
                DBO.FNK_FECHA_SIN_HORA(#D.F_VENCE),'FACTURA',@N_FACTURA, #D.CODUNG, #D.CODPRG
         FROM   #D
         WHERE NOT #D.PREFIJO IN (SELECT KMCOM.PREFIJO 
                                  FROM KMCOM 
                                  WHERE KMCOM.CCOSTO=#D.CCOSTO AND               --KMCOM.IDAREA=#D.IDAREA AND 
                                        KMCOM.IDTIPOCONT='DESCUENTOS' AND KMCOM.CLASECONT='P' AND 
                                        KMCOM.TIPO='DB' AND #D.VALOR>0)
         GROUP BY #D.IDTERCERO, #D.PREFIJO, #D.IDAREA, #D.CCOSTO, #D.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#D.F_FACTURA), 
                  DBO.FNK_FECHA_SIN_HORA(#D.F_VENCE), #D.CODUNG, #D.CODPRG
      END
      
      IF UPPER(DBO.FNK_VALORVARIABLE('CONTAB_IMP_FTR')) = 'SI'
      BEGIN
         PRINT 'Contabilizando Impuestos...'
         DECLARE CUR_IMP CURSOR FOR
         SELECT FTRI.IDIMPUESTO, FTRI.IDCLASE, FTRI.VALORFTRI, FTRI.VALOR 
         FROM FTR INNER JOIN FTRI ON FTR.N_FACTURA = FTRI.N_FACTURA
         WHERE FTRI.VALOR>0
         AND FTR.N_FACTURA=@N_FACTURA
         
         
         OPEN CUR_IMP
         
         FETCH NEXT FROM CUR_IMP
         INTO @IDIMPUESTO, @IDCLASE, @VALORFTRI, @VALOR_IMP 
         
         WHILE @@FETCH_STATUS = 0
         BEGIN
            PRINT 'Impuesto: '+ISNULL(@IDIMPUESTO,'')+'  -  Clase: '+ISNULL(@IDCLASE,'')
            PRINT @VR_TOTAL
            PRINT @FECHATRA
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, IDAREA, DETALLE, VALOR,
                             REFERENCIA1, REFERENCIA2, REFERENCIA3, ITEMREF, USUARIO, FECHA, PREFIJO, ESTADO, PROCESO, GENERA, 
                             CLASECONT, VALOR_PORCIMP, BASE_IMP, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO)
            SELECT TOP 1 @MAUX, @COMPANIA, 'DB', I.CUENTA, FTR.IDTERCERO, NULL, NULL, ISNULL(FIMP.DESCRIPCION,'IMPUESTOS'), 
                   @VALOR_IMP, @IDIMPUESTO, @IDCLASE, I.ITEM, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
                   @IDIMPUESTO, 1, 'FTR_IMPUESTOS', 'Movimiento', 'S', @VALORFTRI, FTR.VALORSERVICIOS, @N_FACTURA, 
                   DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 'FACTURA', @N_FACTURA
            FROM   FTR, FNK_CALCULO_IMPUESTO(@IDIMPUESTO, @IDCLASE, @VALORSERVICIOS, @FECHATRA) I LEFT JOIN FIMP ON IDIMPUESTO = @IDIMPUESTO 
            WHERE  FTR.N_FACTURA = @N_FACTURA
            
            FETCH NEXT FROM CUR_IMP
            INTO @IDIMPUESTO, @IDCLASE, @VALORFTRI, @VALOR_IMP 
         END
         CLOSE CUR_IMP
         DEALLOCATE CUR_IMP
         IF UPPER(DBO.FNK_VALORVARIABLE('ANTIPO_IMP_RESTA_FTR')) = 'NO' AND COALESCE(@VALORFTRI,0)>0
         BEGIN
            PRINT 'INGRESO A LA CONTRAPARTIDA'
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, IDAREA, DETALLE, VALOR,
                             REFERENCIA1, REFERENCIA2, REFERENCIA3, ITEMREF, USUARIO, FECHA, PREFIJO, ESTADO, PROCESO, GENERA, 
                             CLASECONT, VALOR_PORCIMP, BASE_IMP, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO)
            SELECT TOP 1 @MAUX, @COMPANIA, 'CR', DBO.FNK_VALORVARIABLE('CUENTA_CR_ANTIMPUEST'), FTR.IDTERCERO, NULL, NULL, NULL, 
                   @VLR_IMPUESTOS, NULL, NULL, 1, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
                   @IDIMPUESTO, 1, 'FTR_IMPUESTOS', 'Movimiento', 'S', @VALORFTRI, FTR.VALORSERVICIOS, @N_FACTURA, 
                   DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 'FACTURA', @N_FACTURA
            FROM   FTR
            WHERE  FTR.N_FACTURA = @N_FACTURA    
         END 
      END
      --query2     
      PRINT 'DETALLES DEL COMPROBANTE MCH'
      IF @CAPITADA = 0
      BEGIN
         PRINT 'Inserta por Servicio.'
         IF (@PROCEDENCIA = 'SALUD' OR @PROCEDENCIA = 'CE' ) AND @TIPOFAC = 'M'
         BEGIN
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
                             REFERENCIA1 ,REFERENCIA2 , REFERENCIA3,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                             CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, 
                             F_FACTURAREF, F_VENCE, CODUNG, CODPRG)
            SELECT @MAUX, @COMPANIA, 'CR', 
                    DBO.FNK_NC_CUENTA_KMCOM(@IDMODELOCONT,'VENTAS','CR',FTRD.PREFIJO,FTRD.CCOSTO,'S',FTRD.REFERENCIA,@PGP),
                    FTR.IDTERCERO, FTRD.CCOSTO, 
                    UPPER(SER.DESCSERVICIO)+' FACTURA No.'+FTRD.N_FACTURA, 
                    SUM(FTRD.VLR_SERVICI - (CASE WHEN FTRD.VIVA IS NULL THEN 0 ELSE FTRD.VIVA END)), 
                    FTRD.REFERENCIA, 'VARIAS', FTRD.NOPRESTACION, '', @USUARIO, 
                    DBO.FNK_FECHA_SIN_HORA(GETDATE()), FTRD.PREFIJO, FTRD.AREAPRESTACION, FTRD.IDPROVEEDOR, 'S', 1,
                    'VENTAS', 'Movimiento','FACTURA', @N_FACTURA, 
                    @N_FACTURA, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),
                    FTRD.CODUNG, FTRD.CODPRG
            FROM    FTR INNER JOIN FTRD ON FTR.CNSFCT      = FTRD.CNSFTR
                         LEFT JOIN SER  ON FTRD.REFERENCIA = SER.IDSERVICIO 
            WHERE   FTRD.VLR_SERVICI <> 0
            AND     FTR.N_FACTURA     = @N_FACTURA
            GROUP BY DBO.FNK_NC_CUENTA_KMCOM(@IDMODELOCONT,'VENTAS','CR',FTRD.PREFIJO, FTRD.CCOSTO,'S',FTRD.REFERENCIA,@PGP),
                     FTR.IDTERCERO, FTRD.CCOSTO, UPPER(SER.DESCSERVICIO)+' FACTURA No.'+FTRD.N_FACTURA, FTRD.REFERENCIA,
                     FTRD.PREFIJO, FTRD.AREAPRESTACION, FTRD.IDPROVEEDOR, 
                     DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),
                     FTRD.CODUNG, FTRD.CODPRG, FTRD.NOPRESTACION
         END
         ELSE --DIFERENTE DE MASIVO
         BEGIN
            PRINT 'CONTABILIZA CREDITO DESDE FACTURA MANUAL'
            PRINT 'CREDITOS MCH FACTURA'
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
                             REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                             CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, 
                             F_FACTURAREF, F_VENCE, CODUNG, CODPRG)
            SELECT @MAUX, @COMPANIA, 'CR', 
                   CASE WHEN COALESCE(DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO'),'') <> ''
                        THEN
                            CASE WHEN COALESCE(FTRD.IDPROVEEDOR,'') = DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO') 
                                 THEN DBO.FNK_NC_CUENTA_KMCOM_IPS(@IDMODELOCONT,'VENTAS','CR',FTRD.PREFIJO, FTRD.CCOSTO,'S',FTRD.REFERENCIA)
                                 ELSE DBO.FNK_NC_CUENTA_KMCOM(@IDMODELOCONT,'VENTAS','CR',FTRD.PREFIJO, FTRD.CCOSTO,'S',FTRD.REFERENCIA,@PGP)
                            END
                        ELSE DBO.FNK_NC_CUENTA_KMCOM(@IDMODELOCONT,'VENTAS','CR',FTRD.PREFIJO, FTRD.CCOSTO,'S',FTRD.REFERENCIA,@PGP)         
                   END,FTR.IDTERCERO,
                   --CASE DBO.FNK_VALORVARIABLE('CONTABFTR_PRO') 
                   --     WHEN 'FTRD.IDPROVEEDOR' THEN CASE WHEN COALESCE(FTRD.IDPROVEEDOR,'') <> '' THEN FTRD.IDPROVEEDOR
                   --                                       ELSE FTR.IDTERCERO
                   --                                  END     
                   --     ELSE FTR.IDTERCERO 
                   --END, 
                   FTRD.CCOSTO, 
                   UPPER(ISNULL(SER.DESCSERVICIO,PRE.NOM_PREFIJO))+' FACTURA No. '+FTRD.N_FACTURA,
                   CASE WHEN DBO.FNK_VALORVARIABLE('IXCOUNTRY') = 'PERU' THEN FTRD.VLR_SERVICI - (CASE WHEN FTRD.VIVA IS NULL THEN 0 ELSE FTRD.VIVA END)-FTRD.VLR_COPAGOS
                   ELSE
                     FTRD.VLR_SERVICI - (CASE WHEN FTRD.VIVA IS NULL THEN 0 ELSE CASE WHEN  DBO.FNK_VALORVARIABLE('BASE_IVA_SERVICIOS')='SINIVA' THEN 0 ELSE FTRD.VIVA END END) 
                   END,
                   FTRD.REFERENCIA, FTRD.NOPRESTACION, FTRD.NOITEM, @USUARIO, 
                   DBO.FNK_FECHA_SIN_MLS(GETDATE()), FTRD.PREFIJO, FTRD.AREAPRESTACION, FTRD.IDPROVEEDOR, 'S', 1,
                   'VENTAS', 'Movimiento','FACTURA', @N_FACTURA, 
                   @N_FACTURA, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),
                   FTRD.CODUNG, FTRD.CODPRG
            FROM   FTR INNER JOIN FTRD ON FTR.CNSFCT = FTRD.CNSFTR 
                        LEFT JOIN SER  ON FTRD.REFERENCIA = SER.IDSERVICIO 
						LEFT JOIN PRE ON  FTRD.PREFIJO=PRE.PREFIJO
            WHERE  FTRD.VLR_SERVICI <> 0
            AND    FTR.N_FACTURA     = @N_FACTURA
            AND    COALESCE(FTRD.PAQUETE,0)=CASE WHEN COALESCE(FTR.PAQUETE,0)=1 AND FTR.PROCEDENCIA='CI' AND COALESCE(FTR.CNSFMAS,'')<>'' THEN 0 ELSE COALESCE(FTRD.PAQUETE,0)  END
            --AND (COALESCE(FTRD.PAQUETE,0) = CASE WHEN COALESCE(FTR.PAQUETE,0)=1 THEN 1 ELSE 0 END OR  
            --COALESCE(FTRD.PAQUETE,0) = CASE WHEN COALESCE(FTR.PAQUETE,0)=1 THEN 3 ELSE 0 END)  -- JEDM:09.AGO.2011 PAQUETE          
         END            
         PRINT  'Contabilizando IVA...' 
	    -- MOD.JQUIROGA 20090620 - En Venezuela IDTERCERO es el mismo proveedor
         INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, IDAREA, DETALLE, 
                          VALOR ,REFERENCIA1, REFERENCIA2, ITEMREF, USUARIO, FECHA, ESTADO, PROCESO, 
                          CLASECONT, GENERA, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, IDPROVEEDOR)
         SELECT @MAUX, @COMPANIA, 'CR', FTRD.CUENTA_FIMPDV, 
                CASE WHEN DBO.FNK_VALORVARIABLE('IXCOUNTRY') = 'VENEZUELA' THEN FTR.IDTERCERO ELSE DBO.FNK_VALORVARIABLE('IDCON_TERCEROIVA') END, 
                FTRD.CCOSTO, FTRD.AREAPRESTACION,
                'IVA GENERADO DEL '+LTRIM(STR(FTRD.PIVA))+'%', SUM(FTRD.VIVA), NULL, NULL, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
                1, 'IVA','S', 'Movimiento', FTR.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),
                'FACTURA', @N_FACTURA, FTR.IDTERCERO
         FROM   FTR INNER JOIN FTRD ON FTR.CNSFCT = FTRD.CNSFTR
         WHERE  FTRD.VIVA > 0 
         AND    FTR.N_FACTURA = @N_FACTURA
         GROUP BY FTRD.CUENTA_FIMPDV, FTRD.CCOSTO, FTRD.AREAPRESTACION,
                  FTR.N_FACTURA, FTRD.PIVA, FTR.IDTERCERO, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), 
                  DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE)    
         --JEDM:09.AGO.2011 PAQUETE SABER SI DIO GANANCIA O PERDIDA
         IF (SELECT COALESCE(PAQUETE,0) FROM FTR WHERE FTR.N_FACTURA = @N_FACTURA) = 1
         BEGIN
            EXEC SPK_NC_SUMA_DBCR @MAUX
           
            SELECT @PYG=TOTALDEBITO-TOTALCREDITO FROM MCPE WHERE NROCOMPROBANTE=@MAUX
            PRINT '@PYG = ' + CAST( @PYG AS VARCHAR(20))
            IF @PYG >0
            BEGIN
               PRINT 'Inserta PyG Paquete.'
               INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
                                REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                                CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                                CODUNG, CODPRG)             
               SELECT NROCOMPROBANTE=@MAUX, COMPANIA=@COMPANIA, TIPO=CASE WHEN @PYG>0 THEN 'CR' ELSE 'DB' END, 
                      CUENTA = CASE WHEN @PYG > 0 THEN DBO.FNK_VALORVARIABLE('PYG_PAQUETE_G') ELSE DBO.FNK_VALORVARIABLE('PYG_PAQUETE_P') END,
                      FTR.IDTERCERO, #T.CCOSTO, DETALLE='PYG PAQUETE FACTURA No.'+@N_FACTURA, VALOR=ABS(@PYG), 
                      REFERENCIA1=NULL, REFERENCIA2=NULL, ITEMREF=NULL, USUARIO=@USUARIO, FECHA=DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
                      NULL, #T.IDAREA, IDPROVEEDOR = NULL,
                      CLASECONT='P', ESTADO=1, PROCESO='PYG_PAQUETE', GENERA='Movimiento', PROCEDENCIA='FACTURA', REFERENCIA_PRO=@N_FACTURA, 
                      N_FACTURA=@N_FACTURA, F_FACTURAREF=DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), F_VENCE=DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 
                      FTR.CODUNG, FTR.CODPRG
               FROM   #T, FTR
               WHERE  FTR.N_FACTURA = @N_FACTURA
            END
			ELSE
			BEGIN
            DECLARE @TOTALCREDITO DECIMAL(14,2)
            SELECT @TOTALCREDITO=TOTALCREDITO FROM MCPE WHERE NROCOMPROBANTE=@MAUX

             UPDATE MCHE SET VALOR=VALOR-ROUND((ABS(@PYG)*((VALOR*100.00/@TOTALCREDITO)/100.00)),2)
            FROM MCHE WHERE NROCOMPROBANTE=@MAUX
            AND TIPO='CR'

			END
         END   
      END
      ELSE -- CAPITADA = 1
      BEGIN
         IF DBO.FNK_VALORVARIABLE('CAPITA_SIN_PERDIDA')<>'SI'
         BEGIN
            PRINT 'Inserta por Servicio Capitados....'
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
                             REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                             CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                             CODUNG, CODPRG)
            SELECT NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, SUM(VALOR), 
                   REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                   CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                   CODUNG, CODPRG
            FROM
                  (SELECT NROCOMPROBANTE=@MAUX, COMPANIA=@COMPANIA, TIPO='CR', 
                          CUENTA=DBO.FNK_NC_CUENTA_KMCOM(@IDMODELOCONT,'VENTAS','CR',FTRDC.PREFIJO, FTRDC.CCOSTO,'S','',@PGP),
                          FTR.IDTERCERO, FTRDC.CCOSTO, DETALLE=UPPER(PRE.NOM_PREFIJO)+' FACTURA No.'+@N_FACTURA, VALOR=FTRDC.VALORTOTAL, 
                          REFERENCIA1=FTRDC.PREFIJO, REFERENCIA2=NULL, ITEMREF=NULL, USUARIO=@USUARIO, FECHA=DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
                          FTRDC.PREFIJO, FTRDC.IDAREA, IDPROVEEDOR=
                          CASE FTRDC.PROCEDENCIA 
                           WHEN 'HADM' THEN (SELECT IDPROVEEDOR FROM HPRED WHERE NOPRESTACION=FTRDC.NOPRESTACION AND NOITEM=FTRDC.NOITEM AND ISNULL(HPRED.ANULADO,0) = 0)  --SJUNCO REQ 1803
                           WHEN 'AUT'  THEN (SELECT IDPROVEEDOR FROM AUT WHERE IDAUT=FTRDC.NOADMISION)
                           WHEN 'CIT'  THEN (SELECT IDMEDICO FROM CIT WHERE CONSECUTIVO=FTRDC.NOADMISION) 
                          END,  
                          CLASECONT='P', ESTADO=1, PROCESO='VENTAS', GENERA='Movimiento', PROCEDENCIA='FACTURA', REFERENCIA_PRO=@N_FACTURA, N_FACTURA=@N_FACTURA, 
                          F_FACTURAREF=DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), F_VENCE=DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), FTR.CODUNG, FTR.CODPRG
                   FROM   FTR LEFT JOIN FTRDC ON FTR.CNSFCT    = FTRDC.CNSFTR 
                              LEFT JOIN   PRE ON FTRDC.PREFIJO = PRE.PREFIJO
                   WHERE  FTRDC.VALORTOTAL <> 0
                   AND    FTR.N_FACTURA     = @N_FACTURA) X
            GROUP BY NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, 
                  REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                  CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                  CODUNG, CODPRG
         
            EXEC SPK_NC_SUMA_DBCR @MAUX
            SELECT @PYG=TOTALDEBITO-TOTALCREDITO FROM MCPE WHERE NROCOMPROBANTE=@MAUX


            SELECT @CUESINDETA=CUENTA FROM KCDE WHERE IDMODELOCONT=@IDMODELOCONT   AND TIPO='FTR_CAPITASINDETALLE' 

            SELECT @TOTALCUEIN=COUNT(*) FROM MCHE WHERE  NROCOMPROBANTE=@MAUX AND TIPO='CR'
            SELECT @PASO=0
            SELECT @PASO= CASE WHEN @PYG>0 AND EXISTS(SELECT * FROM CUE WHERE CUENTA=COALESCE(@CUESINDETA,'')) AND COALESCE(@TOTALCUEIN,0)=0 THEN 1 ELSE 0 END

            PRINT '@TOTALCUEIN= '+STR(@TOTALCUEIN)
            PRINT '@PYG= '+STR(@PYG)
            PRINT '@CUESINDETA= '+COALESCE(@CUESINDETA,'')

            IF @PYG<>0 AND @PASO=0
            BEGIN
               PRINT 'Inserta PyG JHON Contrato Capitado.... @PASO ='+STR(@PASO)
               INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
                               REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                               CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                               CODUNG, CODPRG)
               SELECT NROCOMPROBANTE=@MAUX, COMPANIA=@COMPANIA, TIPO=CASE WHEN @PYG>0 THEN 'CR' ELSE 'DB' END, 
                      CUENTA = CASE WHEN @PYG>0 THEN DBO.FNK_VALORVARIABLE('PYG_CAPITADO_G') ELSE DBO.FNK_VALORVARIABLE('PYG_CAPITADO_P') END,
                      FTR.IDTERCERO, '', DETALLE='PYG FACTURA CAPITADA No.'+@N_FACTURA, VALOR=ABS(@PYG), 
                      REFERENCIA1=NULL, REFERENCIA2=NULL, ITEMREF=NULL, USUARIO=@USUARIO, FECHA=DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
                      NULL, '', IDPROVEEDOR = NULL,
                      CLASECONT='P', ESTADO=1, PROCESO='PYG_CAPITADO', GENERA='Movimiento', PROCEDENCIA='FACTURA', REFERENCIA_PRO=@N_FACTURA, 
                      N_FACTURA=@N_FACTURA, F_FACTURAREF=DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), F_VENCE=DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 
                      FTR.CODUNG, FTR.CODPRG
               FROM   FTR
               WHERE  FTR.N_FACTURA = @N_FACTURA
            END
         END
         ELSE
         BEGIN
            PRINT 'Inserta por Servicio Capitados....TENGO ACTIVDAD LA VARIABLE ENTRE POR AQUI.....................'
			EXEC SPK_NC_SUMA_DBCR @MAUX
			SELECT @VLRDEBITOS= TOTALDEBITO  FROM MCPE WHERE NROCOMPROBANTE=@MAUX
			PRINT '@DIFECOPAGOS PARA INGRESAR LOS CREDITOS '+STR(@DIFECOPAGOS)
            SELECT  @VALORFTR=VALORSERVICIOS FROM FTR WHERE N_FACTURA=@N_FACTURA
			--SELECT  @VALORFTR=(@VLRDEBITOS-@VALORFTR)
			PRINT '@VALORFTR DEFINITIVO '+STR(@VALORFTR)

			

            SELECT ROW_NUMBER() OVER(ORDER  BY NROCOMPROBANTE  ASC)NRO ,NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, SUM(VALOR)VALOR, 
                   REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                   CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                   CODUNG, CODPRG INTO #TC
            FROM
                  (SELECT NROCOMPROBANTE=@MAUX, COMPANIA=@COMPANIA, TIPO='CR', 
                          CUENTA=DBO.FNK_NC_CUENTA_KMCOM(@IDMODELOCONT,'VENTAS','CR',FTRDC.PREFIJO, FTRDC.CCOSTO,'S','',@PGP),
                          FTR.IDTERCERO, FTRDC.CCOSTO, DETALLE=UPPER(PRE.NOM_PREFIJO)+' FACTURA No.'+@N_FACTURA, VALOR=FTRDC.VALORTOTAL, 
                          REFERENCIA1=FTRDC.PREFIJO, REFERENCIA2=NULL, ITEMREF=NULL, USUARIO=@USUARIO, FECHA=DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
                          FTRDC.PREFIJO, FTRDC.IDAREA, IDPROVEEDOR=
                          CASE FTRDC.PROCEDENCIA 
                           WHEN 'HADM' THEN (SELECT IDPROVEEDOR FROM HPRED WHERE NOPRESTACION=FTRDC.NOPRESTACION AND NOITEM=FTRDC.NOITEM AND ISNULL(HPRED.ANULADO,0) = 0)  --SJUNCO REQ 1803
                           WHEN 'AUT'  THEN (SELECT IDPROVEEDOR FROM AUT WHERE IDAUT=FTRDC.NOADMISION)
                           WHEN 'CIT'  THEN (SELECT IDMEDICO FROM CIT WHERE CONSECUTIVO=FTRDC.NOADMISION) 
                          END,  
                          CLASECONT='P', ESTADO=1, PROCESO='VENTAS', GENERA='Movimiento', PROCEDENCIA='FACTURA', REFERENCIA_PRO=@N_FACTURA, N_FACTURA=@N_FACTURA, 
                          F_FACTURAREF=DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), F_VENCE=DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), FTR.CODUNG, FTR.CODPRG
                   FROM   FTR LEFT JOIN FTRDC ON FTR.CNSFCT    = FTRDC.CNSFTR 
                              LEFT JOIN   PRE ON FTRDC.PREFIJO = PRE.PREFIJO
                   WHERE  FTRDC.VALORTOTAL <> 0
                   AND    FTR.N_FACTURA     = @N_FACTURA) X
            GROUP BY NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, 
                  REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                  CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                  CODUNG, CODPRG
                                   
            SELECT @VALORCR=SUM(VALOR) FROM #TC
             
		      PRINT 'VALOR FTR  FACTURA...='+STR(@VALORFTR)
			   PRINT  'VALOR CARGOS  EN CONTABILIDAD = '+STR(@VALORCR)
            SELECT @CUESINDETA=CUENTA FROM KCDE WHERE IDMODELOCONT=@IDMODELOCONT   AND TIPO='FTR_CAPITASINDETALLE' 
		      IF COALESCE(@VALORCR,0)<=0 AND COALESCE(@CUESINDETA,'')<>''
            BEGIN
                INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
                               REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                               CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                               CODUNG, CODPRG)
               SELECT NROCOMPROBANTE=@MAUX, COMPANIA=@COMPANIA,'CR', CUENTA = @CUESINDETA,
                      FTR.IDTERCERO, '', DETALLE=FTRD.ANEXO +' N_FACTURA: '+@N_FACTURA, FTRD.VR_TOTAL, 
                      REFERENCIA1=FTRD.IDPLAN, REFERENCIA2=FTRD.REFERENCIA, ITEMREF=NULL, USUARIO=@USUARIO, FECHA=DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
                      NULL, '', IDPROVEEDOR = NULL,
                      CLASECONT='P', ESTADO=1, PROCESO='PYG_CAPITADO', GENERA='Movimiento', PROCEDENCIA='FACTURA', REFERENCIA_PRO=@N_FACTURA, 
                      N_FACTURA=@N_FACTURA, F_FACTURAREF=DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), F_VENCE=DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 
                      FTR.CODUNG, FTR.CODPRG
               FROM   FTR INNER JOIN FTRD ON FTR.N_FACTURA=FTRD.N_FACTURA
               WHERE  FTR.N_FACTURA = @N_FACTURA
               
               SELECT @VALORCR = @VALORFTR

            END
            IF @VALORCR <=@VALORFTR
            BEGIN
			   PRINT'ENTRE AQUI'
               INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
                                REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                                CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                                CODUNG, CODPRG)               
               SELECT NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, SUM(VALOR)VALOR, 
                   REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                   CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                   CODUNG, CODPRG 
               FROM #TC
               GROUP BY NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, 
                   REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                   CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                   CODUNG, CODPRG
            END
            ELSE
            BEGIN
               PRINT 'FACTURA CAPITADA SIN PERDIDAS...............'
			      DECLARE @VALORMCHE DECIMAL(14,2) =0
               SELECT @I=1,@DIF=1,@VALORI=0
               SELECT @VALORCR=VALOR FROM #TC WHERE NRO=@I
               WHILE @VALORCR< @VALORFTR
               BEGIN
					   SELECT @VALORI=VALOR FROM #TC WHERE NRO=@I 	
					   IF (@VALORCR+@VALORI)>@VALORFTR
					   BEGIN
						   PRINT 'AJUSTO EL ULTIMO VALOR'
						   SELECT @FALTANTE=@VALORFTR-@VALORCR
						   PRINT '@FALTANTE ='+STR(@FALTANTE)
						   SELECT @VALORI=@FALTANTE
					   END
					   PRINT '@VALORCR ='+STR(@VALORCR)+' @VALORFTR= '+STR(@VALORFTR)
					   INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
									   REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
									   CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
									   CODUNG, CODPRG)               
					   SELECT NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE,@VALORI, 
						   REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
						   CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
						   CODUNG, CODPRG FROM #TC
					   WHERE NRO=@I  
			      SELECT @VALORCR= SUM(VALOR) FROM MCHE WHERE NROCOMPROBANTE=@MAUX AND TIPO='CR'
                  SELECT @I=@I+1
                  IF @VALORCR = @VALORFTR AND @VALORMCHE=@VALORFTR
                  BEGIN
                     PRINT 'SALGO DEL WHILE'
					 SELECT @VALORI=VALOR FROM #TC WHERE NRO=@I 
                     SELECT @VALORCR=@VALORCR+@VALORI
                  END
               END
            END
         END
		 EXEC SPK_NC_SUMA_DBCR @MAUX
         PRINT 'DIFERENCIAS EN COPAGOS '
         PRINT '@CAPITADA ='+STR(@CAPITADA)
         PRINT 'COALESCE(@DIFECOPAGOS,0) ='+STR(COALESCE(@DIFECOPAGOS,0))
		-- RETURN
         IF @CAPITADA = 1 AND COALESCE(@DIFECOPAGOS,0)<>0
         BEGIN
            PRINT 'Buscamos las cuentas'
            DECLARE @NROCOPAGA SMALLINT

            IF @DIFECOPAGOS<0 -- DEBI RECUAUDAS MAS COPAGOS DEBO ASUMIR LA DIFERENCIA
            BEGIN 
	            PRINT 'ENTRE AQUI DIFECOPAGOS<0'
               SELECT  @NROCOPAGA=COUNT(*)
               FROM(
        
                  SELECT @MAUX CNS, @COMPANIA COMPANIA, 'DB' TIPO , KCDE.CUENTA, 
                           CASE FTRDC.PROCEDENCIA
                           WHEN 'HADM' THEN (SELECT IDAFILIADO FROM HADM WHERE NOADMISION=FTRDC.NOADMISION)
                           WHEN 'AUT'  THEN (SELECT IDAFILIADO FROM AUT WHERE IDAUT=FTRDC.NOADMISION)
                           WHEN 'CIT'  THEN (SELECT IDAFILIADO FROM CIT WHERE CONSECUTIVO=FTRDC.NOADMISION)
                           END PROCED,
                           FTRDC.CCOSTO, FTRDC.IDAREA, 'COPAGOS.' DATO ,SUM(FTRDC.VLR_COPAGO)VLR_COPAGO, FTR.N_FACTURA,
                           FTRDC.NOADMISION, 
                           FTR.CODUNG, FTR.CODPRG
                  FROM   FTR, KCDE, FTRDC 
                  WHERE  FTR.CNSFCT = FTRDC.CNSFTR 
                  AND    KCDE.TIPO  = 'FTR_PYGCOPAGO_P' 
                  AND    KCDE.IDMODELOCONT = @IDMODELOCONT
                  AND    FTR.N_FACTURA     = @N_FACTURA
                  GROUP  BY KCDE.CUENTA, FTR.IDAFILIADO, FTR.IDTERCERO, 
                           FTRDC.CCOSTO, FTRDC.IDAREA, FTR.N_FACTURA, FTRDC.NOADMISION, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),
                           FTR.CODUNG, FTR.CODPRG, FTRDC.PROCEDENCIA
                  HAVING SUM(FTRDC.VLR_COPAGO)>0 )X
         
	            IF(COALESCE(@NROCOPAGA,0)>=1)
	            BEGIN 
                  PRINT 'DISTRIBUYO LA PERDIDA ENTRE LOS COPAGOS EXISTENTES'
                     INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, IDAREA, DETALLE,
                                       VALOR ,REFERENCIA1,REFERENCIA2, ITEMREF, USUARIO, FECHA, ESTADO, PROCESO, 
                                       CLASECONT, GENERA, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, 
                                       CODUNG, CODPRG)
                     SELECT @MAUX, @COMPANIA, 'DB', KCDE.CUENTA, 
                              CASE FTRDC.PROCEDENCIA
                              WHEN 'HADM' THEN (SELECT IDAFILIADO FROM HADM WHERE NOADMISION=FTRDC.NOADMISION)
                              WHEN 'AUT'  THEN (SELECT IDAFILIADO FROM AUT WHERE IDAUT=FTRDC.NOADMISION)
                              WHEN 'CIT'  THEN (SELECT IDAFILIADO FROM CIT WHERE CONSECUTIVO=FTRDC.NOADMISION)
                              END,
                              FTRDC.CCOSTO, FTRDC.IDAREA, 'DIFERENCIA EN COPAGOS.',CONVERT(DECIMAL(14,2),ABS(@DIFECOPAGOS)/CASE WHEN @NROCOPAGA<=0 THEN 1 ELSE  @NROCOPAGA END ), FTR.N_FACTURA, NULL, NULL, 
                              @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), 1, 'PAGCOMP','S', 'Movimiento',
                              FTRDC.NOADMISION, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 'FACTURA', @N_FACTURA, 
                              FTR.CODUNG, FTR.CODPRG
                     FROM   FTR, KCDE, FTRDC 
                     WHERE  FTR.CNSFCT = FTRDC.CNSFTR 
                     AND    KCDE.TIPO  = 'FTR_PYGCOPAGO_P' --CUENTA DE PERIDA EN COPAGOS
                     AND    KCDE.IDMODELOCONT = @IDMODELOCONT
                     AND    FTR.N_FACTURA     = @N_FACTURA
                     GROUP  BY KCDE.CUENTA, FTR.IDAFILIADO, FTR.IDTERCERO, 
                              FTRDC.CCOSTO, FTRDC.IDAREA, FTR.N_FACTURA, FTRDC.NOADMISION, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),
                              FTR.CODUNG, FTR.CODPRG, FTRDC.PROCEDENCIA
                     HAVING SUM(FTRDC.VLR_COPAGO)>0
		            END 
		            ELSE 
		            BEGIN 
		               INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, IDAREA, DETALLE,
                                       VALOR ,REFERENCIA1,REFERENCIA2, ITEMREF, USUARIO, FECHA, ESTADO, PROCESO, 
                                       CLASECONT, GENERA, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, 
                                       CODUNG, CODPRG)
                     SELECT @MAUX, @COMPANIA, 'DB', KCDE.CUENTA, 
                              FTR.IDTERCERO,
                              MAX(FTRD.CCOSTO),MAX( FTRD.AREAPRESTACION), 'DIFERENCIA EN COPAGOS.',CONVERT(DECIMAL(14,2),ABS(@DIFECOPAGOS)/CASE WHEN @NROCOPAGA<=0 THEN 1 ELSE  @NROCOPAGA END ), FTR.N_FACTURA, NULL, NULL, 
                              @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), 1, 'PAGCOMP','S', 'Movimiento',
                              FTR.NOREFERENCIA, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 'FACTURA', @N_FACTURA, 
                              FTR.CODUNG, FTR.CODPRG
                     FROM   FTR, KCDE, FTRD 
                     WHERE  FTR.CNSFCT = FTRD.CNSFTR 
                     AND    KCDE.TIPO  = 'FTR_PYGCOPAGO_P' 
                     AND    KCDE.IDMODELOCONT = @IDMODELOCONT
                     AND    FTR.N_FACTURA     = @N_FACTURA
                     GROUP  BY KCDE.CUENTA, FTR.IDAFILIADO, FTR.IDTERCERO, 
                              FTR.N_FACTURA, FTR.NOREFERENCIA, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),
                              FTR.CODUNG, FTR.CODPRG
		         END
            END
            IF @DIFECOPAGOS>0  
            BEGIN
               PRINT 'VOY A BUSCAR LA GANACIA POR LOS COPAGOS....'
               SELECT  @NROCOPAGA=COUNT(*)
               FROM(
        
                  SELECT @MAUX CNS, @COMPANIA COMPANIA, 'DB' TIPO , KCDE.CUENTA, 
                           CASE FTRDC.PROCEDENCIA
                           WHEN 'HADM' THEN (SELECT IDAFILIADO FROM HADM WHERE NOADMISION=FTRDC.NOADMISION)
                           WHEN 'AUT'  THEN (SELECT IDAFILIADO FROM AUT WHERE IDAUT=FTRDC.NOADMISION)
                           WHEN 'CIT'  THEN (SELECT IDAFILIADO FROM CIT WHERE CONSECUTIVO=FTRDC.NOADMISION)
                           END PROCED,
                           FTRDC.CCOSTO, FTRDC.IDAREA, 'COPAGOS.' DATO ,SUM(FTRDC.VLR_COPAGO)VLR_COPAGO, FTR.N_FACTURA,
                           FTRDC.NOADMISION, 
                           FTR.CODUNG, FTR.CODPRG
                  FROM   FTR, KCDE, FTRDC 
                  WHERE  FTR.CNSFCT = FTRDC.CNSFTR 
                  AND    KCDE.TIPO  = 'FTR_PYGCOPAGO_G' 
                  AND    KCDE.IDMODELOCONT = @IDMODELOCONT
                  AND    FTR.N_FACTURA     = @N_FACTURA
                  AND   COALESCE(FTRDC.VLR_COPAGO,0)>0
                  GROUP  BY KCDE.CUENTA, FTR.IDAFILIADO, FTR.IDTERCERO, 
                           FTRDC.CCOSTO, FTRDC.IDAREA, FTR.N_FACTURA, FTRDC.NOADMISION, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),
                           FTR.CODUNG, FTR.CODPRG, FTRDC.PROCEDENCIA
                  HAVING SUM(FTRDC.VLR_COPAGO)>0 )X
         
	            IF(COALESCE(@NROCOPAGA,0)>=1)
	            BEGIN 
                  PRINT 'DISTRIBUYO LA GANACIA ENTRE LOS COPAGOS EXISTENTES'
                  INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, IDAREA, DETALLE,
                                    VALOR ,REFERENCIA1,REFERENCIA2, ITEMREF, USUARIO, FECHA, ESTADO, PROCESO, 
                                    CLASECONT, GENERA, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, 
                                    CODUNG, CODPRG)
                  SELECT @MAUX, @COMPANIA, 'CR', KCDE.CUENTA, 
                           CASE FTRDC.PROCEDENCIA
                           WHEN 'HADM' THEN (SELECT IDAFILIADO FROM HADM WHERE NOADMISION=FTRDC.NOADMISION)
                           WHEN 'AUT'  THEN (SELECT IDAFILIADO FROM AUT WHERE IDAUT=FTRDC.NOADMISION)
                           WHEN 'CIT'  THEN (SELECT IDAFILIADO FROM CIT WHERE CONSECUTIVO=FTRDC.NOADMISION)
                           END,
                           FTRDC.CCOSTO, FTRDC.IDAREA, 'DIFERENCIA EN COPAGOS.',CONVERT(DECIMAL(14,2),ABS(@DIFECOPAGOS)/CASE WHEN @NROCOPAGA<=0 THEN 1 ELSE  @NROCOPAGA END ), FTR.N_FACTURA, NULL, NULL, 
                           @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), 1, 'PAGCOMP','S', 'Movimiento',
                           FTRDC.NOADMISION, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 'FACTURA', @N_FACTURA, 
                           FTR.CODUNG, FTR.CODPRG
                  FROM   FTR, KCDE, FTRDC 
                  WHERE  FTR.CNSFCT = FTRDC.CNSFTR 
                  AND    KCDE.TIPO  = 'FTR_PYGCOPAGO_G' --CUENTA DE GANANCIA EN COPAGOS
                  AND    KCDE.IDMODELOCONT = @IDMODELOCONT
                  AND    FTR.N_FACTURA     = @N_FACTURA
                  AND    COALESCE(FTRDC.VLR_COPAGO,0)>0
                  GROUP  BY KCDE.CUENTA, FTR.IDAFILIADO, FTR.IDTERCERO, 
                           FTRDC.CCOSTO, FTRDC.IDAREA, FTR.N_FACTURA, FTRDC.NOADMISION, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),
                           FTR.CODUNG, FTR.CODPRG, FTRDC.PROCEDENCIA
                  HAVING SUM(COALESCE(FTRDC.VLR_COPAGO,0))>0

		            END 
		            ELSE 
		            BEGIN 
		               INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, IDAREA, DETALLE,
                                       VALOR ,REFERENCIA1,REFERENCIA2, ITEMREF, USUARIO, FECHA, ESTADO, PROCESO, 
                                       CLASECONT, GENERA, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, 
                                       CODUNG, CODPRG)
                     SELECT @MAUX, @COMPANIA, 'CR', KCDE.CUENTA, 
                              FTR.IDTERCERO,
                              MAX(FTRD.CCOSTO),MAX( FTRD.AREAPRESTACION), 'DIFERENCIA EN COPAGOS.',CONVERT(DECIMAL(14,2),ABS(@DIFECOPAGOS)/CASE WHEN @NROCOPAGA<=0 THEN 1 ELSE  @NROCOPAGA END ), FTR.N_FACTURA, NULL, NULL, 
                              @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), 1, 'PAGCOMP','S', 'Movimiento',
                              FTR.NOREFERENCIA, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 'FACTURA', @N_FACTURA, 
                              FTR.CODUNG, FTR.CODPRG
                     FROM   FTR, KCDE, FTRD 
                     WHERE  FTR.CNSFCT = FTRD.CNSFTR 
                     AND    KCDE.TIPO  = 'FTR_PYGCOPAGO_P' 
                     AND    KCDE.IDMODELOCONT = @IDMODELOCONT
                     AND    FTR.N_FACTURA     = @N_FACTURA
                     GROUP  BY KCDE.CUENTA, FTR.IDAFILIADO, FTR.IDTERCERO, 
                              FTR.N_FACTURA, FTR.NOREFERENCIA, DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE),
                              FTR.CODUNG, FTR.CODPRG            
		         END
			      UPDATE MCHE SET IDTERCERO=TER.IDTERCERO
			      FROM MCHE
			      LEFT JOIN AFI ON AFI.IDAFILIADO=MCHE.IDTERCERO
			      LEFT JOIN TER ON TER.NIT=AFI.DOCIDAFILIADO
			      WHERE NROCOMPROBANTE=@MAUX AND PROCESO='PAGCOMP' 
               AND NOT EXISTS(SELECT 1 FROM TER WHERE IDTERCERO=MCHE.IDTERCERO AND COALESCE(IDTERCERO,'')<>'')
            END

         END
         EXEC SPK_NC_SUMA_DBCR @MAUX
         
         SELECT @PYG=TOTALDEBITO-TOTALCREDITO FROM MCPE WHERE NROCOMPROBANTE=@MAUX

			PRINT '@PYG ='+STR(@PYG)
			--RETURN
			-- DIFERENCIAR QUE DE COPAGO Y QUE QUE  SERVICIOS
           -- SE COMENTARIZA EL SISTEMA INGRESA LOS ITEMS DE DIFERENCIA DEL COPAGO MAS ADELANTE
            --SELECT @PYG=CASE WHEN COALESCE(@DIFECOPAGOS,0)>0 THEN (@PYG+ ABS(COALESCE(@DIFECOPAGOS,0))) ELSE (@PYG- ABS(COALESCE(@DIFECOPAGOS,0)))  END
	     IF @PYG>0 AND DBO.FNK_VALORVARIABLE('CAPITA_SIN_GANANCIA')='SI'
        BEGIN
			  PRINT 'FACTURA CAPITADA SIN GANANCIAS TODO AL INGRESO ...............'
           SELECT DISTINCT CUENTA INTO #CUEIN FROM MCHE WHERE  NROCOMPROBANTE=@MAUX 
			  AND TIPO='CR'
			  AND EXISTS(SELECT  * FROM CUE WHERE CUE.CUENTA=MCHE.CUENTA)
			  AND CUENTA NOT IN(SELECT  CUENTA FROM KCDE WHERE CUENTA=MCHE.CUENTA AND KCDE.TIPO  IN('FTR_PYGCOPAGO_G','FTR_PYGCOPAGO_P'))
			  SELECT @TOTALCUEIN =COUNT(CUENTA) FROM #CUEIN
           IF COALESCE(@TOTALCUEIN,0)>0
           BEGIN
			      PRINT 'FACTURA CAPITADA SIN GANANCIAS TODO AL INGRESO JHON DOS...............'
			      INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
                               REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                               CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                               CODUNG, CODPRG)
                SELECT NROCOMPROBANTE=@MAUX, COMPANIA=@COMPANIA, TIPO='CR', 
                      CUENTA = #CUEIN.CUENTA,
                      FTR.IDTERCERO, '', DETALLE='FACTURA CAPITADA No.'+@N_FACTURA, VALOR= (@PYG /@TOTALCUEIN), 
                      REFERENCIA1=NULL, REFERENCIA2=NULL, ITEMREF=NULL, USUARIO=@USUARIO, FECHA=DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
                      NULL, '', IDPROVEEDOR = NULL,
                      CLASECONT='P', ESTADO=1, PROCESO='PYG_CAPITADO', GENERA='Movimiento', PROCEDENCIA='FACTURA', REFERENCIA_PRO=@N_FACTURA, 
                      N_FACTURA=@N_FACTURA, F_FACTURAREF=DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), F_VENCE=DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 
                      FTR.CODUNG, FTR.CODPRG
                FROM   FTR,#CUEIN
                WHERE  FTR.N_FACTURA = @N_FACTURA

			       DROP TABLE #CUEIN

            END
            ELSE
            BEGIN
			      PRINT 'POR AQUI JHON OJO '

                SELECT @CUESINDETA=CUENTA FROM KCDE WHERE IDMODELOCONT=@IDMODELOCONT   AND TIPO='FTR_CAPITASINDETALLE' 

               INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
                               REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                               CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                               CODUNG, CODPRG)
               SELECT NROCOMPROBANTE=@MAUX, COMPANIA=@COMPANIA,'CR', CUENTA = @CUESINDETA,
                      FTR.IDTERCERO, '', DETALLE=FTRD.ANEXO +' N_FACTURA: '+@N_FACTURA, FTRD.VR_TOTAL, 
                      REFERENCIA1=FTRD.IDPLAN, REFERENCIA2=FTRD.REFERENCIA, ITEMREF=NULL, USUARIO=@USUARIO, FECHA=DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
                      NULL, '', IDPROVEEDOR = NULL,
                      CLASECONT='P', ESTADO=1, PROCESO='PYG_CAPITADO', GENERA='Movimiento', PROCEDENCIA='FACTURA', REFERENCIA_PRO=@N_FACTURA, 
                      N_FACTURA=@N_FACTURA, F_FACTURAREF=DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), F_VENCE=DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 
                      FTR.CODUNG, FTR.CODPRG
               FROM   FTR INNER JOIN FTRD ON FTR.N_FACTURA=FTRD.N_FACTURA
               WHERE  FTR.N_FACTURA = @N_FACTURA
              END
			 END 
			 IF @PYG <>0 AND  DBO.FNK_VALORVARIABLE('CAPITA_SIN_GANANCIA')<>'SI'
          BEGIN
              PRINT 'Inserta PyG Contrato Capitado. ES POR AQUI JHON'
              INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
                               REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                               CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                               CODUNG, CODPRG)
               SELECT NROCOMPROBANTE=@MAUX, COMPANIA=@COMPANIA, TIPO=CASE WHEN @PYG>0 THEN 'CR' ELSE 'DB' END, 
                      CUENTA = CASE WHEN @PYG>0 THEN DBO.FNK_VALORVARIABLE('PYG_CAPITADO_G') ELSE DBO.FNK_VALORVARIABLE('PYG_CAPITADO_P') END,
                      FTR.IDTERCERO, '', DETALLE='PYG FACTURA CAPITADA No.'+@N_FACTURA, VALOR=ABS(@PYG), 
                      REFERENCIA1=NULL, REFERENCIA2=NULL, ITEMREF=NULL, USUARIO=@USUARIO, FECHA=DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
                      NULL, '', IDPROVEEDOR = NULL,
                      CLASECONT='P', ESTADO=1, PROCESO='PYG_CAPITADO', GENERA='Movimiento', PROCEDENCIA='FACTURA', REFERENCIA_PRO=@N_FACTURA, 
                      N_FACTURA=@N_FACTURA, F_FACTURAREF=DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), F_VENCE=DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 
                      FTR.CODUNG, FTR.CODPRG
               FROM   FTR
               WHERE  FTR.N_FACTURA = @N_FACTURA
            END
         END
      

      DROP TABLE #T
      DROP TABLE #D
   END

   IF COALESCE(DBO.FNK_VALORVARIABLE('IDIMPAUTOCREE'),'')<>''
   BEGIN
      SELECT @IMPAUTOCREE=LTRIM(RTRIM(COALESCE(DBO.FNK_VALORVARIABLE('IDIMPAUTOCREE'),'')))
      PRINT '@IMPAUTOCREE ='+@IMPAUTOCREE
      IF EXISTS(SELECT * FROM FIMP WHERE IDIMPUESTO=@IMPAUTOCREE)
      BEGIN
         SELECT @FACTORCREE=COALESCE(FIMPDV.VALOR,0)
         FROM FIMP INNER JOIN FIMPD ON FIMP.IDIMPUESTO=FIMPD.IDIMPUESTO
                   INNER JOIN FIMPDV ON FIMPD.IDCLASE=FIMPDV.IDCLASE AND  FIMPD.IDIMPUESTO=FIMPDV.IDIMPUESTO
         WHERE FIMP.IDIMPUESTO=@IMPAUTOCREE
         AND FIMPDV.FECHAINI<=GETDATE()
         AND FIMPDV.FECHAFIN+1>GETDATE()
         IF @FACTORCREE>0
         BEGIN
            PRINT 'AUTOR CREEE DEBITOS'
            PRINT '@FACTORCREE =='+LTRIM(RTRIM(STR(@FACTORCREE)))
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
                              REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                              CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                              CODUNG, CODPRG,VALOR_PORCIMP,BASE_IMP)
            SELECT NROCOMPROBANTE=@MAUX, COMPANIA=@COMPANIA, TIPO='DB',TTEC.CREEDB ,
                     FTR.IDTERCERO, '', DETALLE='AUTORRETENCION DE RENTA.'+@N_FACTURA+' '+@IMPAUTOCREE, VALOR=ROUND((VALORSERVICIOS*(@FACTORCREE/100)),2), 
                     REFERENCIA1=NULL, REFERENCIA2=NULL, ITEMREF=NULL, USUARIO=@USUARIO, FECHA=DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
                     NULL, '', IDPROVEEDOR = NULL,
                     CLASECONT='P', ESTADO=1, PROCESO='IMP_AUTOCREE', GENERA='Movimiento', PROCEDENCIA='FACTURA', REFERENCIA_PRO=@N_FACTURA, 
                     N_FACTURA=@N_FACTURA, F_FACTURAREF=DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), F_VENCE=DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 
                     FTR.CODUNG, FTR.CODPRG,@FACTORCREE,VALORSERVICIOS
            FROM   FTR INNER JOIN TTEC ON FTR.TIPOTTEC=TTEC.TIPO
            WHERE  FTR.N_FACTURA = @N_FACTURA
            PRINT 'AUTOCREE CREIDTOS'
            --doble
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, 
                              REFERENCIA1 ,REFERENCIA2 ,ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, IDPROVEEDOR,
                              CLASECONT, ESTADO, PROCESO, GENERA, PROCEDENCIA, REFERENCIA_PRO, N_FACTURA, F_FACTURAREF, F_VENCE,
                              CODUNG, CODPRG,VALOR_PORCIMP,BASE_IMP)
            SELECT NROCOMPROBANTE=@MAUX, COMPANIA=@COMPANIA, TIPO='CR',TTEC.CREECR ,
                     FTR.IDTERCERO, '', DETALLE='AUTORRENTENCION DE RENTA.'+@N_FACTURA+' '+@IMPAUTOCREE, VALOR=ROUND((VALORSERVICIOS*(@FACTORCREE/100)),0), 
                     REFERENCIA1=NULL, REFERENCIA2=NULL, ITEMREF=NULL, USUARIO=@USUARIO, FECHA=DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
                     NULL, '', IDPROVEEDOR = NULL,
                     CLASECONT='P', ESTADO=1, PROCESO='IMP_AUTOCREE', GENERA='Movimiento', PROCEDENCIA='FACTURA', REFERENCIA_PRO=@N_FACTURA, 
                     N_FACTURA=@N_FACTURA, F_FACTURAREF=DBO.FNK_FECHA_SIN_HORA(FTR.F_FACTURA), F_VENCE=DBO.FNK_FECHA_SIN_HORA(FTR.F_VENCE), 
                     FTR.CODUNG, FTR.CODPRG,@FACTORCREE,VALORSERVICIOS
            FROM   FTR INNER JOIN TTEC ON FTR.TIPOTTEC=TTEC.TIPO
            WHERE  FTR.N_FACTURA = @N_FACTURA

         END
      END
   END
   IF DBO.FNK_VALORVARIABLE('CUF_CPF_DE_SEDE') = 'SI' AND @PROCEDENCIA <> 'FINANCIERO'
   BEGIN 
	   UPDATE MCHE SET CODUNG = @CODUNG,CODPRG = @CODPRG WHERE  MCHE.COMPANIA=@COMPANIA AND MCHE.NROCOMPROBANTE = @MAUX
   END
    EXEC SPK_NC_SUMA_DBCR @MAUX

    DECLARE @DIFERENCIAJ DECIMAL(14,2)
    SELECT @DIFERENCIAJ = ABS(TOTALCREDITO-TOTALDEBITO) FROM MCPE WHERE NROCOMPROBANTE=@MAUX
    PRINT'DIFERENCIA ANTES DE AJUSTE CENTAVOS '+LTRIM(RTRIM(STR(@DIFERENCIAJ)))

   IF @DIFERENCIAJ>0 AND @DIFERENCIAJ <2.00
   BEGIN
	   PRINT 'SI ENTRO  A BALANCEO DE CENTAVOS...'
      EXEC SPK_NC_BALANCEO_CENTAVOS @MAUX
   END

   EXEC SPK_NC_REVISAMCPE @MAUX, @COMPANIA, @USUARIO, @SEDE, @SYS_COMPUTERNAME   
  
   IF EXISTS (SELECT * FROM MCP WHERE NROCOMPROBANTE=@MAUX AND COALESCE(ENVNIIF,0)=0 AND ESTADO=2)
   BEGIN
      PRINT 'ENVIO A NIIF'
      EXEC SPK_PASA_MCP_MCPNIIF @MAUX,@COMPANIA,@USUARIO,@SYS_COMPUTERNAME,@SEDE,@COM,''
   END
   IF DBO.FNK_VALORVARIABLE('IDTIPOCXP_DEFAULT') = 'COMER'
   BEGIN
      IF NOT EXISTS(SELECT * FROM FCXCD WHERE N_FACTURA=@N_FACTURA)
      BEGIN
		   SET @CNSCXC_AUT=SPACE(20)
		   EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@CXC',@CNSCXC_AUT OUTPUT
		   SELECT @CNSCXC_AUT = @SEDE + REPLACE(SPACE(8 - LEN(@CNSCXC_AUT))+LTRIM(RTRIM(@CNSCXC_AUT)),SPACE(1),0)
         SELECT @IDTERCERO=IDTERCERO,@FECHA=F_FACTURA,@VALORTOTAL=VR_TOTAL FROM FTR WHERE N_FACTURA=@N_FACTURA                      
		   EXEC SPK_ADMIN_CXC_CONTAB @CNSCXC_AUT,	@IDTERCERO,@N_FACTURA,@FECHA,	@FECHA,@USUARIO,'CXC GENERADA AUTOMATICAMENTE',@COMPANIA,'',@VALORTOTAL,'','','INSERT',	0,@CUENTA  	
      END
   END
   IF DBO.FNK_VALORVARIABLE('INGRE_ESTIMA_NIIF_AC')='SI' 
   BEGIN
      PRINT 'BUSCANDO PRESTACIONES ESTIMADAS'
      IF (SELECT PROCEDENCIA FROM FTR WHERE N_FACTURA=@N_FACTURA)='SALUD'
      BEGIN
         SELECT @NOADMISION=NOREFERENCIA FROM FTR WHERE N_FACTURA=@N_FACTURA
         IF EXISTS(SELECT * FROM HPRE INNER JOIN HPRED ON HPRE.NOPRESTACION=HPRE.NOPRESTACION 
                  WHERE HPRE.NOADMISION=@NOADMISION 
                  AND COALESCE(HPRE.CONTABNIIF,0)=1 
                  AND COALESCE(HPRE.NROCOMPROBANTENIIF,'')<>'')
         BEGIN
            DECLARE @NROCOMPROBANTENIIF VARCHAR(20)

            DECLARE PG_CURSOR CURSOR FOR  
            SELECT NROCOMPROBANTENIIF 
            FROM HPRE INNER JOIN HPRED ON HPRE.NOPRESTACION=HPRE.NOPRESTACION 
            WHERE HPRE.NOADMISION=@NOADMISION 
            AND COALESCE(HPRE.CONTABNIIF,0)=1   
            AND COALESCE(NROCOMPROBANTENIIF,'')<>'' 
	         OPEN PG_CURSOR    
	         FETCH NEXT FROM PG_CURSOR    
	         INTO @NROCOMPROBANTENIIF
	         WHILE @@FETCH_STATUS = 0    
	         BEGIN 
               EXEC SPK_REVERSA_INGRESO_ESTIMADONIIF @NOADMISION,@COMPANIA,@SEDE ,@USUARIO,@NROCOMPROBANTENIIF
	         FETCH NEXT FROM PG_CURSOR    
	         INTO @NROCOMPROBANTENIIF
	         END
	         CLOSE PG_CURSOR
	         DEALLOCATE PG_CURSOR           
         END
      END
   END
END

