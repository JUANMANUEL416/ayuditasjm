IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='SPK_RIPS_CE_F_CAP' AND XTYPE='P')
BEGIN
   DROP PROCEDURE SPK_RIPS_CE_F_CAP
END

GO
CREATE PROCEDURE DBO.SPK_RIPS_CE_F_CAP
@ENVIO       VARCHAR(6),
@IDTERCERO   VARCHAR(20),  
@FECINI      DATETIME,
@FECFIN      DATETIME,
@CODPREST    VARCHAR(12),
@RAZONSOCIAL VARCHAR(35), 
@TIPOID      VARCHAR(2),
@NUMID       VARCHAR(20),
@TIPOLLAMADO VARCHAR(2),
@IDPLAN      VARCHAR(6)= ''
WITH ENCRYPTION
AS 
DECLARE @COUNT_AC INT
DECLARE @COUNT_US INT
DECLARE @COUNT_AU INT
DECLARE @COUNT_AF INT
DECLARE @COUNT_AD INT
DECLARE @COUNT_AH INT
DECLARE @COUNT_AP INT
DECLARE @COUNT_AM INT
DECLARE @COUNT_AN INT
DECLARE @COUNT_AT INT
DECLARE @SUM INT
DECLARE @N_FACTURA  VARCHAR(20)
DECLARE @CNSFCT     VARCHAR(20)
DECLARE @IDAFILIADO VARCHAR(20)
DECLARE @ESTADO     VARCHAR(2)
DECLARE @DXSINHC    VARCHAR(20)
DECLARE @PGP        SMALLINT
DECLARE @PGPX       SMALLINT
DECLARE @ITEMRIPSD  INT
DECLARE @N_AC   INT
DECLARE @N_AP   INT
DECLARE @FORMATORIPS VARCHAR(20)
DECLARE @IPS VARCHAR(8)
BEGIN  
   PRINT '@IDTERCERO='+ @IDTERCERO
   PRINT '    @ENVIO='+ @ENVIO 

      SELECT @IPS=(CASE DATO WHEN  '825002525' THEN 'ALBA' ELSE DATO END) FROM USVGS WHERE IDVARIABLE='IDTERCEROINSTALADO'  
   
   SELECT @ESTADO=ESTADO FROM RIPS WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO
   DECLARE @ENVIAR_NOCOB_CE_RIPS VARCHAR(120) = DBO.FNK_VALORVARIABLE('ENVIAR_NOCOB_CE_RIPS')  
   DECLARE @RIPS_CITSOLOCUMPLIDA VARCHAR(120) = DBO.FNK_VALORVARIABLE('RIPS_CITSOLOCUMPLIDA')
   DECLARE @RIPS_AGRUPADOS VARCHAR(120) = DBO.FNK_VALORVARIABLE('RIPS_AGRUPADOS')
   DECLARE @PYM_EXTRAMURAL VARCHAR(120) = DBO.FNK_VALORVARIABLE('PYM_EXTRAMURAL')

   IF @ESTADO <> '01'
   BEGIN
      RAISERROR('ENVIO EN ESTADO DIFERENTE DE 01 ', 16,1)
      RETURN
   END

   IF EXISTS(SELECT * FROM PPT WHERE IDTERCERO=@IDTERCERO AND IDPLAN=@IDPLAN AND COALESCE(PGP,0)=1) 
   BEGIN
      SELECT @PGP=1,@PGPX=1
      IF EXISTS(SELECT * FROM PPT WHERE IDTERCERO=@IDTERCERO AND IDPLAN=@IDPLAN AND COALESCE(PGP,0)=1 AND COALESCE(RIPSPGP,'Evento')<>'Evento')
      BEGIN
         SELECT @PGP=0
      END
   END
   ELSE
   BEGIN
      SELECT @PGP=0
   END
   PRINT '@PGP='+STR(@PGP)
   SELECT @FORMATORIPS=TIPORIPS FROM PPT WHERE IDTERCERO=@IDTERCERO AND IDPLAN=@IDPLAN

   SELECT TOP 1 @N_FACTURA = N_FACTURA FROM RIPSD WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO AND PROCEDENCIA IN ('AUT','HADM','CIT')
   SELECT @CNSFCT = CNSFCT FROM FTR WHERE N_FACTURA = @N_FACTURA

   -- MODIFICADO R.JAY 2009.04.29 --JEDM 2015.03.10
   PRINT 'CREANDO US CE'
   INSERT INTO RRIPS_US ( ENVIO, IDTERCERO, TIPO_DOC, IDUSUARIO,CODENTIDADM,TIPOUSUARIO)
   SELECT DISTINCT @ENVIO, @IDTERCERO, LEFT(AFI.TIPO_DOC,2) AS TIPO_DOC, AFI.DOCIDAFILIADO,CODENTIDADM = LEFT(ISNULL(TER.IDALTERNA2,''),6),
   TIPOUSUARIO = CASE PLN.TIPOSISTEMA WHEN 'Contributivo' THEN '1' 
	                                                       WHEN 'Subsidiado'   THEN '2'
	                                                       WHEN 'Vinculado'    THEN '3'
	                                                       WHEN 'Particular'   THEN '4'
	                                                       WHEN 'Otro'         THEN '5'
	                                                       WHEN 'Prepagado'    THEN '5'
	                                                       WHEN 'Desplazado Vinc'   THEN '8'
	                                                       WHEN 'Desplazado Reg Cont' THEN '6'
	                                                       WHEN 'Desplazado Reg Subs' THEN '7'
	                                  END
   FROM   AUT INNER JOIN RIPSD ON RIPSD.NOADMISION  = AUT.IDAUT
	            LEFT  JOIN AFI   ON AUT.IDAFILIADO    = AFI.IDAFILIADO
               LEFT  JOIN TER   ON CASE COALESCE(AUT.IDTERCEROCA,'') WHEN '' THEN AUT.IDCONTRATANTE ELSE AUT.IDTERCEROCA END=TER.IDTERCERO
               LEFT  JOIN PLN   ON AUT.IDPLAN=PLN.IDPLAN
   WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO AND AUT.IDPLAN =CASE WHEN COALESCE(@IDPLAN,'')='' THEN  AUT.IDPLAN ELSE @IDPLAN END 
   AND    RIPSD.PROCEDENCIA = 'AUT'
   AND	  TER.IDTERCERO = @IDTERCERO  --OSOLANO 20230317 EN OCACIONES AUT.IDTERCEROCA<>AUT.IDCONTRTANTE Y DUBLICABA AFILIADO Y POR ENDE ERROR DE PRIMARYKEY

   PRINT 'CREANDO US CI'
   INSERT INTO RRIPS_US ( ENVIO, IDTERCERO, TIPO_DOC, IDUSUARIO,CODENTIDADM,TIPOUSUARIO)
   SELECT DISTINCT @ENVIO, @IDTERCERO, LEFT(AFI.TIPO_DOC,2) AS TIPO_DOC, AFI.DOCIDAFILIADO,CODENTIDADM = LEFT(ISNULL(TER.IDALTERNA2,''),6),
   TIPOUSUARIO = CASE PLN.TIPOSISTEMA WHEN 'Contributivo' THEN '1' 
	                                                       WHEN 'Subsidiado'   THEN '2'
	                                                       WHEN 'Vinculado'    THEN '3'
	                                                       WHEN 'Particular'   THEN '4'
	                                                       WHEN 'Otro'         THEN '5'
	                                                       WHEN 'Prepagado'    THEN '5'
	                                                       WHEN 'Desplazado Vinc'   THEN '8'
	                                                       WHEN 'Desplazado Reg Cont' THEN '6'
	                                                       WHEN 'Desplazado Reg Subs' THEN '7'
	                                  END
   FROM   CIT INNER JOIN RIPSD ON RIPSD.NOADMISION  = CIT.CONSECUTIVO
              LEFT  JOIN AFI   ON CIT.IDAFILIADO    = AFI.IDAFILIADO
              LEFT  JOIN TER   ON CIT.IDTERCEROCA   = TER.IDTERCERO
              LEFT  JOIN PLN   ON CIT.IDPLAN=PLN.IDPLAN
   WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO  
   AND    RIPSD.PROCEDENCIA IN('CIT','ONCO')
   AND NOT EXISTS (SELECT * FROM RRIPS_US U WHERE U.ENVIO = @ENVIO AND U.IDTERCERO=@IDTERCERO
                                           AND   U.TIPO_DOC  =  LEFT(AFI.TIPO_DOC,2)
                                            AND   U.IDUSUARIO =  AFI.DOCIDAFILIADO)
AND CIT.IDPLAN =CASE WHEN COALESCE(@IDPLAN,'')='' THEN  CIT.IDPLAN ELSE @IDPLAN END 
   UPDATE RRIPS_US SET PAPELLIDO = LEFT(REPLACE(AFI.PAPELLIDO,',',' '),30), 
	                    SAPELLIDO = LEFT(REPLACE(AFI.SAPELLIDO,',',' '),30), 
                       PNOMBRE   = LEFT(REPLACE(AFI.PNOMBRE,',',' '),20), 
                       SNOMBRE   = LEFT(REPLACE(AFI.SNOMBRE,',',' '),20), 
                       -- Se cambia comando DATEDIFF por que estaba aproximando la edad  STORRES
                       EDAD      =CASE  
	                                 WHEN DBO.FNK_EDAD_ARS(AFI.FNACIMIENTO, GETDATE(), 'D')<=0 THEN 1  
	                                 WHEN DBO.FNK_EDAD_ARS(AFI.FNACIMIENTO, GETDATE(), 'D')<=30 THEN DBO.FNK_EDAD_ARS(AFI.FNACIMIENTO, GETDATE(), 'D')
	                                 WHEN DBO.FNK_EDAD_ARS(AFI.FNACIMIENTO, GETDATE(), 'D')<=365 THEN 
		                                 CASE	WHEN DBO.FNK_EDAD_ARS(AFI.FNACIMIENTO, GETDATE(), 'M')  = 12 THEN 1
				                                 ELSE DBO.FNK_EDAD_ARS(AFI.FNACIMIENTO, GETDATE(), 'M')
		                                 END
	                                 WHEN DBO.FNK_EDAD_ARS(AFI.FNACIMIENTO, GETDATE(), 'D')<=54750 THEN DBO.FNK_EDAD_ARS(AFI.FNACIMIENTO, GETDATE(), 'A')
                                 END, 
                       UNMEDIDA  =CASE
	                                 WHEN DBO.FNK_EDAD_ARS(AFI.FNACIMIENTO, GETDATE(), 'D')<=30 THEN '3'
	                                 WHEN DBO.FNK_EDAD_ARS(AFI.FNACIMIENTO, GETDATE(), 'D')<=365 THEN
		                                 CASE	WHEN DBO.FNK_EDAD_ARS(AFI.FNACIMIENTO, GETDATE(), 'M') = 12 THEN '1'
				                                 ELSE '2'
		                                 END
	                                 WHEN DBO.FNK_EDAD_ARS(AFI.FNACIMIENTO, GETDATE(), 'D')<=54750 THEN '1'
                                 END, 
                         -- Se cambia comando funcion FNK_EDAD_ARS para sacar edad correcta  STORRES
                       SEXO         = CASE WHEN AFI.SEXO ='FEMENINO' THEN 'F' ELSE 'M' END, 
                       DEPHABITUAL  = LEFT(AFI.CIUDAD,2), 
	                    MUNHABITUAL  = SUBSTRING(AFI.CIUDAD,3,3), 
                       ZONAHABITUAL = CASE WHEN AFI.ZONA='R' THEN 'R' ELSE 'U' END, 
                       TIPOAFILIADO = left(AFI.TIPOAFILIADO,1)
   FROM   RRIPS_US INNER JOIN AFI ON RRIPS_US.TIPO_DOC    = AFI.TIPO_DOC
                                 AND RRIPS_US.IDUSUARIO   = AFI.DOCIDAFILIADO
   WHERE  RRIPS_US.ENVIO = @ENVIO  AND RRIPS_US.IDTERCERO=@IDTERCERO

   PRINT 'CREANDO AC CE'
   INSERT INTO RRIPS_AC(ENVIO,IDTERCERO,ESTADO,NUMFACTURA,IDPRESTADOR,TIPO_DOC,IDUSUARIO,
                        FECHACONSULTA,NUMAUT,IDCONSULTA,FINCONSULTA,CAUSAEXT,IDDXPPAL,
                        IDDXREL1,IDDXREL2,IDDXREL3,TIPODX,VALORCONSULTA,VALORCUOTAM,
                        VALORNETO, NOPRESTACION, NOITEM, CNSFTR, N_CUOTA, CANTIDAD,
                        PROCEDENCIA, IDDX, IDSERVICIO, CODEVAL)
	SELECT RIPSD.ENVIO, RIPSD.IDTERCERO, 'I',CASE WHEN @PGP=0 THEN  @N_FACTURA ELSE 'AC'+REPLACE(LTRIM(REPLACE(@ENVIO,'0',' ')),' ','0')+DBO.FNK_NROCONCEROS_IZQUIERDA(ROW_NUMBER() OVER (ORDER BY @ENVIO),4,'') END, @CODPREST,
			 LEFT(AFI.TIPO_DOC,2),  
			 LEFT(REPLACE(AFI.DOCIDAFILIADO,'.',''),20), AUT.FECHA, CASE WHEN ISNULL(AUT.NUMAUTORIZA,'') = '' THEN LEFT(AUTD.NOAUTORIZEXT,15) ELSE ISNULL(LEFT(AUT.NUMAUTORIZA,15),'') END,             
			 LEFT(REPLACE(SER.IDALTERNA,'-',''),8),
			 LEFT(CASE
					WHEN ( SELECT TOP 1 LEFT(HCAD.ALFANUMERICO,2)									-- B001. PORSALUD R.JAY 2009.05.21
                      FROM   HCA	LEFT JOIN MDX  ON HCA.IDDX = MDX.IDDX
                                 LEFT JOIN MPL  ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
                                 LEFT JOIN HCAD ON HCA.CONSECUTIVO = HCAD.CONSECUTIVO AND HCAD.CAMPO = 'FINALIDAD'
                      WHERE  HCA.IDAFILIADO = AUT.IDAFILIADO AND MPL.AMBITO = 'CE' 
                      AND    CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,AUT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0) IS NOT NULL
					THEN ( SELECT TOP 1 LEFT(HCAD.ALFANUMERICO,2)
                      FROM   HCA	LEFT JOIN MDX  ON HCA.IDDX = MDX.IDDX
                                 LEFT JOIN MPL  ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
                                 LEFT JOIN HCAD ON HCA.CONSECUTIVO = HCAD.CONSECUTIVO AND HCAD.CAMPO = 'FINALIDAD'
                      WHERE  HCA.IDAFILIADO = AUT.IDAFILIADO AND MPL.AMBITO = 'CE'
                      AND    CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,AUT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0)	-- F001. PORSALUD R.JAY 2009.05.21
					WHEN AUT.FINALIDAD IS NULL OR AUT.FINALIDAD = '' THEN '10' 
					ELSE
                  CASE
                     WHEN LEN(AUT.FINALIDAD) = 1 THEN '0'+AUT.FINALIDAD
                     ELSE AUT.FINALIDAD
                  END 
               END,2),CASE WHEN AUT.IDPESPECIAL= @PYM_EXTRAMURAL THEN '16' ELSE  AUT.IDCAUSAEXT END CAUSAEXT ,
          LEFT(CASE 
             -- WHEN SER.IDALTERNA = '890303' THEN 'Z012' -- PORSALUD R.JAY 2009.03.31
             -- WHEN SER.IDALTERNA = '890203' THEN 'Z012' -- PORSALUD R.JAY 2009.03.31
             WHEN (	SELECT TOP 1 MDX.IDDX 
                     FROM   HCA	LEFT JOIN MDX ON HCA.IDDX = MDX.IDDX
                                 LEFT JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
                     WHERE  HCA.IDAFILIADO = AUT.IDAFILIADO AND MPL.AMBITO = 'CE'
                     AND    CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,AUT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0) IS NULL
             THEN
                CASE ISNULL(AUT.DXPPAL,'')
                   WHEN '' THEN 'Z000'
                   ELSE AUT.DXPPAL
                END
				 ELSE 
                LEFT(( SELECT TOP 1 MDX.IDDX 
                       FROM   HCA LEFT JOIN MDX ON HCA.IDDX = MDX.IDDX
                                  LEFT JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
                       WHERE  HCA.IDAFILIADO = AUT.IDAFILIADO AND MPL.AMBITO = 'CE'
                       AND    CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,AUT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0),4)
			 END,4),
			 LEFT(CASE 
             --WHEN SER.IDALTERNA = '890303' THEN '' -- PORSALUD R.JAY 2009.03.31
             --WHEN SER.IDALTERNA = '890203' THEN '' -- PORSALUD R.JAY 2009.03.31
             WHEN (	SELECT TOP 1 MDX.IDDX 
                     FROM   HCA LEFT JOIN MDX ON HCA.DX1 = MDX.IDDX
                                LEFT JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
                     WHERE  HCA.IDAFILIADO = AUT.IDAFILIADO AND MPL.AMBITO = 'CE'
                     AND    CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,AUT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0) IS NULL
             THEN ISNULL(AUT.DXRELACIONADO,'')
             ELSE
             LEFT(( SELECT TOP 1 MDX.IDDX 
                    FROM   HCA	LEFT JOIN MDX ON HCA.DX1 = MDX.IDDX
                                 LEFT JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
                    WHERE  HCA.IDAFILIADO = AUT.IDAFILIADO AND MPL.AMBITO = 'CE'
                    AND     CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,AUT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0),4)
          END,4),
			 LEFT(CASE 
             --WHEN SER.IDALTERNA = '890303' THEN '' -- PORSALUD R.JAY 2009.03.31
             --WHEN SER.IDALTERNA = '890203' THEN '' -- PORSALUD R.JAY 2009.03.31
             WHEN (	SELECT TOP 1 MDX.IDDX 
                     FROM   HCA LEFT JOIN MDX ON HCA.DX2 = MDX.IDDX
                                LEFT JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
                     WHERE  HCA.IDAFILIADO = AUT.IDAFILIADO AND MPL.AMBITO = 'CE'
                     AND   CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,AUT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0) IS NULL
				 THEN ISNULL(AUT.DXRELACIONADO,'')
				 ELSE
				 LEFT(( SELECT TOP 1 MDX.IDDX 
				        FROM   HCA LEFT JOIN MDX ON HCA.DX2 = MDX.IDDX
                               LEFT JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
						  WHERE  HCA.IDAFILIADO = AUT.IDAFILIADO AND MPL.AMBITO = 'CE'
                    AND    CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,AUT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0),4)
			 END,4),
			LEFT(CASE 
            --WHEN SER.IDALTERNA = '890303' THEN '' -- PORSALUD R.JAY 2009.03.31
            --WHEN SER.IDALTERNA = '890203' THEN '' -- PORSALUD R.JAY 2009.03.31
            WHEN (SELECT TOP 1 MDX.IDDX 
						FROM   HCA	LEFT JOIN MDX ON HCA.DX3 = MDX.IDDX
									LEFT JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
						WHERE  HCA.IDAFILIADO = AUT.IDAFILIADO AND MPL.AMBITO = 'CE'
						AND CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,AUT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0) IS NULL
				THEN ISNULL(AUT.DXRELACIONADO,'')
				ELSE
				LEFT((	SELECT TOP 1 MDX.IDDX 
						FROM   HCA	LEFT JOIN MDX ON HCA.DX3 = MDX.IDDX
									LEFT JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
						WHERE  HCA.IDAFILIADO = AUT.IDAFILIADO AND MPL.AMBITO = 'CE'
						AND CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,AUT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0),4)
		END,4),
		CASE 
			WHEN (	SELECT TOP 1 TIPODX
					FROM HCA LEFT JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
					WHERE HCA.IDAFILIADO = AUT.IDAFILIADO AND MPL.AMBITO='CE' AND COALESCE(HCA.ANULADA,0)=0) IS NULL
			THEN 1
			ELSE
				(	SELECT	TOP 1 
							CASE TIPODX 
								WHEN 'Presuntivo'   THEN 1
								WHEN 'Impresion dx' THEN 1
								WHEN 'Definitivo'   THEN 2
								WHEN 'Conf Nuevo'   THEN 2
								WHEN 'Conf Repet'   THEN 3
								ELSE 1
							END
					FROM HCA LEFT JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
					WHERE HCA.IDAFILIADO = AUT.IDAFILIADO AND MPL.AMBITO='CE' AND COALESCE(HCA.ANULADA,0)=0)
		END,
		AUTD.VALOR, AUTD.VALORCOPAGO,
		CASE ISNULL((AUTD.VALOR * AUTD.CANTIDAD),0)
			WHEN 0 THEN (AUTD.VALOR * AUTD.CANTIDAD) - AUTD.VALORCOPAGO
			ELSE (AUTD.VALOR * AUTD.CANTIDAD) 
		END,
		AUT.NOAUT, AUTD.NO_ITEM, ISNULL(@CNSFCT,'EXTERNO'), 1, AUTD.CANTIDAD, 'CE', AUT.DXPPAL, 
		SER.IDSERVICIO, 'CODEVAL'
		FROM   AUTD INNER JOIN AUT     ON AUTD.IDAUT             = AUT.IDAUT     
					INNER JOIN RIPSD   ON RIPSD.NOADMISION       = AUT.IDAUT
					INNER JOIN AFI     ON AUT.IDAFILIADO         = AFI.IDAFILIADO
					LEFT  JOIN SER     ON SER.IDSERVICIO         = AUTD.IDSERVICIO 
					LEFT  JOIN RIPS_CP ON RIPS_CP.IDCONCEPTORIPS = SER.CODIGORIPS 
		WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO AND AUT.IDPLAN =CASE WHEN COALESCE(@IDPLAN,'')='' THEN  AUT.IDPLAN ELSE @IDPLAN END 
		AND    RIPS_CP.ARCHIVO   = 'AC' 
		AND    RIPSD.PROCEDENCIA = 'AUT'
      AND    AUTD.NOCOBRABLE= CASE WHEN @ENVIAR_NOCOB_CE_RIPS = 'NO' THEN 0 ELSE AUTD.NOCOBRABLE END
   PRINT 'SE CREARON EN AC CE ' + CONVERT(VARCHAR,@@ROWCOUNT) + ' ITEMS'

   SELECT @N_AC=COUNT(*) FROM RRIPS_AC WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO
		SELECT HCA.FECHA, HCA.NOADMISION, HCA.IDAFILIADO, HCA.CONSECUTIVO,HCA.IDDX DXPPAL, 
		CASE COALESCE([1],'') WHEN '' THEN HCA.DX1 ELSE COALESCE([1],'') END DX1,
		CASE COALESCE([2],'') WHEN '' THEN HCA.DX2 ELSE COALESCE([2],'') END DX2,
		CASE COALESCE([3],'') WHEN '' THEN HCA.DX3 ELSE COALESCE([3],'') END DX3 INTO #DX
		FROM HCA LEFT JOIN (
							SELECT *
							FROM (
								SELECT * FROM (select HCADX.CONSECUTIVO, ROW_NUMBER() over (partition by HCADX.CONSECUTIVO order by tipo) AS ITEMDX,	 HCADX.IDDX
											   from HCADX  INNER JOIN HCA ON HCA.CONSECUTIVO=HCADX.CONSECUTIVO
											   WHERE HCA.PROCEDENCIA='IPS' and HCA.CLASE='HC' ) HCADX
								WHERE ITEMDX IN (1,2,3)
								) Z 
							PIVOT
							(
							MAX(Z.IDDX )
							FOR ITEMDX IN ([1],[2],[3])
							) AS P ) P  ON HCA.CONSECUTIVO=P.CONSECUTIVO
			   INNER  JOIN CIT			ON HCA.IDAFILIADO = CIT.IDAFILIADO AND  HCA.NOADMISION=CIT.CONSECUTIVO AND CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0
			   INNER JOIN RIPSD			ON RIPSD.NOADMISION = CIT.CONSECUTIVO
			   LEFT  JOIN SER			ON SER.IDSERVICIO         = CIT.IDSERVICIO 
			   LEFT  JOIN RIPS_CP		ON RIPS_CP.IDCONCEPTORIPS = SER.CODIGORIPS 

		WHERE RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
			AND    RIPS_CP.ARCHIVO   = 'AC' 
			AND    RIPSD.PROCEDENCIA IN('CIT','ONCO')
			AND    CIT.CUMPLIDA = CASE @RIPS_CITSOLOCUMPLIDA WHEN 'SI' THEN 1 ELSE CUMPLIDA END
AND CIT.IDPLAN =CASE WHEN COALESCE(@IDPLAN,'')='' THEN  CIT.IDPLAN ELSE @IDPLAN END 
   SELECT @DXSINHC = LEFT(DBO.FNK_VALORVARIABLE('RIPS_DX_CITA_SIN_HC'),4)

	PRINT 'CREANDO AC CIT' -- MODIFICADO 2009.04.06 R.JAY
	INSERT INTO RRIPS_AC( ENVIO, IDTERCERO, ESTADO, NUMFACTURA,   IDPRESTADOR, TIPO_DOC,    IDUSUARIO,
							    FECHACONSULTA, NUMAUT,       IDCONSULTA,  FINCONSULTA, CAUSAEXT,      IDDXPPAL,
							    IDDXREL1,      IDDXREL2,     IDDXREL3,    TIPODX,      VALORCONSULTA, VALORCUOTAM,
							    VALORNETO,     NOPRESTACION, NOITEM,      CNSFTR,      N_CUOTA,       CANTIDAD,
							    PROCEDENCIA, IDDX, IDSERVICIO, CODEVAL)
SELECT @ENVIO, @IDTERCERO, 'I', CASE WHEN @PGP=0 THEN  ISNULL(RIPSD.N_FACTURA,'') ELSE 'AC'+REPLACE(LTRIM(REPLACE(@ENVIO,'0',' ')),' ','0')+DBO.FNK_NROCONCEROS_IZQUIERDA(ROW_NUMBER() OVER (ORDER BY @ENVIO)+@N_AC,4,'') END, @CODPREST,
			 LEFT(AFI.TIPO_DOC,2),  
			 LEFT(REPLACE(AFI.DOCIDAFILIADO,'.',''),20), CIT.FECHA, LEFT(CIT.NOAUTORIZACION,15), 
			 LEFT(REPLACE(SER.IDALTERNA,'-',''),8),  
			 LEFT(CASE
					 WHEN (SELECT TOP 1 LEFT(HCAD.ALFANUMERICO,2)								-- B002. PORSALUD R.JAY 2009.05.21
								FROM   HCA	LEFT JOIN MDX  ON HCA.IDDX = MDX.IDDX
											LEFT JOIN MPL  ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
											LEFT JOIN HCAD ON HCA.CONSECUTIVO = HCAD.CONSECUTIVO AND HCAD.CAMPO = 'FINALIDAD'
								WHERE  HCA.IDAFILIADO = CIT.IDAFILIADO AND MPL.AMBITO = 'CE'
								AND CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0) IS NOT NULL
						THEN CASE WHEN COALESCE (MPE.IDPESPECIAL,'')<>'' AND COALESCE (MPE.FINALIDAD,'')<>'' 
                            THEN COALESCE (MPE.FINALIDAD,'')  ELSE (	SELECT TOP 1 LEFT(HCAD.ALFANUMERICO,2)
								                                                FROM   HCA	LEFT JOIN MDX  ON HCA.IDDX = MDX.IDDX
											                                                LEFT JOIN MPL  ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
											                                                LEFT JOIN HCAD ON HCA.CONSECUTIVO = HCAD.CONSECUTIVO AND HCAD.CAMPO = 'FINALIDAD'
								                                                WHERE  HCA.IDAFILIADO = CIT.IDAFILIADO AND MPL.AMBITO = 'CE'
								                                                AND CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0) END -- F002. PORSALUD R.JAY 2009.05.21
					 WHEN  COALESCE (CIT.FINCONSULTA,'')='' THEN CASE WHEN COALESCE (MPE.IDPESPECIAL,'')<>'' AND COALESCE (MPE.FINALIDAD,'')<>'' 
                                                                                           THEN COALESCE (MPE.FINALIDAD,'')  ELSE '10' END
						ELSE CIT.FINCONSULTA
					END,2),CASE WHEN CIT.IDPESPECIAL=@PYM_EXTRAMURAL THEN '16' ELSE  '13' END CAUSEXT,
               --DXPPAL
			LEFT(CASE 
				-- WHEN SER.IDALTERNA = '890303' THEN 'Z012' -- PORSALUD R.JAY 2009.03.31
				-- WHEN SER.IDALTERNA = '890203' THEN 'Z012' -- PORSALUD R.JAY 2009.03.31
				      WHEN COALESCE ((SELECT TOP 1 MDX.IDDX 
						       FROM  #DX HCA	LEFT JOIN MDX ON HCA.DXPPAL = MDX.IDDX
						       WHERE  HCA.IDAFILIADO = CIT.IDAFILIADO AND  HCA.NOADMISION=CIT.CONSECUTIVO 
						       AND    CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102)),'')=''
						 
				      THEN
					      CASE ISNULL(CIT.IDDX,'')
						        WHEN '' THEN ( CASE WHEN COALESCE ((SELECT TOP 1 AUT.DXPPAL
                                                     FROM   AUT 
                                                     WHERE  AUT.IDAFILIADO = CIT.IDAFILIADO
                                                     AND    CONVERT(VARCHAR,AUT.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102)
                                                     AND    CIT.IDMEDICO = AUT.IDSOLICITANTE ),'')=''
                                               THEN  @DXSINHC
                                               ELSE  (SELECT TOP 1 AUT.DXPPAL
                                                      FROM   AUT 
                                                      WHERE  AUT.IDAFILIADO = CIT.IDAFILIADO
                                                      AND    CONVERT(VARCHAR,AUT.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102)
                                                      AND    CIT.IDMEDICO = AUT.IDSOLICITANTE )
                                          END )                  
						        ELSE CIT.IDDX
					      END
				      ELSE 
				      LEFT((SELECT TOP 1 MDX.IDDX 
						      FROM   #DX HCA	LEFT JOIN MDX ON HCA.DXPPAL = MDX.IDDX
                       WHERE  HCA.IDAFILIADO = CIT.IDAFILIADO AND HCA.NOADMISION=CIT.CONSECUTIVO 
						      AND CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102) ),4)
			      END,4),
               --DXREL1
			LEFT(COALESCE((SELECT TOP 1 MDX.IDDX FROM #DX HCA LEFT JOIN MDX ON HCA.DX1 = MDX.IDDX
						WHERE  HCA.IDAFILIADO = CIT.IDAFILIADO  AND HCA.NOADMISION=CIT.CONSECUTIVO 
						AND CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102) ),''),4),
         --DXREL2
			LEFT(COALESCE((SELECT TOP 1 MDX.IDDX FROM #DX HCA LEFT JOIN MDX ON HCA.DX2 = MDX.IDDX
						WHERE  HCA.IDAFILIADO = CIT.IDAFILIADO  AND HCA.NOADMISION=CIT.CONSECUTIVO 
						AND CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102) ),''),4),
         --DXREL3
			LEFT(COALESCE((SELECT TOP 1 MDX.IDDX FROM #DX HCA LEFT JOIN MDX ON HCA.DX3 = MDX.IDDX
						WHERE  HCA.IDAFILIADO = CIT.IDAFILIADO  AND HCA.NOADMISION=CIT.CONSECUTIVO 
						AND CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102) ),''),4),
         --TIPODX
			CASE	WHEN COALESCE((SELECT TOP 1 TIPODX
							         FROM HCA LEFT JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
							         WHERE HCA.IDAFILIADO = CIT.IDAFILIADO AND HCA.NOADMISION=CIT.CONSECUTIVO  AND MPL.AMBITO='CE' AND COALESCE(HCA.ANULADA,0)=0),'')=''
					THEN 1
					ELSE (SELECT TOP 1 
								CASE TIPODX 
									WHEN 'Presuntivo'   THEN 1
									WHEN 'Impresion dx' THEN 1
									WHEN 'Definitivo'   THEN 2
									WHEN 'Conf Nuevo'   THEN 2
									WHEN 'Conf Repet'   THEN 3
									ELSE 1
								END
							FROM HCA LEFT JOIN  MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
							WHERE HCA.IDAFILIADO = CIT.IDAFILIADO AND HCA.NOADMISION=CIT.CONSECUTIVO AND  MPL.AMBITO='CE' AND COALESCE(HCA.ANULADA,0)=0)
			END, 
			ISNULL(CIT.VALORTOTAL,0), ISNULL(CIT.VALORCOPAGO,0),
			ISNULL(CIT.VALORTOTAL,0) - ISNULL(CIT.VALORCOPAGO,0),
			CIT.CONSECUTIVO, NULL, ISNULL(@CNSFCT,'EXTERNO'), 1, 1, 'CI', CIT.IDDX, SER.IDSERVICIO, 'CODEVAL'
	FROM   CIT	INNER JOIN RIPSD   ON RIPSD.NOADMISION       = CIT.CONSECUTIVO
				   INNER JOIN AFI     ON CIT.IDAFILIADO         = AFI.IDAFILIADO
				   LEFT  JOIN SER     ON SER.IDSERVICIO         = CIT.IDSERVICIO 
			   	LEFT  JOIN RIPS_CP ON RIPS_CP.IDCONCEPTORIPS = SER.CODIGORIPS 
               LEFT  JOIN MPE     ON MPE.IDPESPECIAL=CIT.IDPESPECIAL 
	WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
	AND    RIPS_CP.ARCHIVO   = 'AC' 
	AND    RIPSD.PROCEDENCIA  IN('CIT','ONCO')
	AND    CIT.CUMPLIDA =	 CASE @RIPS_CITSOLOCUMPLIDA WHEN 'SI' THEN 1 ELSE CUMPLIDA END AND CIT.IDPLAN =CASE WHEN COALESCE(@IDPLAN,'')='' THEN  CIT.IDPLAN ELSE @IDPLAN END 
	PRINT 'SE CREARON EN AC CIT ' + CONVERT(VARCHAR,@@ROWCOUNT) + ' ITEMS'

   PRINT 'CREANDO AP CIT'
   INSERT INTO RRIPS_AP(ENVIO,IDTERCERO,ESTADO,NUMFACTURA,IDPRESTADOR,TIPO_DOC,IDUSUARIO,FECHAPROCEDIMIENTO,
                        NUMAUT,IDPROCEDIMIENTO,AMBITO,FINPROCEDIMIENTO,PERSONALA,DXPPAL,DXREL,
                        COMPLICACION,ACTOQ, VALORPROCED, NOPRESTACION, NOITEM, CNSFTR, N_CUOTA, 
                        CANTIDAD, PROCEDENCIA, IDDX, IDSERVICIO, CODEVAL)
   SELECT @ENVIO, @IDTERCERO, 'I', CASE WHEN @PGP=0 THEN  @N_FACTURA ELSE 'AP'+REPLACE(LTRIM(REPLACE(@ENVIO,'0',' ')),' ','0')+DBO.FNK_NROCONCEROS_IZQUIERDA(ROW_NUMBER() OVER (ORDER BY @ENVIO),4,'') END, @CODPREST, 
          LEFT(AFI.TIPO_DOC,2),          
          REPLACE(AFI.DOCIDAFILIADO,'.',''),  CIT.FECHA, ISNULL(LEFT(CIT.NOAUTORIZACION,15),''),  
          LEFT(REPLACE(SER.IDALTERNA,'-',''),8), CASE WHEN CIT.IDPESPECIAL=@PYM_EXTRAMURAL THEN '4' ELSE  '1' END AMBITO,'1','',
		LEFT(CASE 
				-- WHEN SER.IDALTERNA = '890303' THEN 'Z012' -- PORSALUD R.JAY 2009.03.31
				-- WHEN SER.IDALTERNA = '890203' THEN 'Z012' -- PORSALUD R.JAY 2009.03.31
				      WHEN COALESCE ((SELECT TOP 1 MDX.IDDX 
						       FROM   HCA	LEFT JOIN MDX ON HCA.IDDX = MDX.IDDX
								            LEFT JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
						       WHERE  HCA.IDAFILIADO = CIT.IDAFILIADO AND  HCA.NOADMISION=CIT.CONSECUTIVO AND MPL.AMBITO = 'CE'
						       AND    CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0),'')=''
						 
				      THEN
					      CASE ISNULL(CIT.IDDX,'')
						        WHEN '' THEN ( CASE WHEN COALESCE ((SELECT TOP 1 AUT.DXPPAL
                                                     FROM   AUT 
                                                     WHERE  AUT.IDAFILIADO = CIT.IDAFILIADO
                                                     AND    CONVERT(VARCHAR,AUT.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102)
                                                     AND    CIT.IDMEDICO = AUT.IDSOLICITANTE ),'')=''
                                               THEN  @DXSINHC
                                               ELSE  (SELECT TOP 1 AUT.DXPPAL
                                                      FROM   AUT 
                                                      WHERE  AUT.IDAFILIADO = CIT.IDAFILIADO
                                                      AND    CONVERT(VARCHAR,AUT.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102)
                                                      AND    CIT.IDMEDICO = AUT.IDSOLICITANTE )
                                          END )                  
						        ELSE CIT.IDDX
					      END
				      ELSE 
				      LEFT((SELECT TOP 1 MDX.IDDX 
						      FROM   HCA	LEFT JOIN MDX ON HCA.IDDX = MDX.IDDX
									         LEFT JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
                       WHERE  HCA.IDAFILIADO = CIT.IDAFILIADO AND HCA.NOADMISION=CIT.CONSECUTIVO AND MPL.AMBITO = 'CE'
						      AND CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0),4)
			      END,4),
               --DXREL1
			left(CASE 
				--WHEN SER.IDALTERNA = '890303' THEN 'Z012' -- PORSALUD R.JAY 2009.03.31
				--WHEN SER.IDALTERNA = '890203' THEN 'Z012' -- PORSALUD R.JAY 2009.03.31
				WHEN COALESCE ((	SELECT TOP 1 MDX.IDDX 
						FROM   HCA	LEFT JOIN MDX ON HCA.DX1 = MDX.IDDX
									LEFT JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
						WHERE  HCA.IDAFILIADO = CIT.IDAFILIADO  AND HCA.NOADMISION=CIT.CONSECUTIVO AND MPL.AMBITO = 'CE'
						AND CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102)AND COALESCE(HCA.ANULADA,0)=0),'')=''
				THEN ISNULL(CIT.IDDX,'')
				ELSE 
				LEFT((	SELECT TOP 1 MDX.IDDX 
						FROM   HCA	LEFT JOIN MDX ON HCA.DX1 = MDX.IDDX
									LEFT JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
						WHERE  HCA.IDAFILIADO = CIT.IDAFILIADO AND HCA.NOADMISION=CIT.CONSECUTIVO AND MPL.AMBITO = 'CE'
						AND CONVERT(VARCHAR,HCA.FECHA,102) = CONVERT(VARCHAR,CIT.FECHA,102) AND COALESCE(HCA.ANULADA,0)=0),4)
			END,4),''AS COMPICACION,'' AS ACTOQ,COALESCE(CIT.VALORTOTAL,0),CIT.CONSECUTIVO,1, ISNULL(@CNSFCT,'EXTERNO'), 1,1, 'CI', 
        '', SER.IDSERVICIO, 'CODEVAL' 
	FROM   CIT	INNER JOIN RIPSD   ON RIPSD.NOADMISION       = CIT.CONSECUTIVO
				INNER JOIN AFI     ON CIT.IDAFILIADO         = AFI.IDAFILIADO
				LEFT  JOIN SER     ON SER.IDSERVICIO         = CIT.IDSERVICIO 
			   	LEFT  JOIN RIPS_CP ON RIPS_CP.IDCONCEPTORIPS = SER.CODIGORIPS 
                LEFT  JOIN MPE     ON MPE.IDPESPECIAL=CIT.IDPESPECIAL 
	WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
	AND    RIPS_CP.ARCHIVO   = 'AP' 
	AND    RIPSD.PROCEDENCIA IN('CIT','ONCO')
	AND    CIT.CUMPLIDA = CASE @RIPS_CITSOLOCUMPLIDA WHEN 'SI' THEN 1 ELSE CUMPLIDA END 
	AND CIT.IDPLAN =CASE WHEN COALESCE(@IDPLAN,'')='' THEN  CIT.IDPLAN ELSE @IDPLAN END 
    PRINT 'SE CREARON EN AP CE ' + CONVERT(VARCHAR,@@ROWCOUNT) + ' ITEMS'


    SELECT @N_AP=COUNT(*) FROM RRIPS_AP WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO

   PRINT 'CREANDO AP CE'
   INSERT INTO RRIPS_AP(ENVIO,IDTERCERO,ESTADO,NUMFACTURA,IDPRESTADOR,TIPO_DOC,IDUSUARIO,FECHAPROCEDIMIENTO,
                        NUMAUT,IDPROCEDIMIENTO,AMBITO,FINPROCEDIMIENTO,PERSONALA,DXPPAL,DXREL,
                        COMPLICACION,ACTOQ, VALORPROCED, NOPRESTACION, NOITEM, CNSFTR, N_CUOTA, 
                        CANTIDAD, PROCEDENCIA, IDDX, IDSERVICIO, CODEVAL)
   SELECT @ENVIO, @IDTERCERO, 'I', CASE WHEN @PGP=0 THEN  @N_FACTURA ELSE 'AP'+REPLACE(LTRIM(REPLACE(@ENVIO,'0',' ')),' ','0')+DBO.FNK_NROCONCEROS_IZQUIERDA(ROW_NUMBER() OVER (ORDER BY @ENVIO)+@N_AP,4,'') END, @CODPREST, 
          LEFT(AFI.TIPO_DOC,2),          
          REPLACE(AFI.DOCIDAFILIADO,'.',''),  AUT.FECHA, 
		  LEFT(CASE  ISNULL(AUTD.NOAUTORIZEXT,'') WHEN '' THEN  ISNULL(AUT.NUMAUTORIZA,'') ELSE  ISNULL(AUTD.NOAUTORIZEXT,'') END,15),  
          LEFT(REPLACE(SER.IDALTERNA,'-',''),8),  
          CASE WHEN AUT.IDPESPECIAL=@PYM_EXTRAMURAL THEN '4' ELSE  CASE WHEN NOT AUT.AMBITO IN ('1','2','3') THEN '1' ELSE LEFT(AUT.AMBITO,1) END END ,  
          LEFT(CASE WHEN AUT.FINALIDAD IS NULL OR AUT.FINALIDAD='' THEN '5' 
					WHEN LEFT(AUT.AMBITO,1)='4' OR AUT.IDPESPECIAL=@PYM_EXTRAMURAL THEN '4' ELSE AUT.FINALIDAD END,1) ,
          CASE WHEN AUT.PERSONAL_AT='' OR AUT.PERSONAL_AT IS NULL THEN '5' ELSE LEFT(AUT.PERSONAL_AT,1) END,  
          LEFT(CASE WHEN DBO.FNK_VALORVARIABLE('AUTSINHC') = 'SI'
          THEN
             LEFT(AUT.DXPPAL,4)    
          ELSE     
             CASE WHEN SER.CODIGORIPS = DBO.FNK_ValorVariable('IDPROTERQXRIPS')
                     THEN 
                        (CASE 
                            WHEN (SELECT TOP 1 MDX.IDDX FROM HCA LEFT JOIN MDX ON HCA.IDDX=MDX.IDDX 
                                  WHERE HCA.CONSECUTIVO=AUT.CONSECUTIVOHCA AND COALESCE(HCA.ANULADA,0)=0) IS NULL
                            THEN ISNULL(AUT.DXPPAL,'')
                            ELSE LEFT((SELECT TOP 1 MDX.IDDX FROM HCA LEFT JOIN MDX ON HCA.IDDX=MDX.IDDX 
                                 WHERE HCA.CONSECUTIVO=AUT.CONSECUTIVOHCA AND COALESCE(HCA.ANULADA,0)=0),4)
                         END)
                     ELSE ISNULL(AUT.DXPPAL,'')
           END
        END,4) ,
        LEFT(CASE WHEN SER.CODIGORIPS = DBO.FNK_ValorVariable('IDPROTERQXRIPS')
                  THEN 
                   (CASE 
                   WHEN (SELECT TOP 1 MDX.IDDX FROM HCA LEFT JOIN MDX ON HCA.DX1=MDX.IDDX 
                         WHERE HCA.CONSECUTIVO=AUT.CONSECUTIVOHCA AND COALESCE(HCA.ANULADA,0)=0) IS NULL
                   THEN ISNULL(AUT.DXRELACIONADO,'')
                   ELSE
                    LEFT((SELECT TOP 1 MDX.IDDX FROM HCA LEFT JOIN MDX ON HCA.DX1=MDX.IDDX 
                           WHERE HCA.CONSECUTIVO=AUT.CONSECUTIVOHCA AND COALESCE(HCA.ANULADA,0)=0),4)
                    END)
                  ELSE ISNULL(AUT.DXRELACIONADO,'')
        END,4),
        LEFT(CASE WHEN SER.CODIGORIPS = DBO.FNK_ValorVariable('IDPROTERQXRIPS')
                   THEN AUT.COMPLICACION
                   ELSE ''
        END,4),  
        AUT.FORMAQX,   
        CAST (ROUND ( CASE ISNULL((AUTD.VALOR * AUTD.CANTIDAD),0)WHEN 0 THEN (AUTD.VALOR * AUTD.CANTIDAD)-AUTD.VALORCOPAGO ELSE (AUTD.VALOR * AUTD.CANTIDAD) END,0) AS INT ), 
        AUT.NOAUT, AUTD.NO_ITEM, ISNULL(@CNSFCT,'EXTERNO'), 1,CAST (ROUND ( AUTD.CANTIDAD,0)AS INT), 'CE', 
        LEFT(AUT.DXPPAL,4), SER.IDSERVICIO, 'CODEVAL' 
 	FROM   AUTD	INNER JOIN AUT     ON AUTD.IDAUT             = AUT.IDAUT     
			INNER JOIN RIPSD   ON RIPSD.NOADMISION       = AUT.IDAUT
			INNER JOIN AFI     ON AUT.IDAFILIADO         = AFI.IDAFILIADO
			LEFT  JOIN SER     ON SER.IDSERVICIO         = AUTD.IDSERVICIO 
			LEFT  JOIN RIPS_CP ON RIPS_CP.IDCONCEPTORIPS = SER.CODIGORIPS 
	WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
	AND    RIPS_CP.ARCHIVO   = 'AP' 
	AND    RIPSD.PROCEDENCIA = 'AUT'
   AND    AUTD.NOCOBRABLE= CASE WHEN @ENVIAR_NOCOB_CE_RIPS = 'NO' THEN 0 ELSE AUTD.NOCOBRABLE END AND AUT.IDPLAN =CASE WHEN COALESCE(@IDPLAN,'')='' THEN  AUT.IDPLAN ELSE @IDPLAN END 
    PRINT 'SE CREARON EN AP CE ' + CONVERT(VARCHAR,@@ROWCOUNT) + ' ITEMS'


  IF EXISTS (SELECT * FROM RRIPS_AP WHERE CANTIDAD>1 AND ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO)
  BEGIN
      DECLARE @ITEM INT
      DECLARE @CANT INT 
      DECLARE @BAND INT
	   DECLARE RRIPS_AP_CUR CURSOR FOR 
      SELECT ITEM,CANTIDAD FROM RRIPS_AP WHERE CANTIDAD>1 AND ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO  
      ORDER BY ITEM 
	   OPEN RRIPS_AP_CUR    
	   FETCH NEXT FROM RRIPS_AP_CUR    
	   INTO @ITEM,@CANT
	   WHILE @@FETCH_STATUS = 0    
	   BEGIN
         UPDATE RRIPS_AP SET CANTIDAD=1,VALORPROCED=ROUND((VALORPROCED/@CANT),0) WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO AND ITEM=@ITEM
         SELECT * INTO #XR FROM RRIPS_AP WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO AND ITEM=@ITEM
         SELECT @BAND=1
         WHILE @BAND<@CANT
         BEGIN
             INSERT INTO RRIPS_AP(ENVIO,IDTERCERO,ESTADO,NUMFACTURA,IDPRESTADOR,TIPO_DOC,IDUSUARIO,FECHAPROCEDIMIENTO,
                                  NUMAUT,IDPROCEDIMIENTO,AMBITO,FINPROCEDIMIENTO,PERSONALA,DXPPAL,DXREL,
                                  COMPLICACION,ACTOQ, VALORPROCED, NOPRESTACION, NOITEM, CNSFTR, N_CUOTA, 
                                  CANTIDAD, PROCEDENCIA, IDDX, IDSERVICIO, CODEVAL)
             SELECT ENVIO,@IDTERCERO,ESTADO,NUMFACTURA,IDPRESTADOR,TIPO_DOC,IDUSUARIO,FECHAPROCEDIMIENTO,
                                  NUMAUT,IDPROCEDIMIENTO,AMBITO,FINPROCEDIMIENTO,PERSONALA,DXPPAL,DXREL,
                                  COMPLICACION,ACTOQ, VALORPROCED, NOPRESTACION, NOITEM, CNSFTR, N_CUOTA, 
                                  CANTIDAD, PROCEDENCIA, IDDX, IDSERVICIO, CODEVAL
             FROM #XR
             SELECT @BAND=@BAND+1
         END
         DROP TABLE #XR
	   FETCH NEXT FROM RRIPS_AP_CUR    
	   INTO @ITEM,@CANT
	   END
	   CLOSE RRIPS_AP_CUR
	   DEALLOCATE RRIPS_AP_CUR      
  END

  IF @RIPS_AGRUPADOS = 'SI'
   BEGIN
      PRINT 'ENTRE AQUI HAGO TEMPORAL'

	  SELECT * INTO #A FROM RRIPS_AP WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO

	  PRINT 'BORRO RRIPS_AP'

	  DELETE RRIPS_AP WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO

	  PRINT 'LUEGO INSERTO REGISTRO DE LA TEMPORAL'
      
	  INSERT INTO RRIPS_AP (ENVIO, IDTERCERO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, FECHAPROCEDIMIENTO, NUMAUT, IDPROCEDIMIENTO, AMBITO, FINPROCEDIMIENTO, PERSONALA, DXPPAL, DXREL,
							COMPLICACION, ACTOQ,VALORPROCED,FECHARECIBO, ESTADO, FECHAENVIO, NOPRESTACION, NOITEM, CNSFTR, N_CUOTA,CANTIDAD, IDDX, PROCEDENCIA, IDSERVICIO, CODEVAL)
	  SELECT ENVIO, @IDTERCERO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, FECHAPROCEDIMIENTO, NUMAUT, IDPROCEDIMIENTO, AMBITO, FINPROCEDIMIENTO, PERSONALA, DXPPAL, DXREL,
	  COMPLICACION, ACTOQ,CONVERT(VARCHAR(15), SUM(CONVERT(DECIMAL(14,0),VALORPROCED)))VALORPROCED, 
	  FECHARECIBO, ESTADO, FECHAENVIO, NOPRESTACION, NOITEM, CNSFTR, N_CUOTA,1 CANTIDAD, IDDX, PROCEDENCIA, IDSERVICIO, CODEVAL
	  FROM #A WHERE ENVIO=@ENVIO 
	  GROUP BY ENVIO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, FECHAPROCEDIMIENTO, NUMAUT, IDPROCEDIMIENTO, AMBITO, FINPROCEDIMIENTO, PERSONALA, DXPPAL, DXREL, COMPLICACION, ACTOQ ,
		FECHARECIBO, ESTADO, FECHAENVIO, NOPRESTACION, NOITEM, CNSFTR, N_CUOTA,  IDDX, PROCEDENCIA, IDSERVICIO, CODEVAL

      PRINT 'DESPUES DE INSERTAR BORRO LA TEMPORAL '
      DROP TABLE #A 
	  PRINT 'EXITOSO'
   END

   PRINT 'CREANDO AM CE'
   INSERT INTO RRIPS_AM(ENVIO,IDTERCERO,ESTADO,NUMFACTURA,IDPRESTADOR,TIPO_DOC,IDUSUARIO,NUMAUT,
                        IDMEDICAMENTO, TIPOMEDICAMENTO, NOMBREMEDI, FORMAFARMA, CONCMEDI,
                        UMEDMEDI, NUMUNIDADES, VALORUNIMEDI, VALORTOTMEDI, NOPRESTACION, 
                        NOITEM, CNSFTR, N_CUOTA, PROCEDENCIA, IDDX, IDSERVICIO, CODEVAL, 
                        FECHAMEDICAMENTO) 
   SELECT @ENVIO, @IDTERCERO, 'I',CASE WHEN @PGP=0 THEN  @N_FACTURA ELSE 'AM'+REPLACE(LTRIM(REPLACE(@ENVIO,'0',' ')),' ','0')+DBO.FNK_NROCONCEROS_IZQUIERDA(ROW_NUMBER() OVER (ORDER BY @ENVIO),4,'') END, @CODPREST, 
          LEFT(AFI.TIPO_DOC,2),  
          REPLACE(AFI.DOCIDAFILIADO,'.',''), LEFT(AUT.NUMAUTORIZA,15),    
           CASE WHEN SER.CODIGORIPS = DBO.FNK_VALORVARIABLE('IDMEDPOSRIPS') THEN SER.IDALTERNA
			   WHEN  SER.PREFIJO = DBO.FNK_VALORVARIABLE('PREFIJOMEDNOPOS') AND DBO.FNK_VALORVARIABLE('NOPOSRIPS')='SI' THEN SER.IDALTERNA  ELSE ''  END,  
         CASE WHEN AUT.IDPESPECIAL=@PYM_EXTRAMURAL THEN '3' ELSE  CASE WHEN SER.CODIGORIPS='12' AND AUT.AMBITO<>'4' THEN '1' 
			   WHEN SER.CODIGORIPS='13'  AND AUT.AMBITO<>'4' THEN '2' WHEN @IPS='ALBA' AND AUT.AMBITO='4'  THEN '1' 
				WHEN  AUT.AMBITO='4'  THEN  '3' END END,  
          LEFT(REPLACE(SER.DESCSERVICIO,',',';'),30),  
          CASE SER.CODIGORIPS WHEN  DBO.FNK_VALORVARIABLE('IDMEDPOSRIPS') THEN CASE WHEN DBO.FNK_VALORVARIABLE('RIPS_AM_DATOSMEDPOS')='SI' THEN ISNULL(LEFT(IFFA.DESCRIPCION,20),'') ELSE '' END  ELSE ISNULL(LEFT(IFFA.DESCRIPCION,20),'') END,
          CASE SER.CODIGORIPS WHEN  DBO.FNK_VALORVARIABLE('IDMEDPOSRIPS') THEN CASE WHEN DBO.FNK_VALORVARIABLE('RIPS_AM_DATOSMEDPOS')='SI' THEN ISNULL(LEFT(ICCN.DESCRIPCION,20),'') ELSE '' END  ELSE ISNULL(LEFT(ICCN.DESCRIPCION,20),'') END,
          CASE SER.CODIGORIPS WHEN  DBO.FNK_VALORVARIABLE('IDMEDPOSRIPS') THEN CASE WHEN DBO.FNK_VALORVARIABLE('RIPS_AM_DATOSMEDPOS')='SI' THEN ISNULL(LEFT(IUNI.DESCRIPCION,20),'') ELSE '' END  ELSE ISNULL(LEFT(IUNI.DESCRIPCION,20),'') END,
          CAST (ROUND ( AUTD.CANTIDAD,0)AS INT), AUTD.VALOR,    
          CASE ISNULL((AUTD.VALOR * AUTD.CANTIDAD),0)WHEN 0 THEN (AUTD.VALOR * AUTD.CANTIDAD) - AUTD.VALORCOPAGO ELSE (AUTD.VALOR * AUTD.CANTIDAD) END, 
          AUT.NOAUT, AUTD.NO_ITEM, ISNULL(@CNSFCT,'EXTERNO'), 1, 'CE', AUT.DXPPAL, 
          SER.IDSERVICIO, 'CODEVAL', AUT.FECHA
   FROM   AUTD INNER JOIN AUT     ON AUTD.IDAUT             = AUT.IDAUT     
               INNER JOIN RIPSD   ON RIPSD.NOADMISION       = AUT.IDAUT
               INNER JOIN AFI     ON AUT.IDAFILIADO         = AFI.IDAFILIADO
               LEFT  JOIN SER     ON SER.IDSERVICIO         = AUTD.IDSERVICIO 
               LEFT  JOIN RIPS_CP ON RIPS_CP.IDCONCEPTORIPS = SER.CODIGORIPS 
               LEFT JOIN IART    ON IART.IDARTICULO        = SER.IDARTICULO 
               LEFT JOIN IUNI    ON IART.IDUNIDAD       = IUNI.IDUNIDAD
               LEFT JOIN ICCN    ON IART.IDCONCENTRA    = ICCN.IDCONCENTRA
               LEFT JOIN IFFA    ON IART.IDFORFARM      = IFFA.IDFORFARM
               LEFT JOIN IGEN    ON IART.IDGENERICO        = IGEN.IDGENERICO  
   WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
   AND    RIPS_CP.ARCHIVO   = 'AM'  
   AND    RIPSD.PROCEDENCIA = 'AUT'
   AND    AUTD.NOCOBRABLE= CASE WHEN @ENVIAR_NOCOB_CE_RIPS = 'NO' THEN 0 ELSE AUTD.NOCOBRABLE END
   AND AUT.IDPLAN =CASE WHEN COALESCE(@IDPLAN,'')='' THEN  AUT.IDPLAN ELSE @IDPLAN END 
   PRINT 'SE CREARON EN AM CE ' + CONVERT(VARCHAR,@@ROWCOUNT) + ' ITEMS'

   /*SE AGREGA VALIDACION PARA ENVIAR LOS CODIGOS CORRECTOS STORRES*/
   IF COALESCE(@FORMATORIPS,'')='01'-- COD CUMS SOLO
   BEGIN 
      PRINT 'FORMATO RIPS CUMS' 
         UPDATE RRIPS_AM SET IDMEDICAMENTO=COALESCE(SER.CODCUM,A.IDSERVICIO) 
         FROM RRIPS_AM A INNER JOIN SER ON A.IDSERVICIO=SER.IDSERVICIO
         WHERE ENVIO = @ENVIO AND A.IDTERCERO=@IDTERCERO  --STORRES SE AGREGA CONDICION
   END
   ELSE
   BEGIN
      IF COALESCE(@FORMATORIPS,'')='02'-- COD SISPRO SOLO
      BEGIN
         PRINT 'FORMATO RIPS SISPRO'
         UPDATE RRIPS_AM SET IDMEDICAMENTO=COALESCE(SER.CODSISPRO,A.IDSERVICIO) 
         FROM RRIPS_AM A INNER JOIN SER ON A.IDSERVICIO=SER.IDSERVICIO
         WHERE ENVIO = @ENVIO AND A.IDTERCERO=@IDTERCERO --STORRES SE AGREGA CONDICION
      END 
      ELSE
      BEGIN
         IF COALESCE(@FORMATORIPS,'')='03'
         BEGIN 
            PRINT 'FORMATO RIPS BASE DE DATOS PROPIAS'
            UPDATE RRIPS_AM SET 
               IDMEDICAMENTO=COALESCE(SERTHOM.IDALTERNA,A.IDSERVICIO), 
               NOMBREMEDI=LEFT(COALESCE(SERTHOM.DESCRIPCION,A.NOMBREMEDI),30) 
            FROM RRIPS_AM A 
               INNER JOIN FTR     ON A.NUMFACTURA=FTR.N_FACTURA
                LEFT JOIN SERTHOM ON A.IDSERVICIO=SERTHOM.IDSERVICIO AND SERTHOM.IDTERCERO=FTR.IDTERCERO
         END
      END
   END
   IF EXISTS(SELECT * FROM PPT WHERE IDTERCERO=@IDTERCERO AND IDPLAN=@IDPLAN AND COALESCE(CODBCUM,'NA')<>'NA')
   BEGIN
      DECLARE @IDGRUPOSER VARCHAR(20)
      SELECT @IDGRUPOSER=CODBCUM FROM PPT WHERE IDTERCERO=@IDTERCERO AND IDPLAN=@IDPLAN 
      IF EXISTS(SELECT  * FROM GSSP WHERE IDGRUPOSER=@IDGRUPOSER)
      BEGIN
         UPDATE RRIPS_AM SET IDMEDICAMENTO=GSSP.CODCUM,FORMAFARMA=GSSP.FORMAFARMA,CONCMEDI=GSSP.CONCMEDI,UMEDMEDI=GSSP.UMEDMEDI
         FROM RRIPS_AM INNER JOIN GSSP ON RRIPS_AM.IDSERVICIO=GSSP.IDSERVICIO
         WHERE RRIPS_AM.ENVIO=@ENVIO
         AND GSSP.IDGRUPOSER=@IDGRUPOSER

      END
   END
   /*FINALIZO DE AGREGAR NUEVA VALIDACION STORRES*/
   PRINT 'CREANDO AT CE'
   INSERT INTO RRIPS_AT(ENVIO, IDTERCERO, ESTADO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, NUMAUT, TIPOSERVICIO,
                        IDSERVICIO, DESCRIPCIONSER, CANTIDAD, VLRUNITMAT, VLRTOTMAT, NOPRESTACION, 
                        NOITEM, CNSFTR, N_CUOTA, PROCEDENCIA, IDDX, IDSERVICIOORI, CODEVAL,
                        FECHAPROCEDIMIENTO )
   SELECT @ENVIO, @IDTERCERO, 'I', CASE WHEN @PGP=0 THEN  @N_FACTURA ELSE 'AT'+REPLACE(LTRIM(REPLACE(@ENVIO,'0',' ')),' ','0')+DBO.FNK_NROCONCEROS_IZQUIERDA(ROW_NUMBER() OVER (ORDER BY @ENVIO),4,'') END, @CODPREST, 
          LEFT(AFI.TIPO_DOC,2),  
          REPLACE(AFI.DOCIDAFILIADO,'.',''), LEFT(AUT.NUMAUTORIZA,15),  
        CASE WHEN AUT.IDPESPECIAL=@PYM_EXTRAMURAL THEN '5' ELSE  CASE
                     WHEN  RIPS_CP.IDCONCEPTORIPS= '06' AND AUT.AMBITO<>'4' THEN '3'  
                     WHEN RIPS_CP.IDCONCEPTORIPS='07' AND AUT.AMBITO<>'4' THEN '4'  
                     WHEN RIPS_CP.IDCONCEPTORIPS='08' AND AUT.AMBITO<>'4' THEN '3'  
                     WHEN RIPS_CP.IDCONCEPTORIPS='09' AND AUT.AMBITO<>'4' THEN '1'  
                     WHEN RIPS_CP.IDCONCEPTORIPS='10' AND AUT.AMBITO<>'4' THEN '1'  
                     WHEN RIPS_CP.IDCONCEPTORIPS='11' AND AUT.AMBITO<>'4' THEN '1'  
                     WHEN RIPS_CP.IDCONCEPTORIPS='14' AND AUT.AMBITO<>'4' THEN '2' 
					 WHEN @IPS='ALBA' AND AUT.AMBITO='4'  THEN '1' 
					 WHEN AUT.AMBITO='4' THEN '5'  
         END END ,  
         REPLACE(SER.IDALTERNA,'-',''),  LEFT(REPLACE(SER.DESCSERVICIO,',',';'),30),  
         CAST (ROUND ( AUTD.CANTIDAD,0)AS INT), AUTD.VALOR, 
       CAST (ROUND (CASE ISNULL((AUTD.VALOR * AUTD.CANTIDAD),0)WHEN 0 THEN (AUTD.VALOR * AUTD.CANTIDAD) - AUTD.VALORCOPAGO ELSE (AUTD.VALOR * AUTD.CANTIDAD) END,0)AS INT )
		, 
         AUT.NOAUT, AUTD.NO_ITEM, ISNULL(@CNSFCT,'EXTERNO'), 1, 'CE', AUT.DXPPAL, SER.IDSERVICIO, 
         'CODEVAL', AUT.FECHA
   FROM   AUTD INNER JOIN AUT     ON AUTD.IDAUT             = AUT.IDAUT     
               INNER JOIN RIPSD   ON RIPSD.NOADMISION       = AUT.IDAUT
               INNER JOIN AFI     ON AUT.IDAFILIADO         = AFI.IDAFILIADO
               LEFT  JOIN SER     ON SER.IDSERVICIO         = AUTD.IDSERVICIO 
               LEFT  JOIN RIPS_CP ON RIPS_CP.IDCONCEPTORIPS = SER.CODIGORIPS 
   WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
   AND   (RIPS_CP.ARCHIVO   = 'AT' OR RIPS_CP.ARCHIVO   = 'AH')
   AND    RIPSD.PROCEDENCIA = 'AUT'
   AND    AUTD.NOCOBRABLE= CASE WHEN @ENVIAR_NOCOB_CE_RIPS = 'NO' THEN 0 ELSE AUTD.NOCOBRABLE END
   AND AUT.IDPLAN =CASE WHEN COALESCE(@IDPLAN,'')='' THEN  AUT.IDPLAN ELSE @IDPLAN END 
--para que vengan las consultas de gestion CEM
   UNION ALL
    SELECT @ENVIO, @IDTERCERO, 'I', CASE WHEN @PGP=0 THEN  @N_FACTURA ELSE 'AT'+REPLACE(LTRIM(REPLACE(@ENVIO,'0',' ')),' ','0')+DBO.FNK_NROCONCEROS_IZQUIERDA(ROW_NUMBER() OVER (ORDER BY @ENVIO),4,'') END, @CODPREST, 
          LEFT(AFI.TIPO_DOC,2),  
          REPLACE(AFI.DOCIDAFILIADO,'.',''), LEFT(CIT.NOAUTORIZACION,15),  
       CASE WHEN CIT.IDPESPECIAL=@PYM_EXTRAMURAL THEN '5' ELSE   CASE RIPS_CP.IDCONCEPTORIPS
                     WHEN '06' THEN '3'  
                     WHEN '07' THEN '4'  
                     WHEN '08' THEN '3'  
                     WHEN '09' THEN '1'  
                     WHEN '10' THEN '1'  
                     WHEN '11' THEN '1'  
                     WHEN '14' THEN '2' 
         END END ,  
         REPLACE(SER.IDALTERNA,'-',''),  LEFT(REPLACE(SER.DESCSERVICIO,',',';'),30),  
         CAST (ROUND ( CIT.CANTIDADC,0)AS INT), CIT.VALORTOTAL, 
       CAST (ROUND (CASE ISNULL((CIT.VALORTOTAL * CIT.CANTIDADC),0)WHEN 0 THEN (CIT.VALORTOTAL * CIT.CANTIDADC) - CIT.VALORCOPAGO ELSE (CIT.VALORTOTAL * CIT.CANTIDADC) END,0)AS INT )
		, 
         CIT.CONSECUTIVO, 1, ISNULL(@CNSFCT,'EXTERNO'), 1, 'CE', CIT.IDDX, SER.IDSERVICIO, 
         'CODEVAL', CIT.FECHA
  	FROM   CIT	INNER JOIN RIPSD   ON RIPSD.NOADMISION       = CIT.CONSECUTIVO
				   INNER JOIN AFI     ON CIT.IDAFILIADO         = AFI.IDAFILIADO
				   LEFT  JOIN SER     ON SER.IDSERVICIO         = CIT.IDSERVICIO 
			   	LEFT  JOIN RIPS_CP ON RIPS_CP.IDCONCEPTORIPS = SER.CODIGORIPS 
               LEFT  JOIN MPE     ON MPE.IDPESPECIAL=CIT.IDPESPECIAL 
	WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
	AND    (RIPS_CP.ARCHIVO   = 'AT' OR RIPS_CP.ARCHIVO   = 'AH')
	AND    RIPSD.PROCEDENCIA = 'CIT'
	AND    CIT.CUMPLIDA =	 CASE @RIPS_CITSOLOCUMPLIDA WHEN 'SI' THEN 1 ELSE CUMPLIDA END AND CIT.IDPLAN =CASE WHEN COALESCE(@IDPLAN,'')='' THEN  CIT.IDPLAN ELSE @IDPLAN END   
   PRINT 'SE CREARON EN AT CE ' + CONVERT(VARCHAR,@@ROWCOUNT) + ' ITEMS'

  IF @PGP=0
  BEGIN
     DELETE RRIPS_AC WHERE ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO AND NUMFACTURA NOT IN (SELECT N_FACTURA FROM RIPSD WHERE ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO) 
     DELETE RRIPS_AP WHERE ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO AND NUMFACTURA NOT IN (SELECT N_FACTURA FROM RIPSD WHERE ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO)
     DELETE RRIPS_AM WHERE ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO AND NUMFACTURA NOT IN (SELECT N_FACTURA FROM RIPSD WHERE ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO)
     DELETE RRIPS_AT WHERE ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO AND NUMFACTURA NOT IN (SELECT N_FACTURA FROM RIPSD WHERE ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO)
  END
  ELSE
  BEGIN
     IF UPPER(DBO.FNK_VALORVARIABLE('RIPSPGPENCERO')) = 'SI' AND @PGPX=1
      BEGIN 
         EXEC DBO.SPK_RIPS_EN_CERO @ENVIO, @IDTERCERO
      END

      DELETE RIPSD WHERE ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO AND PROCEDENCIA IN('CI','CE')
      SELECT @ITEMRIPSD=MAX(NOITEM)+1 FROM RIPSD  WHERE ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO
      --SELECT @ITEMRIPSD=1

      INSERT INTO RIPSD(ENVIO, IDTERCERO, NOITEM, NOADMISION, N_FACTURA, PROCEDENCIA)
      SELECT @ENVIO,@IDTERCERO,ROW_NUMBER() OVER(ORDER  BY ENVIO  DESC)+@ITEMRIPSD,NOPRESTACION,NUMFACTURA,PROCEDENCIA
      FROM  RRIPS_AC WHERE ENVIO = @ENVIO AND NUMFACTURA NOT IN (SELECT N_FACTURA FROM RIPSD WHERE ENVIO = @ENVIO) 

      SELECT @ITEMRIPSD=MAX(NOITEM) FROM RIPSD WHERE ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO

      INSERT INTO RIPSD(ENVIO, IDTERCERO, NOITEM, NOADMISION, N_FACTURA, PROCEDENCIA)
      SELECT @ENVIO,@IDTERCERO,ROW_NUMBER() OVER(ORDER  BY ENVIO  DESC)+@ITEMRIPSD,NOPRESTACION,NUMFACTURA,PROCEDENCIA FROM RRIPS_AP
      WHERE ENVIO = @ENVIO AND NUMFACTURA NOT IN (SELECT N_FACTURA FROM RIPSD WHERE ENVIO = @ENVIO)

      SELECT @ITEMRIPSD=MAX(NOITEM) FROM RIPSD WHERE ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO

      INSERT INTO RIPSD(ENVIO, IDTERCERO, NOITEM, NOADMISION, N_FACTURA, PROCEDENCIA)
      SELECT @ENVIO,@IDTERCERO,ROW_NUMBER() OVER(ORDER  BY ENVIO  DESC)+@ITEMRIPSD,NOPRESTACION,NUMFACTURA,PROCEDENCIA FROM RRIPS_AM
      WHERE ENVIO = @ENVIO AND NUMFACTURA NOT IN (SELECT N_FACTURA FROM RIPSD WHERE ENVIO = @ENVIO)

      SELECT @ITEMRIPSD=MAX(NOITEM) FROM RIPSD WHERE ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO

      INSERT INTO RIPSD(ENVIO, IDTERCERO, NOITEM, NOADMISION, N_FACTURA, PROCEDENCIA)
      SELECT @ENVIO,@IDTERCERO,ROW_NUMBER() OVER(ORDER  BY ENVIO  DESC)+@ITEMRIPSD,NOPRESTACION,NUMFACTURA,PROCEDENCIA FROM RRIPS_AT
      WHERE ENVIO = @ENVIO AND NUMFACTURA NOT IN (SELECT N_FACTURA FROM RIPSD WHERE ENVIO = @ENVIO)
  END
  UPDATE RIPS SET ENVIADO='G' WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO
  --BORRAMOS  TEMPORAL DE DX PPAL Y REL 
  DROP TABLE #DX
END



