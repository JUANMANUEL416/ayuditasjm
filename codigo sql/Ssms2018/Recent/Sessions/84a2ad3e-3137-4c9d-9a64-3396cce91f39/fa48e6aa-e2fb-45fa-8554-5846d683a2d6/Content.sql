IF EXISTS (SELECT name FROM sysobjects   WHERE NAME = 'SPK_ACTUALIZARESOL_HC' AND type = 'P')
BEGIN
   DROP PROCEDURE SPK_ACTUALIZARESOL_HC
END
GO
CREATE PROC DBO.SPK_ACTUALIZARESOL_HC
    @CONSECUTIVO  VARCHAR(13),
    @NVECES       SMALLINT=1,
    @IDAFILIADO   VARCHAR(20)=NULL,
    @FECHA        DATETIME=NULL
WITH ENCRYPTION
AS 
SET NOCOUNT ON
DECLARE @TABLER	TABLE (ID INT IDENTITY(1,1), CODRES VARCHAR(20))
DECLARE @TABLED	TABLE (ID INT IDENTITY(1,1), SECUENCIA SMALLINT, TIPO_CAMPO VARCHAR(12), CAMPO VARCHAR(10), CUMPLE BIT)
DECLARE 
    @FIXR			INT,
    @FIXR_TO		INT,
    @FIXD			INT,
    @FIXD_TO		INT,
    @CODRES			VARCHAR(20),
    @CLASEPLANTILLA VARCHAR(8), 
    @SECUENCIA		SMALLINT,
    @TIPO_CAMPO		VARCHAR(12), 
    @ALFANUMERICO	VARCHAR(120), 
    @CAMPO			VARCHAR(10),
    @CUMPLE         BIT,
    @GUARDA         INT,
    @NOADMISION     VARCHAR(20),
    @HUGO           VARCHAR(20),
    @MSG            VARCHAR(MAX),
    @IDAFILIADO_RN  VARCHAR(20),
    @FNACIMIENTO    DATETIME,
    @MATERNA        BIT=0,
    @HISMATER       VARCHAR(20),
    @ID				INT --IDRESAFI4505
BEGIN   
    PRINT 'EXEC SPK_ACTUALIZARESOL_HC '''+@CONSECUTIVO+''', '+CONVERT(VARCHAR(10),@NVECES)

    SELECT @CLASEPLANTILLA=CLASEPLANTILLA, @NOADMISION=NOADMISION, @FECHA=(CASE WHEN @FECHA IS NULL THEN FECHA ELSE @FECHA END)
    FROM HCA WHERE CONSECUTIVO=@CONSECUTIVO

    SELECT @HISMATER=ISNULL(DATO,'') FROM USVGS WHERE IDVARIABLE='4505_SOLO_MATER'
    IF @HISMATER<>''
    BEGIN
        IF NOT EXISTS (SELECT 1 FROM HCA WHERE NOADMISION=@NOADMISION AND CLASEPLANTILLA=@HISMATER AND ISNULL(ANULADA,0)=0)
            RETURN
    END

    --Reviso recien nacido
    IF EXISTS (SELECT 1 FROM HCAO WHERE PROCESO='RNACIDO_AFI' AND CLASEPLANTILLA=@CLASEPLANTILLA) AND @IDAFILIADO IS NULL
        SET @MATERNA = 1

    IF @MATERNA = 1
    BEGIN
       SELECT TOP 1 @HUGO=HCA.CONSECUTIVO 
       FROM HCA INNER JOIN MPL ON HCA.CLASEPLANTILLA=MPL.CLASEPLANTILLA
       WHERE HCA.NOADMISION=@NOADMISION AND ISNULL(MPL.HURG,0)=3 AND HCA.CONSECUTIVO<>@CONSECUTIVO
       ORDER BY HCA.FECHA DESC
    
       IF @HUGO IS NOT NULL
       BEGIN
          /* Recien nacido en AFI */
          EXEC SPK_CREA_RNACIDO_AFI @CONSECUTIVO
          
          SELECT @IDAFILIADO_RN=AFI.IDAFILIADO, @FNACIMIENTO=FNACIMIENTO
          FROM HCA INNER JOIN AFI ON HCA.IDAFILIADO_RN=AFI.IDAFILIADO
          WHERE CONSECUTIVO=@CONSECUTIVO

          --IF ISNULL(@FNACIMIENTO,GETDATE())<@FECHA
          --   SET @FECHA = @FNACIMIENTO

          /* 4505 de la madre */
          EXEC SPK_ACTUALIZARESOL_HC @HUGO, 2, NULL, @FECHA
          
          IF @IDAFILIADO_RN IS NOT NULL
          BEGIN
             PRINT 'Se crea RESAFI4505 para recien nacido'
             EXEC SPK_ACTUALIZARESOL_HC @CONSECUTIVO, 3, @IDAFILIADO_RN, @FECHA
          END
       END
       --RETURN
    END
    
    IF @HISMATER<>'' AND @CLASEPLANTILLA=(SELECT DATO FROM USVGS WHERE IDVARIABLE='NOTAVAC')
    BEGIN
        SELECT @IDAFILIADO=MAX(IDAFILIADO_RN) FROM HCA WHERE CLASEPLANTILLA=@HISMATER AND NOADMISION=@NOADMISION
        PRINT 'Nota de vacunaci√≥n con idafiliado='+@IDAFILIADO
    END

    IF ISNULL(@IDAFILIADO,'')=''
    BEGIN
       PRINT 'Se crea RESAFI'
       SELECT @IDAFILIADO=IDAFILIADO FROM HCA WHERE CONSECUTIVO=@CONSECUTIVO
    END
    
    
    INSERT INTO @TABLER (CODRES)
    SELECT DISTINCT RESCAMPOS.CODRES
    FROM   RESCONF INNER JOIN RESCAMPOS ON RESCONF.IDRESCAMPO = RESCAMPOS.IDRESCAMPOS
                   INNER JOIN MPLD      ON RESCONF.CODIGO     = MPLD.CLASEPLANTILLA 
                                       AND RESCONF.CAMPO      = MPLD.CAMPO
    WHERE  MPLD.CLASEPLANTILLA = @CLASEPLANTILLA AND RESCONF.TABLA='MPLD'
    
    SELECT @FIXR=1, @FIXR_TO=COUNT(1) FROM @TABLER
    
    WHILE @FIXR<=@FIXR_TO
    BEGIN    
      SET @GUARDA=1
      SELECT @CODRES=CODRES FROM @TABLER WHERE ID=@FIXR
       
      EXEC SPK_CREARESOL @CODRES, @IDAFILIADO, @FECHA, @ID OUTPUT
    
      DELETE @TABLED
    
      IF @MATERNA=1 AND @NVECES=1 AND @CODRES='4505'
          INSERT INTO @TABLED (SECUENCIA, TIPO_CAMPO, CAMPO, CUMPLE)
          SELECT MPLD.SECUENCIA, MPLD.TIPO_CAMPO, RESCAMPOS.CAMPO, RESCAMPOS.CUMPLE
          FROM   RESCONF INNER JOIN RESCAMPOS ON RESCONF.IDRESCAMPO = RESCAMPOS.IDRESCAMPOS
                         INNER JOIN MPLD      ON RESCONF.CODIGO     = MPLD.CLASEPLANTILLA 
                                             AND RESCONF.CAMPO      = MPLD.CAMPO 
          WHERE  MPLD.CLASEPLANTILLA=@CLASEPLANTILLA AND RESCONF.TABLA='MPLD' AND RESCAMPOS.CODRES=@CODRES
                 AND MPLD.ESTADO='Activo' AND RESCAMPOS.CAMPO IN ('049','050','051')
          ORDER BY RESCAMPOS.CAMPO
      ELSE
          INSERT INTO @TABLED (SECUENCIA, TIPO_CAMPO, CAMPO, CUMPLE)
          SELECT MPLD.SECUENCIA, MPLD.TIPO_CAMPO, RESCAMPOS.CAMPO, RESCAMPOS.CUMPLE
          FROM   RESCONF INNER JOIN RESCAMPOS ON RESCONF.IDRESCAMPO=RESCAMPOS.IDRESCAMPOS AND RESCAMPOS.CODRES=@CODRES 
                         INNER JOIN MPLD      ON RESCONF.CODIGO=MPLD.CLASEPLANTILLA AND RESCONF.CAMPO=MPLD.CAMPO
						 INNER JOIN HCAD      ON HCAD.CONSECUTIVO=@CONSECUTIVO AND HCAD.CLASEPLANTILLA=MPLD.CLASEPLANTILLA 
                                             AND MPLD.SECUENCIA=HCAD.SECUENCIA AND MPLD.CAMPO=HCAD.CAMPO
          WHERE  MPLD.CLASEPLANTILLA=@CLASEPLANTILLA AND RESCONF.TABLA='MPLD' AND MPLD.ESTADO='Activo' 
          ORDER BY RESCAMPOS.CAMPO
       
      SELECT @FIXD=1, @FIXD_TO=COUNT(1) FROM @TABLED
    
      WHILE @FIXD<=@FIXD_TO
      BEGIN
    	  SELECT @SECUENCIA=SECUENCIA, @TIPO_CAMPO=TIPO_CAMPO, @CAMPO=CAMPO, @CUMPLE=CUMPLE FROM @TABLED WHERE ID=@FIXD

         IF @TIPO_CAMPO = 'Alfanumerico' OR @TIPO_CAMPO = 'Calculado' OR @TIPO_CAMPO = 'Krystalos'  
             SELECT @ALFANUMERICO = ALFANUMERICO FROM HCAD WHERE CONSECUTIVO = @CONSECUTIVO AND SECUENCIA = @SECUENCIA 
         ELSE IF @TIPO_CAMPO = 'Numerico' OR @TIPO_CAMPO = 'Escala'
             SELECT @ALFANUMERICO = CONVERT(INT,NUMERICO) FROM HCAD WHERE CONSECUTIVO = @CONSECUTIVO AND SECUENCIA = @SECUENCIA 
         ELSE IF @TIPO_CAMPO = 'Lista' OR @TIPO_CAMPO = 'RadioButton'
             SELECT @ALFANUMERICO = COALESCE (MPLDL.VALOR,0) 
             FROM HCAD INNER JOIN MPLD ON HCAD.CLASEPLANTILLA=MPLD.CLASEPLANTILLA AND HCAD.SECUENCIA=MPLD.SECUENCIA
                     INNER JOIN MPLDL ON MPLD.CLASEPLANTILLA=MPLDL.CLASEPLANTILLA AND MPLD.CAMPO=MPLDL.CAMPO  AND LEFT(HCAD.ALFANUMERICO,80)=LEFT(MPLDL.VALORLISTA,80)
             WHERE CONSECUTIVO = @CONSECUTIVO AND HCAD.SECUENCIA = @SECUENCIA
         ELSE IF @TIPO_CAMPO = 'Memo'
             SELECT @ALFANUMERICO = SUBSTRING(ISNULL(MEMO,''),1,20) FROM HCAD WHERE CONSECUTIVO=@CONSECUTIVO AND SECUENCIA=@SECUENCIA
         ELSE IF @TIPO_CAMPO = 'Fecha'
             SELECT @ALFANUMERICO = CONVERT(VARCHAR(10),FECHA,103)  FROM HCAD WHERE CONSECUTIVO=@CONSECUTIVO AND SECUENCIA=@SECUENCIA       
         ELSE 
             SELECT @ALFANUMERICO = ''
        PRINT '@SECUENCIA ='+CAST(@SECUENCIA AS VARCHAR(20))+' @ALFANUMERICO= '+@ALFANUMERICO
    	  IF @CODRES='4505'
         BEGIN
            IF @CUMPLE=1 AND (@ALFANUMERICO='' OR @ALFANUMERICO=0 OR @ALFANUMERICO IS NULL)
            BEGIN
                PRINT 'No ingreso a SPK_ACTUALIZA_RESAFI4505 ya que no cumple'
                SET @GUARDA = 0
            END
            ELSE
            BEGIN
                BEGIN TRY 
                   IF @ALFANUMERICO <> ''
                   BEGIN
    	  	          EXEC SPK_ACTUALIZA_RESAFI4505 @ID, @CAMPO, @FECHA, @ALFANUMERICO, @CONSECUTIVO
                   END
                END TRY
                BEGIN CATCH
                   SET @MSG = 'EXEC SPK_ACTUALIZA_RESAFI4505 '+CONVERT(VARCHAR,@ID)+', '''+@CAMPO+''', '''
                              +CONVERT(VARCHAR,@FECHA)+''', '''+@ALFANUMERICO+''', '''+@CONSECUTIVO+''' '
                   RAISERROR(@MSG,13,1)
                END CATCH
    	     END
         END
    
    	  SET @FIXD += 1
      END
      
      IF @CODRES='4505'
      BEGIN
         IF @GUARDA=1
		 BEGIN
    		 EXEC SPK_REVISA_RESAFI4505 @ID, @FECHA
    		 EXEC SPK_REVISA_RESAFI4505 @ID, @FECHA
		 END
         ELSE
         BEGIN
             DELETE FROM RESAFI4505 WHERE IDRESAFI4505=@ID
             PRINT 'Borro el registro de RESAFI4505='+CONVERT(VARCHAR(20),@ID)
         END
      END
    
      SET @FIXR += 1
    END 
END

