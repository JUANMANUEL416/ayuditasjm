CREATE OR ALTER PROCEDURE DBO.SPQ_FTR_RPT_COL @JSON NVARCHAR(MAX)
	WITH ENCRYPTION
AS
SET DATEFORMAT dmy
DECLARE @TBLERRORES TABLE (ERROR VARCHAR(MAX))
DECLARE  @PARAMETROS NVARCHAR(MAX)			,@MODELO VARCHAR(100)			   ,@METODO VARCHAR(100)
		,@USUARIO VARCHAR(12)				   ,@COMPANIA VARCHAR(2)		      ,@IDSEDE      VARCHAR(5)		
      ,@SYS_COMPUTERNAME VARCHAR(200)     ,@DATOS    VARCHAR(MAX)
      ,@PROCESO VARCHAR(20)               ,@F_INICIAL DATETIME               ,@F_FINAL DATETIME
      ,@IDTERCERO VARCHAR(20)             ,@IDPLAN VARCHAR(20)              ,@PARTICULAR VARCHAR(20)
      ,@IDSEDEF VARCHAR(20)               ,@PROCEDENCIA VARCHAR(20)         ,@USUARIOFACTU VARCHAR(20)
      ,@TERCONTABLE VARCHAR(20)           ,@AREAFUNCIONAL VARCHAR(20)       ,@PREFIJO VARCHAR(20)
      ,@IDSERVICIO VARCHAR(20)            ,@PART VARCHAR(MAX)               ,@SQL VARCHAR(MAX)
      ,@ESTFTR VARCHAR(120)               ,@WHERE VARCHAR(MAX)              ,@SELECT VARCHAR(MAX)
BEGIN
	SELECT *
	INTO #JSON
	FROM OPENJSON(@json) WITH (
			MODELO VARCHAR(100) '$.MODELO'
			,METODO VARCHAR(100) '$.METODO'
			,USUARIO VARCHAR(12) '$.USUARIO'
			,PARAMETROS NVARCHAR(MAX) AS JSON
	)

	SELECT   @MODELO = MODELO, @METODO = METODO, @PARAMETROS = PARAMETROS, @USUARIO = USUARIO
	FROM #JSON
	IF @METODO='GENERAR_RPT'     
	BEGIN         
		SELECT @PROCESO=PROCESO, @DATOS=DATOS        
		FROM   OPENJSON (@PARAMETROS)
		WITH ( 
			PROCESO VARCHAR(20) '$.PROCESO',
			DATOS NVARCHAR(MAX) AS JSON 
		)           
			DECLARE @PATICULARES TABLE(IDPLAN VARCHAR(6))

			INSERT INTO @PATICULARES(IDPLAN)
			SELECT DATO FROM USVGS WHERE IDVARIABLE LIKE 'IDPLANPART%'
			SELECT  @F_INICIAL=F_INICIAL, @F_FINAL=F_FINAL, @IDTERCERO=IDTERCERO, @IDPLAN=IDPLAN, @PARTICULAR=PARTICULAR, @IDSEDEF=IDSEDEF,
			@PROCEDENCIA=CASE WHEN PROCEDENCIA<>'Todas' THEN CASE PROCEDENCIA WHEN 'Asistencial' THEN 'SALUD' WHEN 'Citas' THEN 'CI' WHEN 'Ordenes CE' THEN 'CE'
			WHEN 'Financieras' THEN 'FINANCIERO' WHEN 'Inventario' THEN 'INVENTARIO' WHEN 'Caja' THEN 'CAJA' ELSE '' END ELSE PROCEDENCIA END, @USUARIOFACTU=USUARIOFACTU, @TERCONTABLE=TERCONTABLE, @AREAFUNCIONAL=AREAFUNCIONAL,  @PREFIJO=PREFIJO,
			@IDSERVICIO=IDSERVICIO     
			FROM   OPENJSON (@DATOS)
			WITH   (  
				F_INICIAL DATE            '$.F_INICIAL',
				F_FINAL DATE              '$.F_FINAL',
				IDTERCERO VARCHAR(20)     '$.IDTERCERO',
				IDPLAN VARCHAR(6)         '$.IDPLAN',
				PARTICULAR VARCHAR(20)    '$.PARTICULAR',
				IDSEDEF VARCHAR(6)        '$.IDSEDE',
				PROCEDENCIA VARCHAR(20)   '$.PROCEDENCIA',
				USUARIOFACTU VARCHAR(20)  '$.USUARIOFACTU',
				TERCONTABLE VARCHAR(20)   '$.TERCONTABLE',
				AREAFUNCIONAL VARCHAR(20) '$.AREAFUNCIONAL',
				PREFIJO VARCHAR(20)       '$.PREFIJO',
				IDSERVICIO VARCHAR(20)    '$.IDSERVICIO'       
			)   
		IF (OBJECT_ID('tempdb.dbo.#FTR','U')) IS NULL
		BEGIN
			CREATE TABLE #FTR(N_FACTURA VARCHAR(20) COLLATE database_default)
		END
		ELSE
		BEGIN
			DELETE #FTR WHERE 1=1
		END
		IF  DBO.FNK_VALORVARIABLE('SEPARA_NC_RPT_FACT')<>'NO' AND @PROCESO <> 'NotasCr'
		BEGIN
			INSERT INTO #FTR(N_FACTURA)
			SELECT DISTINCT FTR.N_FACTURA 
			FROM FTR INNER JOIN FNOT ON FTR.N_FACTURA = FNOT.N_FACTURA
			WHERE COALESCE(TIPOANULACION, '') = 'NC'
			AND F_FACTURA>=CONVERT(VARCHAR(10),@F_INICIAL,103)
			AND F_FACTURA< CONVERT(VARCHAR(10),@F_FINAL + 1,103)
		END
		--ARMADO DE CLAUSULA PARTICULARES
		SELECT @PART = ''
		IF LEFT(@PARTICULAR,1) = '1'
		BEGIN
			SELECT @PART = ' AND  FTR.IDPLAN NOT IN( SELECT DATO FROM USVGS WHERE IDVARIABLE IN
			(''IDPLANPART'',''IDPLANPART2'',''IDPLANPART3'',''IDPLANPART4'',''IDPLANPART5''))'
		END
		ELSE IF  LEFT(@PARTICULAR,1) = '2'
		BEGIN
			SELECT @PART = ' AND  FTR.IDPLAN IN( SELECT DATO FROM USVGS WHERE IDVARIABLE IN
			(''IDPLANPART'',''IDPLANPART2'',''IDPLANPART3'',''IDPLANPART4'',''IDPLANPART5''))'
		END
		ELSE
		BEGIN
			SELECT @PART = ''
		END
		SELECT @ESTFTR=''
		IF @PROCESO='Anuladas'
		BEGIN 
			SELECT @ESTFTR=' AND FTR.ESTADO=''A'' '
		END
		ELSE
		BEGIN
			IF @PROCESO='NotasCr'
			BEGIN 
			SELECT @ESTFTR=' AND COALESCE(FTR.TIPOANULACION,'''')=''NC'' '
			END
			ELSE
			BEGIN
			IF UPPER(@PROCESO) <> 'GENERAL'
			BEGIN
				SELECT @ESTFTR='  AND FTR.ESTADO=''P'' AND COALESCE(FTR.TIPOANULACION,'''')<>''NC'' '
			END 
			ELSE
			BEGIN
				SELECT @ESTFTR='  AND FTR.ESTADO=FTR.ESTADO '
			END
			END
		END

		PRINT '@PROCESO='+@PROCESO

		IF @PROCESO='Rventas'
		BEGIN
			PRINT 'INGRESO'
			SELECT @SQL=
						'SELECT PLN.DESCPLAN TIPOPLAN,DBO.FNK_FECHA_GRINGA(F_FACTURA)F_FACTURA,DBO.FNK_FECHA_GRINGA(F_VENCE)F_VENCE,CASE WHEN FTR.TIPOFIN=''N'' THEN ''03'' ELSE ''01'' END TIPOCOMP,
						CASE WHEN FTR.TIPOFIN=''N'' THEN ''BOLETA ELECTRONICA'' ELSE ''FACTURA ELECTRONICA'' END TIPODOCUMENTO,LEFT(FTR.N_FACTURA,4)SERIE,
						RIGHT(FTR.N_FACTURA,8)NUMERO,CASE WHEN FTR.TIPOFIN=''C''  THEN 6 ELSE CONVERT(VARCHAR(1),CONVERT(INT,COALESCE(TGEN.VALOR1,0))) END TIPO,
						TER.TIPO_ID TIPO_DOC,TER.NIT IDENTIFICACION,TER.RAZONSOCIAL,
						(SELECT SUM(CASE WHEN COALESCE(FTRD.VIVA,0)>0 THEN (FTRD.VALOR*CANTIDAD) ELSE  0 END)
						FROM FTRD WHERE N_FACTURA=FTR.N_FACTURA AND COALESCE(FTRD.PAQUETE,0) IN(0,2))  OPGRAVADA ,
						(SELECT SUM(CASE WHEN COALESCE(FTRD.VIVA,0)=0 THEN (FTRD.VALOR*CANTIDAD)  ELSE 0 END)  
						FROM FTRD WHERE N_FACTURA=FTR.N_FACTURA AND COALESCE(FTRD.PAQUETE,0) IN(0,2))  OPNOGRAVADA ,
						COALESCE(FTR.VIVA,0)IGV,
						FTR.VALORSERVICIOS,''''F_COMP_REF,''''TIPO_REF,''''NRO_SERIE,'''' NRO_REFERENCIA
						FROM  FTR INNER JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
									INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
									LEFT JOIN TGEN ON TER.TIPO_ID =TGEN.CODIGO AND TGEN.TABLA=''General'' AND TGEN.CAMPO=''TIPOIDSUNAT''
						LEFT  JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
						LEFT  JOIN TTEC ON FTR.TIPOTTEC=TTEC.TIPO
						LEFT  JOIN SED ON FTR.IDSEDE=SED.IDSEDE
			WHERE  F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
			AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
			AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
			AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
			AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
			AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
			AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
			AND    FTR.USUARIOFACTURA = CASE WHEN COALESCE('''+COALESCE(@USUARIOFACTU,'')+''','''')='''' THEN FTR.USUARIOFACTURA ELSE '''+COALESCE(@USUARIOFACTU,'')+''' END 
			' +@PART+ '
			UNION ALL 
			SELECT PLN.DESCPLAN,DBO.FNK_FECHA_GRINGA(FNOT.F_NOTA)F_NOTA,DBO.FNK_FECHA_GRINGA(FNOT.F_NOTA)F_NOTA,CASE FTR.TIPOFIN WHEN ''N'' THEN IIF(FNOT.CLASE=''C'',''07'',''07'') WHEN ''C'' THEN IIF(FNOT.CLASE=''C'',''08'',''08'') END TIPO,
						''NOTA  ''+CASE WHEN FTR.TIPOFIN=''N'' THEN IIF(FNOT.CLASE=''C'',''CREDITO BOLETA '',''DEBITO BOLETA'') ELSE  IIF(FNOT.CLASE=''C'',''CREDITO FACTURA'',''DEBITO FACTURA'') END+''ELECTRONICA'' TIPODOC,
						LEFT(FNOT.CNSDIANFE,4)SERIE,RIGHT(FNOT.CNSDIANFE,8)NRO,CASE WHEN FTR.TIPOFIN=''C''  THEN 6 ELSE CONVERT(VARCHAR(1),CONVERT(INT,COALESCE(TGEN.VALOR1,0))) END,
						TER.TIPO_ID,TER.NIT,TER.RAZONSOCIAL,
						(SELECT SUM(CASE WHEN COALESCE(FNOTD.VALORIVA,0)>0 THEN FNOTD.VR_TOTAL - FNOTD.VALORIVA ELSE  0 END)
						FROM FNOTD WHERE CNSFNOT=FNOT.CNSFNOT )  OPGRAVADA ,
						(SELECT SUM(CASE WHEN COALESCE(FNOTD.VALORIVA,0)=0 THEN FNOTD.VR_TOTAL  ELSE 0 END)  
						FROM FNOTD WHERE CNSFNOT=FNOT.CNSFNOT )  OPNOGRAVADA ,
						(SELECT SUM(CASE WHEN COALESCE(FNOTD.VALORIVA,0)>0 THEN FNOTD.VALORIVA  ELSE 0 END)  
						FROM FNOTD WHERE CNSFNOT=FNOT.CNSFNOT ),
						FNOT.VR_TOTAL,DBO.FNK_FECHA_GRINGA(FTR.F_FACTURA),CASE WHEN FTR.TIPOFIN=''N'' THEN ''03'' ELSE ''01'' END,LEFT(FTR.N_FACTURA,4)SERIE,
						RIGHT(FTR.N_FACTURA,8)NRO
			FROM FNOT INNER JOIN FTR ON FNOT.N_FACTURA=FTR.N_FACTURA
						INNER JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
									INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
									LEFT JOIN TGEN ON TER.TIPO_ID =TGEN.CODIGO AND TGEN.TABLA=''General'' AND TGEN.CAMPO=''TIPOIDSUNAT''
						LEFT  JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
						LEFT  JOIN TTEC ON FTR.TIPOTTEC=TTEC.TIPO
						LEFT  JOIN SED ON FTR.IDSEDE=SED.IDSEDE
			WHERE  F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
			AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
			AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
			AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
			AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
			AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
			AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
			AND    FTR.USUARIOFACTURA = CASE WHEN COALESCE('''+COALESCE(@USUARIOFACTU,'')+''','''')='''' THEN FTR.USUARIOFACTURA ELSE '''+COALESCE(@USUARIOFACTU,'')+''' END 
			'
			PRINT @SQL
			SELECT 'OK' OK
			EXECUTE(@SQL)
		END

		IF UPPER(@PROCESO) IN('FACTURADO','TERCERO','IDPLAN','TERCONTA','ANULADAS','NOTACR','USUARIO')
		BEGIN
			IF UPPER(@PROCESO)='TERCERO' 
			BEGIN
			IF  COALESCE(@IDTERCERO,'')=''
			BEGIN
				SELECT @SQL=
					'SELECT FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL, COUNT(*) CANTIDAD, SUM(FTR.VALORSERVICIOS) VALOR_SERVICIOS, SUM(FTR.VALORCOPAGO) VALORCOPAGO, 
					SUM(FTR.VALORPCOMP) VALOR_PCOMP, SUM(FTR.DESCUENTO) DESCUENTO, SUM(FTR.VALORSERVICIOS)-SUM(FTR.DESCUENTO)-SUM(FTR.VALORPCOMP)-SUM(FTR.VALORCOPAGO) VR_TOTAL,
					SUM(CASE WHEN  FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN 1 ELSE 0 END) ACTIVAS,SUM(CASE WHEN  FTR.ESTADO=''A'' THEN 1 ELSE 0 END)ANULADAS,
					SUM( CASE WHEN COALESCE(FTR.TIPOANULACION,'''')=''NC'' THEN 1 ELSE 0 END) NOTACR,SUM(CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN 1 ELSE 0 END) ENCOLA,
					SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 1 THEN 1  ELSE 0 END) ENCOLA,SUM(CASE WHEN COALESCE(FTR.FACTE,0)=2 THEN 1 ELSE 0 END) ENVIADA,
					SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 3 THEN 1 ELSE 0 END)CONERROR,SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 4 THEN 1 ELSE 0 END) RECEPCION
					FROM   FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
					WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
					AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
					AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
					AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
					AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
					AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
					' +@PART+@ESTFTR+
					' GROUP BY FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.ESTADO,COALESCE(FTR.TIPOANULACION,'''') ' 
				PRINT @SQL
				SELECT 'OK' OK
				EXECUTE(@SQL)
			END
			ELSE
			BEGIN
				PRINT 'DETALLE POR TERCERO'
				SELECT @ESTFTR='  AND FTR.ESTADO=FTR.ESTADO '
				SELECT @SQL=
					'SELECT FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.N_FACTURA,CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,FTR.PROCEDENCIA,AFI.DOCIDAFILIADO,AFI.NOMBREAFI,
					FTR.VALORSERVICIOS,FTR.VALORCOPAGO AS VALORCOPAGO, 
					FTR.VALORPCOMP VALOR_PCOMP, FTR.DESCUENTO DESCUENTO, FTR.VALORSERVICIOS-FTR.DESCUENTO-FTR.VALORPCOMP-FTR.VALORCOPAGO VR_TOTAL,
					CASE WHEN FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN ''ACTIVA'' ELSE ''ANULADA'' END ESTADO,
					CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN ''SINENVIAR'' WHEN 1 THEN ''ENCOLA'' WHEN 2 THEN ''NOTIFICADA'' WHEN 3 THEN ''CONERROR''
					WHEN 4 THEN ''NOTIFICADA'' ELSE ''OTRO'' END ESTADODIAN,FTR.USUARIOFACTURA,USUSU.NOMBRE 
					FROM   FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
								LEFT  JOIN AFI ON FTR.IDAFILIADO=AFI.IDAFILIADO
								LEFT  JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
					WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
					AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
					AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
					AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
					AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
					AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
					' +@PART+@ESTFTR
					PRINT @SQL
					SELECT 'OK' OK
					EXECUTE(@SQL)
			END
			END
			IF UPPER(@PROCESO)='IDPLAN'  
			BEGIN
			IF COALESCE(@IDPLAN,'')=''
			BEGIN
				SELECT @SQL=
					'SELECT FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.IDPLAN,PLN.DESCPLAN, COUNT(*) CANTIDAD, SUM(FTR.VALORSERVICIOS) VALOR_SERVICIOS, SUM(FTR.VALORCOPAGO) VALORCOPAGO, 
					SUM(FTR.VALORPCOMP) VALOR_PCOMP, SUM(FTR.DESCUENTO) DESCUENTO, SUM(FTR.VALORSERVICIOS)-SUM(FTR.DESCUENTO)-SUM(FTR.VALORPCOMP)-SUM(FTR.VALORCOPAGO) VR_TOTAL,
					SUM(CASE WHEN  FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN 1 ELSE 0 END) ACTIVAS,SUM(CASE WHEN  FTR.ESTADO=''A'' THEN 1 ELSE 0 END)ANULADAS,
					SUM( CASE WHEN COALESCE(FTR.TIPOANULACION,'''')=''NC'' THEN 1 ELSE 0 END) NOTACR,SUM(CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN 1 ELSE 0 END) ENCOLA,
					SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 1 THEN 1  ELSE 0 END) ENCOLA,SUM(CASE WHEN COALESCE(FTR.FACTE,0)=2 THEN 1 ELSE 0 END) ENVIADA,
					SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 3 THEN 1 ELSE 0 END)CONERROR,SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 4 THEN 1 ELSE 0 END) RECEPCION
					FROM   FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
								LEFT  JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
					WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
					AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
					AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
					AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
					AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
					AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
					' +@PART+@ESTFTR+
					' GROUP BY FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.ESTADO,COALESCE(FTR.TIPOANULACION,''''),FTR.IDPLAN,PLN.DESCPLAN ' 
				PRINT @SQL
				SELECT 'OK' OK
				EXECUTE(@SQL)
			END
			ELSE
			BEGIN
				PRINT 'DETALLE POR TERCERO Y PLAN '
				SELECT @ESTFTR='  AND FTR.ESTADO=FTR.ESTADO '
				SELECT @SQL=
					'SELECT FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.IDPLAN,PLN.DESCPLAN,FTR.N_FACTURA,CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,FTR.PROCEDENCIA,AFI.DOCIDAFILIADO,AFI.NOMBREAFI,
					FTR.VALORSERVICIOS,FTR.VALORCOPAGO AS VALORCOPAGO, 
					FTR.VALORPCOMP VALOR_PCOMP, FTR.DESCUENTO DESCUENTO, FTR.VALORSERVICIOS-FTR.DESCUENTO-FTR.VALORPCOMP-FTR.VALORCOPAGO VR_TOTAL,
					CASE WHEN FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN ''ACTIVA'' ELSE ''ANULADA'' END ESTADO,
					CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN ''SINENVIAR'' WHEN 1 THEN ''ENCOLA'' WHEN 2 THEN ''NOTIFICADA'' WHEN 3 THEN ''CONERROR''
					WHEN 4 THEN ''NOTIFICADA'' ELSE ''OTRO'' END ESTADODIAN,FTR.USUARIOFACTURA,USUSU.NOMBRE 
					FROM   FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
								LEFT  JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
								LEFT  JOIN AFI ON FTR.IDAFILIADO=AFI.IDAFILIADO
								LEFT  JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
					WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
					AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
					AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
					AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
					AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
					AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
					AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
					' +@PART+@ESTFTR
					PRINT @SQL
					SELECT 'OK' OK
					EXECUTE(@SQL)
				END
			END
			IF UPPER(@PROCESO)='TERCONTA'  
			BEGIN
			IF COALESCE(@TERCONTABLE,'')=''
			BEGIN
				SELECT @SQL=
					'SELECT COALESCE(FTR.TIPOTTEC,''SINTTEC'')TIPOTTEC,COALESCE(TTEC.DETALLE,''NO DEFINIDO'')DETALLE, COUNT(*) CANTIDAD, SUM(FTR.VALORSERVICIOS) VALOR_SERVICIOS, SUM(FTR.VALORCOPAGO) VALORCOPAGO, 
					SUM(FTR.VALORPCOMP) VALOR_PCOMP, SUM(FTR.DESCUENTO) DESCUENTO, SUM(FTR.VALORSERVICIOS)-SUM(FTR.DESCUENTO)-SUM(FTR.VALORPCOMP)-SUM(FTR.VALORCOPAGO) VR_TOTAL,
					SUM(CASE WHEN  FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN 1 ELSE 0 END) ACTIVAS,SUM(CASE WHEN  FTR.ESTADO=''A'' THEN 1 ELSE 0 END)ANULADAS,
					SUM( CASE WHEN COALESCE(FTR.TIPOANULACION,'''')=''NC'' THEN 1 ELSE 0 END) NOTACR,SUM(CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN 1 ELSE 0 END) ENCOLA,
					SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 1 THEN 1  ELSE 0 END) ENCOLA,SUM(CASE WHEN COALESCE(FTR.FACTE,0)=2 THEN 1 ELSE 0 END) ENVIADA,
					SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 3 THEN 1 ELSE 0 END)CONERROR,SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 4 THEN 1 ELSE 0 END) RECEPCION
					FROM   FTR LEFT JOIN TTEC ON FTR.TIPOTTEC=TTEC.TIPO 
					WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
					AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
					AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
					AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
					AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
					AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
					' +@PART+@ESTFTR+
					' GROUP BY FTR.TIPOTTEC,TTEC.DETALLE,FTR.ESTADO,COALESCE(FTR.TIPOANULACION,'''')' 
				PRINT @SQL
				SELECT 'OK' OK
				EXECUTE(@SQL)
			END
			ELSE
			BEGIN
				PRINT 'DETALLE POR TIPO DE TERCERO '
				SELECT @ESTFTR='  AND FTR.ESTADO=FTR.ESTADO '
				SELECT @SQL=
					'SELECT FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.IDPLAN,PLN.DESCPLAN,COALESCE(FTR.TIPOTTEC,''SINTTEC'')TIPOTTEC,COALESCE(TTEC.DETALLE,''NO DEFINIDO'')DETALLE,FTR.N_FACTURA,CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,FTR.PROCEDENCIA,AFI.DOCIDAFILIADO,AFI.NOMBREAFI,
					FTR.VALORSERVICIOS,FTR.VALORCOPAGO AS VALORCOPAGO, 
					FTR.VALORPCOMP VALOR_PCOMP, FTR.DESCUENTO DESCUENTO, FTR.VALORSERVICIOS-FTR.DESCUENTO-FTR.VALORPCOMP-FTR.VALORCOPAGO VR_TOTAL,
					CASE WHEN FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN ''ACTIVA'' ELSE ''ANULADA'' END ESTADO,
					CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN ''SINENVIAR'' WHEN 1 THEN ''ENCOLA'' WHEN 2 THEN ''NOTIFICADA'' WHEN 3 THEN ''CONERROR''
					WHEN 4 THEN ''NOTIFICADA'' ELSE ''OTRO'' END ESTADODIAN,FTR.USUARIOFACTURA,USUSU.NOMBRE 
					FROM   FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
								LEFT  JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
								LEFT  JOIN AFI ON FTR.IDAFILIADO=AFI.IDAFILIADO
								LEFT  JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
								LEFT  JOIN TTEC ON FTR.TIPOTTEC=TTEC.TIPO
					WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
					AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
					AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
					AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
					AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
					AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
					AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
					AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
					' +@PART+@ESTFTR
					PRINT @SQL
					SELECT 'OK' OK
					EXECUTE(@SQL)
				END
			END
			IF UPPER(@PROCESO)='USUARIO'  
			BEGIN
			IF COALESCE(@USUARIOFACTU,'')=''
			BEGIN
				SELECT @SQL=
					'SELECT FTR.USUARIOFACTURA,USUSU.NOMBRE, COUNT(*) CANTIDAD, SUM(FTR.VALORSERVICIOS) VALOR_SERVICIOS, SUM(FTR.VALORCOPAGO) VALORCOPAGO, 
					SUM(FTR.VALORPCOMP) VALOR_PCOMP, SUM(FTR.DESCUENTO) DESCUENTO, SUM(FTR.VALORSERVICIOS)-SUM(FTR.DESCUENTO)-SUM(FTR.VALORPCOMP)-SUM(FTR.VALORCOPAGO) VR_TOTAL,
					SUM(CASE WHEN  FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN 1 ELSE 0 END) ACTIVAS,SUM(CASE WHEN  FTR.ESTADO=''A'' THEN 1 ELSE 0 END)ANULADAS,
					SUM( CASE WHEN COALESCE(FTR.TIPOANULACION,'''')=''NC'' THEN 1 ELSE 0 END) NOTACR,SUM(CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN 1 ELSE 0 END) ENCOLA,
					SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 1 THEN 1  ELSE 0 END) ENCOLA,SUM(CASE WHEN COALESCE(FTR.FACTE,0)=2 THEN 1 ELSE 0 END) ENVIADA,
					SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 3 THEN 1 ELSE 0 END)CONERROR,SUM(CASE WHEN COALESCE(FTR.FACTE,0)= 4 THEN 1 ELSE 0 END) RECEPCION
					FROM   FTR LEFT JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
					WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
					AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
					AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
					AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
					AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
					AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
					' +@PART+@ESTFTR+
					' GROUP BY FTR.USUARIOFACTURA,USUSU.NOMBRE,FTR.ESTADO,COALESCE(FTR.TIPOANULACION,'''')' 
				PRINT @SQL
				SELECT 'OK' OK
				EXECUTE(@SQL)
			END
			ELSE
			BEGIN
				PRINT 'DETALLE POR USUARIO FACTURA '
				SELECT @ESTFTR='  AND FTR.ESTADO=FTR.ESTADO '
				SELECT @SQL=
					'SELECT FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.IDPLAN,PLN.DESCPLAN,COALESCE(FTR.TIPOTTEC,''SINTTEC'')TIPOTTEC,COALESCE(TTEC.DETALLE,''NO DEFINIDO'')DETALLE,
					FTR.USUARIOFACTURA,USUSU.NOMBRE, FTR.N_FACTURA,CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,FTR.PROCEDENCIA,AFI.DOCIDAFILIADO,AFI.NOMBREAFI,
					FTR.VALORSERVICIOS,FTR.VALORCOPAGO AS VALORCOPAGO, 
					FTR.VALORPCOMP VALOR_PCOMP, FTR.DESCUENTO DESCUENTO, FTR.VALORSERVICIOS-FTR.DESCUENTO-FTR.VALORPCOMP-FTR.VALORCOPAGO VR_TOTAL,
					CASE WHEN FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN ''ACTIVA'' ELSE ''ANULADA'' END ESTADO,
					CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN ''SINENVIAR'' WHEN 1 THEN ''ENCOLA'' WHEN 2 THEN ''NOTIFICADA'' WHEN 3 THEN ''CONERROR''
					WHEN 4 THEN ''NOTIFICADA'' ELSE ''OTRO'' END ESTADODIAN,FTR.USUARIOFACTURA,USUSU.NOMBRE 
					FROM   FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
								LEFT  JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
								LEFT  JOIN AFI ON FTR.IDAFILIADO=AFI.IDAFILIADO
								LEFT  JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
								LEFT  JOIN TTEC ON FTR.TIPOTTEC=TTEC.TIPO
					WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
					AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
					AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
					AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
					AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
					AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
					AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
					AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
					AND    FTR.USUARIOFACTURA = CASE WHEN COALESCE('''+COALESCE(@USUARIOFACTU,'')+''','''')='''' THEN FTR.USUARIOFACTURA ELSE '''+COALESCE(@USUARIOFACTU,'')+''' END 
					' +@PART+@ESTFTR
					PRINT @SQL
					SELECT 'OK' OK
					EXECUTE(@SQL)
				END
			END
		END
		IF UPPER(@PROCESO) ='PREFIJO' --,'SERVICIO','IDAREA')
		BEGIN
			PRINT 'INGRESO A PREFIJO'
			SELECT @SQL=
			' SELECT FTRD.PREFIJO, COALESCE(PRE.NOM_PREFIJO,PLN.DESCPLAN) DESCRIPCION,SUM(COALESCE(FTRD.VLR_SERVICI,0)) VALORSERVICIOS,
			SUM(CASE WHEN COALESCE(COPAGOS_CP,0)>0 THEN COALESCE(COPAGOS_CP,0) ELSE COALESCE(FTRD.VLR_COPAGOS,0) END) VLRCOPAGOS,
			SUM(FTRD.VLR_SERVICI-CASE WHEN COALESCE(COPAGOS_CP,0)>0 THEN COALESCE(COPAGOS_CP,0) ELSE COALESCE(FTRD.VLR_COPAGOS,0) END)VR_TOTAL
			FROM FTRD LEFT JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
						LEFT JOIN PRE ON SER.PREFIJO=PRE.PREFIJO
						LEFT JOIN PLN ON FTRD.REFERENCIA=PLN.IDPLAN
			WHERE EXISTS('+
			' SELECT *  FROM   FTR                  WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
					AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
					AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
					AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
					AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
					AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
					AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
					AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
					AND    FTR.USUARIOFACTURA = CASE WHEN COALESCE('''+COALESCE(@USUARIOFACTU,'')+''','''')='''' THEN FTR.USUARIOFACTURA ELSE '''+COALESCE(@USUARIOFACTU,'')+''' END 
					' +@PART+@ESTFTR+
			' AND FTR.N_FACTURA=FTRD.N_FACTURA)
			AND FTRD.PREFIJO = CASE WHEN COALESCE('''+COALESCE(@PREFIJO,'')+''','''')='''' THEN FTRD.PREFIJO ELSE '''+COALESCE(@PREFIJO,'')+''' END 
			GROUP BY  FTRD.PREFIJO, COALESCE(PRE.NOM_PREFIJO,PLN.DESCPLAN)'
			SELECT 'OK' OK
			EXECUTE(@SQL)
		END
		IF UPPER(@PROCESO) ='IDAREA'
		BEGIN
			PRINT 'INGRESO A IDAREA'
			SELECT @SQL=
			' SELECT FTRD.AREAPRESTACION,AFU.DESCRIPCION,FTRD.CCOSTO,CEN.DESCRIPCION AS DESCRIPCION_CCOSTO,FTRD.N_FACTURA,SUM(COALESCE(FTRD.VLR_SERVICI,0)) VALORSERVICIOS,
			SUM(CASE WHEN COALESCE(COPAGOS_CP,0)>0 THEN COALESCE(COPAGOS_CP,0) ELSE COALESCE(FTRD.VLR_COPAGOS,0) END) VLRCOPAGOS,
			SUM(FTRD.VLR_SERVICI-CASE WHEN COALESCE(COPAGOS_CP,0)>0 THEN COALESCE(COPAGOS_CP,0) ELSE COALESCE(FTRD.VLR_COPAGOS,0) END)VR_TOTAL
			FROM FTRD LEFT JOIN AFU ON FTRD.AREAPRESTACION=AFU.IDAREA
						LEFT JOIN CEN ON FTRD.CCOSTO=CEN.CCOSTO
			WHERE EXISTS('+
			' SELECT *  FROM   FTR                  WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
					AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
					AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
					AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
					AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
					AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
					AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
					AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
					AND    FTR.USUARIOFACTURA = CASE WHEN COALESCE('''+COALESCE(@USUARIOFACTU,'')+''','''')='''' THEN FTR.USUARIOFACTURA ELSE '''+COALESCE(@USUARIOFACTU,'')+''' END 
					' +@PART+@ESTFTR+
			' AND FTR.N_FACTURA=FTRD.N_FACTURA)
			AND FTRD.AREAPRESTACION = CASE WHEN COALESCE('''+COALESCE(@AREAFUNCIONAL,'')+''','''')='''' THEN FTRD.AREAPRESTACION ELSE '''+COALESCE(@AREAFUNCIONAL,'')+''' END 
			GROUP BY  FTRD.AREAPRESTACION, AFU.DESCRIPCION,FTRD.CCOSTO,CEN.DESCRIPCION,FTRD.N_FACTURA'
			SELECT 'OK' OK
			EXECUTE(@SQL)
		END
		IF UPPER(@PROCESO) ='SERVICIO'
		BEGIN
			PRINT 'INGRESO A SERVICIO'
			SELECT @SQL=
			' SELECT FTRD.REFERENCIA,FTRD.ANEXO,SUM(FTRD.CANTIDAD)CANTIDAD,SUM(COALESCE(FTRD.VALOR,0)) VLR_UNITARIO,SUM(FTRD.CANTIDAD*COALESCE(FTRD.VALOR,1))VLR_BRUTO,
			SUM(CASE WHEN COALESCE(COPAGOS_CP,0)>0 THEN COALESCE(COPAGOS_CP,0) ELSE COALESCE(FTRD.VLR_COPAGOS,0) END) VLRCOPAGOS,
			SUM(FTRD.VLR_SERVICI-CASE WHEN COALESCE(COPAGOS_CP,0)>0 THEN COALESCE(COPAGOS_CP,0) ELSE COALESCE(FTRD.VLR_COPAGOS,0) END)VR_TOTAL
			FROM FTRD 
			WHERE EXISTS('+
			' SELECT *  FROM   FTR                  WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
					AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
					AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
					AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
					AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
					AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
					AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
					AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
					AND    FTR.USUARIOFACTURA = CASE WHEN COALESCE('''+COALESCE(@USUARIOFACTU,'')+''','''')='''' THEN FTR.USUARIOFACTURA ELSE '''+COALESCE(@USUARIOFACTU,'')+''' END 
					' +@PART+@ESTFTR+
			' AND FTR.N_FACTURA=FTRD.N_FACTURA)
			AND FTRD.REFERENCIA = CASE WHEN COALESCE('''+COALESCE(@IDSERVICIO,'')+''','''')='''' THEN FTRD.REFERENCIA ELSE '''+COALESCE(@IDSERVICIO,'')+''' END 
			GROUP BY  FTRD.REFERENCIA, FTRD.ANEXO
			ORDER BY FTRD.REFERENCIA'
			SELECT 'OK' OK
			EXECUTE(@SQL)
		END
		IF UPPER(@PROCESO) IN('TODO','ANULADAS','NOTASCR')
		BEGIN
			SELECT @SQL=
			'SELECT FTR.IDTERCERO, TER.NIT,TER.RAZONSOCIAL,FTR.IDPLAN,PLN.DESCPLAN,COALESCE(FTR.TIPOTTEC,''SINTTEC'')TIPOTTEC,COALESCE(TTEC.DETALLE,''NO DEFINIDO'')DETALLE,
				FTR.USUARIOFACTURA,USUSU.NOMBRE,FTR.IDSEDE,SED.DESCRIPCION AS NOMBRE_SEDE, FTR.N_FACTURA,CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,FTR.PROCEDENCIA,AFI.DOCIDAFILIADO,AFI.NOMBREAFI,
			FTR.VALORSERVICIOS,FTR.VALORCOPAGO AS VALORCOPAGO, 
			FTR.VALORPCOMP VALOR_PCOMP, FTR.DESCUENTO DESCUENTO, FTR.VALORSERVICIOS-FTR.DESCUENTO-FTR.VALORPCOMP-FTR.VALORCOPAGO VR_TOTAL,
			CASE WHEN FTR.ESTADO=''P'' AND COALESCE(TIPOANULACION,'''')<>''NC'' THEN ''ACTIVA'' ELSE ''ANULADA'' END ESTADO,
			CASE COALESCE(FTR.FACTE,0) WHEN 0 THEN ''SINENVIAR'' WHEN 1 THEN ''ENCOLA'' WHEN 2 THEN ''NOTIFICADA'' WHEN 3 THEN ''CONERROR''
			WHEN 4 THEN ''NOTIFICADA'' ELSE ''OTRO'' END ESTADODIAN,FTR.CONTABILIZADADXC,FTR.NROCOMPROBANTE 
			FROM   FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
						LEFT  JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
						LEFT  JOIN AFI ON FTR.IDAFILIADO=AFI.IDAFILIADO
						LEFT  JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
						LEFT  JOIN TTEC ON FTR.TIPOTTEC=TTEC.TIPO
						LEFT  JOIN SED ON FTR.IDSEDE=SED.IDSEDE
			WHERE  FTR.N_FACTURA NOT IN (SELECT N_FACTURA FROM #FTR)
			AND    F_FACTURA >= '''+CONVERT(VARCHAR(10),@F_INICIAL,103)+'''
			AND    F_FACTURA <  '''+CONVERT(VARCHAR(10),@F_FINAL + 1,103)+'''
			AND    COALESCE(FTR.IDSEDE,'''') = CASE  WHEN '''+COALESCE(@IDSEDEF,'Todas')+'''<>''Todas'' THEN '''+COALESCE(@IDSEDEF,'Todas')+''' ELSE COALESCE(FTR.IDSEDE,'''') END
			AND    FTR.PROCEDENCIA = CASE WHEN COALESCE('''+COALESCE(@PROCEDENCIA,'Todas')+''',''Todas'')=''Todas'' THEN FTR.PROCEDENCIA ELSE '''+COALESCE(@PROCEDENCIA,'Todas')+''' END 
			AND    FTR.IDTERCERO = CASE WHEN COALESCE('''+COALESCE(@IDTERCERO,'')+''','''')='''' THEN FTR.IDTERCERO ELSE '''+COALESCE(@IDTERCERO,'')+''' END 
			AND    FTR.IDPLAN = CASE WHEN COALESCE('''+COALESCE(@IDPLAN,'')+''','''')='''' THEN FTR.IDPLAN ELSE '''+COALESCE(@IDPLAN,'')+''' END 
			AND    FTR.TIPOTTEC = CASE WHEN COALESCE('''+COALESCE(@TERCONTABLE,'')+''','''')='''' THEN FTR.TIPOTTEC ELSE '''+COALESCE(@TERCONTABLE,'')+''' END 
			AND    FTR.USUARIOFACTURA = CASE WHEN COALESCE('''+COALESCE(@USUARIOFACTU,'')+''','''')='''' THEN FTR.USUARIOFACTURA ELSE '''+COALESCE(@USUARIOFACTU,'')+''' END 
			' +@PART+@ESTFTR
			PRINT @SQL
			SELECT 'OK' OK
			EXECUTE(@SQL)
		END
	END   
END



