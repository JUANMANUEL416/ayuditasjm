IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_NIEPED' AND TYPE='V')
BEGIN
   DROP VIEW VWK_NIEPED
END
GO
CREATE VIEW DBO.VWK_NIEPED
AS
SELECT CONSECUTIVO=CONCAT(A.ANO,A.MES), A.NUMDOC, 
    NCON.CODCONCEPTO, NCON.DESCRIPCION, NCON.TIPO, NCON.ID_DIAN, 
    VALOR=CONVERT(DECIMAL(14,2),SUM(COALESCE(B.VALOR,0)+ CASE WHEN TGEN.CODIGO IN('Cesantia','PrimaS','InteresesCesantias', 'VacacionesComunes') THEN COALESCE(B.VALOR_APORTES,0) ELSE 0 END)),
    HORAS=(CASE 
            WHEN (SELECT MAX(IIF(ISNULL(AFECTAHORAS,0)=0,1,0)) FROM NEVE WHERE NEVE.CODCONCEPTO=NCON.CODCONCEPTO)=1 AND MAX(TGEN.DESCRIPCION) NOT LIKE '%recargo%'
             THEN IIF(NCON.TIPO='Egreso', -SUM(B.CANTIDAD), SUM(B.CANTIDAD))
            WHEN NCON.ID_DIAN='PagoS' 
             THEN IIF(NCON.TIPO='Egreso', -SUM(B.CANTIDAD), SUM(B.CANTIDAD))
           ELSE 0 END),
    CANTIDAD=SUM(B.CANTIDAD)
FROM NIEPE AS A
    INNER JOIN NIEPED AS B ON B.CNSNIEPE=A.CNSNIEPE AND A.NUMDOC=B.NUMDOC --AND ISNULL(B.VALOR,0)>0 OR COALESCE(B.VALOR_APORTES,0)>0
    INNER JOIN NOMI ON NOMI.CODNOMINA=A.CODNOMINA AND ISNULL(NOMI.REPORTA,0)=1
    INNER JOIN NCON ON NCON.CODCONCEPTO=B.CODCONCEPTO
    INNER JOIN TGEN ON TGEN.TABLA='FDIAN' AND TGEN.CAMPO='CONCEPTOSNOMINA' AND TGEN.CODIGO=NCON.ID_DIAN
WHERE CASE WHEN TGEN.CODIGO IN('Cesantia','PrimaS','InteresesCesantias', 'VacacionesComunes') THEN (ISNULL(B.VALOR,0) + COALESCE(B.VALOR_APORTES,0)) ELSE  ISNULL(B.VALOR,0) END >0
GROUP BY CONCAT(A.ANO,A.MES), A.NUMDOC, NCON.CODCONCEPTO, NCON.DESCRIPCION, NCON.TIPO, NCON.ID_DIAN



