CREATE OR ALTER PROCEDURE DBO.SPK_NC_CONTAB_CIERRE_CAJ 
@CNSACJ VARCHAR(20),
@IDSEDE VARCHAR(20),
@SYS_COMPUTERNAME VARCHAR(255),
@NROCOMPROBANTE VARCHAR(20)
WITH ENCRYPTION
AS  
DECLARE @COM             VARCHAR(6)  
DECLARE @NOREFERENCIA    VARCHAR(20)  
DECLARE @ANO             VARCHAR(4)  
DECLARE @MES             INT  
DECLARE @IDMODELOCONT    VARCHAR(2)
DECLARE @PREFIJO_USCXS   VARCHAR(10) 
DECLARE @PROCESO         VARCHAR(12) 
DECLARE @COMPANIA VARCHAR(2)='01'
DECLARE @FECHATRA DATETIME
DECLARE @CODCAJA VARCHAR(10)
DECLARE @CODCAJERO VARCHAR(20)
DECLARE @USUARIO VARCHAR(20)
BEGIN  
   PRINT 'EMPIEZO'

   SET @IDMODELOCONT = DBO.FNK_VALORVARIABLE('IDMODELOCONTABLE')
 
   SELECT @ANO        = YEAR(FECHACIERRE),  
          @MES        = MONTH(FECHACIERRE),  
          @FECHATRA   = DBO.FNK_FECHA_SIN_MLS(FECHACIERRE),
          @CODCAJERO    = CODCAJERO
   FROM   ACJ
   WHERE CNSACJ=@CNSACJ

   SELECT @USUARIO=USUARIO FROM USUSU WHERE CODCAJERO=@CODCAJERO
    
   IF NOT EXISTS(SELECT COMPANIA,ANO,MES FROM PRI WHERE COMPANIA=@COMPANIA AND ANO=@ANO AND MES=@MES)  
   BEGIN
      RAISERROR('Período Contable No Existe', 16, 1)
      RETURN
   END 
   IF NOT EXISTS(SELECT COMPANIA,ANO,MES FROM PRI WHERE COMPANIA=@COMPANIA AND ANO=@ANO AND MES=@MES AND CERRADO=0)  
   BEGIN
      RAISERROR('Período Contable Cerrado, No se Puede Continuar', 16, 1)
      RETURN
   END 
   IF ISNULL(@NROCOMPROBANTE,'') = '' 
   BEGIN  
      PRINT 'Generando Consecutivo...'  
      SET @NROCOMPROBANTE = SPACE(20) -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
      EXEC SPK_GENCONSECUTIVO @COMPANIA,@IDSEDE,'@MCP',@NROCOMPROBANTE OUTPUT -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
      PRINT '@NROCOMPROBANTE:' + ISNULL(@NROCOMPROBANTE,'') -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
      SELECT @NROCOMPROBANTE = @IDSEDE + REPLACE(SPACE(8 - CASE WHEN LEN(@NROCOMPROBANTE) > 8 THEN 8 ELSE LEN(@NROCOMPROBANTE) END)+LTRIM(RTRIM(@NROCOMPROBANTE)),SPACE(1),0) -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
      PRINT '@NROCOMPROBANTE:' + ISNULL(@NROCOMPROBANTE,'') -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
      SET @COM = ''
      SET @COM= DBO.FNK_VALORVARIABLE('IDCON_TCOM_ECAJ')
      IF NOT EXISTS(SELECT COMPROBANTE FROM COM WHERE COMPROBANTE = @COM AND COMPANIA = @COMPANIA )  
      BEGIN
         SET @COM = DBO.FNK_VALORVARIABLE('IDCON_TCOM_DEFAULT')             
      END
      IF NOT EXISTS(SELECT COMPROBANTE FROM COM WHERE COMPROBANTE = @COM AND COMPANIA = @COMPANIA )  
      BEGIN
         SET @COM = 'IX'  
      END  
      SET @PREFIJO_USCXS = '@COM'+@COM  
      SET @NOREFERENCIA  = SPACE(20)  
         
      EXEC SPK_GENCONSECUTIVO @COMPANIA,@IDSEDE,@PREFIJO_USCXS,@NOREFERENCIA OUTPUT     
      SELECT @NOREFERENCIA = REPLACE(SPACE(8 - LEN(@NOREFERENCIA))+LTRIM(RTRIM(@NOREFERENCIA)),SPACE(1),0)  
      PRINT 'Nuevo Comprobante: '+@COM+' '+@NOREFERENCIA  
               
      PRINT 'Comprobante Contable (MCPE)'  
      INSERT INTO MCPE(NROCOMPROBANTE, COMPANIA, PROCEDENCIA, NOREFERENCIA, ANO, MES, FECHACONTABLE, TOTALDEBITO,  
                       TOTALCREDITO, REFERENCIA1, REFERENCIA2, USUARIO, FECHA, LOTE, OBSERVACION, IDSEDE, ESTADO,  
                       COMPROBANTE, IDTERCERO, BANCO, NOCHEQUE, ANULADO, RPT_COMPROBANTE)  
      SELECT @NROCOMPROBANTE, @COMPANIA, 'CAJA', @NOREFERENCIA, @ANO, @MES, DBO.FNK_FECHA_SIN_MLS(FECHACIERRE),  
             0, 0, @CNSACJ, @CODCAJA, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), NULL,   
             'CIERRE DE CAJA NRO.:'+CODCAJA+' CONSECUTIVO: '+CNSACJ+' CAJERO:'+LTRIM(RTRIM(CJR.DESCRIPCION)), @IDSEDE, 0, @COM,
             DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO'),'','',0,'EGRESO'   
      FROM ACJ INNER JOIN CJR ON ACJ.CODCAJERO=CJR.CODCAJERO
      AND ACJ.CNSACJ=@CNSACJ
   END  
   ELSE  
   BEGIN  
      IF EXISTS(SELECT * FROM MCP WHERE NROCOMPROBANTE=@NROCOMPROBANTE AND ESTADO=2 AND COALESCE(ANULADO,0)<>1)
      BEGIN
         RAISERROR('Comprobante Contabilizado, No se puede Continuar', 16, 1)
         RETURN
      END
      IF NOT EXISTS(SELECT * FROM MCPE WHERE NROCOMPROBANTE=@NROCOMPROBANTE)
      BEGIN
         INSERT INTO MCPE(NROCOMPROBANTE, COMPANIA, PROCEDENCIA, NOREFERENCIA, ANO, MES, FECHACONTABLE, TOTALDEBITO,  
                           TOTALCREDITO, REFERENCIA1, REFERENCIA2, USUARIO, FECHA, LOTE, OBSERVACION, IDSEDE, ESTADO,  
                           COMPROBANTE, IDTERCERO, BANCO, NOCHEQUE, ANULADO, RPT_COMPROBANTE)  
         SELECT NROCOMPROBANTE, COMPANIA, PROCEDENCIA, NOREFERENCIA, ANO, MES,FECHACONTABLE,  
                  TOTALDEBITO, TOTALCREDITO, REFERENCIA1, REFERENCIA2, USUARIO, FECHA, LOTE,   
                  LEFT(OBSERVACION,512), IDSEDE, ESTADO, COMPROBANTE,IDTERCERO,BANCO,NOCHEQUE,ANULADO,RPT_COMPROBANTE   
         FROM MCP
         WHERE NROCOMPROBANTE=@NROCOMPROBANTE              
      END
      DELETE MCHE WHERE NROCOMPROBANTE = @NROCOMPROBANTE  
      SELECT @COM=COMPROBANTE,@NOREFERENCIA=NOREFERENCIA FROM MCP WHERE NROCOMPROBANTE=@NROCOMPROBANTE  
      DELETE MCH  WHERE NROCOMPROBANTE=@NROCOMPROBANTE  
      IF (SELECT COUNT(*) FROM MCP WHERE NROCOMPROBANTE = @NROCOMPROBANTE) > 0
      BEGIN
         DELETE MCP WHERE MCP.NROCOMPROBANTE=@NROCOMPROBANTE   
      END
   END  
   PRINT 'AGREGO LOS DETALLES RECLASIFICANDO LOS COMPROBANTES'
   INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,    
                    REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,  
                    CNSPAGO,N_FACTURA,F_FACTURAREF,F_VENCE,GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG) 
   SELECT  @NROCOMPROBANTE,MCH.COMPANIA,CASE WHEN  MCH.TIPO='DB' THEN 'CR' ELSE 'DB' END,MCH.CUENTA,MCH.IDTERCERO,MCH.CCOSTO,
           'RECLASIFICACION DE TERCERO Y DOCUMENTO  CIERE DE CAJA',VALOR,MCH.REFERENCIA1,    
                       MCH.REFERENCIA2,MCH.REFERENCIA3,ITEMREF,@USUARIO,DBO.FNK_GETDATE(),PREFIJO,IDAREA,MCH.CLASECONT,1,PROCESO,  
                       CNSPAGO,MCH.N_FACTURA,F_FACTURAREF,F_VENCE,GENERA,MCH.PROCEDENCIA, REFERENCIA_PRO, MCH.CODUNG, MCH.CODPRG
   FROM FCJ INNER JOIN CAJ ON FCJ.CODCAJA=CAJ.CODCAJA 
            INNER JOIN MCP ON FCJ.NROCOMPROBANTE=MCP.NROCOMPROBANTE
            INNER JOIN MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE AND MCH.CUENTA=CAJ.CUENTA
   WHERE FCJ.CNSACJ=@CNSACJ
   AND MCP.ESTADO=2
   AND COALESCE(MCP.ANULADO,0) <> 1
   AND FCJ.CONTABILIZADA = 1

   UPDATE ACJ SET CONTABILIZADA=1,NROCOMPROBANTE=@NROCOMPROBANTE WHERE CNSACJ=@CNSACJ

    EXEC SPK_NC_SUMA_DBCR @NROCOMPROBANTE

    DECLARE @DIFERENCIAJ DECIMAL(14,2)
    SELECT @DIFERENCIAJ = ABS(TOTALCREDITO-TOTALDEBITO) FROM MCPE WHERE NROCOMPROBANTE=@NROCOMPROBANTE
    PRINT'DIFERENCIA ANTES DE AJUSTE CENTAVOS '+LTRIM(RTRIM(STR(@DIFERENCIAJ)))

   IF @DIFERENCIAJ>0 AND @DIFERENCIAJ <2.00
   BEGIN
	   PRINT 'SI ENTRO  A BALANCEO DE CENTAVOS...'
      EXEC SPK_NC_BALANCEO_CENTAVOS @NROCOMPROBANTE
   END

   EXEC SPK_NC_REVISAMCPE @NROCOMPROBANTE, @COMPANIA, @USUARIO, @IDSEDE, @SYS_COMPUTERNAME      
   EXEC SPK_PASA_MCP_MCPNIIF @NROCOMPROBANTE, @COMPANIA, @USUARIO, @SYS_COMPUTERNAME, @IDSEDE,@COM,'' 


END 




