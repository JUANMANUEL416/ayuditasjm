USE KMASMENTE

SELECT TOP 50 * FROM API_LOG WHERE USUARIO='1040734894' ORDER BY ITEM DESC

{"MODELO":"FTR_COL","METODO":"MARCATODOMASI","PARAMETROS":{"DATOS":{"F_INIMAS":"2023-07-01","F_FINMAS":"2024-02-09","IDTERMAS":"0100000027","NITFMAS":"900294794","RAZONSOC":"COMITE DE ESTUDIOS MEDICOS SAS","IDPLANMAS":"MENTE","DESPLANMAS":"MENTE PLENA","PROCE":"CIT","SEDEFMAS":"01","FACTURABLE":true,"MARCADOS":false},"ACCION":"2","CNSFACT":null},"USUARIO":"1040734894"}
{"MODELO":"FTR_COL","METODO":"FACTURAR_MASI","PARAMETROS":{"DATOS":{"F_INIMAS":"2023-07-01","F_FINMAS":"2024-02-09","IDTERMAS":"0100000027","NITFMAS":"900294794","RAZONSOC":"COMITE DE ESTUDIOS MEDICOS SAS","IDPLANMAS":"MENTE","DESPLANMAS":"MENTE PLENA","PROCE":"CIT","SEDEFMAS":"01","FACTURABLE":true,"MARCADOS":false},"ACCION":"4","CNSFACT":"0100004714"},"USUARIO":"1040734894"}


SELECT  * FROM CIT WHERE CNSFACT='0100004716' AND TIPODTO IS NULL

SELECT CONSECUTIVO INTO #B
      FROM   CIT INNER JOIN SER ON SER.IDSERVICIO  = CIT.IDSERVICIO 
                  LEFT JOIN TER ON CIT.IDTERCEROCA = TER.IDTERCERO
      WHERE  CIT.IDTERCEROCA = '0100000027' AND (CIT.FACTURADA = 0 OR CIT.FACTURADA IS NULL) AND CIT.MARCAFAC = 1 AND CIT.CNSFACT = '0100004716' AND COALESCE(CIT.FACTURABLE,0) = 1
         AND (TER.IDTERCERO = '0100000027' OR (TER.IDTERCERO IS NULL AND '0100000027'='0100000027'))
	      AND CIT.IDAFILIADO = CASE '' WHEN 'CUE' THEN '' ELSE CIT.IDAFILIADO END

         SELECT FACTURABLE,VALORTOTAL,CUMPLIDA, *
   FROM CIT LEFT JOIN 
        TER ON CIT.IDTERCEROCA=TER.IDTERCERO
   WHERE CIT.IDTERCEROCA = '0100000027' AND (CIT.FACTURADA = 0 OR CIT.FACTURADA IS NULL) AND CIT.MARCAFAC = 1 AND CIT.CNSFACT = '0100004716'
   AND   COALESCE(FACTURABLE,0)=1 
   AND   ((COALESCE(VALORTOTAL,0)>0 AND '' <> 'CUE') OR (COALESCE(VALORTOTAL,0) = COALESCE(VALORTOTAL,0) AND '' =  'CUE')) 
   AND   COALESCE(CIT.DESCUENTO,0)<CASE WHEN CIT.TIPODTO='P' THEN 100 ELSE CIT.VALORTOTAL END
   AND   (TER.IDTERCERO = (CASE WHEN '0100000027'='' THEN TER.IDTERCERO ELSE '0100000027' END) OR
          (TER.IDTERCERO IS NULL AND '0100000027'='0100000027' AND '0100000027'<>'') OR
          (TER.IDTERCERO IS NULL AND '0100000027'=''))
   AND   CIT.IDAFILIADO = CASE '' WHEN 'CUE' THEN '' ELSE CIT.IDAFILIADO END


   BEGIN TRAN
   EXEC SPQ_JSON'{"MODELO":"FTR_COL","METODO":"FACTURAR_MASI","PARAMETROS":{"DATOS":{"F_INIMAS":"2023-07-01","F_FINMAS":"2024-02-09","IDTERMAS":"0100000027","NITFMAS":"900294794","RAZONSOC":"COMITE DE ESTUDIOS MEDICOS SAS","IDPLANMAS":"MENTE","DESPLANMAS":"MENTE PLENA","PROCE":"CIT","SEDEFMAS":"01","FACTURABLE":true,"MARCADOS":false},"ACCION":"4","CNSFACT":"0100004716"},"USUARIO":"1040734894"}'
   ROLLBACK

SELECT  ID = ROW_NUMBER() OVER (ORDER BY IDAFILIADO, NOADMISION, NOPRESTACION, NOITEM),                               
IDAFILIADO,DOCIDAFILIADO,PACIENTE,PROCEDENCIA,NOADMISION,IDSERVICIO,DESCSERVICIO,FECHA,                               
CONVERT(DECIMAL(14,2),VALORTOTAL)VALORTOTAL,CONVERT(DECIMAL(14,2),VALORCOPAGO)VALORCOPAGO,                               
CONVERT(DECIMAL(14,2),VALOREXCEDENTE)VALOREXCEDENTE,MARCAFAC,USUMARCA, NOPRESTACION, NOITEM,
CNSFACT,COALESCE(NOAUTORIZACION,'')NOAUTORIZACION                               ,
IDTERCEROCA AS IDTERCERO,RAZONSOCIAL,IDPLAN,NOMPLAN AS DESCPLAN,CANTIDAD,TIPOCOPAGO,IDSEDE,CODUNG   
FROM [dbo].[VWK_CARGOS_HADMAUTCIT] 
WHERE (PROCEDENCIA LIKE '%%%%' OR PACIENTE LIKE '%%%%' OR DOCIDAFILIADO LIKE '%%%%' OR  NOADMISION LIKE '%%%%') 
AND  COALESCE(FACTURADA,0) = 0    AND CONVERT(DATE, FECHA) >=  '2023-07-01' 
AND CONVERT(DATE, FECHA) <=  '2024-02-09' AND IDTERCERO=  '0100000027' 
AND IDPLAN=  'MENTE' AND IDSEDE = '01' AND PROCEDENCIA = 'CIT'
AND COALESCE(NOCOBRABLE,0)=0   
ORDER BY IDAFILIADO, NOADMISION, NOPRESTACION, NOITEM OFFSET (1-1)*200 
ROWS  FETCH NEXT 200 ROWS ONLY 

SELECT NOADMISION INTO #A
FROM [dbo].[VWK_CARGOS_HADMAUTCIT] 
WHERE (PROCEDENCIA LIKE '%%%%' OR PACIENTE LIKE '%%%%' OR DOCIDAFILIADO LIKE '%%%%' OR  NOADMISION LIKE '%%%%') 
AND  COALESCE(FACTURADA,0) = 0    AND CONVERT(DATE, FECHA) >=  '2023-07-01' 
AND CONVERT(DATE, FECHA) <=  '2024-02-09' AND IDTERCERO=  '0100000027' 
AND IDPLAN=  'MENTE' AND IDSEDE = '01' AND PROCEDENCIA = 'CIT'
AND COALESCE(NOCOBRABLE,0)=0   
ORDER BY IDAFILIADO, NOADMISION, NOPRESTACION, NOITEM OFFSET (1-1)*200 
ROWS  FETCH NEXT 200 ROWS ONLY 

SELECT  * FROM #B WHERE NOT EXISTS(SELECT * FROM #A WHERE #B.CONSECUTIVO=#A.NOADMISION)


SELECT IDCONTRATANTE,IDTERCEROCA,  * FROM CIT WHERE CONSECUTIVO IN(SELECT  * FROM #B WHERE NOT EXISTS(SELECT * FROM #A WHERE #B.CONSECUTIVO=#A.NOADMISION))

select  * from ter where IDTERCERO='0100000120'

UPDATE CIT SET IDCONTRATANTE=IDTERCEROCA WHERE CONSECUTIVO IN(SELECT  * FROM #B WHERE NOT EXISTS(SELECT * FROM #A WHERE #B.CONSECUTIVO=#A.NOADMISION))