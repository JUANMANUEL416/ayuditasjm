IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='SPK_CALCULAR_RETIROS' AND XTYPE='P')
BEGIN
   DROP PROCEDURE SPK_CALCULAR_RETIROS
END
GO
CREATE PROCEDURE DBO.SPK_CALCULAR_RETIROS
@CNSPAGO  VARCHAR(20),
@NUMDOR   VARCHAR(20)
WITH ENCRYPTION
AS
DECLARE @NUMDOC          VARCHAR(20), @CODCONCEPTO VARCHAR(20)
DECLARE @FECHAINI        DATETIME    
DECLARE @FECHAFIN        DATETIME  
DECLARE @FECHARET        DATETIME  
DECLARE @CODNOMINA       VARCHAR(2)
DECLARE @PTOPE           DECIMAL(14,6)  
DECLARE @NIVEL           VARCHAR(10)    
DECLARE @GRADO           VARCHAR(10)  
DECLARE @CODCARGO        VARCHAR(20)
DECLARE @CODPLANTA       VARCHAR(20)  
DECLARE @NCONINFO        VARCHAR(2)
DECLARE @ITEM            VARCHAR(8)  
DECLARE @HORAS_LAB           INT  
DECLARE @DIAS_LAB            INT  
DECLARE @DIASP               INT, @VALCONCEPTO DECIMAL(14,2) 
DECLARE @DIASLABT            INT
/*//SE AGREGA VARIABLE PARA CALCULO DE 12 MESES*/
DECLARE @DIASFAL			 INT 
-------
DECLARE @DIASLABA            INT
DECLARE @MESESLAB            INT
DECLARE @VLR_LIQUI       DECIMAL(14,2)
DECLARE @ENERO           DATETIME
DECLARE @VLRDIA          DECIMAL(14,2)
DECLARE @VLRNUEVO        DECIMAL(14,2)
DECLARE @MESRET          INT
DECLARE @JULIO            DATETIME
DECLARE @DIASPS           DATETIME
DECLARE @DIASVAC          INT
DECLARE @FPAGOVAC         DATETIME
DECLARE @FECHAING         DATETIME
DECLARE @DIARETIRO        INT
DECLARE @DIAINGRESO		  INT
DECLARE @MESESLABA		  INT	
DECLARE @CANTI            INT	
DECLARE @VALORD           DECIMAL(14,2)
DECLARE @DETALLE          VARCHAR(20)
DECLARE @COMPANIA	VARCHAR (2)
DECLARE @SEDE	VARCHAR (5)
DECLARE @ANO	VARCHAR (4)
DECLARE @MES	VARCHAR (2)
DECLARE @CODPAGO	VARCHAR (5)
DECLARE @USUARIO	VARCHAR (12)
DECLARE @SYS_COMPUTERNAME	VARCHAR (255)
DECLARE @NUMDOCVAC VARCHAR(20)
DECLARE @ITEMVAC INT
DECLARE @DIASF DECIMAL(7,4)
DECLARE @VACA VARCHAR(20)
DECLARE @CNSNEMPVD VARCHAR(20)
DECLARE @DIASR DECIMAL(7,4)
DECLARE @INDEMNIZA BIT
DECLARE @PERINDEM VARCHAR(10)
DECLARE @SMLV DECIMAL(14,2)
DECLARE @BASICO DECIMAL(14,2)
DECLARE @BASICOT DECIMAL(14,2)
DECLARE @DIASINDEMENOR INT 
DECLARE @DIASINDEMAYOR INT
DECLARE @RESIDUO INT 
DECLARE @POR_RESIDIO DECIMAL(7,2)
DECLARE @SI_INDEMNIZA BIT
DECLARE @MESEST INT
BEGIN
   PRINT 'INGRESE A RETIROS'
   IF (SELECT COUNT(*) FROM NEDIA WHERE CNSPAGO = @CNSPAGO AND IDEVENTO = 'RET' AND NUMDOC=CASE WHEN COALESCE(@NUMDOR,'')<>'' THEN @NUMDOR ELSE NUMDOC END) = 0 
   BEGIN
      PRINT 'SIN RETIROS EN EL MES'
      RETURN
   END
   IF  DBO.FNK_VALORVARIABLE('FORMALIQRETIROS')<>'OTRASIPS'
   BEGIN  
      SELECT  @ENERO=CAST('01-01-'+CAST(YEAR(GETDATE()) AS VARCHAR(4))AS DATETIME)
      SELECT @FECHAINI  = NPER.FECHAINI,   @FECHAFIN  = NPER.FECHAFIN,@FECHAINI=FECHAINI,  @CODNOMINA = NOMI.CODNOMINA,  
             @PTOPE     = NOMI.MAXADEDUCIR  
      FROM   NPER INNER JOIN NOMI ON NPER.CNSPAGO   = @CNSPAGO 
                                 AND NPER.CODNOMINA = NOMI.CODNOMINA 

      SET @HORAS_LAB = -1 -- Indica que la Base de las Horas a liquidar se toman del Item de Concepto (NCOND.HORAS)  
      SET @DIAS_LAB  = -1 -- Indica que la Base de los Dias a liquidar se toman del Item de Concepto (NCOND.DIAS) 

      DECLARE RET_C CURSOR  FOR
      SELECT NUMDOC, FECHAFIN FROM NEDIA WHERE CNSPAGO = @CNSPAGO AND IDEVENTO = 'RET' 
      AND NUMDOC=CASE WHEN COALESCE(@NUMDOR,'')<>'' THEN @NUMDOR ELSE NUMDOC END
      OPEN RET_C       
      FETCH NEXT FROM RET_C    
      INTO @NUMDOC, @FECHARET
      WHILE @@FETCH_STATUS = 0    
      BEGIN   
         PRINT 'NUMDOC= '+@NUMDOC
	     --PRINT 'ENERO= '+@ENERO 
         SELECT @CODCARGO = CODCARGO, @NIVEL = NIVEL, @GRADO = GRADO, @CODPLANTA = CODPLANTA FROM NEMP WHERE NUMDOC = @NUMDOC
         DECLARE CON_C CURSOR FOR
         SELECT CODCONCEPTO FROM NEVED WHERE IDEVENTO = 'RET'      
         AND    CODCONCEPTO NOT IN (SELECT CODCONCEPTO FROM NEMPFD_RUN WHERE CNSPAGO = @CNSPAGO AND NUMDOC = @NUMDOC) 
	     --AND    CODCONCEPTO = '014'  --BORRAR
         OPEN CON_C
         FETCH NEXT FROM CON_C
         INTO @CODCONCEPTO
         WHILE @@FETCH_STATUS = 0
         BEGIN
            PRINT 'RET CODCONCEPTO= ' + @CODCONCEPTO
		    PRINT 'RET HORAS LAB= '
		    PRINT  @HORAS_LAB 
		    PRINT 'RET DIAS LAB= '
		    PRINT  @DIAS_LAB 
            SELECT @NCONINFO = INFO FROM NCON WHERE CODCONCEPTO = @CODCONCEPTO
            SELECT @ITEM = ITEM FROM NEMPF WHERE CNSPAGO = @CNSPAGO AND NUMDOC = @NUMDOC
            --SELECT V.CODCONCEPTO, V.CODPLANTA, V.NUMDOC, V.ITEM, V.INFO
            INSERT INTO NEMPFD_RUN (NUMDOC, CNSPAGO, ITEM, CODCONCEPTO, DETALLE, CANTIDAD, VALOR, VALOR_EMPRESA, VALOR100P,   
                                    IDTRANSPRESTAMO, NUMDOCPRESTAMO, NUMCUOTA, CODPRF, IDTERCERO, INCLUIR_EXCLUIR, LIQUIDAR, INFO,   
                                    BASE_PRESTACIONES, ITEMCONCEPTO, VALHORASLAB, GENERANOVEFU, CODNOVEFU, BASE_CALCULO, TIPO)
            SELECT @NUMDOC, @CNSPAGO, @ITEM, @CODCONCEPTO, V.DETALLE, V.CANTIDAD, V.VALOR_EMPLEADO,   
                   V.VALOR_EMPRESA, V.VALOR100P, V.IDTRANSPRESTAMO, V.NUMDOCPRESTAMO, V.NUMCUOTA, V.CODPRF, V.IDTERCERO,   
                   'Automatica', 'Si', @NCONINFO, V.BASE_PRESTACIONES, V.ITEMCONCEPTO, 1, V.GENERANOVEFU, V.CODNOVEFU, V.BASE_CALCULO, 'Ingreso'
            FROM DBO.FNK_VALORCONCEPTO_NEMPFD_RUN_RET(@NUMDOC,@CODCONCEPTO,@FECHAINI,@FECHAFIN,@CNSPAGO,1, @HORAS_LAB, @DIAS_LAB) AS V  
            WHERE ( V.VALOR_EMPLEADO + V.VALOR_EMPRESA ) > 0  
         
            PRINT 'CAPTURANDO EL VALOR LIQUIDADO'
         
            SELECT @VLR_LIQUI= VALOR100P FROM NEMPFD_RUN WHERE CNSPAGO=@CNSPAGO AND NUMDOC=@NUMDOC 
            AND CODCONCEPTO=@CODCONCEPTO

            PRINT  '@VLR_LIQUI='+STR(@VLR_LIQUI)

            SELECT @VLRDIA=@VLR_LIQUI/360.00   
            PRINT '@VLRDIA ='+STR(@VLRDIA)

            SELECT @DIASLABT= DATEDIFF(DAY,FECHAING,@FECHARET),@MESESLABA=DATEDIFF(MONTH,@ENERO,@FECHARET),
                   @FECHAING=FECHAING
                   FROM FNK_INFO_NEMPHIS_NEMP(@FECHAFIN,@NUMDOC)
            IF @FECHAING>@ENERO
            BEGIN
               SELECT @ENERO=@FECHAING
            END
            IF DAY(@FECHARET+1)=1
            BEGIN
               SELECT @MESESLABA=DATEDIFF(MONTH,@ENERO,@FECHARET)
            END
            ELSE
            BEGIN
               SELECT @MESESLABA=DATEDIFF(MONTH,@ENERO,@FECHARET-@DIARETIRO)
            END

           SELECT @FPAGOVAC=CAST(CASE  WHEN DAY(@FECHAING)<10 THEN '0'+CAST(DAY(@FECHAING) AS VARCHAR(2)) ELSE CAST(DAY(@FECHAING) AS VARCHAR(2))END
                  +'/'+ CASE WHEN MONTH(@FECHAING)<10 THEN '0'+CAST(MONTH(@FECHAING) AS VARCHAR(2)) ELSE CAST(MONTH(@FECHAING) AS VARCHAR(2))END
                  +'/'+CAST(YEAR(GETDATE()) AS VARCHAR(4))  AS DATETIME)

                
		    SELECT @DIARETIRO=DAY(@FECHARET),@DIAINGRESO=DAY(@FECHAING)

		    SELECT @DIASLABA=DBO.FNK_DIASLABORADOS_LIQUIDACION(@ENERO,@FECHARET)

		    --PRIMA DE NAVIDAD 
            IF @CODCONCEPTO IN('043')
            BEGIN
               IF @DIASLABT>=180
               BEGIN
                  PRINT 'TIEMPO LABORADO MAYOR A 6 MESES' 
                  IF @DIAS_LAB>=360
                  BEGIN
                     PRINT 'TIEMPO LABORADO MAYOR AL A?O'
                     SELECT @VLRNUEVO=ROUND(@DIASLABA*@VLRDIA,0)
                     UPDATE  NEMPFD_RUN SET VALOR=@VLRNUEVO,VALOR100P=@VLRNUEVO WHERE CNSPAGO=@CNSPAGO AND NUMDOC=@NUMDOC 
                     AND CODCONCEPTO=@CODCONCEPTO                  
                  END
                  ELSE 
                  BEGIN
                     PRINT 'TIEMPO LABORADO MAYOR A 6 MESES MENOR A UN A?O'
                     SELECT @VLRNUEVO=ROUND(@DIASLABA*@VLRDIA,0)
                     UPDATE  NEMPFD_RUN SET VALOR=@VLRNUEVO,VALOR100P=@VLRNUEVO WHERE CNSPAGO=@CNSPAGO AND NUMDOC=@NUMDOC 
                     AND CODCONCEPTO=@CODCONCEPTO                                    
                  END
               END
               ELSE 
               BEGIN 
                  PRINT ' MENOR 180 DIAS NO LIQUIDAMOS SE BORRA'
                  DELETE FROM NEMPFD_RUN WHERE CNSPAGO=@CNSPAGO AND NUMDOC=@NUMDOC 
                  AND CODCONCEPTO=@CODCONCEPTO            
               END
            END
		    --PRIMA SEMESTRAL

            IF @CODCONCEPTO='044'
            BEGIN
               IF @DIASLABT>=180
               BEGIN
                  PRINT 'PRIMA SEMESTRAL'
                  PRINT 'VERIFICAMOS EL MES DE RETIRO'
                  SELECT @MESRET=MONTH(@FECHARET)
                  IF @MESRET < 7
                  BEGIN
                     SELECT  @JULIO=CAST('01/07/'+CAST(YEAR(GETDATE())-1 AS VARCHAR(4))AS DATETIME) 
                  END
                  ELSE
                  BEGIN
                     SELECT  @JULIO=CAST('01/07/'+CAST(YEAR(GETDATE()) AS VARCHAR(4))AS DATETIME)
                  END
                  IF DAY(@FECHARET+1)=1
                  BEGIN
                     SELECT @MESESLABA=DATEDIFF(MONTH,@JULIO,@FECHARET)
                  END
                  ELSE
                  BEGIN
                     SELECT @MESESLABA=DATEDIFF(MONTH,@JULIO,@FECHARET-@DIARETIRO)
                  END
			         SELECT @DIASLABA=DBO.FNK_DIASLABORADOS_LIQUIDACION(@JULIO,@FECHARET)
                  PRINT '@DIASLABA ='+STR(@DIASLABA)
                  PRINT  '@VLRDIA ='+STR(@VLRDIA)
                  
                  SELECT @VLRNUEVO=ROUND(@DIASLABA*@VLRDIA,0)
                  PRINT '@VLRNUEVO ='+STR(@VLRNUEVO)

                  UPDATE  NEMPFD_RUN SET VALOR=@VLRNUEVO,VALOR100P=@VLRNUEVO WHERE CNSPAGO=@CNSPAGO AND NUMDOC=@NUMDOC 
                  AND CODCONCEPTO=@CODCONCEPTO      
               END
               ELSE
               BEGIN
                  PRINT ' MENOR 180 DIAS NO LIQUIDAMOS SE BORRA'
                  DELETE FROM NEMPFD_RUN WHERE CNSPAGO=@CNSPAGO AND NUMDOC=@NUMDOC 
                  AND CODCONCEPTO=@CODCONCEPTO           
               END 
            END         
            IF @CODCONCEPTO IN('018','014','012','042')
            BEGIN
               PRINT 'VOY A LIQUIDAR VACACIONES'
               IF @FPAGOVAC<=@FECHARET
               BEGIN

                  SELECT @DIASLABA=DBO.FNK_DIASLABORADOS_LIQUIDACION(@FPAGOVAC,@FECHARET)

 
                  PRINT '@MESESLABA ='+STR(@MESESLABA)
			        -- SELECT @DIASLABA=(@MESESLABA*30)-CASE WHEN @DIAINGRESO>1 THEN @DIAINGRESO-1 ELSE 0 END+CASE WHEN  @DIARETIRO>30  THEN 30   ELSE @DIARETIRO END
                  PRINT '@DIASLABA = '+STR(@DIASLABA)
                  SELECT @VLRNUEVO=ROUND(@DIASLABA*@VLRDIA,0)
                  PRINT '@VLRNUEVO ='+STR(@VLRNUEVO)
			         IF @CODCONCEPTO='042'--VACACIONES
			         BEGIN
				         SELECT @VLRNUEVO=@VLRNUEVO
			         END
                  UPDATE  NEMPFD_RUN SET VALOR=@VLRNUEVO,VALOR100P=@VLRNUEVO WHERE CNSPAGO=@CNSPAGO AND NUMDOC=@NUMDOC 
                  AND CODCONCEPTO=@CODCONCEPTO   
                  END
               ELSE
               BEGIN
                  SELECT @MESESLABA=DATEDIFF(MONTH,@FPAGOVAC-360,@FECHARET+1)			   
			   /*//SE AGREGA CALCULO PARA QUE CALCULE 12 MESES CUANDO FALTE UN SOLO DIA PARA CUMPLIR UN A?O LABORADO*/			   
			      SELECT @DIASFAL =DATEDIFF (Day,@FPAGOVAC-360,@FECHARET)-360
			      ----
			      SELECT @DIASLABA=(CASE WHEN @DIASFAL>=1 AND @DIASFAL<5 THEN 12 ELSE  @MESESLABA END *30)-(30-@DIAINGRESO)+CASE WHEN  @DIARETIRO>30  THEN 0   ELSE @DIARETIRO END
 
                  SELECT @VLRNUEVO=ROUND(@DIASLABA*@VLRDIA,0)
                  UPDATE  NEMPFD_RUN SET VALOR=@VLRNUEVO,VALOR100P=@VLRNUEVO WHERE CNSPAGO=@CNSPAGO AND NUMDOC=@NUMDOC 
                  AND CODCONCEPTO=@CODCONCEPTO                
               END
            END
            FETCH NEXT FROM CON_C
            INTO @CODCONCEPTO
         END
         CLOSE CON_C
         DEALLOCATE CON_C
         FETCH NEXT FROM RET_C    
         INTO @NUMDOC, @FECHARET
      END
      CLOSE RET_C
      DEALLOCATE RET_C
   END
   ELSE
   BEGIN
      PRINT 'RETIRO DE OTRAS IPS'
      -- GENERO LA NOMINA PARA TRAER LAS PROVISIONES
      --SELECT * FROM NPER WHERE CNSPAGO='01201612P30-1'
      SELECT @SEDE=CEN.IDSEDE,@SYS_COMPUTERNAME=HOST_NAME()
      FROM NEMP INNER JOIN CEN ON NEMP.CCOSTO=CEN.CCOSTO
      WHERE NEMP.NUMDOC=@NUMDOR

      SELECT @COMPANIA='01',@CODNOMINA=CODNOMINA,@ANO=ANO,@MES=MES,@CODPAGO=CODPPAG,@USUARIO='Liquidador',@FECHARET=FECHAFIN,
      @FECHAINI=FECHAINI,@FECHAFIN=FECHAFIN 
      FROM NPER WHERE CNSPAGO=@CNSPAGO

       PRINT '@FECHARET ='+CONVERT(VARCHAR,COALESCE(@FECHARET,GETDATE()),102)


      PRINT '@FECHAING ='+ CONVERT(VARCHAR,COALESCE(@FECHAING,GETDATE()),102)

      PRINT 'GENERO LA NOMINA PARA SACAR LAS PROVISIONES.......'


      EXEC SPK_LIQUIDAR_NOMI @COMPANIA,@SEDE,@CODNOMINA,@ANO,@MES,@CODPAGO,@USUARIO,@SYS_COMPUTERNAME,@CNSPAGO

       EXEC SPK_PROCESO_VACACIONES @CNSPAGO,'ACTUALIZA',@NUMDOR
     -- RETURN
      PRINT 'REGRESO DE GENERAR LA NOMINA'
      DECLARE @NRODIAS DECIMAL(7,4)
      -- POR AHORA SE HARA CON BASE A LAS PROVISIONES, DEPENDIENTO LOS CAMBIOS
      DECLARE RET_EMP CURSOR  FOR
      SELECT NUMDOC,COALESCE(INDEMNIZA,0) FROM NEDIA WHERE CNSPAGO = @CNSPAGO AND IDEVENTO = 'RET' 
      AND NUMDOC=CASE WHEN COALESCE(@NUMDOR,'')<>'' THEN @NUMDOR ELSE NUMDOC END
      OPEN RET_EMP       
      FETCH NEXT FROM RET_EMP    
      INTO @NUMDOC,@SI_INDEMNIZA
      WHILE @@FETCH_STATUS = 0    
      BEGIN   
         PRINT 'NUMDOC= '+@NUMDOC
         SELECT @DIASLABT= DATEDIFF(DAY,FECHAING,@FECHARET),@FECHAING=FECHAING,@CANTI=HORASXCARGO,@BASICOT=BASICO,
         @BASICO=CONVERT(decimal(14,2),(BASICO/DIASXCARGO)) ,@MESESLABA=DATEDIFF(MONTH,FECHAING,@FECHARET) 
         FROM FNK_INFO_NEMPHIS_NEMP(@FECHARET,@NUMDOC)
         -- SE RETIRAN DE NIEPED YA QUE EL VALOR PUEDE CAMBIAR 

         DELETE NIEPED FROM  NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE AND NIEPE.NUMDOC=NIEPED.NUMDOC  
         WHERE NIEPE.CNSPAGO = @CNSPAGO AND NIEPED.NUMDOC = @NUMDOC 
         AND CODCONCEPTO IN(SELECT CODCONCEPTO FROM NEVED WHERE IDEVENTO = 'RET')

         DELETE NEMPFD_RUN WHERE CNSPAGO=@CNSPAGO 
         AND NUMDOC=@NUMDOC 
         AND CODCONCEPTO IN(SELECT CODCONCEPTO FROM NEVED WHERE IDEVENTO = 'RET')

         DELETE NEMPFD WHERE CNSPAGO=@CNSPAGO 
         AND NUMDOC=@NUMDOC 
         AND CODCONCEPTO IN(SELECT CODCONCEPTO FROM NEVED WHERE IDEVENTO = 'RET')


	     --PRINT 'ENERO= '+@ENERO 
         SELECT @CODCARGO = CODCARGO, @NIVEL = NIVEL, @GRADO = GRADO, @CODPLANTA = CODPLANTA 
         FROM NEMP WHERE NUMDOC = @NUMDOC
         DECLARE NOM_CON CURSOR FOR
         SELECT CODCONCEPTO,COALESCE(INDEMNIZA,0),COALESCE(PERINDEM,'') FROM NEVED WHERE IDEVENTO = 'RET'      
         AND    CODCONCEPTO NOT IN (SELECT CODCONCEPTO FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE AND NIEPE.NUMDOC=NIEPED.NUMDOC  
                                    WHERE NIEPE.CNSPAGO = @CNSPAGO AND NIEPED.NUMDOC = @NUMDOC) 
         OPEN NOM_CON
         FETCH NEXT FROM NOM_CON
         INTO @CODCONCEPTO,@INDEMNIZA,@PERINDEM
         WHILE @@FETCH_STATUS = 0
         BEGIN
             PRINT 'RET CODCONCEPTO= ' + @CODCONCEPTO
		       PRINT 'RET HORAS LAB= '
		       PRINT  @HORAS_LAB 
		       PRINT 'RET DIAS LAB= '
		       PRINT  @DIAS_LAB 
            SELECT @VALORD = 0
            SELECT @NCONINFO = INFO FROM NCON WHERE CODCONCEPTO = @CODCONCEPTO
            SELECT @ITEM = ITEM FROM NEMPF WHERE CNSPAGO = @CNSPAGO AND NUMDOC = @NUMDOC


            IF LTRIM(RTRIM(@CODCONCEPTO))=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('NOMICODCON_PRIMA')))
            BEGIN
               PRINT 'Liquidacion de primas .. Busco el Periodo...'
               
               PRINT 'RETIRO MARCAS'
               UPDATE NIEPED SET PAGADO=0,NUMDOCPRESTAMO=NULL
					FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
															AND NIEPE.NUMDOC=NIEPED.NUMDOC
					WHERE NIEPE.ANO=@ANO AND NIEPE.NUMDOC=@NUMDOC 
					AND MES>=1 
					AND MES< 13
				   AND COALESCE(NIEPED.PAGADO,0)=1 
               AND (NIEPED.NUMDOCPRESTAMO=@CNSPAGO OR NIEPED.NUMDOCPRESTAMO='')
					AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO)

				   SELECT @VALORD= SUM (NIEPED.VALOR_APORTES)
				   FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
														   AND NIEPE.NUMDOC=NIEPED.NUMDOC
				   WHERE NIEPE.ANO=@ANO AND NIEPE.NUMDOC=@NUMDOC 
				   AND MES>=CASE WHEN MONTH(@FECHARET)<7 THEN 1 ELSE 7 END 
				   AND MES<CASE WHEN  MONTH(@FECHARET)<7 THEN 7  ELSE 13 END
               AND COALESCE(NIEPED.PAGADO,0)=0 
				   AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO)

               PRINT 'VALOR DE LA PRIMA == '+STR(COALESCE(@VALORD,0))
               IF COALESCE(@VALORD,0)>0
               BEGIN
                  PRINT 'MARCANDO PAGADO'
                  UPDATE NIEPED SET PAGADO=1,NUMDOCPRESTAMO=@CNSPAGO
					   FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
															   AND NIEPE.NUMDOC=NIEPED.NUMDOC
					   WHERE NIEPE.ANO=@ANO AND NIEPE.NUMDOC=@NUMDOC 
					   AND MES>=1 
					   AND MES< 13
				      AND COALESCE(NIEPED.PAGADO,0)=0 
					   AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO)
               END
            END
            IF @CODCONCEPTO=DBO.FNK_VALORVARIABLE('NOMICODCON_CESAN')
            BEGIN
				   PRINT 'Liquidacion de CESANTIAS .. Busco el Periodo...'

               PRINT 'RETIRO MARCAS'
               UPDATE NIEPED SET PAGADO=0,NUMDOCPRESTAMO=NULL
				   FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
														   AND NIEPE.NUMDOC=NIEPED.NUMDOC
				   WHERE NIEPE.ANO=@ANO AND NIEPE.NUMDOC=@NUMDOC 
				   AND MES>=1 
				   AND MES< 13
				   AND COALESCE(NIEPED.PAGADO,0)=1 
               AND (NIEPED.NUMDOCPRESTAMO=@CNSPAGO OR NIEPED.NUMDOCPRESTAMO='')
				   AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO)

					SELECT  @VALORD= SUM (NIEPED.VALOR_APORTES)
					FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
															AND NIEPE.NUMDOC=NIEPED.NUMDOC
					WHERE NIEPE.ANO=@ANO AND NIEPE.NUMDOC=@NUMDOC 
					AND MES>=1 
					AND MES< 13
				   AND COALESCE(NIEPED.PAGADO,0)=0 
					AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO)
				
               PRINT 'VALOR DE LA CESANTIAS == '+STR(COALESCE(@VALORD,0))
               IF COALESCE(@VALORD,0)>0
               BEGIN
                  PRINT 'MARCANDO PAGADO'
                  UPDATE NIEPED SET PAGADO=1,NUMDOCPRESTAMO=@CNSPAGO
					   FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
															   AND NIEPE.NUMDOC=NIEPED.NUMDOC
					   WHERE NIEPE.ANO=@ANO AND NIEPE.NUMDOC=@NUMDOC 
					   AND MES>=1 
					   AND MES< 13
				      AND COALESCE(NIEPED.PAGADO,0)=0 
					   AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO)

               END
            END
            IF @CODCONCEPTO=DBO.FNK_VALORVARIABLE('NOMICODCON_INCESAN') 
            BEGIN
               PRINT 'RETIRO MARCAS'
               UPDATE NIEPED SET PAGADO=0,NUMDOCPRESTAMO=NULL
					FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
															AND NIEPE.NUMDOC=NIEPED.NUMDOC
					WHERE NIEPE.ANO=@ANO AND NIEPE.NUMDOC=@NUMDOC 
					AND MES>=1 
					AND MES< 13
				   AND COALESCE(NIEPED.PAGADO,0)=1 
               AND (NIEPED.NUMDOCPRESTAMO=@CNSPAGO OR NIEPED.NUMDOCPRESTAMO='')
					AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO)

				   IF DBO.FNK_VALORVARIABLE('VAL_ICESAPERCOMPLETO')='SI' AND MONTH(@FECHARET)<>12
				   BEGIN
					   DECLARE @DIASTRA SMALLINT
					   DECLARE @FECHAREDEF DATETIME
					   DECLARE @FECHAINIANO DATETIME
					   DECLARE @VLCESAN DECIMAL(14,2)

					   SELECT @FECHAREDEF=FECHAFIN FROM NEDIA WHERE NUMDOC=@NUMDOC AND IDEVENTO='RET' AND CNSPAGO=@CNSPAGO
					   SELECT @FECHAINIANO=CAST('01/01/'+CAST(YEAR(@FECHAREDEF) AS VARCHAR(4))AS DATETIME)
					   SELECT @DIASTRA=DATEDIFF(DAY,CASE WHEN @FECHAING>@FECHAINIANO THEN @FECHAING ELSE @FECHAINIANO END,@FECHAREDEF)+1
               

					   SELECT  @VLCESAN= SUM (NIEPED.VALOR_APORTES)
					   FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
															   AND NIEPE.NUMDOC=NIEPED.NUMDOC
					   WHERE NIEPE.ANO=@ANO AND NIEPE.NUMDOC=@NUMDOC 
					   AND MES>=1 
					   AND MES< 13
				      AND COALESCE(NIEPED.PAGADO,0)=1 
                  AND (NIEPED.NUMDOCPRESTAMO=@CNSPAGO OR NIEPED.NUMDOCPRESTAMO='')
					   AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=DBO.FNK_VALORVARIABLE('NOMICODCON_CESAN'))

					   SELECT @VALORD=ROUND(((@VLCESAN/360)*@DIASTRA)*0.12,0)
				   END
				   ELSE
				   BEGIN
				      PRINT 'Liquidacion de INTERESES CESANTIAS .. Busco el Periodo...'
				      SELECT  @VALORD= SUM (NIEPED.VALOR_APORTES)
				      FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
														      AND NIEPE.NUMDOC=NIEPED.NUMDOC
				      WHERE NIEPE.ANO=@ANO AND NIEPE.NUMDOC=@NUMDOC 
				      AND MES>=1 
				      AND MES< 13
				      AND COALESCE(NIEPED.PAGADO,0)=0 
				      AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO)
				   END
               PRINT 'VALOR INTERESES  DE LA CESANTIAS == '+STR(COALESCE(@VALORD,0))
               IF COALESCE(@VALORD,0)>0
               BEGIN
                  UPDATE NIEPED SET PAGADO=1,NUMDOCPRESTAMO=@CNSPAGO
				      FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
														      AND NIEPE.NUMDOC=NIEPED.NUMDOC
				      WHERE NIEPE.ANO=@ANO AND NIEPE.NUMDOC=@NUMDOC 
				      AND MES>=1 
				      AND MES< 13
				      AND COALESCE(NIEPED.PAGADO,0)=0 
				      AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO)
               END
            END
            IF @CODCONCEPTO= DBO.FNK_VALORVARIABLE('NOMICODCON_VACA') AND NOT EXISTS(SELECT * FROM NEMPE WHERE NUMDOC=@NUMDOC AND CODCONCEPTO=@CODCONCEPTO )
            BEGIN
               PRINT 'Actulizando historicos...'
               DECLARE PG_CURSOR CURSOR FOR 
               SELECT NUMDOC,ITEM FROM NEMPV 
               WHERE NUMDOC=@NUMDOC 
               GROUP BY NUMDOC,ITEM
               ORDER BY NUMDOC,ITEM
               OPEN PG_CURSOR    
               FETCH NEXT FROM PG_CURSOR    
               INTO @NUMDOCVAC,@ITEMVAC
               WHILE @@FETCH_STATUS = 0    
               BEGIN 
                  IF EXISTS(SELECT * FROM NEMPVD WHERE NUMDOC=@NUMDOC AND ITEM=@ITEMVAC AND EVENTO='RET' )
                  BEGIN
                     SELECT @DIASR=NDIAS FROM NEMPVD WHERE NUMDOC=@NUMDOC AND ITEM=@ITEMVAC AND CNSPAGO=@CNSPAGO  AND EVENTO='RET'  
                     DELETE NEMPVD WHERE NUMDOC=@NUMDOC AND   CNSPAGO=@CNSPAGO AND ITEM=@ITEMVAC AND EVENTO='RET'
                     UPDATE NEMPV SET DIASP=DIASP-@DIASR WHERE NUMDOC=@NUMDOC AND ITEM=@ITEMVAC
                     UPDATE NEMPV SET ESTADO=CASE WHEN DIASG=DIASP THEN 'Cumplidas' else 'Proceso' END WHERE NUMDOC=@NUMDOC AND ITEM=@ITEMVAC
                  END                   
                  FETCH NEXT FROM PG_CURSOR    
                  INTO @NUMDOCVAC,@ITEMVAC
               END
               CLOSE PG_CURSOR
               DEALLOCATE PG_CURSOR
               PRINT 'Busco la el ultimo pago de Vacaciones-----'
               SELECT @NRODIAS=SUM(COALESCE(DIASG,0))-SUM(COALESCE(DIASP,0))
               FROM NEMPV WHERE NUMDOC=@NUMDOC AND ESTADO IN('Proceso','Cumplidas')
               PRINT '@NRODIAS ='+STR(@NRODIAS)
               PRINT '@BASICO ='+STR(@BASICO)
               IF @NRODIAS > 0
               BEGIN
                  SELECT @VALORD=ROUND(@BASICO*@NRODIAS,0)
                   PRINT '@VALORD ='+STR(@VALORD)
               END
               ELSE
               BEGIN
                  IF @DIASLABT>360 OR @NRODIAS>0
                  BEGIN
                     SELECT @VALORD=@BASICO*@NRODIAS
                     IF COALESCE(@VALORD,0)<=0
                     BEGIN 
                        IF YEAR(@FECHARET)>YEAR(@FECHAING)
                        BEGIN 
                           PRINT 'ANO DE INGRESO MAYOR AL RETIRO'
                           SELECT  @VALORD= SUM (NIEPED.VALOR_APORTES)
				               FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
														               AND NIEPE.NUMDOC=NIEPED.NUMDOC
				               WHERE NIEPE.ANO=@ANO-1 AND NIEPE.NUMDOC=@NUMDOC 
				               AND MES>=MONTH(@FECHAING)
				               AND MES< 13
                           AND COALESCE(NIEPED.PAGADO,0)=0 
				               AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO)                  

                           SELECT   @VALORD= COALESCE(@VALORD,0)+SUM (NIEPED.VALOR_APORTES)
				               FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
														               AND NIEPE.NUMDOC=NIEPED.NUMDOC
				               WHERE NIEPE.ANO=@ANO AND NIEPE.NUMDOC=@NUMDOC 
				               AND MES>=1
				               AND MES< MONTH(@FECHARET)+1
                           AND COALESCE(NIEPED.PAGADO,0)=0 
				               AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO) 
                        END
                        ELSE
                        BEGIN
                           PRINT 'ANO DE RETIRO IGUAL'
                           PRINT 'MONTH(@FECHAING)='+STR(MONTH(@FECHAING))
                           PRINT ' MONTH(@FECHARET)='+STR( MONTH(@FECHARET))
                           SELECT  @VALORD= SUM (NIEPED.VALOR_APORTES)
				               FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
														               AND NIEPE.NUMDOC=NIEPED.NUMDOC
				               WHERE NIEPE.ANO=@ANO AND NIEPE.NUMDOC=@NUMDOC 
				               AND MES>=MONTH(@FECHAING)
				               AND MES< MONTH(@FECHARET)+1
                           AND COALESCE(NIEPED.PAGADO,0)=0 
				               AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO) 
                        END
                     END
                  END
                  ELSE
                  BEGIN
                     IF YEAR(@FECHARET)>YEAR(@FECHAING)
                     BEGIN 
                        PRINT 'ANO DE INGRESO MAYOR AL RETIRO'
                        SELECT  @VALORD= SUM(NIEPED.VALOR_APORTES)
				            FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
														            AND NIEPE.NUMDOC=NIEPED.NUMDOC
				            WHERE NIEPE.ANO=@ANO-1 AND NIEPE.NUMDOC=@NUMDOC 
				            AND MES>=MONTH(@FECHAING)
				            AND MES< 13
                        AND COALESCE(NIEPED.PAGADO,0)=0 
				            AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO)                  

                        SELECT   @VALORD= COALESCE(@VALORD,0)+SUM (NIEPED.VALOR_APORTES)
				            FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
														            AND NIEPE.NUMDOC=NIEPED.NUMDOC
				            WHERE NIEPE.ANO=@ANO AND NIEPE.NUMDOC=@NUMDOC 
				            AND MES>=1
				            AND MES< MONTH(@FECHARET)+1
                        AND COALESCE(NIEPED.PAGADO,0)=0 
				            AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO) 
                     END
                     ELSE
                     BEGIN
                        PRINT 'ANO DE RETIRO IGUAL'
                        PRINT 'MONTH(@FECHAING)='+STR(MONTH(@FECHAING))
                        PRINT ' MONTH(@FECHARET)='+STR( MONTH(@FECHARET))
                        SELECT  @VALORD= SUM (NIEPED.VALOR_APORTES)
				            FROM NIEPE INNER JOIN NIEPED ON NIEPE.CNSNIEPE=NIEPED.CNSNIEPE 
														            AND NIEPE.NUMDOC=NIEPED.NUMDOC
				            WHERE NIEPE.ANO=@ANO AND NIEPE.NUMDOC=@NUMDOC 
				            AND MES>=MONTH(@FECHAING)
				            AND MES< MONTH(@FECHARET)+1
                        AND COALESCE(NIEPED.PAGADO,0)=0 
				            AND NIEPED.CODCONCEPTO IN(SELECT CODCONCEPTOA FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO) 
                     END
                  END
               END
               PRINT 'VALOR DE LAS VACACIONES == '+STR(COALESCE(@VALORD,0))
            END
            IF @INDEMNIZA = 1  AND @SI_INDEMNIZA = 1
            BEGIN
               SELECT @SMLV=VALOR FROM NPARV WHERE CODPARAMETRO='SMLV' AND FECHAINI<=@FECHARET AND FECHAFIN>@FECHARET
               IF CEILING(@BASICOT/@SMLV)>=10
               BEGIN
                  SELECT @DIASINDEMENOR=20,@DIASINDEMAYOR=15
               END
               ELSE
               BEGIN
                  SELECT @DIASINDEMENOR=30,@DIASINDEMAYOR=20
               END
               IF @PERINDEM='MENOR'
               BEGIN
                  IF @DIASLABT < 360
                  BEGIN
                     SELECT @VALORD = @BASICOT
                  END
                  ELSE
                  BEGIN
                     SELECT @VALORD = 0
                  END
               END
               ELSE
               BEGIN
                  IF  @DIASLABT < 360
                  BEGIN
                     SELECT @VALORD = 0
                  END
                  ELSE
                  BEGIN
                     PRINT 'PRIMER AÑO... CONVIERTO A DIAS 30 DIAS DE NOMINA'
                     SELECT @DIASLABT=(@MESESLABA*30)-DAY(@FECHAING)-(30-DAY(@FECHARET))
                     IF @DIASINDEMENOR = 30
                     BEGIN
                        SELECT @VALORD= @BASICOT
                     END
                     ELSE
                     BEGIN
                        SELECT @VALORD=(@BASICO*@DIASINDEMENOR)
                     END
                     PRINT '@DIASLABT TOTALS='+STR(@DIASLABT)
                     SELECT @DIASLABT = @DIASLABT-360
                     IF @DIASLABT < 360
                     BEGIN
                        PRINT 'HASTA 2 AÑO'
                        PRINT '@DIASLABT DESPUES ='+STR(@DIASLABT)
                        SELECT @RESIDUO=(@DIASLABT%360.00)
                        PRINT '@RESIDUO='+STR(@RESIDUO)
                        SELECT @POR_RESIDIO=((@RESIDUO*@DIASINDEMENOR)/360.00)
                        PRINT '@POR_RESIDIO ='+STR(@POR_RESIDIO)
                        PRINT '(@BASICO*@POR_RESIDIO)='+STR((@BASICO*@POR_RESIDIO))
                        SELECT @VALORD=@VALORD+(@BASICO*@POR_RESIDIO)
                        SELECT @DIASLABT=0
                     END
                     IF @DIASLABT > 0
                     BEGIN
                        PRINT 'MAYOR DE  2 AÑOS'
                        SELECT @VALORD=@VALORD+((@DIASLABT/360)*(@BASICO*@DIASINDEMAYOR))
                        SELECT @RESIDUO=(@DIASLABT%360.00)
                        SELECT @POR_RESIDIO=((@RESIDUO*@DIASINDEMAYOR)/360.00)
                        SELECT @VALORD=@VALORD+(@BASICO*@POR_RESIDIO)
                     END
                  END
               END
            END
            IF COALESCE(@VALORD,0)>0
            BEGIN
               INSERT INTO NEMPFD (NUMDOC, CNSPAGO, ITEM, CODCONCEPTO, DETALLE, CANTIDAD, VALOR, VALOR_EMPRESA, VALOR100P,   
                                       IDTRANSPRESTAMO, NUMDOCPRESTAMO, NUMCUOTA, CODPRF, IDTERCERO, INCLUIR_EXCLUIR, LIQUIDAR, INFO,   
                                       BASE_PRESTACIONES, ITEMCONCEPTO, VALHORASLAB, GENERANOVEFU, CODNOVEFU, BASE_CALCULO,LINEA) 
			      SELECT @NUMDOC,@CNSPAGO,'CAR00001',@CODCONCEPTO,@DETALLE,CASE WHEN A.CANTIDAD<=0 THEN @CANTI ELSE A.CANTIDAD END,ROUND(@VALORD,2),A.VALOR_EMPRESA,ROUND(@VALORD,2),A.IDTRANSPRESTAMO,A.NUMDOCPRESTAMO,
					       A.NUMCUOTA,A.CODPRF,@NUMDOC,'Automatica', 'Si','No','No',A.ITEMCONCEPTO,1,0,0,A.BASE_CALCULO,1
					       FROM FNK_CALCULO_VALORCONCEPTO_NOM(@NUMDOC,@CODCONCEPTO,@FECHAINI,@FECHAFIN,@CNSPAGO, 1,0,0) A
                WHERE  NOT EXISTS(SELECT 1 FROM NEMPE WHERE NUMDOC=@NUMDOC AND CODCONCEPTO=@CODCONCEPTO )

               DELETE NEMPFD WHERE CNSPAGO=@CNSPAGO AND NUMDOC=@NUMDOC AND CODCONCEPTO IN(SELECT CODCONCEPTOA  FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO) AND CODCONCEPTO_PADRE=@CODCONCEPTO
               
               IF @CODCONCEPTO= DBO.FNK_VALORVARIABLE('NOMICODCON_VACA')
               BEGIN
                  PRINT 'Actulizando historicos...'
                  DECLARE PG_CURSOR CURSOR FOR 
                  SELECT NUMDOC,ITEM,SUM((DIASG-COALESCE(DIASP,0)))  FROM NEMPV 
                  WHERE NUMDOC=@NUMDOC 
                  GROUP BY NUMDOC,ITEM
                  HAVING SUM(DIASG-COALESCE(DIASP,0)) >0
                  ORDER BY NUMDOC,ITEM
                  OPEN PG_CURSOR    
                  FETCH NEXT FROM PG_CURSOR    
                  INTO @NUMDOCVAC,@ITEMVAC,@DIASF
                  WHILE @@FETCH_STATUS = 0    
                  BEGIN 
                     SET @CNSNEMPVD=SPACE(20)
                     EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@NEMPVD',@CNSNEMPVD OUTPUT
                     SELECT @CNSNEMPVD = @SEDE +REPLACE(SPACE(8 - LEN(@CNSNEMPVD))+LTRIM(RTRIM(@CNSNEMPVD)),SPACE(1),0)
                     SELECT TOP 1  @VACA=IDEVENTO FROM NEVE WHERE CODCONCEPTO=dbo.FNK_VALORVARIABLE('NOMICODCON_VACA')
                     BEGIN TRY           
                        INSERT INTO NEMPVD(CNSNEMPVD, NUMDOC, ITEM, EVENTO, NDIAS, OBSERVACIONES, CNSPAGO, USUARIO, SYS_COMPUTERNAME, ESTADO, FECHAINI, SABADO, DOMINGO, FESTIVO, DIASCAL, PROCE)
                        SELECT @CNSNEMPVD, @NUMDOC, @ITEMVAC, 'RET',ROUND(@DIASF,0),'Liquidación de Empleado' , @CNSPAGO, @USUARIO, @SYS_COMPUTERNAME, 'EnNomina', @FECHAINI, 1, 0, 0, @DIASF, 'Retiro'                   
   
                        UPDATE NEMPV SET DIASP=ROUND(DIASP+@DIASF,0),ESTADO='Pagado' WHERE NUMDOC=@NUMDOC AND ITEM=@ITEMVAC                                        
                     END TRY
                     BEGIN CATCH
                           PRINT 'ERROR EN EL INSERT HISTORICO'
                     END CATCH

                     FETCH NEXT FROM PG_CURSOR    
                     INTO @NUMDOCVAC,@ITEMVAC,@DIASF
                  END
                  CLOSE PG_CURSOR
                  DEALLOCATE PG_CURSOR
               END
            END
            ELSE
            BEGIN
                DELETE NEMPFD WHERE CNSPAGO=@CNSPAGO AND NUMDOC=@NUMDOC AND CODCONCEPTO IN(SELECT CODCONCEPTOA  FROM NCONDA WHERE CODCONCEPTO=@CODCONCEPTO) AND CODCONCEPTO_PADRE=@CODCONCEPTO
            END
            FETCH NEXT FROM NOM_CON
            INTO @CODCONCEPTO,@INDEMNIZA,@PERINDEM



         END
         CLOSE NOM_CON
         DEALLOCATE NOM_CON
         FETCH NEXT FROM RET_EMP    
         INTO @NUMDOC,@SI_INDEMNIZA
      END
      CLOSE RET_EMP
      DEALLOCATE RET_EMP                  

   END
END



