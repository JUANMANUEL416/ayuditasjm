IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FNK_GEN_PLANOS_RIPS_US' AND XTYPE='FN')
BEGIN
   DROP FUNCTION DBO.FNK_GEN_PLANOS_RIPS_US
END
GO
CREATE FUNCTION DBO.FNK_GEN_PLANOS_RIPS_US( @ENVIO VARCHAR(6))
RETURNS VARCHAR(MAX)
WITH ENCRYPTION
AS
BEGIN
	DECLARE @PLANO VARCHAR(MAX)
	,@TIPO_DOC VARCHAR(2)
	,@IDUSUARIO VARCHAR(20)
	,@CODENTIDADM VARCHAR(20)
	,@TIPOUSUARIO VARCHAR(2)
	,@PAPELLIDO VARCHAR(30)
	,@SAPELLIDO VARCHAR(30)
	,@PNOMBRE VARCHAR(30)
	,@SNOMBRE VARCHAR(30)
	,@EDAD VARCHAR(3)
	,@UNMEDIDA VARCHAR(1)
	,@SEXO   VARCHAR(1)
	,@DEPHABITUAL VARCHAR(2)
	,@MUNHABITUAL VARCHAR(3)
	,@ZONAHABITUAL VARCHAR(1)

	SELECT @PLANO=''
	DECLARE GEN_PLANO_US CURSOR FOR 
	SELECT TIPO_DOC,IDUSUARIO,CODENTIDADM,TIPOUSUARIO,COALESCE(PAPELLIDO,''),COALESCE(SAPELLIDO,''),
			COALESCE(PNOMBRE,''),COALESCE(SNOMBRE,''),CAST(EDAD AS VARCHAR(3)),CAST(UNMEDIDA AS VARCHAR(1)),
			SEXO,COALESCE(DEPHABITUAL,''),COALESCE(MUNHABITUAL,''),ZONAHABITUAL
	FROM RRIPS_US WHERE ENVIO=@ENVIO
	OPEN GEN_PLANO_US    
	FETCH NEXT FROM GEN_PLANO_US    
	INTO @TIPO_DOC,@IDUSUARIO,@CODENTIDADM,@TIPOUSUARIO,@PAPELLIDO,@SAPELLIDO,@PNOMBRE,@SNOMBRE
		,@EDAD,@UNMEDIDA,@SEXO,@DEPHABITUAL,@MUNHABITUAL,@ZONAHABITUAL
	WHILE @@FETCH_STATUS = 0    
	BEGIN 
		SET @PLANO+= REPLACE(@TIPO_DOC+','+@IDUSUARIO+','+@CODENTIDADM+','+@TIPOUSUARIO+','+@PAPELLIDO+','+@SAPELLIDO+','+@PNOMBRE+','+@SNOMBRE
							+','+@EDAD+','+@UNMEDIDA+','+@SEXO+','+@DEPHABITUAL+','+@MUNHABITUAL+','+@ZONAHABITUAL,CHAR(32),'')
		SET @PLANO+='|' 
		FETCH NEXT FROM GEN_PLANO_US    
		INTO @TIPO_DOC,@IDUSUARIO,@CODENTIDADM,@TIPOUSUARIO,@PAPELLIDO,@SAPELLIDO,@PNOMBRE,@SNOMBRE
			,@EDAD,@UNMEDIDA,@SEXO,@DEPHABITUAL,@MUNHABITUAL,@ZONAHABITUAL
	END
	CLOSE GEN_PLANO_US
	DEALLOCATE GEN_PLANO_US
   IF LEN(@PLANO)>2
   BEGIN
      SELECT @PLANO=LEFT(@PLANO,LEN(@PLANO)-1)
      SELECT @PLANO=REPLACE(@PLANO,'|',CHAR(13))
   END
	RETURN @PLANO
END


