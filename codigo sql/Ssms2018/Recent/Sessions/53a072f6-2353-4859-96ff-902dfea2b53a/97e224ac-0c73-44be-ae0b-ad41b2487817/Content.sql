IF EXISTS (SELECT name FROM sysobjects WHERE name = 'SPK_ENVIA_PPTO_EGRESOCAJA' AND type = 'P')
BEGIN
   DROP PROCEDURE SPK_ENVIA_PPTO_EGRESOCAJA
END
GO
CREATE PROCEDURE  DBO.SPK_ENVIA_PPTO_EGRESOCAJA  
@CODCAJA          VARCHAR(4),
@CNSFACJ          VARCHAR(20),
@COMPANIA         VARCHAR(2),
@SEDE             VARCHAR(5), 
@USUARIO          VARCHAR(12),
@SYS_COMPUTERNAME VARCHAR(254)
WITH ENCRYPTION
AS  
DECLARE @OK               INT
DECLARE @CLASER           VARCHAR(1)
DECLARE @TIPOPAGO         VARCHAR(3)
DECLARE @VALOR            DECIMAL(14,2)
DECLARE @TIPO             VARCHAR(7)
DECLARE @PROCEDENCIA      VARCHAR(10)
DECLARE @DATO             VARCHAR(80)
DECLARE @DATO1            VARCHAR(80)
DECLARE @ESTADO           VARCHAR(1) 
DECLARE @IDAFILIADO       VARCHAR(20)
DECLARE @NVOVONSEC        VARCHAR(20)
DECLARE @NVOCONSEC1       VARCHAR(20)
DECLARE @NVOCONSEC2       VARCHAR(20)
DECLARE @CNSACJ           VARCHAR(20)
DECLARE @CNSPCJ           VARCHAR(20)
DECLARE @ABIERTA          SMALLINT
DECLARE @VALORTOTAL       DECIMAL(14,2)
DECLARE @DOC1             VARCHAR(16)
DECLARE @DOC2             VARCHAR(16) 
DECLARE @CLASE_FAC        VARCHAR(5)
DECLARE @IDTERCERO        VARCHAR(20)
DECLARE @TIPOEGRESO       VARCHAR(8)
DECLARE @DATO2            VARCHAR(80)
DECLARE @DATO3            VARCHAR(80)
DECLARE @DATO4            VARCHAR(80)
DECLARE @DATO5            VARCHAR(80)
DECLARE @DATO6            VARCHAR(80)
DECLARE @DATO7            VARCHAR(80)
DECLARE @CPRECTRAS        VARCHAR(80)
DECLARE @DATOCHQ          VARCHAR(80)
DECLARE @DATOEFE          VARCHAR(80)
DECLARE @DATOAPE          VARCHAR(80)
DECLARE @DATON            VARCHAR(80)
DECLARE @DATOCATCAJA      VARCHAR(80)
DECLARE @BANCO            VARCHAR(3)
DECLARE @SUCURSAL         VARCHAR(2)
DECLARE @CTA_BCO          VARCHAR(40)
DECLARE @CSGBANCO         VARCHAR(3)
DECLARE @CSGSUCURSAL      VARCHAR(2)
DECLARE @CSGCTA_BCO       VARCHAR(40)
DECLARE @CNSDOC           VARCHAR(20)
DECLARE @NUMERODOCUMENTO  VARCHAR(20)   
DECLARE @NODOCUMENTO      VARCHAR(20)   
DECLARE @N_RECIBO         VARCHAR(20)
DECLARE @CODCAJADEP       VARCHAR(5)
DECLARE @CNSFACJDEP       VARCHAR(20)
DECLARE @DEAPERTURA       SMALLINT
DECLARE @ITEMBMOV         INT 
DECLARE @IDOPERACION      VARCHAR(20)
DECLARE @RENGLON          SMALLINT
DECLARE @CCOSTO           VARCHAR(20)
DECLARE @IDAREA           VARCHAR(20)
DECLARE @CUENTA           VARCHAR(16)
DECLARE @FECHA            DATETIME
DECLARE @CNSFCXP          VARCHAR(20)
DECLARE @CNSCXC           VARCHAR(20)
DECLARE @CONCEPTO         VARCHAR(10)
DECLARE @IDTERCERO_CXP    VARCHAR(20)
DECLARE @VALOR_CXP        DECIMAL (14,2)
DECLARE @F_VENCE          DATETIME
DECLARE @NOMBRECLIENTE    VARCHAR(40)
DECLARE @OBSERVACION      VARCHAR(255) 
DECLARE @DOCORIGEN        INT 
DECLARE @NVOCONSEC        VARCHAR(20)
DECLARE @ITEM             INT
DECLARE @CODIGOCPCJ       VARCHAR(20)
DECLARE @DATOCEHOSP       VARCHAR(80)
DECLARE @DEVDOC           VARCHAR(20)
DECLARE @NROCOMPROBANTE   VARCHAR(20)
DECLARE @RECBCO           INT
DECLARE @BANCO2           VARCHAR(3)
DECLARE @SUCURSAL2        VARCHAR(2)
DECLARE @CTA_BCO2         VARCHAR(20)
DECLARE @DEVREC           VARCHAR(20)
DECLARE @CODCAJA_DEV      VARCHAR(4)
DECLARE @CNSFACJ_DEV      VARCHAR(20)
DECLARE @PROC_DEV         VARCHAR(10)
DECLARE @NOADMISION_DEV   VARCHAR(20)
DECLARE @NOPRESTACION_DEV VARCHAR(20)
DECLARE @CONSECUTIVOCAN   VARCHAR (20)
DECLARE @VALORTOTAL1      DECIMAL(14,2)
DECLARE @IDTERCERO1       VARCHAR(20)
DECLARE @NOINGRESODEPORI  VARCHAR(16)
DECLARE @VALORDEPORI      DECIMAL(14,2)
DECLARE @TRASACAJA        VARCHAR(80) 
DECLARE @VALORREINTEGRO   DECIMAL(14,2)
DECLARE @G_REINT          SMALLINT
DECLARE @NVOCONSECTFCJ    VARCHAR(20)
DECLARE @CNSPCJAUX        VARCHAR(20)  
DECLARE @TOTREINTEGRO     DECIMAL(14,2)
DECLARE @CNSCXP           VARCHAR(20) --PPTO
DECLARE @CNSPPTO          VARCHAR(20) --PPTO
DECLARE @CNSCDP           VARCHAR(20) --PPTO
DECLARE @CNSRP            VARCHAR(20) --PPTO
DECLARE @CNSPAGO          VARCHAR(20) --PPTO
DECLARE @FPAGO            DATETIME    --PPTO
DECLARE @PBANCO           VARCHAR(20) --PPTO
DECLARE @PCUENTA          VARCHAR(20) --PPTO
DECLARE @PSUCURSAL        VARCHAR(20) --PPTO
DECLARE @PFORMA           VARCHAR(20) --PPTO
DECLARE @PCCOSTO          VARCHAR(20) --PPTO
DECLARE @DESFORMA         VARCHAR(50) --PPTO
DECLARE @PDOCUMENTO       VARCHAR(20) --PPTO
DECLARE @ESPART           BIT          --PPTO
DECLARE @PABONO           DECIMAL(14,2) --PPTO
DECLARE @OBSERVACIONPPTO  VARCHAR(500)  --PPTO
DECLARE @F_PAGOPPTO        DATETIME  --PPTO
DECLARE @CONSECUTIVO      VARCHAR(20)
DECLARE @RUBRO            VARCHAR(20)
DECLARE @RECO             VARCHAR(20)
DECLARE @CCOSTOPRESUP     VARCHAR(20)
DECLARE @RECA             VARCHAR(20)
DECLARE @SI               SMALLINT
DECLARE @VLR_CXPPANT      DECIMAL(14,2)
DECLARE @DATOPAGARE       VARCHAR (80)
DECLARE @CNSFCJDIDSER     VARCHAR(20)
BEGIN
   DECLARE PG_CURSOR_CJ CURSOR FOR 
   SELECT FCXP.CNSFCXP,FCXPP.ABONO ,FCJD.IDSERVICIO					                   
   FROM  FCXP,FCXPP, FCJD
   WHERE FCXPP.CNSFCXPP = FCJD.IDSERVICIO
   AND   FCJD.CODCAJA   = @CODCAJA
   AND   FCJD.CNSFACJ   = @CNSFACJ
   AND   FCXP.CNSFCXP   = FCXPP.CNSFCXP
   GROUP BY FCXP.CNSFCXP,FCXPP.ABONO ,FCJD.IDSERVICIO				     
   OPEN PG_CURSOR_CJ    
   FETCH NEXT FROM PG_CURSOR_CJ    
   INTO @CNSCXP,@PABONO,@CNSFCJDIDSER
   WHILE @@FETCH_STATUS = 0    
   BEGIN
	   -- AQUI PRESUPUESTO
      SELECT @F_PAGOPPTO=FECHA FROM FCJ WHERE CODCAJA=@CODCAJA AND CNSFACJ=@CNSFACJ
	   PRINT 'VOY A PRESUPUESTO'

		SELECT @CNSPPTO=CNSPPTO,@CNSCDP=CNSCDP,@CNSRP=CNSRP
		FROM FCXP  WHERE CNSFCXP=@CNSCXP
		PRINT 'CAPTURO VARIABLES'
		SELECT @PBANCO=BANCO,@PSUCURSAL=SUCURSAL,@PCUENTA=CTA_BCO,@PFORMA=TIPOPAGO,@PDOCUMENTO=NUMERODOCUMENTO FROM PCJ WHERE CODCAJA=@CODCAJA AND CNSFACJ=@CNSFACJ
      SELECT @FPAGO=FECHA FROM FCJ WHERE CODCAJA=@CODCAJA AND CNSFACJ=@CNSFACJ
		SELECT @DESFORMA=DESCRIPCION,@PCCOSTO=DBO.FNK_VALORVARIABLE('PRESUP_CCOSTO')  FROM FPA WHERE FORMAPAGO=@PFORMA
      SELECT @VLR_CXPPANT=VALOR  FROM PTCXP WHERE CONSECUTIVO=@CNSPPTO AND CDP=@CNSCDP AND RP=@CNSRP AND CNSCXP=@CNSCXP
		PRINT 'TRAIGO EL CONSEUCTIVO...'
      SELECT @CONSECUTIVO=CONSECUTIVO FROM PTPTO WHERE FECHAINI<=@F_PAGOPPTO AND FECHAFIN+1>@F_PAGOPPTO
		PRINT 'CONSECUTIVO PPTO CUENTA CXP...'+@CNSPPTO
		PRINT 'CONSECUTIVO PPTO PRESUPUESTO ACTUAL ...'+@CONSECUTIVO

         IF NOT EXISTS(SELECT * FROM PTCDP WHERE CONSECUTIVO=@CNSPPTO AND CDP=@CNSCDP )
         BEGIN
            PRINT 'NO EXISTE CDP CON ESE CDP Y ESE CONSECUTIVO PARA ESTA CXP= '+@CNSCXP
            FETCH NEXT FROM PG_CURSOR_CJ    
            INTO @CNSCXP,@PABONO,@CNSFCJDIDSER
            CONTINUE
         END
          

      IF @CNSPPTO=@CONSECUTIVO
      BEGIN
			SELECT @CNSPAGO = COALESCE(CONTADOR_PAGOS,0) + 1 
			FROM   PTPTO 
			WHERE  COMPANIA = @COMPANIA AND CONSECUTIVO = @CNSPPTO
						
			PRINT 'CONSECUTIVO... ANTES'+STR(@CNSPAGO)

			SELECT @CNSPAGO = @SEDE + REPLACE(SPACE(8 - LEN(@CNSPAGO))+LTRIM(RTRIM(@CNSPAGO)),SPACE(1),0) 

			PRINT 'CONSECUTIVO... DESPUES'+STR(@CNSPAGO)

			SELECT @OBSERVACIONPPTO='ABONO CUENTA POR PAGAR NRO.:'+@CNSCXP+' REALIZADO EL: '+DBO.FNK_FECHA(@FPAGO)+' FORMA DE PAGO: '+@DESFORMA
						+CASE WHEN COALESCE(@PBANCO,'')<>'' THEN '  BANCO '+@PBANCO+' SUCURSAL '+@PSUCURSAL+' CUENTA BACARIA NRO.: ' +@PCUENTA
									+ CASE WHEN COALESCE(@PFORMA,'')=DBO.FNK_VALORVARIABLE('IDCJFPACHEQUE') THEN '  CHEQUE NRO.:'+COALESCE(@PDOCUMENTO,'Sin Definir') ELSE COALESCE(@PDOCUMENTO,'') END
						ELSE 'CAJA NRO.: '+@CODCAJA+' CONSECUTIVO: '+@CNSFACJ END

         PRINT 'INSERT'
         PRINT '@CNSRP ='+COALESCE(@CNSRP,'NO HAY CDP...')

			INSERT INTO PTPAG(COMPANIA , CONSECUTIVO , CDP , RP , CNSCXP , CNSPAGO , OBSERVACION , VALOR , ORIGENPAGO , CODCAJA , CNSFACJ , BANCO ,
										SUCURSAL , CTA_BCO , ITEM_BMOV , ESTADO , FECHA , CCOSTO)
			SELECT @COMPANIA,@CNSPPTO,@CNSCDP,@CNSRP,@CNSCXP,@CNSPAGO,@OBSERVACIONPPTO,@PABONO,
						CASE WHEN @PFORMA=DBO.FNK_VALORVARIABLE('IDCJFPAEFECTIVO')THEN 'CAJA' ELSE 'BANCO' END,	 
						@CODCAJA,@CNSFACJ,@PBANCO,@PSUCURSAL,@PCUENTA,1,'NoConfirmado',@FPAGO,@PCCOSTO



			UPDATE PTPTO SET CONTADOR_PAGOS= COALESCE(CONTADOR_PAGOS,0) + 1 
			WHERE  COMPANIA    = @COMPANIA
			AND    CONSECUTIVO = @CNSPPTO
						
			PRINT 'DETALLE  @CNSPAGO='+@CNSPAGO

			INSERT INTO PTPAGD (COMPANIA , CONSECUTIVO , CDP , RP , CNSCXP , CNSPAGO , ITEM , CLASE , RUBRO , VALOR , OBSERVACION)
			SELECT @COMPANIA,@CNSPPTO,@CNSCDP,@CNSRP,@CNSCXP,@CNSPAGO, ROW_NUMBER() OVER(ORDER  BY FCXPD.RUBRO  DESC),'Gasto',RUBRO, SUM((((FCXPD.VLR_NETO*100)/@VLR_CXPPANT)/100)*@PABONO),
         @OBSERVACIONPPTO
			FROM FCXPD
			WHERE CNSFCXP=@CNSCXP
         GROUP BY RUBRO

        UPDATE PTCXPD SET ITEMCDPD=PTRPD.ITEMCDPD
        FROM PTCXPD INNER JOIN PTRPD ON PTCXPD.RUBRO_ID=PTRPD.RUBRO_ID AND PTRPD.RP=PTCXPD.RP AND PTRPD.CONSECUTIVO=PTCXPD.CONSECUTIVO AND PTCXPD.CDP=PTRPD.CDP
        WHERE PTCXPD.CONSECUTIVO=@CNSPPTO
        AND PTCXPD.CNSCXP=@CNSCXP
        AND PTCXPD.RP=@CNSRP
        AND PTCXPD.CDP=@CNSCDP
        AND PTCXPD.ITEMCDPD IS NULL

         UPDATE PTPAG SET ESTADO='Confirmado' WHERE COMPANIA=@COMPANIA AND CONSECUTIVO=@CNSPPTO AND RP=@CNSRP AND CNSCXP=@CNSCXC AND CNSPAGO=@CNSPAGO

			PRINT 'TERMINE INSER PTPAGD'
      END
      ELSE
      BEGIN
         PRINT 'VIGENCIA ANTERIOR'
         PRINT 'CAPTURO VALORES DE LOS MOVIMIENTOS PRESUPUESTALES' 
         DECLARE @CDP VARCHAR(20)
         DECLARE @RP  VARCHAR(20)
         DECLARE @CNSCDPN INT
         DECLARE @CNSRPN  INT
         DECLARE @VLR_CDPANT DECIMAL(14,2)
         DECLARE @VLR_RPANT DECIMAL(14,2)
         DECLARE @RUBROVIANTE VARCHAR(50)
         DECLARE @ID_RUBROANTE INT 
         DECLARE @CLASE VARCHAR(10)
         DECLARE @RECURSO VARCHAR(3)

        
                        
         SELECT  @RUBROVIANTE=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('PPTO_RUBRORECO_VANTE')))
         IF COALESCE(@RUBROVIANTE,'')<>''
         BEGIN
            SELECT @ID_RUBROANTE=RUBRO_ID,@CLASE=CLASE,@RECURSO=RECURSO FROM PTRUB WHERE CONSECUTIVO=@CONSECUTIVO AND RUBRO=@RUBROVIANTE
         END
         ELSE
         BEGIN
            PRINT 'NO ENCONTRE EL RUBRO ANTERIOR O NO ESTA CONFIGURADO'
            FETCH NEXT FROM PG_CURSOR_CJ    
            INTO @CNSCXP,@PABONO,@CNSFCJDIDSER
            CONTINUE
         END

         SELECT @VLR_CDPANT=VALOR  FROM PTCDP WHERE CONSECUTIVO=@CNSPPTO AND CDP=@CNSCDP
         SELECT @VLR_RPANT=VALOR  FROM PTRP WHERE CONSECUTIVO=@CNSPPTO AND CDP=@CNSCDP AND RP=@CNSRP
         SELECT @VLR_CXPPANT=VALOR  FROM PTCXP WHERE CONSECUTIVO=@CNSPPTO AND CDP=@CNSCDP AND RP=@CNSRP AND CNSCXP=@CNSCXP

         PRINT 'VALORES ANTERIORES '
         PRINT' @VLR_CDPANT == '+STR(@VLR_CDPANT) 
         PRINT' @VLR_RPANT == '+STR(@VLR_RPANT) 
         PRINT' @VLR_CXPPANT == '+STR(@VLR_CXPPANT) 
         PRINT' @PABONO == '+STR(@PABONO) 
         PRINT ''

         IF NOT EXISTS(SELECT * FROM PTCDP WHERE CONSECUTIVO=@CNSPPTO AND CDP=@CNSCDP )
         BEGIN
            PRINT 'NO EXISTE CDP CON ESE CDP Y ESE CONSECUTIVO PARA ESTA CXP= '+@CNSCXP
            FETCH NEXT FROM PG_CURSOR_CJ    
            INTO @CNSCXP,@PABONO,@CNSFCJDIDSER
            CONTINUE
         END
          
         SELECT @CNSCDPN=CONTADOR_CDP+1, @CNSRPN=CONTADOR_RP+1 FROM PTPTO WHERE CONSECUTIVO=@CONSECUTIVO
                        
         SELECT @CDP = @SEDE +REPLACE(SPACE(8 - LEN(@CNSCDPN))+LTRIM(RTRIM(@CNSCDPN)),SPACE(1),0)
         SELECT @RP = @SEDE +REPLACE(SPACE(8 - LEN(@CNSRPN))+LTRIM(RTRIM(@CNSRPN)),SPACE(1),0)
         PRINT '@CDP '+@CDP
         PRINT '@RP '+@RP
         PRINT 'CDPANT '+ @CNSCDP
         PRINT 'RPANT '+ @CNSRP
         PRINT 'PTCDP....'

         INSERT INTO PTCDP(COMPANIA, CONSECUTIVO, CDP, IDDEP, OBJETIVO, VALOR, SALDO, FECHAEXPEDICION, FECHAVENCE, FECHAREINTEGRO, AUTORIZADOR, ESTADO, CCOSTO, CNSPTSCDP)
         SELECT COMPANIA, @CONSECUTIVO, @CDP, IDDEP, OBJETIVO, @PABONO, @PABONO, @FPAGO,@FPAGO, @FPAGO, AUTORIZADOR, 'NoConfirmado', CCOSTO, CNSPTSCDP
         FROM PTCDP WHERE CONSECUTIVO=@CNSPPTO AND CDP=@CNSCDP
         PRINT 'PTCDPD....'

         INSERT INTO PTCDPD(COMPANIA, CONSECUTIVO, CDP, ITEM, CLASE, RUBRO, RECURSO, IDTIPOMOV, OBJETIVO, VALOR, VALOR_RP, SALDO, SOLICITANTE, RUBRO_ID)
         SELECT PTCDPD.COMPANIA, @CONSECUTIVO, @CDP,1,@CLASE, @RUBROVIANTE, @RECURSO,
                  IDTIPOMOV, OBJETIVO, SUM((((PTCDPD.VALOR*100)/@VLR_CDPANT)/100)*@PABONO), 0, SUM((((PTCDPD.VALOR*100)/@VLR_CDPANT)/100)*@PABONO), SOLICITANTE,@ID_RUBROANTE
         FROM PTCDPD 
         WHERE PTCDPD.CONSECUTIVO=@CNSPPTO AND CDP=@CNSCDP 
         GROUP BY PTCDPD.COMPANIA, IDTIPOMOV, OBJETIVO, SOLICITANTE
                        

         UPDATE PTCDP SET ESTADO='Confirmado' WHERE CONSECUTIVO=@CONSECUTIVO AND CDP=@CDP

         --PRINT 'ME DEVUELVO'
         --RETURN
                        
         PRINT 'VAMOS A RP' 

         INSERT INTO PTRP(COMPANIA, CONSECUTIVO, CDP, RP, OBJETIVO, VALOR, SALDO, SOLICITANTE, CNSFCOM, CNSFCXP, IDTERCERO, NODOCUMENTO, FECHARP, FECHAPLAZO, ESTADO, CCOSTO)
         SELECT COMPANIA, @CONSECUTIVO, @CDP, @RP, OBJETIVO, @PABONO, @PABONO, SOLICITANTE, CNSFCOM, CNSFCXP, IDTERCERO, NODOCUMENTO, @FPAGO, @FPAGO, 'NoConfirmado', CCOSTO
         FROM PTRP WHERE CONSECUTIVO=@CNSPPTO AND CDP=@CNSCDP AND RP=@CNSRP

         PRINT 'VAMOS A RPD'

         INSERT INTO PTRPD(COMPANIA, CONSECUTIVO, CDP, RP, CLASE, RUBRO, VALOR, VALOR_CXP, SALDO, OBJETIVO, RUBRO_ID,ITEMCDPD)
         SELECT PTRPD.COMPANIA, @CONSECUTIVO, @CDP, @RP, PTRPD.CLASE, @RUBROVIANTE,  SUM((((PTRPD.VALOR*100)/@VLR_RPANT)/100)*@PABONO),  0,
                  SUM((((PTRPD.VALOR*100)/@VLR_RPANT)/100)*@PABONO), OBJETIVO,@ID_RUBROANTE,1
         FROM PTRPD   INNER JOIN PTRUB ON PTRPD.RUBRO_ID=PTRUB.RUBRO_ID
         WHERE PTRPD.CONSECUTIVO=@CNSPPTO AND CDP=@CNSCDP  AND RP=@CNSRP AND PTRUB.CONSECUTIVO = @CNSPPTO
         GROUP BY PTRPD.COMPANIA, PTRPD.CLASE, PTRPD.OBJETIVO
         PRINT 'ACTUALIZO RP'
         UPDATE PTRP SET ESTADO='Confirmado' WHERE CONSECUTIVO=@CONSECUTIVO AND CDP=@CDP AND RP=@RP

         PRINT 'ACTUALIZO CONTADORES'
         UPDATE PTPTO SET CONTADOR_CDP = CONTADOR_CDP+1, CONTADOR_RP = CONTADOR_RP+1 WHERE CONSECUTIVO = @CONSECUTIVO
         PRINT 'VOY PARA PTCXP....'
                        
         INSERT INTO PTCXP(COMPANIA, CONSECUTIVO, CDP, RP, CNSCXP, FECHA, VALOR, SALDO, OBSERVACION, ESTADO, CCOSTO)
         SELECT COMPANIA, @CONSECUTIVO, @CDP, @RP, @CNSCXP, @FPAGO, @PABONO, @PABONO, OBSERVACION, 'NoConfirmado', CCOSTO
         FROM PTCXP WHERE CONSECUTIVO=@CNSPPTO AND CDP=@CNSCDP  AND RP=@CNSRP AND CNSCXP=@CNSCXP

         PRINT 'VOY A REALIZAR CXPD...'  
         PRINT '@VLR_CXPPANT '+STR(@VLR_CXPPANT)
         PRINT '@PABONO '+STR(@PABONO)
         INSERT INTO PTCXPD(COMPANIA, CONSECUTIVO, CDP, RP, CNSCXP, ITEM, CLASE, RUBRO, VALOR, VALOR_PAG, SALDO, OBSERVACION, ESTADO, RUBRO_ID,ITEMCDPD)
         SELECT PTCXPD.COMPANIA, @CONSECUTIVO, @CDP, @RP, @CNSCXP, ROW_NUMBER() OVER(ORDER  BY @RUBROVIANTE  DESC), PTCXPD.CLASE, @RUBROVIANTE,
                  SUM((((PTCXPD.VALOR*100)/@VLR_CXPPANT)/100)*@PABONO), 0, SUM((((PTCXPD.VALOR*100)/@VLR_CXPPANT)/100)*@PABONO), 
                  OBSERVACION,'NoConfirmado', @ID_RUBROANTE,1
         FROM PTCXPD 
         WHERE PTCXPD.CONSECUTIVO=@CNSPPTO AND CDP=@CNSCDP  AND RP=@CNSRP  AND CNSCXP=@CNSCXP
         GROUP BY PTCXPD.COMPANIA, PTCXPD.CLASE,OBSERVACION
         --RETURN
         UPDATE PTCXP SET ESTADO='Confirmado' WHERE CONSECUTIVO=@CONSECUTIVO AND CDP=@CDP AND RP=@RP AND CNSCXP=@CNSCXP

			SELECT @CNSPAGO = COALESCE(CONTADOR_PAGOS,0) + 1 
			FROM   PTPTO 
			WHERE  COMPANIA = @COMPANIA AND CONSECUTIVO = @CONSECUTIVO
						
			PRINT 'CONSECUTIVO... ANTES'+STR(@CNSPAGO)

			SELECT @CNSPAGO = @SEDE + REPLACE(SPACE(8 - LEN(@CNSPAGO))+LTRIM(RTRIM(@CNSPAGO)),SPACE(1),0) 

			PRINT 'CONSECUTIVO... DESPUES'+STR(@CNSPAGO)

			SELECT @OBSERVACIONPPTO='ABONO CUENTA POR PAGAR NRO.:'+@CNSCXP+' REALIZADO EL: '+DBO.FNK_FECHA(@FPAGO)+' FORMA DE PAGO: '+@DESFORMA
						+CASE WHEN COALESCE(@PBANCO,'')<>'' THEN '  BANCO '+@PBANCO+' SUCURSAL '+@PSUCURSAL+' CUENTA BACARIA NRO.: ' +@PCUENTA
									+ CASE WHEN COALESCE(@PFORMA,'')=DBO.FNK_VALORVARIABLE('IDCJFPACHEQUE') THEN '  CHEQUE NRO.:'+COALESCE(@PDOCUMENTO,'Sin Definir') ELSE COALESCE(@PDOCUMENTO,'') END
						ELSE 'CAJA NRO.: '+@CODCAJA+' CONSECUTIVO: '+@CNSFACJ END
						
			PRINT 'INSERT'
			INSERT INTO PTPAG(COMPANIA , CONSECUTIVO , CDP , RP , CNSCXP , CNSPAGO , OBSERVACION , VALOR , ORIGENPAGO , CODCAJA , CNSFACJ , BANCO ,
										SUCURSAL , CTA_BCO , ITEM_BMOV , ESTADO , FECHA , CCOSTO)
			SELECT @COMPANIA,@CONSECUTIVO,@CDP,@RP,@CNSCXP,@CNSPAGO,@OBSERVACIONPPTO,@PABONO,
						CASE WHEN @PFORMA=DBO.FNK_VALORVARIABLE('IDCJFPAEFECTIVO')THEN 'CAJA' ELSE 'BANCO' END,	 
						@CODCAJA,@CNSFACJ,@PBANCO,@PSUCURSAL,@PCUENTA,1,'NoConfirmado',@FPAGO,@PCCOSTO

			UPDATE PTPTO SET CONTADOR_PAGOS= COALESCE(CONTADOR_PAGOS,0) + 1 
			WHERE  COMPANIA    = @COMPANIA
			AND    CONSECUTIVO = @CONSECUTIVO
						
			PRINT 'DETALLE '

			INSERT INTO PTPAGD (COMPANIA , CONSECUTIVO , CDP , RP , CNSCXP , CNSPAGO , ITEM , CLASE , RUBRO , VALOR , OBSERVACION, RUBRO_ID,ITEMCDPD)
         SELECT PTCXPD.COMPANIA, @CONSECUTIVO, @CDP, @RP, @CNSCXP,@CNSPAGO, ROW_NUMBER() OVER(ORDER  BY @RUBROVIANTE  DESC), PTCXPD.CLASE, @RUBROVIANTE,
                  SUM((((PTCXPD.VALOR*100)/@VLR_CXPPANT)/100)*@PABONO),@OBSERVACIONPPTO,@ID_RUBROANTE,1
         FROM PTCXPD 
         WHERE PTCXPD.CONSECUTIVO=@CNSPPTO AND CDP=@CNSCDP  AND RP=@CNSRP AND  CNSCXP=@CNSCXP
         GROUP BY PTCXPD.COMPANIA, PTCXPD.CLASE
			PRINT 'TERMINE INSER PTPAGD'

         PRINT 'CONFIRMO EL PAGO ...'

          UPDATE PTPAG SET ESTADO='Confirmado' WHERE CONSECUTIVO=@CONSECUTIVO AND CDP=@CDP AND RP=@RP AND CNSCXP=@CNSCXP  AND CNSPAGO=@CNSPAGO

      END
      UPDATE FCJD SET CNSCDP=@CDP,CNSRP=COALESCE(@CNSRP,@CNSRP),CNSPTPAG=@CNSPAGO  WHERE CODCAJA=@CODCAJA AND CNSFACJ=@CNSFACJ AND IDSERVICIO=@CNSFCJDIDSER
	   PRINT 'ACTUALIZO SALDOS DE CXP....'+@CNSCXP
	   EXEC SPK_CALCULOVALORESCXP @CNSCXP 


      FETCH NEXT FROM PG_CURSOR_CJ    
      INTO @CNSCXP,@PABONO,@CNSFCJDIDSER
   END
   CLOSE PG_CURSOR_CJ
   DEALLOCATE PG_CURSOR_CJ
   UPDATE FCJ SET ENPRESUPUESTO=1,PPTO=@CONSECUTIVO WHERE CODCAJA=@CODCAJA AND CNSFACJ=@CNSFACJ
END

