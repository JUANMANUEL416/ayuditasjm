USE PUHEMOONC


SELECT *  FROM HCATDIMOV



UPDATE  HCATDIMOV SET VLR_UNITARIO=ROUND(COALESCE(VALOR,0),-2)

SELECT *
FROM  HCATDIMOV INNER JOIN CIT ON HCATDIMOV.CONSECUTIVOCIT=CIT.CONSECUTIVO
                INNER JOIN  DBO.SERTOT1 SERTOT1 WITH(NOLOCK) ON IDTERCERO  = CIT.IDTERCEROCA
                                                   AND    SERTOT1.IDPLAN     = CIT.IDPLAN
                                                   AND    SERTOT1.IDSERVICIO = HCATDIMOV.IDSERVICIO
                                                   AND    CIT.FECHA     >= SERTOT1.FECHAINIFD 
                                                   AND    CIT.FECHA     <= SERTOT1.FECHAFINFD
                                                   AND    CIT.FECHA     >= SERTOT1.FECHAINI   
                                                   AND    CIT.FECHA     <= SERTOT1.FECHAFIN
                                                   AND    CIT.IDAREA     = SERTOT1.IDAREACA



         SELECT TOP 1  @VLR_UNITARIO=ROUND(COALESCE(VALOR,0),-2) 
         FROM SERTOT1
         WHERE IDTERCERO=@IDTERCEROCA
         AND IDPLAN=@IDPLANCA
         AND IDSERVICIO=@IDSERVICIO
         AND FECHAFIN>GETDATE()
         AND FECHAFINFD>GETDATE()
         AND FECHAINI<=GETDATE()
         AND FECHAINIFD<=GETDATE()



SELECT	CIT.FECHA, CIT.IDCONTRATANTE IDTERCERO, CIT.IDPLAN, CIT.CCOSTO,
						CASE WHEN CIT.IDTERCEROCA IS NULL OR CIT.IDTERCEROCA='' THEN CIT.IDCONTRATANTE ELSE CIT.IDTERCEROCA END IDTERCEROCA,
						CIT.IDPLAN IDPLANCA, CIT.IDAREA, HCATDIMOV.IDSERVICIO,
						COALESCE(HCATDIMOV.CANTIDAD,0)-COALESCE(HCATDIMOV.CANT_DEVUELTA,0) CANTIDAD,
						VLR_UNITARIO VALOR,
						0 VALORCOPAGO,
						0 VALORPCOMP,
						VLR_UNITARIO  VALOREXCEDENTE,
						0 DESCUENTO,
						CIT.CONSECUTIVO NOADMISION, HCATDIMOV.CNSMOV NOPRESTACION, HCATDIMOV.ID NOITEM,
						ISNULL(HCATDIMOV.FACTURADA,0) FACTURADA, HCATDIMOV.N_FACTURA, 'ONCO' PROCEDENCIA, CIT.IDAFILIADO, CIT.IDMEDICO,
                  CIT.CLASEORDEN, COALESCE(CIT.IDPESPECIAL,'') IDPESPECIAL, COALESCE(CIT.RIESGO,'') RIESGO,CASE WHEN  COALESCE(FACTURABLE,0)=1 THEN 0 ELSE 1 END AS NOCOBRABLE,
                  COALESCE(CIT.IDSEDE,'') IDSEDE,COALESCE(HCATDIMOV.MARCAFAC,0)MARCAFAC , COALESCE(HCATDIMOV.USUMARCA,'') AS USUMARCA,HCATDIMOV.CNSFACT,CIT.NOAUTORIZACION,
                  CIT.TIPOCOPAGO,CIT.CODUNG
				FROM	DBO.HCATDIMOV  HCATDIMOV INNER  JOIN DBO.CIT CIT ON HCATDIMOV.CONSECUTIVOCIT=CIT.CONSECUTIVO
				WHERE 	CIT.CUMPLIDA = 1
				AND     NOT CIT.IDAFILIADO IS NULL AND COALESCE(CIT.FACTURABLE,0)=1
            AND IDTERCEROCA='0100000007' AND IDPLAN='C_STOT'