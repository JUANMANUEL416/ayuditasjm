CREATE OR ALTER PROCEDURE  DBO.SPQ_FTR_IMPRESION 
@JSON  NVARCHAR(MAX)
WITH ENCRYPTION
AS  
DECLARE	 @PARAMETROS  NVARCHAR(MAX)     
         ,@MODELO    VARCHAR(100)         
         ,@METODO    VARCHAR(100)	
         ,@USUARIO      VARCHAR(12)
DECLARE @EXISTE INT     
DECLARE @N_FACTURA VARCHAR(20)
DECLARE @PROCEDENCIA VARCHAR(10)
DECLARE @IDFORMATOFTR VARCHAR(20)
DECLARE @TIPOFAC    VARCHAR(2)
DECLARE @NOREFERENCIA VARCHAR(20)
DECLARE @IMPRIMEIDALTERNA SMALLINT
DECLARE @NROAFIS SMALLINT
DECLARE @IDSEDE VARCHAR(5)
DECLARE @VLLETRAS VARCHAR(1024)
DECLARE @NROLETRAS SMALLINT
DECLARE @REFERENCIA VARCHAR(20)
DECLARE @NOAUT VARCHAR(20)
DECLARE @VENDEDOR VARCHAR(20)
DECLARE @F_FACTURA  DATETIME
DECLARE @USUFACTURA VARCHAR(20)
DECLARE @NOMBREFACTU VARCHAR(120)
DECLARE @CARGO VARCHAR(20)
DECLARE @IDFIRMA VARCHAR(20)
DECLARE @EQUIPO VARCHAR(256)
DECLARE @FIMPRESION VARCHAR(70)
DECLARE @ENTERO BIT
DECLARE @IXCOUNTRY VARCHAR(20)
DECLARE @VLR_AFECTO DECIMAL(14,2)
DECLARE @VLR_INAFECTO DECIMAL(14,2)
DECLARE @VLR_SUBTOTAL DECIMAL(14,2)
DECLARE @CNSFNOT VARCHAR(20)
DECLARE @DEMO VARCHAR(20)
DECLARE @ANEXOIMPNOCOBRABLE VARCHAR(10)
DECLARE @MODERADORA TABLE(VALOR DECIMAL(14,2))
DECLARE @VLR_MODERA DECIMAL(14,2)
DECLARE @VLR_COPAGOS DECIMAL(14,2)
BEGIN  
	SET DATEFORMAT dmy
   SET LANGUAGE Spanish;
	SELECT *
	INTO #JSON
	FROM OPENJSON (@json)
	WITH (
		MODELO         VARCHAR(100)     '$.MODELO',
		METODO         VARCHAR(100)     '$.METODO',
		USUARIO        VARCHAR(12)      '$.USUARIO',
		PARAMETROS     NVARCHAR(MAX)  AS JSON
	)
	SELECT @MODELO = MODELO , @METODO = METODO , @PARAMETROS = PARAMETROS, @USUARIO = USUARIO
	FROM #JSON
	DECLARE @TBLERRORES TABLE(ERROR VARCHAR(200)); 

   INSERT INTO @MODERADORA
   SELECT  VALOR FROM MOCCD WHERE TIPODEPAGO='Moderadora'

	SELECT @N_FACTURA =  N_FACTURA,@CNSFNOT=COALESCE(CNSFNOT,'')
	FROM OPENJSON (@PARAMETROS)
	WITH (N_FACTURA       VARCHAR(20)    '$.N_FACTURA',
         CNSFNOT VARCHAR(20)     '$.CNSFNOT')

   SELECT @IXCOUNTRY = DBO.FNK_VALORVARIABLE('IXCOUNTRY')
   IF @METODO='DATOSFTR'
   BEGIN
      SELECT @PROCEDENCIA=PROCEDENCIA,@IDFORMATOFTR=LTRIM(RTRIM(COALESCE(IDFORMATO,''))),@TIPOFAC=TIPOFAC, @NOREFERENCIA=NOREFERENCIA,
             @IMPRIMEIDALTERNA=COALESCE(PPT.IMPRIMEIDALTERNA,0),@IDSEDE=FTR.IDSEDE,
              @VLLETRAS=LTRIM(RTRIM(TRIM(DBO.FNK_DE_VALORES_A_LETRAS(FTR.VR_TOTAL)))),
              @REFERENCIA=NOREFERENCIA,@VENDEDOR=VENDEDOR,@USUFACTURA=FTR.USUARIOFACTURA
      FROM FTR LEFT  JOIN PPT ON FTR.IDTERCERO=PPT.IDTERCERO AND FTR.IDPLAN=PPT.IDPLAN
      WHERE N_FACTURA=@N_FACTURA
      IF CHARINDEX('/100',@VLLETRAS,1)>0 AND @IXCOUNTRY<>'PERU'
      BEGIN 
         SELECT @NROLETRAS=LEN(@VLLETRAS)-8
         SELECT @VLLETRAS=SUBSTRING(@VLLETRAS,0,@NROLETRAS)
      END
      ELSE
      BEGIN 
         IF LEN(@VLLETRAS)<4
         BEGIN
            SELECT @VLLETRAS='Cero.'
         END
         IF  @IXCOUNTRY='PERU'
         BEGIN
            IF CHARINDEX('/100',@VLLETRAS,1)=0
            BEGIN
               SELECT @VLLETRAS=@VLLETRAS+' 00/100 '
            END
         END
      END
      SELECT @ANEXOIMPNOCOBRABLE=LTRIM(RTRIM(COALESCE(DBO.FNK_VALORVARIABLE('ANEXOIMPNOCOBRABLE'),'')))
      SELECT @IDFIRMA=NULL
      IF DBO.FNK_VALORVARIABLE('IDUSUARIO_REPRE')<>''
      BEGIN
         SELECT @IDFIRMA=IDFIRMA,@NOMBREFACTU=NOMBRE,@CARGO=CARGO FROM USUSU WHERE USUARIO=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDUSUARIO_REPRE')))
      END
      IF COALESCE(@IDFIRMA,'')=''
      BEGIN
         SELECT @IDFIRMA=IDFIRMA,@NOMBREFACTU=NOMBRE,@CARGO=CARGO FROM USUSU WHERE USUARIO=@USUFACTURA
      END
      SELECT @ENTERO=CASE WHEN DBO.FNK_VALORVARIABLE('IMP_SIN_DECIMAL_FTR')='SI' THEN 1 ELSE 0 END
      SELECT @EQUIPO=COALESCE(SYS_COMPUTERNAME,HOST_NAME()) FROM USUSU WHERE USUARIO=@USUARIO
      SELECT @VLR_MODERA=SUM(X.MODERADORA),@VLR_COPAGOS=SUM(X.COPAGOS)
      FROM (
            SELECT CASE WHEN VLR_COPAGOS IN(SELECT * FROM @MODERADORA) THEN VLR_COPAGOS ELSE 0 END MODERADORA,
                   CASE WHEN VLR_COPAGOS NOT IN(SELECT * FROM @MODERADORA) THEN VLR_COPAGOS ELSE 0 END COPAGOS
            FROM FTRD
            WHERE N_FACTURA=@N_FACTURA
            )X

      SELECT @FIMPRESION= CAST(DAY(GETDATE())AS VARCHAR(2))+' de '+
          UPPER(DATENAME(MONTH,GETDATE()))+' '+
          CAST(YEAR(GETDATE()) AS VARCHAR(4))+'  Hora:'+RIGHT(CONVERT(VARCHAR(20),GETDATE(),100),7)
      IF @IXCOUNTRY='PERU'
      BEGIN
         SELECT @VLR_AFECTO=SUM(CASE WHEN COALESCE(PIVA,0)>0 THEN COALESCE(VLRIMPUESTO,(VALOR*CANTIDAD),0)  ELSE 0 END), 
         @VLR_INAFECTO=SUM(CASE WHEN COALESCE(PIVA,0)=0 THEN (VLR_SERVICI-COALESCE(VLR_COPAGOS,0)) ELSE 0 END),
         @VLR_SUBTOTAL=ROUND(SUM(CASE WHEN  COALESCE(PIVA,0)>0 THEN VLR_SERVICI/(1+(PIVA/100)) ELSE VLR_SERVICI END),2)
         FROM FTRD 
         WHERE FTRD.N_FACTURA=@N_FACTURA
         AND COALESCE(PAQUETE,0)IN(0,2)
         IF COALESCE(@VLR_SUBTOTAL,0)<>(COALESCE(@VLR_AFECTO,0)+COALESCE(@VLR_INAFECTO,0))
         BEGIN
            SELECT @VLR_SUBTOTAL=(COALESCE(@VLR_AFECTO,0)+COALESCE(@VLR_INAFECTO,0))
         END
      END

      IF @TIPOFAC='M'
      BEGIN
         PRINT 'Reviso si son varios afiliados o solo uno '
         IF @PROCEDENCIA='CI' OR @REFERENCIA='UNIWEB' 
         BEGIN
            SELECT @NROAFIS=COUNT(1) 
			FROM (
				SELECT DISTINCT IDAFILIADO
				FROM FTRD INNER JOIN CIT ON FTRD.NOADMISION=CIT.CONSECUTIVO
				WHERE FTRD.N_FACTURA=@N_FACTURA
				GROUP BY CIT.IDAFILIADO 
			) X
            PRINT '@NROAFIS ='+STR(@NROAFIS)
         END
         IF  @PROCEDENCIA='CE' AND COALESCE(@NROAFIS,0)=0
         BEGIN
            SELECT @NROAFIS=COUNT(1) 
			FROM(
				SELECT DISTINCT IDAFILIADO
				FROM FTRD INNER JOIN AUT ON FTRD.NOADMISION=AUT.NOAUT
				WHERE FTRD.N_FACTURA=@N_FACTURA
            AND FTRD.PROCEDENCIA='CE'
				UNION ALL
				SELECT DISTINCT IDAFILIADO
				FROM FTRD INNER JOIN CIT ON FTRD.NOADMISION=CIT.CONSECUTIVO
				WHERE FTRD.N_FACTURA=@N_FACTURA
            AND FTRD.PROCEDENCIA='CI'
			) X
            PRINT '@NROAFIS CE='+STR(@NROAFIS)


            SELECT TOP 1 @NOAUT= NOADMISION FROM FTRD WHERE N_FACTURA=@N_FACTURA

         END
      END
      IF DBO.FNK_VALORVARIABLE('BDATA_PRODUCCION')<>DB_NAME()
      BEGIN
         SELECT @DEMO='DEMO'
      END
      ELSE
      BEGIN
         SELECT @DEMO=''
      END
      IF @PROCEDENCIA NOT IN('FINANCIERO','INVENTARIO')
      BEGIN
         IF  @TIPOFAC='I' OR @TIPOFAC='M' 
         BEGIN
         
            SELECT 'OK'OK,FTR.N_FACTURA,TER.TIPO_ID,TER.NIT,TER.DV,TER.RAZONSOCIAL,TER.IDALTERNA2,TRIM(TER.DIRECCION) DIRECCION,COALESCE(TER.TELEFONOS,'')TELEFONOS,
                   LOWER(COALESCE(TER.EMAIL,''))EMAIL,UPPER(CIU.NOMBRE) NOMBRE,UPPER(DEP.NOMBRE) AS DPTO,CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,CONVERT(varchar,FECHAFAC,108)HFACTURA,
				   COALESCE(CONVERT(VARCHAR,FTRE.FECHA,103),'')FECHAVAL,CONVERT(VARCHAR,FTRE.FECHA,108)HVALIDA,
                   CONVERT(VARCHAR,F_VENCE,103)F_VENCE,LTRIM(RTRIM(COALESCE(IDFORMATO,'')))IDFORMATO,
                   FTR.PROCEDENCIA,COALESCE(FTR.FACTE,0)ESTDIAN,FTR.VR_ABONOS,
                   CASE WHEN @DEMO='' THEN  CASE WHEN FTR.ESTADO='A' THEN 'ANULADA' ELSE CASE WHEN COALESCE(TIPOANULACION,'')<>'' THEN 'ANULADA NC' ELSE 'OK' END END ELSE @DEMO END ESTADO,
                   AFI.DOCIDAFILIADO,AFI.TIPO_DOC,AFI.NOMBREAFI,AFI.EDAD,DBO.FN_EDAD_PACIENTE(AFI.FNACIMIENTO,FTR.F_FACTURA,'ALL') EDAD1,AFI.DIRECCION AS AFI_DIR,AFI.TELEFONORES AS AFI_TEL,
                   AFI.CELULAR,UPPER(CIUF.NOMBRE) CIUD_AFI,UPPER(DEPF.NOMBRE) AS DPTO_AFI,
                   AFI.TIPOUSUARIO AS   TIPOAFILIADO, @EQUIPO EQUIPO,@FIMPRESION FIMPRESION,@USUARIO USUARIO,
                    CASE  WHEN COALESCE(TUSU.DESCRIPCION,'')='' THEN 
                       CASE  WHEN AFI.TIPOAFILIADO = 'C' THEN 'Cotizante'
                              WHEN AFI.TIPOAFILIADO = 'B' THEN 'Beneficiario'
                              WHEN AFI.TIPOAFILIADO = 'J' THEN 'Jubilado'
                              WHEN AFI.TIPOAFILIADO = 'A' THEN 'Adicional'
                              WHEN AFI.TIPOAFILIADO = 'S' THEN 'Sustitución Pensional'
                              WHEN AFI.TIPOAFILIADO = 'Sb' THEN 'Subsidiado'
                              WHEN AFI.TIPOAFILIADO = 'SR' THEN 'Sin régimen'
                              WHEN AFI.TIPOAFILIADO = 'TA' THEN 'Tomador/Amparado'
                              WHEN AFI.TIPOAFILIADO = 'RE' THEN 'Régimen Especial'
                              WHEN AFI.TIPOAFILIADO = 'SN' THEN 'Subsidiado'
                              WHEN AFI.TIPOAFILIADO = 'S/' THEN 'Subsidiado'
                              WHEN AFI.TIPOAFILIADO = 'S/N' THEN 'Subsidiado' ELSE '' END 
                           ELSE COALESCE(TUSU.DESCRIPCION,'') END                              
                           TIPOAFI_NOMBRE,
                   AFI.NIVELSOCIOEC,AFI.SEXO, AFI.SISBENNUMFICHA ,AFI.SISBENNIVEL,
                   FTR.IDPLAN,PLN.DESCPLAN,PLN.TIPOSISTEMA,
                   COALESCE(DBO.FNK_VALORVARIABLE('FTR_IMPNOCONTRATO'),'') FTR_IMPNOCONTRATO,
                   CASE WHEN COALESCE(DBO.FNK_VALORVARIABLE('FTR_IMPNOCONTRATO'),'') = 'SI' THEN CASE WHEN  COALESCE(PPT.NROCONTRATO,'')<>'' THEN COALESCE(PPT.NROCONTRATO,'') WHEN COALESCE(PPT.IDCONTRATO,'')<>'' THEN IIF(COALESCE(CNT.IDALTERNA,'')<>'', CNT.IDALTERNA, COALESCE(PPT.IDCONTRATO,'')) ELSE '' END END IDCONTRATO,
                   CASE WHEN COALESCE(@NOAUT,'')<>'' THEN @NOAUT ELSE  FTR.NOREFERENCIA END NOREFERENCIA,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTR.VALORSERVICIOS  AS MONEY), 1))VALORSERVICIOS,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTR.VALORCOPAGO  AS MONEY), 1))VALORCOPAGO,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTR.DESCUENTO  AS MONEY), 1))DESCUENTO,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTR.VR_TOTAL  AS MONEY), 1))VR_TOTAL,
                   FTR.VALORSERVICIOS AS VSERVICIOS,CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTR.VALOR_SERVICIOS_SIN_IGV  AS MONEY), 1)) AS VALOR_SERVICIOS_SIN_IGV,FTR.VALORCOPAGO AS VCOPAGO,FTR.DESCUENTO AS VDESCUENTO,FTR.VR_TOTAL AS VTOTAL,
                   FTR.VIVA,COALESCE(@VLR_AFECTO,0)AFECTO,COALESCE(@VLR_INAFECTO,0)INAFECTO,COALESCE(@VLR_SUBTOTAL,0)VLR_SUBTOTAL,
                    @VLLETRAS+CASE WHEN @IXCOUNTRY='PERU' THEN ' SOLES ' WHEN FTR.MONEDA = 'USD' THEN ' DOLARES ' ELSE ' PESOS M/CTE. ' END AS LETRAS,
                  --dbo.FNK_MontoEscrito(FTR.VR_TOTAL)LETRAS,
                   CASE WHEN COALESCE(@NOMBREFACTU,'')<>'' THEN @NOMBREFACTU ELSE USUSU.NOMBRE END AS NFACTURADOR,
                   CASE WHEN COALESCE(@CARGO,'')<>'' THEN @CARGO  ELSE USUSU.CARGO END CARGO,
                   CASE WHEN @IXCOUNTRY='PERU' THEN (SELECT CUFE FROM FTRE WHERE FTRN_FACTURA=FTR.N_FACTURA) ELSE COALESCE(FTR.CUFE,'') END CUFE,
                   REPLACE(REPLACE(REPLACE(LTRIM(RTRIM(COALESCE(DBO.FNK_RTF(FDIAN.TITULO),''))),CHAR(13),''),CHAR(10),''),'¾', 'ó')RESOL,
                   CASE WHEN @IXCOUNTRY='PERU' THEN (SELECT CUFE FROM FTRE WHERE FTRN_FACTURA=FTR.N_FACTURA) ELSE COALESCE(DBO.FNK_QRCODE(FTR.N_FACTURA),'') END CODQR,
                   CASE WHEN EXISTS(SELECT DICOM FROM ARCHIVOS WHERE ID =@IDFIRMA ) 
                        THEN  (SELECT DICOM FROM ARCHIVOS WHERE ID =@IDFIRMA)
                        ELSE '' END DICOM,
                   COALESCE(SED.LEGAL,'')+COALESCE(SED.LEGAL2,'') AS LEGAL,
                   COALESCE(SED.LEGAL3,'')+COALESCE(SED.LEGAL4,'') AS LEGAL1,
                   (SELECT NOMBRE FROM USUSU WHERE USUARIO=@USUARIO)IMPRESO,
                   CASE WHEN @IXCOUNTRY='PERU' THEN CASE WHEN TIPOFIN='N' THEN 'CONTADO' ELSE 'CREDITO A '+CAST(CASE WHEN COALESCE(PPT.DIASVTO,30)<=0 THEN 30 ELSE PPT.DIASVTO END  AS VARCHAR(4))+' Días' END ELSE 'Forma de Pago:'+CASE WHEN COALESCE(TER.ENVIODICAJA,0)=1 THEN 'Contado' ELSE 'Credito '+CAST(COALESCE(PPT.DIASVTO,30) AS VARCHAR(4))+' Días' END END FPAGO,
				   CASE WHEN FTR.IDPLAN IN (
						DBO.FNK_VALORVARIABLE('IDPLANPART'), DBO.FNK_VALORVARIABLE('IDPLANPART2'), DBO.FNK_VALORVARIABLE('IDPLANPART3'), DBO.FNK_VALORVARIABLE('IDPLANPART4'), DBO.FNK_VALORVARIABLE('IDPLANPART5')
					) OR TER.IDTERCERO = DBO.FNK_VALORVARIABLE('IDTERCEROPARTICULAR') THEN 'Contado'
					WHEN COALESCE(PPT.DIASVTO,0) = 0 THEN 'Contado' ELSE 'Credito ' END FPAGO2,
                   (SELECT 'PROVEEDOR ELECTRÓNICO: '+LTRIM(RTRIM(TER.RAZONSOCIAL))+', NIT:'+LTRIM(RTRIM(NIT))+'-'+LTRIM(RTRIM(STR(DV)))  
                     FROM TER WHERE IDTERCERO=DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO'))PROFE,
                   (SELECT CASE WHEN DBO.FNK_VALORVARIABLE('DATOSPROPIETARIO')='SEDE' AND DBO.FNK_VALORVARIABLE('FACTSEDE') ='NO'
                     THEN COALESCE(SED.CODHABILITA,TER.IDALTERNA2) ELSE TER.IDALTERNA2 END FROM TER LEFT JOIN SED ON TER.NIT=SED.NIT
                     WHERE IDTERCERO=DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO')
                     AND SED.IDSEDE=FTR.IDSEDE)CODHABILITA                   
                   ,CASE WHEN @TIPOFAC='M' THEN @NROAFIS ELSE 1 END NROAFI,
                   DBO.FNK_VALORVARIABLE('FTR_03F_NOAUT') FTR_03F_NOAUT ,FTR.USUARIOFACTURA,USUSU.NOMBRE AS NUSUFACTURA,
                   @ENTERO AS ENTERO,CASE TIPOFIN WHEN 'N' THEN 'B' ELSE 'F' END TIPOFACT,
                    CASE WHEN @IXCOUNTRY='PERU' AND VR_TOTAL>700 THEN ROUND((VR_TOTAL*0.12),2) ELSE 0 END VR_DETRA,
                    COALESCE(FTR.PAQUETE,0)PAQUETE,
                    COALESCE(TER.SIIF,0)SIIF,
                    IIF(COALESCE(TER.SIIF,0)=1,CONCAT('#$',COALESCE(TER.SIIFCODIGOPCI, ''),';',COALESCE(TER.SIIFCONTRATO, ''),';',COALESCE(TER.SIIFCORREOSUPER, ''),'#$'),'') NOTAS,
                    FTR.OBSERVACION OBSERVACIONES,COALESCE(EMP.RAZONSOCIAL,'') AS COMPANIA,SED.DESCRIPCION AS IDSEDEATE,SED.CODHABILITA AS SEDCODHABI,
                    CONCAT(YEAR(F_FACTURA),'/',CASE WHEN MONTH(F_FACTURA)<10 THEN '0'+CAST(MONTH(F_FACTURA) AS VARCHAR(1)) ELSE CAST(MONTH(F_FACTURA)AS VARCHAR(2)) END)  PERIODO,
                    @VLR_MODERA AS VLR_TMODERADORA,@VLR_COPAGOS AS VLR_TCOPAGOS, PPT.RESUMEN AS RESUMEN_CONTRATO
                    , IIF(COALESCE(DBO.FNK_VALORVARIABLE('ESCUOTARECUPE'),'SI')='SI', 1 , 0) ESCUOTARECUPERACION 
                    , IIF(@TIPOFAC='M' , 0, IIF( FTR.PROCEDENCIA IN ('CE','CI') , (SELECT TOP 1 COPAGOPROPIO FROM CIT WHERE CIT.CONSECUTIVO= FTR.NOREFERENCIA  AND FTR.PROCEDENCIA='CI') + (SELECT TOP 1 COPAGOPROPIO FROM AUT WHERE AUT.NOAUT= FTR.NOREFERENCIA AND FTR.PROCEDENCIA='CE') , 0 ) ) COPAGOPROPIO
            FROM FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
                     INNER JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
                     LEFT  JOIN AFI ON FTR.IDAFILIADO=AFI.IDAFILIADO
                     LEFT  JOIN CIU ON TER.CIUDAD=CIU.CIUDAD
                     LEFT  JOIN CIU CIUF ON AFI.CIUDAD=CIUF.CIUDAD
                     LEFT  JOIN DEP ON CIU.DPTO=DEP.DPTO
                     LEFT  JOIN DEP DEPF ON CIUF.DPTO=DEPF.DPTO
                     LEFT  JOIN PPT ON FTR.IDTERCERO=PPT.IDTERCERO AND FTR.IDPLAN=PPT.IDPLAN
                     LEFT JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
                     LEFT JOIN ARCHIVOS ON USUSU.IDFIRMA=ARCHIVOS.ID
                     LEFT JOIN FDIAN ON FTR.CNSRESOL=FDIAN.CNSRESOL
                     LEFT JOIN FTRE  ON FTR.N_FACTURA=FTRE.FTRN_FACTURA AND FTR.PREFIJODIANFE=FTRE.PREFIJO AND FTR.CNSDIANFE=FTRE.N_FACTURA
                     LEFT JOIN CNT   ON PPT.IDCONTRATO=CNT.IDCONTRATO
                     LEFT JOIN SED   ON FTR.IDSEDE=SED.IDSEDE
                     LEFT JOIN TGEN TUSU ON AFI.TIPOUSUARIO=TUSU.CODIGO AND TABLA='AFI' AND CAMPO='TIPO_USUARIO'
                     LEFT JOIN TER EMP ON AFI.IDEMPLEADOR=EMP.IDTERCERO

            WHERE FTR.N_FACTURA=@N_FACTURA

            IF @PROCEDENCIA='CI' OR ( @REFERENCIA='UNIWEB' AND @PROCEDENCIA<>'CE') OR @PROCEDENCIA='MAD'
            BEGIN
               IF @TIPOFAC='I'
               BEGIN
                  IF  @PROCEDENCIA='MAD'
                  BEGIN
                     SELECT MED.NOMBRE,MES.DESCRIPCION,MED.NO_REGISTRO,MAD.NOAUTORIZACION,DBO.FNK_FECHA_DDMMAA(CIT.FECHA)FECHAING,CONVERT(VARCHAR,CIT.FECHA,108)HORACIT,
                            DBO.FNK_FECHA_DDMMAA(CIT.FECHA)FECHAEGR,MAD.PROCEDENCIA,HCA.IDDX,MDX.DESCRIPCION AS DESCMDX,CIT.IDSERVICIO
                     FROM MAD INNER JOIN CIT ON MAD.CONSECUTIVOCIT=CIT.CONSECUTIVO
                                      INNER JOIN MED ON CIT.IDMEDICO=MED.IDMEDICO
                                      LEFT  JOIN MES  ON MED.IDEMEDICA=MES.IDEMEDICA
                                      LEFT  JOIN HCA ON CIT.CONSECUTIVO=HCA.CONSECUTIVOCIT
                                      LEFT  JOIN MDX ON HCA.IDDX=MDX.IDDX
                     WHERE MAD.N_FACTURA=@N_FACTURA
                  END
                  ELSE
                  BEGIN
                     SELECT MED.NOMBRE,MES.DESCRIPCION,MED.NO_REGISTRO,COALESCE(CIT.NOAUTORIZACION,'') NOAUTORIZACION,CONVERT(VARCHAR,CIT.FECHA,103)FECHAING,CONVERT(VARCHAR,CIT.FECHA,103)FECHAEGR,
                            CASE COALESCE(CIT.MODALIDAD,'Presencial') WHEN 'Virtual' THEN 'Virtual' ELSE 'Presencial' END MODALIDAD,HCA.IDDX,MDX.DESCRIPCION AS DESCMDX
                     FROM CIT INNER JOIN MED ON CIT.IDMEDICO=MED.IDMEDICO
                              INNER JOIN MES ON CASE WHEN COALESCE(CIT.IDEMEDICA,'')='' THEN MED.IDEMEDICA ELSE COALESCE(CIT.IDEMEDICA,'') END=MES.IDEMEDICA
                              LEFT  JOIN HCA ON CIT.CONSECUTIVO=HCA.CONSECUTIVOCIT
                              LEFT  JOIN MDX ON HCA.IDDX=MDX.IDDX
                     WHERE CIT.CONSECUTIVO=@NOREFERENCIA
                  END
               END
               ELSE
               BEGIN
                  SELECT TOP 1 MED.NOMBRE,MES.DESCRIPCION,COALESCE(CIT.NOAUTORIZACION,'')NOAUTORIZACION,CONVERT(VARCHAR,MIN(CIT.FECHA) OVER (PARTITION BY FTRD.N_FACTURA),103)FECHAING,CONVERT(VARCHAR,MAX(CIT.FECHA) OVER (PARTITION BY FTRD.N_FACTURA),103)FECHAEGR
                  FROM FTRD LEFT JOIN CIT ON FTRD.NOADMISION=CIT.CONSECUTIVO
                            LEFT JOIN MED ON CIT.IDMEDICO=MED.IDMEDICO
                            LEFT JOIN MES ON CASE WHEN COALESCE(CIT.IDEMEDICA,'')='' THEN MED.IDEMEDICA ELSE COALESCE(CIT.IDEMEDICA,'') END=MES.IDEMEDICA
                  WHERE FTRD.N_FACTURA=@N_FACTURA
                  --GROUP BY MED.NOMBRE,MES.DESCRIPCION,COALESCE(CIT.NOAUTORIZACION,'')
               END
               IF @TIPOFAC='M'
               BEGIN
                  PRINT 'DEBERIA INGRESSAR ACA'
                  IF @IDFORMATOFTR='03F'
                  BEGIN        
                     SELECT FTRD.PREFIJO,PRE.NOM_PREFIJO,
                     CASE  @IMPRIMEIDALTERNA 
                        WHEN 0 THEN FTRD.REFERENCIA
                        WHEN 1 THEN SER.IDALTERNA
                        WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE COALESCE(SER.CODCUM,SER.IDALTERNA) END --CUM
                        WHEN 3 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END --ATC
                        WHEN 4 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --ADRES
                        WHEN 5 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDSERVICIO END--SAVIA
                        WHEN 6 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.CODSISPRO END -- SISPRO
                        WHEN 7 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --INVINA
                        WHEN 8 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END -- SOLOCUPS
                        WHEN 9 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END --CUM CUPS
                        WHEN 10 THEN CASE WHEN SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END -- CODIGO SOAT
                     END IDSERVICIO,
                     CASE  @IMPRIMEIDALTERNA    
                        WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS=1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE '' END --CUM
                        ELSE SER.CODCUPS
                     END CODCUPS,
                     CASE  WHEN @IMPRIMEIDALTERNA IN (8,9) THEN SER.DESCRIPCION_CUPS
                           ELSE FTRD.ANEXO
                     END ANEXO,
                     (SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=1) ANEXO1,
                     COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=2),'') ANEXO2,
                     FTRD.CANTIDAD AS CANTIDAD,FTRD.VALOR AS VLR_UNI,FTRD.VLR_COPAGOS AS VLR_COPA,VR_TOTAL AS VLRTOTAL,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST((FTRD.VALOR)  AS MONEY), 1))VALOR,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST((FTRD.VLR_COPAGOS)  AS MONEY), 1))VLR_COPAGOS,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST((FTRD.VR_TOTAL)  AS MONEY), 1))VR_TOTAL,
--                     ROUND(CASE WHEN COALESCE(PIVA,0)>0 AND COALESCE(FTRD.VLR_COPAGOS,0)>0 THEN (FTRD.VLR_COPAGOS/(1+(PIVA/100))) ELSE  COALESCE(FTRD.VLR_COPAGOS,0) END,2) COPA_SINIGV,
                     CONVERT(DECIMAL(14,2),CASE WHEN COALESCE(PIVA,0)>0 AND COALESCE(FTRD.VALOR,0)>0 THEN ROUND(FTRD.VALOR*(1+(PIVA/100)),2) ELSE  COALESCE(FTRD.VALOR,0) END) VLR_UNI_IGV,
                     CONVERT(VARCHAR,FTRD.FECHAPREST,103)FECHAPREST
                     FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                               INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
                     WHERE N_FACTURA=@N_FACTURA
                     ORDER BY FTRD.FECHAPREST,PRE.PREFIJO,SER.IDSERVICIO
                  END
                  ELSE
                  BEGIN
                     PRINT '@IMPRIMEIDALTERNA='+STR(@IMPRIMEIDALTERNA)
                     SELECT FTRD.PREFIJO,PRE.NOM_PREFIJO,
                     CASE  @IMPRIMEIDALTERNA 
                        WHEN 0 THEN FTRD.REFERENCIA
                        WHEN 1 THEN SER.IDALTERNA
                        WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE COALESCE(SER.CODCUM,SER.IDALTERNA) END --CUM
                        WHEN 3 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END --ATC
                        WHEN 4 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --ADRES
                        WHEN 5 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDSERVICIO END--SAVIA
                        WHEN 6 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.CODSISPRO END -- SISPRO
                        WHEN 7 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --INVINA
                        WHEN 8 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END -- SOLOCUPS
                        WHEN 9 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END --CUM CUPS
                        WHEN 10 THEN CASE WHEN SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END -- CODIGO SOAT
                     END IDSERVICIO,
                     CASE  @IMPRIMEIDALTERNA    
                        WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS=1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE '' END --CUM
                        ELSE SER.CODCUPS
                     END CODCUPS,
                     CASE  WHEN @IMPRIMEIDALTERNA IN (8,9) THEN SER.DESCRIPCION_CUPS
                           ELSE FTRD.ANEXO
                     END ANEXO,
                     (SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=1) ANEXO1,
                     COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',65,'') WHERE VEZ=2),'') ANEXO2,
                     SUM(FTRD.CANTIDAD)CANTIDAD,FTRD.VALOR AS  VLR_UNI,SUM(FTRD.VLR_COPAGOS) VLR_COPA,SUM(VR_TOTAL) VLRTOTAL,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(SUM(FTRD.VALOR)  AS MONEY), 1))VALOR,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(SUM(FTRD.VLR_COPAGOS)  AS MONEY), 1))VLR_COPAGOS,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(SUM(FTRD.VR_TOTAL)  AS MONEY), 1))VR_TOTAL,
                     --ROUND(SUM(CASE WHEN COALESCE(PIVA,0)>0 AND COALESCE(FTRD.VLR_COPAGOS,0)>0 THEN (FTRD.VLR_COPAGOS/(1+(PIVA/100))) ELSE  COALESCE(FTRD.VLR_COPAGOS,0) END),2) COPA_SINIGV,
                     CONVERT(DECIMAL(14,2),SUM(CASE WHEN COALESCE(PIVA,0)>0 AND COALESCE(FTRD.VALOR,0)>0 THEN ROUND(FTRD.VALOR*(1+(PIVA/100)),2) ELSE  COALESCE(FTRD.VALOR,0) END)) VLR_UNI_IGV
                     FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                               INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
                     WHERE N_FACTURA=@N_FACTURA
                     AND FTRD.VALOR>0
                     GROUP BY FTRD.PREFIJO,PRE.NOM_PREFIJO,FTRD.REFERENCIA,SER.IDALTERNA,SER.MEDICAMENTOS,SER.CODCUPS,
                     SER.CODCUM,SER.IDSERVICIO,SER.CODSISPRO,FTRD.ANEXO,PRE.PREFIJO,FTRD.VALOR, SER.DESCRIPCION_CUPS
                     ORDER BY PRE.PREFIJO,SER.IDSERVICIO
                  END
               END
               ELSE 
               BEGIN
                  IF @IDFORMATOFTR='01'
                  BEGIN
                     SELECT FTRD.AREAPRESTACION,AFU.DESCRIPCION,FTRD.PREFIJO,PRE.NOM_PREFIJO,SUM(FTRD.VLR_SERVICI) VLR_SERVICI
                      FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                               INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
                               LEFT  JOIN AFU ON FTRD.AREAPRESTACION=AFU.IDAREA
                     WHERE N_FACTURA= @N_FACTURA
                     AND FTRD.VALOR>0
                     GROUP BY FTRD.AREAPRESTACION,AFU.DESCRIPCION,FTRD.PREFIJO,PRE.NOM_PREFIJO
                     ORDER BY  FTRD.AREAPRESTACION,FTRD.PREFIJO               
                  END
                  ELSE
                  BEGIN
                     SELECT FTRD.PREFIJO,PRE.NOM_PREFIJO,FTRD.AREAPRESTACION,AFU.DESCRIPCION, FORMAT(FTRD.FECHAPREST, 'dd/MM/yyyy') FECHAPREST,
                     CASE  @IMPRIMEIDALTERNA 
                        WHEN 0 THEN FTRD.REFERENCIA
                        WHEN 1 THEN SER.IDALTERNA
                        WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE COALESCE(SER.CODCUM,SER.IDALTERNA) END --CUM
                        WHEN 3 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END --ATC
                        WHEN 4 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --ADRES
                        WHEN 5 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDSERVICIO END--SAVIA
                        WHEN 6 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.CODSISPRO END -- SISPRO
                        WHEN 7 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --INVINA
                        WHEN 8 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END -- SOLOCUPS
                        WHEN 9 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END --CUM CUPS
                        WHEN 10 THEN CASE WHEN SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END -- CODIGO SOAT
                     END IDSERVICIO,
                     CASE  @IMPRIMEIDALTERNA    
                        WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS=1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE '' END --CUM
                        ELSE  COALESCE(SER.CODCUPS,SER.IDSERVICIO)
                     END CODCUPS,
                     CASE  WHEN @IMPRIMEIDALTERNA IN (8,9) THEN COALESCE(SER.DESCRIPCION_CUPS,DESCSERVICIO)
                           ELSE FTRD.ANEXO
                     END ANEXO,
                     (SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=1) ANEXO1,
                     COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=3),'') ANEXO2,
                     FTRD.CANTIDAD,FTRD.VALOR VLR_UNI,FTRD.VLR_COPAGOS VLR_COPA,VR_TOTAL VLRTOTAL, FTRD.VLR_SERVICI VLRSERV,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VALOR  AS MONEY), 1))VALOR,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VLR_COPAGOS  AS MONEY), 1))VLR_COPAGOS,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VR_TOTAL  AS MONEY), 1))VR_TOTAL,
                     CONVERT(DECIMAL(14,2),CASE WHEN COALESCE(PIVA,0)>0 AND COALESCE(FTRD.VLR_COPAGOS,0)>0 THEN ROUND((FTRD.VLR_COPAGOS/(1+(PIVA/100))),2) ELSE  COALESCE(FTRD.VLR_COPAGOS,0) END) COPA_SINIGV,
                     CONVERT(DECIMAL(14,2),CASE WHEN COALESCE(PIVA,0)>0  THEN  ROUND(FTRD.VLR_SERVICI/(1+(PIVA/100)),2) ELSE FTRD.VLR_SERVICI END) VLRTOT_SINIGV,
                     FTRD.VLR_SERVICI,
                     FTRD.VALOR_UNITARIO_SIN_IGV,
                     FTRD.VALOR_IGV_UNITARIO,
                     FTRD.VALOR_UNITARIO_CON_IGV,
                     FTRD.VALOR_COPAGO_UNIT_SIN_IGV,
                     FTRD.VALOR_COPAGO_IGV_UNIT,
                     FTRD.VALOR_COPAGO_TOTAL_SIN_IGV
                     FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                               INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
                               LEFT  JOIN AFU ON FTRD.AREAPRESTACION=AFU.IDAREA
                     WHERE N_FACTURA=@N_FACTURA
						   AND 1= CASE WHEN @ANEXOIMPNOCOBRABLE='SI' THEN 1 ELSE CASE WHEN COALESCE(FTRD.VLR_SERVICI,0) > 0 THEN 1 ELSE 0 END END
						   ORDER BY CASE WHEN @ANEXOIMPNOCOBRABLE = 'SI' THEN FTRD.VR_TOTAL END DESC,
                              CASE WHEN @ANEXOIMPNOCOBRABLE <> 'SI' THEN FTRD.PREFIJO END ASC,
                              SER.IDSERVICIO
                  END
               END
            END
            IF @PROCEDENCIA='CE'
            BEGIN
               IF @TIPOFAC='I'
               BEGIN
                  SELECT COALESCE(MED.NOMBRE,'')NOMBRE,COALESCE(MES.DESCRIPCION,'')DESCRIPCION,COALESCE(AUT.NUMAUTORIZA,'')NOAUTORIZACION
				            ,CONVERT(VARCHAR,AUT.FECHA,103) FECHAING,CONVERT(VARCHAR,AUT.FECHA,108) HORACIT
				            ,CASE WHEN PLN.TIPOPLAN = 'MES' THEN CONVERT(VARCHAR,EOMONTH(AUT.FECHA),103)
				           ELSE CONVERT(VARCHAR,AUT.FECHA,103) 
				      END FECHAEGR,HCA.IDDX,MDX.DESCRIPCION AS DESCMDX
                  FROM AUT LEFT JOIN MED ON AUT.IDSOLICITANTE=MED.IDMEDICO
                           LEFT JOIN MES ON MED.IDEMEDICA=MES.IDEMEDICA
                           LEFT JOIN HCA ON AUT.CONSECUTIVOHCA=HCA.CONSECUTIVO
                           LEFT JOIN MDX ON HCA.IDDX=MDX.IDDX
						   LEFT JOIN PLN ON AUT.IDPLAN = PLN.IDPLAN
                  WHERE NOAUT=@NOREFERENCIA  
               END
               ELSE
               BEGIN
                  IF @NROAFIS >1
                  BEGIN
					      SELECT ''NOMBRE,'' DESCRIPCION,CONVERT(VARCHAR,MIN(FECHA),103)FECHAING,CONVERT(VARCHAR,MAX(FECHA),103)FECHAEGR FROM(
                     SELECT '' NOMBRE,'' DESCRIPCION,''NOAUTORIZACION
                           ,FECHA
                     FROM AUT LEFT JOIN MED ON AUT.IDSOLICITANTE=MED.IDMEDICO
                              LEFT JOIN MES ON MED.IDEMEDICA=MES.IDEMEDICA
                     WHERE AUT.N_FACTURA=@N_FACTURA   
                     UNION ALL
                     SELECT '','',''NOAUTORIZACION,CASE WHEN @IDFORMATOFTR IN('03G1','03G2') THEN COALESCE(FTRD.FECHAPREST,CIT.FECHA) ELSE CIT.FECHA END
                     FROM FTRD LEFT JOIN CIT ON FTRD.NOADMISION=CIT.CONSECUTIVO
                               LEFT JOIN MED ON CIT.IDMEDICO=MED.IDMEDICO
                               LEFT JOIN MES ON COALESCE(CIT.IDEMEDICA,MED.IDEMEDICA)=MES.IDEMEDICA
                     WHERE FTRD.N_FACTURA=@N_FACTURA )X
					      WHERE X.FECHA IS NOT NULL
                  END
                  ELSE 
                  BEGIN
                     SELECT COALESCE(MED.NOMBRE,'')NOMBRE,COALESCE(MES.DESCRIPCION,'')DESCRIPCION,COALESCE(AUT.NUMAUTORIZA,'')NOAUTORIZACION
                           ,CONVERT(VARCHAR,FECHA,103)FECHAING,CONVERT(VARCHAR,FECHA,103)FECHAEGR
                     FROM AUT LEFT JOIN MED ON AUT.IDSOLICITANTE=MED.IDMEDICO
                              LEFT JOIN MES ON MED.IDEMEDICA=MES.IDEMEDICA
                     WHERE NOAUT=@NOAUT   
                     UNION ALL
                     SELECT TOP 1 MED.NOMBRE,MES.DESCRIPCION,COALESCE(CIT.NOAUTORIZACION,'')NOAUTORIZACION,CONVERT(VARCHAR,MIN(CIT.FECHA),103)FECHAING,CONVERT(VARCHAR,MAX(CIT.FECHA),103)FECHAEGR
                     FROM FTRD LEFT JOIN CIT ON FTRD.NOADMISION=CIT.CONSECUTIVO
                               LEFT JOIN MED ON CIT.IDMEDICO=MED.IDMEDICO
                               LEFT JOIN MES ON COALESCE(CIT.IDEMEDICA,MED.IDEMEDICA)=MES.IDEMEDICA
                     WHERE FTRD.N_FACTURA=@N_FACTURA
                     GROUP BY MED.NOMBRE,MES.DESCRIPCION,COALESCE(CIT.NOAUTORIZACION,'')
                  END
               END
			      IF @IDFORMATOFTR='01' 
               BEGIN
                  SELECT FTRD.AREAPRESTACION,AFU.DESCRIPCION,FTRD.PREFIJO,PRE.NOM_PREFIJO,SUM(FTRD.VLR_SERVICI) VLR_SERVICI
                  FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                            INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
                            LEFT  JOIN AFU ON FTRD.AREAPRESTACION=AFU.IDAREA
                  WHERE N_FACTURA= @N_FACTURA
                  AND FTRD.VALOR>0
                  GROUP BY FTRD.AREAPRESTACION,AFU.DESCRIPCION,FTRD.PREFIJO,PRE.NOM_PREFIJO
                  ORDER BY  FTRD.AREAPRESTACION,FTRD.PREFIJO               
              END
			     ELSE
				  BEGIN
					
					IF EXISTS(SELECT 1 FROM FTRD WHERE PREFIJO = DBO.FNK_VALORVARIABLE('PREFIJOMEDICAMENTOS') AND N_FACTURA=@N_FACTURA) AND DBO.FNK_VALORVARIABLE('INVDISPENSA_ART_HIJO') = 'SI'
					BEGIN
						SELECT FTRD.PREFIJO,PRE.NOM_PREFIJO, FORMAT(FTRD.FECHAPREST, 'dd/MM/yyyy') FECHAPREST,
						CASE  @IMPRIMEIDALTERNA    
							WHEN 0 THEN FTRD.REFERENCIA
							WHEN 1 THEN SER.IDALTERNA
							WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE COALESCE(SER.CODCUM,SER.IDALTERNA) END --CUM
							WHEN 3 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END --ATC
							WHEN 4 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --ADRES
							WHEN 5 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDSERVICIO END--SAVIA
							WHEN 6 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.CODSISPRO END -- SISPRO
							WHEN 7 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --INVINA
							WHEN 8 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END -- SOLOCUPS
							WHEN 9 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END --CUM CUPS
							WHEN 10 THEN CASE WHEN SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END -- CODIGO SOAT
							ELSE FTRD.REFERENCIA
						END IDSERVICIO,
						CASE  @IMPRIMEIDALTERNA    
							WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS=1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE '' END --CUM
							ELSE SER.CODCUPS
						END CODCUPS,
						CASE  WHEN @IMPRIMEIDALTERNA IN (8,9) THEN SER.DESCRIPCION_CUPS
								ELSE FTRD.ANEXO
						END ANEXO,

						(SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=1) ANEXO1,
						COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=2),'') ANEXO2,
						FTRD.CANTIDAD,FTRD.VALOR VLR_UNI,FTRD.VLR_COPAGOS VLR_COPA,VR_TOTAL VLRTOTAL,FTRD.VLR_SERVICI VLRSERV,
						CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VALOR  AS MONEY), 1))VALOR,
						CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VLR_COPAGOS  AS MONEY), 1))VLR_COPAGOS,
						CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VR_TOTAL  AS MONEY), 1))VR_TOTAL,
						CONVERT(DECIMAL(14,2),CASE WHEN COALESCE(PIVA,0)>0 AND COALESCE(FTRD.VLR_COPAGOS,0)>0 THEN ROUND((FTRD.VLR_COPAGOS/(1+(PIVA/100))),2) ELSE  COALESCE(FTRD.VLR_COPAGOS,0) END) COPA_SINIGV,
						CONVERT(DECIMAL(14,2),CASE WHEN COALESCE(PIVA,0)>0  THEN  ROUND((FTRD.VLR_SERVICI-COALESCE(FTRD.VLR_COPAGOS,0))/(1+(PIVA/100)),2) ELSE (FTRD.VLR_SERVICI-COALESCE(FTRD.VLR_COPAGOS,0)) END) VLRTOT_SINIGV,
						FTRD.VLR_SERVICI,
                  FTRD.VALOR_UNITARIO_SIN_IGV,
                  FTRD.VALOR_IGV_UNITARIO,
                  FTRD.VALOR_UNITARIO_CON_IGV,
                  FTRD.VALOR_COPAGO_UNIT_SIN_IGV,
                  FTRD.VALOR_COPAGO_IGV_UNIT,
                  FTRD.VALOR_COPAGO_TOTAL_SIN_IGV
						FROM FTRD INNER JOIN SER ON SER.IDSERVICIO= CASE 
																		WHEN FTRD.PREFIJO = DBO.FNK_VALORVARIABLE('PREFIJOMEDICAMENTOS') 
																			AND DBO.FNK_VALORVARIABLE('INVDISPENSA_ART_HIJO') = 'SI' 
																		THEN (SELECT TOP 1 AUTDF.IDSERVICIO 
																			  FROM AUTDF 
																			  WHERE AUTDF.IDSERVICIO_AUTD = FTRD.REFERENCIA 
																			  AND AUTDF.IDAUT = @REFERENCIA) 
																		ELSE FTRD.REFERENCIA 
																	END
									INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
						WHERE N_FACTURA=@N_FACTURA
						AND FTRD.VALOR>0
						ORDER BY PRE.PREFIJO,SER.IDSERVICIO
					END
					ELSE
					BEGIN
                   IF @IDFORMATOFTR IN('03G1','03G2')
                   BEGIN
						   SELECT FTRD.PREFIJO,PRE.NOM_PREFIJO,
						   CASE  @IMPRIMEIDALTERNA    
							   WHEN 0 THEN FTRD.REFERENCIA
							   WHEN 1 THEN SER.IDALTERNA
							   WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE COALESCE(SER.CODCUM,SER.IDALTERNA) END --CUM
							   WHEN 3 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END --ATC
							   WHEN 4 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --ADRES
							   WHEN 5 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDSERVICIO END--SAVIA
							   WHEN 6 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.CODSISPRO END -- SISPRO
							   WHEN 7 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --INVINA
							   WHEN 8 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END -- SOLOCUPS
							   WHEN 9 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END --CUM CUPS
							   WHEN 10 THEN CASE WHEN SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END -- CODIGO SOAT
							   ELSE FTRD.REFERENCIA
						   END IDSERVICIO,
						   CASE  @IMPRIMEIDALTERNA    
							   WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS=1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE '' END --CUM
							   ELSE SER.CODCUPS
						   END CODCUPS,
						   CASE  WHEN @IMPRIMEIDALTERNA IN (8,9) THEN SER.DESCRIPCION_CUPS
								   ELSE FTRD.ANEXO
						   END ANEXO,

						   (SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=1) ANEXO1,
						   COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=2),'') ANEXO2,
						   SUM(FTRD.CANTIDAD)CANTIDAD,FTRD.VALOR VLR_UNI,SUM(FTRD.VLR_COPAGOS) VLR_COPA,SUM(VR_TOTAL) VLRTOTAL,SUM(FTRD.VLR_SERVICI) VLRSERV,
						   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VALOR  AS MONEY), 1))VALOR,
						   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(SUM(FTRD.VLR_COPAGOS)  AS MONEY), 1))VLR_COPAGOS,
						   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(SUM(FTRD.VR_TOTAL)  AS MONEY), 1))VR_TOTAL,
						   CONVERT(DECIMAL(14,2),SUM(CASE WHEN COALESCE(PIVA,0)>0 AND COALESCE(FTRD.VLR_COPAGOS,0)>0 THEN ROUND((FTRD.VLR_COPAGOS/(1+(PIVA/100))),2) ELSE  COALESCE(FTRD.VLR_COPAGOS,0) END)) COPA_SINIGV,
						   CONVERT(DECIMAL(14,2),SUM(CASE WHEN COALESCE(PIVA,0)>0  THEN  ROUND((FTRD.VLR_SERVICI-COALESCE(FTRD.VLR_COPAGOS,0))/(1+(PIVA/100)),2) ELSE (FTRD.VLR_SERVICI-COALESCE(FTRD.VLR_COPAGOS,0)) END)) VLRTOT_SINIGV,
						   SUM(FTRD.VLR_SERVICI)VLR_SERVICI,
                     COALESCE(FTRD.VALOR_UNITARIO_SIN_IGV,0)VALOR_UNITARIO_SIN_IGV,
                     COALESCE(FTRD.VALOR_IGV_UNITARIO,0)VALOR_IGV_UNITARIO,
                     COALESCE(FTRD.VALOR_UNITARIO_CON_IGV,0)VALOR_UNITARIO_CON_IGV,
                     COALESCE(FTRD.VALOR_COPAGO_UNIT_SIN_IGV,0)VALOR_COPAGO_UNIT_SIN_IGV,
                     SUM(COALESCE(FTRD.VALOR_COPAGO_IGV_UNIT,0))VALOR_COPAGO_IGV_UNIT,
                     SUM(COALESCE(FTRD.VALOR_COPAGO_TOTAL_SIN_IGV,0))VALOR_COPAGO_TOTAL_SIN_IGV
						   FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
									   INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
						   WHERE N_FACTURA=@N_FACTURA
						   AND 1= CASE WHEN @ANEXOIMPNOCOBRABLE='SI' THEN 1 ELSE CASE WHEN COALESCE(FTRD.VLR_SERVICI,0) > 0 THEN 1 ELSE 0 END END
                     GROUP BY FTRD.PREFIJO,PRE.NOM_PREFIJO,FTRD.REFERENCIA,SER.IDALTERNA,SER.MEDICAMENTOS,SER.CODCUPS,SER.IDSERVICIO,SER.CODCUM,
                              SER.CODSISPRO,SER.DESCRIPCION_CUPS,FTRD.ANEXO,FTRD.VALOR,COALESCE(FTRD.VALOR_UNITARIO_SIN_IGV,0),COALESCE(FTRD.VALOR_IGV_UNITARIO,0),
                              COALESCE(FTRD.VALOR_UNITARIO_CON_IGV,0),
                              FTRD.VALOR_COPAGO_UNIT_SIN_IGV
						   ORDER BY CASE WHEN @ANEXOIMPNOCOBRABLE = 'SI' THEN FTRD.VALOR END DESC,
                              CASE WHEN @ANEXOIMPNOCOBRABLE <> 'SI' THEN FTRD.PREFIJO END ASC,
                              SER.IDSERVICIO
                   END 
                   ELSE
                   BEGIN
						   SELECT FTRD.PREFIJO,PRE.NOM_PREFIJO, FORMAT(FTRD.FECHAPREST, 'dd/MM/yyyy') FECHAPREST,
						   CASE  @IMPRIMEIDALTERNA    
							   WHEN 0 THEN FTRD.REFERENCIA
							   WHEN 1 THEN SER.IDALTERNA
							   WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE COALESCE(SER.CODCUM,SER.IDALTERNA) END --CUM
							   WHEN 3 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END --ATC
							   WHEN 4 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --ADRES
							   WHEN 5 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDSERVICIO END--SAVIA
							   WHEN 6 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.CODSISPRO END -- SISPRO
							   WHEN 7 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --INVINA
							   WHEN 8 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END -- SOLOCUPS
							   WHEN 9 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END --CUM CUPS
							   WHEN 10 THEN CASE WHEN SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END -- CODIGO SOAT
							   ELSE FTRD.REFERENCIA
						   END IDSERVICIO,
						   CASE  @IMPRIMEIDALTERNA    
							   WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS=1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE '' END --CUM
							   ELSE SER.CODCUPS
						   END CODCUPS,
						   CASE  WHEN @IMPRIMEIDALTERNA IN (8,9) THEN SER.DESCRIPCION_CUPS
								   ELSE FTRD.ANEXO
						   END ANEXO,

						   (SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=1) ANEXO1,
						   COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=2),'') ANEXO2,
						   FTRD.CANTIDAD,FTRD.VALOR VLR_UNI,FTRD.VLR_COPAGOS VLR_COPA,VR_TOTAL VLRTOTAL,FTRD.VLR_SERVICI VLRSERV,
						   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VALOR  AS MONEY), 1))VALOR,
						   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VLR_COPAGOS  AS MONEY), 1))VLR_COPAGOS,
						   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VR_TOTAL  AS MONEY), 1))VR_TOTAL,
						   CONVERT(DECIMAL(14,2),CASE WHEN COALESCE(PIVA,0)>0 AND COALESCE(FTRD.VLR_COPAGOS,0)>0 THEN ROUND((FTRD.VLR_COPAGOS/(1+(PIVA/100))),2) ELSE  COALESCE(FTRD.VLR_COPAGOS,0) END) COPA_SINIGV,
						   CONVERT(DECIMAL(14,2),CASE WHEN COALESCE(PIVA,0)>0  THEN  ROUND((FTRD.VLR_SERVICI-COALESCE(FTRD.VLR_COPAGOS,0))/(1+(PIVA/100)),2) ELSE (FTRD.VLR_SERVICI-COALESCE(FTRD.VLR_COPAGOS,0)) END) VLRTOT_SINIGV,
						   FTRD.VLR_SERVICI,
                     FTRD.VALOR_UNITARIO_SIN_IGV,
                     FTRD.VALOR_IGV_UNITARIO,
                     FTRD.VALOR_UNITARIO_CON_IGV,
                     FTRD.VALOR_COPAGO_UNIT_SIN_IGV,
                     FTRD.VALOR_COPAGO_IGV_UNIT,
                     FTRD.VALOR_COPAGO_TOTAL_SIN_IGV
						   FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
									   INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
						   WHERE N_FACTURA=@N_FACTURA
						   AND 1= CASE WHEN @ANEXOIMPNOCOBRABLE='SI' THEN 1 ELSE CASE WHEN COALESCE(FTRD.VLR_SERVICI,0) > 0 THEN 1 ELSE 0 END END
						   ORDER BY CASE WHEN @ANEXOIMPNOCOBRABLE = 'SI' THEN FTRD.VR_TOTAL END DESC,
                              CASE WHEN @ANEXOIMPNOCOBRABLE <> 'SI' THEN FTRD.PREFIJO END ASC,
                              SER.IDSERVICIO
                  END

					END
				END
            END
            IF @PROCEDENCIA='CAJA'
            BEGIN
               SELECT 'OK'
               SELECT FTRD.PREFIJO,'',FTRD.REFERENCIA AS  IDSERVICIO,FTRD.ANEXO,
               (SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=1) ANEXO1,
               COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=2),'') ANEXO2,
               FTRD.CANTIDAD,FTRD.VALOR VLR_UNI,FTRD.VLR_COPAGOS VLR_COPA,VR_TOTAL VLRTOTAL,
               CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VALOR  AS MONEY), 1))VALOR,
               CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VLR_COPAGOS  AS MONEY), 1))VLR_COPAGOS,
               CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VR_TOTAL  AS MONEY), 1))VR_TOTAL
               FROM FTRD
               WHERE N_FACTURA=@N_FACTURA
               AND FTRD.VALOR>0
               ORDER BY FTRD.PREFIJO
            END
         END
         IF @PROCEDENCIA='SALUD' OR @PROCEDENCIA='HPREP'
         BEGIN
            IF DBO.FNK_VALORVARIABLE('FTR_FECHAS')='HPRE'
            BEGIN
               DECLARE @FECHAPRE_INI DATETIME
               DECLARE @FECHAPRE_FIN DATETIME

               SELECT @FECHAPRE_INI= COALESCE(MIN(HPRE.FECHA),MAX(HADM.FECHAALTAMED)) 
               FROM HPRED INNER JOIN HPRE ON HPRED.NOPRESTACION=HPRE.NOPRESTACION
                          INNER JOIN HADM ON HPRE.NOADMISION=HADM.NOADMISION 
               WHERE HPRED.N_FACTURA=@N_FACTURA

               SELECT @FECHAPRE_FIN=COALESCE(MAX(HPRE.FECHA),MAX(HADM.FECHAALTAMED)) 
               FROM HPRED INNER JOIN HPRE ON HPRED.NOPRESTACION=HPRE.NOPRESTACION
                          INNER JOIN HADM ON HPRE.NOADMISION=HADM.NOADMISION 
               WHERE HPRED.N_FACTURA=@N_FACTURA

            END
            IF COALESCE(@IXCOUNTRY,'')='PERU'
            BEGIN
               SELECT TOP 1 COALESCE(MED.NOMBRE,'')NOMBRE,COALESCE(MES.DESCRIPCION,'')DESCRIPCION,COALESCE(CIT.NOAUTORIZACION,'')NOAUTORIZACION,
               CAST(YEAR(HADM.FECHA) AS VARCHAR(4))ANIO,CAST(MONTH(HADM.FECHA) AS VARCHAR(2)) MES
               FROM HADM INNER JOIN CIT ON HADM.NOADMISION=CIT.NOADMISION  
                         INNER JOIN MED ON CIT.IDMEDICO=MED.IDMEDICO
                         LEFT  JOIN MES ON MED.IDEMEDICA=MES.IDEMEDICA
               WHERE HADM.NOADMISION=@NOREFERENCIA
               
            END
            ELSE
            BEGIN
               SELECT COALESCE(MED.NOMBRE,'')NOMBRE,COALESCE(MES.DESCRIPCION,'')DESCRIPCION,
               COALESCE(CASE WHEN COALESCE(@VENDEDOR,'')<>'' THEN @VENDEDOR ELSE HADM.NOAUTORIZACION END,'')NOAUTORIZACION,
               COALESCE(CONVERT(VARCHAR,CASE WHEN COALESCE(@VENDEDOR,'')<>'' THEN HADMAUT.F_INICIAL ELSE 
               CASE  WHEN DBO.FNK_VALORVARIABLE('FTR_FECHAS')='HPRE' THEN @FECHAPRE_INI ELSE HADM.FECHA END END,103),'')FECHAING,
               COALESCE(CONVERT(VARCHAR,CASE WHEN COALESCE(@VENDEDOR,'')<>'' THEN HADMAUT.F_FINAL ELSE 
               CASE  WHEN DBO.FNK_VALORVARIABLE('FTR_FECHAS')='HPRE' THEN @FECHAPRE_FIN ELSE  COALESCE(HADM.FECHAALTAMED,HADM.FECHAALTAENF,HADM.FECHAALTA,@F_FACTURA,GETDATE()) END END,103),'')FECHAEGR,
               CASE WHEN COALESCE(@VENDEDOR,'')<>'' THEN COALESCE(DATEDIFF(DAY,HADMAUT.F_INICIAL,COALESCE(HADMAUT.F_FINAL,GETDATE())),0)+1
                    ELSE CASE  WHEN DBO.FNK_VALORVARIABLE('FTR_FECHAS')='HPRE' THEN  COALESCE(DATEDIFF(DAY,@FECHAPRE_INI,@FECHAPRE_FIN),0)
                    ELSE COALESCE(DATEDIFF(DAY,HADM.FECHA,COALESCE(HADM.FECHAALTAMED,HADM.FECHAALTAENF,HADM.FECHAALTA,@F_FACTURA,GETDATE())),0) END END DIASEST,
                    COALESCE(STUFF((SELECT '|'+AUTORIZACION FROM HADMAUT WHERE NOADMISION=@NOREFERENCIA AND COALESCE(N_FACTURA,'')='' FOR XML PATH('')),1,1,''),'')NROADICIONAL,
               CASE WHEN HADM.TIPOADM=DBO.FNK_VALORVARIABLE('IDTARIFASOAT') THEN HACTRAN.NOPOLIZA ELSE '' END POLIZA
               FROM HADM LEFT JOIN MED ON COALESCE(HADM.IDMEDICOALTA,HADM.IDMEDICOTRA,HADM.IDMEDICOING) =MED.IDMEDICO
                         LEFT JOIN MES ON MED.IDEMEDICA=MES.IDEMEDICA
                         LEFT JOIN HADMAUT ON HADM.NOADMISION=HADMAUT.NOADMISION AND HADMAUT.AUTORIZACION=@VENDEDOR
                         LEFT JOIN HACTRAN ON HADM.CNSHACTRAN=HACTRAN.CNSHACTRAN
               WHERE HADM.NOADMISION=@NOREFERENCIA
            END
--query2
--query2
            IF @IDFORMATOFTR='01'
            BEGIN
               SELECT FTRD.AREAPRESTACION,AFU.DESCRIPCION,FTRD.PREFIJO,PRE.NOM_PREFIJO,SUM(FTRD.VLR_SERVICI)VLR_SERVICI
               FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                           INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
                           LEFT  JOIN AFU ON FTRD.AREAPRESTACION=AFU.IDAREA
               WHERE N_FACTURA= @N_FACTURA
               AND FTRD.VALOR>0
               GROUP BY FTRD.AREAPRESTACION,AFU.DESCRIPCION,FTRD.PREFIJO,PRE.NOM_PREFIJO
               ORDER BY  FTRD.AREAPRESTACION,FTRD.PREFIJO               
            END
            ELSE
            BEGIN
               IF COALESCE(@IXCOUNTRY,'')='PERU'
               BEGIN
                  SELECT FTRD.PREFIJO, PRE.NOM_PREFIJO,SER.IDSERVICIO,COALESCE(FTRD.ANEXO,SER.DESCSERVICIO)ANEXO,
                  FTRD.CANTIDAD ,FTRD.VALOR VLR_UNI,FTRD.VLR_COPAGOS VLR_COPA,VLR_SERVICI VLRTOTAL,''AS CLASESER,
                  COALESCE(CONVERT(VARCHAR,FTRD.FECHA,103),'')FECHAQX,COALESCE(SER.DESCSERVICIO,'')N_PROCE,
                  CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VALOR  AS MONEY), 1))VALOR,
                  CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VLR_COPAGOS  AS MONEY), 1))VLR_COPAGOS,
                  CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VLR_SERVICI  AS MONEY), 1))VR_TOTAL,
                  VLRTOT_SINIGV=(FTRD.VALOR*FTRD.CANTIDAD),
                  FTRD.VALOR_UNITARIO_SIN_IGV,
                  FTRD.VALOR_IGV_UNITARIO,
                  FTRD.VALOR_UNITARIO_CON_IGV,
                  FTRD.VALOR_COPAGO_UNIT_SIN_IGV,
                  FTRD.VALOR_COPAGO_IGV_UNIT,
                  FTRD.VALOR_COPAGO_TOTAL_SIN_IGV,
                  COALESCE(FTRD.PAQUETE,0)PAQUETE
                  FROM FTRD INNER JOIN FTR ON FTRD.N_FACTURA=FTR.N_FACTURA    
                           LEFT JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
                           LEFT JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                  WHERE FTRD.N_FACTURA=@N_FACTURA
                  ORDER BY PAQUETE,FECHA
                  --AND 1=CASE WHEN COALESCE(FTR.PAQUETE,0)=1 THEN 
                  --      CASE WHEN COALESCE(FTRD.PAQUETE,0) IN(0,2) THEN 1 ELSE 0 END
                  --      ELSE 1 END

               END
               ELSE
               BEGIN
                  --SELECT TOP 1 * FROM HADM
                  DECLARE @CNSRPDX VARCHAR(20)
                  DECLARE @FECHA   DATETIME =DBO.FNK_GETDATE()
                  EXEC SPK_GENCONSECUTIVO '01',@IDSEDE,'@RPDX',@CNSRPDX OUTPUT   
                  SELECT @CNSRPDX = @IDSEDE +REPLACE(SPACE(8 - LEN(@CNSRPDX))+LTRIM(RTRIM(@CNSRPDX)),SPACE(1),0)

                  PRINT '@CNSRPDX='+COALESCE(@CNSRPDX,'NADA RPDX')
         
                  EXEC SPK_RPT_ANEXO_PREFAC @NOREFERENCIA,@N_FACTURA, 0, @CNSRPDX, 3, @FECHA
                  SELECT * FROM (
                  SELECT CASE WHEN IDTERCERO='SERVICIOS' THEN  RPDX.ID1 ELSE RPDX.ID4 END PREFIJO,
                   CASE WHEN IDTERCERO='SERVICIOS' THEN  PRE.NOM_PREFIJO ELSE RPDX.STRINGGRANDE1 END NOM_PREFIJO ,
                   LTRIM(RTRIM(RPDX.ID2)) IDSERVICIO,REPLACE(REPLACE(COALESCE(RPDX.NOMBRE,''),CHAR(13),''),CHAR(10),'')ANEXO,
                     (SELECT DESCR FROM DBO.FNK_SPLIT_PMA(RPDX.NOMBRE,' ',75,'') WHERE VEZ=1) ANEXO1,
                     COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(RPDX.NOMBRE,' ',75,'') WHERE VEZ=2),'') ANEXO2,
                  RPDX.VALOR2 CANTIDAD ,RPDX.VALOR1 VLR_UNI,RPDX.VALOR3 VLR_COPA,RPDX.VALOR4 VLRTOTAL,RPDX.IDTERCERO AS CLASESER,
                     COALESCE(CONVERT(VARCHAR,RPDX.FECHA1,103),'')FECHAQX,COALESCE(SER.DESCSERVICIO,'')N_PROCE,
                     COALESCE(RPDX.ID5,'')CNSQX,
                     CASE WHEN IDTERCERO='SERVICIOS' THEN  0 ELSE RIGHT(CONCAT(RPDX.ID5,CAST(RPDX.CANTIDAD AS VARCHAR(5))),2) END ITEMCIR,
                     STRINGMEDIO2 AS NROAUTO,
                  CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(RPDX.VALOR1  AS MONEY), 1))VALOR,
                  CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(RPDX.VALOR3  AS MONEY), 1))VLR_COPAGOS,
                  CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(RPDX.VALOR4  AS MONEY), 1))VR_TOTAL
                  FROM RPDX LEFT JOIN PRE ON RPDX.ID1=PRE.PREFIJO
                               LEFT JOIN SER ON RPDX.ID4=SER.IDSERVICIO
                  WHERE RPDX.CNS=@CNSRPDX
                  AND COALESCE(RPDX.VALOR1,0)>0 
                   ) DATOS
                  ORDER BY CLASESER DESC,ITEMCIR ASC, FECHAQX, PREFIJO
               END
            END 
         END
      END
      ELSE
      BEGIN
         IF @PROCEDENCIA IN('FINANCIERO','INVENTARIO')
         BEGIN
            PRINT 'INGRESO A FINANCIERA'
            SELECT 'OK'OK,FTR.N_FACTURA,FTR.IDSEDE,TER.TIPO_ID,TER.NIT,TER.DV,TER.RAZONSOCIAL,TER.IDALTERNA2,TER.DIRECCION,TER.TELEFONOS,TER.EMAIL,CIU.NOMBRE,DEP.NOMBRE AS DPTO,
                   CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,COALESCE(CONVERT(VARCHAR,FTRE.FECHA,103),'') AS FECHAVAL,CONVERT(VARCHAR,F_VENCE,103)F_VENCE,LTRIM(RTRIM(COALESCE(IDFORMATO,'01')))IDFORMATO,COALESCE(FTR.FACTE,0)ESTDIAN,
                   FTR.IDPLAN,PLN.DESCPLAN,PLN.TIPOSISTEMA,COALESCE(PPT.NROCONTRATO,CNT.IDALTERNA,PPT.IDCONTRATO,'')IDCONTRATO,COALESCE(FTR.NOREFERENCIA,'')NOREFERENCIA,FTR.PROCEDENCIA,
                   CASE WHEN FTR.ESTADO='A' THEN 'ANULADA' ELSE CASE WHEN COALESCE(TIPOANULACION,'')<>'' THEN 'ANULADA NC' ELSE 'OK' END END ESTADO,
                   REPLACE(LTRIM(RTRIM(FTR.OBSERVACION)),CHAR(13),'')OBSERVACION,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTR.VALORSERVICIOS  AS MONEY), 1))VALORSERVICIOS,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(CASE WHEN COALESCE(FTR.CAPITADA,0)=1 AND COALESCE(FTR.COPAPROPIO,0)=1 THEN COALESCE(FTR.CP_VLR_COPAGOS,0) ELSE COALESCE(FTR.VALORCOPAGO,0) END AS MONEY), 1))VALORCOPAGO,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(COALESCE(FTR.DESCUENTO,0)  AS MONEY), 1))DESCUENTO,
                  -- CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(COALESCE(FTR.VIVA,0)  AS MONEY), 1))VIVA,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(COALESCE(FTR.VR_TOTAL,0)  AS MONEY), 1))VR_TOTAL,
                   FTR.VALORSERVICIOS AS VSERVICIOS,FTR.VALORCOPAGO AS VCOPAGO,FTR.DESCUENTO AS VDESCUENTO,FTR.VR_TOTAL AS VTOTAL,
                   @VLLETRAS+CASE WHEN @IXCOUNTRY='PERU' THEN ' SOLES ' WHEN FTR.MONEDA = 'USD' THEN ' DOLARES ' ELSE ' PESOS M/CTE. ' END AS LETRAS,
                   USUSU.NOMBRE AS NFACTURADOR,CASE WHEN COALESCE(@CARGO,'')<>'' THEN @CARGO  ELSE USUSU.CARGO END CARGO,
                   COALESCE(FTR.CUFE,'')CUFE,REPLACE(COALESCE(DBO.FNK_RTF(FDIAN.TITULO),''),'¾', 'ó')RESOL,
                   COALESCE(DBO.FNK_QRCODE(FTR.N_FACTURA),'') CODQR,
                   CASE WHEN EXISTS(SELECT DICOM FROM ARCHIVOS WHERE ID = @IDFIRMA )
                        THEN  (SELECT DICOM FROM ARCHIVOS WHERE ID = @IDFIRMA)
                        ELSE '' END DICOM
					,COALESCE(CONVERT(VARCHAR,FECHACAP_INI,103),'')FECHACAP_INI,
                        COALESCE(CONVERT(VARCHAR,FECHACAP_FIN,103),'')FECHACAP_FIN,
					FTR.VALORMODERADORA  
					, CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(COALESCE(FTR.VALORMODERADORA,0)  AS MONEY), 1))VALORMODERADORACRR 
					, USUSU.USUARIO USUARIOFACTURA,USUSU.NOMBRE AS NUSUFACTURA,@ENTERO AS ENTERO,
               FTR.VIVA,COALESCE(@VLR_AFECTO,0)AFECTO,COALESCE(@VLR_INAFECTO,0)INAFECTO,COALESCE(@VLR_SUBTOTAL,0)VLR_SUBTOTAL,
               CASE WHEN @IXCOUNTRY='PERU' THEN CASE WHEN TIPOFIN='N' THEN 'CONTADO' ELSE 'CREDITO A '+CAST(CASE WHEN COALESCE(PPT.DIASVTO,30)<=0 THEN 30 ELSE COALESCE(PPT.DIASVTO,30) END  AS VARCHAR(4))+' Dias' END ELSE 'Forma de Pago:'+
               CASE WHEN COALESCE(TER.ENVIODICAJA,0)=1 THEN 'Contado' ELSE 'Credito '+CAST(COALESCE(PPT.DIASVTO,30) AS VARCHAR(4))+' Dias' END END FPAGO,
			   CASE WHEN FTR.IDPLAN IN (
						DBO.FNK_VALORVARIABLE('IDPLANPART'), DBO.FNK_VALORVARIABLE('IDPLANPART2'), DBO.FNK_VALORVARIABLE('IDPLANPART3'), DBO.FNK_VALORVARIABLE('IDPLANPART4'), DBO.FNK_VALORVARIABLE('IDPLANPART5')
					) OR TER.IDTERCERO = DBO.FNK_VALORVARIABLE('IDTERCEROPARTICULAR') THEN 'Contado'
				WHEN COALESCE(PPT.DIASVTO,0) = 0 THEN 'Contado' ELSE 'Credito ' END FPAGO2,
               CASE TIPOFIN WHEN 'N' THEN 'B' ELSE 'F' END TIPOFACT,
                CASE WHEN @IXCOUNTRY='PERU' AND VR_TOTAL>700 THEN ROUND((VR_TOTAL*0.12),2) ELSE 0 END VR_DETRA,
				COALESCE(SED.LEGAL,'')+COALESCE(SED.LEGAL2,'') AS LEGAL,
                   COALESCE(SED.LEGAL3,'')+COALESCE(SED.LEGAL4,'') AS LEGAL1,
                   (SELECT NOMBRE FROM USUSU WHERE USUARIO=@USUARIO)IMPRESO,
                    @EQUIPO EQUIPO,@FIMPRESION FIMPRESION,@USUARIO USUARIO,
                   (SELECT 'PROVEEDOR ELECTRÓNICO: '+LTRIM(RTRIM(TER.RAZONSOCIAL))+', NIT:'+LTRIM(RTRIM(NIT))+'-'+LTRIM(RTRIM(STR(DV)))  
                     FROM TER WHERE IDTERCERO=DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO'))PROFE,
					 COALESCE(DBO.FNK_VALORVARIABLE('FTR_IMPNOCONTRATO'),'') FTR_IMPNOCONTRATO,
                NOMBREAFI=CASE WHEN FTR.TIPOFIN='N' THEN TER.RAZONSOCIAL ELSE '' END,
                CIUD_AFI=CASE WHEN FTR.TIPOFIN='N' THEN CIU.NOMBRE ELSE '' END,
                DPTO_AFI=CASE WHEN FTR.TIPOFIN='N' THEN DEP.NOMBRE ELSE '' END,
                TIPO_DOC=CASE WHEN FTR.TIPOFIN='N' THEN TER.TIPO_ID ELSE '' END,
                DOCIDAFILIADO=CASE WHEN FTR.TIPOFIN='N' THEN TER.NIT ELSE '' END
            FROM FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
                     INNER JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
                     LEFT  JOIN CIU ON TER.CIUDAD=CIU.CIUDAD
                     LEFT  JOIN DEP ON CIU.DPTO=DEP.DPTO
                     LEFT  JOIN PPT ON FTR.IDTERCERO=PPT.IDTERCERO AND FTR.IDPLAN=PPT.IDPLAN
                     LEFT JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
                     LEFT JOIN ARCHIVOS ON USUSU.IDFIRMA=ARCHIVOS.ID
                     LEFT JOIN FDIAN ON FTR.CNSRESOL=FDIAN.CNSRESOL
                     LEFT JOIN FTRE ON FTR.N_FACTURA=FTRE.FTRN_FACTURA
                     LEFT JOIN CNT  ON PPT.IDCONTRATO=CNT.IDCONTRATO
					      LEFT JOIN SED   ON FTR.IDSEDE=SED.IDSEDE
            WHERE FTR.N_FACTURA=@N_FACTURA    
         
            SELECT 'OK'
            SELECT 'Item '+REPLACE(SPACE(2-LEN(FTRD.N_CUOTA)),SPACE(1),'0')+LTRIM(RTRIM(CAST(FTRD.N_CUOTA AS VARCHAR(3))))ITEM,
                   -- LEFT(LTRIM(RTRIM(FTRD.REFERENCIA)),6)IDSERVICIO,

                   --   (SELECT DESCR FROM DBO.FNK_SPLIT_PMA(LTRIM(RTRIM(FTRD.ANEXO)),' ',25,'') WHERE VEZ=1) ANEXO,
                   --   COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(LTRIM(RTRIM(FTRD.ANEXO)),' ',25,'') WHERE VEZ=2),'') ANEXO1,
                   --   REPLACE(REPLACE(COALESCE(ANEXO,''),CHAR(13),''),CHAR(10),'')ANEXOT,
                   --FTRD.CANTIDAD,FTRD.VALOR VLR_UNI,FTRD.VLR_SERVICI,COALESCE(FTRD.VLR_COPAGOS,0) VLR_COPA,VR_TOTAL VLRTOTAL,
                   --VLRTOT_SINIGV=(FTRD.VALOR*FTRD.CANTIDAD),
                  
                  --- EEMC78: SE AGREGA PARA QUE LA FACTURA FINANCIERA TENGA EN CUENTA LA CONFIGURACION DEL PLAN PPT.IMPRIMEIDALTERNA PARA LA CODIFICACIÓN
                  CASE  @IMPRIMEIDALTERNA    
							WHEN 0 THEN FTRD.REFERENCIA
							WHEN 1 THEN SER.IDALTERNA
							WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE COALESCE(SER.CODCUM,SER.IDALTERNA) END --CUM
							WHEN 3 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END --ATC
							WHEN 4 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --ADRES
							WHEN 5 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDSERVICIO END--SAVIA
							WHEN 6 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.CODSISPRO END -- SISPRO
							WHEN 7 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --INVINA
							WHEN 8 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END -- SOLOCUPS
							WHEN 9 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END --CUM CUPS
							WHEN 10 THEN CASE WHEN SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END -- CODIGO SOAT
							ELSE FTRD.REFERENCIA
						END IDSERVICIO,
						CASE  @IMPRIMEIDALTERNA    
							WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS=1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE '' END --CUM
							ELSE SER.CODCUPS
						END CODCUPS,
						CASE  WHEN @IMPRIMEIDALTERNA IN (8,9) THEN SER.DESCRIPCION_CUPS
								ELSE (SELECT DESCR FROM DBO.FNK_SPLIT_PMA(LTRIM(RTRIM(COALESCE(FTRD.ANEXO, SER.DESCSERVICIO,''))),' ',25,'') WHERE VEZ=1)
						END ANEXO,
                  FTRD.ANEXO ANEX,
                      COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(LTRIM(RTRIM(COALESCE(FTRD.ANEXO, SER.DESCSERVICIO,''))),' ',25,'') WHERE VEZ=2),'') ANEXO1,
                      REPLACE(REPLACE(COALESCE(FTRD.ANEXO, SER.DESCSERVICIO,'') ,CHAR(13),''),CHAR(10),'')+CASE WHEN ANEXOT,
                   FTRD.CANTIDAD,FTRD.VALOR VLR_UNI,FTRD.VLR_SERVICI,COALESCE(FTRD.VLR_COPAGOS,0) VLR_COPA,VR_TOTAL VLRTOTAL,
                   VLRTOT_SINIGV=(FTRD.VALOR*FTRD.CANTIDAD),
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VALOR  AS MONEY), 1))VALOR,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(COALESCE(FTRD.VLR_COPAGOS,0)  AS MONEY), 1))VLR_COPAGOS,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(0  AS MONEY), 1))VLR_DESCUENTO,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(COALESCE(FTRD.VIVA,0)  AS MONEY), 1))VIVA,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VLR_SERVICI  AS MONEY), 1))VR_TOTAL

            FROM FTRD LEFT JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                        LEFT JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
            WHERE N_FACTURA=@N_FACTURA
            AND FTRD.VALOR>0
            ORDER BY PRE.PREFIJO,SER.IDSERVICIO
         END
      END
      IF DBO.FNK_VALORVARIABLE('FACTSEDE')='SI' OR DBO.FNK_VALORVARIABLE('DATOSPROPIETARIO')='SEDE'
      BEGIN
         SELECT CASE WHEN DBO.FNK_VALORVARIABLE('RAZONSOCIALENSEDES')='TER' THEN (SELECT RAZONSOCIAL FROM TER WHERE IDTERCERO=DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO'))ELSE
              COALESCE(SED.DESCRIPCION,TER.RAZONSOCIAL) END RAZONSOCIAL,TER.NIT,TER.DV,COALESCE(SED.DIRECCION,TER.DIRECCION)DIRECCION,COALESCE(SED.TELEFONOS,TER.TELEFONOS)TELEFONOS,
         CIU.NOMBRE CIUDAD,DEP.NOMBRE AS DPTO,COALESCE(SED.EMAIL,TER.EMAIL)EMAIL,SED.CODHABILITA
         FROM SED INNER JOIN TER ON SED.NIT=TER.NIT
                    INNER JOIN CIU ON COALESCE(SED.CIUDAD,TER.CIUDAD)=CIU.CIUDAD
                    LEFT  JOIN DEP ON CIU.DPTO=DEP.DPTO
         WHERE IDSEDE=@IDSEDE
      END
      ELSE
      BEGIN
         SELECT 'SIN SEDE'
      END
      IF @IXCOUNTRY='PERU' AND EXISTS(SELECT * FROM FCJ WHERE N_FACTURA=@N_FACTURA)
      BEGIN
         SELECT FPA.DESCRIPCION,PCJ.VALOR
         FROM FCJ INNER JOIN PCJ ON FCJ.CNSFACJ=PCJ.CNSFACJ AND FCJ.CODCAJA=PCJ.CODCAJA
                  INNER JOIN FPA ON PCJ.TIPOPAGO=FPA.FORMAPAGO
         WHERE FCJ.N_FACTURA=@N_FACTURA
      END
      ELSE
      BEGIN 
         SELECT 'DE OTRAS IPS'PAGOS
      END 
      IF @IXCOUNTRY='PERU'
      BEGIN
         SELECT TOP 1 COALESCE(BCO.DESCRIPCION,'')DESCRIPCION,COALESCE(BCO.CODACH,'')CODACH,COALESCE(BCT.CTA_BCO,'')CTA_BCO,
         CCI
         FROM BCT LEFT JOIN BCO ON BCT.BANCO=BCO.BANCO
         WHERE BCT.IDSEDE=@IDSEDE
         AND BCT.TIPOCUE='Recaudadora'
      END
      ELSE
      BEGIN
         SELECT 'CUENTAS'CUENTAS
      END
      IF @CNSFNOT <> ''
      BEGIN
         PRINT 'EMPIEZO A ARMAR EL REPORTE...' 
         SELECT CNSFNOT,FNOT.CLASE,CONVERT(VARCHAR,F_NOTA,103)F_NOTA,LEFT(CONVERT(VARCHAR,F_NOTA,108),5)H_NOTA,N_FACTURA,
                  COALESCE(DBO.FNK_RTF(OBSERVACION),'')OBSERVACION,IDCONCEPTO,CPNT.DESCRIPCION,FNOT.IDTERCERO,TER.NIT,TER.RAZONSOCIAL,
                     COALESCE(FNOT.CUDE,'')CUFE,COALESCE(DBO.FNK_QRCODE(FNOT.CNSFNOT),'')CODQR,CNSDIANFE,FNOT.VR_TOTAL,CASE WHEN FNOT.ESTADO ='A' THEN 'ANULADA' ELSE'OK' END ESTADO
         FROM FNOT LEFT JOIN CPNT ON FNOT.IDCONCEPTO=CPNT.CODIGO
                     LEFT JOIN TER ON FNOT.IDTERCERO=TER.IDTERCERO
         WHERE CNSFNOT=@CNSFNOT         
      END
      ELSE
      BEGIN
         SELECT 'OK' OK
      END
      IF @IXCOUNTRY='PERU'
      BEGIN
         IF EXISTS(SELECT * FROM FTR WHERE N_FACTURA=@N_FACTURA AND COALESCE(CAPITADA,0)=1)
         BEGIN
            SELECT ROW_NUMBER() OVER(ORDER  BY NOPRESTACION  ASC) NRO,NOPRESTACION,DBO.FNK_FECHA_DDMMAA(FECHA)FECHA,
            LTRIM(RTRIM(REPLACE(PACIENTE,'  ','')))PACIENTE,SER.DESCSERVICIO
            FROM FTR INNER JOIN FTRDC ON FTR.CNSFCT=FTRDC.CNSFTR
                     LEFT  JOIN SER ON FTRDC.IDSERVICIO=SER.IDSERVICIO
            WHERE FTR.N_FACTURA=@N_FACTURA
         END
         ELSE
         BEGIN
            SELECT 'KO'KO
         END
      END
      ELSE
      BEGIN
         SELECT  'KO'KO
      END
     IF @IDFORMATOFTR='01' AND EXISTS(SELECT  * FROM FTRD WHERE N_FACTURA=@N_FACTURA AND PREFIJO=DBO.FNK_VALORVARIABLE('IDCIRPREFIJO'))
      BEGIN
         SELECT FTRD.IDCIRUGIA,SER.DESCSERVICIO,REFERENCIA,ANEXO,SUM(FTRD.VLR_SERVICI) VLR_SERVICI,FTRD.PREFIJO,PRE.NOM_PREFIJO
         FROM FTRD INNER JOIN SER ON FTRD.IDCIRUGIA=SER.IDSERVICIO 
                   INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
         WHERE N_FACTURA=@N_FACTURA AND FTRD.PREFIJO=DBO.FNK_VALORVARIABLE('IDCIRPREFIJO')
         GROUP BY FTRD.IDCIRUGIA,SER.DESCSERVICIO,REFERENCIA,ANEXO,FTRD.PREFIJO,PRE.NOM_PREFIJO         
      END
      ELSE
      BEGIN
         SELECT  'KO' KO
      END
   END
END


