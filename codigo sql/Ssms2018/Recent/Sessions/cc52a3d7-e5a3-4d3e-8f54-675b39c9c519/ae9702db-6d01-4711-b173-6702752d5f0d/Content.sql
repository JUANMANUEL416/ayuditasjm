CREATE OR ALTER PROCEDURE DBO.SPQ_AGENDALXDOMI
@JSON  NVARCHAR(MAX)
WITH   ENCRYPTION
AS
DECLARE   
 @PARAMETROS	       NVARCHAR(MAX), @MODELO          NVARCHAR(MAX),	@METODO           VARCHAR(100),  @MODELOACT      NVARCHAR(MAX),   @USUARIO			VARCHAR(20)
,@VALOR			       DECIMAL(18,2), @PROCEDENCIAPAGO	VARCHAR(10),	@SERVICIOS	      NVARCHAR(MAX),	@AFILIADOS	    NVARCHAR(MAX),   @IDTERCERO			VARCHAR(20)
,@IDPLAN              VARCHAR(6),	 @ESCOMERCIAL		VARCHAR(2),		@MEDIOINFORMACION VARCHAR(10),   @IDKPAGE        INT,             @CONT1				INT
,@IDAFILIADO	       VARCHAR(20),	 @SEDE				VARCHAR(5),		@NOADMISION       VARCHAR(16),   @CONSECUTIVO    VARCHAR(13),		@HOY				DATETIME=CONVERT(SMALLDATETIME,GETDATE())
,@FECHACIT		       DATETIME,		 @IDMEDICO			VARCHAR(12),	@CONT2		      INT,				@IDSERVICIO     VARCHAR(20),		@CONT3				INT
,@CONSECUTIVOTEMP     VARCHAR(13),	 @PAGOS				NVARCHAR(MAX),	@EMAIL            VARCHAR(100),  @CELULAR        VARCHAR(13),		@PREFIJO			VARCHAR(6)
,@APOYODG_AMBITO      VARCHAR(2),	 @IDAREA          VARCHAR(20),	@IDAREAH          VARCHAR(20),   @CCOSTO         VARCHAR(20),		@ALTOCOSTO			VARCHAR(2)
,@NVOCONSEC           VARCHAR(20),	 @FECHAHPRE			DATETIME,		@OBSERVACION      VARCHAR(2048),	@CONT           INT,             @CODCUPS			VARCHAR(20)
,@IDCONCEPTORIPS      VARCHAR(2),	 @RPDX				VARCHAR(20),	@ITEM             INT,				@NIT            VARCHAR(20),		@URLFACTURA			VARCHAR(1000)
,@N_FACTURA           VARCHAR(16),	 @MENSAJE			VARCHAR(5000),	@html             varchar(max),  @HEAD           VARCHAR(MAX),		@BODY_EMAIL			VARCHAR(MAX)
,@FOOTER              VARCHAR(MAX),	 @NOMBRES			VARCHAR(150),	@CNSHTX           VARCHAR(20),   @CONSECUTIVOHCA VARCHAR(13),		@IDCAUSAL			VARCHAR(5)
,@IDTERCEROPARTICULAR VARCHAR(30),	 @COMERCIAL       VARCHAR(2),		@IDSEDE           VARCHAR(5),    @CONSECUTIVOCAN VARCHAR(13)
,@IDFIRMA             VARCHAR(36),	 @CNSCONSE			VARCHAR(16),	@CNSFACJ          VARCHAR(20),   @GENBOLETA      BIT,				   @SYS_COMPUTERNAME	VARCHAR(254)
,@CNSFCJ              VARCHAR(20),	 @NOMBREAFI			VARCHAR(200),	@IDAFILIADO_OLD   VARCHAR(20),   @ITEMRED        INT,             @USUNOTA			VARCHAR(20)
,@TIPODX              VARCHAR(10),	 @IDDX				VARCHAR(10),	@CLASEPLANTILLA   VARCHAR(20)='NT_ADM01',                         @ALFANUMERICO		VARCHAR(8000)
,@STRING              VARCHAR(900),	 @DOCUMENTOID     VARCHAR(40),	@NOINGRESO        VARCHAR(20),   @GENFACTURA     BIT,             @DatoBolFac VARCHAR (10), @RUC VARCHAR (11)
,@I                   INT,           @I_TO            INT
,@NUMERICO			    INT,			    @BASIC			    VARCHAR(500) = DBO.FNK_VALORVARIABLE('IZIPAY_SERVICEMODE'), @IDCOMER VARCHAR (10)		
,@RAZONSOCIAL		    VARCHAR(100),	 @DIRECCION			VARCHAR(100),	@TELEFONOS			VARCHAR(20),	@CORREO			VARCHAR(100)	,	@IDTERCERORUC	VARCHAR (11)
,@NOPRESTACION2		 VARCHAR(20)   ,@DOMPRE			 VARCHAR(1)		, @IDEMEDICA		VARCHAR(4), @CNSAUX		 	VARCHAR(13)			
,@DESCCAUSAL			VARCHAR(50),	@NOTALARGA VARCHAR (500)      ,@PAS VARCHAR(10)       ,@PAD VARCHAR(10)  ,@PESO DECIMAL(18,2)  ,@TALLA VARCHAR(10)  ,@PERIMETRO VARCHAR(10)
,@IMC DECIMAL(18,2)       ,@PAM DECIMAL(18,2)      ,@FC DECIMAL(18,2)  
DECLARE @RESULTADO			VARCHAR(10)    , @HEMOGLOBINA DECIMAL (18,2)       ,@HEMOTROCRITO DECIMAL(18,2)     ,@DIASEDAD INT
DECLARE @CONTENEDOR			VARCHAR(10)
DECLARE @DESC_EQUIPOMUES	VARCHAR(100)
DECLARE @CNSCONTENEDOR		VARCHAR(16)
DECLARE @NORDEN				VARCHAR(16)
DECLARE @FECHA		DATETIME
DECLARE @DATE		VARCHAR(19)
DECLARE @IDSEDE2	VARCHAR(10), @NOMBREEQUIPO VARCHAR(50)
DECLARE @MES		VARCHAR(2)
DECLARE @ANIO		VARCHAR(4)
DECLARE @DIA1		VARCHAR(2)
DECLARE @HORA		VARCHAR(8)
DECLARE @BODY       NVARCHAR(MAX)
DECLARE @STATUS     VARCHAR(20)
DECLARE @ANSWER     NVARCHAR(MAX)

DECLARE @VALORCOP	DECIMAL(16,2)
DECLARE @sUrl		VARCHAR(3096) =  'https://api.micuentaweb.pe/api-payment/V4/Charge/CreatePaymentOrder'
DECLARE @obj		INT
DECLARE @response	VARCHAR(max)
DECLARE @urlpago	VARCHAR(255)
DECLARE @RESPUESTA	VARCHAR(20)
DECLARE @paymentOrderId		 VARCHAR(40)
DECLARE @paymentOrderStatus	 VARCHAR(40)

DECLARE @TBLERRORES TABLE(CONTINUA VARCHAR(2), ERROR VARCHAR(500));
SELECT @HEAD	=  '<!DOCTYPE html>'+ '<html lang="es"><head><meta charset="UTF-8">'+
				   '<meta name="viewport" content="width=device-width, initial-scale=1.0"></head><body>'+
				   '<div style=" width: 100%; text-align: center">'+
				   '<img src="https://app.expertta.com.pe:28000/mails/banner.jpg" alt="bannerExpertta" style="width:100%; ">'+
				   '</div>'
SELECT @FOOTER =   '<div style=" width: 100%; text-align: center">'+
                   '<img src="https://app.expertta.com.pe:28000/mails/footer.png" alt="bannerExpertta"  style="width:100%;">'+
                   '</div></body></html>'
DECLARE @ERRORES TABLE(CONTINUA VARCHAR(2), ERROR VARCHAR(200))
DECLARE @RELIQUIDAR TABLE(ID INT IDENTITY, ITEM INT, NOADMISION VARCHAR(16), NOPRESTACION VARCHAR(16))
BEGIN
SET LANGUAGE Spanish;
   SELECT *
   INTO #JSON
   FROM OPENJSON (@json)
	WITH (
	   MODELO         VARCHAR(100)      '$.MODELO', 
	   METODO         VARCHAR(100)      '$.METODO',
	   USUARIO        VARCHAR(20)       '$.USUARIO',
       TIPO           VARCHAR(15)       '$.TIPO',
	   PARAMETROS     NVARCHAR(MAX)  AS JSON
	)
   SELECT @MODELO = MODELO , @METODO = METODO , @PARAMETROS = PARAMETROS, @USUARIO = USUARIO
   FROM #JSON
   SELECT @SEDE = '02'
   IF @METODO = 'RESERVARGEN'
   BEGIN
	   SELECT @VALOR = VALOR, @IDTERCERO = IDTERCERO, @IDPLAN = IDPLAN, @SERVICIOS = SERVICIOS, @AFILIADOS = AFILIADOS,
		       @ESCOMERCIAL = ESCOMERCIAL, @MEDIOINFORMACION = MEDIOINFORMACION, @SEDE = IDSEDE
	   FROM OPENJSON (@PARAMETROS)  
		WITH ( VALOR			DECIMAL(16,2)	'$.VALOR', 
			   IDTERCERO		VARCHAR(20)		'$.IDTERCERO',
			   IDPLAN			VARCHAR(6)		'$.IDPLAN',
			   ESCOMERCIAL		VARCHAR(2)		'$.ESCOMERCIAL',
			   MEDIOINFORMACION	VARCHAR(10)		'$.MEDIOINFORMACION',
			   IDSEDE	      VARCHAR(10)		'$.IDSEDE',
			   AFILIADOS		NVARCHAR(MAX)	 AS JSON,
			   SERVICIOS		NVARCHAR(MAX)	 AS JSON )

		SELECT ITEM, IDAFILIADO, CONSECUTIVO INTO #AFILIADOSLX FROM OPENJSON (@AFILIADOS) 
		WITH ( ITEM INT '$.ITEM', IDAFILIADO VARCHAR(20) '$.IDAFILIADO', CONSECUTIVO VARCHAR(13) '$.CONSECUTIVO' )
		ALTER TABLE #AFILIADOSLX ADD NOADMISION VARCHAR(16)
	
		SELECT value as IDSERVICIO, IDAFILIADO, VALORTOTAL INTO #SERVICIOSLX FROM OPENJSON(@SERVICIOS) 
		WITH ( value VARCHAR(20) '$.value', IDAFILIADO VARCHAR(20) '$.IDAFILIADO', VALORTOTAL DECIMAL(18,2) '$.VALORTOTAL'  ) 
		ALTER TABLE #SERVICIOSLX ADD ITEM INT IDENTITY
		ALTER TABLE #SERVICIOSLX ADD NEWCONSECUTIVO VARCHAR(13)

		INSERT INTO KPAGE(CONSECUTIVO, TABLA, PROCEDENCIA, FECHAGEN, MODO, VALOR, ESTADO, TIPO_PAGO, USUGENERA, COMERCIAL, MEDIOINF)
		SELECT '', 'CIT', 'RESERVA', CONVERT(SMALLDATETIME,GETDATE()), 'PRODUCTION',@VALOR, IIF(@VALOR = 0, 'PAID', 'PENDIENTE'), 'ENSEDE',@USUARIO, @ESCOMERCIAL, @MEDIOINFORMACION
		SELECT @IDKPAGE = @@IDENTITY

		SELECT @CONT1 = 1
		WHILE @CONT1 <= (SELECT COUNT(1) FROM #AFILIADOSLX)
		BEGIN
			SELECT @IDAFILIADO = IDAFILIADO, @CONSECUTIVO = CONSECUTIVO FROM #AFILIADOSLX WHERE ITEM = @CONT1
			BEGIN 
			   EXEC SPK_GENCONSECUTIVO '01',@SEDE,'@HADM',@NOADMISION OUTPUT
				SELECT @NOADMISION = @SEDE + RIGHT('00000000'+CONVERT(VARCHAR(8),@NOADMISION),8)
				INSERT INTO HADM (NOADMISION, IDAFILIADO, FECHA, IDSEDE, IDPLAN, IDTERCERO, TIPOADM, HABCAMA, VIAINGRESO, CAUSAEXTERNA, 
						            TIPODISCAP, GRADODISCAP, CAUSASALIDA, ESTADOPSALIDA, RESPCUENTA, URG_NOMBRE, URG_DIR, URG_TELE, URG_VINCULO, FACTURADA, CERRADA, 
						            PCUBRIMIENTO, USUARIO, DESTINO, ESTADOSALIDA, RIPS, NIVELSOCIOEC, TIPOPOLIZA, FACTURABLE, INDDEVOLUCION, TIPOTOPE, 
						            IDPROVEEDOR, TIPOCONT, FECHAPRE, DECLARIESGOS, CLASEING, EMBARAZADA, TTRIAGE, ESINSTPROV, IDPLAN_AFI, 
						            IDTERCERO_AFI, USACTC, TIPOHTX, TIPOESTANCIA, TIPOADMINI,ESTADO,
						            FECHAALTA,FECHAALTAMED, FECHAALTAENF)
				SELECT @NOADMISION, @IDAFILIADO, @HOY, @SEDE, @IDPLAN, @IDTERCERO, '01', NULL, '3', '', 
						 AFI.TIPODISCAPACIDAD, 'N', 'OR', 1, LEFT(TER.RAZONSOCIAL,45), AFI.URG_NOMBRE, AFI.URG_DIR, AFI.URG_TELE, AFI.URG_VINCULO, 0, 1, 
						 100, @USUARIO, 1, 'N', 0, AFI.NIVELSOCIOEC, 'Vigente', 1, 0, 'Fecha',
						 AFI.IDPROVEEDOR, 'I',@HOY, 'Manifiesto no ser Alérgico a ninguna Sustancia', 'A', 
						 0, 0, 3, AFI.IDPLAN,
						 AFI.IDADMINISTRADORA, 1, '01', NULL, '01','Activo',
						 @HOY,@HOY,@HOY
				FROM   AFI INNER JOIN TER ON @IDTERCERO=TER.IDTERCERO
				WHERE  AFI.IDAFILIADO = @IDAFILIADO
				
            UPDATE HADM  SET CERRADA = '0' , NIVELSOCIOEC = NULL  WHERE NOADMISION = @NOADMISION AND @IDPLAN IN ('PAQ039', 'MAD', 'PAQ025','TELECO')--AGREGADO AC

				END
				UPDATE #AFILIADOSLX SET NOADMISION = @NOADMISION WHERE IDAFILIADO = @IDAFILIADO
				SELECT @FECHACIT = FECHA, @IDMEDICO = IDMEDICO FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO

				--CREAR HPRED
				BEGIN
					SELECT @FECHAHPRE	= dbo.FNK_FECHA_SIN_MLS(GETDATE())
					SELECT @PREFIJO = PREFIJO, @APOYODG_AMBITO = AMBITO FROM SER WHERE IDSERVICIO = @IDSERVICIO
					PRINT 'CREANDO LA HPRE'
					SELECT @CCOSTO=CEN.CCOSTO, @IDAREA=CEN.IDAREA FROM PLN INNER JOIN CEN ON CEN.CCOSTO=PLN.CCOSTO WHERE PLN.IDPLAN = @IDPLAN
					SELECT @IDAREAH   = IDAREAH  FROM AFU WHERE IDAREA  = @IDAREA
					SELECT @ALTOCOSTO = COALESCE(GALTOCOSTO_QX,'No') FROM CEN WHERE CCOSTO = @CCOSTO

					PRINT 'GENERANDO CONSECUTIVO'
					EXEC SPK_GENCONSECUTIVO '01',@SEDE,'@HPRE', @NVOCONSEC OUTPUT  
					SELECT @NVOCONSEC = @SEDE + REPLACE(SPACE(8 - LEN(@NVOCONSEC))+LTRIM(RTRIM(@NVOCONSEC)),SPACE(1),0)

					PRINT '@NVOCONSEC: ' + @NVOCONSEC 
					PRINT 'INSERTANDO HPRE'
					INSERT INTO HPRE( NOPRESTACION, NOADMISION, FECHA, IDPLAN, IDAREA, IDSEDE, ALTOCOSTO, NO_ITEMES, VALORTOTAL,
								VALORCOPAGO, VALOREXEDENTE, IMPRESO, AUTORIZADOPOR, NUMAUTORIZA, FECHAAUTORIZA, AUTORIZADO,
								USUARIO, CERRADA, VALORPCOMP, CIRUGIA, PCUBRIMIENTO, CLASEORDEN, CONSECUTIVO, ESDEINV,
								PEDIDOINV, CNSMOV, INDDEVOLUCION, PREFIJO, CCOSTO, SUBCCOSTO, FINALIDAD, AMBITO, PERSONAL_AT,
								DXPPAL, DXRELACIONADO, COMPLICACION, FORMAQX, ESCONSULTA, IDAREAH, NIVELATENCION, IDAREAEQUIPO,
								IMPRESOP, IDMEDICO, COBRARA, IDTERCEROCA, CONSECUTIVOHCA, ITEMRED, ENLAB, PROCEDENCIA, 
								TIPOHISTORIA,SYS_COMPUTERNAME, COMERCIAL)
					SELECT @NVOCONSEC, @NOADMISION, @FECHAHPRE, @IDPLAN, @IDAREA, @SEDE, @ALTOCOSTO, NULL, 0, 0, 
						0, 0, NULL, NULL, NULL,
						NULL, @USUARIO, 0 ,0, 'No', 100, '', NULL, 0, 0, NULL, 0, @PREFIJO, @CCOSTO, '',
						1, NULL, NULL, NULL, NULL, NULL, NULL, 0, @IDAREAH, NULL, NULL, 0, @IDMEDICO, 'C', @IDTERCERO,
						@CONSECUTIVO, NULL, 0, 'CIT', NULL,NULL, @ESCOMERCIAL


					CREATE TABLE #CITEMP1( ITEM INT IDENTITY, CONSECUTIVO VARCHAR(13), IDSERVICIO VARCHAR(20), NOADMISION VARCHAR(16) )

					INSERT INTO #CITEMP1( CONSECUTIVO, IDSERVICIO, NOADMISION )
					SELECT IDAFILIADO,IDSERVICIO, @NOADMISION FROM #SERVICIOSLX WHERE IDAFILIADO = @IDAFILIADO
					SELECT @OBSERVACION = 'GENERADO POR CONTROL DE AGENDA DE LX'
					
					SET @CONT = 1 --INSERTA HPRED
					WHILE ( @CONT <= (SELECT COUNT(1) FROM #CITEMP1))
					BEGIN
						SELECT @IDSERVICIO = IDSERVICIO FROM #CITEMP1 WHERE ITEM = @CONT
						SELECT @VALOR = VLRSERVICIO ,@CODCUPS = CODCUPS FROM SERTOT 
						WHERE  IDTERCERO  = @IDTERCERO 
						AND    IDPLAN     = @IDPLAN
						AND    IDSERVICIO = @IDSERVICIO
						AND    @FECHAHPRE >= FECHAINIFD
						AND    @FECHAHPRE <= FECHAFINFD
						AND    @FECHAHPRE >= FECHAINI
						AND    @FECHAHPRE <= FECHAFIN

						SELECT @IDCONCEPTORIPS = CODIGORIPS FROM SER WHERE IDSERVICIO = @IDSERVICIO
						--SELECT @IDAREA, @IDAREAH, @SEDE, @PREFIJO, @APOYODG_AMBITO,@CCOSTO,@ALTOCOSTO,@VALOR,@CODCUPS,@IDCONCEPTORIPS
						PRINT 'INSERTANDO HPRED'
						INSERT INTO HPRED(NOPRESTACION, NOITEM, IDSERVICIO, CANTIDAD, VALOR, VALORCOPAGO, VALOREXCEDENTE, VALORTOTALCOSTO,
									IDPLAN, IMPRESO, AUTORIZADO, COMENTARIOS, IDPROVEEDOR, IDCONCEPTORIPS, AMBITO, FINALIDAD, 
									PERSONAL_AT, DXPPAL, DXRELACIONADO, COMPLICACION, FORMAQX, VALORPCOMP, IDCIRUGIA, USUARIO,
									UTISOAT, VLRFALTAAPLICARSOAT, TIPOSERCIRUGIA, FACTURADA, N_FACTURA, VLRAPLICADO1, VLRAPLICADO2,
									CANTIDADORIGINAL, CANTIDADDEVUELTA, CNSIDEV, INDDEVOLUCION, INDDEVAPLICADA, USUARIODEV, NOCOBRABLE,
									ITEMCIRUGIA, PCOSTO, CXP, FECHA, VIA, IDAREAH, IDAREA, NIVELATENCION, PEDIDOINV, CONSECUTIVOCX,
									NOLOTE, COBRARA, IDTERCEROCA, PCUBRIMIENTO, TIPODTO, DESCUENTO, NORDEN, CCOSTO, CODCUPS,
									APOYODG_AMBITO, ENCARGOS, FECHASOL)

						SELECT @NVOCONSEC, @CONT, @IDSERVICIO, 1, @VALOR, 0, 0, 0, @IDPLAN, 0, NULL, @OBSERVACION, NULL,
											@IDCONCEPTORIPS, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 0, NULL, @USUARIO, 0, 0, NULL, 0, NULL,
											0, 0, 1 , 0, NULL , 0, 0,  NULL, 0,NULL, 0, 0, @FECHAHPRE,  'NA', @IDAREAH, @IDAREA, NULL, 0, NULL, 
											NULL, 'C', @IDTERCERO, 100, 'N', 0, NULL, @CCOSTO, @CODCUPS,@APOYODG_AMBITO, 0, @FECHAHPRE
						
						EXEC SPK_GENCONSECUTIVO '01', '01','@HTX', @CNSHTX OUTPUT  
						SELECT @CNSHTX = '01' + REPLACE(SPACE(8 - LEN(@CNSHTX))+LTRIM(RTRIM(@CNSHTX)),SPACE(1),0) 

						INSERT INTO HTX ( 
							CNSHTX, CONSECUTIVOHCA, CODOM, ITEMRED, TIPOHISTORIA, IDSERVICIO, CANTIDAD, FECHAORDEN, IDTIPOCONC, VIA, FECHAREQ, CLASE, TIPO
							, SOLICITADO, APLICADO, ENCARGOS,NOPRESTACION, NOITEM, NOADMISION, ESTADO, CCOSTO, IDAREA, LISTOENTREGA, ENTREGADO, APROBADO, CLASEHTX
							, IDPLAN, CONSECUTIVO_CIT, CNSCONTENEDOR, PA_RECIBIDO, PA_ESTADO )
						SELECT
							@CNSHTX, NULL, '005',NULL, 'O', @IDSERVICIO,1,CONVERT(DATE,GETDATE()),'','',CONVERT(DATE,GETDATE()),'I', 'Horaria'
							,0,0,1,@NVOCONSEC,@CONT,@NOADMISION, 'A','102','01',0,0,0,'NE'
							,@IDPLAN,NULL,NULL,NULL,NULL

						UPDATE HPRED SET CNSHBALI = @CNSHTX WHERE NOPRESTACION = @NVOCONSEC AND NOITEM = @CONT AND HPRED.IDSERVICIO = @IDSERVICIO

						SET @CONT  = @CONT + 1
					END
               --ACTUALIZAMOS VALORES EN HPRED Y HPRE DESPUES DE REPARTIR COPAGO
               UPDATE HPRED SET VALOREXCEDENTE = COALESCE(VALOR,0) - COALESCE(VALORCOPAGO,0) WHERE NOPRESTACION = @NVOCONSEC
					UPDATE HPRE SET VALORTOTAL = X.VALOR ,VALORCOPAGO = X.VALORCOPAGO ,VALOREXEDENTE = X.VALOREXCEDENTE
               FROM  (SELECT NOPRESTACION, SUM(COALESCE(VALOREXCEDENTE,0)) VALOREXCEDENTE, SUM(COALESCE(VALOR,0)) VALOR , SUM(COALESCE(VALORCOPAGO,0)) VALORCOPAGO
                      FROM   HPRED
                      WHERE  NOPRESTACION = @NVOCONSEC
                      GROUP BY NOPRESTACION
                     ) X
               WHERE HPRE.NOPRESTACION = X.NOPRESTACION
					--ASIGNAR CITA:
					BEGIN
					IF EXISTS(SELECT * FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO AND COALESCE(IDAFILIADO,'')='')
					BEGIN
						PRINT 'INSERTA EN CONSECUTIVO ORIGINAL'
						UPDATE CIT SET 
							IDAFILIADO=@IDAFILIADO, IDSERVICIO=@IDSERVICIO, IDPLAN=@IDPLAN, IDTERCEROCA=@IDTERCERO,
							IDCONTRATANTE=@IDTERCERO, NOADMISION=@NOADMISION, FECHASOL=CONVERT(SMALLDATETIME,GETDATE()), IDEMEDICA='550', WEB=0,
							TIPOCOPAGO='N', CLASECONTRATO='E', AQUIENCOBRO='N', COVID=0, USUARIO = @USUARIO, IDKPAGE = @IDKPAGE, COMERCIAL = COMERCIAL, VALORCOPAGO = @VALOR
						WHERE CONSECUTIVO=@CONSECUTIVO
						UPDATE HTX SET CONSECUTIVO_CIT = @CONSECUTIVO WHERE NOPRESTACION = @NVOCONSEC
					END
					ELSE
					BEGIN
						PRINT 'CREA NUEVOS CONSECUTIVOS SI LA CITA ORIGINAL ESTA OCUPADA'
						SELECT @CONT3 = 1
						WHILE  @CONT3 <> 0
						BEGIN
							IF NOT EXISTS(SELECT * FROM CIT WHERE IDMEDICO = @IDMEDICO AND FECHA = DATEADD(SECOND, 10 * @CONT3, @FECHACIT) )
							BEGIN
								EXEC SPK_GENCONSECUTIVO '01',@SEDE,'@CIT', @CONSECUTIVOTEMP OUTPUT  
								SELECT @CONSECUTIVOTEMP = @SEDE + REPLACE(SPACE(8 - LEN(@CONSECUTIVOTEMP))+LTRIM(RTRIM(@CONSECUTIVOTEMP)),SPACE(1),0)    
								INSERT INTO CIT(CONSECUTIVO, IDAFILIADO, IDSERVICIO,IDPLAN,IDTERCEROCA,IDCONTRATANTE,NOADMISION, FECHASOL,
												IDMEDICO, IDEMEDICA, FECHA, TIPOCITA, TIPOSOLICITUD, ATENCION, IDSEDE, DISPONIBILIDAD, CLASEORDEN,COVID, WEB,USUGENAGENDA,FGENERACION,
												TIPOCOPAGO,CLASECONTRATO,AQUIENCOBRO, USUARIO, IDKPAGE, COMERCIAL, VALORCOPAGO )
								SELECT @CONSECUTIVOTEMP, @IDAFILIADO, @IDSERVICIO, @IDPLAN, @IDTERCERO, @IDTERCERO, @NOADMISION, CONVERT(SMALLDATETIME,GETDATE()), 
										IDMEDICO, IDEMEDICA, DATEADD(SECOND, 10 * @CONT3, @FECHACIT) , TIPOCITA, TIPOSOLICITUD, ATENCION, @SEDE, DISPONIBILIDAD, CLASEORDEN, COVID, WEB, USUGENAGENDA, FGENERACION,
										TIPOCOPAGO, CLASECONTRATO, AQUIENCOBRO, @USUARIO, @IDKPAGE, @ESCOMERCIAL, @VALOR
								FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO

								UPDATE HTX SET CONSECUTIVO_CIT = @CONSECUTIVO WHERE NOPRESTACION = @NVOCONSEC


								SELECT @CONT3 = 0
							END
							ELSE SELECT @CONT3 = @CONT3 + 1
						END
					END
				END
				DROP TABLE #CITEMP1
			END

			EXEC SPK_ASIGNAR_CONTENEDOR @NVOCONSEC, @NOADMISION, @SEDE
			SELECT @CONT1 = @CONT1 +1
		END
		SELECT @IDKPAGE IDKPAGE, @VALOR VALOR
		
		/* INICIO CAMBIOS ANDRE */
		INSERT INTO COMER (CONSECUTIVO_CIT, IDAFILIADO, USUARIOCREADOR , NOADMISION , FECHAREGISTRA, ORIGEN, ESTADO)
		SELECT @CONSECUTIVO, @IDAFILIADO,@USUARIO, @NOADMISION, GETDATE(), 'PRESENCIAL', 'PENDIENTE'
		SELECT @IDCOMER = @@IDENTITY
		INSERT INTO COMERD (IDCOMER, CONSECUTIVO_CIT, USUARIOOBSERVACION, OBSERVACION)
		SELECT @IDCOMER, @CONSECUTIVO, @USUARIO, 'REGISTRO DE PRUEBA'
		/* FIN CAMBIOS ANDRE */

	RETURN
   END
   IF @METODO = 'PROCESAPAGO'
   BEGIN
	SELECT @PAGOS = PAGO, @IDKPAGE = IDKPAGE, @VALOR = VALOR, @IDAFILIADO = IDAFILIADO FROM OPENJSON (@PARAMETROS)  
		WITH ( VALOR DECIMAL(16,2) '$.VALOR', IDKPAGE INT '$.IDKPAGE', IDAFILIADO	VARCHAR(20) '$.IDAFILIADO' , PAGO NVARCHAR(MAX) AS JSON )
		--2. INSERTO EN KPAGED
		SELECT * INTO #PAGOSHTX FROM OPENJSON(@PAGOS) WITH (  ITEM			INT				'$.item',		TIPOPAGO		VARCHAR(13)		'$.tipopago',
															  VALOR			DECIMAL(16,2)	'$.valor',		PROCEDENCIA		VARCHAR(25)		'$.procedencia',
															  REFERENCIA	VARCHAR(20)		'$.referencia', OBSERVACION		VARCHAR(200)	'$.observacion' )
		BEGIN TRY
			INSERT INTO KPAGED(IDKPAGE, ITEM, TIPO, CLASE, REFERENCIA, OBSERVACION, VALOR)
			SELECT @IDKPAGE, ITEM, TIPOPAGO, PROCEDENCIA, REFERENCIA, OBSERVACION, VALOR FROM #PAGOSHTX
			UPDATE KPAGE 
			   SET ESTADO = 'PAID', 
				   USUCOBRA = @USUARIO, 
				   FECHARES = CONVERT(smalldatetime, GETDATE()), 
				   PROCEDENCIA ='EN SEDE',
				   TABLA ='HTX',
				   TIPO_PAGO='ENSEDE',
				   RESPONSABLEPAGO = @IDAFILIADO 
			 WHERE IDKPAGE = @IDKPAGE
			--INSERTA EN FCJ
			SELECT @NOMBREAFI = NOMBREAFI FROM AFI WHERE IDAFILIADO = @IDAFILIADO
			SELECT @IDSEDE ='02'
			SELECT @VALOR = VALOR FROM KPAGE WHERE IDKPAGE = @IDKPAGE

			SELECT @CNSFCJ		= NULL
			EXEC SPK_GENCONSECUTIVO '01','01','@FCJ', @CNSFCJ OUTPUT  
			SELECT @CNSFCJ		= '01' + REPLACE(SPACE(8 - LEN(@CNSFCJ))+LTRIM(RTRIM(@CNSFCJ)),SPACE(1),0) 
		END TRY
		BEGIN CATCH
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
			RETURN
		END 
		END CATCH

		IF (SELECT COUNT(*) FROM @TBLERRORES) < 1
		BEGIN
				SELECT 'OK' OK
			RETURN
		END 
   END
   IF @METODO = 'GENBOLETA'
   BEGIN
		SELECT @IDAFILIADO = IDAFILIADO, @CELULAR = CELULAR, @EMAIL = EMAIL, @IDKPAGE = IDKPAGE FROM OPENJSON(@PARAMETROS) 
		WITH (	IDAFILIADO	VARCHAR(20)		'$.IDAFILIADO',
				CELULAR		VARCHAR(15)		'$.CELULAR',
				EMAIL		VARCHAR(100)	'$.EMAIL',
				IDKPAGE		INT				'$.IDKPAGE'
			)

		BEGIN TRY
			--SELECT @IDAFILIADO, @CELULAR, @EMAIL, @IDKPAGE
			UPDATE AFI SET EMAIL= @EMAIL, CELULAR = @CELULAR WHERE IDAFILIADO = @IDAFILIADO
			INSERT INTO AFIH(FECHA, TIPO_DOC,IDAFILIADO, DOCIDAFILIADO, PAPELLIDO,SAPELLIDO,PNOMBRE, SNOMBRE, IDTERCERO, IDPLAN, TIPOSUBSIDIO, COBERTURA_SALUD, EMAIL, CELULAR, TELEFONORES, USUCAMBIA)
			SELECT CONVERT(SMALLDATETIME, GETDATE()),TIPO_DOC, IDAFILIADO, DOCIDAFILIADO, PAPELLIDO, SAPELLIDO, PNOMBRE, SNOMBRE, IDPROVEEDOR, IDPLAN, '','',@EMAIL, @CELULAR, TELEFONORES, @USUARIO FROM AFI WHERE IDAFILIADO = @IDAFILIADO
		END TRY
		BEGIN CATCH
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		END CATCH

		BEGIN TRY
			CREATE TABLE #PRESTA( ITEM INT IDENTITY, IDAFILIADO VARCHAR(20), NOADMISION VARCHAR(16), NOPRESTACION VARCHAR(16) )
			INSERT INTO #PRESTA(IDAFILIADO, NOADMISION, NOPRESTACION)
			SELECT CIT.IDAFILIADO,CIT.NOADMISION , HTX.NOPRESTACION
			FROM   CIT  
			INNER JOIN HTX ON CIT.NOADMISION = HTX.NOADMISION
			INNER JOIN SER ON HTX.IDSERVICIO = SER.IDSERVICIO
			WHERE  IDKPAGE = @IDKPAGE
			GROUP BY CIT.IDAFILIADO, CIT.NOADMISION, HTX.NOPRESTACION

			

			SELECT @SEDE= '01'

			EXEC SPK_GENCONSECUTIVO '01',@SEDE,'@RPDX', @RPDX OUTPUT  
			SELECT @RPDX = @SEDE + REPLACE(SPACE(8 - LEN(@RPDX))+LTRIM(RTRIM(@RPDX)),SPACE(1),0)
			DECLARE @NOPRESTACION VARCHAR(16)

			SELECT @NOPRESTACION = NOPRESTACION FROM #PRESTA WHERE IDAFILIADO = @IDAFILIADO

			CREATE TABLE #PRESTAD( ID INT IDENTITY, NOPRESTACION VARCHAR(20), ITEM INT )

			INSERT INTO #PRESTAD(NOPRESTACION, ITEM)
			SELECT HPRED.NOPRESTACION, HPRED.NOITEM FROM HPRED INNER JOIN #PRESTA ON HPRED.NOPRESTACION = #PRESTA.NOPRESTACION COLLATE Modern_Spanish_CS_AS

			SELECT @CONT1 = 1
			WHILE @CONT1 <= (SELECT COUNT(*) FROM #PRESTAD)
			BEGIN
				SELECT @NOPRESTACION = NOPRESTACION, @ITEM = ITEM FROM #PRESTAD WHERE ID = @CONT1
				UPDATE HPRED SET NOITEM = @CONT1 WHERE NOPRESTACION = @NOPRESTACION  AND NOITEM = @ITEM	
			SELECT @CONT1 = @CONT1+1
			END

			SELECT @NOPRESTACION = NOPRESTACION FROM #PRESTA WHERE IDAFILIADO = @IDAFILIADO
			PRINT 'ACTUALIZO TODOS HPRED'
			UPDATE HPRED SET NOPRESTACION = @NOPRESTACION 
			FROM HPRED INNER JOIN #PRESTA ON HPRED.NOPRESTACION = #PRESTA.NOPRESTACION COLLATE Modern_Spanish_CS_AS
			PRINT 'FIN ACTUALIZO'

			SELECT @NOADMISION = NOADMISION FROM #PRESTA WHERE IDAFILIADO = @IDAFILIADO

			EXEC SPK_COPAGOQX @NOADMISION, @NOPRESTACION, 1

			UPDATE HPRED SET MARCA=1, USUARIOMARCA = @USUARIO WHERE NOPRESTACION = @NOPRESTACION

			EXEC SPK_AFACTURAR @NOADMISION, @RPDX, @USUARIO
			SELECT @ITEM = ITEM FROM RPDX WHERE CNS = @RPDX
			
			SELECT @NIT = NIT FROM SED WHERE IDSEDE ='01'
			SELECT @IDSEDE2 = (SELECT  SED.IDSEDE FROM USUSU 
				INNER JOIN UBEQ ON USUSU.SYS_ComputerName = UBEQ.SYS_ComputerName
				INNER JOIN SED ON UBEQ.IDSEDE =  SED.IDSEDE
				WHERE USUSU.USUARIO = @USUARIO)
				SELECT @NOMBREEQUIPO = (SELECT  USUSU.SYS_ComputerName FROM USUSU WHERE USUSU.USUARIO = @USUARIO)

			EXEC SPK_FACTURA_ADMISION_DOMI @NOADMISION, @NIT, '01', @IDSEDE2, @USUARIO, @NOMBREEQUIPO, @RPDX, @ITEM

			SELECT @URLFACTURA = FTR.LINKFACTURA, @N_FACTURA = FTR.N_FACTURA
			FROM  FTR INNER JOIN HPRED ON HPRED.N_FACTURA = FTR.N_FACTURA
			WHERE HPRED.NOPRESTACION = @NOPRESTACION
			EXEC SPK_GENERA_JSON_PERU_FACTURA @N_FACTURA
			IF @URLFACTURA IS NOT NULL
			BEGIN
				PRINT 'EXISTE URL'
				SELECT 'GENERADA'RESULTADO, @URLFACTURA URLFACTURA, @N_FACTURA N_FACTURA

				UPDATE KPAGE SET REF_PAGO = @N_FACTURA, FACTURADO = 'OK', RESPONSABLEPAGO = @IDAFILIADO  WHERE IDKPAGE = @IDKPAGE

				IF LEN(@CELULAR) = 9
				  BEGIN
					SELECT @MENSAJE = 'Se ha generado tu Boleta, descargala aquí: '+ @URLFACTURA
					PRINT 'ENVÍO SMS Y WAP DE NOTIFICACIÓN: '
					PRINT '@MENSAJE: ' + @MENSAJE
					PRINT '@URLFACTURA: ' + @URLFACTURA
					EXEC SPK_SENDSMS @CELULAR,@MENSAJE 
					EXEC DBO.SPK_SEND_WHATSAPP @CELULAR, @MENSAJE
				  END
				IF LEN(@EMAIL) > 5
				  BEGIN 
				  PRINT 'ENVÍO EMAIL DE NOTIFICACIÓN: '
				  PRINT '@NOMBRES: ' + @NOMBRES
				  PRINT '@EMAIL: ' + @EMAIL
				  PRINT '@URLFACTURAL: ' + @URLFACTURA

				   SELECT @NOMBRES = CONCAT(COALESCE(AFI.PNOMBRE,''),' ', COALESCE(AFI.SNOMBRE,'') ) FROM AFI WHERE IDAFILIADO = @IDAFILIADO
					SELECT @BODY_EMAIL = '<div class="text" style="font: 100% sans-serif">'+
											'<p>Hola '+ @NOMBRES +'</p>'+
											'<p>La generación de tu boleta ha sido exitosa.</p>'+
											'<p><a href="'+@URLFACTURA+'">Descargar.</a>.</p> '+
											'<p>Muchas gracias por utilizar nuestros servicios.</p>'+
										 '</div>'
					SET @html = @HEAD + @BODY_EMAIL + @FOOTER
					PRINT 'ENVIO DE EMAIL'
					--SET @html = dbo.fnk_limpiatexto(@html, ' a-z0-9 .,<>/"''%;:=??() ')
					EXEC DBO.SPK_SENDMAIL_EXPERTTA  @to = @EMAIL, @subject = 'Facturación Expertta', @body_html=@html 
				  END
			  END
			ELSE
			  BEGIN
				SELECT 'ERROR'RESULTADO
			  END
		
		END TRY
		BEGIN CATCH
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
			RETURN
		END
		END CATCH
		
		
	RETURN
   END
   IF @METODO = 'DATOSORDEN'
   BEGIN
    SELECT @IDKPAGE = IDKPAGE FROM OPENJSON(@PARAMETROS) WITH( IDKPAGE INT '$.IDKPAGE' )
		SELECT DISTINCT CIT.IDAFILIADO
			   ,AFI.TIPO_DOC, AFI.DOCIDAFILIADO, COALESCE(AFI.PNOMBRE,'')PNOMBRE, COALESCE(AFI.SNOMBRE,'')SNOMBRE, COALESCE(AFI.PAPELLIDO,'')PAPELLIDO, COALESCE(AFI.SAPELLIDO,'')SAPELLIDO
			   ,AFI.NOMBREAFI
			   ,AFI.SEXO, COALESCE(AFI.CELULAR,'')CELULAR, COALESCE(AFI.TELEFONORES,'')TELEFONORES
			   ,AFI.EDAD
			   ,CIT.FECHA
		FROM CIT
		INNER JOIN AFI ON AFI.IDAFILIADO = CIT.IDAFILIADO
		WHERE CIT.IDKPAGE = @IDKPAGE

		SELECT CIT.CONSECUTIVO, CIT.FECHA, CIT.IDAFILIADO, SER.IDSERVICIO, SER.DESCSERVICIO
		FROM CIT
		INNER JOIN HTX ON CIT.CONSECUTIVO = HTX.CONSECUTIVO_CIT
		INNER JOIN SER ON HTX.IDSERVICIO = SER.IDSERVICIO
		WHERE CIT.IDKPAGE = @IDKPAGE 
	RETURN
   END
   IF @METODO = 'DATOSORDEN_CIT'
   BEGIN
	SELECT @CONSECUTIVO = CONSECUTIVO FROM OPENJSON(@PARAMETROS) WITH( CONSECUTIVO varchar(13) '$.CONSECUTIVO' )
	SELECT CIT.IDAFILIADO
		,AFI.TIPO_DOC, AFI.DOCIDAFILIADO, COALESCE(AFI.PNOMBRE,'')PNOMBRE, COALESCE(AFI.SNOMBRE,'')SNOMBRE, COALESCE(AFI.PAPELLIDO,'')PAPELLIDO, COALESCE(AFI.SAPELLIDO,'')SAPELLIDO
		,AFI.NOMBREAFI
		,AFI.SEXO, COALESCE(AFI.CELULAR,'')CELULAR, COALESCE(AFI.TELEFONORES,'')TELEFONORES
		,AFI.EDAD
		,CIT.FECHA
		,CIT.IDKPAGE
	FROM CIT
	INNER JOIN AFI ON AFI.IDAFILIADO = CIT.IDAFILIADO
	WHERE CIT.CONSECUTIVO = @CONSECUTIVO

	SELECT CIT.CONSECUTIVO, CIT.FECHA, CIT.IDAFILIADO, SER.IDSERVICIO, SER.DESCSERVICIO
	FROM CIT
	INNER JOIN HTX ON CIT.CONSECUTIVO = HTX.CONSECUTIVO_CIT
	INNER JOIN SER ON HTX.IDSERVICIO = SER.IDSERVICIO
	WHERE CIT.CONSECUTIVO = @CONSECUTIVO 
	RETURN
   END
   IF @METODO = 'DATOSTOMA'
   BEGIN
	SELECT @CONSECUTIVO = CONSECUTIVO FROM OPENJSON(@PARAMETROS) WITH( CONSECUTIVO VARCHAR(13) '$.CONSECUTIVO' )
	SELECT @NOADMISION = NOADMISION FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO

	SELECT @CONT1 = COUNT(*) FROM CIT INNER JOIN KPAGE ON CIT.IDKPAGE = KPAGE.IDKPAGE WHERE CIT.CONSECUTIVO = @CONSECUTIVO AND KPAGE.PROCEDENCIA = 'AFI_APP'
	IF NOT EXISTS(SELECT * FROM HTX WHERE CONSECUTIVO_CIT = @CONSECUTIVO AND HTX.NOADMISION = @NOADMISION) AND @CONT1 > 0
	BEGIN
		SELECT @STRING = '{"MODELO":"AGENDALXDOMI","METODO":"CREAHTXHPRED","PARAMETROS":{"CONSECUTIVO":"'+ @CONSECUTIVO + '"} ,"USUARIO":"'+ @USUARIO + '"}'
		PRINT @STRING
		EXEC SPQ_JSON @STRING
	END
	--1 Datos Afiliado
	BEGIN
		SELECT  AFI.NOMBREAFI, AFI.TIPO_DOC, AFI.DOCIDAFILIADO, AFI.IDAFILIADO, AFI.SEXO, AFI.EDAD, AFI.TELEFONORES, AFI.CELULAR, AFI.EMAIL
			  , floor((cast(convert(varchar(8),getdate(),112) as int)-cast(convert(varchar(8),AFI.FNACIMIENTO,112) as int) ) / 10000) as EDAD_LIMPIA
			  , AFI.FNACIMIENTO, CIT.OBSERVACIONES
			  , CIT.VALORCOPAGO
			  , AFI.DIRECCION, AFI.CIUDAD, CIU.NOMBRE DESCCIUDAD
			  , AFI.CORREGIMIENTO, TGEN.DESCRIPCION DISTRITO
			  , CONCAT(COALESCE(AFI.DIRECCION,''), ', ',COALESCE(TGEN.DESCRIPCION,''),', ',COALESCE(CIU.NOMBRE,'')) AFIDIRECCION
		FROM AFI 
		INNER JOIN CIT ON CIT.IDAFILIADO = AFI.IDAFILIADO
		LEFT JOIN CIU ON AFI.CIUDAD = CIU.CIUDAD
		LEFT JOIN TGEN ON AFI.CIUDAD = TGEN.CAMPO AND AFI.CORREGIMIENTO = TGEN.CODIGO
		WHERE CIT.CONSECUTIVO = @CONSECUTIVO
	END
	SELECT @CNSHTX = CNSHTX FROM HTX WHERE CONSECUTIVO_CIT = @CONSECUTIVO 
	--2 Historial
	BEGIN
		SELECT FECHASOL FECHA, '' EVENTO,'ASIGNACIÓN DE CITA' DESCRIPCION,CIT.USUARIO, CASE KPAGE.PROCEDENCIA WHEN 'AFI_APP' THEN 'Agendamiento virtual' ELSE USUSU.NOMBRE END NOMBRE , ''CAUSANOTOMA, ''OBSERVACION
		FROM CIT
		LEFT JOIN USUSU ON USUSU.USUARIO = CIT.USUARIO
		LEFT JOIN KPAGE ON KPAGE.IDKPAGE = CIT.IDKPAGE
		WHERE CIT.CONSECUTIVO = @CONSECUTIVO
			UNION ALL
		SELECT CIT.FECHALLEGA FECHA, '' EVENTO,'LLEGADA DE PACIENTE' DESCRIPCION, CIT.USUARIO, ''CAUSANOTOMA, ''OBSERVACION, USUSU.NOMBRE NOMBRE 
		FROM CIT
		LEFT JOIN USUSU ON USUSU.USUARIO = CIT.USUARIOLLEGA
		WHERE CONSECUTIVO = @CONSECUTIVO
			UNION ALL
		SELECT CIT.FECHAATENCION FECHA, '' EVENTO,'TOMA DE MUESTRA' DESCRIPCION, CIT.USUARIO, ''CAUSANOTOMA, ''OBSERVACION, USUSU.NOMBRE NOMBRE 
		FROM CIT
		LEFT JOIN USUSU ON USUSU.USUARIO = CIT.USUATENCION
		WHERE CONSECUTIVO = @CONSECUTIVO
	END
	
	SELECT @VALOR = 0
	SELECT @VALOR = COALESCE(CIT.VALORCOPAGO,0), @IDKPAGE = COALESCE(IDKPAGE,'') FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO
	DECLARE @IDKPAGE2 VARCHAR (10)
	SELECT @IDKPAGE2 = COALESCE(TFCJ.IDKPAGE,'')
		FROM  HTX
			  INNER JOIN HPRED ON HTX.NOPRESTACION = HPRED.NOPRESTACION AND HTX.IDSERVICIO = HPRED.IDSERVICIO
			  LEFT JOIN FTR ON ( CASE WHEN HPRED.VALORCOPAGO = 0 THEN HPRED.N_FACTURA ELSE   HPRED.N_FACTURAH END ) = FTR.N_FACTURA --AND FTRD.REFERENCIA = HPRED.IDSERVICIO
			  LEFT JOIN TFCJ ON FTR.N_FACTURA = TFCJ.N_FACTURA
		WHERE CONSECUTIVO_CIT = @CONSECUTIVO
			  AND COALESCE(HPRED.N_FACTURAH,'')<>''
	--SELECT @IDKPAGE2 = COALESCE(TFCJ.IDKPAGE,'')
	--	FROM  HTX
	--		  INNER JOIN HPRED ON HTX.NOPRESTACION = HPRED.NOPRESTACION
	--		  INNER JOIN TFCJ ON HPRED.N_FACTURAH = TFCJ.N_FACTURA
	--	WHERE CONSECUTIVO_CIT = @CONSECUTIVO
	--		  AND COALESCE(HPRED.N_FACTURAH,'')<>''
	IF COALESCE(@IDKPAGE,'') = COALESCE(@IDKPAGE2,'')  AND COALESCE(@IDKPAGE,'')=''
		BEGIN
			SELECT @IDKPAGE = COALESCE(TFCJ.IDKPAGE,'')
			FROM  HTX
				  INNER JOIN HPRED ON HTX.NOPRESTACION = HPRED.NOPRESTACION
				  INNER JOIN TFCJ ON HPRED.N_FACTURAH = TFCJ.N_FACTURA
			WHERE CONSECUTIVO_CIT = @CONSECUTIVO
				  AND COALESCE(HPRED.N_FACTURAH,'')<>''
			UPDATE CIT SET IDKPAGE = @IDKPAGE WHERE CONSECUTIVO = @CONSECUTIVO
		END
	IF COALESCE(@IDKPAGE,'') <> COALESCE(@IDKPAGE2,'') AND  COALESCE(@IDKPAGE2,'') <> ''
		BEGIN
			SELECT @IDKPAGE = @IDKPAGE2
			UPDATE CIT SET IDKPAGE = @IDKPAGE WHERE CONSECUTIVO = @CONSECUTIVO
		END
	IF( SELECT COUNT(*) FROM KPAGE KP INNER JOIN CIT ON KP.IDKPAGE = CIT.IDKPAGE WHERE CIT.CONSECUTIVO = @CONSECUTIVO ) = 0 AND @VALOR <> 0 AND COALESCE(@IDKPAGE,'')=''
	BEGIN
		INSERT INTO KPAGE(CONSECUTIVO,TABLA, PROCEDENCIA, FECHAGEN, MODO, VALOR, ESTADO, TIPO_PAGO, USUGENERA)
		SELECT @CONSECUTIVO,'CIT', 'RESERVA', CONVERT(SMALLDATETIME,GETDATE()), 'PRODUCTION', @VALOR, 'PENDIENTE', 'ENSEDE', @USUARIO
		SELECT @IDKPAGE = @@IDENTITY
		UPDATE CIT SET IDKPAGE = @IDKPAGE WHERE CONSECUTIVO = @CONSECUTIVO
	END
	--3 Datos de pago
	BEGIN
		DECLARE @REF_PAGO VARCHAR (20)
		SELECT @REF_PAGO = ( SELECT REF_PAGO FROM KPAGE INNER JOIN CIT ON KPAGE.IDKPAGE =  CIT.IDKPAGE WHERE CIT.CONSECUTIVO = @CONSECUTIVO )
		IF (SELECT FACTEP FROM FTR WHERE N_FACTURA = @REF_PAGO) = 'PEND'
			BEGIN
			--PRINT 'ESTADO FACTEP PENDIENTE --'
			 EXEC SPK_CONSULTA_DOCUMENTO_ELECTRONICA @REF_PAGO
			END
		SELECT KP.IDKPAGE, KP.FECHAGEN, KP.FECHARES, KP.VALOR,KP.ESTADO, KP.TIPO_PAGO
			  ,KP.REF_PAGO, KP.USUCOBRA, U1.NOMBRE NOMBRECOBRA
			  ,KP.RESPONSABLEPAGO, AFI.NOMBREAFI, AFI.DOCIDAFILIADO, AFI.TIPO_DOC, AFI.CELULAR
			  ,KP.COMERCIAL,KP.MEDIOINF, MI.DESCRIPCION,KP.USUGENERA, U2.NOMBRE NOMBREGENERA
			  ,FTR.LINKFACTURA
			  ,FTR.FACTEP
			  ,FTR.RAZONANULACION
		FROM KPAGE KP 
		INNER JOIN CIT ON KP.IDKPAGE = CIT.IDKPAGE
		LEFT JOIN FTR ON FTR.N_FACTURA = KP.REF_PAGO
		LEFT JOIN USUSU U1 ON U1.USUARIO = KP.USUCOBRA
		LEFT JOIN USUSU U2 ON U2.USUARIO = KP.USUGENERA
		LEFT JOIN AFI ON AFI.IDAFILIADO = KP.RESPONSABLEPAGO
		LEFT JOIN ( SELECT TABLA, CAMPO, CODIGO, DESCRIPCION FROM TGEN WHERE TABLA = 'AGENDALX' AND CAMPO ='MEDIOSINF')MI
					 ON MI.CODIGO = KP.MEDIOINF
		WHERE CIT.CONSECUTIVO = @CONSECUTIVO

	END
	--Datos de Orden MEd
	SELECT @CONSECUTIVOHCA = HTX.CONSECUTIVOHCA
	FROM CIT 
	INNER JOIN HTX ON HTX.CONSECUTIVO_CIT = CIT.CONSECUTIVO
	WHERE CONSECUTIVO = @CONSECUTIVO
	SELECT @CONSECUTIVOHCA CONSECUTIVOHCA
	--URL pago
	IF COALESCE(@IDKPAGE,0)<>0
	BEGIN
		SELECT @BODY = REPLACE(BODY,'%',''), @response = RESPUESTA FROM KPAGE WHERE IDKPAGE = @IDKPAGE
		IF @response = 'SUCCESS'
		SELECT @response = @BODY

		SELECT @STATUS = status
			 , @ANSWER = answer 
		FROM OPENJSON(@BODY)
		WITH(
			status	VARCHAR(20)   '$.status', 
			answer	NVARCHAR(MAX) AS JSON
		)
		PRINT @BODY
		PRINT @response
		PRINT ''
		SELECT @STATUS status
			 , T1.paymentURL
			 , T1.paymentOrderStatus
			 , T1.expirationDate
			 , DATEADD(HOUR,+5,CONVERT(DATETIME,replace(replace(LEFT(expirationDate,19),'T',' '),'-','')))FECHAVENCE
			 , IIF( CONVERT(DATETIME,replace(replace(LEFT(expirationDate,19),'T',' '),'-',''))> GETDATE() ,'SI','NO') VIGENTE
			 , T1.orderId
			 , T2.errorCode
			 , T2.errorMessage
			 , T2.detailedErrorMessage 
		FROM (
			SELECT * FROM OPENJSON(@response)WITH(
				paymentURL				VARCHAR(50)		'$.paymentURL',
				paymentOrderStatus		VARCHAR(30)		'$.paymentOrderStatus',
				expirationDate			VARCHAR(30)		'$.expirationDate',
				orderId					INT				'$.orderId'
			)
		)T1 
		 LEFT JOIN (
			SELECT  * FROM OPENJSON(@ANSWER)WITH(
				errorCode				VARCHAR(30)		'$.errorCode',
				errorMessage			VARCHAR(100)	'$.errorMessage',
				detailedErrorMessage	VARCHAR(200)	'$.detailedErrorMessage',
				orderId					INT				'$.orderId'
			)
		)T2 ON 1=1

	END
	--5 Grupos por IDKPAGE
	BEGIN
		IF @IDKPAGE IS NOT NULL
			BEGIN
				SELECT CIT.IDKPAGE, AFI.DOCIDAFILIADO, AFI.NOMBREAFI, CIT.FECHA, HTX.IDSERVICIO, SER.DESCSERVICIO FROM CIT 
				INNER JOIN  AFI ON CIT.IDAFILIADO = AFI.IDAFILIADO
				INNER JOIN  HTX ON CIT.CONSECUTIVO = HTX.CONSECUTIVO_CIT
				INNER JOIN  SER ON SER.IDSERVICIO = HTX.IDSERVICIO
				WHERE  CIT.IDKPAGE = @IDKPAGE AND IDKPAGE <> 0
			END
		ELSE
			BEGIN
				SELECT 'KO'KPAGE
			END
	END
	--SELECT * FROM KPAGE WHERE IDKPAGE ='155758'
	RETURN
   END
   IF @METODO = 'RECETA'
   BEGIN
		SELECT @CONSECUTIVOHCA = CONSECUTIVOHCA FROM OPENJSON(@PARAMETROS) WITH (CONSECUTIVOHCA VARCHAR(16) '$.CONSECUTIVOHCA')
		SELECT @NOADMISION = NOADMISION FROM HCA WHERE CONSECUTIVO = @CONSECUTIVOHCA

		BEGIN
			SELECT HADM.NOADMISION, AFI.TIPO_DOC, AFI.DOCIDAFILIADO, AFI.SEXO, AFI.FNACIMIENTO, AFI.DIRECCION,
					AFI.ZONA, CIU.NOMBRE CIUDAD,TGEN1.DESCRIPCION CORREGIMIENTO, OCU.DESCRIPCION OCUPACION,
					TER.RAZONSOCIAL CONTRATANTE, HADM.IDPLAN, PLN.TIPOSISTEMA REGIMEN, AFI.TELEFONORES,AFI.CIUDAD,
					CASE AFI.TIPOAFILIADO WHEN 'B' THEN 'Beneficiario' WHEN 'C' THEN 'Cotizante' END [TIPOVINCULACION],
					HADM.NOAUTORIZACION, HADM.FECHA, HHAB.DESCRIPCION UBICACION, VIAING.DESCRIPCION AS VIAINGRESO, CAUEX.DESCRIPCION AS CAUSAEXTERNA, MED.NOMBRE  [MEDICOINGRESO],
					MEDT.NOMBRE  [MEDICOTRATANTE], HADM.DXINGRESO, MDX.DESCRIPCION [DIAGNOSTICO],
					HADM.NOMBRERESPO, HADM.PARENTESCORESPO, HADM.TELEFONORESPO,
					HADM.URG_VINCULO, HADM.URG_NOMBRE, HADM.URG_DIR, HADM.URG_TELE,
					HADM.FECHAALTA, TELEFONO=DBO.FNK_PrimerMovilTercero(AFI.IDAFILIADO), AFI.EDAD
					,floor((cast(convert(varchar(8),DBO.FNK_FECHA_SIN_MLS(DBO.FNK_getdate()),112) as int)-cast(convert(varchar(8),AFI.FNACIMIENTO,112) as int) ) / 10000) as EDAD_LIMPIA
					,AFI.NOMBREAFI
					, STUFF((SELECT DISTINCT ', '+DX FROM DBO.VWK_HCA_DX WHERE NOADMISION=HADM.NOADMISION FOR XML PATH('')),1,1,'') DIAGNOSTICOS
					, PLN.DESCPLAN
					, AFI.IDAFILIADO
			FROM   HADM INNER JOIN AFI      ON HADM.IDAFILIADO = AFI.IDAFILIADO
						LEFT JOIN CIU      ON AFI.CIUDAD      = CIU.CIUDAD
						LEFT JOIN (SELECT CODIGO, DESCRIPCION FROM TGEN WHERE TABLA = 'CORREGIMIENTOS')TGEN1
											ON TGEN1.CODIGO  = AFI.CORREGIMIENTO
						LEFT JOIN (SELECT CODIGO, DESCRIPCION FROM TGEN WHERE TABLA ='General' AND CAMPO = 'CAUSAEXTERNA')CAUEX
											ON CAUEX.CODIGO = HADM.CAUSAEXTERNA
						LEFT JOIN (SELECT CODIGO, DESCRIPCION FROM TGEN WHERE TABLA ='General' AND CAMPO = 'VIADEINGRESO')VIAING
											ON VIAING.CODIGO = HADM.VIAINGRESO
						LEFT JOIN OCU      ON AFI.IDOCUPACION = OCU.OCUPACION
						LEFT JOIN HHAB     ON HADM.HABCAMA   = HHAB.HABCAMA
						LEFT JOIN TER      ON  HADM.IDTERCERO = TER.IDTERCERO
						LEFT JOIN PLN      ON  HADM.IDPLAN    = PLN.IDPLAN
						LEFT JOIN MED      ON HADM.IDMEDICOING = MED.IDMEDICO
						LEFT JOIN MED MEDT ON HADM.IDMEDICOING = MED.IDMEDICO
						LEFT JOIN MDX      ON HADM.DXINGRESO   = MDX.IDDX
                   
			WHERE  HADM.NOADMISION = @NOADMISION
		END--Datos de la admisión
		BEGIN -- 1.- Datos de la Historia Clínica
			DECLARE @ASI_UTILIZAFIRMA_HC VARCHAR(2)=DBO.FNK_VALORVARIABLE('ASI_UTILIZAFIRMA_HC')
			DECLARE @_CNSFUAT VARCHAR(7), @_CNSFAT VARCHAR(7)
			SELECT HCA.CONSECUTIVO
            	,HCA.FECHA
				,HCA.IDAFILIADO
				,HCA.IDMEDICO
				,HCA.TIPODX
				,HCA.IDDX
				,MDX.DESCRIPCION DXPRINCIPAL
				,HCA.DX1
				,DX1.DESCRIPCION DIAG1
				,HCA.DX2
				,DX2.DESCRIPCION DIAG2
				,HCA.DX3
				,DX3.DESCRIPCION DIAG3
				,HCA.DX4
				,DX4.DESCRIPCION DIAG4
				,UTILIZAFIRMA = CASE WHEN @ASI_UTILIZAFIRMA_HC <> 'SI' THEN 0 ELSE 1 END 
				,NOMBREMEDICODIL = CASE WHEN @ASI_UTILIZAFIRMA_HC <> 'SI' THEN '' ELSE MED.NOMBRE END 
				,CMPMEDICODIL = CASE WHEN @ASI_UTILIZAFIRMA_HC <> 'SI' THEN '' ELSE MED.NO_REGISTRO END
				,ESPECIALIDADMEDDIL = CASE WHEN @ASI_UTILIZAFIRMA_HC <> 'SI' THEN '' ELSE MES.DESCRIPCION END
				,RMMEDICODIL = MED.BEEPER
				,FIRMA = CASE WHEN @ASI_UTILIZAFIRMA_HC <> 'SI' THEN NULL ELSE (SELECT DICOM FROM ARCHIVOS WHERE ID = MED.IDFIRMA) END
				,HCA.CLASEPLANTILLA,MPL.DESCPLANTILLA
				,TER.RAZONSOCIAL CONTRATANTE
				,HADM.IDPLAN
				,PLN.DESCPLAN
				,HADM.NOAUTORIZACION
				,HCA.NOADMISION
				,FECHAINGRESO = CONVERT(VARCHAR,HADM.FECHA,103)
				,VIADEINGRESO.DESCRIPCION VIAINGRESO
				,CAUSAEXTERNA.DESCRIPCION CAUSAEXTERNA
				,FECHAALTA = CONVERT(VARCHAR,HADM.FECHAALTA,103)+' '+CONVERT(VARCHAR,HADM.FECHAALTA,108)
				,MEDT.NOMBRE  [MEDICOTRATANTE]
				, MEDING.NOMBRE MEDICOINGRESA
				, IDXINGRESO = (SELECT TOP 1 DX FROM VWK_DX WHERE NOADMISION=HADM.NOADMISION ORDER BY FECHA,TIPO)
				,DXINGRESO = (SELECT TOP 1 DESCRIPCION FROM VWK_DX WHERE NOADMISION=HADM.NOADMISION ORDER BY FECHA,TIPO) 
				,HADM.URG_NOMBRE
				,HADM.URG_VINCULO
				,HADM.URG_TELE
				,HADM.URG_DIR
				,HADM.NOMBRERESPO
				,HADM.PARENTESCORESPO
				,HADM.TELEFONORESPO
				,IMPRIMEOM=COALESCE(MPL.IMPRIMEOM,0)
				,RNE = MED.BEEPER
				,(SELECT TOP 1 DESCRIPCION FROM TGEN WHERE TABLA='MED' AND CAMPO='CLASE_REGISTRO' AND CODIGO=MED.CLASE_REGISTRO) CLASE_REGISTRO_MEDICO
				,COALESCE(HCA.IDPLAN,CIT.IDPLAN) IDPLAN_CIT
				,PLN2.DESCPLAN DESCPLAN_CIT
				, RIGHT('0000000'+CAST( IIF(HCA.CLASEPLANTILLA = 'FUAT', (SELECT COUNT(1)+1 FROM HCA AS X WHERE COALESCE(ANULADA,0)=0
																		AND X.CLASEPLANTILLA = 'FUAT' AND X.FECHA < HCA.FECHA)
																		, 0)AS VARCHAR), 7)CONSECUTIVOFUAT 
				, RIGHT('0000000'+CAST( IIF(HCA.CLASEPLANTILLA = 'FAT', (SELECT COUNT(1)+1 FROM HCA AS X WHERE COALESCE(ANULADA,0)=0
																		AND X.CLASEPLANTILLA = 'FAT' AND X.FECHA < HCA.FECHA)
																		, 0)AS VARCHAR), 7)CONSECUTIVOFAT
			,HCA.CHECK1,HCA.CHECK2,HCA.CHECK3
			,SER.DESCSERVICIO
			FROM HCA
			INNER JOIN MED ON HCA.IDMEDICO = MED.IDMEDICO
			LEFT JOIN HADM ON HADM.NOADMISION = HCA.NOADMISION
			LEFT JOIN MED MEDT ON HADM.IDMEDICOING = MED.IDMEDICO
			LEFT JOIN MED MEDING ON MEDING.IDMEDICO = HADM.IDMEDICOING
			LEFT JOIN TER ON TER.IDTERCERO = HADM.IDTERCERO
			LEFT JOIN MPL ON MPL.CLASEPLANTILLA=HCA.CLASEPLANTILLA
			LEFT JOIN PLN ON PLN.IDPLAN=HADM.IDPLAN
			LEFT JOIN MES ON MED.IDEMEDICA = MES.IDEMEDICA
			LEFT JOIN MDX ON HCA.IDDX = MDX.IDDX
			LEFT JOIN MDX DX1 ON HCA.DX1 = DX1.IDDX
			LEFT JOIN MDX DX2 ON HCA.DX2 = DX2.IDDX
			LEFT JOIN MDX DX3 ON HCA.DX3 = DX3.IDDX
			LEFT JOIN MDX DX4 ON HCA.DX4 = DX4.IDDX
			LEFT JOIN TGEN VIADEINGRESO ON VIADEINGRESO.TABLA='General' AND VIADEINGRESO.CAMPO='VIADEINGRESO' AND VIADEINGRESO.CODIGO = HADM.VIAINGRESO
			LEFT JOIN TGEN CAUSAEXTERNA ON CAUSAEXTERNA.TABLA='General' AND CAUSAEXTERNA.CAMPO='CAUSAEXTERNA' AND CAUSAEXTERNA.CODIGO = HADM.CAUSAEXTERNA
			LEFT JOIN CIT ON CIT.CONSECUTIVO=HCA.CONSECUTIVOCIT
			LEFT JOIN PLN PLN2 ON PLN2.IDPLAN=COALESCE(HCA.IDPLAN,CIT.IDPLAN,HADM.IDPLAN)
			LEFT JOIN SER ON SER.IDSERVICIO=CIT.IDSERVICIO
			WHERE HCA.CONSECUTIVO = @CONSECUTIVOHCA
		END
		BEGIN -- 5.- Ordenes médicas HCATD
			DECLARE @CODIGO_MED VARCHAR(20) = DBO.FNK_VALORVARIABLE('OMCODMEDICAMENTOS')
			SELECT HCATD.CONSECUTIVO 
				,HCATD.ITEMRED
				,HCATD.CODOM ,HCCOM.DESCRIPCION ,HCATD.IDSERVICIO ,SER.DESCSERVICIO ,HCATD.CANTIDAD
				,HCATD.CLASE ,HCATD.FRECUENCIA ,HCATD.DURACION ,HCATD.OBSERVACION ,HCATD.PRIMER
				,CASE WHEN @CODIGO_MED=HCATD.CODOM THEN 1 ELSE CASE WHEN SER.MEDICAMENTOS>0 THEN 1 ELSE 0 END END MEDICAMENTO
				,SER.EQUICC ,SER.PRESUNI ,HCATD.IDTIPOCONC
				,CASE WHEN HCATD.DURACION>24 THEN 'D' ELSE 'H' END TIPODURACION
				,HCATD.VIA ,HCATD.QAM CANTIDADAM ,HCATD.QPM CANTIDADPM
				,HCATD.HORAAM ,HCATD.HORAPM ,HCATD.RAZONNEC
			FROM HCATD
			INNER JOIN SER ON HCATD.IDSERVICIO = SER.IDSERVICIO
			LEFT JOIN HCCOM ON HCATD.CODOM = HCCOM.CODOM
			WHERE HCATD.CONSECUTIVO = @CONSECUTIVOHCA
			ORDER BY HCATD.CODOM
				,HCATD.PRIMER
		END
	RETURN
   END
   IF @METODO = 'CONSE_INF'
   BEGIN
		SELECT @CONSECUTIVO = CONSECUTIVO, @IDAFILIADO = IDAFILIADO 
		FROM OPENJSON(@PARAMETROS) WITH (CONSECUTIVO VARCHAR(20) '$.CONSECUTIVO', IDAFILIADO VARCHAR(20) '$.IDAFILIADO')

		IF EXISTS( SELECT * FROM DOCS WHERE DocTipo = 'CONSE_INF_LAB' AND DocCnsAuxiliar = @IDAFILIADO AND DocConsecutivo = @CONSECUTIVO )
		BEGIN
			SELECT DocFS FIRMA FROM DOCS WHERE DocTipo = 'CONSE_INF_LAB' AND DocCnsAuxiliar = @IDAFILIADO AND DocConsecutivo = @CONSECUTIVO ORDER BY DocFechaRegistro DESC
			SELECT CODIGO, DESCRIPCION, DATO1, CHECK1, CHECK2, CHECK3 FROM TGEN WHERE TABLA = 'LABORATORIO' AND CAMPO ='CONS_INF' AND DATO1 = @CONSECUTIVO AND DESCRIPCION = @IDAFILIADO
		END
		ELSE
		BEGIN
			SELECT 'KO'FIRMA
		END
	 RETURN
   END
   IF @METODO = 'CONSULTADIAS'
	BEGIN
		SELECT CONVERT(VARCHAR,FECHA,111) DIA
			FROM CIT 
			INNER JOIN MED ON MED.IDMEDICO = CIT.IDMEDICO
			WHERE --IDMEDICO = '10609419' AND 
			MED.TIPO_USUARIO IN('Ovalo','Carpa') and
			CIT.IDSEDE = '02' AND 
			FECHA > GETDATE()
			GROUP BY CIT.IDMEDICO,CONVERT(VARCHAR,FECHA,111)
	 RETURN
	END
   IF @METODO = 'REAGENDAR'
   BEGIN
	SELECT @CONSECUTIVO = NEWCONSECUTIVO, @CONSECUTIVOTEMP = OLDCONSECUTIVO, @IDCAUSAL = IDCAUSAL, @OBSERVACION = OBSCAUSAL
	FROM OPENJSON(@PARAMETROS) WITH( NEWCONSECUTIVO VARCHAR(13) '$.NEWCONSECUTIVO',
									 OLDCONSECUTIVO VARCHAR(13) '$.OLDCONSECUTIVO',
									 IDCAUSAL		VARCHAR(5)	'$.IDCAUSAL',
									 OBSCAUSAL		VARCHAR(500)'$.OBSCAUSAL'
									 )
	IF EXISTS(SELECT 1 FROM CIT WHERE CONSECUTIVO = @CONSECUTIVOTEMP AND COALESCE(FECHAATENCION,'')<>'')
	BEGIN
		INSERT INTO @ERRORES(CONTINUA, ERROR)
		SELECT 'NO', 'Esta cita ya fue atendida, no puede reagendar.'
	END
	ELSE
	BEGIN
		-- Asignar nueva cita
		SELECT @IDAFILIADO = IDAFILIADO, @IDSERVICIO = IDSERVICIO, @IDPLAN = IDPLAN, @IDTERCERO = IDTERCEROCA,
			   @IDTERCEROPARTICULAR = IDCONTRATANTE, @NOADMISION = NOADMISION,
			   @COMERCIAL = COMERCIAL, @IDSEDE = IDSEDE
		FROM CIT 
		WHERE CONSECUTIVO = @CONSECUTIVOTEMP

		UPDATE CIT SET 
			IDAFILIADO=@IDAFILIADO, IDSERVICIO=@IDSERVICIO, IDPLAN=@IDPLAN, IDTERCEROCA=@IDTERCEROPARTICULAR,
			IDCONTRATANTE=@IDTERCEROPARTICULAR, NOADMISION=@NOADMISION, FECHASOL=CONVERT(SMALLDATETIME,GETDATE()), IDEMEDICA='550', WEB=0,
			TIPOCOPAGO='N', CLASECONTRATO='E', AQUIENCOBRO='N', COVID=0, USUARIO = @USUARIO, IDKPAGE = @IDKPAGE, COMERCIAL = @COMERCIAL
		WHERE CONSECUTIVO=@CONSECUTIVO
		-- Cancelar cita anterior
		EXEC SPKD_ASIGNACITA @IDAFILIADO, @CONSECUTIVOTEMP, @IDSERVICIO, NULL, @USUARIO, '01', 20, 0, NULL, @IDCAUSAL, @OBSERVACION

		IF EXISTS(SELECT 1 FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO AND IDAFILIADO = @IDAFILIADO)
		BEGIN
			INSERT INTO @ERRORES(CONTINUA, ERROR)
			SELECT 'SI', 'Reagendado correctamente!'
		END
	END
	IF EXISTS(SELECT 1 FROM @ERRORES WHERE CONTINUA = 'NO')
	BEGIN SELECT 'KO'PROCESO END
	ELSE
	BEGIN SELECT 'OK'PROCESO END

	SELECT CONTINUA, ERROR FROM @ERRORES 
	RETURN
   END
   IF @METODO = 'GETHTX'
   BEGIN
		SELECT @CONSECUTIVO = CONSECUTIVO FROM OPENJSON(@PARAMETROS)WITH( CONSECUTIVO VARCHAR(13) '$.CONSECUTIVO' )
		SELECT @NOADMISION = NOADMISION FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO
		SELECT @CONT1 = COUNT(*) FROM CIT INNER JOIN KPAGE ON CIT.IDKPAGE = KPAGE.IDKPAGE WHERE CIT.CONSECUTIVO = @CONSECUTIVO AND KPAGE.PROCEDENCIA = 'AFI_APP'

		IF NOT EXISTS(SELECT * FROM HTX WHERE CONSECUTIVO_CIT = @CONSECUTIVO AND HTX.NOADMISION = @NOADMISION) AND @CONT1 > 0
		BEGIN
			SELECT @STRING = '{"MODELO":"AGENDALXDOMI","METODO":"CREAHTXHPRED","PARAMETROS":{"CONSECUTIVO":"'+ @CONSECUTIVO + '"} ,"USUARIO":"'+ @USUARIO + '"}'
			PRINT @STRING
			EXEC SPQ_JSON @STRING
		END

		DECLARE @TEMP TABLE (ITEM INT IDENTITY, CONSECUTIVO VARCHAR(13), NOPRESTACION VARCHAR(16), NOADMISION VARCHAR(16))

		INSERT INTO @TEMP(CONSECUTIVO, NOPRESTACION, NOADMISION)
		SELECT CIT.CONSECUTIVO, HTX.NOPRESTACION, HTX.NOADMISION
		FROM HTX 
		INNER JOIN CIT ON HTX.CONSECUTIVO_CIT = CIT.CONSECUTIVO
		INNER JOIN  SER ON HTX.IDSERVICIO = SER.IDSERVICIO				
		WHERE   HTX.IDSERVICIO <> 'EXA9998'
				AND COALESCE(HTX.CNSCONTENEDOR,'') = ''
				AND htx.CONSECUTIVO_CIT = @CONSECUTIVO
		GROUP BY CIT.CONSECUTIVO, HTX.CNSCONTENEDOR, HTX.NOPRESTACION, HTX.NOADMISION
		
		SELECT @I = 1
		SELECT @I_TO = (SELECT COUNT(1) FROM @TEMP)
--query2
		WHILE @I <= @I_TO
		BEGIN
			SELECT @CONSECUTIVO  = CONSECUTIVO, 
			       @NOPRESTACION = NOPRESTACION, 
				   @NOADMISION   = NOADMISION 
			FROM   @TEMP WHERE ITEM = @I

			EXEC SPK_ASIGNAR_CONTENEDOR @NOPRESTACION, @NOADMISION, '01'

		    SELECT @I = @I + 1
		END
		
		SELECT HTX.CNSCONTENEDOR
			 , HTX.CONTENEDOR, TGEN.DESCRIPCION
		FROM HTX 
		LEFT JOIN TGEN ON HTX.CONTENEDOR = TGEN.CODIGO AND TGEN.TABLA = 'LABORATORIO'
		WHERE CONSECUTIVO_CIT = @CONSECUTIVO AND COALESCE(HTX.CNSCONTENEDOR,'')<>''
		GROUP BY HTX.CNSCONTENEDOR , HTX.CNSCONTENEDOR, HTX.CONTENEDOR, TGEN.DESCRIPCION

		SELECT   HTX.CNSHTX, HTX.IDSERVICIO, HTX.CONSECUTIVO_CIT, HTX.CNSCONTENEDOR
				,HTX.CONTENEDOR
				,SER.DESCSERVICIO
				,HTX.NOPRESTACION
		FROM   HTX 
		INNER JOIN SER ON HTX.IDSERVICIO = SER.IDSERVICIO
		LEFT JOIN TGEN ON SER.EQUIPOMUES = TGEN.CODIGO AND TGEN.TABLA = 'LABORATORIO'
		WHERE  CONSECUTIVO_CIT = @CONSECUTIVO AND COALESCE(HTX.CNSCONTENEDOR,'')<>''
		ORDER BY SER.DESCSERVICIO

		SELECT CIT.USUATENCION, CIT.CONSECUTIVO, CIT.IDAFILIADO, CIT.FECHA FECHA_2, CONVERT(DATE,CIT.FECHA) FECHA
			, HTX.CNSCONTENEDOR, HTX.DESC_EQUIPOMUES
			, AFI.NOMBREAFI, AFI.DOCIDAFILIADO, AFI.TIPO_DOC
			, CASE WHEN AFI.SEXO = 'Masculino' then 'M' WHEN AFI.SEXO ='Femenino' then 'F' ELSE 'Pen' END AS SEXO
			,CAST( LEFT( AFI.EDAD , 2 ) +' a?s'  AS varchar ) EDAD ,GETDATE() FECHA_ACTUAL,
			SER.MPRINCIPAL,
				STUFF(( SELECT ', ' + SER.INICIALES FROM HTX X LEFT JOIN SER ON X.IDSERVICIO = SER.IDSERVICIO
											        WHERE X.CNSCONTENEDOR = HTX.CNSCONTENEDOR AND X.CONSECUTIVO_CIT = HTX.CONSECUTIVO_CIT
				FOR XML PATH('')),1,2,'') as INICIALES
		FROM HTX 
		INNER JOIN CIT ON HTX.CONSECUTIVO_CIT = CIT.CONSECUTIVO
		INNER JOIN AFI ON CIT.IDAFILIADO  = AFI.IDAFILIADO
		LEFT JOIN SER ON HTX.IDSERVICIO = SER.IDSERVICIO				
		WHERE CIT.CONSECUTIVO = @CONSECUTIVO  AND COALESCE(HTX.CNSCONTENEDOR,'')<>''
		GROUP BY  CIT.USUATENCION, CIT.CONSECUTIVO, CIT.IDAFILIADO, CIT.FECHA, CONVERT(DATE,CIT.FECHA)
			, HTX.CNSCONTENEDOR, HTX.DESC_EQUIPOMUES
			, AFI.NOMBREAFI, AFI.DOCIDAFILIADO, AFI.TIPO_DOC, AFI.SEXO, AFI.EDAD,HTX.CNSCONTENEDOR,SER.MPRINCIPAL, HTX.CONSECUTIVO_CIT
	RETURN
   END
   IF @METODO = 'ENVIAR_REPROGRAMAR'
   BEGIN
			SELECT @CONSECUTIVO = CONSECUTIVO FROM OPENJSON(@PARAMETROS)WITH( CONSECUTIVO VARCHAR(13) '$.CONSECUTIVO' )
			DECLARE @CNSCONTENEDORES		VARCHAR(16)
		--SELECT @CNSCONTENEDORES = (SELECT CNSCONTENEDOR FROM HTX WHERE CONSECUTIVO_CIT = @CONSECUTIVO AND CODOM IN ('005', '006') AND IDSERVICIO NOT IN ('EXA9998') )
			SELECT @OBSERVACION = '-REPROGRAMADO DESDE EL OVALO-'
			SELECT @SERVICIOS = STUFF((SELECT DISTINCT ', '+CONCAT(' ',SER.DESCSERVICIO)+ ' '
			 FROM CIT C
			 INNER JOIN HTX ON CIT.CONSECUTIVO =  HTX.CONSECUTIVO_CIT AND HTX.CODOM IN ('005', '006')
			 INNER JOIN SER ON HTX.IDSERVICIO = SER.IDSERVICIO
			  FOR XML PATH('')),1,1,'') FROM CIT WHERE  CIT.CONSECUTIVO = @CONSECUTIVO

			  INSERT INTO HTXEVEN(CNSHTX,EVENTO,USUARIO,CAUSANOTOMA,OBSERVACION)
			SELECT HTX.CNSHTX,'08',@USUARIO,'003',@OBSERVACION
			FROM HTX 
			INNER JOIN CIT ON HTX.CONSECUTIVO_CIT = CIT.CONSECUTIVO AND HTX.NOADMISION =  CIT.NOADMISION 
			WHERE  HTX.CODOM IN ('005','006') AND.HTX.IDSERVICIO NOT IN ( 'EXA9998') AND HTX.CONSECUTIVO_CIT = @CONSECUTIVO 

			UPDATE HTX SET OBSERVACIONES   = @OBSERVACION
						 , CONSECUTIVO_CIT = ''
						 , FECHAREPROGRAMA = CONVERT(smalldatetime, GETDATE())
						 , REPROGRAMADO    = 1        
						 , HTX.ESTADOTOMA  = 3        --0 null. Pendiente | 1. Tomada | 2. ? | 3. No tomada
 						 , USUREPROGRAMA   = @USUARIO 
						 , CAUSANOTOMA     = '003'
			FROM  HTX 
			INNER JOIN CIT ON HTX.CONSECUTIVO_CIT = CIT.CONSECUTIVO AND HTX.NOADMISION =  CIT.NOADMISION 
			WHERE  HTX.CODOM IN ('005','006') AND.HTX.IDSERVICIO NOT IN ( 'EXA9998') AND HTX.CONSECUTIVO_CIT = @CONSECUTIVO 

			UPDATE CIT SET IDAFILIADO =  NULL WHERE  CONSECUTIVO = @CONSECUTIVO
			-- CREA NOTA ADMINISTRATIVA:
			SELECT @NOADMISION = NOADMISION, @IDAFILIADO = IDAFILIADO FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO
			PRINT 'OBSERBASION: 1 ' + @OBSERVACION
			SELECT @DESCCAUSAL = DESCCAUSAL FROM CAU WHERE IDCAUSAL = '003'
			SELECT @NOTALARGA = CONCAT('No pudo realizar la toma de muestra: ',@SERVICIOS ,'. ',@DESCCAUSAL,': ', @OBSERVACION,'. Fecha: ', convert(smalldatetime,getdate()))
			SELECT @OBSERVACION = @NOTALARGA
			EXEC DBO.SPK_GENERA_NOTA_ADM @NOADMISION=@NOADMISION, @USUARIO=@USUARIO
			,@OPCION = 3 --3. REPROGRAMACION DE CITA
			,@OBSERVACION = @OBSERVACION

			IF EXISTS (SELECT 1 FROM CIT WHERE CONSECUTIVO=@CONSECUTIVO)
			BEGIN
				SELECT 'OK'RESULTADO
			END
			ELSE
			BEGIN
				SELECT 'KO'RESULTADO
			END

	RETURN
   END
   IF @METODO = 'CONFIRMARENTRADA'
	BEGIN
	DECLARE @R1 SMALLINT, @R2 SMALLINT, @R3 SMALLINT
        SELECT @CONSECUTIVO = CONSECUTIVO, @IDFIRMA = IDFIRMA, @IDAFILIADO= IDAFILIADO, @R1= R1, @R2 = R2, @R3= R3, @IDMEDICO = IDMEDICO
		FROM OPENJSON (@PARAMETROS)   
        WITH ( CONSECUTIVO	VARCHAR(13)		'$.CONSECUTIVO', 
			   IDFIRMA		VARCHAR(36)		'$.IDFIRMA', 
			   IDAFILIADO	VARCHAR(20)		'$.IDAFILIADO',
			   IDMEDICO		VARCHAR(20)		'$.IDMEDICO',
			   R1			SMALLINT		'$.R1',
			   R2			SMALLINT		'$.R2',
			   R3			SMALLINT		'$.R3'
			  )
		BEGIN TRY
			SELECT @SEDE = '02'
			SELECT @CNSCONSE = ''
			EXEC SPK_GENCONSECUTIVO '01',@SEDE,'@CONSE_INF',@CNSCONSE OUTPUT
			SELECT @CNSCONSE = @SEDE + RIGHT('00000000'+CONVERT(VARCHAR(8),@CNSCONSE),8)
			PRINT '@@CNSCONSE: ' + @CNSCONSE

			SELECT @IDAFILIADO = IDAFILIADO FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO

			IF EXISTS( SELECT * FROM TGEN WHERE TABLA = 'LABORATORIO' AND CAMPO ='CONS_INF' AND DATO1 = @CONSECUTIVO AND DESCRIPCION = @IDAFILIADO )
			BEGIN
				DELETE TGEN WHERE TABLA = 'LABORATORIO' AND CAMPO ='CONS_INF' AND DATO1 = @CONSECUTIVO AND DESCRIPCION = @IDAFILIADO
			END

			INSERT INTO TGEN(TABLA, CAMPO, CODIGO, DESCRIPCION, DATO1, CHECK1, CHECK2, CHECK3)
			SELECT 'LABORATORIO','CONS_INF',@CNSCONSE,@IDAFILIADO, @CONSECUTIVO, @R1, @R2, @R3

			SELECT @FECHA = CONVERT(SMALLDATETIME,FECHA) FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO
			print @FECHA
			print @CONSECUTIVO
			print @IDMEDICO
			IF EXISTS(SELECT * FROM CIT WHERE IDMEDICO = @IDMEDICO AND CONVERT(SMALLDATETIME,FECHA) = @FECHA AND COALESCE(CIT.IDAFILIADO,'')='')
			BEGIN
				PRINT 'EXISTE Y ESTA VACIA SE BORRA LA OTRA  '+@IDMEDICO
				SELECT @CONSECUTIVOCAN = CONSECUTIVO FROM CIT WHERE IDMEDICO = @IDMEDICO AND CONVERT(SMALLDATETIME,FECHA) = @FECHA AND COALESCE(CIT.IDAFILIADO,'')=''
				DELETE CIT WHERE CONSECUTIVO = @CONSECUTIVOCAN
				PRINT 'ENTRA A ACTUALIZAR TODO'
				UPDATE CIT 
				SET FECHALLEGA = CONVERT(SMALLDATETIME,GETDATE())
					, USUARIOLLEGA = @USUARIO
					, CUMPLIDA     = 3
					, IDMEDICO     = @IDMEDICO
					, IMPRESO      = 1 
				WHERE CONSECUTIVO = @CONSECUTIVO
			END

			IF EXISTS(SELECT * FROM CIT WHERE IDMEDICO = @IDMEDICO AND CONVERT(SMALLDATETIME,FECHA) = @FECHA AND COALESCE(CIT.IDAFILIADO,'')<>@IDAFILIADO AND CONSECUTIVO <> @CONSECUTIVO)
			BEGIN
				PRINT 'EXISTE Y ESTA OCUPADA'
				SELECT @I = 1
				SELECT @USUNOTA = 'KO'
				WHILE @USUNOTA <> 'OK'
				BEGIN
					IF NOT EXISTS(SELECT * FROM CIT WHERE IDMEDICO = @IDMEDICO AND CONVERT(SMALLDATETIME,FECHA) = DATEADD(SECOND, 61*@I, @FECHA) )
					BEGIN
						UPDATE CIT 
						SET FECHA = DATEADD(SECOND, 15 + @I, @FECHA)
						WHERE CONSECUTIVO = @CONSECUTIVO

						UPDATE CIT 
						SET FECHALLEGA = CONVERT(SMALLDATETIME,GETDATE())
							, USUARIOLLEGA = @USUARIO
							, CUMPLIDA     = 3
							, IDMEDICO     = @IDMEDICO
							, IMPRESO      = 1 
						WHERE CONSECUTIVO = @CONSECUTIVO 
						SELECT @USUNOTA = 'OK'
					END
					SELECT @I = @I + 1
				END
			END
		
			IF  NOT EXISTS(SELECT * FROM CIT WHERE IDMEDICO = @IDMEDICO AND CONVERT(SMALLDATETIME,FECHA) = @FECHA AND COALESCE(CIT.IDAFILIADO,'')='')
			AND NOT EXISTS(SELECT * FROM CIT WHERE IDMEDICO = @IDMEDICO AND CONVERT(SMALLDATETIME,FECHA) = @FECHA AND COALESCE(CIT.IDAFILIADO,'')<>@IDAFILIADO AND CONSECUTIVO <> @CONSECUTIVO)
			BEGIN
				UPDATE CIT 
				SET FECHALLEGA	   = CONVERT(SMALLDATETIME,GETDATE())
					, USUARIOLLEGA = @USUARIO
					, CUMPLIDA     = 3
					, IDMEDICO     = @IDMEDICO
					, IMPRESO      = 1 
				WHERE CONSECUTIVO = @CONSECUTIVO 
			END
		END TRY
		BEGIN CATCH
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
			RETURN
		END 
		END CATCH

		IF (SELECT COUNT(*) FROM @TBLERRORES) < 1
		BEGIN
				SELECT 'OK' OK
			RETURN
		END  --0=pendiente, 1=cumplida, 2=incumplida, 3=en proceso
	 RETURN
	END
   IF @METODO = 'CONFIRMATOMA'
   BEGIN
		DECLARE @CONTENEDORES VARCHAR(500)
		SELECT @CONSECUTIVO = CONSECUTIVO, @CONTENEDORES = CONTENEDORES , @PAS = PAS, @PAD =  PAD, @PESO = PESO, @TALLA =  TALLA, @PERIMETRO = PERIMETRO, @IMC = IMC, @PAM = PAM, @FC = FC
      FROM OPENJSON(@PARAMETROS)WITH( CONSECUTIVO VARCHAR(12) '$.CONSECUTIVO'
                                 , CONTENEDORES VARCHAR(500) '$.CONTENEDORES' 
                                 , PAS VARCHAR(10) '$.PAS' 
                                 , PAD VARCHAR(10) '$.PAD'
                                 , PESO DECIMAL(18,2) '$.PESO'
                                 , TALLA VARCHAR(10) '$.TALLA'
                                 , PERIMETRO VARCHAR(10) '$.PERIMETRO'
                                 , IMC DECIMAL(18,2) '$.IMC'
                                 , PAM DECIMAL(18,2) '$.PAM'
                                 , FC DECIMAL(18,2) '$.FC'
                                 )
		BEGIN TRY
			UPDATE  HTX  SET  
					HTX.ESTADOTOMA  = 1 --0 null. Pendiente | 1. Tomada | 2. ? | 3. No tomada
				  , HTX.USUATENCION = @USUARIO
				  , HTX.FTOMA       = CONVERT(SMALLDATETIME, GETDATE())
				  , HTX.PA_ESTADO = 0
				  , HTX.TIPO = 'Ovalo'
			FROM HTX
			INNER JOIN ( SELECT value AS CONSECUTIVOS FROM STRING_SPLIT(@CONTENEDORES,',') )CNS 
						ON HTX.CNSCONTENEDOR = CNS.CONSECUTIVOS

			UPDATE CIT SET CUMPLIDA = 1, CIT.USUATENCION = @USUARIO, FECHAATENCION = CONVERT(SMALLDATETIME, GETDATE()) WHERE CONSECUTIVO = @CONSECUTIVO

			--CREA NOTA DE TOMA DE MUESTRA AC
				SELECT @IDEMEDICA=IDEMEDICA, @IDPLAN = COALESCE(@IDPLAN,IDPLAN),@NOADMISION = NOADMISION, @IDAFILIADO = IDAFILIADO FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO
				SELECT @IDMEDICO = IDMEDICO	,@SYS_COMPUTERNAME = COALESCE(SYS_COMPUTERNAME, @@SERVERNAME)	FROM USUSU 	WHERE USUARIO = @USUARIO
				SELECT @PREFIJO = 'NT'

					EXEC SPK_GENCONSECUTIVO '01','01',@PREFIJO,@CNSAUX OUTPUT
					SELECT @CNSAUX = CASE WHEN @PREFIJO <> '@HC' THEN RIGHT(@PREFIJO, 2) 
									ELSE '' END 
								+ '01' + REPLACE(SPACE(8 - LEN(@CNSAUX)) + LTRIM(RTRIM(@CNSAUX)), SPACE(1), 0)
            
				INSERT INTO HCA (CONSECUTIVO,ITEMRED,CLASEPLANTILLA,AMBITO,FECHA,NOADMISION,IDAFILIADO,TIPODX
					,IDDX,IDMEDICO,IDMEDICODILIGENCIA,PROCEDENCIA,ALTA,CLASE,IDAREA,CCOSTO,USUARIO
					,CONSECUTIVOCIT
					,IDPLAN,MED_ESPEC)
					SELECT @CNSAUX
						,@ITEMRED ITEMRED
						,'TOMUES'
						,'QX'
						,CONVERT(SMALLDATETIME, GETDATE())
						,@NOADMISION NOADMISION 
						,COALESCE(@IDAFILIADO,NULL) IDAFILIADO
						,NULL
						,NULL
						,@IDMEDICO IDMEDICO
						,@IDMEDICO IDMEDICODILIGENCIA
						,'QX' 
						, 0
						, 'NT'
						,'01'
						,'101'
						,@USUARIO USUARIO
						,@CONSECUTIVO CONSECUTIVO_CIT
						,@IDPLAN IDPLAN
						,COALESCE(@IDEMEDICA,null) IDEMEDICA

					INSERT INTO HCAD(CONSECUTIVO,CLASEPLANTILLA, CAMPO, SECUENCIA, TIPOCAMPO, ALFANUMERICO/*, FECHA, MEMO, NUMERICO)*/)
					SELECT @CNSAUX,'TOMUES', CAMPO, SECUENCIA, TIPO_CAMPO, DESCCAMPO FROM MPLD WHERE CLASEPLANTILLA = 'TOMUES' ORDER BY SECUENCIA

					INSERT INTO HCADL(CONSECUTIVO, SECUENCIA, ITEM, VALORLISTA, CHECKM, DESCRIPCION, SINCRONIZADO)
					SELECT @CNSAUX,12,0,VALORLISTA,0,'',0 FROM MPLDL WHERE CLASEPLANTILLA = 'TOMUES'	
					UPDATE HCAD SET FECHA = GETDATE() WHERE CONSECUTIVO = @CNSAUX AND CLASEPLANTILLA = 'TOMUES' AND CAMPO ='FECHA' AND SECUENCIA = 11
					
					SELECT	@SERVICIOS = STUFF(( SELECT ', ' + SER.DESCSERVICIO FROM HTX
						INNER JOIN SER ON HTX.IDSERVICIO = SER.IDSERVICIO
						INNER JOIN ( SELECT value AS CONSECUTIVOS FROM STRING_SPLIT(@CONTENEDORES,',') )CNS 
									ON HTX.CNSCONTENEDOR = CNS.CONSECUTIVOS
					FOR XML PATH('')),1,2,'') 
					SELECT @OBSERVACION ='Se realizo la toma de: '
					SELECT @OBSERVACION+=CONCAT('(',@SERVICIOS,')')
					SELECT @OBSERVACION+=', se realiza explicaci? de protocolo de toma de muestra, se realiza firma de consentimiento informado y explicaci? de procedimiento, se toma muestra  '
					SELECT @OBSERVACION+=  'sin complicaciones no se presenta ning? evento adverso derivado a la prestaci? del servicio, se cumple con protocolo, se explica tiempo de reporte de resultado, se informa de pagina www.expertta.com.pe para la descarga del resultado. 
					Se informan signos de alarma y numero de contacto con expertta salud 6803040. Queda paciente en domicilio en buen estado.'

					UPDATE HCAD 
					SET ALFANUMERICO = '03. OTRAS PRUEBAS', NUMERICO = 3 WHERE CONSECUTIVO = @CNSAUX  AND  CLASEPLANTILLA = 'TOMUES'
					AND CAMPO = 'PRUEBA' AND  SECUENCIA      = 12

					UPDATE HCADL SET CHECKM = 1 WHERE CONSECUTIVO = @CNSAUX AND SECUENCIA = 12 AND VALORLISTA = '03. OTRAS PRUEBAS'
					UPDATE HCAD 
					   SET MEMO			  = @OBSERVACION 
						WHERE CONSECUTIVO    = @CNSAUX 
					   AND CLASEPLANTILLA = 'TOMUES' 
					   AND CAMPO          = '020' 
					   AND SECUENCIA      = 20
				--FIN CREACION DE TOMA DE MUESTRA AC

			DECLARE @CANTIDAD INT = 0
			DECLARE @IDENTITY INT

			SELECT @CANTIDAD = COUNT(*)
			FROM HTX 
			INNER JOIN SER ON HTX.IDSERVICIO = SER.IDSERVICIO
			INNER JOIN ( SELECT VALUE as CONSECUTIVOS FROM STRING_SPLIT(@CONTENEDORES,','))CNS
						 ON HTX.CNSCONTENEDOR = CNS.CONSECUTIVOS
			WHERE SER.CLASIF1 = 'P_AUTOMATICO' --PROCESO EN PREANALITICA AUTOM?ICO
			IF @CANTIDAD > 0
			BEGIN
				SELECT @IDTERCERO = '20602059261'
								
				UPDATE HTX SET  PA_USURECIBE = @USUARIO,
								PA_FLLEGA    = CONVERT(SMALLDATETIME,GETDATE()),
								PA_RECIBIDO  = 1, --1 RECIBIDO EN PREANALITICA
								PA_ESTADO    = 4,	 -- | 0 Sin Recibir | 1. Recibido | 2. Rechazada | 3. Por Enviar |4. Enviada | 5. En Laboratorio |
								P_TEMPING	= null,
								HTX.PA_USUPROCESA = 'UAUTOMA',
								HTX.PA_FPROCESA   = GETDATE(),
								HTX.RESULTADO = 'PENDIENTE'
				FROM HTX 
				INNER JOIN ( SELECT VALUE as CONSECUTIVOS FROM STRING_SPLIT(@CONTENEDORES,','))CNS
							ON HTX.CNSCONTENEDOR = CNS.CONSECUTIVOS
		
				--inserta en HTXEVENT
				INSERT INTO HTXEVEN( FECHA, CNSHTX, EVENTO, USUARIO, CNSCONTENEDOR )
				SELECT GETDATE(),CNSHTX,'14', @USUARIO, CNSCONTENEDOR
				FROM HTX 
				INNER JOIN ( SELECT VALUE as CONSECUTIVOS FROM STRING_SPLIT(@CONTENEDORES,','))CNS
							ON HTX.CNSCONTENEDOR = CNS.CONSECUTIVOS

				--Se genera el envio 
				INSERT INTO LMUES(USUARIOCREA,FECHACREA,ESTADO,IDTERCERO,OBSERVACION,NOADMISION,USUARIORECIBE,USUARIOENTREGA)
				SELECT @USUARIO,GETDATE(),0,@IDTERCERO,'Generado autim?icamente por ser servicio marcado.','0000000000','',''
				SELECT @IDENTITY = @@IDENTITY

				--se inserta el detalle del env?
				INSERT INTO LMUESD(MUESTRAID, IDMUESTRA, CNSCONTENEDOR, EQUIPO,TEMPERATURA, OBSERVACION )
				SELECT @IDENTITY, CONTENEDOR, CNSCONTENEDOR, '','',DESC_EQUIPOMUES FROM HTX INNER JOIN (
				SELECT VALUE as CONSECUTIVOS FROM STRING_SPLIT(@CONTENEDORES,','))CNS
								  ON HTX.CNSCONTENEDOR = CNS.CONSECUTIVOS
				WHERE 
					--PA_ESTADO = 1 AND 
					COALESCE(HTX.CONSECUTIVO_CIT,'')<>''
				GROUP BY CNSCONTENEDOR, CONTENEDOR, DESC_EQUIPOMUES

				--Entrega envio a motorizado (autom?ico)
				UPDATE LMUES SET USUARIOENTREGA = @USUARIO,
						     FECHADEENTREGA = GETDATE(),
						     USUARIOLLEVA   = 'UAUTOMA',
						     ESTADO		    = 1, -- 0: Creado |  1: Enviado |  2: Recibido lab |  3: Rechazado
							 P_TEMPSAL		= null
				WHERE MUESTRAID = @IDENTITY

			END

      create table #SIGNOSV(
         ITEM               INT IDENTITY,
         CLASEPLANTILLA     VARCHAR(8) ,
         ORDENSV		      INT			,
         CODIGOSV		      VARCHAR(15),
         UNIDAD			      VARCHAR(8) ,
         CLASESV		      VARCHAR(20),
         DATO			      VARCHAR(20)
      );

      INSERT INTO #SIGNOSV ( CODIGOSV, CLASESV, UNIDAD, DATO) SELECT  '1. PAS', 'Signo Vital', 'mm/hg', @PAS
      INSERT INTO #SIGNOSV ( CODIGOSV, CLASESV, UNIDAD, DATO) SELECT  '2. PAD', 'Signo Vital', 'mm/hg', @PAD
      INSERT INTO #SIGNOSV ( CODIGOSV, CLASESV, UNIDAD, DATO) SELECT  '3. PAM', 'Signo Vital', 'mm/hg', @PAM
      INSERT INTO #SIGNOSV ( CODIGOSV, CLASESV, UNIDAD, DATO) SELECT  'PESO', 'Signo Vital', 'kg', @PESO
      INSERT INTO #SIGNOSV ( CODIGOSV, CLASESV, UNIDAD, DATO) SELECT  'TALLA', 'Signo Vital', 'CM', @TALLA
      INSERT INTO #SIGNOSV ( CODIGOSV, CLASESV, UNIDAD, DATO) SELECT  'P.ABDOMINAL', 'Signo Vital', 'Cm', @PERIMETRO
      INSERT INTO #SIGNOSV ( CODIGOSV, CLASESV, UNIDAD, DATO) SELECT  'IMC', 'Signo Vital', 'K/m2', @IMC
      INSERT INTO #SIGNOSV ( CODIGOSV, CLASESV, UNIDAD, DATO) SELECT  'FC', 'Signo Vital', 'lat/min', @FC

      INSERT INTO CITSV (CONSECUTIVO_CIT, CLASEPLANTILLA, ITEM, CODIGOSV, CLASESV, UNIDAD, DATO)
      SELECT @CONSECUTIVO, 'TOMUES', ITEM, CODIGOSV, CLASESV, UNIDAD, DATO
      FROM #SIGNOSV

      DROP TABLE #SIGNOSV

		END TRY
		BEGIN CATCH
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
			RETURN
		END 
		END CATCH

		IF (SELECT COUNT(*) FROM @TBLERRORES) < 1
		BEGIN
				SELECT 'OK' OK
			RETURN
		END 
	RETURN
   END
   IF @METODO = 'DEVOLVERTOMA'
   BEGIN
		SELECT @CONSECUTIVO = CONSECUTIVO FROM OPENJSON(@PARAMETROS)WITH( CONSECUTIVO VARCHAR(12) '$.CONSECUTIVO' )
		SELECT @IDAFILIADO = IDAFILIADO FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO

		BEGIN TRY
			UPDATE CIT SET FECHALLEGA =null, USUARIOLLEGA = null, CUMPLIDA = null, IMPRESO = null WHERE CONSECUTIVO = @CONSECUTIVO
			DELETE DOCS WHERE DocCnsAuxiliar = @IDAFILIADO AND DocConsecutivo = @CONSECUTIVO
		END TRY
		BEGIN CATCH
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
			RETURN
		END 
		END CATCH

		IF (SELECT COUNT(*) FROM @TBLERRORES) < 1
		BEGIN
				SELECT 'OK' OK
			RETURN
		END 
   END
   IF @METODO = 'PAGO'
   BEGIN
		SELECT @PAGOS = PAGO, @IDKPAGE = IDKPAGE, @CONSECUTIVO = CONSECUTIVO, @IDAFILIADO = IDAFILIADO, @GENBOLETA = GENBOLETA, @GENFACTURA = GENFACTURA, @USUARIO = USUARIO, @IDTERCERORUC =  IDTERCERORUC--, @RUC =  RUC
		FROM OPENJSON (@PARAMETROS)  
		WITH (IDKPAGE		INT			'$.IDKPAGE'    , 
				CONSECUTIVO VARCHAR(13) '$.CONSECUTIVO', 
				IDAFILIADO	VARCHAR(20) '$.IDAFILIADO' ,
				GENBOLETA	BIT			'$.GENBOLETA'  ,
				GENFACTURA	BIT			'$.GENFACTURA' ,
				USUARIO		VARCHAR (20) '$.USUARIO'   ,
				IDTERCERORUC	VARCHAR (11) '$.IDTERCERORUC'  ,--RUC			VARCHAR (11) '$.RUC'  ,
				PAGO		NVARCHAR(MAX) AS JSON )
      --return  --PILAS BORRAR
		BEGIN TRY
			--1. Actualizo KPAGE SELECT * FROM KPAGE WHERE TABLA ='HTX'
			UPDATE KPAGE SET TABLA ='HTX', 
							 PROCEDENCIA ='EN SEDE', 
							 MODO ='PRODUCTION', 
							 FECHARES = CONVERT(SMALLDATETIME,GETDATE()), 
							 ESTADO = 'PAID', 
							 TIPO_PAGO='ENSEDE', 
							 USUCOBRA = @USUARIO,
							 RESPONSABLEPAGO = @IDAFILIADO
			WHERE  IDKPAGE = @IDKPAGE
			DELETE FROM KPAGED WHERE IDKPAGE = @IDKPAGE
			--2. INSERTO EN KPAGED DELETE #PAGOSHTX
			SELECT * INTO #PAGOSHTX1 FROM OPENJSON(@PAGOS) WITH (  ITEM			INT				'$.item',		 TIPOPAGO		   VARCHAR(13)		'$.tipopago',
																                VALOR		DECIMAL(16,2)	'$.valor',		 PROCEDENCIA		VARCHAR(25)		'$.procedencia',
																                REFERENCIA	VARCHAR(20)		'$.referencia', OBSERVACION		VARCHAR(200)	'$.observacion' )

			INSERT INTO KPAGED(IDKPAGE, ITEM, TIPO, CLASE, REFERENCIA, OBSERVACION, VALOR)
			SELECT @IDKPAGE, ITEM, TIPOPAGO, PROCEDENCIA, REFERENCIA, OBSERVACION, VALOR FROM #PAGOSHTX1

			--3. INSERTO EN TFCJ
			SELECT @NOADMISION = NOADMISION, @IDTERCERO = IDTERCEROCA FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO
			SELECT @NOMBREAFI = NOMBREAFI FROM AFI WHERE IDAFILIADO = @IDAFILIADO
			SELECT @IDSEDE ='02'
			SELECT @VALOR = VALOR FROM KPAGE WHERE IDKPAGE = @IDKPAGE

         IF (SELECT MED.TIPO_USUARIO FROM CIT INNER JOIN MED ON CIT.IDMEDICO = MED.IDMEDICO WHERE CIT.CONSECUTIVO = @CONSECUTIVO ) = 'Tmuestra'
            SELECT @DOMPRE = 'D' --Domiciliario
         ELSE
            SELECT @DOMPRE = 'P' --Presencial
			-- SE GENERA BOLETA DEL SI VIENE CON LA MARCA
			PRINT '@USUARIO ' + COALESCE (@USUARIO,'NO TENGO USUARIO')
			IF @GENBOLETA = 1 --AND @GENFACTURA = 1
			BEGIN	
            --SELECT 'INGRESE A GENBOLETA' GENBOLETA    --PILAS BORRAR
				IF ( SELECT COUNT(1) FROM AFI WHERE IDAFILIADO = @IDAFILIADO AND TIPO_DOC = 'DNI' AND LEN(DOCIDAFILIADO) <> 8  ) >= 1
				BEGIN
					INSERT INTO @TBLERRORES(ERROR) 
					SELECT 'No se genera Boleta, el DNI del responsable de pago debe ser de 8 digitos.' --Validation failure;exception;El DNI debe ser de 8 digitos ;
					IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
					BEGIN
							SELECT 'KO' OK
							SELECT ERROR FROM @TBLERRORES
						RETURN
					END
				END
				SELECT @NVOCONSEC  = NOPRESTACION FROM HTX WHERE CONSECUTIVO_CIT = @CONSECUTIVO
				SELECT @NOADMISION = NOADMISION, @IDAFILIADO_OLD = IDAFILIADO FROM CIT WHERE CONSECUTIVO   = @CONSECUTIVO

				UPDATE HADM SET IDAFILIADO = @IDAFILIADO WHERE NOADMISION = @NOADMISION

				INSERT INTO @RELIQUIDAR(ITEM, NOADMISION, NOPRESTACION)
				SELECT HPRED.NOITEM, @NOADMISION, @NVOCONSEC 
				FROM HPRED INNER JOIN HTX ON HPRED.IDSERVICIO   = HTX.IDSERVICIO 
                                     AND HPRED.NOPRESTACION = HTX.NOPRESTACION
				WHERE HTX.NOPRESTACION = @NVOCONSEC
				SELECT @I = 0
				SELECT @I_TO = (SELECT COUNT(1) FROM @RELIQUIDAR)
				WHILE @I <= @I_TO
				BEGIN
					SELECT @ITEM = ITEM FROM @RELIQUIDAR WHERE ID = @I
					UPDATE HPRED SET MARCA = 1, USUARIOMARCA = @USUARIO, FACTURADA=0, ENCARGOS=0 WHERE NOPRESTACION = @NVOCONSEC AND NOITEM = @ITEM
					--IF @IDTERCERO = DBO.FNK_VALORVARIABLE ('IDTERCEROPARTICULAR') 
               --   EXEC SPK_COPAGOQX @NOADMISION, @NVOCONSEC, @ITEM
               IF @DOMPRE = 'D' 
                  EXEC SPK_COPAGOQX @NOADMISION, @NVOCONSEC, @ITEM

				   SELECT @I = @I + 1				
            END

            --SELECT 'DESPUES DE RELIQUIDAR' DESPRELIQUIDA --PILAS BORRAR

				IF EXISTS(SELECT * FROM PTE WHERE NOADMISION = @NOADMISION)
				BEGIN
					SELECT @VALOR = COPAGO FROM PTE WHERE NOADMISION = @NOADMISION
					SET @VALOR = @VALOR / (1.0+(COALESCE((SELECT VALOR FROM FIMPDV WHERE GETDATE() BETWEEN FECHAINI AND FECHAFIN AND IDIMPUESTO IN (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDIMP_IVA')),18.0)/100))
					UPDATE HPRED SET VALORCOPAGO = @VALOR WHERE IDSERVICIO IN ('EXA00990','EXA0681') AND NOPRESTACION = @NVOCONSEC
				END

				EXEC SPK_GENCONSECUTIVO '01',@IDSEDE,'@RPDX', @RPDX OUTPUT  
				SELECT @RPDX = @IDSEDE + REPLACE(SPACE(8 - LEN(@RPDX))+LTRIM(RTRIM(@RPDX)),SPACE(1),0)

				DECLARE @COPAGOSERVICIO BIT
				DECLARE @VALORCOPAGO DECIMAL (14,10)

				SELECT @VALORCOPAGO = SUM(VALORCOPAGO) FROM HPRED WHERE  NOPRESTACION = @NVOCONSEC
				IF @VALORCOPAGO >  0
				BEGIN
					SELECT @COPAGOSERVICIO = 1
				END
				ELSE
				BEGIN
					SELECT @COPAGOSERVICIO = 0
				END
				IF @GENFACTURA = 1 AND  @IDTERCERO = DBO.FNK_VALORVARIABLE ('IDTERCEROPARTICULAR')  
				BEGIN
               --SELECT 'NODEBO ENTRAR A FACTURA' NODEBOFACTURA --PILAS BORRAR
					DECLARE @IDTERCERORESPONSABLE VARCHAR (20)
					UPDATE  CIT SET  IDCONTRATANTE =@IDTERCERORUC,IDPLAN = 'PAR001', IDTERCEROCA= @IDTERCERORUC, CCONTRATANTE = '1'   WHERE CONSECUTIVO = @CONSECUTIVO
					UPDATE  HADM SET IDTERCERO = @IDTERCERORUC , IDPLAN = 'PAR001' WHERE NOADMISION = @NOADMISION
					UPDATE  HPRE SET IDTERCEROCA = @IDTERCERORUC,  IDPLAN = 'PAR001'  WHERE NOADMISION = @NOADMISION
					SELECT @NOPRESTACION2 = (SELECT NOPRESTACION FROM HPRE WHERE NOADMISION = @NOADMISION)
					UPDATE HPRED  SET IDTERCEROCA =  @IDTERCERORUC, IDPLAN = 'PAR001', IDTERCEROH =@IDTERCERORUC  WHERE NOPRESTACION= @NOPRESTACION2
					UPDATE KPAGE  SET IDTERCERORESPONSABLE = @IDTERCERORUC  WHERE IDKPAGE = @IDKPAGE
					DECLARE @OTROTERCERO BIT =1
					SELECT @IDTERCERORESPONSABLE = @IDTERCERORUC
					 IF NOT EXISTS (SELECT 1 FROM PPT WHERE  IDTERCERO =@IDTERCERORESPONSABLE AND IDPLAN = 'PAR001' )
						BEGIN 
							INSERT INTO PPT (IDTERCERO, IDPLAN, TIPOTERCONTABLE, IDTARIFA, FACTOR, TIPORECOBRO, TIPOFACTURACION, IDMODELOPCA, IDMODELOPCH, CEAUTORIZADO, ESTADO,PFACTURARIND,IDFORMATOFTR , MFORMATOFACTURAIND )
							SELECT @IDTERCERORESPONSABLE, 'PAR001', 'PART', '001', 1, 'NA', 'C','05', '05', 'N', 'Activo', 1, '03G1', 1
						END

				END
            --SELECT 'VOY A SPK_AFACTURAR' SPK_AFACTURAR --PILAS BORRAR
				EXEC SPK_AFACTURAR @NOADMISION, @RPDX, @USUARIO
				SELECT @ITEM = ITEM FROM RPDX WHERE CNS = @RPDX

				SELECT @IDSEDE2 = (SELECT  SED.IDSEDE FROM USUSU 
						INNER JOIN UBEQ ON USUSU.SYS_ComputerName = UBEQ.SYS_ComputerName
						INNER JOIN SED ON UBEQ.IDSEDE =  SED.IDSEDE
						WHERE USUSU.USUARIO = @USUARIO)
				SELECT @NIT = NIT FROM SED WHERE IDSEDE =@IDSEDE2
				SELECT @DatoBolFac	= CASE @GENFACTURA  WHEN  1 THEN 'F' WHEN  0 THEN 'B' END

				IF  @COPAGOSERVICIO = 0
				BEGIN 
               --SELECT '@COPAGOSERVICIO = 0' COPAGOSERVICIO --PILAS BORRAR
					UPDATE HPRED  SET IDTERCEROCA =  @IDTERCERORUC, IDPLAN = 'PAR001', IDTERCEROH =@IDTERCERORUC  WHERE NOPRESTACION= @NOPRESTACION2
					UPDATE KPAGE  SET IDTERCERORESPONSABLE = @IDTERCERORUC  WHERE IDKPAGE = @IDKPAGE
					SELECT @IDSEDE2 = (SELECT  SED.IDSEDE FROM USUSU 
						               INNER JOIN UBEQ ON USUSU.SYS_ComputerName = UBEQ.SYS_ComputerName
						               INNER JOIN SED ON UBEQ.IDSEDE =  SED.IDSEDE
						               WHERE USUSU.USUARIO = @USUARIO)
						SELECT @NOMBREEQUIPO = (SELECT  USUSU.SYS_ComputerName FROM USUSU WHERE USUSU.USUARIO = @USUARIO)
						PRINT 'IDSEDE PARA BOLETA = COPAGOSERVICIO = 0 ' + @IDSEDE2
                  --RETURN
					EXEC DBO.SPK_FACTURA_ADMISION_DOMI @NOADMISION, @NIT, '01', @IDSEDE2, @USUARIO, @NOMBREEQUIPO, @RPDX, @ITEM,  @TIPOFACT= @DatoBolFac--, @IDTERCERORESPONSABLE =@IDTERCERORESPONSABLE
				END
				ELSE
				BEGIN
               --SELECT '@COPAGOSERVICIO = 1' COPAGOSERVICIO --PILAS BORRAR
				   SELECT @IDSEDE2 = (SELECT SED.IDSEDE 
                                  FROM   USUSU INNER JOIN UBEQ ON USUSU.SYS_ComputerName = UBEQ.SYS_ComputerName
						                             INNER JOIN SED ON UBEQ.IDSEDE =  SED.IDSEDE
						                WHERE  USUSU.USUARIO = @USUARIO)
					 SELECT @NOMBREEQUIPO = (SELECT  USUSU.SYS_ComputerName FROM USUSU WHERE USUSU.USUARIO = @USUARIO)
					 PRINT 'IDSEDE PARA BOLETA = COPAGOSERVICIO MAYOR A 0 ' + @IDSEDE2
                --SELECT 'ANTES DE SPK_FACTURA_ADMISION_DOMI_COPA' ANTESFACTBOLETA --PILAS BORRAR
                
					 EXEC DBO.SPK_FACTURA_ADMISION_DOMI_COPA @NOADMISION, @NIT, '01', @IDSEDE2, @USUARIO, @NOMBREEQUIPO, @RPDX, @ITEM, @TIPOCOPA= @DatoBolFac, @IDTERCERORESP =@IDTERCERORUC
                --SELECT 'DESPUES DE SPK_FACTURA_ADMISION_DOMI_COPA' DESPFACTBOLETA --PILAS BORRAR
				END
				
				UPDATE HADM SET IDAFILIADO = @IDAFILIADO_OLD WHERE NOADMISION = @NOADMISION
            --SELECT FTR.LINKFACTURA, HPRED.N_FACTURAH FROM FTR INNER JOIN HPRED ON  FTR.N_FACTURA = HPRED.N_FACTURAH WHERE HPRED.NOPRESTACION = @NVOCONSEC
            --RETURN
				SELECT @URLFACTURA =  FTR.LINKFACTURA, @N_FACTURA = FTR.N_FACTURA
				FROM   FTR INNER JOIN HPRED ON  CASE WHEN @COPAGOSERVICIO = 1 THEN HPRED.N_FACTURAH ELSE  HPRED.N_FACTURA END = FTR.N_FACTURA
				WHERE  HPRED.NOPRESTACION = @NVOCONSEC

				EXEC SPK_GENERA_JSON_PERU_FACTURA @N_FACTURA
				UPDATE KPAGE SET REF_PAGO = @N_FACTURA, FACTURADO = 'OK', TIPOFACTURA =@DatoBolFac  WHERE IDKPAGE = @IDKPAGE
				UPDATE  TFCJ SET IDKPAGE = @IDKPAGE   WHERE  N_FACTURA = @N_FACTURA
				DECLARE @CNSTFCJ VARCHAR (20)
				DECLARE @PROCEDENCIA VARCHAR (10)
				IF NOT EXISTS (SELECT * FROM TFCJ WHERE N_FACTURA =  @N_FACTURA AND NOADMISION = @NOADMISION)
				BEGIN
					EXEC SPK_GENCONSECUTIVO '01','01','@TFCJ', @CNSTFCJ OUTPUT  
					SELECT @CNSTFCJ = '01' + REPLACE(SPACE(8 - LEN(@CNSTFCJ))+LTRIM(RTRIM(@CNSTFCJ)),SPACE(1),0) 
					SELECT @PROCEDENCIA=PROCEDENCIA FROM HPRE WHERE NOPRESTACION=@NOPRESTACION 
					INSERT INTO TFCJ(CNSFACJ, N_RECIBO, CLASE_FAC, NOADMISION, NOPRESTACION,
							IDPLAN, VALORTOTAL, COMPANIA, IDAFILIADO,TIPO_DOC, CERRADA, FECHA, PROCEDENCIA,
							N_FACTURA, IDTERCERO, NOMBRECLIENTE,
							CNSACJ, TIPO, ESTADO, IMPRESO, MARCACONT, CONTABILIZADA, 
							NROCOMPROBANTE, AREAPRESTACION, CCOSTO,
							SUBCCOSTO, CLASER, IDENTIFICADOR, USUARIO, SYS_COMPUTERNAME, IDKPAGE)
					SELECT @CNSTFCJ, NULL,  'COBRO', @NOADMISION, NULL, @IDPLAN, (SELECT VR_TOTAL FROM FTR WHERE N_FACTURA =@N_FACTURA) , '01',
							@IDAFILIADO,NULL, 0, GETDATE(), 'HTX', @N_FACTURA, @IDTERCERORUC, LEFT(@NOMBREAFI,40),  
							NULL, 'INTERNO', 0, 0, 0, 0, NULL, NULL, NULL, NULL, 'C', 'FACTURA AD',
							@USUARIO, @SYS_COMPUTERNAME, @IDKPAGE
				END
			END
			UPDATE  TFCJ SET PROCEDENCIA = 'HTX'  WHERE  N_FACTURA = @N_FACTURA
		END TRY
		BEGIN CATCH
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
			RETURN
		END 
		END CATCH

		IF (SELECT COUNT(*) FROM @TBLERRORES) < 1
		BEGIN
				SELECT 'OK' OK
			RETURN
		END 
   END
   IF @METODO = 'DETALLESPAGO'
   BEGIN
		SELECT @IDKPAGE = IDKPAGE FROM OPENJSON (@PARAMETROS)WITH( IDKPAGE INT '$.IDKPAGE' )
		
		SELECT KPAGE.IDKPAGE, KPAGE.FECHARES, KPAGE.VALOR, KPAGE.REF_PAGO, KPAGE.USUCOBRA, KPAGE.RESPONSABLEPAGO, KPAGE.USUGENERA, KPAGE.FECHAGEN
			  ,FTR.LINKFACTURA,FTR.FACTEP
			  ,AFI.NOMBREAFI, AFI.TIPO_DOC, AFI.DOCIDAFILIADO, AFI.CELULAR, AFI.TELEFONORES
			  ,USUSU.NOMBRE NOMBRECOBRA
			  ,U.NOMBRE NOMBREGENERA
			  ,KPAGED.IDKPAGED
			  ,FTR.NOREFERENCIA
		FROM KPAGE
		LEFT JOIN FTR ON KPAGE.REF_PAGO = FTR.N_FACTURA
		LEFT JOIN AFI ON KPAGE.RESPONSABLEPAGO = AFI.IDAFILIADO
		LEFT JOIN USUSU ON KPAGE.USUCOBRA = USUSU.USUARIO
		LEFT JOIN USUSU U ON KPAGE.USUGENERA = U.USUARIO
		LEFT JOIN KPAGED ON KPAGE.IDKPAGE = KPAGED.IDKPAGE
		WHERE KPAGE.IDKPAGE = @IDKPAGE
		
		SELECT KPAGED.IDKPAGE, KPAGED.IDKPAGED, KPAGED.TIPO, KPAGED.ITEM, KPAGED.CLASE, KPAGED.REFERENCIA, KPAGED.OBSERVACION, KPAGED.VALOR ,DOCS.DocNombre, DOCS.DocumentoId, DOCS.DocFS
		FROM KPAGED 
		LEFT JOIN DOCS ON CONVERT(VARCHAR,KPAGED.IDKPAGE) = DOCS.DocConsecutivo AND DOCS.DocTipo <> 'SITEDS'
		WHERE IDKPAGE = @IDKPAGE


   END
   IF @METODO = 'AGENDADOMICILIARIA'
   BEGIN
		SELECT @IDTERCERO = IDTERCERO, @IDPLAN = IDPLAN, @SERVICIOS = SERVICIOS, @AFILIADOS = AFILIADOS, @SEDE = IDSEDE
		FROM OPENJSON (@PARAMETROS)  
			WITH ( IDTERCERO		VARCHAR(20)		'$.IDTERCERO',
				   IDPLAN			VARCHAR(6)		'$.IDPLAN',
               IDSEDE			VARCHAR(6)		'$.IDSEDE',
				   AFILIADOS		NVARCHAR(MAX)	 AS JSON,
				   SERVICIOS		NVARCHAR(MAX)	 AS JSON )
		SELECT ITEM, IDAFILIADO INTO #AFIS FROM OPENJSON (@AFILIADOS) 
		WITH ( ITEM INT '$.ITEM', IDAFILIADO VARCHAR(20) '$.IDAFILIADO', CONSECUTIVO VARCHAR(13) '$.CONSECUTIVO' )
		ALTER TABLE #AFIS ADD NOADMISION VARCHAR(16)
	
		SELECT value as IDSERVICIO, IDAFILIADO, VALORTOTAL INTO #SER FROM OPENJSON(@SERVICIOS) 
		WITH ( value VARCHAR(20) '$.value', IDAFILIADO VARCHAR(20) '$.IDAFILIADO', VALORTOTAL DECIMAL(18,2) '$.VALORTOTAL'  ) 
		ALTER TABLE #SER ADD ITEM INT IDENTITY
		DECLARE @HTXS TABLE(CNSHTX VARCHAR(20), NOADMISION VARCHAR(20), IDAFILIADO VARCHAR(20), IDSERVICIO VARCHAR(10))
		BEGIN TRY
	--		CREAR ADMISION
			SELECT @SEDE  = COALESCE (@SEDE, '01')
			SELECT @CONT1 = 1
			WHILE @CONT1 <= (SELECT COUNT(1) FROM #AFIS)
			BEGIN
				SELECT TOP 1 @IDAFILIADO = IDAFILIADO FROM #AFIS -- WHERE ITEM = @CONT1
				BEGIN 
					EXEC SPK_GENCONSECUTIVO '01',@SEDE,'@HADM',@NOADMISION OUTPUT
					SELECT @NOADMISION = @SEDE + RIGHT('00000000'+CONVERT(VARCHAR(8),@NOADMISION),8)
					INSERT INTO HADM (
						NOADMISION, IDAFILIADO, FECHA, IDSEDE, IDPLAN, IDTERCERO, TIPOADM, HABCAMA, VIAINGRESO, CAUSAEXTERNA, 
						TIPODISCAP, GRADODISCAP, CAUSASALIDA, ESTADOPSALIDA, RESPCUENTA, URG_NOMBRE, URG_DIR, URG_TELE, URG_VINCULO, FACTURADA, CERRADA, 
						PCUBRIMIENTO, USUARIO, DESTINO, ESTADOSALIDA, RIPS, NIVELSOCIOEC, TIPOPOLIZA, FACTURABLE, INDDEVOLUCION, TIPOTOPE, 
						IDPROVEEDOR, TIPOCONT, FECHAPRE, DECLARIESGOS, CLASEING, EMBARAZADA, TTRIAGE, ESINSTPROV, IDPLAN_AFI, 
						IDTERCERO_AFI, USACTC, TIPOHTX, TIPOESTANCIA, TIPOADMINI,ESTADO,
						FECHAALTA,FECHAALTAMED, FECHAALTAENF)
					SELECT @NOADMISION, @IDAFILIADO, @HOY, @SEDE, @IDPLAN, @IDTERCERO, '01', NULL, '3', '', 
						AFI.TIPODISCAPACIDAD, 'N', 'OR', 1, LEFT(TER.RAZONSOCIAL,45), AFI.URG_NOMBRE, AFI.URG_DIR, AFI.URG_TELE, AFI.URG_VINCULO, 0, 1, 
						100, @USUARIO, 1, 'N', 0, AFI.NIVELSOCIOEC, 'Vigente', 1, 0, 'Fecha',
						AFI.IDPROVEEDOR, 'I',@HOY, 'Manifiesto no ser Al?gico a ninguna Sustancia', 'A', 
						0, 0, 3, AFI.IDPLAN,
						@IDTERCERO, 1, '01', NULL, '01','Activo',
						@HOY,@HOY,@HOY
					FROM AFI
						INNER JOIN TER ON @IDTERCERO=TER.IDTERCERO
					WHERE AFI.IDAFILIADO=@IDAFILIADO
				END
				UPDATE #AFIS SET NOADMISION = @NOADMISION WHERE IDAFILIADO = @IDAFILIADO

				EXEC SPK_GENCONSECUTIVO '01','01','@HCON', @CONSECUTIVOHCA OUTPUT
				SELECT @CONSECUTIVOHCA = 'ON01' + REPLACE(SPACE(8 - LEN(@CONSECUTIVOHCA)) + LTRIM(RTRIM(@CONSECUTIVOHCA)), SPACE(1), 0)

				SELECT @USUNOTA = DBO.FNK_VALORVARIABLE('USU_NOTA_AUTO') --Debe tener idmedico v?ido

				IF NOT EXISTS(SELECT * FROM USUSU WHERE USUARIO = @USUNOTA) SELECT @USUNOTA = @USUARIO
			
				SELECT @IDMEDICO = IDMEDICO, @SYS_COMPUTERNAME = COALESCE(SYS_COMPUTERNAME, @@SERVERNAME)
				FROM USUSU
				WHERE USUARIO = @USUNOTA

				-- Area funcional y centro de costo donde se origina la HC
				SELECT @IDAREA = IDAREA,@CCOSTO = CCOSTO
				FROM UBEQ
				WHERE SYS_COMPUTERNAME = @SYS_COMPUTERNAME

				SELECT @ITEMRED = MAX(ITEMRED) + 1 FROM HCA WHERE NOADMISION = NOADMISION
				IF @ITEMRED IS NULL SET @ITEMRED = 1

				INSERT INTO HCA (CONSECUTIVO,ITEMRED,CLASEPLANTILLA,AMBITO,FECHA
								,NOADMISION,IDAFILIADO,TIPODX,IDDX,IDMEDICO,IDMEDICODILIGENCIA,PROCEDENCIA
								,ALTA,CLASE,IDAREA,CCOSTO,USUARIO,IDPLAN,CODAZUL,SINCRONIZADO)
				SELECT			@CONSECUTIVOHCA,@ITEMRED,CLASEPLANTILLA,AMBITO,GETDATE()
								,@NOADMISION,@IDAFILIADO,@TIPODX,@IDDX,@IDMEDICO,@IDMEDICO,'COMERCIAL' 
								,ALTA=0,CLASE,@IDAREA,@CCOSTO,@USUNOTA,@IDPLAN,CODAZUL=0,0
				FROM MPL 
				WHERE CLASEPLANTILLA=@CLASEPLANTILLA

				INSERT INTO HCAD(CONSECUTIVO,CLASEPLANTILLA,CAMPO,SECUENCIA,TIPOCAMPO)
				SELECT @CONSECUTIVOHCA,@CLASEPLANTILLA,CAMPO,SECUENCIA,TIPO_CAMPO
				FROM MPLD
				WHERE CLASEPLANTILLA=@CLASEPLANTILLA

				-- AREA
				SELECT @ALFANUMERICO='11-COMERCIAL', @NUMERICO=11
				UPDATE HCAD SET ALFANUMERICO=@ALFANUMERICO, NUMERICO=@NUMERICO
				WHERE CONSECUTIVO=@CONSECUTIVOHCA AND SECUENCIA=1
			
				-- MOTIVO
				SELECT @ALFANUMERICO=VALORLISTA, @NUMERICO=VALOR 
				FROM MPLDL WHERE CLASEPLANTILLA=@CLASEPLANTILLA AND CAMPO='LISTA2' 
				AND VALOR=8

				UPDATE HCAD SET ALFANUMERICO=@ALFANUMERICO, NUMERICO=@NUMERICO
				WHERE CONSECUTIVO=@CONSECUTIVOHCA AND SECUENCIA=2

				UPDATE HCAD SET FECHA=GETDATE()
				WHERE CONSECUTIVO=@CONSECUTIVOHCA AND SECUENCIA=10

				UPDATE HCAD SET MEMO='Agendamiento para toma de muestra domiciliaria.'
				WHERE CONSECUTIVO=@CONSECUTIVOHCA AND SECUENCIA=20

				INSERT INTO HCADL(CONSECUTIVO,SECUENCIA,VALORLISTA)
				SELECT  @CONSECUTIVOHCA,SECUENCIA,VALORLISTA 
				FROM MPLDL INNER JOIN MPLD ON MPLDL.CLASEPLANTILLA=MPLD.CLASEPLANTILLA
				AND MPLDL.CAMPO=MPLD.CAMPO
				WHERE MPLD.CLASEPLANTILLA=@CLASEPLANTILLA
		
				INSERT INTO HCATD (CONSECUTIVO, ITEMRED,NOITEM, CODOM, IDSERVICIO, CANTIDAD, IDTIPOCONC, VIA
								 , OBSERVACION
								 , CLASE, ENCARGOS, FRECUENCIA, DURACION, TIPO, AVISADOENF, PRIMER, DOSISUNICA, RAZONNEC, QAM, QPM
								 , LUNES, MARTES, MIERCOLES, JUEVES, VIERNES, SABADO, DOMINGO)
				SELECT			@CONSECUTIVOHCA, @ITEMRED, ITEM, '005', IDSERVICIO, 1.000000, '', 'No Aplica'
						, 'Agendamiento realizado por el ?ea comercial para realizar toma domiciliaria.'
						, 'I', 0, 24.00, 24.00, 'Horaria', 0, 1, 0, 0, 0.00, 0.00
						, 0, 0, 0, 0, 0, 0, 0 FROM #SER where IDAFILIADO = @idafiliado

				EXEC SPK_HCATD_A_HTX @CONSECUTIVOHCA, '01', '01'

				INSERT INTO @HTXS(CNSHTX, NOADMISION, IDAFILIADO, IDSERVICIO)
				SELECT CNSHTX, NOADMISION, @IDAFILIADO, IDSERVICIO FROM HTX WHERE CONSECUTIVOHCA = @CONSECUTIVOHCA

				SELECT @CONT1 = @CONT1 +1
			END
		END TRY
		BEGIN CATCH
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
			RETURN
		END 
		END CATCH

		IF (SELECT COUNT(*) FROM @TBLERRORES) < 1
		BEGIN
				SELECT 'OK' OK
				SELECT CNSHTX, NOADMISION, IDAFILIADO, IDSERVICIO FROM @HTXS
			RETURN
		END 
   END
   IF @METODO = 'CREAHTXHPRED'
   BEGIN
	SELECT @CONSECUTIVO = CONSECUTIVO FROM OPENJSON(@PARAMETROS) WITH( CONSECUTIVO VARCHAR(13) '$.CONSECUTIVO' )
	SELECT @NOADMISION = NOADMISION FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO
	SELECT @CONT1 = COUNT(*) FROM CIT INNER JOIN KPAGE ON CIT.IDKPAGE = KPAGE.IDKPAGE WHERE CIT.CONSECUTIVO = @CONSECUTIVO AND KPAGE.PROCEDENCIA = 'AFI_APP'
	IF NOT EXISTS(SELECT * FROM HTX WHERE CONSECUTIVO_CIT = @CONSECUTIVO AND HTX.NOADMISION = @NOADMISION) AND @CONT1 > 0
	BEGIN
		SELECT @NOADMISION = NOADMISION
		     , @IDPLAN     = IDPLAN
		     , @IDTERCERO  = IDTERCEROCA
			 , @IDSERVICIO = IDSERVICIO
			 , @IDKPAGE    = IDKPAGE 
			 , @FECHACIT   = FECHA
			 , @IDMEDICO   = IDMEDICO
		FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO

		SELECT @FECHACIT = FECHA, @IDMEDICO = IDMEDICO FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO
		--CREAR HPRED
		SELECT @FECHAHPRE	= dbo.FNK_FECHA_SIN_MLS(GETDATE())
		SELECT @PREFIJO = PREFIJO, @APOYODG_AMBITO = AMBITO FROM SER WHERE IDSERVICIO = @IDSERVICIO
		PRINT 'CREANDO LA HPRE'
		SELECT @CCOSTO=CEN.CCOSTO, @IDAREA=CEN.IDAREA FROM PLN INNER JOIN CEN ON CEN.CCOSTO=PLN.CCOSTO WHERE PLN.IDPLAN = @IDPLAN
		SELECT @IDAREAH   = IDAREAH  FROM AFU WHERE IDAREA  = @IDAREA
		SELECT @ALTOCOSTO = COALESCE(GALTOCOSTO_QX,'No') FROM CEN WHERE CCOSTO = @CCOSTO

		PRINT 'GENERANDO CONSECUTIVO'
		EXEC SPK_GENCONSECUTIVO '01',@SEDE,'@HPRE', @NVOCONSEC OUTPUT  
		SELECT @NVOCONSEC = @SEDE + REPLACE(SPACE(8 - LEN(@NVOCONSEC))+LTRIM(RTRIM(@NVOCONSEC)),SPACE(1),0)

		PRINT '@NVOCONSEC: ' + @NVOCONSEC 
		PRINT 'INSERTANDO HPRE'
		INSERT INTO HPRE( NOPRESTACION, NOADMISION, FECHA, IDPLAN, IDAREA, IDSEDE, ALTOCOSTO, NO_ITEMES, VALORTOTAL,
					VALORCOPAGO, VALOREXEDENTE, IMPRESO, AUTORIZADOPOR, NUMAUTORIZA, FECHAAUTORIZA, AUTORIZADO,
					USUARIO, CERRADA, VALORPCOMP, CIRUGIA, PCUBRIMIENTO, CLASEORDEN, CONSECUTIVO, ESDEINV,
					PEDIDOINV, CNSMOV, INDDEVOLUCION, PREFIJO, CCOSTO, SUBCCOSTO, FINALIDAD, AMBITO, PERSONAL_AT,
					DXPPAL, DXRELACIONADO, COMPLICACION, FORMAQX, ESCONSULTA, IDAREAH, NIVELATENCION, IDAREAEQUIPO,
					IMPRESOP, IDMEDICO, COBRARA, IDTERCEROCA, CONSECUTIVOHCA, ITEMRED, ENLAB, PROCEDENCIA, 
					TIPOHISTORIA,SYS_COMPUTERNAME, COMERCIAL)
		SELECT @NVOCONSEC, @NOADMISION, @FECHAHPRE, @IDPLAN, @IDAREA, @SEDE, @ALTOCOSTO, NULL, 0, 0, 
			0, 0, NULL, NULL, NULL,
			NULL, @USUARIO, 0 ,0, 'No', 100, '', NULL, 0, 0, NULL, 0, @PREFIJO, @CCOSTO, '',
			1, NULL, NULL, NULL, NULL, NULL, NULL, 0, @IDAREAH, NULL, NULL, 0, @IDMEDICO, 'C', @IDTERCERO,
			NULL, NULL, 0, 'CIT', NULL,NULL, 'SI'

		SELECT @VALOR = VLRSERVICIO FROM SERTOT1 
		WHERE  IDTERCERO  = @IDTERCERO 
		AND    IDPLAN     = @IDPLAN
		AND    IDSERVICIO = @IDSERVICIO
		AND    @FECHAHPRE >= FECHAINIFD
		AND    @FECHAHPRE <= FECHAFINFD
		AND    @FECHAHPRE >= FECHAINI
		AND    @FECHAHPRE <= FECHAFIN

		SELECT @CODCUPS = CODCUPS  FROM SERTOT1
		WHERE   IDPLAN         = @IDPLAN
		AND    IDAREACA		   = @IDAREA 
		AND    IDTERCERO	   = @IDTERCERO 
		AND    IDSERVICIO	   = @IDSERVICIO
		AND    @FECHAHPRE     >= FECHAINIFD
		AND    @FECHAHPRE     <= FECHAFINFD
		AND    @FECHAHPRE     >= FECHAINI
		AND    @FECHAHPRE     <= FECHAFIN

		SELECT @IDCONCEPTORIPS = CODIGORIPS FROM SER WHERE IDSERVICIO = @IDSERVICIO
		INSERT INTO HPRED(NOPRESTACION, NOITEM, IDSERVICIO, CANTIDAD, VALOR, VALORCOPAGO, VALOREXCEDENTE, VALORTOTALCOSTO,
					IDPLAN, IMPRESO, AUTORIZADO, COMENTARIOS, IDPROVEEDOR, IDCONCEPTORIPS, AMBITO, FINALIDAD, 
					PERSONAL_AT, DXPPAL, DXRELACIONADO, COMPLICACION, FORMAQX, VALORPCOMP, IDCIRUGIA, USUARIO,
					UTISOAT, VLRFALTAAPLICARSOAT, TIPOSERCIRUGIA, FACTURADA, N_FACTURA, VLRAPLICADO1, VLRAPLICADO2,
					CANTIDADORIGINAL, CANTIDADDEVUELTA, CNSIDEV, INDDEVOLUCION, INDDEVAPLICADA, USUARIODEV, NOCOBRABLE,
					ITEMCIRUGIA, PCOSTO, CXP, FECHA, VIA, IDAREAH, IDAREA, NIVELATENCION, PEDIDOINV, CONSECUTIVOCX,
					NOLOTE, COBRARA, IDTERCEROCA, PCUBRIMIENTO, TIPODTO, DESCUENTO, NORDEN, CCOSTO, CODCUPS,
					APOYODG_AMBITO, ENCARGOS, FECHASOL)

		SELECT @NVOCONSEC, 1, @IDSERVICIO, 1, @VALOR, 0, 0, 0, @IDPLAN, 0, NULL, 'CREADO AUTOMATICAMENTE', NULL,
							@IDCONCEPTORIPS, NULL, NULL, NULL, NULL, NULL, NULL, NULL, 0, NULL, @USUARIO, 0, 0, NULL, 0, NULL,
							0, 0, 1 , 0, NULL , 0, 0,  NULL, 0,NULL, 0, 0, @FECHAHPRE,  'NA', @IDAREAH, @IDAREA, NULL, 0, NULL, 
							NULL, 'C', @IDTERCERO, 100, 'N', 0, NULL, @CCOSTO, @CODCUPS,@APOYODG_AMBITO, 0, @FECHAHPRE
						
		EXEC SPK_GENCONSECUTIVO '01', '01','@HTX', @CNSHTX OUTPUT  
		SELECT @CNSHTX = '01' + REPLACE(SPACE(8 - LEN(@CNSHTX))+LTRIM(RTRIM(@CNSHTX)),SPACE(1),0) 

		INSERT INTO HTX ( 
			CNSHTX, CONSECUTIVOHCA, CODOM, ITEMRED, TIPOHISTORIA, IDSERVICIO, CANTIDAD, FECHAORDEN, IDTIPOCONC, VIA, FECHAREQ, CLASE, TIPO
			, SOLICITADO, APLICADO, ENCARGOS,NOPRESTACION, NOITEM, NOADMISION, ESTADO, CCOSTO, IDAREA, LISTOENTREGA, ENTREGADO, APROBADO, CLASEHTX
			, IDPLAN, CONSECUTIVO_CIT, CNSCONTENEDOR, PA_RECIBIDO, PA_ESTADO )
		SELECT
				@CNSHTX, NULL, '005',NULL, 'O', @IDSERVICIO,1,CONVERT(DATE,GETDATE()),'','',CONVERT(DATE,GETDATE()),'I', 'Horaria'
			,0,0,1,@NVOCONSEC,1,@NOADMISION, 'A','102','01',0,0,0,'NE'
			,@IDPLAN,@CONSECUTIVO,NULL,NULL,NULL

		UPDATE HPRED SET CNSHBALI = @CNSHTX WHERE NOPRESTACION = @NVOCONSEC AND NOITEM = @CONT AND HPRED.IDSERVICIO = @IDSERVICIO
			
		EXEC SPK_ASIGNAR_CONTENEDOR @NVOCONSEC, @NOADMISION, '02'
	END
   END
   IF @METODO = 'SOLOBOLETA'
   BEGIN 
		SELECT @IDKPAGE = IDKPAGE, @CONSECUTIVO = CONSECUTIVO, @IDAFILIADO = IDAFILIADO
		FROM OPENJSON (@PARAMETROS)  
		WITH (	IDKPAGE		INT			'$.IDKPAGE'    , 
				CONSECUTIVO VARCHAR(13) '$.CONSECUTIVO',
				IDAFILIADO	VARCHAR(20) '$.IDAFILIADO' )

		BEGIN TRY
			PRINT ':::::::::::::::::::::: ENTRO A GENERAR BOLETA ::::::::::::::::::::::::::::'
			SELECT @NVOCONSEC  = NOPRESTACION FROM HTX WHERE CONSECUTIVO_CIT = @CONSECUTIVO

			
			SELECT @NOADMISION = NOADMISION FROM CIT WHERE CONSECUTIVO   = @CONSECUTIVO

			INSERT INTO @RELIQUIDAR(ITEM, NOADMISION, NOPRESTACION)
			SELECT HPRED.NOITEM, @NOADMISION, @NVOCONSEC 
			FROM HPRED 
			INNER JOIN HTX ON --HPRED.CNSHBALI = HTX.CNSHTX AND 
								HPRED.IDSERVICIO = HTX.IDSERVICIO AND 
								HPRED.NOPRESTACION = HTX.NOPRESTACION
			WHERE HTX.NOPRESTACION = @NVOCONSEC
			SELECT @I = 0
			SELECT @I_TO = (SELECT COUNT(1) FROM @RELIQUIDAR)
			WHILE @I <= @I_TO
			BEGIN
				SELECT @ITEM = ITEM FROM @RELIQUIDAR WHERE ID = @I

				UPDATE HPRED SET MARCA = 1, USUARIOMARCA = @USUARIO, FACTURADA=0, ENCARGOS=0 WHERE NOPRESTACION = @NVOCONSEC AND NOITEM = @ITEM
					
				EXEC SPK_COPAGOQX @NOADMISION, @NVOCONSEC, @ITEM

				IF (SELECT COUNT(*) FROM HPRED WHERE COALESCE(VALORCOPAGO,0)=0 AND NOPRESTACION = @NVOCONSEC AND NOITEM = @ITEM)>0
				BEGIN
					UPDATE HPRED SET VALORCOPAGO = VALOR WHERE NOPRESTACION = @NVOCONSEC AND NOITEM = @ITEM
				END

				SELECT @I = @I + 1
			END
			IF EXISTS(SELECT * FROM PTE WHERE NOADMISION = @NOADMISION)
			BEGIN
				SELECT @VALOR = COPAGO FROM PTE WHERE NOADMISION = @NOADMISION
				SET @VALOR = @VALOR / (1.0+(COALESCE((SELECT VALOR FROM FIMPDV WHERE GETDATE() BETWEEN FECHAINI AND FECHAFIN AND IDIMPUESTO IN (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDIMP_IVA')),18.0)/100))
				UPDATE HPRED SET VALORCOPAGO = @VALOR WHERE IDSERVICIO IN ('EXA00990','EXA0681') AND NOPRESTACION = @NVOCONSEC
			END
			UPDATE HPRED  SET USUARIOMARCA = @USUARIO  WHERE NOPRESTACION = @NVOCONSEC
			SELECT @IDSEDE ='02'
			EXEC SPK_GENCONSECUTIVO '01',@IDSEDE,'@RPDX', @RPDX OUTPUT  
			SELECT @RPDX = @IDSEDE + REPLACE(SPACE(8 - LEN(@RPDX))+LTRIM(RTRIM(@RPDX)),SPACE(1),0)
			EXEC SPK_AFACTURAR @NOADMISION, @RPDX, @USUARIO
			--select * from rpdx where cns = @rpdx
			SELECT @ITEM = ITEM FROM RPDX WHERE CNS = @RPDX

			SELECT @NIT = NIT FROM SED WHERE IDSEDE ='01'
			SELECT @DatoBolFac	= (SELECT TIPOFACTURA FROM KPAGE WHERE IDKPAGE = @IDKPAGE)
			IF @IDTERCERO = DBO.FNK_VALORVARIABLE ('IDTERCEROPARTICULAR')
			BEGIN 
			SELECT @IDSEDE2 = (SELECT  SED.IDSEDE FROM USUSU 
				INNER JOIN UBEQ ON USUSU.SYS_ComputerName = UBEQ.SYS_ComputerName
				INNER JOIN SED ON UBEQ.IDSEDE =  SED.IDSEDE
				WHERE USUSU.USUARIO = @USUARIO)
				SELECT @NOMBREEQUIPO = (SELECT  USUSU.SYS_ComputerName FROM USUSU WHERE USUSU.USUARIO = @USUARIO)
				exec DBO.SPK_FACTURA_ADMISION_DOMI @NOADMISION, @NIT, '01', @IDSEDE2, @USUARIO, @NOMBREEQUIPO, @RPDX, @ITEM, @TIPOFACT= @DatoBolFac
			END
			ELSE
			BEGIN
			SELECT @IDSEDE2 = (SELECT  SED.IDSEDE FROM USUSU 
				INNER JOIN UBEQ ON USUSU.SYS_ComputerName = UBEQ.SYS_ComputerName
				INNER JOIN SED ON UBEQ.IDSEDE =  SED.IDSEDE
				WHERE USUSU.USUARIO = @USUARIO)
				SELECT @NOMBREEQUIPO = (SELECT  USUSU.SYS_ComputerName FROM USUSU WHERE USUSU.USUARIO = @USUARIO)
				exec DBO.SPK_FACTURA_ADMISION_DOMI_COPA @NOADMISION, @NIT, '01', @IDSEDE2, @USUARIO, @NOMBREEQUIPO, @RPDX, @ITEM, @TIPOCOPA= @DatoBolFac
			END

			SELECT @URLFACTURA =  FTR.LINKFACTURA, @N_FACTURA = FTR.N_FACTURA
			FROM FTR
			INNER JOIN HPRED ON HPRED.N_FACTURAH = FTR.N_FACTURA
			WHERE --FTR.N_FACTURA = 'B003-00009642'
			HPRED.NOPRESTACION = @NVOCONSEC
			EXEC SPK_GENERA_JSON_PERU_FACTURA @N_FACTURA
			UPDATE KPAGE SET REF_PAGO = @N_FACTURA, FACTURADO = 'OK' WHERE IDKPAGE = @IDKPAGE
			UPDATE TFCJ SET IDKPAGE = @IDKPAGE , PROCEDENCIA = 'HTX'  WHERE N_FACTURA = @N_FACTURA
		
		END TRY
		BEGIN CATCH
				INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE()
		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
			RETURN
		END 
		END CATCH

		IF (SELECT COUNT(*) FROM @TBLERRORES) < 1
		BEGIN
				SELECT 'OK' OK
			RETURN
		END 
   END
   IF @METODO = 'LX_RESULTADOS'
   BEGIN
		DECLARE @F_DESDE VARCHAR(10)
		DECLARE @F_HASTA VARCHAR(10)
		SELECT @F_DESDE = F_DESDE, @F_HASTA = F_HASTA FROM OPENJSON(@PARAMETROS)WITH(F_DESDE VARCHAR(10) '$.F_DESDE', F_HASTA VARCHAR(10) '$.F_HASTA')

		SELECT HTX.CNSHTX, HTX.IDSERVICIO, HTX.NOADMISION, HTX.CONSECUTIVO_CIT, HTX.CNSCONTENEDOR, HTX.USUATENCION, HTX.FTOMA, HTX.RESULTADO
			  ,UPPER(AFI.NOMBREAFI)NOMBREAFI, AFI.TIPO_DOC, AFI.DOCIDAFILIADO, AFI.SEXO, AFI.EDAD, AFI.FNACIMIENTO
			  ,TER.IDTERCERO, TER.RAZONSOCIAL
			  ,PLN.IDPLAN, PLN.DESCPLAN
			  ,SER.DESCSERVICIO
			  ,AFI.IDAFILIADO
			  ,UPPER(USUSU.NOMBRE)NOMBRE
		FROM HTX
		INNER JOIN SER ON HTX.IDSERVICIO = SER.IDSERVICIO
		INNER JOIN HADM ON HTX.NOADMISION = HADM.NOADMISION
		INNER JOIN AFI ON HADM.IDAFILIADO = AFI.IDAFILIADO
		INNER JOIN TER ON HADM.IDTERCERO = TER.IDTERCERO
		INNER JOIN USUSU ON HTX.USUATENCION = USUSU.USUARIO
		left JOIN PLN ON HTX.IDPLAN = PLN.IDPLAN
		WHERE RESULTADO = 'PENDIENTE'
			  AND SER.CLASIF1='P_AUTOMATICO'
			  AND COALESCE(HTX.CONSECUTIVO_CIT,'')<>''
			  AND CONVERT(DATE,HTX.FTOMA) >= CONVERT(DATE,@F_DESDE)
		      AND CONVERT(DATE,HTX.FTOMA) <= CONVERT(DATE,@F_HASTA)
			  --AND HTX.USUATENCION = @USUARIO

		SELECT 	UPPER(USUSU.NOMBRE)NOMBRE, USUSU.USUARIO, COUNT(*)CANT
		FROM HTX
		INNER JOIN USUSU ON HTX.USUATENCION = USUSU.USUARIO
		INNER JOIN SER ON HTX.IDSERVICIO = SER.IDSERVICIO
		INNER JOIN HADM ON HTX.NOADMISION = HADM.NOADMISION
		INNER JOIN AFI ON HADM.IDAFILIADO = AFI.IDAFILIADO
		INNER JOIN TER ON HADM.IDTERCERO = TER.IDTERCERO
		--INNER JOIN PLN ON HTX.IDPLAN = PLN.IDPLAN
		WHERE RESULTADO = 'PENDIENTE'
			  AND SER.CLASIF1='P_AUTOMATICO'
			  AND CONVERT(DATE,HTX.FTOMA) >= CONVERT(DATE,@F_DESDE)
		      AND CONVERT(DATE,HTX.FTOMA) <= CONVERT(DATE,@F_HASTA)
		group by USUSU.NOMBRE, USUSU.USUARIO
		ORDER BY count(*) DESC, USUSU.NOMBRE ASC

   END
--query 3
   IF @METODO = 'LX_PROCESAR_RES'
   BEGIN
		SELECT @RESULTADO = RESULTADO, @CNSHTX = CNSHTX, @IDAFILIADO = IDAFILIADO, @HEMOGLOBINA =  HEMOGLOBINA
		FROM OPENJSON (@PARAMETROS)  
		WITH (	RESULTADO	   VARCHAR(10)	      '$.RESULTADO', 
               HEMOGLOBINA	   DECIMAL(18,2)	   '$.HEMOGLOBINA', 
				   CNSHTX		   VARCHAR(16)       '$.CNSHTX',
				   IDAFILIADO	   VARCHAR(20)       '$.IDAFILIADO' )
		SELECT @CONSECUTIVO = CONSECUTIVO_CIT, @IDSERVICIO = IDSERVICIO, @CNSCONTENEDOR= CNSCONTENEDOR, @DESC_EQUIPOMUES = DESC_EQUIPOMUES,@NOPRESTACION = NOPRESTACION 
      FROM HTX WHERE CNSHTX = @CNSHTX

		SELECT @NOADMISION = NOADMISION
		     , @IDPLAN     = IDPLAN
		     , @IDTERCERO  = IDTERCEROCA
			 , @IDKPAGE    = IDKPAGE 
			 , @FECHACIT   = FECHA
			 , @IDMEDICO   = IDMEDICO
			 , @SEDE       = IDSEDE
		FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO

		--SELECT @NOPRESTACION = NOPRESTACION FROM HTX WHERE  CONSECUTIVO_CIT = @CONSECUTIVO AND IDSERVICIO = 'EXA0681' AND CODOM IN ('005', '006') AND NOADMISION = @NOADMISION

		-----
         IF (SELECT COALESCE(AFI.FNACIMIENTO,'')  FROM AFI WHERE  IDAFILIADO = @IDAFILIADO) = ''
         BEGIN
            INSERT INTO @TBLERRORES(ERROR) SELECT 'El px no cuenta con fecha de nacimiento, se debe de actualizar.'
         END
         IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		   BEGIN
			   SELECT 'KO' OK
			   SELECT ERROR FROM @TBLERRORES
			   RETURN
		   END
         ELSE
         BEGIN
             BEGIN TRY
               IF @IDSERVICIO IN ( 'EXA0681', 'EXA00991')
               BEGIN
                  SELECT @NVOCONSEC = NULL
                     EXEC SPK_GENCONSECUTIVO '01', @SEDE, '@LING',  @NVOCONSEC OUTPUT  
                  SELECT @NVOCONSEC = @SEDE + REPLACE(SPACE(8 - LEN(@NVOCONSEC))+LTRIM(RTRIM(@NVOCONSEC)),SPACE(1),0) 

		           INSERT INTO LING(NOINGRESO ,TIPOINGRESO ,IDAFILIADO, IDTERCERO, IDPLAN, FECHA, NOADMISION, NOPRESTACION, IDMEDICO, COBRARA, IMPRESO, ESTADO, CONSECUTIVOHCA ,AMBITOTR, USUARIO, FECHA_PRES, INTERFACE, NOTI)
                 SELECT TOP 1 @NVOCONSEC,'A' ,HADM.IDAFILIADO  ,HADM.IDTERCERO ,HADM.IDPLAN ,dbo.FNK_FECHA_SIN_MLS(GETDATE()) , HPRE.NOADMISION ,HPRED.NOPRESTACION ,HPRE.IDMEDICO, 'C',0 ,'I',HPRE.CONSECUTIVOHCA ,'LX' , 'INTERFACE' , GETDATE(), 1 , 'NO'
                 FROM   HPRED INNER JOIN HPRE ON HPRED.NOPRESTACION = HPRE.NOPRESTACION
                             INNER JOIN HADM ON HPRE.NOADMISION    = HADM.NOADMISION
                 WHERE  HPRED.NOPRESTACION = @NOPRESTACION
                 AND    HPRED.IDSERVICIO   = @IDSERVICIO

      
		            SELECT @NORDEN = NULL
		            EXEC SPK_GENCONSECUTIVO '01', @SEDE, '@LORD',  @NORDEN OUTPUT  
 		            SELECT @NORDEN = @SEDE + REPLACE(SPACE(8 - LEN(@NORDEN))+LTRIM(RTRIM(@NORDEN)),SPACE(1),0) 
		
		            INSERT INTO LORD(NORDEN , NOINGRESO , IDSERVICIO , FECHA, ESTADO, NOITEM, CONSECUTIVOHCA , REALIZADO ,OBSERVACION , IDMEDICO ,USUARIOTRAE)
                    SELECT TOP 1 @NORDEN,@NVOCONSEC, @IDSERVICIO, dbo.FNK_FECHA_SIN_MLS(GETDATE()), 'I', 1, HPRE.CONSECUTIVOHCA, 1, '', 'LFIGUEROA' , 'INTERFACE'
                    FROM   HPRED INNER JOIN HPRE ON HPRED.NOPRESTACION = HPRE.NOPRESTACION
                                    INNER JOIN HADM ON HPRE.NOADMISION    = HADM.NOADMISION
                    WHERE  HPRED.NOPRESTACION = @NOPRESTACION
                    AND    HPRED.IDSERVICIO   = @IDSERVICIO
		            UPDATE HPRED SET ENCARGOS = 0 WHERE NOPRESTACION = @NOPRESTACION AND IDSERVICIO = @IDSERVICIO

               
		            INSERT INTO LORDD(NORDEN, NOITEM, IDDATO, MEMO, ALFANUMERICO, FECHA, OBS ,IDSERVICIO, TIPOCAMPO, VR_MINIMO,VR_MAXIMO,UNIDADES,COD_ANALITO)
                  SELECT @NORDEN,1,'MEMO','HISOPADO NASO-FARINGEO','MUESTRA', dbo.FNK_FECHA_SIN_MLS(GETDATE()) ,'' ,@IDSERVICIO, '', '' ,'' ,'', '749' UNION ALL
                  SELECT @NORDEN,2,'MEMO',IIF(@RESULTADO='POSITIVO','Reactivo (Positivo)','No Reactivo (Negativo)'),'ANTIGENO COVID-19', dbo.FNK_FECHA_SIN_MLS(GETDATE()) ,'' ,@IDSERVICIO, '', '' ,'' ,'', '1017'
                  --LEN(@CELULAR)=9
                  UPDATE HTX SET RESULTADO = 'PROCESADO' WHERE CNSHTX = @CNSHTX

		            SELECT @CELULAR = CASE WHEN  CELULAR IS NULL THEN TELEFONORES WHEN CELULAR IS NOT NULL THEN CELULAR  END
		            FROM AFI WHERE IDAFILIADO = @IDAFILIADO

		            SELECT @NVOCONSEC NOINGRESO, @CELULAR CELULAR, 'OK' OK, @IDSERVICIO EXAMEN
 		            RETURN
               END
               IF @IDSERVICIO = 'EXA00606'
               BEGIN
		            
                  UPDATE HTX SET RESULTADO = 'PROCESADO' WHERE CNSHTX = @CNSHTX

                  --SELECT  @DIASEDAD=  Convert(Integer, Datediff(Day, FNACIMIENTO, Getdate()))  FROM AFI WHERE  IDAFILIADO = @IDAFILIADO

		            SELECT @CELULAR = CASE WHEN  CELULAR IS NULL THEN TELEFONORES WHEN CELULAR IS NOT NULL THEN CELULAR  END
		            FROM AFI WHERE IDAFILIADO = @IDAFILIADO

		            SELECT @NVOCONSEC NOINGRESO, @CELULAR CELULAR, 'OK' OK, @IDSERVICIO EXAMEN
		            RETURN
               END
  
            END TRY
         BEGIN CATCH
            INSERT INTO @TBLERRORES(ERROR) SELECT ERROR_MESSAGE();
         END CATCH
         IF(SELECT COUNT(*) FROM @TBLERRORES)>0
         BEGIN
            SELECT 'KO' OK
            SELECT ERROR FROM @TBLERRORES
            RETURN
         END
         SELECT 'OK' OK
      END
   END
   IF @METODO = 'LX_ACTUALIZARDOCS'
   BEGIN
	  SELECT @NOINGRESO     = NOINGRESO
            ,@DOCUMENTOID  = DOCUMENTOID
			   ,@IDAFILIADO   = IDAFILIADO
            ,@CNSHTX       = CNSHTX
      FROM OPENJSON(@PARAMETROS)
      WITH( NOINGRESO   VARCHAR(20)   '$.NOINGRESO'
           ,DOCUMENTOID VARCHAR(40)   '$.DOCUMENTOID'
           ,IDAFILIADO  VARCHAR(16)   '$.IDAFILIADO'
           ,CNSHTX      VARCHAR(20)   '$.CNSHTX'
           )
           
	  SELECT @NOMBREAFI = CONCAT(PNOMBRE,'_',SNOMBRE,'_',DOCIDAFILIADO,'_',@NOINGRESO)FROM AFI WHERE IDAFILIADO = @IDAFILIADO

	  UPDATE DOCS
        SET DocNombre    = @NOMBREAFI
          , DocExtension = '.jpeg'
		  , DocUsuario   = @USUARIO
      WHERE DocumentoID  = @DOCUMENTOID

	  UPDATE LING
	  SET	 DOCUMENTOID = @DOCUMENTOID
	  WHERE  NOINGRESO   = @NOINGRESO

     IF COALESCE(@NOINGRESO,'') = ''
     BEGIN
      UPDATE DOCS SET DocConsecutivo = @CNSHTX WHERE DocumentoID = @DOCUMENTOID
     END
	  RETURN
   END
   IF @METODO = 'ZONAS'
   BEGIN
		SELECT CIT.IDMEDICO value,CONCAT( NOMBRE ,' - ',CASE WHEN CIT.IDSEDE = '01' THEN 'LIMA'WHEN CIT.IDSEDE = '20' THEN 'AREQUIPA' END) label FROM MED 
      INNER JOIN CIT ON MED.IDMEDICO = CIT.IDMEDICO
      INNER JOIN SED ON CIT.IDSEDE =  SED.IDSEDE
      WHERE TIPO_USUARIO ='Tmuestra' AND NOMBRE LIKE '%ZONA%'
      GROUP BY CIT.IDMEDICO, NOMBRE, CIT.IDSEDE
   END
   IF @METODO = 'DIAS_ZONA'
   BEGIN
		SELECT @IDMEDICO = IDMEDICO FROM OPENJSON(@PARAMETROS) WITH(IDMEDICO VARCHAR(16) '$.IDMEDICO')
		SELECT CONVERT(VARCHAR,CIT.FECHA,111)DIAS
		FROM [dbo].[CIT] 
      LEFT JOIN SED ON CIT.IDSEDE = SED.IDSEDE
		WHERE  
			CONVERT(DATE,CIT.FECHA) >= CONVERT(DATE,GETDATE())  
		AND COALESCE(CIT.IDAFILIADO,'') = ''  
		AND CIT.IDMEDICO = @IDMEDICO --'SUR'
		GROUP BY CONVERT(VARCHAR,CIT.FECHA,111)
   END
   IF @METODO = 'HORAS_ZONA'
   BEGIN
	DECLARE @DIA DATE
	SELECT @IDMEDICO = IDMEDICO, @DIA = DIA FROM OPENJSON(@PARAMETROS) 
	WITH(IDMEDICO VARCHAR(16) '$.IDMEDICO', DIA DATE '$.DIA' )
   --		SELECT CONCAT( CONVERT(VARCHAR(10),CONVERT(TIME,CIT.FECHA),108) ,' - ',CASE WHEN CIT.IDSEDE = '01' THEN 'LIMA'WHEN CIT.IDSEDE = '20' THEN 'AREQUIPA' END) AS label, CIT.CONSECUTIVO as HORAS, CIT.CONSECUTIVO

		SELECT CONCAT( CONVERT(VARCHAR(10),CONVERT(TIME,CIT.FECHA),108) ,' - ',CASE WHEN CIT.IDSEDE = '01' THEN 'LIMA'WHEN CIT.IDSEDE = '20' THEN 'AREQUIPA' END) AS HORAS, CIT.CONSECUTIVO
		FROM [dbo].[CIT] 
      LEFT JOIN SED ON CIT.IDSEDE = SED.IDSEDE
		WHERE  
			CONVERT(DATE,CIT.FECHA) = CONVERT(DATE,@DIA)  
		AND COALESCE(CIT.IDAFILIADO,'') = ''  
		AND CIT.IDMEDICO = @IDMEDICO

   END
   IF @METODO = 'DATOS_AFI'
   BEGIN
		SELECT @IDAFILIADO = IDAFILIADO FROM OPENJSON(@PARAMETROS)WITH(IDAFILIADO VARCHAR(16) '$.IDAFILIADO')
		SELECT AFI.CIUDAD, AFI.CORREGIMIENTO DISTRITO, DIRECCION, COALESCE(CELULAR,'')CELULAR, COALESCE(EMAIL,'')EMAIL
			 , CIU.NOMBRE NOMBRECIU
			 , COALESCE(TGEN.DESCRIPCION,'SIN')DESCDISTRITO
		FROM AFI
		LEFT JOIN CIU ON AFI.CIUDAD = CIU.CIUDAD
		LEFT JOIN TGEN ON AFI.CORREGIMIENTO = TGEN.CODIGO AND TGEN.TABLA = 'CORREGIMIENTOS'
		WHERE IDAFILIADO = @IDAFILIADO 
		RETURN
   END
   IF @METODO = 'ASIGNA_VALOR'
   BEGIN
	   SELECT * INTO #SERVICIOS FROM OPENJSON (@PARAMETROS)
	   WITH( 
			IDAFILIADO	VARCHAR(20)		'$.IDAFILIADO', 
			IDSERVICIO	VARCHAR(10)		'$.value', 
			VALORTOTAL	DECIMAL(16,4)	'$.VALORTOTAL', 
			CNSHTX		VARCHAR(20)		'$.CNSHTX' 
	   )
	   ALTER TABLE #SERVICIOS ADD ITEM INT IDENTITY
	   SELECT @VALOR = SUM(VALORTOTAL) FROM #SERVICIOS 
	   SELECT @IDPLAN = HTX.IDPLAN, @IDAFILIADO = S1.IDAFILIADO, @CONSECUTIVO = HTX.CONSECUTIVO_CIT FROM #SERVICIOS S1 INNER JOIN HTX ON HTX.CNSHTX = S1.CNSHTX AND S1.ITEM = 1
	   IF COALESCE(@VALOR,0)>0
	   BEGIN
		INSERT INTO KPAGE(CONSECUTIVO, TABLA, PROCEDENCIA, FECHAGEN,MODO, VALOR, ESTADO,USUCOBRA, IDPLAN)
		SELECT @IDAFILIADO, 'CIT','COMERCIAL', CONVERT(SMALLDATETIME,GETDATE()),'PRODUCTION', @VALOR, 'CREATED',@USUARIO, @IDPLAN
		SELECT @IDKPAGE = @@IDENTITY
		UPDATE CIT SET IDKPAGE = @IDKPAGE, VALORCOPAGO = @VALOR WHERE CONSECUTIVO = @CONSECUTIVO
	   END
	   RETURN
   END
   IF @METODO = 'GEN_ENLACE'
   BEGIN
		SELECT @CONSECUTIVO = CONSECUTIVO FROM OPENJSON(@PARAMETROS)
		WITH( CONSECUTIVO		VARCHAR(20)		'$.CONSECUTIVO' )

		SELECT @IDAFILIADO = IDAFILIADO
			  ,@FECHA      = FECHA 
			  ,@IDKPAGE    = IDKPAGE
		FROM CIT WHERE CONSECUTIVO = @CONSECUTIVO

		SELECT @VALORCOP = COALESCE (VALOR, 0) FROM KPAGE WHERE IDKPAGE = @IDKPAGE
		BEGIN TRY  
			SELECT @EMAIL = LTRIM(RTRIM(COALESCE(EMAIL,'EXPERTTA@EXPERTTA.COM.PE')))
				 , @CELULAR = LTRIM(RTRIM(CELULAR))
				 , @NOMBREAFI = CONCAT(PNOMBRE,' ',PAPELLIDO) 
			FROM AFI WHERE IDAFILIADO = @IDAFILIADO
	
			SELECT @FECHA = GETDATE()+1

			SELECT @DIA1 = CONVERT(VARCHAR, @FECHA,3)
				 , @MES  = CONVERT(VARCHAR, @FECHA,1)
				 , @ANIO = CONVERT(VARCHAR, @FECHA,23)
				 , @HORA = CONVERT(VARCHAR, @FECHA,8)

			SELECT @DATE = @ANIO+'-'+@MES+'-'+@DIA1+'T'+@HORA

			SELECT @BODY =' {"amount": '+
								REPLACE(REPLACE(CONVERT(varchar(50), CAST(@VALORCOP AS money), 1),'.',''),',','')+
							', "currency": "PEN", "orderId": "'+CONVERT(VARCHAR,@IDKPAGE)+
							'", "channelOptions": {"channelType": "URL", "mailOptions": { "recipient": "'+
							@EMAIL+'"}},"paymentReceiptEmail": "'+@EMAIL+'","expirationDate": "'+@DATE+'+05:00","dataCollectionForm": "false"} '
			PRINT '@DATE:' + @DATE 
			PRINT '@BODY: ' + @BODY
		END TRY  
		BEGIN CATCH  
		    INSERT INTO @ERRORES(ERROR) SELECT ERROR_MESSAGE() 

			IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
			BEGIN
					SELECT 'KO' OK
					SELECT ERROR FROM @TBLERRORES
				RETURN
			END 
		END CATCH

		BEGIN TRY 
			BEGIN
				EXEC sys.sp_OACreate 'MSXML2.ServerXMLHttp', @obj OUT
				EXEC sys.sp_OAMethod @obj, 'Open', NULL, 'POST', @sUrl, false
				EXEC sys.sp_OAMethod @Obj, 'setRequestHeader', null, 'Authorization', @BASIC 
				EXEC sys.sp_OAMethod @Obj, 'setRequestHeader', null, 'Content-Type', 'application/json'
				EXEC sys.sp_OAMethod @Obj, 'setRequestHeader', null, 'Accept', 'application/json'
				EXEC SYS.sp_OAMethod @obj, 'send', null, @Body
				EXEC sys.sp_OAMethod @obj, 'responseText', @response OUTPUT
				IF @response IS NULL
				BEGIN
					DECLARE @TABLA_TMP AS TABLE (ITEM INT IDENTITY(1,1), RESPONSE VARCHAR(MAX))
					INSERT INTO @TABLA_TMP(RESPONSE)
					EXEC sys.sp_OAGetProperty @obj, 'responseText'
					SELECT @response=RESPONSE FROM @TABLA_TMP
				END

				EXEC sys.sp_OADestroy @obj
			
				select @RESPUESTA = [status], @ANSWER = answer  from openjson (@response) with (status varchar(20) '$.status', answer	NVARCHAR(MAX) AS JSON)

				UPDATE KPAGE SET BODY = @response WHERE IDKPAGE = @IDKPAGE	

				IF @RESPUESTA = 'ERROR'
				BEGIN
					INSERT INTO @TBLERRORES(ERROR)
					SELECT CONCAT(errorMessage,': ',detailedErrorMessage) FROM OPENJSON(@ANSWER)WITH(
						errorCode				VARCHAR(30)		'$.errorCode',
						errorMessage			VARCHAR(100)	'$.errorMessage',
						detailedErrorMessage	VARCHAR(200)	'$.detailedErrorMessage'
					)
				END

				IF @RESPUESTA = 'SUCCESS'
				BEGIN
					SELECT @urlpago = paymentURL, @paymentOrderId = paymentOrderId FROM OPENJSON( @ANSWER ) with ( paymentURL VARCHAR(100) '$.paymentURL', paymentOrderId  varchar(40) '$.paymentOrderId' )
					UPDATE KPAGE SET ESTADO='SEND',RESPUESTA = @ANSWER, paymentOrderId = @paymentOrderId WHERE IDKPAGE = @IDKPAGE	
				END
			END
		END TRY  
		BEGIN CATCH  
		    INSERT INTO @ERRORES(ERROR) SELECT ERROR_MESSAGE() 
			IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
			BEGIN
					SELECT 'KO' OK
					SELECT ERROR FROM @TBLERRORES
				RETURN
			END 
		END CATCH

		IF (SELECT COUNT(*) FROM @TBLERRORES)> 0
		BEGIN
				SELECT 'KO' OK
				SELECT ERROR FROM @TBLERRORES
			RETURN
		END 

		IF (SELECT COUNT(*) FROM @TBLERRORES) < 1
		BEGIN
				SELECT 'OK' OK
			RETURN
		END 
   END
   IF @METODO = 'VALIDA_ENLACE'
   BEGIN
	SELECT @IDKPAGE = CONSECUTIVO FROM OPENJSON(@PARAMETROS)WITH(CONSECUTIVO INT '$.CONSECUTIVO')

	SELECT @paymentOrderId = paymentOrderId FROM KPAGE WHERE IDKPAGE = @IDKPAGE
	SELECT @Body =' {"paymentOrderId": "'+@paymentOrderId+'"} ' 
	SELECT @sUrl  = 'https://api.micuentaweb.pe/api-payment/V4/Charge/PaymentOrder/Get'
	BEGIN
		EXEC sys.sp_OACreate 'MSXML2.ServerXMLHttp', @obj OUT
		EXEC sys.sp_OAMethod @obj, 'Open', NULL, 'POST', @sUrl, false
		EXEC sys.sp_OAMethod @Obj, 'setRequestHeader', null, 'Authorization', @BASIC
		EXEC sys.sp_OAMethod @Obj, 'setRequestHeader', null, 'Content-Type', 'application/json'
		EXEC sys.sp_OAMethod @Obj, 'setRequestHeader', null, 'Accept', 'application/json'
		EXEC SYS.sp_OAMethod @obj, 'send', null, @Body
		EXEC sys.sp_OAMethod @obj, 'responseText', @response OUTPUT
		IF @response IS NULL
		BEGIN
			DECLARE @TABLA_TMP1 AS TABLE (ITEM INT IDENTITY(1,1), RESPONSE VARCHAR(MAX))
			INSERT INTO @TABLA_TMP1(RESPONSE)
			EXEC sys.sp_OAGetProperty @obj, 'responseText'
			SELECT @response=RESPONSE FROM @TABLA_TMP1
		END
		EXEC sys.sp_OADestroy @obj
		PRINT '@response: '+@response

		SELECT @RESPUESTA = [status] FROM OPENJSON (@response) WITH (status VARCHAR(20) '$.status')
		PRINT '@RESPUESTA: '+@RESPUESTA
		IF @RESPUESTA = 'SUCCESS'
		BEGIN
			PRINT 'SUCCESS'
			SELECT @answer = answer FROM OPENJSON(@response) WITH( answer NVARCHAR(MAX) AS JSON )
			SELECT @paymentOrderStatus = paymentOrderStatus FROM OPENJSON(@answer) WITH ( paymentOrderStatus VARCHAR(40) '$.paymentOrderStatus')
			SELECT @DatoBolFac	= (SELECT CASE WHEN TIPOFACTURA IS NULL  THEN  'B'  ELSE  TIPOFACTURA END [TIPOFACTURA]  FROM KPAGE WHERE IDKPAGE = @IDKPAGE ) 
			UPDATE KPAGE SET ESTADO = @paymentOrderStatus, FECHARES = CONVERT(SMALLDATETIME,GETDATE()), RESPUESTA = @answer, TIPOFACTURA= @DatoBolFac WHERE IDKPAGE = @IDKPAGE

			IF @paymentOrderStatus = 'PAID'
			BEGIN
				SELECT @VALORCOP = VALOR  FROM KPAGE WHERE IDKPAGE = @IDKPAGE

				INSERT INTO KPAGED(IDKPAGE, ITEM, TIPO, CLASE, OBSERVACION, VALOR)
				SELECT @IDKPAGE,1,'Link Pago', '','Pago por Enlace', @VALORCOP

				SELECT @paymentOrderStatus ESTADO
				RETURN
			END
			ELSE 
			BEGIN
				UPDATE KPAGE SET ESTADO = @paymentOrderStatus WHERE IDKPAGE = @IDKPAGE
				SELECT @paymentOrderStatus ESTADO
				RETURN
			END
		END
		ELSE SELECT 'ERROR'ESTADO RETURN
	END
   END
   IF @METODO = 'ENVIAR_ENLACE'
   BEGIN
	SELECT @IDAFILIADO = IDAFILIADO, @IDKPAGE = IDKPAGE FROM OPENJSON(@PARAMETROS)WITH( IDAFILIADO VARCHAR(20) '$.IDAFILIADO', IDKPAGE INT '$.IDKPAGE')

	SELECT @CELULAR = LTRIM(RTRIM(CELULAR)) FROM AFI WHERE IDAFILIADO = @IDAFILIADO

	SELECT @BODY = BODY, @response = RESPUESTA FROM KPAGE WHERE IDKPAGE = @IDKPAGE

	SELECT @STATUS = status
			, @ANSWER = answer 
	FROM OPENJSON(@BODY)
	WITH(
		status	VARCHAR(20)   '$.status', 
		answer	NVARCHAR(MAX) AS JSON
	)
	SELECT @urlpago = paymentURL FROM OPENJSON(@response)WITH(
		paymentURL				VARCHAR(50)		'$.paymentURL',
		paymentOrderStatus		VARCHAR(30)		'$.paymentOrderStatus',
		expirationDate			VARCHAR(30)		'$.expirationDate',
		orderId					INT				'$.orderId'
	)
	IF LEN(@CELULAR)=9
	BEGIN
		SELECT @MENSAJE = 'Gracias por atenderte con Expertta, a continuaci? el enlace para que realices el pago: ' + @urlpago
		print @mensaje
		EXEC DBO.SPK_SEND_WHATSAPP @CELULAR, @MENSAJE
		SELECT 'OK'OK
	END
	ELSE
	BEGIN
		SELECT 'KO'OK
		SELECT 'Hubo un error con el n?ero celular.'ERROR
	END

   END
   IF @METODO = 'AGREGARPROVEEDOR'
	BEGIN
		SELECT @RUC = RUC , @RAZONSOCIAL=RAZONSOCIAL,  @DIRECCION = DIRECCION , @TELEFONOS = TELEFONOS, @CORREO = CORREO
		FROM OPENJSON (@PARAMETROS) WITH ( RUC			VARCHAR(11)		'$.RUC'
										  ,RAZONSOCIAL	VARCHAR(100)	'$.RAZONSOCIAL'
										  ,DIRECCION	VARCHAR(100)	'$.DIRECCION'
										  ,TELEFONOS	VARCHAR(20)		'$.TELEFONOS'
										  ,CORREO		VARCHAR(100)	'$.CORREO'	)
	
		SELECT @NVOCONSEC = NULL 
		EXEC SPK_GENCONSECUTIVO '01', '01', '@AFI',  @NVOCONSEC OUTPUT  
		SELECT @NVOCONSEC = '01' +  REPLACE(SPACE(8 - LEN(@NVOCONSEC))+LTRIM(RTRIM(@NVOCONSEC)),SPACE(1),0)
		--SELECT TOP 500 * FROM TER WHERE RAZONSOCIAL LIKE '%HOLA SAC%'
		IF (SELECT COUNT(*) FROM TER WHERE NIT =  LTRIM(RTRIM(@RUC))) = 0
		BEGIN
			INSERT INTO TER (IDTERCERO,RUC, RAZONSOCIAL, DIRECCION,TELEFONOS, EMAIL, NIT, TIPO_ID, CIUDAD, USUCREA, FECHACREA)
			SELECT @NVOCONSEC, @RUC, @RAZONSOCIAL,@DIRECCION, @TELEFONOS, @CORREO, @RUC, 'RUC', '41401', @USUARIO , GETDATE()
			SELECT @NVOCONSEC = (SELECT IDTERCERO FROM  TER WHERE RUC = @RUC)
		END

		IF EXISTS (SELECT 1 FROM TER WHERE IDTERCERO=@NVOCONSEC)
		BEGIN
			SELECT 'OK'RESULTADO
		END
		ELSE
		BEGIN
			SELECT 'KO'RESULTADO
		END
	END
   IF @METODO = 'AGREGARUC'
	BEGIN
		SELECT  @RUC = RUC , @IDTERCERO =  IDTERCERO FROM OPENJSON (@PARAMETROS) WITH ( RUC VARCHAR(11) '$.RUC',IDTERCERO VARCHAR(100) '$.IDTERCERO')
		UPDATE  TER SET RUC = @RUC  WHERE IDTERCERO = @IDTERCERO
		IF EXISTS (SELECT 1 FROM TER WHERE IDTERCERO=@IDTERCERO)
		BEGIN
			SELECT 'OK'RESULTADO
		END
		ELSE
		BEGIN
			SELECT 'KO'RESULTADO
		END
	END
   IF @METODO = 'UNIRPAGO'-- 
	BEGIN
		SELECT @CONSECUTIVO = CONSECUTIVO  FROM OPENJSON (@PARAMETROS) WITH (CONSECUTIVO VARCHAR(20) '$.CONSECUTIVO')

		DECLARE @NOADMISION_IDKPAGE VARCHAR (20), @NOPRESTACION_IDKPAGE VARCHAR (20), @NOITEMMAX VARCHAR (5), @IDKPAGE22 VARCHAR (10)

		SELECT @IDKPAGE22 = (SELECT IDKPAGE FROM CIT WHERE  CONSECUTIVO = @CONSECUTIVO)
		SELECT @NOPRESTACION = (SELECT NOPRESTACION FROM HTX WHERE  CONSECUTIVO_CIT =@CONSECUTIVO )
		SELECT @NOADMISION = (SELECT NOADMISION FROM CIT WHERE  CONSECUTIVO = @CONSECUTIVO)
		SELECT @NOITEMMAX =( SELECT TOP 1 NOITEM FROM HPRED WHERE NOPRESTACION = @NOPRESTACION ORDER BY  NOITEM DESC)

		UPDATE HTX  SET NOPRESTACION = @NOPRESTACION   WHERE CONSECUTIVO_CIT IN (SELECT CONSECUTIVO FROM CIT WHERE IDKPAGE = @IDKPAGE22)
		UPDATE HPRED  SET NOPRESTACION = @NOPRESTACION , NOITEM = @NOITEMMAX +1 WHERE NOPRESTACION IN (SELECT NOPRESTACION FROM HPRE WHERE  NOADMISION IN (SELECT NOADMISION FROM CIT WHERE  IDKPAGE = @IDKPAGE22 )AND NOPRESTACION <> @NOPRESTACION)

		IF EXISTS (SELECT 1 FROM KPAGE WHERE IDKPAGE = @IDKPAGE22)
		BEGIN
			SELECT 'OK'RESULTADO
		END
		ELSE
		BEGIN
			SELECT 'KO'RESULTADO
		END
			SELECT TOP 1000 * FROM KPAGE WHERE IDKPAGE = @IDKPAGE22
   END
END

