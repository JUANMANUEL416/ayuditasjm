

SELECT * FROM FCXCD INNER JOIN FCXC ON FCXCD.CNSCXC=FCXC.CNSCXC WHERE N_FACTURA IN(SELECT  N_FACTURA FROM #A)
AND FCXC.INDRECIBIDO=0

BEGIN TRAN 
DELETE FCXCD FROM FCXCD INNER JOIN FCXC ON FCXCD.CNSCXC=FCXC.CNSCXC WHERE N_FACTURA IN(SELECT  N_FACTURA FROM #A)
AND FCXC.INDRECIBIDO=0
COMMIT

UPDATE FTR SET INDCXC=0 WHERE N_FACTURA IN(SELECT  N_FACTURA FROM #A WHERE  NOT EXISTS(SELECT * FROM FCXCD WHERE #A.N_FACTURA=FCXCD.N_FACTURA))

SELECT 'EXEC SPK_ANULA_FACT '''+N_FACTURA+''',''01'','''+IDSEDE+''','''+USUARIOFACTURA+''',''NO SE ENVIO A LA DIAN'',''SOPORTE'',''SOPORTE''' FROM FTR WHERE N_FACTURA IN(SELECT  N_FACTURA FROM #A WHERE  NOT EXISTS(SELECT * FROM FCXCD WHERE #A.N_FACTURA=FCXCD.N_FACTURA))


