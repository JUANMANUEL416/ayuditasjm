IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'SPK_RIPS_CXC_ASIS' AND XTYPE='P')
BEGIN
   DROP PROC SPK_RIPS_CXC_ASIS
END
GO
CREATE PROCEDURE DBO.SPK_RIPS_CXC_ASIS
@ENVIO     VARCHAR(20),
@IDSGSSS   VARCHAR(20),
@DPRRS     VARCHAR(120),
@DPRNIT    VARCHAR(20),
@IDTERCERO VARCHAR(20)=NULL
WITH ENCRYPTION
AS 
DECLARE @FECHAINICIAL DATETIME
DECLARE @FECHAFINAL   DATETIME
DECLARE @IDPLAN       VARCHAR(6)
-- AP
DECLARE @NUMFACTURA         VARCHAR(20)
DECLARE @TIPO_DOC           VARCHAR(2)
DECLARE @IDUSUARIO          VARCHAR(20)
DECLARE @FECHAPROCEDIMIENTO DATETIME
DECLARE @NUMAUT             VARCHAR(15)
DECLARE @IDPROCEDIMIENTO    VARCHAR(12)
DECLARE @AMBITO             VARCHAR(1)
DECLARE @FINPROCEDIMIENTO   VARCHAR(2)
DECLARE @PERSONALA          VARCHAR(1)
DECLARE @DXPPAL             VARCHAR(4)
DECLARE @DXREL              VARCHAR(4)
DECLARE @COMPLICACION       VARCHAR(4)
DECLARE @ACTOQ              VARCHAR(1)
DECLARE @VALORPROCED        DECIMAL(14,2)
DECLARE @NOPRESTACION       VARCHAR(16)
DECLARE @NOITEM             VARCHAR(3)-- CAMBIO TRUNCAMIENTO RIPS AP 
DECLARE @CANTIDAD           INT
DECLARE @CANT               INT
DECLARE @TIPOBUSQUEDA       VARCHAR(10)
DECLARE @IDTARIFA           VARCHAR(5)
DECLARE @CNSFTR             VARCHAR(40)
DECLARE @N_CUOTA            INT
DECLARE @IDSERVICIO         VARCHAR(20)
DECLARE @IDDX               VARCHAR(10)
DECLARE @ESTADO             VARCHAR(2)
DECLARE @CODEVAL            VARCHAR(20)
DECLARE @OK                 INT
DECLARE @CAUSAEXT           VARCHAR(2)
DECLARE @DXREL2             VARCHAR(4)
DECLARE @DXREL3             VARCHAR(4)
DECLARE @VALORCOP           DECIMAL(14,2)
DECLARE @VALORTOT           DECIMAL(14,2)
DECLARE @FORMATORIPS        VARCHAR(20)
DECLARE @RIPS_COPAGOS       VARCHAR(20)
DECLARE @IDPROTERQXRIPS     VARCHAR(20)
DECLARE @RRIPS_AP_TODOSCONDX VARCHAR(20)
DECLARE @RIPS_PROCESOAP     VARCHAR(20)
DECLARE @RIPS_VALORENTERO   VARCHAR(20)
DECLARE @IDMEDPOSRIPS       VARCHAR(20)
DECLARE @RIPS_AM_DATOSMEDPOS VARCHAR(20)
DECLARE @RIPS_AGRUPADOS     VARCHAR(20)
DECLARE @RIPS_FEHAINIFINAL  VARCHAR(20)
DECLARE @RIPS_COPAGOS_FTR   VARCHAR(20)
DECLARE @PRE_OXIGENO        VARCHAR(20)
DECLARE @RIPS_VALOR_CX      VARCHAR(20)
DECLARE @CODSER				VARCHAR(20)
DECLARE @RIPSNOCOBRABLE		VARCHAR(20)
DECLARE @RIPS_DXEGRESO		VARCHAR(20)
DECLARE @RIPS_IDCONTRATO    VARCHAR(2)
DECLARE @IDMATERIALESRIPS   VARCHAR(2)
DECLARE @IDHONORARIOSRIPS   VARCHAR(2)
DECLARE @IDDERECHOSALARIPS  VARCHAR(2)
DECLARE @PLANBENEFICIO      VARCHAR(2)
DECLARE @PIDEAUTORIZAFACCORTE VARCHAR(2)

BEGIN 
   
   SELECT @ESTADO = ESTADO FROM RIPS WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO
   IF @ESTADO <> '01'
   BEGIN
      RAISERROR('ENVIO EN ESTADO DIFERENTE DE 01 ', 16,1)
      RETURN
   END
   
   SELECT @IDTERCERO = (CASE WHEN @IDTERCERO IS NULL THEN IDTERCERO ELSE @IDTERCERO END), 
      @FECHAINICIAL = FECHAINICIAL, @FECHAFINAL = FECHAFINAL, @IDPLAN = IDPLAN
   FROM   RIPS 
   WHERE  ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO

   SET @RIPSNOCOBRABLE      = DBO.FNK_VALORVARIABLE('NOCOBRAENRIPS')
   SET @RIPS_COPAGOS        = DBO.FNK_VALORVARIABLE('RIPS_COPAGOS')
   SET @IDPROTERQXRIPS      = DBO.FNK_VALORVARIABLE('IDPROTERQXRIPS')
   SET @RRIPS_AP_TODOSCONDX = DBO.FNK_VALORVARIABLE('RRIPS_AP_TODOSCONDX')
   SET @RIPS_PROCESOAP      = DBO.FNK_VALORVARIABLE('RIPS_PROCESOAP')
   SET @RIPS_VALORENTERO    = DBO.FNK_VALORVARIABLE('RIPS_VALORENTERO')
   SET @IDMEDPOSRIPS        = DBO.FNK_VALORVARIABLE('IDMEDPOSRIPS')
   SET @RIPS_AM_DATOSMEDPOS = DBO.FNK_VALORVARIABLE('RIPS_AM_DATOSMEDPOS')
   SET @RIPS_AGRUPADOS      = DBO.FNK_VALORVARIABLE('RIPS_AGRUPADOS')
   SET @RIPS_FEHAINIFINAL   = DBO.FNK_VALORVARIABLE('RIPS_FEHAINIFINAL')
   SET @RIPS_COPAGOS_FTR    = DBO.FNK_VALORVARIABLE('RIPS_COPAGOS_FTR')
   SET @PRE_OXIGENO         = DBO.FNK_VALORVARIABLE('PREFIJOOXIGENO')
   SET @RIPS_DXEGRESO	    = DBO.FNK_VALORVARIABLE('RIPS_DXEGRESO')
   SET @RIPS_IDCONTRATO	    = DBO.FNK_VALORVARIABLE('RIPS_IDCONTRATO')
   SET @IDMATERIALESRIPS    = DBO.FNK_VALORVARIABLE('IDMATERIALESRIPS')
   SET @IDHONORARIOSRIPS    = DBO.FNK_VALORVARIABLE('IDHONORARIOSRIPS')
   SET @IDDERECHOSALARIPS   = DBO.FNK_VALORVARIABLE('IDDERECHOSALARIPS')
   SET @PLANBENEFICIO       = DBO.FNK_VALORVARIABLE('MANEJA_PLANBENEFICIO') 
   SET @PIDEAUTORIZAFACCORTE= DBO.FNK_VALORVARIABLE('PIDEAUTORIZAFACCORTE')   -- STORRES

   IF ISNULL(@IDPLAN,'')=''
   BEGIN
	  SELECT @IDPLAN=IDPLAN FROM FTR WHERE N_FACTURA=(SELECT TOP 1 N_FACTURA FROM RIPSD WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO)
   END
   
   IF (SELECT COALESCE(RIPS.CODMEDICAMENTO,'') FROM RIPS WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO)=''
   BEGIN
		IF ISNULL(@IDPLAN,'')=''
			SELECT TOP 1 @FORMATORIPS=TIPORIPS, @RIPS_VALOR_CX=RIPS_VALOR_CX FROM PPT WHERE IDTERCERO=@IDTERCERO AND ESTADO='Activo'
		ELSE
			SELECT @FORMATORIPS=TIPORIPS, @RIPS_VALOR_CX=RIPS_VALOR_CX FROM PPT WHERE IDTERCERO=@IDTERCERO AND IDPLAN=@IDPLAN
   END
   ELSE
   BEGIN
	    SELECT @FORMATORIPS=RIPS.CODMEDICAMENTO FROM RIPS WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO
        
		IF ISNULL(@IDPLAN,'')=''
			SELECT TOP 1 @RIPS_VALOR_CX=RIPS_VALOR_CX FROM PPT WHERE IDTERCERO=@IDTERCERO AND ESTADO='Activo'
		ELSE
			SELECT @RIPS_VALOR_CX=RIPS_VALOR_CX FROM PPT WHERE IDTERCERO=@IDTERCERO AND IDPLAN=@IDPLAN
   END

   IF COALESCE(@RIPS_VALOR_CX,'')='AP'
      SET @RIPS_PROCESOAP='SI'
   IF COALESCE(@RIPS_VALOR_CX,'')='AT'
      SET @RIPS_PROCESOAP='NO'


   IF (SELECT COALESCE(RIPS.CODSERVICIO,'') FROM RIPS WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO)=''
   BEGIN 
   	   IF ISNULL(@IDPLAN,'')=''
		  SELECT TOP 1 @CODSER=IMPRIMEIDALTERNA FROM PPT WHERE IDTERCERO=@IDTERCERO AND ESTADO='Activo'
	   ELSE
		  SELECT @CODSER=IMPRIMEIDALTERNA FROM PPT WHERE IDTERCERO=@IDTERCERO AND IDPLAN=@IDPLAN

		  IF @CODSER='9' SELECT @CODSER='8'
   END
   ELSE
   BEGIN
	  SELECT @CODSER=COALESCE(RIPS.CODSERVICIO,'') FROM RIPS WHERE ENVIO=@ENVIO	AND IDTERCERO=@IDTERCERO 
   END
   
   
   -- AD   
   BEGIN TRAN
   PRINT 'AD'
   INSERT INTO RRIPS_AD ( ENVIO, IDTERCERO, NUMFACTURA, IDPRESTADOR, CODCONCEPTO, CANTIDAD, VALORUNITARIO, TOTALCONCEPTO )
   SELECT @ENVIO, @IDTERCERO, RIPSD.N_FACTURA, @IDSGSSS, SER.CODIGORIPS, SUM(FTRD.CANTIDAD), 
          CASE @RIPS_COPAGOS WHEN 'NO' THEN SUM(FTRD.VALOR)
               ELSE SUM( CASE WHEN COALESCE(FTRD.PAQUETE,0)=2 THEN 0 ELSE (FTRD.VALOR * FTRD.CANTIDAD)/(CASE FTRD.CANTIDAD WHEN 0 THEN 1 ELSE FTRD.CANTIDAD END) END )
          END,              
          SUM(CASE WHEN COALESCE(FTRD.PAQUETE,0)=2 THEN 0 ELSE FTRD.VALOR * FTRD.CANTIDAD END)
   FROM   RIPSD INNER JOIN FTRD  ON RIPSD.N_FACTURA    = FTRD.N_FACTURA
                INNER JOIN HPRED ON FTRD.NOPRESTACION  = HPRED.NOPRESTACION AND FTRD.NOITEM = HPRED.NOITEM
                INNER JOIN HPRE  ON HPRED.NOPRESTACION = HPRE.NOPRESTACION
                INNER JOIN HADM  ON HPRE.NOADMISION    = HADM.NOADMISION
                 LEFT JOIN SER   ON HPRED.IDSERVICIO   = SER.IDSERVICIO
                 LEFT JOIN AFI   ON HADM.IDAFILIADO    = AFI.IDAFILIADO
                 LEFT JOIN PRE   ON SER.PREFIJO        = PRE.PREFIJO
   WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
   AND    RIPSD.PROCEDENCIA = 'SALUD' 
   AND    COALESCE(COALESCE(FTRD.ITFC,0),0)         <> 2   
   GROUP BY RIPSD.N_FACTURA, SER.CODIGORIPS
   IF @@ERROR <> 0 
   BEGIN 
      ROLLBACK
      RAISERROR('ERROR EN AD', 16, 1)
      RETURN
   END 
   COMMIT




   -- AC
   BEGIN TRAN
   PRINT 'AC'  
   /*SEPARACION DE CONSULTAS*/
   DECLARE AC_CURSOR CURSOR FOR  
   SELECT RIPSD.N_FACTURA, LEFT(AFI.TIPO_DOC,2), AFI.DOCIDAFILIADO, 
          CASE WHEN HPRE.FECHA < HADM.FECHA THEN HADM.FECHA
               WHEN HPRE.FECHA > HADM.FECHAALTA THEN HADM.FECHAALTA
               ELSE HPRE.FECHA
          END,  
          CASE WHEN COALESCE(FTR.VENDEDOR,'')<>'' THEN LEFT(COALESCE(FTR.VENDEDOR,''),15) ELSE  LEFT(HADM.NOAUTORIZACION,15) END , 
		 CASE @CODSER WHEN '0' THEN LEFT(SER.IDSERVICIO,6) WHEN '1' THEN LEFT(SER.IDALTERNA,6) WHEN '8' THEN LEFT(SER.CODCUPS,6) ELSE LEFT(SER.IDALTERNA,6) END,
          CASE WHEN ISNULL(HPRE.FINALIDAD,'') ='' OR ISNULL(HPRE.FINALIDAD,'') ='1'THEN '10' ELSE HPRE.FINALIDAD END, HADM.CAUSAEXTERNA, IIF(@RIPS_DXEGRESO='SI',UPPER(HADM.DXEGRESO),UPPER(HADM.DXINGRESO)),
          UPPER(HADM.DXSALIDA1), UPPER(HADM.DXSALIDA2), UPPER(HADM.DXSALIDA3), CASE WHEN COALESCE(FTRD.PAQUETE,0)=2 THEN 0 ELSE  FTRD.VALOR END, FTRD.VLR_COPAGOS, 
          CASE WHEN COALESCE(FTRD.PAQUETE,0)=2  THEN 0 ELSE 
                   CASE ISNULL(FTRD.VR_TOTAL,0) WHEN 0 THEN (FTRD.VALOR * FTRD.CANTIDAD) - FTRD.VLR_COPAGOS ELSE FTRD.VR_TOTAL 
                   END
           END, 
          FTRD.NOPRESTACION, FTRD.NOITEM, FTRD.CNSFTR, FTRD.N_CUOTA, FTRD.CANTIDAD, 
          IIF(@RIPS_DXEGRESO='SI',UPPER(HADM.DXEGRESO),UPPER(HADM.DXINGRESO)), SER.IDSERVICIO, FTRD.CODEVAL
   FROM   RIPSD INNER JOIN FTRD  ON RIPSD.N_FACTURA    = FTRD.N_FACTURA
                INNER JOIN FTR   ON RIPSD.N_FACTURA    = FTR.N_FACTURA
                INNER JOIN HPRED ON FTRD.NOPRESTACION  = HPRED.NOPRESTACION AND FTRD.NOITEM = HPRED.NOITEM
                INNER JOIN HPRE  ON HPRED.NOPRESTACION = HPRE.NOPRESTACION
                INNER JOIN HADM  ON HPRE.NOADMISION    = HADM.NOADMISION
                 LEFT JOIN SER   ON HPRED.IDSERVICIO   = SER.IDSERVICIO
                 LEFT JOIN AFI   ON HADM.IDAFILIADO    = AFI.IDAFILIADO
                 LEFT JOIN PRE   ON SER.PREFIJO        = PRE.PREFIJO
                 LEFT JOIN AFU   ON HPRE.IDAREA        = AFU.IDAREA
                 LEFT JOIN QXPCXD ON HPRED.CONSECUTIVOCX = QXPCXD.CONSECUTIVO AND HPRED.ITEMCIRUGIA = QXPCXD.ITEM
                 LEFT JOIN TGEN   ON QXPCXD.TIPOCIRUGIA = TGEN.CODIGO AND TGEN.CAMPO = 'TIPOCIRUGIA' AND TGEN.TABLA ='General'
   WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
   AND    RIPSD.PROCEDENCIA = 'SALUD' 
   AND    SER.CODIGORIPS    = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDCONSRIPS')
   AND    COALESCE(FTRD.ITFC,0)         <> 2     
   AND    COALESCE(HPRED.NOCOBRABLE,0)  =  CASE @RIPSNOCOBRABLE WHEN 'SI' THEN  COALESCE(HPRED.NOCOBRABLE,0) ELSE 0 END	
   OPEN AC_CURSOR  
   FETCH NEXT FROM AC_CURSOR  
   INTO @NUMFACTURA, @TIPO_DOC, @IDUSUARIO, @FECHAPROCEDIMIENTO, @NUMAUT, @IDPROCEDIMIENTO,
        @FINPROCEDIMIENTO, @CAUSAEXT, @DXPPAL, @DXREL, @DXREL2, @DXREL3, @VALORPROCED, @VALORCOP, @VALORTOT,
        @NOPRESTACION, @NOITEM, @CNSFTR, @N_CUOTA, @CANTIDAD, @IDDX, @IDSERVICIO, @CODEVAL
   WHILE @@FETCH_STATUS = 0  
   BEGIN
      SELECT @CANT = 1
      WHILE @CANT <= @CANTIDAD   
      BEGIN
         INSERT INTO RRIPS_AC ( ENVIO, IDTERCERO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, FECHACONSULTA, NUMAUT, IDCONSULTA,
                                FINCONSULTA, CAUSAEXT, IDDXPPAL, IDDXREL1, IDDXREL2, IDDXREL3, TIPODX, VALORCONSULTA,
                                VALORCUOTAM, VALORNETO, NOPRESTACION, NOITEM, CNSFTR, N_CUOTA, CANTIDAD,
                                PROCEDENCIA, IDDX, IDSERVICIO, CODEVAL)
         SELECT @ENVIO, @IDTERCERO, @NUMFACTURA, @IDSGSSS, @TIPO_DOC, @IDUSUARIO, @FECHAPROCEDIMIENTO, @NUMAUT, 
                @IDPROCEDIMIENTO, @FINPROCEDIMIENTO, @CAUSAEXT, @DXPPAL, @DXREL, @DXREL2, @DXREL3,
                '1',CASE WHEN @RIPS_VALORENTERO='SI' THEN CONVERT(INT,@VALORPROCED) ELSE  @VALORPROCED END,
                CASE WHEN @RIPS_VALORENTERO='SI' THEN CONVERT(INT,@VALORCOP / @CANTIDAD) ELSE @VALORCOP / @CANTIDAD END,
                CASE @RIPS_COPAGOS WHEN 'NO' THEN CASE WHEN @RIPS_VALORENTERO='SI' THEN CONVERT(INT,@VALORPROCED) ELSE @VALORPROCED END
                     ELSE CASE WHEN @RIPS_VALORENTERO='SI' THEN CONVERT(INT,@VALORPROCED - (@VALORCOP / @CANTIDAD)) ELSE @VALORPROCED - (@VALORCOP / @CANTIDAD) END
                END, 
                @NOPRESTACION, @NOITEM, @CNSFTR, @N_CUOTA, 1, 
                'QX', @IDDX, @IDSERVICIO, @CODEVAL        
         IF @@ERROR <> 0 
         BEGIN 
            ROLLBACK
            RAISERROR('ERROR EN AC', 16, 1)
            RETURN
         END 
         SELECT @CANT = @CANT + 1
      END
      FETCH NEXT FROM AC_CURSOR  
      INTO @NUMFACTURA, @TIPO_DOC, @IDUSUARIO, @FECHAPROCEDIMIENTO, @NUMAUT, @IDPROCEDIMIENTO,
           @FINPROCEDIMIENTO, @CAUSAEXT, @DXPPAL, @DXREL, @DXREL2, @DXREL3, @VALORPROCED, @VALORCOP, @VALORTOT,
           @NOPRESTACION, @NOITEM, @CNSFTR, @N_CUOTA, @CANTIDAD, @IDDX, @IDSERVICIO, @CODEVAL
   END
   CLOSE AC_CURSOR  
   DEALLOCATE AC_CURSOR 
   COMMIT

   -- AP SIN CX

   PRINT 'AP'
   BEGIN TRAN
   
   INSERT INTO RRIPS_AP (
      ENVIO, IDTERCERO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, 
      FECHAPROCEDIMIENTO, NUMAUT, IDPROCEDIMIENTO, AMBITO, FINPROCEDIMIENTO, 
      PERSONALA, DXPPAL, DXREL, COMPLICACION, ACTOQ, 
      VALORPROCED, NOPRESTACION, NOITEM, CNSFTR, N_CUOTA, 
      CANTIDAD, PROCEDENCIA, IDDX, IDSERVICIO, CODEVAL 
   ) 
   SELECT 
      @ENVIO, @IDTERCERO, NUMFACTURA, @IDSGSSS, TIPO_DOC, IDUSUARIO, 
      FECHAPROCEDIMIENTO, NUMAUT, IDPROCEDIMIENTO, AMBITO, FINPROCEDIMIENTO, 
      PERSONALA, DXPPAL, DXREL, COMPLICACION, 
      CASE WHEN DBO.FNK_VALORVARIABLE('APRIPSACTOQ') = 'SI' THEN '1' ELSE ACTOQ END, 
      CASE WHEN @RIPS_VALORENTERO='SI' THEN CONVERT(VARCHAR(20),CAST(VALORPROCED AS INT)) ELSE CONVERT(VARCHAR(20),CAST(VALORPROCED AS DECIMAL(14,2))) END,  
         NOPRESTACION, NOITEM, CNSFTR, N_CUOTA, 
      CANTIDAD, 'QX', IDDX, IDSERVICIO, CODEVAL
   FROM (
      SELECT 
         RIPSD.N_FACTURA AS NUMFACTURA, 
         LEFT(AFI.TIPO_DOC,2) AS TIPO_DOC, 
         AFI.DOCIDAFILIADO AS IDUSUARIO, 
         CASE WHEN HPRE.FECHA < HADM.FECHA THEN HADM.FECHA WHEN HPRE.FECHA > HADM.FECHAALTA THEN HADM.FECHAALTA ELSE HPRE.FECHA END AS FECHAPROCEDIMIENTO, 
         CASE WHEN COALESCE(FTR.VENDEDOR,'')<>'' THEN  LEFT(FTR.VENDEDOR,15) ELSE  LEFT(HADM.NOAUTORIZACION,15) END AS NUMAUT,          
		 CASE @CODSER WHEN '0' THEN LEFT(SER.IDSERVICIO,6) WHEN '1' THEN LEFT(SER.IDALTERNA,6) WHEN '8' THEN LEFT(SER.CODCUPS,6) ELSE LEFT(SER.IDALTERNA,6) END AS IDPROCEDIMIENTO,
         AFU.AMBITO, 
         CASE ISNULL(HPRE.FINALIDAD,'') WHEN '' THEN LEFT(PRE.FINALIDAD,1) ELSE LEFT(HPRE.FINALIDAD,1) END AS FINPROCEDIMIENTO,
         CASE SER.MPERSONAL_AT WHEN 1 THEN HPRE.PERSONAL_AT ELSE '' END AS PERSONALA, 
         CASE SER.CODIGORIPS WHEN @IDPROTERQXRIPS THEN IIF(@RIPS_DXEGRESO='SI',UPPER(HADM.DXEGRESO),UPPER(HADM.DXINGRESO))  ELSE CASE WHEN @RRIPS_AP_TODOSCONDX='SI' THEN IIF(@RIPS_DXEGRESO='SI',UPPER(HADM.DXEGRESO),UPPER(HADM.DXINGRESO)) ELSE '' END END AS DXPPAL,
         CASE SER.CODIGORIPS WHEN @IDPROTERQXRIPS THEN UPPER(HADM.DXSALIDA1)    ELSE CASE WHEN @RRIPS_AP_TODOSCONDX='SI' THEN UPPER(HADM.DXSALIDA1) ELSE '' END END AS DXREL,
         CASE SER.CODIGORIPS WHEN @IDPROTERQXRIPS THEN UPPER(HADM.COMPLICACION) ELSE CASE WHEN @RRIPS_AP_TODOSCONDX='SI' THEN UPPER(HADM.COMPLICACION) ELSE '' END END AS COMPLICACION, 
         CASE SER.CODIGORIPS WHEN @IDPROTERQXRIPS THEN CASE ISNULL(TGEN.DATO1,'') WHEN '' THEN '' ELSE TGEN.DATO1 END ELSE  CASE WHEN @RRIPS_AP_TODOSCONDX='SI' THEN 1 ELSE  '' END END AS ACTOQ,
		   CASE WHEN COALESCE(FTRD.PAQUETE,0)=2  THEN 0 ELSE 
         CASE @RIPS_COPAGOS WHEN 'NO' THEN CASE WHEN @RIPS_VALORENTERO='SI' THEN CONVERT(INT,FTRD.VALOR) ELSE FTRD.VALOR END
						   ELSE CASE WHEN @RIPS_VALORENTERO='SI' THEN CONVERT(INT,FTRD.VALOR - (FTRD.VLR_COPAGOS/FTRD.CANTIDAD))
                      ELSE FTRD.VALOR - (FTRD.VLR_COPAGOS/FTRD.CANTIDAD)  END
         END
         END AS VALORPROCED,
         HPRED.NOPRESTACION AS NOPRESTACION, 
         HPRED.NOITEM AS NOITEM, 
         HPRED.CANTIDAD AS CANTIDAD,
         FTRD.CNSFTR AS CNSFTR, 
         FTRD.N_CUOTA AS N_CUOTA, 
         SER.IDSERVICIO AS IDSERVICIO, 
         IIF(@RIPS_DXEGRESO='SI',UPPER(HADM.DXEGRESO),UPPER(HADM.DXINGRESO)) AS IDDX, 
         FTRD.CODEVAL AS CODEVAL
      FROM   RIPSD INNER JOIN FTRD   ON RIPSD.N_FACTURA     = FTRD.N_FACTURA
                   INNER JOIN FTR    ON RIPSD.N_FACTURA     = FTR.N_FACTURA
                   INNER JOIN HPRED  ON FTRD.NOPRESTACION   = HPRED.NOPRESTACION AND FTRD.NOITEM = HPRED.NOITEM
                   INNER JOIN HPRE   ON HPRED.NOPRESTACION  = HPRE.NOPRESTACION
                   INNER JOIN HADM   ON HPRE.NOADMISION     = HADM.NOADMISION
                    LEFT JOIN SER    ON HPRED.IDSERVICIO    = SER.IDSERVICIO
                    LEFT JOIN AFI    ON HADM.IDAFILIADO     = AFI.IDAFILIADO
                    LEFT JOIN PRE    ON SER.PREFIJO         = PRE.PREFIJO
                    LEFT JOIN AFU    ON HPRE.IDAREA         = AFU.IDAREA
                    LEFT JOIN QXPCXD ON HPRED.CONSECUTIVOCX = QXPCXD.CONSECUTIVO AND HPRED.ITEMCIRUGIA = QXPCXD.ITEM
                    LEFT JOIN TGEN   ON QXPCXD.TIPOCIRUGIA  = TGEN.CODIGO AND TGEN.CAMPO = 'TIPOCIRUGIA' AND TGEN.TABLA ='General'
      WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
      AND  COALESCE(HPRED.IDCIRUGIA,'') =  CASE WHEN EXISTS(SELECT * FROM QXPCXD WHERE  HPRED.CONSECUTIVOCX = QXPCXD.CONSECUTIVO AND HPRED.ITEMCIRUGIA = QXPCXD.ITEM)
                                                THEN CASE WHEN @RIPS_PROCESOAP='SI' AND COALESCE(HPRED.TIPOSERCIRUGIA,'')<>'PAQUETE'
												          THEN '' --COALESCE(HPRED.IDCIRUGIA,'')
												          ELSE CASE WHEN HPRED.TIPOSERCIRUGIA='PAQUETE' 
														          THEN COALESCE(HPRED.IDCIRUGIA,'') ELSE COALESCE(HPRED.IDCIRUGIA,'XXX') END END 
												ELSE '' END --COALESCE(HPRED.IDCIRUGIA,'')
      AND    RIPSD.PROCEDENCIA = 'SALUD' 
      AND    COALESCE(FTRD.ITFC,0)         <> 2
      AND    COALESCE(HPRED.NOCOBRABLE,0)  =  CASE @RIPSNOCOBRABLE WHEN 'SI' THEN  COALESCE(HPRED.NOCOBRABLE,0) ELSE 0 END
      AND    (   SER.CODIGORIPS IN (SELECT DATO FROM USVGS WHERE IDVARIABLE IN ('IDPROCRIPS','IDPROPYPRIPS','IDPROTERNOQXRIPS'))
              OR SER.CODIGORIPS    = @IDPROTERQXRIPS )
    ) AS X 
    
   IF @@ERROR <> 0 
   BEGIN 
      ROLLBACK
      RAISERROR('ERROR EN AP', 16, 1)
      RETURN
   END 
   COMMIT
   -- AM
   BEGIN TRAN
   PRINT 'AM'
   
   SELECT 
      ROW_NUMBER() OVER (ORDER BY NUMFACTURA,IDUSUARIO,NUMAUT,IDSERVICIO) ID,
      ROW_NUMBER() OVER (
         PARTITION BY NUMFACTURA,IDUSUARIO,NUMAUT,IDSERVICIO,VALORUNIMEDI
         ORDER BY NUMFACTURA,IDUSUARIO,NUMAUT,IDSERVICIO,VALORUNIMEDI
      ) AS ORDEN,
      NUMFACTURA, TIPO_DOC, IDUSUARIO, NUMAUT, IDMEDICAMENTO, TIPOMEDICAMENTO, UPPER(NOMBREMEDI)NOMBREMEDI,
      UPPER(FORMAFARMA)FORMAFARMA, UPPER(CONCMEDI)CONCMEDI, UPPER(UMEDMEDI)UMEDMEDI, NUMUNIDADES, VALORUNIMEDI, VALORTOTMEDI, NOPRESTACION, NOITEM, CNSFTR, 
      N_CUOTA, IDDX, IDSERVICIO, CODEVAL, FECHAMEDICAMENTO 
   INTO #AM
   FROM (
      SELECT 
         RIPSD.N_FACTURA AS NUMFACTURA, 
         LEFT(AFI.TIPO_DOC,2) AS TIPO_DOC, 
         AFI.DOCIDAFILIADO AS IDUSUARIO, 
         CASE WHEN COALESCE(FTR.VENDEDOR,'')<>'' THEN LEFT(FTR.VENDEDOR,15) ELSE LEFT(HADM.NOAUTORIZACION,15) END AS NUMAUT, 
         CASE SER.CODIGORIPS WHEN @IDMEDPOSRIPS THEN SER.IDALTERNA ELSE SER.IDALTERNA END AS IDMEDICAMENTO,
         CASE SER.CODIGORIPS WHEN @IDMEDPOSRIPS THEN '1' ELSE '2' END AS TIPOMEDICAMENTO,
         LEFT(SER.DESCSERVICIO,30) AS NOMBREMEDI,
         CASE SER.CODIGORIPS WHEN @IDMEDPOSRIPS THEN CASE WHEN @RIPS_AM_DATOSMEDPOS='SI' THEN ISNULL(LEFT(IFFA.DESCRIPCION,20),'') ELSE '' END  ELSE ISNULL(LEFT(IFFA.DESCRIPCION,20),'') END AS FORMAFARMA,
         CASE SER.CODIGORIPS WHEN @IDMEDPOSRIPS THEN CASE WHEN @RIPS_AM_DATOSMEDPOS='SI' THEN ISNULL(LEFT(ICCN.DESCRIPCION,20),'') ELSE '' END  ELSE ISNULL(LEFT(ICCN.DESCRIPCION,20),'') END AS CONCMEDI,
         CASE SER.CODIGORIPS WHEN @IDMEDPOSRIPS THEN CASE WHEN @RIPS_AM_DATOSMEDPOS='SI' THEN ISNULL(LEFT(IUNI.DESCRIPCION,20),'') ELSE '' END  ELSE ISNULL(LEFT(IUNI.DESCRIPCION,20),'') END AS UMEDMEDI,
         CAST (FTRD.CANTIDAD AS INT) AS NUMUNIDADES, 
         CASE WHEN COALESCE(FTRD.PAQUETE,0)=2  THEN 0 ELSE CASE WHEN @RIPS_VALORENTERO='SI' THEN CONVERT(INT,FTRD.VALOR) ELSE FTRD.VALOR END END AS VALORUNIMEDI, 
         CASE WHEN COALESCE(FTRD.PAQUETE,0)=2  THEN 0 ELSE
            CASE @RIPS_COPAGOS WHEN 'NO' THEN  CASE WHEN @RIPS_VALORENTERO='SI' THEN CAST (FTRD.VALOR * FTRD.CANTIDAD AS INT) ELSE CAST (FTRD.VALOR * FTRD.CANTIDAD AS DECIMAL(14,2)) END
            ELSE 
               CASE WHEN (FTRD.VALOR * FTRD.CANTIDAD) = 0 
                     THEN CASE WHEN @RIPS_VALORENTERO='SI' THEN  CAST (FTRD.VALOR * FTRD.CANTIDAD AS INT ) ELSE  CAST (FTRD.VALOR * FTRD.CANTIDAD AS DECIMAL(14,2)) END
                     ELSE CASE WHEN @RIPS_VALORENTERO='SI' THEN CAST((FTRD.VALOR * FTRD.CANTIDAD) - FTRD.VLR_COPAGOS AS INT) ELSE CAST((FTRD.VALOR * FTRD.CANTIDAD) - FTRD.VLR_COPAGOS AS DECIMAL(14,2)) END
               END     
            END 
         END AS VALORTOTMEDI, 
         FTRD.NOPRESTACION, 
         FTRD.NOITEM, 
         FTRD.CNSFTR, 
         FTRD.N_CUOTA, 
         IIF(@RIPS_DXEGRESO='SI',UPPER(HADM.DXEGRESO),UPPER(HADM.DXINGRESO)) AS IDDX, 
         SER.IDSERVICIO, 
         FTRD.CODEVAL, 
         HPRE.FECHA FECHAMEDICAMENTO
      FROM  RIPSD 
         INNER JOIN FTRD  ON RIPSD.N_FACTURA    = FTRD.N_FACTURA
         INNER JOIN FTR   ON RIPSD.N_FACTURA    = FTR.N_FACTURA  
         INNER JOIN HPRED ON FTRD.NOPRESTACION  = HPRED.NOPRESTACION AND FTRD.NOITEM = HPRED.NOITEM
         INNER JOIN HPRE  ON HPRED.NOPRESTACION = HPRE.NOPRESTACION
         INNER JOIN HADM  ON HPRE.NOADMISION    = HADM.NOADMISION
          LEFT JOIN SER   ON HPRED.IDSERVICIO   = SER.IDSERVICIO
          LEFT JOIN AFI   ON HADM.IDAFILIADO    = AFI.IDAFILIADO
          LEFT JOIN PRE   ON SER.PREFIJO        = PRE.PREFIJO
          LEFT JOIN AFU   ON HPRE.IDAREA        = AFU.IDAREA
          LEFT JOIN IART  ON SER.IDARTICULO     = IART.IDARTICULO
          LEFT JOIN IUNI  ON IART.IDUNIDAD      = IUNI.IDUNIDAD
          LEFT JOIN ICCN  ON IART.IDCONCENTRA   = ICCN.IDCONCENTRA
          LEFT JOIN IFFA  ON IART.IDFORFARM     = IFFA.IDFORFARM
      WHERE RIPSD.ENVIO = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
         AND RIPSD.PROCEDENCIA = 'SALUD' 
         AND COALESCE(FTRD.ITFC,0) <> 2
         AND    COALESCE(HPRED.NOCOBRABLE,0)  = CASE @RIPSNOCOBRABLE WHEN 'SI' THEN  COALESCE(HPRED.NOCOBRABLE,0) ELSE 0 END
         AND (SER.CODIGORIPS = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDMEDNOPOSRIPS') OR SER.CODIGORIPS = @IDMEDPOSRIPS)
   )X


   /* STORRES SE QUIETA ESTE PROCESO POR QUE ESTA DA?ANDO EL VALOR UNITARIO DEL SERVICIO DE OXIGENO*/
  -- IF @PRE_OXIGENO<>'' AND EXISTS (SELECT 1 FROM PRE WHERE PREFIJO=@PRE_OXIGENO)
  -- BEGIN
  --      UPDATE AM SET 
  --          VALORUNIMEDI= CASE WHEN VALORUNIMEDI=0 THEN 0 ELSE (VALORUNIMEDI/A.VALOR) END, 
  --          NUMUNIDADES= CASE WHEN VALORUNIMEDI=0 THEN 0 ELSE (VALORTOTMEDI/(VALORUNIMEDI/A.VALOR)) END --A.VALOR*NUMUNIDADES  
  --      FROM #AM AM
  --          INNER JOIN SER   ON SER.IDSERVICIO=AM.IDSERVICIO 
  --          INNER JOIN HPRE  ON HPRE.NOPRESTACION=AM.NOPRESTACION 
  --          INNER JOIN SERTOT A ON SER.IDSERVICIO=A.IDSERVICIO AND HPRE.IDTERCEROCA=A.IDTERCERO AND HPRE.IDPLAN=A.IDPLAN
  --              AND  A.FECHAINI <=AM.FECHAMEDICAMENTO  AND A.FECHAFIN>=AM.FECHAMEDICAMENTO
  --              AND  A.FECHAINIFD <=AM.FECHAMEDICAMENTO  AND A.FECHAFINFD>=AM.FECHAMEDICAMENTO
		--	AND A.PREFIJO=SER.PREFIJO
  --      WHERE SER.PREFIJO=@PRE_OXIGENO
		--AND HPRE.PREFIJO=@PRE_OXIGENO
		--AND A.VALOR > 0
  -- END



   --AGREGO AT INDIVIDUALES O AGRUPADOS
   IF @RIPS_AGRUPADOS='SI'
   BEGIN
      PRINT 'Sumo cantidades'
      UPDATE #AM SET NUMUNIDADES=B.NUMUNIDADES, VALORTOTMEDI=B.VALORTOTMEDI 
      FROM #AM A
         INNER JOIN (
            SELECT NUMFACTURA, IDUSUARIO, NUMAUT, IDSERVICIO, VALORUNIMEDI, SUM(NUMUNIDADES) NUMUNIDADES, SUM(CAST(VALORTOTMEDI AS DECIMAL(13,2))) VALORTOTMEDI
            FROM #AM 
            GROUP BY NUMFACTURA, IDUSUARIO, NUMAUT, IDSERVICIO, VALORUNIMEDI
         )B ON A.NUMFACTURA=B.NUMFACTURA AND A.IDUSUARIO=B.IDUSUARIO AND COALESCE(A.NUMAUT,'')=COALESCE(B.NUMAUT,'')
            AND A.IDSERVICIO=B.IDSERVICIO AND A.VALORUNIMEDI=B.VALORUNIMEDI
      WHERE A.ORDEN=1

      PRINT 'Borro lo que no sea 1'
      DELETE #AM WHERE ORDEN<>1
   END

   PRINT 'Busco formato de codigos medicamentos'
   print @FORMATORIPS
   IF COALESCE(@FORMATORIPS,'')='01'-- COD CUMS SOLO
   BEGIN 
		PRINT 'FORMATO RIPS CUMS' 
		UPDATE #AM SET IDMEDICAMENTO=CASE COALESCE(D.CODIGOCUM,'') WHEN '' THEN CASE COALESCE(IART.CODCUM,'') WHEN '' THEN SER.CODCUM ELSE IART.CODCUM END ELSE D.CODIGOCUM END
		FROM #AM A INNER JOIN HPRED D ON D.NOPRESTACION=A.NOPRESTACION AND D.NOITEM=A.NOITEM
					INNER JOIN SER ON SER.IDSERVICIO=D.IDSERVICIO
					LEFT JOIN IART ON D.IDARTICULO=IART.IDARTICULO

		UPDATE #AM SET IDMEDICAMENTO=CASE COALESCE(IART.CODCUM,'') WHEN '' THEN SER.CODCUM ELSE IART.CODCUM END
		FROM #AM A INNER JOIN HPRED D ON D.NOPRESTACION=A.NOPRESTACION AND D.NOITEM=A.NOITEM
					INNER JOIN SER ON SER.IDSERVICIO=D.IDSERVICIO
					INNER JOIN IART ON D.IDARTICULO=IART.IDARTICULO
		WHERE ISNULL(IDMEDICAMENTO,'')='' OR ISNULL(IDMEDICAMENTO,'') NOT LIKE '%-%'

		UPDATE #AM SET IDMEDICAMENTO=CASE ISNULL(SER.CODCUM,'') WHEN '' THEN A.IDSERVICIO ELSE SER.CODCUM END
		FROM #AM A INNER JOIN SER ON A.IDSERVICIO=SER.IDSERVICIO
		WHERE ISNULL(IDMEDICAMENTO,'')='' OR ISNULL(IDMEDICAMENTO,'') NOT LIKE '%-%'
	  
		UPDATE #AM SET IDMEDICAMENTO=DBO.FNK_LIMPIATEXTO(IDMEDICAMENTO,'0-9-')
		FROM #AM WHERE ISNULL(IDMEDICAMENTO,'') LIKE '%-%'

		UPDATE #AM SET IDMEDICAMENTO=(stuff((select CONCAT('-',IIF(ISNUMERIC(WORD)=1 AND CONVERT(INT, WORD)>0, CONVERT(INT, WORD),WORD)) 
										FROM DBO.FNK_EXPLODE(IDMEDICAMENTO,'-') FOR XML PATH('')),1,1,'')
										)
		FROM #AM WHERE ISNULL(IDMEDICAMENTO,'') LIKE '%-%'

   END
   ELSE
   BEGIN
      IF COALESCE(@FORMATORIPS,'')='02'-- COD SISPRO SOLO
      BEGIN
         PRINT 'FORMATO RIPS SISPRO'
         UPDATE #AM SET IDMEDICAMENTO=COALESCE(SER.CODSISPRO,A.IDSERVICIO) 
         FROM #AM A INNER JOIN SER ON A.IDSERVICIO=SER.IDSERVICIO
      END 
      ELSE
      BEGIN
         IF COALESCE(@FORMATORIPS,'')='03'
         BEGIN 
            PRINT 'FORMATO RIPS BASE DE DATOS PROPIAS'
            UPDATE #AM SET 
               IDMEDICAMENTO=COALESCE(SERTHOM.IDALTERNA,A.IDSERVICIO), 
               NOMBREMEDI=LEFT(COALESCE(SERTHOM.DESCRIPCION,A.NOMBREMEDI),30) 
            FROM #AM A 
               INNER JOIN FTR     ON A.NUMFACTURA=FTR.N_FACTURA
                LEFT JOIN SERTHOM ON A.IDSERVICIO=SERTHOM.IDSERVICIO AND SERTHOM.IDTERCERO=FTR.IDTERCERO
         END
		 ELSE
		 BEGIN
			 IF COALESCE(@FORMATORIPS,'')='04'
			 BEGIN 
				PRINT 'FORMATO RIPS CODCUPS PARA MEDICAMENTOS'
				UPDATE #AM SET 
				   IDMEDICAMENTO=COALESCE(SER.CODCUPS,A.IDSERVICIO), 
				   NOMBREMEDI=LEFT(COALESCE(SER.DESCRIPCION_CUPS,A.NOMBREMEDI),30) 
				FROM #AM A 
				   INNER JOIN FTR     ON A.NUMFACTURA=FTR.N_FACTURA
					LEFT JOIN SER ON A.IDSERVICIO=SER.IDSERVICIO
			 END
		 END
      END
   END


   INSERT INTO RRIPS_AM ( 
      ENVIO, IDTERCERO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, NUMAUT, IDMEDICAMENTO, TIPOMEDICAMENTO, NOMBREMEDI,
      FORMAFARMA, CONCMEDI, UMEDMEDI, NUMUNIDADES, VALORUNIMEDI, VALORTOTMEDI, NOPRESTACION, NOITEM, CNSFTR, 
      N_CUOTA, PROCEDENCIA, IDDX, IDSERVICIO, CODEVAL, FECHAMEDICAMENTO 
   )
   SELECT 
      @ENVIO, @IDTERCERO, NUMFACTURA, @IDSGSSS, TIPO_DOC, IDUSUARIO, NUMAUT, IDMEDICAMENTO, TIPOMEDICAMENTO, NOMBREMEDI,
      FORMAFARMA, CONCMEDI, UMEDMEDI, NUMUNIDADES, VALORUNIMEDI, VALORTOTMEDI, NOPRESTACION, NOITEM, CNSFTR, 
      N_CUOTA, 'QX', IDDX, IDSERVICIO, CODEVAL, FECHAMEDICAMENTO 
   FROM #AM

   IF @@ERROR <> 0 
   BEGIN 
      ROLLBACK
      RAISERROR('ERROR EN AM', 16, 1)
      RETURN
   END            
   ELSE
   BEGIN 
      SELECT @OK = COALESCE(COUNT(*),0)
      FROM   RRIPS_AM
      WHERE  ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO
      AND    (VALORUNIMEDI < 0 OR  VALORTOTMEDI < 0)
      IF @OK > 0
      BEGIN
         ROLLBACK
         RAISERROR('ERROR EN AM VALORES NEGATIVOS', 16, 1)
         RETURN     
      END
   END
   COMMIT
   DROP TABLE #AM
   --TERMINO AM


   -- AT
   PRINT 'AT' 

   SELECT 
      ROW_NUMBER() OVER (ORDER BY NUMFACTURA,IDUSUARIO,NUMAUT,IDSERVICIOORI) ID,
      ROW_NUMBER() OVER (
         PARTITION BY NUMFACTURA,IDUSUARIO,NUMAUT,IDSERVICIOORI,VLRUNITMAT
         ORDER BY NUMFACTURA,IDUSUARIO,NUMAUT,IDSERVICIOORI,VLRUNITMAT
      ) AS ORDEN,
      NUMFACTURA, TIPO_DOC, IDUSUARIO, NUMAUT, TIPOSERVICIO, IDSERVICIO,
      DESCRIPCIONSER, CANTIDAD, VLRUNITMAT, VLRTOTMAT, NOPRESTACION, NOITEM, CNSFTR, 
      N_CUOTA, IDDX, IDSERVICIOORI, CODEVAL, FECHAPROCEDIMIENTO 
   INTO #AT
   FROM (
	  SELECT 
         RIPSD.N_FACTURA AS NUMFACTURA, 
         LEFT(AFI.TIPO_DOC,2) AS TIPO_DOC, 
         AFI.DOCIDAFILIADO AS IDUSUARIO,
         CASE WHEN COALESCE(FTR.VENDEDOR,'')<>'' THEN LEFT(FTR.VENDEDOR,15) ELSE LEFT(HADM.NOAUTORIZACION,15) END AS NUMAUT,
         CASE SER.CODIGORIPS 
            WHEN (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDESTANCIASRIPS')   THEN '3'
            WHEN (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDHONORARIOSRIPS')  THEN '4'
            WHEN (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDMATERIALESRIPS')  THEN '1'
            WHEN (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDTRASLADOSRIPS')   THEN '2'
            WHEN (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDDERECHOSALARIPS') THEN '3'
            WHEN (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDPROTESISRIPS')    THEN '1'
            ELSE '2'
         END AS TIPOSERVICIO, 
		 CASE @CODSER WHEN '0' THEN LEFT(SER.IDSERVICIO,10) WHEN '1' THEN LEFT(SER.IDALTERNA,10) WHEN '8' THEN LEFT(SER.CODCUPS,10) ELSE LEFT(SER.IDALTERNA,10) END AS IDSERVICIO,
         CASE WHEN @CODSER IN (8) THEN LEFT(SER.DESCRIPCION_CUPS,60) ELSE LEFT(SER.DESCSERVICIO,60) END AS DESCRIPCIONSER,
         CASE WHEN FTRD.CANTIDAD > 99999 THEN 99999 ELSE CAST(FTRD.CANTIDAD AS INT) END AS CANTIDAD,
         CAST(FTRD.VALOR AS VARCHAR(15)) AS VLRUNITMAT, 
		 CAST(FTRD.VALOR AS VARCHAR(15)) AS VLRTOTMAT,
         HADM.NOADMISION AS NOPRESTACION, 
         1 AS NOITEM, 
         FTRD.CNSFTR, 
         FTRD.N_CUOTA, 
         IIF(@RIPS_DXEGRESO='SI',UPPER(HADM.DXEGRESO),UPPER(HADM.DXINGRESO)) AS IDDX, 
         SER.IDSERVICIO AS IDSERVICIOORI, 
         FTRD.CODEVAL, 
         FTR.F_FACTURA AS FECHAPROCEDIMIENTO
      FROM   RIPSD INNER JOIN FTRD  ON RIPSD.N_FACTURA    = FTRD.N_FACTURA
				   INNER JOIN FTR   ON FTR.CNSFCT		  = FTRD.CNSFTR
                   INNER JOIN HADM  ON FTR.NOREFERENCIA   = HADM.NOADMISION
                    LEFT JOIN SER   ON FTRD.REFERENCIA    = SER.IDSERVICIO
                    LEFT JOIN AFI   ON HADM.IDAFILIADO    = AFI.IDAFILIADO
                    LEFT JOIN PRE   ON SER.PREFIJO        = PRE.PREFIJO
					--LEFT JOIN CPPAF ON CPPAF.IDPLAN       = FTRD.IDPLAN AND CPPAF.IDSERVICIO=SER.IDSERVICIO AND COALESCE(CPPAF.REQAUTORIZACION,0)=1 AND COALESCE(HPRE.IDAREA,'')=COALESCE(CPPAF.IDAREA,'')
      WHERE  RIPSD.ENVIO = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
      AND    RIPSD.PROCEDENCIA = 'SALUD' 
      AND    COALESCE(FTRD.ITFC,0) <> 2
	  AND    COALESCE(FTRD.PAQUETE,0)=0
	  AND    HADM.PAQUETE = 1 AND COALESCE(IDSERVICIOPAQUETE,'')<>''
      AND    (   SER.CODIGORIPS = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDESTANCIASRIPS')
              OR SER.CODIGORIPS = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDHONORARIOSRIPS')
              OR SER.CODIGORIPS = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDMATERIALESRIPS')
              OR SER.CODIGORIPS = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDTRASLADOSRIPS')
              OR SER.CODIGORIPS = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDDERECHOSALARIPS')
              OR SER.CODIGORIPS = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDBANSANGRERIPS')
              OR SER.CODIGORIPS = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDPROTESISRIPS')
			  )
	   
	   UNION ALL
      SELECT 
         RIPSD.N_FACTURA AS NUMFACTURA, 
         LEFT(AFI.TIPO_DOC,2) AS TIPO_DOC, 
         AFI.DOCIDAFILIADO AS IDUSUARIO,
         CASE WHEN COALESCE(CPPAF.REQAUTORIZACION,0)=1 OR UPPER(ISNULL(HPRE.CIRUGIA,''))='SI'
              THEN LEFT(HPRED.NOAUTORIZACION,15) ELSE CASE WHEN COALESCE(FTR.VENDEDOR,'')<>'' THEN LEFT(FTR.VENDEDOR,15) ELSE LEFT(HADM.NOAUTORIZACION,15) END 
         END AS NUMAUT,
         CASE SER.CODIGORIPS 
            WHEN (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDESTANCIASRIPS')   THEN '3'
            WHEN (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDHONORARIOSRIPS')  THEN '4'
            WHEN (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDMATERIALESRIPS')  THEN '1'
            WHEN (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDTRASLADOSRIPS')   THEN '2'
            WHEN (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDDERECHOSALARIPS') THEN '3'
            WHEN (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDPROTESISRIPS')    THEN '1'
            ELSE '2'
         END AS TIPOSERVICIO, 
		 CASE @CODSER WHEN '0' THEN LEFT(SER.IDSERVICIO,10) WHEN '1' THEN LEFT(SER.IDALTERNA,10) WHEN '8' THEN LEFT(SER.CODCUPS,10) ELSE LEFT(SER.IDALTERNA,10) END AS IDSERVICIO,
         CASE WHEN @CODSER IN (8) THEN LEFT(SER.DESCRIPCION_CUPS,60) ELSE LEFT(SER.DESCSERVICIO,60) END AS DESCRIPCIONSER,
         CASE WHEN FTRD.CANTIDAD > 99999 THEN 99999 ELSE CAST(FTRD.CANTIDAD AS INT) END AS CANTIDAD,
          
         CASE WHEN COALESCE(FTRD.PAQUETE,0)=2  
		 THEN '0' ELSE  CAST(CASE WHEN COALESCE (HPRED.IDCIRUGIA,'')<>'' AND @RIPS_PROCESOAP ='SI' AND COALESCE(FTRD.PAQUETE,0)=2
               AND SER.CODIGORIPS IN (@IDHONORARIOSRIPS, @IDDERECHOSALARIPS)
                    THEN 0 
					WHEN  (COALESCE (HPRED.IDCIRUGIA,'')<>'' AND SER.CODIGORIPS IN (@IDHONORARIOSRIPS, @IDDERECHOSALARIPS))
                     AND  @RIPS_PROCESOAP ='SI' AND COALESCE(FTRD.PAQUETE,0)<>2 					
			   THEN 0  
                   ELSE FTRD.VALOR END AS VARCHAR(15)) END AS VLRUNITMAT, 

         CASE WHEN COALESCE(FTRD.PAQUETE,0)=2  THEN '0' ELSE 
         CAST(CASE WHEN (COALESCE (HPRED.IDCIRUGIA,'')<>''  AND SER.CODIGORIPS IN(@IDHONORARIOSRIPS, @IDDERECHOSALARIPS)) AND @RIPS_PROCESOAP ='SI' AND COALESCE(FTRD.PAQUETE,0)=2
              
               THEN 0 
			   WHEN   (COALESCE (HPRED.IDCIRUGIA,'')<>'' AND SER.CODIGORIPS IN (@IDHONORARIOSRIPS, @IDDERECHOSALARIPS)) AND @RIPS_PROCESOAP ='SI' AND COALESCE(FTRD.PAQUETE,0)<>2 
			   THEN 0       ELSE CASE @RIPS_COPAGOS 
							        WHEN 'NO' THEN CAST(FTRD.VALOR * FTRD.CANTIDAD AS DECIMAL(14,2))
							        ELSE CAST((FTRD.VALOR * FTRD.CANTIDAD) - FTRD.VLR_COPAGOS AS DECIMAL(14,2)) 
                        END
			     END AS VARCHAR(15)) END AS VLRTOTMAT,
         HPRED.NOPRESTACION, 
         HPRED.NOITEM, 
         FTRD.CNSFTR, 
         FTRD.N_CUOTA, 
         IIF(@RIPS_DXEGRESO='SI',UPPER(HADM.DXEGRESO),UPPER(HADM.DXINGRESO)) AS IDDX, 
         SER.IDSERVICIO AS IDSERVICIOORI, 
         FTRD.CODEVAL, 
         HPRE.FECHA AS FECHAPROCEDIMIENTO
      FROM   RIPSD INNER JOIN FTRD  ON RIPSD.N_FACTURA    = FTRD.N_FACTURA
                   INNER JOIN FTR   ON RIPSD.N_FACTURA    = FTR.N_FACTURA
                   INNER JOIN HPRED ON FTRD.NOPRESTACION  = HPRED.NOPRESTACION AND FTRD.NOITEM = HPRED.NOITEM
                   INNER JOIN HPRE  ON HPRED.NOPRESTACION = HPRE.NOPRESTACION
                   INNER JOIN HADM  ON HPRE.NOADMISION    = HADM.NOADMISION
                    LEFT JOIN SER   ON HPRED.IDSERVICIO   = SER.IDSERVICIO
                    LEFT JOIN AFI   ON HADM.IDAFILIADO    = AFI.IDAFILIADO
                    LEFT JOIN PRE   ON SER.PREFIJO        = PRE.PREFIJO
					LEFT JOIN CPPAF ON CPPAF.IDPLAN       = HPRED.IDPLAN AND CPPAF.IDSERVICIO=HPRED.IDSERVICIO AND COALESCE(CPPAF.REQAUTORIZACION,0)=1 AND COALESCE(HPRE.IDAREA,'')=COALESCE(CPPAF.IDAREA,'')
      WHERE  RIPSD.ENVIO = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
      AND    RIPSD.PROCEDENCIA = 'SALUD' 
      AND    COALESCE(FTRD.ITFC,0) <> 2
      AND    COALESCE(HPRED.NOCOBRABLE,0)  =  CASE @RIPSNOCOBRABLE WHEN 'SI' THEN  COALESCE(HPRED.NOCOBRABLE,0) ELSE 0 END
      AND    (   SER.CODIGORIPS = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDESTANCIASRIPS')
              OR SER.CODIGORIPS = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDHONORARIOSRIPS')
              OR SER.CODIGORIPS = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDMATERIALESRIPS')
              OR SER.CODIGORIPS = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDTRASLADOSRIPS')
              OR SER.CODIGORIPS = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDDERECHOSALARIPS')
              OR SER.CODIGORIPS = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDBANSANGRERIPS')
              OR SER.CODIGORIPS = (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDPROTESISRIPS')
			  )
   )X

   
   --AGREGO AT INDIVIDUALES O AGRUPADOS
   IF @RIPS_AGRUPADOS='SI'
   BEGIN
      PRINT 'Sumo cantidades'
      UPDATE #AT SET CANTIDAD=B.CANTIDAD, VLRTOTMAT=B.VLRTOTMAT 
      FROM #AT A
         INNER JOIN (
            SELECT NUMFACTURA, IDUSUARIO, NUMAUT, IDSERVICIOORI, VLRUNITMAT, SUM(CANTIDAD) CANTIDAD, SUM(CAST(VLRTOTMAT AS DECIMAL(13,2))) VLRTOTMAT
            FROM #AT 
            GROUP BY NUMFACTURA, IDUSUARIO, NUMAUT, IDSERVICIOORI, VLRUNITMAT
         )B ON A.NUMFACTURA=B.NUMFACTURA AND A.IDUSUARIO=B.IDUSUARIO AND COALESCE(A.NUMAUT,'')=COALESCE(B.NUMAUT,'')
            AND A.IDSERVICIOORI=B.IDSERVICIOORI AND A.VLRUNITMAT=B.VLRUNITMAT
      WHERE A.ORDEN=1

      PRINT 'Borro lo que no sea 1'
      DELETE #AT WHERE ORDEN<>1
   END

   -- SE AGREGA VALIDACION DE AT DE ENTEROS     
   IF @RIPS_VALORENTERO='SI'
   BEGIN
      UPDATE #AT SET VLRUNITMAT=CAST(CAST(VLRUNITMAT AS DECIMAL(13,2)) AS INT), VLRTOTMAT=CAST(CAST(VLRTOTMAT AS DECIMAL(13,2)) AS INT)
   END

   INSERT INTO RRIPS_AT ( 
      ENVIO, IDTERCERO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, NUMAUT, TIPOSERVICIO, IDSERVICIO, 
      DESCRIPCIONSER, CANTIDAD, VLRUNITMAT, VLRTOTMAT, NOPRESTACION, NOITEM, CNSFTR, 
      N_CUOTA, PROCEDENCIA, IDDX, IDSERVICIOORI, CODEVAL, FECHAPROCEDIMIENTO
   )
   SELECT 
      @ENVIO, @IDTERCERO, NUMFACTURA, @IDSGSSS, TIPO_DOC, IDUSUARIO, NUMAUT, TIPOSERVICIO, IDSERVICIO, 
      DESCRIPCIONSER, CANTIDAD, VLRUNITMAT, VLRTOTMAT, NOPRESTACION, NOITEM, CNSFTR, 
      N_CUOTA, 'QX', IDDX, IDSERVICIOORI, CODEVAL, FECHAPROCEDIMIENTO
   FROM #AT

   DROP TABLE #AT


   --TERMINO AT


   -- US
   PRINT 'US'   
   INSERT INTO RRIPS_US ( ENVIO, IDTERCERO, TIPO_DOC, IDUSUARIO, CODENTIDADM, TIPOUSUARIO, PAPELLIDO, 
                          SAPELLIDO, PNOMBRE, SNOMBRE, EDAD, UNMEDIDA, SEXO, DEPHABITUAL, 
                          MUNHABITUAL, ZONAHABITUAL, TIPOAFILIADO )
      SELECT ENVIO, @IDTERCERO, TIPO_DOC, DOCIDAFILIADO, IDALTERNA2, MIN(TIPOSISTEMA), PAPELLIDO, SAPELLIDO, PNOMBRE, SNOMBRE,
          EDAD, UNMEDIDA, SEXO, DEPTO, MUNICIPIO, ZONA, TIPOAFILIADO
   FROM   (
            SELECT DISTINCT @ENVIO AS ENVIO, LEFT(AFI.TIPO_DOC,2) AS TIPO_DOC, AFI.DOCIDAFILIADO, 
            CASE WHEN COALESCE(PPT.IDALTERNA,'')='' THEN  LEFT(ISNULL(TER.IDALTERNA2,''),6) ELSE COALESCE(PPT.IDALTERNA,'') END AS IDALTERNA2, 
                   CASE PLN.TIPOSISTEMA WHEN 'Contributivo' THEN '1' 
                                        WHEN 'Subsidiado'   THEN '2'
                                        WHEN 'Vinculado'    THEN '3'
                                        WHEN 'Particular'   THEN '4'
                                        WHEN 'Otro'         THEN '5'
                                        WHEN 'Prepagado'    THEN '5'
                                        WHEN 'Desplazado Vinc'   THEN '8'
                                        WHEN 'Desplazado Reg Cont' THEN '6'
                                        WHEN 'Desplazado Reg Subs' THEN '7'
                   END AS TIPOSISTEMA, 
                   LEFT(REPLACE(AFI.PAPELLIDO,',',' '),30) AS PAPELLIDO,  
                   LEFT(REPLACE(AFI.SAPELLIDO,',',' '),30) AS SAPELLIDO, 
                   LEFT(REPLACE(AFI.PNOMBRE,',',' '),20) AS PNOMBRE,  
                   LEFT(REPLACE(AFI.SNOMBRE,',',' '),20) AS SNOMBRE,  
                   CASE  
                      WHEN DATEDIFF(DAY,AFI.FNACIMIENTO,GETDATE())<=0 THEN 1  
                      WHEN DATEDIFF(DAY,AFI.FNACIMIENTO,GETDATE())<=30 THEN DATEDIFF(DAY,AFI.FNACIMIENTO,GETDATE())  
                      WHEN DATEDIFF(DAY,AFI.FNACIMIENTO,GETDATE())<=365 THEN 
                           CASE WHEN DATEDIFF(MONTH,AFI.FNACIMIENTO,GETDATE())  = 12 THEN 1
                                ELSE DATEDIFF(MONTH,AFI.FNACIMIENTO,GETDATE())
                           END
                      WHEN DATEDIFF(DAY,AFI.FNACIMIENTO,GETDATE())<=54750 THEN DATEDIFF(YEAR,AFI.FNACIMIENTO,GETDATE()) 
                   END EDAD,  
                   CASE  
                      WHEN DATEDIFF(DAY,AFI.FNACIMIENTO,GETDATE())<=30 THEN '3'  
                      WHEN DATEDIFF(DAY,AFI.FNACIMIENTO,GETDATE())<=365 THEN 
                           CASE WHEN DATEDIFF(MONTH,AFI.FNACIMIENTO,GETDATE()) = 12 THEN '1'
                                ELSE '2'
                           END  
                      WHEN DATEDIFF(DAY,AFI.FNACIMIENTO,GETDATE())<=54750 THEN '1' 
                   END UNMEDIDA,  
                   CASE WHEN AFI.SEXO ='FEMENINO' THEN 'F' ELSE 'M' END SEXO,  
                   LEFT(AFI.CIUDAD,2) DEPTO,  
                   SUBSTRING(AFI.CIUDAD,3,3) MUNICIPIO,  
                   CASE WHEN AFI.ZONA='R' THEN 'R' ELSE 'U' END ZONA, LEFT(AFI.TIPOAFILIADO,1) AS TIPOAFILIADO
            FROM   RIPSD INNER JOIN FTRD   ON RIPSD.N_FACTURA     = FTRD.N_FACTURA
                         INNER JOIN HPRED  ON FTRD.NOPRESTACION   = HPRED.NOPRESTACION AND FTRD.NOITEM = HPRED.NOITEM
                         INNER JOIN HPRE   ON HPRED.NOPRESTACION  = HPRE.NOPRESTACION
                         INNER JOIN HADM   ON HPRE.NOADMISION     = HADM.NOADMISION
                         INNER JOIN FTR    ON FTRD.CNSFTR         = FTR.CNSFCT
                          LEFT JOIN TER    ON FTR.IDTERCERO       = TER.IDTERCERO 
                          LEFT JOIN AFI    ON HADM.IDAFILIADO     = AFI.IDAFILIADO
                          LEFT JOIN PLN    ON HPRED.IDPLAN        = PLN.IDPLAN
                          LEFT JOIN PPT    ON FTR.IDTERCERO=PPT.IDTERCERO AND FTR.IDPLAN=PPT.IDPLAN
            WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
            AND    RIPSD.PROCEDENCIA = 'SALUD' 
            AND    COALESCE(FTRD.ITFC,0)         <> 2
            AND    AFI.DOCIDAFILIADO NOT IN (SELECT IDUSUARIO FROM RRIPS_US WHERE ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO)  
        ) A
   GROUP BY ENVIO, TIPO_DOC, DOCIDAFILIADO, IDALTERNA2, PAPELLIDO, SAPELLIDO, PNOMBRE, SNOMBRE,
          EDAD, UNMEDIDA, SEXO, DEPTO, MUNICIPIO, ZONA, TIPOAFILIADO
   -- AU
   SELECT DISTINCT @ENVIO AS ENVIO, HADM.NOADMISION
   INTO    #AKK
   FROM   RIPSD INNER JOIN FTRD   ON RIPSD.N_FACTURA     = FTRD.N_FACTURA
                INNER JOIN HPRED  ON FTRD.NOPRESTACION   = HPRED.NOPRESTACION AND FTRD.NOITEM = HPRED.NOITEM
                INNER JOIN HPRE   ON HPRED.NOPRESTACION  = HPRE.NOPRESTACION
                INNER JOIN HADM   ON HPRE.NOADMISION     = HADM.NOADMISION
                 LEFT JOIN AFI    ON HADM.IDAFILIADO     = AFI.IDAFILIADO
   WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
   AND    RIPSD.PROCEDENCIA = 'SALUD' 
   AND    HADM.VIAINGRESO   = 1  
   AND    COALESCE(FTRD.ITFC,0)         <> 2
   
   SELECT NOADMISION, COUNT(*)  AS VECES
   INTO   #AKK2
   FROM   #AKK
   GROUP BY NOADMISION
   HAVING COUNT(*) > 1
   
   DELETE #AKK WHERE NOADMISION IN ( SELECT NOADMISION FROM #AKK2 )
   
   PRINT 'AU sander'
   INSERT INTO RRIPS_AU ( ENVIO, IDTERCERO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, FECHAINGRESO, NUMAUT, CAUSAEXT,
                          DXSALIDA, IDDXREL1, IDDXREL2, IDDXREL3, DESTINOSALIDA, ESTSALIDA, CBMU, FECHASALIDA, NOADMISION )
   SELECT DISTINCT @ENVIO, @IDTERCERO, RIPSD.N_FACTURA, @IDSGSSS, LEFT(AFI.TIPO_DOC,2), AFI.DOCIDAFILIADO, HADM.FECHA, 
          CASE WHEN COALESCE(FTR.VENDEDOR,'')<>'' THEN LEFT(FTR.VENDEDOR,15) ELSE LEFT(HADM.NOAUTORIZACION,15) END,
          HADM.CAUSAEXTERNA, LEFT(UPPER(HADM.DXEGRESO),4), LEFT(UPPER(HADM.DXSALIDA1),4), LEFT(UPPER(HADM.DXSALIDA2),4), LEFT(UPPER(HADM.DXSALIDA3),4),
          CASE WHEN (HADM.DESTINO >= 1 AND HADM.DESTINO <= 3) THEN HADM.DESTINO ELSE '1' END, HADM.ESTADOPSALIDA,
          UPPER(HADM.CAUSABMUERTE), 
          CASE HADM.DESTINO WHEN 1 THEN HADM.FECHAALTAMED --se cambia por fecha de salida de urgencia  SELECT FECHAALTA, FECHAALTAMED FROM HADM
                            ELSE COALESCE(DBO.FNK_FECHASALEURG_HOSP(HADM.NOADMISION),HADM.FECHAALTAMED)
          END,              -- '1-Alta Urgencia|#1|2-A Cirug?|#2|3-Hospitalizaci?|#3|4-No Aplica|#4'
          HADM.NOADMISION 
   FROM   RIPSD INNER JOIN FTRD   ON RIPSD.N_FACTURA     = FTRD.N_FACTURA
                INNER JOIN FTR    ON FTRD.CNSFTR         = FTR.CNSFCT
                INNER JOIN HPRED  ON FTRD.NOPRESTACION   = HPRED.NOPRESTACION AND FTRD.NOITEM = HPRED.NOITEM
                INNER JOIN HPRE   ON HPRED.NOPRESTACION  = HPRE.NOPRESTACION
                INNER JOIN HADM   ON HPRE.NOADMISION     = HADM.NOADMISION
                 LEFT JOIN AFI    ON HADM.IDAFILIADO     = AFI.IDAFILIADO
   WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
   AND    RIPSD.PROCEDENCIA = 'SALUD' 
   AND    HADM.VIAINGRESO   = 1  
   AND    COALESCE(FTRD.ITFC,0)         <> 2
   AND    HADM.NOADMISION IN (SELECT NOADMISION FROM #AKK)
   print'antes del cursor'
   DECLARE @NOADMISION VARCHAR(16)
   
   DECLARE USREP_CUR CURSOR FOR
   SELECT NOADMISION FROM #AKK2
   
   OPEN USREP_CUR
   
   FETCH NEXT FROM USREP_CUR
   INTO @NOADMISION
   
   WHILE @@FETCH_STATUS = 0
   BEGIN          
      INSERT INTO RRIPS_AU ( ENVIO, IDTERCERO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, FECHAINGRESO, NUMAUT, CAUSAEXT,
                             DXSALIDA, IDDXREL1, IDDXREL2, IDDXREL3, DESTINOSALIDA, ESTSALIDA, CBMU, FECHASALIDA, NOADMISION )
      SELECT DISTINCT @ENVIO, @IDTERCERO, RIPSD.N_FACTURA, @IDSGSSS, LEFT(AFI.TIPO_DOC,2), AFI.DOCIDAFILIADO, HADM.FECHA, 
             CASE WHEN COALESCE(FTR.VENDEDOR,'')<>'' THEN LEFT(FTR.VENDEDOR,15) ELSE LEFT(HADM.NOAUTORIZACION,15) END, 
             HADM.CAUSAEXTERNA, UPPER(HADM.DXEGRESO), UPPER(HADM.DXSALIDA1), UPPER(HADM.DXSALIDA2), UPPER(HADM.DXSALIDA3),
             CASE WHEN (HADM.DESTINO >= 1 AND HADM.DESTINO <= 3) THEN HADM.DESTINO ELSE '1' END, HADM.ESTADOPSALIDA,
             UPPER(HADM.CAUSABMUERTE), 
             CASE HADM.DESTINO WHEN 1 THEN HADM.FECHAALTAMED --se cambia por fecha de salida de urgencia  SELECT FECHAALTA, FECHAALTAMED FROM HADM
                               ELSE DBO.FNK_FECHASALEURG_HOSP(HADM.NOADMISION)
             END,   
             HADM.NOADMISION
      FROM   RIPSD INNER JOIN FTRD   ON RIPSD.N_FACTURA     = FTRD.N_FACTURA
                   INNER JOIN HPRED  ON FTRD.NOPRESTACION   = HPRED.NOPRESTACION AND FTRD.NOITEM = HPRED.NOITEM
                   INNER JOIN HPRE   ON HPRED.NOPRESTACION  = HPRE.NOPRESTACION
                   INNER JOIN HADM   ON HPRE.NOADMISION     = HADM.NOADMISION
                    LEFT JOIN AFI    ON HADM.IDAFILIADO     = AFI.IDAFILIADO
      WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
      AND    RIPSD.PROCEDENCIA = 'SALUD' 
      AND    HADM.VIAINGRESO   = 1  
      AND    COALESCE(FTRD.ITFC,0)         <> 2   
      AND    AFI.DOCIDAFILIADO IN (SELECT DOCIDAFILIADO FROM #AKK2)
         
      FETCH NEXT FROM USREP_CUR
      INTO @NOADMISION
      
   END
   CLOSE USREP_CUR
   DEALLOCATE USREP_CUR

   DROP TABLE #AKK   
   DROP TABLE #AKK2   
   
   -- AH
   PRINT 'AH'
   INSERT INTO RRIPS_AH ( ENVIO, IDTERCERO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, VIAINGRESO, FECHAINGRESO, NUMAUT, CAUSAEXT,
                          DXINGRESO, DXEGRESO, DXREL1, DXREL2, DXREL3, DXCOMP, ESTSALIDA, DXCBM, FECHAEGRESO, NOADMISION )
   SELECT DISTINCT @ENVIO, @IDTERCERO, RIPSD.N_FACTURA, @IDSGSSS, LEFT(AFI.TIPO_DOC,2), AFI.DOCIDAFILIADO, HADM.VIAINGRESO, HADM.FECHA, 
          CASE WHEN COALESCE(FTR.VENDEDOR,'')<>'' THEN LEFT(FTR.VENDEDOR,15) ELSE LEFT(HADM.NOAUTORIZACION,15) END,
          HADM.CAUSAEXTERNA, HADM.DXINGRESO, HADM.DXEGRESO, UPPER(HADM.DXSALIDA1), UPPER(HADM.DXSALIDA2), UPPER(HADM.DXSALIDA3),
          UPPER(HADM.COMPLICACION), UPPER(HADM.ESTADOPSALIDA), UPPER(HADM.CAUSABMUERTE),CASE WHEN HADM.CERRADA=0 THEN @FECHAFINAL ELSE HADM.FECHAALTAMED END , HADM.NOADMISION
   FROM   RIPSD INNER JOIN FTRD   ON RIPSD.N_FACTURA     = FTRD.N_FACTURA
                INNER JOIN FTR    ON FTRD.CNSFTR         = FTR.CNSFCT  
                INNER JOIN HPRED  ON FTRD.NOPRESTACION   = HPRED.NOPRESTACION AND FTRD.NOITEM = HPRED.NOITEM
                INNER JOIN HPRE   ON HPRED.NOPRESTACION  = HPRE.NOPRESTACION
                INNER JOIN HADM   ON HPRE.NOADMISION     = HADM.NOADMISION
                INNER JOIN HTAD   ON HADM.TIPOADM        = HTAD.TIPOADM
				INNER JOIN PPT    ON PPT.IDTERCERO		 = FTR.IDTERCERO AND PPT.IDPLAN=FTR.IDPLAN
                 LEFT JOIN AFI    ON HADM.IDAFILIADO     = AFI.IDAFILIADO
   WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
   AND    RIPSD.PROCEDENCIA = 'SALUD' 
   AND    HTAD.TIPOATENCION = 'H'
   AND    COALESCE(FTRD.ITFC,0)         <> 2
   AND    COALESCE(PPT.RIPSAH_SEPARADO,0)=0

   SELECT DISTINCT @ENVIO ENVIO, @IDTERCERO IDTERCERO, RIPSD.N_FACTURA, @IDSGSSS IDSGSSS, LEFT(AFI.TIPO_DOC,2) TIPO_DOC, AFI.DOCIDAFILIADO, HADM.VIAINGRESO, HADM.FECHA FECHAINGRESO, 
          CASE WHEN COALESCE(FTR.VENDEDOR,'')<>'' THEN LEFT(FTR.VENDEDOR,15) ELSE LEFT(HADM.NOAUTORIZACION,15) END NOAUTORIZACION,
          HADM.CAUSAEXTERNA, HADM.DXINGRESO, HADM.DXEGRESO, UPPER(HADM.DXSALIDA1) DXSALIDA1, UPPER(HADM.DXSALIDA2) DXSALIDA2, UPPER(HADM.DXSALIDA3) DXSALIDA3,
          UPPER(HADM.COMPLICACION) COMPLICACION, UPPER(HADM.ESTADOPSALIDA) ESTADOPSALIDA, UPPER(HADM.CAUSABMUERTE) CAUSABMUERTE,CASE WHEN HADM.CERRADA=0 THEN @FECHAFINAL ELSE HADM.FECHAALTAMED END FECHAEGRESO, HADM.NOADMISION
		  INTO #RRIPS_AH
   FROM   RIPSD INNER JOIN FTRD   ON RIPSD.N_FACTURA     = FTRD.N_FACTURA
                INNER JOIN FTR    ON FTRD.CNSFTR         = FTR.CNSFCT  
                INNER JOIN HPRED  ON FTRD.NOPRESTACION   = HPRED.NOPRESTACION AND FTRD.NOITEM = HPRED.NOITEM
                INNER JOIN HPRE   ON HPRED.NOPRESTACION  = HPRE.NOPRESTACION
                INNER JOIN HADM   ON HPRE.NOADMISION     = HADM.NOADMISION
                INNER JOIN HTAD   ON HADM.TIPOADM        = HTAD.TIPOADM
				INNER JOIN PPT    ON PPT.IDTERCERO		 = FTR.IDTERCERO AND PPT.IDPLAN=FTR.IDPLAN
                 LEFT JOIN AFI    ON HADM.IDAFILIADO     = AFI.IDAFILIADO
   WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
   AND    RIPSD.PROCEDENCIA = 'SALUD' 
   AND    HTAD.TIPOATENCION = 'H'
   AND    COALESCE(FTRD.ITFC,0)         <> 2
   AND    COALESCE(PPT.RIPSAH_SEPARADO,0)=1
   ALTER TABLE #RRIPS_AH ADD ITEM INTEGER IDENTITY(1,1)
   DECLARE @IAH INT, @IAH_TO INT, @D INT, @D_TO INT
   SELECT @IAH=1, @IAH_TO=COUNT(1) FROM #RRIPS_AH
   WHILE @IAH<=@IAH_TO
   BEGIN
		SELECT @D_TO=DATEDIFF(DAY,A.FECHAINGRESO,A.FECHAEGRESO), @D=1 FROM #RRIPS_AH A WHERE A.ITEM=@IAH
		WHILE @D<=@D_TO
		BEGIN
		   INSERT INTO RRIPS_AH ( ENVIO, IDTERCERO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, VIAINGRESO, FECHAINGRESO, NUMAUT, CAUSAEXT,
                      DXINGRESO, DXEGRESO, DXREL1, DXREL2, DXREL3, DXCOMP, ESTSALIDA, DXCBM, FECHAEGRESO, NOADMISION )
			SELECT ENVIO, IDTERCERO, N_FACTURA, IDSGSSS, TIPO_DOC, DOCIDAFILIADO, VIAINGRESO, FECHAINGRESO+@D, 
				NOAUTORIZACION, CAUSAEXTERNA, DXINGRESO, DXEGRESO, DXSALIDA1, DXSALIDA2, DXSALIDA3,
				COMPLICACION, ESTADOPSALIDA, CAUSABMUERTE, FECHAINGRESO+@D, NOADMISION
			FROM #RRIPS_AH A WHERE A.ITEM=@IAH
			SET @D+=1
		END
		SET @IAH+=1
   END
   -- AN
   PRINT 'AN'
   INSERT INTO RRIPS_AN ( ENVIO, IDTERCERO, NUMFACTURA, CONSECUTIVO, IDPRESTADOR, TIPOIDM, IDMADRE, FNACIMIENTO, EDADGEST, CPRENATAL, 
                          SEXO, PESO, DXRN, CBM, FMUERTE)
   SELECT DISTINCT @ENVIO, @IDTERCERO, RIPSD.N_FACTURA, QXRCN.CONSECUTIVO, @IDSGSSS, LEFT(AFI.TIPO_DOC,2), AFI.DOCIDAFILIADO, QXRCN.RNFECHANACE,
          LEFT(QXRCN.CMPERIODOGES,2), CASE UPPER(QXRCN.CMCONTROLPRE) WHEN 'SI' THEN '1' ELSE '2' END, UPPER(LEFT(QXRCN.RNSEXO,1)), 
          LEFT(QXRCN.RNPESO,4), LEFT(UPPER(QXRCN.RNDX),4), LEFT(UPPER(QXRCN.RNCAUSAMUERTE),4), QXRCN.RNFECHAMUERTE 
   FROM   RIPSD INNER JOIN FTRD   ON RIPSD.N_FACTURA     = FTRD.N_FACTURA
                INNER JOIN HPRED  ON FTRD.NOPRESTACION   = HPRED.NOPRESTACION AND FTRD.NOITEM = HPRED.NOITEM
                INNER JOIN HPRE   ON HPRED.NOPRESTACION  = HPRE.NOPRESTACION
                INNER JOIN HADM   ON HPRE.NOADMISION     = HADM.NOADMISION
                 LEFT JOIN AFI    ON HADM.IDAFILIADO     = AFI.IDAFILIADO
                INNER JOIN QXRCN  ON HADM.NOADMISION     = QXRCN.NOADMISION
   WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
   AND    RIPSD.PROCEDENCIA = 'SALUD' 
   AND    COALESCE(FTRD.ITFC,0)         <> 2
   -- AF 
   --- MODIFICACION FECHA INICIAL Y FECHA FINAL DE ACUERDO A VARIABLE DEL SISTEMA
   PRINT 'AF'
   --QUERY2
   IF @RIPS_VALORENTERO='SI'
    INSERT INTO RRIPS_AF ( ENVIO, IDTERCERO, IDPRESTADOR, RAZONSOCIAL, TIPO_ID, NUMIDENTIFICACION, NUMFACTURA, FECHAEXPEDICION,
                          FECHAINICIO, FECHAFINAL, CODENTIDADM, NOMBREENTIDADM, NUMEROCONTRATO, 
                          NUMPOLIZA, VALORTOTALCOPAGO, VALORCOMISION, VALORTOTALDESC, VALORNETO ) 
  SELECT DISTINCT @ENVIO, @IDTERCERO, @IDSGSSS, @DPRRS, 'NI', @DPRNIT, RIPSD.N_FACTURA, FTR.F_FACTURA,
  CASE WHEN @RIPS_FEHAINIFINAL='SI' THEN CASE WHEN @PIDEAUTORIZAFACCORTE = 'SI' THEN HADMAUT.F_INICIAL ELSE DBO.FNK_FECHA_SIN_HORA(HADM.FECHA)                              END ELSE @FECHAINICIAL END F_INI,  --STORRES
  CASE WHEN @RIPS_FEHAINIFINAL='SI' THEN CASE WHEN @PIDEAUTORIZAFACCORTE = 'SI' THEN HADMAUT.F_FINAL   ELSE DBO.FNK_FECHA_SIN_HORA(COALESCE(HADM.FECHAALTAMED,@FECHAFINAL)) END ELSE @FECHAFINAL END  F_FIN, --STORRES
   CASE WHEN COALESCE(PPT.IDALTERNA,'')='' THEN  LEFT(ISNULL(TER.IDALTERNA2,''),6) ELSE COALESCE(PPT.IDALTERNA,'') END,
   LEFT(TER.RAZONSOCIAL,30), LEFT(COALESCE (CNT.IDALTERNA, PPT.NROCONTRATO, CASE COALESCE(@RIPS_IDCONTRATO,'') when 'NO' THEN '' ELSE HADM.IDPLAN END ),15)CONTRATO, RIGHT(HADM.NOPOLIZA,10), 
  CASE WHEN @RIPS_COPAGOS='NO' THEN CASE WHEN @RIPS_COPAGOS_FTR='SI' THEN  CAST (FTR.VALORCOPAGO AS INT ) ELSE  0 END  ELSE CAST (FTR.VALORCOPAGO AS INT ) END VALORCOPAGO , '0', '0', 
  CASE WHEN @RIPS_COPAGOS='NO' THEN CASE WHEN @RIPS_COPAGOS_FTR='SI'
																  THEN  CONVERT (VARCHAR (15),CONVERT(DECIMAL(14,2), FTR.VR_TOTAL)) 
                                                                  ELSE CONVERT (VARCHAR (15), CAST (FTR.VALORCOPAGO AS INT )+ CONVERT(DECIMAL(14,2), FTR.VR_TOTAL))  
                                                                  END
 ELSE  CONVERT (VARCHAR (15),CONVERT(DECIMAL(14,2), FTR.VR_TOTAL)) END
 FROM   RIPSD   INNER JOIN FTRD   ON RIPSD.N_FACTURA     = FTRD.N_FACTURA
                INNER JOIN HPRED  ON FTRD.NOPRESTACION   = HPRED.NOPRESTACION AND FTRD.NOITEM = HPRED.NOITEM
                INNER JOIN HPRE   ON HPRED.NOPRESTACION  = HPRE.NOPRESTACION
                INNER JOIN HADM   ON HPRE.NOADMISION     = HADM.NOADMISION
                INNER JOIN FTR    ON FTRD.CNSFTR         = FTR.CNSFCT
                 LEFT JOIN TER    ON FTR.IDTERCERO       = TER.IDTERCERO
				 LEFT JOIN PPT    ON PPT.IDTERCERO		    = FTR.IDTERCERO AND PPT.IDPLAN=FTR.IDPLAN
				 LEFT JOIN CNT    ON CNT.IDCONTRATO		    = PPT.IDCONTRATO
             LEFT JOIN HADMAUT ON HADMAUT.NOADMISION    = HADM.NOADMISION AND HADMAUT.AUTORIZACION = FTR.VENDEDOR --STORRES
   WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
   AND    RIPSD.PROCEDENCIA = 'SALUD'
   AND    COALESCE(FTRD.ITFC,0)         <> 2
   ELSE 
   INSERT INTO RRIPS_AF ( ENVIO, IDTERCERO, IDPRESTADOR, RAZONSOCIAL, TIPO_ID, NUMIDENTIFICACION, NUMFACTURA, FECHAEXPEDICION,
                          FECHAINICIO, FECHAFINAL, CODENTIDADM, NOMBREENTIDADM, NUMEROCONTRATO, 
                          NUMPOLIZA, VALORTOTALCOPAGO, VALORCOMISION, VALORTOTALDESC, VALORNETO ) 
  SELECT DISTINCT @ENVIO, @IDTERCERO, @IDSGSSS, @DPRRS, 'NI', @DPRNIT, RIPSD.N_FACTURA, FTR.F_FACTURA,
  CASE WHEN @RIPS_FEHAINIFINAL='SI' THEN CASE WHEN @PIDEAUTORIZAFACCORTE = 'SI' THEN HADMAUT.F_INICIAL ELSE DBO.FNK_FECHA_SIN_HORA(HADM.FECHA)                              END ELSE @FECHAINICIAL END F_INI,  --STORRES
  CASE WHEN @RIPS_FEHAINIFINAL='SI' THEN CASE WHEN @PIDEAUTORIZAFACCORTE = 'SI' THEN HADMAUT.F_FINAL   ELSE DBO.FNK_FECHA_SIN_HORA(COALESCE(HADM.FECHAALTAMED,@FECHAFINAL)) END ELSE @FECHAFINAL   END F_FIN,  --STORRES
           CASE WHEN COALESCE(PPT.IDALTERNA,'')='' THEN  LEFT(ISNULL(TER.IDALTERNA2,''),6) ELSE COALESCE(PPT.IDALTERNA,'') END,
           LEFT(TER.RAZONSOCIAL,30), LEFT(COALESCE (CNT.IDALTERNA, PPT.NROCONTRATO, CASE COALESCE(@RIPS_IDCONTRATO,'') when 'NO' THEN '' ELSE HADM.IDPLAN END ),15)CONTRATO, RIGHT(HADM.NOPOLIZA,10), 
 CASE WHEN @RIPS_COPAGOS='NO' THEN CASE WHEN @RIPS_COPAGOS_FTR='SI' THEN  CAST (FTR.VALORCOPAGO AS INT ) ELSE  0 END  ELSE CAST (FTR.VALORCOPAGO AS INT ) END VALORCOPAGO , '0', '0', 
 CASE WHEN @RIPS_COPAGOS='NO' THEN CASE WHEN @RIPS_COPAGOS_FTR='SI' 
                                                                  THEN  CONVERT (VARCHAR (15),CONVERT(DECIMAL(14,2), FTR.VR_TOTAL)) 
                                                                  ELSE CONVERT (VARCHAR (15), CAST (FTR.VALORCOPAGO AS INT )+ CONVERT(DECIMAL(14,2), FTR.VR_TOTAL))  
                                                         END
 ELSE  CONVERT (VARCHAR (15),CONVERT(DECIMAL(14,2), FTR.VR_TOTAL)) END
   FROM   RIPSD INNER JOIN FTRD   ON RIPSD.N_FACTURA     = FTRD.N_FACTURA
                INNER JOIN HPRED  ON FTRD.NOPRESTACION   = HPRED.NOPRESTACION AND FTRD.NOITEM = HPRED.NOITEM
                INNER JOIN HPRE   ON HPRED.NOPRESTACION  = HPRE.NOPRESTACION
                INNER JOIN HADM   ON HPRE.NOADMISION     = HADM.NOADMISION
                INNER JOIN FTR    ON FTRD.CNSFTR         = FTR.CNSFCT
                 LEFT JOIN TER    ON FTR.IDTERCERO       = TER.IDTERCERO 
				 LEFT JOIN PPT    ON PPT.IDTERCERO		    = FTR.IDTERCERO  AND PPT.IDPLAN=FTR.IDPLAN
				 LEFT JOIN CNT    ON CNT.IDCONTRATO		    = PPT.IDCONTRATO
             LEFT JOIN HADMAUT ON HADMAUT.NOADMISION    = HADM.NOADMISION AND HADMAUT.AUTORIZACION = FTR.VENDEDOR --STORRES
   WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
   AND    RIPSD.PROCEDENCIA = 'SALUD'
   AND    COALESCE(FTRD.ITFC,0)         <> 2

       UPDATE RRIPS_AF SET PLANBENEFICIOS = CASE WHEN @PLANBENEFICIO = 'SI' THEN FTR.IDPLAN ELSE '' END
       FROM   RRIPS_AF INNER JOIN FTR ON RRIPS_AF.NUMFACTURA = FTR.N_FACTURA
       WHERE  RRIPS_AF.ENVIO = @ENVIO AND RRIPS_AF.IDTERCERO=@IDTERCERO
   
   -- CX AP
   PRINT 'CX AP'
   PRINT 'ENTRE A CX'
   
   DECLARE AP_CURSOR CURSOR FOR    
    SELECT DISTINCT RIPSD.N_FACTURA, LEFT(AFI.TIPO_DOC,2), AFI.DOCIDAFILIADO, HPRE.FECHA,
	CASE WHEN COALESCE( LEFT(HPRE.NUMAUTORIZA,15),'')='' AND COALESCE(HADM.NOAUTORIZACION,'')<>'' 
		THEN LEFT(HADM. NOAUTORIZACION,15) ELSE CASE WHEN COALESCE(FTR.VENDEDOR,'')<>'' THEN LEFT(FTR.VENDEDOR,15) ELSE LEFT(HADM.NOAUTORIZACION,15) END END , 
		 CASE @CODSER WHEN '0' THEN LEFT(SER.IDSERVICIO,6) WHEN '1' THEN LEFT(SER.IDALTERNA,6) WHEN '8' THEN LEFT(SER.CODCUPS,6) ELSE LEFT(SER.IDALTERNA,6) END IDPROCEDIMIENTO,
          AFU.AMBITO, CASE ISNULL(HPRE.FINALIDAD,'') WHEN '' THEN PRE.FINALIDAD ELSE HPRE.FINALIDAD END,
          CASE SER.MPERSONAL_AT WHEN 1 THEN HPRE.PERSONAL_AT ELSE '' END, IIF(@RIPS_DXEGRESO='SI',UPPER(HADM.DXEGRESO),UPPER(HADM.DXINGRESO)), HADM.DXSALIDA1,
          HADM.COMPLICACION, CASE ISNULL(TGEN.DATO1,'') WHEN '' THEN '1' ELSE TGEN.DATO1 END,
          SUM( CASE WHEN COALESCE(FTRD.PAQUETE,0)=2 AND COALESCE(FTRD.PAQUETE,0) NOT IN (2,3) THEN 0 ELSE 
		         CAST(CASE WHEN @RIPS_PROCESOAP='SI' 
							THEN HPRED.VALOR ELSE 0 END  AS INT ) END) VALOR,
          HPRED.NOPRESTACION, FTR.IDTERCERO, HPRED.IDPLAN, FTRD.CNSFTR, NULL, FTRD.CODEVAL
		FROM   RIPSD INNER JOIN FTRD   ON RIPSD.N_FACTURA     = FTRD.N_FACTURA
                INNER JOIN FTR    ON FTRD.CNSFTR         = FTR.CNSFCT
                INNER JOIN HPRED  ON FTRD.NOPRESTACION   = HPRED.NOPRESTACION AND FTRD.NOITEM = HPRED.NOITEM
			    INNER JOIN SER SER1 ON HPRED.IDSERVICIO=SER1.IDSERVICIO
				INNER JOIN PRE PRE1 ON SER1.PREFIJO=PRE1.PREFIJO
                INNER JOIN HPRE   ON HPRED.NOPRESTACION  = HPRE.NOPRESTACION
                INNER JOIN HADM   ON HPRE.NOADMISION     = HADM.NOADMISION
                INNER JOIN AFI    ON HADM.IDAFILIADO     = AFI.IDAFILIADO
                INNER JOIN QXPCXD ON HPRED.CONSECUTIVOCX = QXPCXD.CONSECUTIVO AND HPRED.ITEMCIRUGIA = QXPCXD.ITEM
                INNER JOIN SER    ON QXPCXD.IDSERVICIO   = SER.IDSERVICIO  
                INNER JOIN PRE    ON SER.PREFIJO         = PRE.PREFIJO  
                 LEFT JOIN AFU    ON HPRE.IDAREA         = AFU.IDAREA
                 LEFT JOIN TGEN   ON QXPCXD.TIPOCIRUGIA  = TGEN.CODIGO AND TGEN.CAMPO = 'TIPOCIRUGIA' AND TGEN.TABLA ='General'
   WHERE  RIPSD.ENVIO       = @ENVIO AND RIPSD.IDTERCERO=@IDTERCERO
   AND    COALESCE(FTRD.ITFC,0)         <> 2
   AND    RIPSD.PROCEDENCIA = 'SALUD' 
   AND    COALESCE(HPRED.NOCOBRABLE,0)  = CASE @RIPSNOCOBRABLE WHEN 'SI' THEN  COALESCE(HPRED.NOCOBRABLE,0) ELSE 0 END
   AND    COALESCE(QXPCXD.PAQUETE,0)=0 
   AND  HPRED.TIPOSERCIRUGIA<>'PAQUETE'
   AND    HPRE.PREFIJO = CASE WHEN HPRE.CIRUGIA='SI' AND COALESCE(HPRE.PREFIJO,'')='' THEN '' ELSE (SELECT DATO FROM USVGS WHERE IDVARIABLE='IDCIRPREFIJO') END
   AND    COALESCE(PRE1.MINVENTARIOS,0)=0  

   GROUP BY RIPSD.N_FACTURA, LEFT(AFI.TIPO_DOC,2), AFI.DOCIDAFILIADO, HPRE.FECHA,CASE WHEN COALESCE( LEFT(HPRE.NUMAUTORIZA,15),'')='' AND COALESCE(HADM.NOAUTORIZACION,'')<>'' 
		THEN LEFT(HADM. NOAUTORIZACION,15) ELSE  CASE WHEN COALESCE(FTR.VENDEDOR,'')<>'' THEN LEFT(FTR.VENDEDOR,15) ELSE LEFT(HADM.NOAUTORIZACION,15) END END , 
		 CASE @CODSER WHEN '0' THEN LEFT(SER.IDSERVICIO,6) WHEN '1' THEN LEFT(SER.IDALTERNA,6) WHEN '8' THEN LEFT(SER.CODCUPS,6) ELSE LEFT(SER.IDALTERNA,6) END,
          AFU.AMBITO, CASE ISNULL(HPRE.FINALIDAD,'') WHEN '' THEN PRE.FINALIDAD ELSE HPRE.FINALIDAD END,
          CASE SER.MPERSONAL_AT WHEN 1 THEN HPRE.PERSONAL_AT ELSE '' END, IIF(@RIPS_DXEGRESO='SI',UPPER(HADM.DXEGRESO),UPPER(HADM.DXINGRESO)), HADM.DXSALIDA1,
          HADM.COMPLICACION, CASE ISNULL(TGEN.DATO1,'') WHEN '' THEN '1' ELSE TGEN.DATO1 END,
          HPRED.NOPRESTACION, FTR.IDTERCERO, HPRED.IDPLAN, FTRD.CNSFTR,  FTRD.CODEVAL
  ORDER BY HPRE.FECHA
	 
   OPEN AP_CURSOR  
   FETCH NEXT FROM AP_CURSOR  
   INTO @NUMFACTURA, @TIPO_DOC, @IDUSUARIO, @FECHAPROCEDIMIENTO, @NUMAUT, @IDPROCEDIMIENTO,
        @AMBITO, @FINPROCEDIMIENTO, @PERSONALA, @DXPPAL, @DXREL, @COMPLICACION, @ACTOQ,@VALORPROCED,
        @NOPRESTACION, @IDTERCERO, @IDPLAN, @CNSFTR, @N_CUOTA, @CODEVAL
   WHILE @@FETCH_STATUS = 0  
   BEGIN


	   IF @RIPS_VALORENTERO='SI'
         INSERT INTO RRIPS_AP (ENVIO, IDTERCERO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, FECHAPROCEDIMIENTO, NUMAUT, IDPROCEDIMIENTO,
                               AMBITO, FINPROCEDIMIENTO, PERSONALA, DXPPAL, DXREL, COMPLICACION, ACTOQ, VALORPROCED, NOPRESTACION,
                               CNSFTR, N_CUOTA, CANTIDAD, PROCEDENCIA, CODEVAL) 
         SELECT @ENVIO, @IDTERCERO, @NUMFACTURA, @IDSGSSS, @TIPO_DOC, @IDUSUARIO, @FECHAPROCEDIMIENTO, @NUMAUT, @IDPROCEDIMIENTO,
                @AMBITO, @FINPROCEDIMIENTO, @PERSONALA, @DXPPAL, @DXREL, @COMPLICACION, @ACTOQ, CONVERT(VARCHAR(20),CAST( @VALORPROCED AS INT )) ,
                @NOPRESTACION, @CNSFTR, @N_CUOTA, 1, 'QX', @CODEVAL

      ELSE 
	   INSERT INTO RRIPS_AP (ENVIO, IDTERCERO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, FECHAPROCEDIMIENTO, NUMAUT, IDPROCEDIMIENTO,
                               AMBITO, FINPROCEDIMIENTO, PERSONALA, DXPPAL, DXREL, COMPLICACION, ACTOQ, VALORPROCED, NOPRESTACION,
                               CNSFTR, N_CUOTA, CANTIDAD, PROCEDENCIA, CODEVAL) 
         SELECT @ENVIO, @IDTERCERO, @NUMFACTURA, @IDSGSSS, @TIPO_DOC, @IDUSUARIO, @FECHAPROCEDIMIENTO, @NUMAUT, @IDPROCEDIMIENTO,
                @AMBITO, @FINPROCEDIMIENTO, @PERSONALA, @DXPPAL, @DXREL, @COMPLICACION, @ACTOQ,  CONVERT(VARCHAR(20),@VALORPROCED) ,
                @NOPRESTACION, @CNSFTR, @N_CUOTA, 1, 'QX', @CODEVAL

      FETCH NEXT FROM AP_CURSOR  
      INTO @NUMFACTURA, @TIPO_DOC, @IDUSUARIO, @FECHAPROCEDIMIENTO, @NUMAUT, @IDPROCEDIMIENTO,
           @AMBITO, @FINPROCEDIMIENTO, @PERSONALA, @DXPPAL, @DXREL, @COMPLICACION, @ACTOQ,@VALORPROCED,
           @NOPRESTACION, @IDTERCERO, @IDPLAN, @CNSFTR, @N_CUOTA, @CODEVAL
   END
   CLOSE AP_CURSOR  
   DEALLOCATE AP_CURSOR 
    
  IF EXISTS (SELECT * FROM RRIPS_AP WHERE CANTIDAD>1 AND ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO AND DBO.FNK_VALORVARIABLE('RRIPS_AP_CANT_MAYOR1')<>'SI')
  BEGIN
     PRINT 'SI EXISTE AP >0 '
      DECLARE @ITEM INT
      DECLARE @CANTAT INT 
      DECLARE @BAND INT
	   DECLARE RRIPS_AP_CUR CURSOR FOR 
      SELECT ITEM,CANTIDAD FROM RRIPS_AP WHERE CANTIDAD>1 AND ENVIO=@ENVIO  AND IDTERCERO=@IDTERCERO  
      ORDER BY ITEM 
	   OPEN RRIPS_AP_CUR    
	   FETCH NEXT FROM RRIPS_AP_CUR    
	   INTO @ITEM,@CANTAT
	   WHILE @@FETCH_STATUS = 0    
	   BEGIN
         UPDATE RRIPS_AP SET CANTIDAD=1,VALORPROCED=CAST(CONVERT(INT,ROUND((CONVERT(NUMERIC(14,2),VALORPROCED)),0)) AS VARCHAR(15)) WHERE ENVIO=@ENVIO AND ITEM=@ITEM
         SELECT * INTO #XR FROM RRIPS_AP WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO AND ITEM=@ITEM
         SELECT @BAND=1
         WHILE @BAND<@CANTAT
         BEGIN
	         INSERT INTO RRIPS_AP (ENVIO, IDTERCERO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, FECHAPROCEDIMIENTO, NUMAUT, IDPROCEDIMIENTO,
                               AMBITO, FINPROCEDIMIENTO, PERSONALA, DXPPAL, DXREL, COMPLICACION, ACTOQ, VALORPROCED, NOPRESTACION,
                               CNSFTR, N_CUOTA, CANTIDAD, PROCEDENCIA, CODEVAL) 
            SELECT 
                  ENVIO, IDTERCERO, NUMFACTURA, IDPRESTADOR, TIPO_DOC, IDUSUARIO, FECHAPROCEDIMIENTO, NUMAUT, IDPROCEDIMIENTO,
                               AMBITO, FINPROCEDIMIENTO, PERSONALA, DXPPAL, DXREL, COMPLICACION, ACTOQ,
							   CASE WHEN @RIPS_VALORENTERO='SI' THEN CONVERT(VARCHAR(20),CAST( VALORPROCED AS INT)) 
							   ELSE  CONVERT(VARCHAR(20),CAST( VALORPROCED AS DECIMAL(12,2))) END, NOPRESTACION,
                               CNSFTR, N_CUOTA, 1, PROCEDENCIA, CODEVAL
            FROM #XR
            SELECT @BAND=@BAND+1
         END
         DROP TABLE #XR
	   FETCH NEXT FROM RRIPS_AP_CUR    
	   INTO @ITEM,@CANTAT
	   END
	   CLOSE RRIPS_AP_CUR
	   DEALLOCATE RRIPS_AP_CUR      
  END
  ELSE
  BEGIN
     UPDATE RRIPS_AP SET VALORPROCED=CASE WHEN @RIPS_VALORENTERO='SI' THEN CONVERT(VARCHAR(15),CAST(ROUND((VALORPROCED*CANTIDAD),2) AS INT)) 
							   ELSE  CONVERT(VARCHAR(20),CAST( ROUND((VALORPROCED*CANTIDAD),2) AS DECIMAL(14,2))) END
      WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO
  END

  BEGIN --COVID
     PRINT 'Reviso facturas con solo muestras COVID'
     DECLARE @COVID TABLE (ID INT IDENTITY, N_FACTURA VARCHAR(20))
     DECLARE @I INT, @I_TO INT, @N_FACTURA VARCHAR(20), @CANTC INT

     INSERT INTO @COVID (N_FACTURA)
     SELECT FTRD.N_FACTURA
     FROM RIPSD 
        INNER JOIN FTRD ON FTRD.N_FACTURA=RIPSD.N_FACTURA
        INNER JOIN SER ON SER.IDSERVICIO=FTRD.REFERENCIA
     WHERE SER.CODCUPS='906340' AND RIPSD.ENVIO=@ENVIO
      AND RIPSD.IDTERCERO=@IDTERCERO AND RIPSD.PROCEDENCIA='SALUD' 
     GROUP BY FTRD.N_FACTURA
     HAVING COUNT(1)=1

     SELECT @I=1, @I_TO=MAX(ID) FROM @COVID

     WHILE @I<=@I_TO
     BEGIN
        SELECT @N_FACTURA=N_FACTURA FROM @COVID WHERE ID=@I

        SELECT @FECHAINICIAL=LING.FECHA, @FECHAFINAL=LORDD.FECHA, @CANTC=1
        FROM FTR 
	        INNER JOIN FTRD ON FTRD.N_FACTURA=FTR.N_FACTURA
	        INNER JOIN HPRED ON HPRED.NOPRESTACION=FTRD.NOPRESTACION AND HPRED.NOITEM=FTRD.NOITEM
	        INNER JOIN LING ON LING.NOADMISION=FTR.NOREFERENCIA AND LING.TIPOINGRESO='A'
	        INNER JOIN LORD ON LORD.NOINGRESO=LING.NOINGRESO AND LORD.IDSERVICIO=HPRED.IDSERVICIO
	        INNER JOIN LORDD ON LORDD.NORDEN=LORD.NORDEN AND LORDD.TIPOCAMPO='FECHA'
        WHERE FTR.N_FACTURA=@N_FACTURA
		
		IF COALESCE(@CANTC,0)>=1
		BEGIN
        UPDATE RRIPS_AF SET FECHAINICIO= CASE WHEN @FECHAINICIAL IS NULL THEN FECHAINICIO ELSE @FECHAINICIAL END, FECHAFINAL=CASE WHEN @FECHAFINAL IS NULL THEN FECHAFINAL ELSE @FECHAFINAL END   --STORRES
        WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO AND NUMFACTURA=@N_FACTURA
		
        UPDATE RRIPS_AU SET FECHAINGRESO= CASE WHEN @FECHAINICIAL IS NULL THEN FECHAINGRESO ELSE @FECHAINICIAL END, FECHASALIDA=CASE WHEN @FECHAFINAL IS NULL THEN FECHASALIDA ELSE @FECHAFINAL END  --STORES
        WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO AND NUMFACTURA=@N_FACTURA

        UPDATE RRIPS_AH SET FECHAINGRESO= CASE WHEN @FECHAINICIAL IS NULL THEN FECHAINGRESO ELSE @FECHAINICIAL END, FECHAEGRESO=CASE WHEN @FECHAFINAL IS NULL THEN FECHAEGRESO ELSE @FECHAFINAL END   --STORRES
        WHERE ENVIO=@ENVIO AND IDTERCERO=@IDTERCERO AND NUMFACTURA=@N_FACTURA
		END
        SET @I+=1
     END
     DELETE @COVID
  END


   PRINT 'SALI DE CX'
   --UPDATE RIPS SET ESTADO = '02' WHERE ENVIO = @ENVIO AND IDTERCERO=@IDTERCERO
END


