IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='FNK_DIAS_VACACIONES_CALENDARIO' AND XTYPE='TF')
BEGIN
   DROP FUNCTION DBO.FNK_DIAS_VACACIONES_CALENDARIO 
END
GO
CREATE FUNCTION DBO.FNK_DIAS_VACACIONES_CALENDARIO(
 @FECHAINI      DATETIME,
 @DIAS          INT, 
 @SABADOS       SMALLINT, 
 @DOMINGOS      SMALLINT,
 @FESTIVOS      SMALLINT 
 )   
RETURNS  @RESULTADO TABLE(
   F_REGRESO DATETIME,
   DIASPAGO  SMALLINT
)  
AS  
BEGIN  
DECLARE @CONT INT  
DECLARE @DADISFRUTAR INT  
DECLARE @FECHA DATETIME       
DECLARE @DIASEMANA SMALLINT
DECLARE @DIASFINMES SMALLINT
DECLARE @ULTIMO SMALLINT   
	SELECT @CONT=1,@DIASFINMES=0
	SELECT @DADISFRUTAR=0 
	SELECT @FECHA=@FECHAINI  
	WHILE @CONT<=@DIAS
	BEGIN  
		SELECT @DIASEMANA = DATEPART(WEEKDAY,@FECHA)
		IF EXISTS(SELECT * FROM FES WHERE FECHA=@FECHA)
		BEGIN
			IF @CONT=@DIAS AND @FESTIVOS=0 AND @DIASEMANA<>7
			BEGIN
				SELECT @ULTIMO=1
			END
			
			IF @FESTIVOS = 1
			BEGIN
				--SE AGREGA CUANDO ES FESTIVO Y SI DEBE TRABAJARLO AUMENTA EL CONTADOR PERO NO SUMA
				IF @CONT=@DIAS 
				BEGIN
					SELECT @CONT = @CONT + 1
					CONTINUE
				END	
				ELSE
				BEGIN
					SELECT @CONT = @CONT + 1
				END
			END
			
			SELECT @DADISFRUTAR = @DADISFRUTAR + 1 
			SELECT @FECHA = @FECHA + 1
			CONTINUE
		END

		IF @FECHA=DBO.FNK_DIA_DEL_MES(YEAR(@FECHA),MONTH(@FECHA),'ULTIMO')
		BEGIN
			SELECT @DIASFINMES=@DIASFINMES+(30-DAY(@FECHA)) 
			SELECT @DADISFRUTAR = @DADISFRUTAR + @DIASFINMES
		END

		IF  @DIASEMANA = 7 
		BEGIN
			IF @DOMINGOS = 1 
			BEGIN
				SELECT @CONT = @CONT + 1 
			END
			SELECT @DADISFRUTAR = @DADISFRUTAR + 1 
			SELECT @FECHA = @FECHA + 1
			CONTINUE
		END
		
		IF  @DIASEMANA = 6
		BEGIN
		    --SE AGREGA ESTA LINEA CUANDO EL ULTIMO DIA ES SABADO Y EL DOMINGO NO TRABAJA
			IF @CONT=@DIAS AND @DOMINGOS=0 AND @SABADOS=1
			BEGIN
				SELECT @ULTIMO=1
			END
			ELSE
			BEGIN
				IF @SABADOS = 1 
				BEGIN
					SELECT @CONT = @CONT + 1 
				END
			END
			SELECT @FECHA = @FECHA + 1
			SELECT @DADISFRUTAR = @DADISFRUTAR + 1 
			CONTINUE
		END

		--SE AGREGA ESTA LINEA CUANDO EL ULTIMO DIA ES VIERNES Y EL SABADO NO TRABAJA
		IF  @DIASEMANA = 5 AND @CONT=@DIAS --AND @SABADOS=0
		BEGIN
			IF @SABADOS=0
			BEGIN
				SELECT @ULTIMO=1
			END
			SELECT @CONT = @CONT + 1
			SELECT @FECHA = @FECHA + 1
			SELECT @DADISFRUTAR = @DADISFRUTAR + 1
			CONTINUE
		END
	    --SE AGREGA ESTA LINEA CUANDO ES DIFERENTE DE FESTIVO O FIN DE SEMANA Y YA PASÃ“ EL ULTIMO DIA HABIL ESTE AUMENTA EL DIA PERO NO SUMA
		IF @DIAS=@CONT AND @ULTIMO=1
		BEGIN 
			SELECT @CONT = @CONT + 1  
		END
		ELSE
		BEGIN
			SELECT @CONT = @CONT + 1      
			SELECT @FECHA = @FECHA + 1
			SELECT @DADISFRUTAR = @DADISFRUTAR + 1
		END
		--SE AGREGA ESTA LINEA CUANDO EL SIGUIENTE DIA DE SU REGRESO ES FESTIVO, ENTRE SEMANA
		IF EXISTS(SELECT * FROM FES WHERE FECHA=@FECHA+1 AND @CONT=@DIAS AND @FESTIVOS=0)
		BEGIN 
			SELECT @FECHA = @FECHA + 1
			SELECT @DADISFRUTAR = @DADISFRUTAR + 1			
		END
	END  
	--DIA DE REGRESO
   IF DATEPART(WEEKDAY,@FECHA)=6 AND @SABADOS=0 -- VALIDO SI LA FECHA DE REGRESO ES UN SABADO PERO NO LO CUENTAN + 2 DIAS
   BEGIN
      SELECT @FECHA = @FECHA + 2
      SELECT @DADISFRUTAR = @DADISFRUTAR + 1	
   END
   --VALIDO DE NUEVO EL LUNES FESTIVO 
	IF EXISTS(SELECT * FROM FES WHERE FECHA=@FECHA)
	BEGIN
      SELECT @FECHA = @FECHA + 1
      SELECT @DADISFRUTAR = @DADISFRUTAR + 1
   END
	INSERT INTO @RESULTADO(F_REGRESO,DIASPAGO)
	SELECT @FECHA,@DADISFRUTAR
	RETURN
END

