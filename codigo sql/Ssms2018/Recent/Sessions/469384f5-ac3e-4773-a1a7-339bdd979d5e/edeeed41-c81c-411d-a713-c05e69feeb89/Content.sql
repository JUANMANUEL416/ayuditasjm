IF EXISTS (SELECT name FROM sysobjects WHERE name = 'SPK_CIERRERECIBO_CAJA' AND type = 'P')
   DROP PROCEDURE SPK_CIERRERECIBO_CAJA

GO
CREATE PROCEDURE  DBO.SPK_CIERRERECIBO_CAJA  
@CODCAJA          VARCHAR(4),
@CNSFACJ          VARCHAR(20),
@COMPANIA         VARCHAR(2),
@SEDE             VARCHAR(5), 
@USUARIO          VARCHAR(12),
@SYS_COMPUTERNAME VARCHAR(254)
WITH ENCRYPTION
AS  
DECLARE @OK               INT
DECLARE @CLASER           VARCHAR(1)
DECLARE @TIPOPAGO         VARCHAR(3)
DECLARE @VALOR            DECIMAL(14,2)
DECLARE @TIPO             VARCHAR(7)
DECLARE @PROCEDENCIA      VARCHAR(10)
DECLARE @DATO             VARCHAR(80)
DECLARE @DATO1            VARCHAR(80)
DECLARE @ESTADO           VARCHAR(1) 
DECLARE @IDAFILIADO       VARCHAR(20)
DECLARE @NVOVONSEC        VARCHAR(20)
DECLARE @NVOCONSEC1       VARCHAR(20)
DECLARE @NVOCONSEC2       VARCHAR(20)
DECLARE @CNSACJ           VARCHAR(20)
DECLARE @CNSPCJ           VARCHAR(20)
DECLARE @ABIERTA          SMALLINT
DECLARE @VALORTOTAL       DECIMAL(14,2)
DECLARE @DOC1             VARCHAR(16)
DECLARE @DOC2             VARCHAR(16) 
DECLARE @CLASE_FAC        VARCHAR(5)
DECLARE @IDTERCERO        VARCHAR(20)
DECLARE @TIPOEGRESO       VARCHAR(8)
DECLARE @DATO2            VARCHAR(80)
DECLARE @DATO3            VARCHAR(80)
DECLARE @DATO4            VARCHAR(80)
DECLARE @DATO5            VARCHAR(80)
DECLARE @DATO6            VARCHAR(80)
DECLARE @DATO7            VARCHAR(80)
DECLARE @CPRECTRAS        VARCHAR(80)
DECLARE @DATOCHQ          VARCHAR(80)
DECLARE @DATOEFE          VARCHAR(80)
DECLARE @DATOAPE          VARCHAR(80)
DECLARE @DATON            VARCHAR(80)
DECLARE @DATOCATCAJA      VARCHAR(80)
DECLARE @BANCO            VARCHAR(3)
DECLARE @SUCURSAL         VARCHAR(2)
DECLARE @CTA_BCO          VARCHAR(40)
DECLARE @CSGBANCO         VARCHAR(3)
DECLARE @CSGSUCURSAL      VARCHAR(2)
DECLARE @CSGCTA_BCO       VARCHAR(40)
DECLARE @CNSDOC           VARCHAR(20)
DECLARE @NUMERODOCUMENTO  VARCHAR(20)   
DECLARE @NODOCUMENTO      VARCHAR(20)   
DECLARE @N_RECIBO         VARCHAR(20)
DECLARE @CODCAJADEP       VARCHAR(5)
DECLARE @CNSFACJDEP       VARCHAR(20)
DECLARE @DEAPERTURA       SMALLINT
DECLARE @ITEMBMOV         INT 
DECLARE @IDOPERACION      VARCHAR(20)
DECLARE @RENGLON          SMALLINT
DECLARE @CCOSTO           VARCHAR(20)
DECLARE @IDAREA           VARCHAR(20)
DECLARE @CUENTA           VARCHAR(16)
DECLARE @FECHA            DATETIME
DECLARE @CNSFCXP          VARCHAR(20)
DECLARE @CNSCXC           VARCHAR(20)
DECLARE @CONCEPTO         VARCHAR(10)
DECLARE @IDTERCERO_CXP    VARCHAR(20)
DECLARE @VALOR_CXP        DECIMAL (14,2)
DECLARE @F_VENCE          DATETIME
DECLARE @NOMBRECLIENTE    VARCHAR(40)
DECLARE @OBSERVACION      VARCHAR(255) 
DECLARE @DOCORIGEN        INT 
DECLARE @NVOCONSEC        VARCHAR(20)
DECLARE @ITEM             INT
DECLARE @CODIGOCPCJ       VARCHAR(20)
DECLARE @DATOCEHOSP       VARCHAR(80)
DECLARE @DEVDOC           VARCHAR(20)
DECLARE @NROCOMPROBANTE   VARCHAR(20)
DECLARE @RECBCO           INT
DECLARE @BANCO2           VARCHAR(3)
DECLARE @SUCURSAL2        VARCHAR(2)
DECLARE @CTA_BCO2         VARCHAR(20)
DECLARE @DEVREC           VARCHAR(20)
DECLARE @CODCAJA_DEV      VARCHAR(4)
DECLARE @CNSFACJ_DEV      VARCHAR(20)
DECLARE @PROC_DEV         VARCHAR(10)
DECLARE @NOADMISION_DEV   VARCHAR(20)
DECLARE @NOPRESTACION_DEV VARCHAR(20)
DECLARE @CONSECUTIVOCAN   VARCHAR (20)
DECLARE @VALORTOTAL1      DECIMAL(14,2)
DECLARE @VALORTOTAL2      DECIMAL(14,2)
DECLARE @IDTERCERO1       VARCHAR(20)
DECLARE @NOINGRESODEPORI  VARCHAR(16)
DECLARE @VALORDEPORI      DECIMAL(14,2)
DECLARE @TRASACAJA        VARCHAR(80) 
DECLARE @VALORREINTEGRO   DECIMAL(14,2)
DECLARE @G_REINT          SMALLINT
DECLARE @NVOCONSECTFCJ    VARCHAR(20)
DECLARE @CNSPCJAUX        VARCHAR(20)  
DECLARE @TOTREINTEGRO     DECIMAL(14,2)
DECLARE @CNSCXP           VARCHAR(20) --PPTO
DECLARE @CNSPPTO          VARCHAR(20) --PPTO
DECLARE @CNSCDP           VARCHAR(20) --PPTO
DECLARE @CNSRP            VARCHAR(20) --PPTO
DECLARE @CNSPAGO          VARCHAR(20) --PPTO
DECLARE @FPAGO            DATETIME    --PPTO
DECLARE @PBANCO           VARCHAR(20) --PPTO
DECLARE @PCUENTA          VARCHAR(20) --PPTO
DECLARE @PSUCURSAL        VARCHAR(20) --PPTO
DECLARE @PFORMA           VARCHAR(20) --PPTO
DECLARE @PCCOSTO          VARCHAR(20) --PPTO
DECLARE @DESFORMA         VARCHAR(50) --PPTO
DECLARE @PDOCUMENTO       VARCHAR(20) --PPTO
DECLARE @ESPART           BIT          --PPTO
DECLARE @PABONO           DECIMAL(14,2) --PPTO
DECLARE @OBSERVACIONPPTO  VARCHAR(500)  --PPTO
DECLARE @F_PAGOPPTO        DATETIME  --PPTO
DECLARE @CONSECUTIVO      VARCHAR(20)
DECLARE @RUBRO            VARCHAR(20)
DECLARE @RECO             VARCHAR(20)
DECLARE @CCOSTOPRESUP     VARCHAR(20)
DECLARE @RECA             VARCHAR(20)
DECLARE @SI               SMALLINT
DECLARE @VLR_CXPPANT      DECIMAL(14,2)
DECLARE @DATOPAGARE       VARCHAR (80)
DECLARE @CNSFCXPCJM VARCHAR(20)   --REEMBOLSO CAJA MENOR
DECLARE @RESPONCJM  VARCHAR(20)   --REEMBOLSO CAJA MENOR
DECLARE @CAJAMENOR  VARCHAR(4)    --REEMBOLSO CAJA MENOR
DECLARE @VLRPAGOCJM DECIMAL(14,2) --REEMBOLSO CAJA MENOR
DECLARE @CNSFCXPPM  VARCHAR(20)   --REEMBOLSO CAJA MENOR
DECLARE @AUX INT
DECLARE @PCJTERCERO  VARCHAR(20) --PGA.CXC=1
DECLARE @PCJTIPOPAGO VARCHAR(10) --PGA.CXC=1
DECLARE @VALORTPAGO  DECIMAL(14,2) --PGA.CXC=1
DECLARE @CNSDOCPCJ   VARCHAR(20) --PGA.CXC=1
DECLARE @FACTURADOC  VARCHAR(20) --PGA.CXC=1
DECLARE @CNSPCJPAGO  VARCHAR(20) --PGA.CXC=1
DECLARE @CUENTAPCJ   VARCHAR(20) --PGA.CXC=1
DECLARE @VALORPAGO   DECIMAL(14,2)-- ABONO A FACTURAS
DECLARE @IDCATEGORIA VARCHAR(10)
DECLARE @IDPLANFCJ   VARCHAR(6)
BEGIN
   --    SELECT @OK = COUNT(*) FROM FCJ WHERE CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA AND IMPRESO = 0  
   --    IF @OK IS NULL
   --       SELECT @OK = 0
   --    IF @OK > 0 
   --       RETURN
   SET @OK = 0
   SELECT @ESPART=0
   PRINT 'INGRESO AL SPK'
   SELECT @DATOCEHOSP = DATO FROM USVGS WHERE IDVARIABLE = 'CETIPOAUTORIZACION'
   
   SELECT @ESTADO         = ESTADO,         @IDAFILIADO  = IDAFILIADO,   @VALORTOTAL    = VALORTOTAL, @VALORTOTAL2    = VALORTOTAL,
          @DOC1           = NOADMISION,     @DOC2        = NOPRESTACION, @CLASE_FAC     = CLASE_FAC,
          @IDTERCERO      = IDTERCERO,      @TIPOEGRESO  = TIPOEGRESO,   @N_RECIBO      = N_RECIBO,
          @DEAPERTURA     = COALESCE(DEAPERTURA,0),      @CSGBANCO    = BANCO,        @CSGSUCURSAL   = SUCURSAL,
          @CSGCTA_BCO     = CTA_BCO,        @FECHA       = FECHA,        @NOMBRECLIENTE = NOMBRECLIENTE,
          @NROCOMPROBANTE = NROCOMPROBANTE, @OBSERVACION = OBSERVACION,  @CLASER        = CLASER, 
          @TIPO           = TIPO,           @PROCEDENCIA = PROCEDENCIA,  @IDPLANFCJ     = IDPLAN
   FROM   FCJ 
   WHERE  CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA

 
   SELECT @IDCATEGORIA=IDCATEGORIA FROM CJTE WHERE TIPOEGRESO=@TIPOEGRESO

   SELECT @AUX = COALESCE(PRI.CERRADO,0) FROM PRI WHERE ANO = DATEPART(YEAR,@FECHA) AND MES = DATEPART(MONTH,@FECHA)
   IF @AUX = 1
   BEGIN
      RAISERROR('PERIODO CERRADO ',16,1)
      RETURN
   END 
   IF NOT EXISTS(SELECT * FROM PCJ WHERE CODCAJA=@CODCAJA AND CNSFACJ=@CNSFACJ)
   BEGIN
      RAISERROR('NO EXISTEN FORMAS DE PAGO ',16,1)
      RETURN      
   END
   SELECT @DATOCHQ = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJFPACHEQUE'
   SELECT @DATOEFE = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJFPAEFECTIVO'
   SELECT @DATOAPE = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJAPERTURACAJA'
   ---JGOMEZ---07.09.2015
   SELECT @DATOPAGARE= DATO FROM USVGS WHERE IDVARIABLE='IDCPCJPAGARE'
   
   IF @ESTADO IS NULL
   BEGIN
      SELECT @ESTADO = 'P'
   END
   
   IF @DEAPERTURA IS NULL
   BEGIN
      SELECT @DEAPERTURA = 0
   END
   
   CREATE TABLE #TPCJ (TIPOPAGO        VARCHAR(3)  COLLATE database_default,  
                       VALOR           DECIMAL(14,2),
                       BANCO           VARCHAR(3)  COLLATE database_default,  
                       SUCURSAL        VARCHAR(2)  COLLATE database_default,
                       CTA_BCO         VARCHAR(40) COLLATE database_default, 
                       CNSDOC          VARCHAR(20) COLLATE database_default,
                       NUMERODOCUMENTO VARCHAR(20) COLLATE database_default, 
                       CODCAJADEP      VARCHAR(5)  COLLATE database_default,
                       CNSFACJDEP      VARCHAR(20) COLLATE database_default) 
   
   IF @CLASE_FAC = 'COBRO'
   BEGIN   
      IF @ESTADO <> 'A' -- OR @ESTADO IS NULL ARREGLAR?
      BEGIN           
         SELECT @DATO1 = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJPART' 
         IF @CLASER = 'S'
         BEGIN
            EXEC SPK_PEDIDOINV_CAJA @CNSFACJ, @CODCAJA, @SYS_COMPUTERNAME, @SEDE, @COMPANIA, @USUARIO 
            -- LLEVAR EL CONTROL DE FORMAS DE PAGO EN LA CAJA
         END
         IF  @PROCEDENCIA = 'CE'  OR @PROCEDENCIA = 'CITAS'
         BEGIN
			IF @PROCEDENCIA = 'CITAS'
				BEGIN
					IF  @IDPLANFCJ = DBO.FNK_VALORVARIABLE('IDPLANPART')  OR 
						@IDPLANFCJ = DBO.FNK_VALORVARIABLE('IDPLANPART2') OR
						@IDPLANFCJ = DBO.FNK_VALORVARIABLE('IDPLANPART3') OR 
						@IDPLANFCJ = DBO.FNK_VALORVARIABLE('IDPLANPART4') OR 
						@IDPLANFCJ = DBO.FNK_VALORVARIABLE('IDPLANPART5') 
					BEGIN
                  PRINT 'CITAS PARTICULAR'
						UPDATE FCJ SET OBSERVACION=OBSERVACION+' CONCEPTO DE PAGO CITA DE '+SER.DESCSERVICIO+' MEDICO :'+MED.NOMBRE
						FROM FCJ INNER JOIN CIT ON FCJ.NOADMISION=CIT.CONSECUTIVO
									LEFT JOIN SER ON CIT.IDSERVICIO=SER.IDSERVICIO
									LEFT JOIN MED ON CIT.IDMEDICO=MED.IDMEDICO
						WHERE FCJ.CODCAJA=@CODCAJA
						AND FCJ.CNSFACJ=@CNSFACJ
					END
					ELSE
					BEGIN
						UPDATE FCJ SET OBSERVACION=OBSERVACION+' CONCEPTO DE COPAGO Y/O CUOTA MODERADORA CITA DE '+SER.DESCSERVICIO+' MEDICO :'+MED.NOMBRE
						FROM FCJ INNER JOIN CIT ON FCJ.NOADMISION=CIT.CONSECUTIVO
									LEFT JOIN SER ON CIT.IDSERVICIO=SER.IDSERVICIO
									LEFT JOIN MED ON CIT.IDMEDICO=MED.IDMEDICO
						WHERE FCJ.CODCAJA=@CODCAJA
						AND FCJ.CNSFACJ=@CNSFACJ
					END

				END
            IF @PROCEDENCIA = 'CE'
            BEGIN
               PRINT 'VOY A LLENAR OBSERVACION'
				IF  @IDPLANFCJ = DBO.FNK_VALORVARIABLE('IDPLANPART')  OR 
					@IDPLANFCJ = DBO.FNK_VALORVARIABLE('IDPLANPART2') OR
					@IDPLANFCJ = DBO.FNK_VALORVARIABLE('IDPLANPART3') OR 
					@IDPLANFCJ = DBO.FNK_VALORVARIABLE('IDPLANPART4') OR 
					@IDPLANFCJ = DBO.FNK_VALORVARIABLE('IDPLANPART5') 
				BEGIN
					UPDATE FCJ SET OBSERVACION=COALESCE(OBSERVACION,'')+' CONCEPTO DE PAGO ORDEN MEDICA NRO.'+AUT.NOAUT+' DE '+PRE.NOM_PREFIJO+' SOLICITANTE :'+COALESCE(MED.NOMBRE,'')
					FROM FCJ INNER JOIN AUT ON FCJ.NOADMISION=AUT.NOAUT AND FCJ.NOPRESTACION=AUT.IDAUT
						LEFT JOIN PRE ON AUT.PREFIJO=PRE.PREFIJO
						LEFT JOIN MED ON AUT.IDSOLICITANTE=MED.IDMEDICO
					WHERE FCJ.CODCAJA=@CODCAJA
					AND FCJ.CNSFACJ=@CNSFACJ
				END
				ELSE
				BEGIN
					UPDATE FCJ SET OBSERVACION=COALESCE(OBSERVACION,'')+' CONCEPTO DE COPAGO Y/O CUOTA MODERADORA ORDEN MEDICA NRO.'+AUT.NOAUT+' DE '+PRE.NOM_PREFIJO+' SOLICITANTE :'+COALESCE(MED.NOMBRE,'')
					FROM FCJ INNER JOIN AUT ON FCJ.NOADMISION=AUT.NOAUT AND FCJ.NOPRESTACION=AUT.IDAUT
						LEFT JOIN PRE ON AUT.PREFIJO=PRE.PREFIJO
						LEFT JOIN MED ON AUT.IDSOLICITANTE=MED.IDMEDICO
					WHERE FCJ.CODCAJA=@CODCAJA
					AND FCJ.CNSFACJ=@CNSFACJ
				END

			   

                SELECT  @DATO = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJDEPOSITO'

               IF EXISTS( SELECT * FROM  FCJ, FCJD 
                           WHERE FCJ.CNSFACJ = FCJD.CNSFACJ
                           AND   FCJ.CODCAJA = FCJD.CODCAJA
                           AND   FCJ.CNSFACJ = @CNSFACJ
                           AND   FCJ.CODCAJA = @CODCAJA  
                           AND   FCJD.CONCEPTO = @DATO)
               BEGIN
                  INSERT INTO QXDING( NOINGRESO, CODCAJA, CNSFACJ, FECHA, VALOR, IDTERCERO,
                                   LEGALIZADO, CODCAJALG, CNSFACJLG, DEVUELTO, CODCAJADV, 
                                   CNSFACJDV, PORLEGALIZAR,PROCEDENCIA)
                  SELECT FCJ.NOADMISION, @CODCAJA, @CNSFACJ, FCJ.FECHA, FCJD.VALORTOTAL, 
                         CASE WHEN ISNULL(FCJ.IDAFILIADO,'')='' THEN FCJ.IDTERCERO ELSE FCJ.IDAFILIADO END, 0, NULL, NULL, 0, NULL, NULL, 0,'CE'
                  FROM  FCJ, FCJD 
                  WHERE FCJ.CNSFACJ = FCJD.CNSFACJ
                  AND   FCJ.CODCAJA = FCJD.CODCAJA
                  AND   FCJ.CNSFACJ = @CNSFACJ
                  AND   FCJ.CODCAJA = @CODCAJA  
                  AND   FCJD.CONCEPTO = @DATO
               END
            END
         END     
         IF @DEAPERTURA = 1 OR @DEAPERTURA = 2
         BEGIN 
            PRINT 'ES DE APERTURA DE CAJA(1) TRASLADO RECEPCION(2) NO DEBO SUMAR RECAUDOS EN CAJA'
         END   
         ELSE  
         BEGIN       
            PRINT 'Entre a control de formas de pago'
            INSERT INTO CAJR (CODCAJA, FORMAPAGO)
            SELECT DISTINCT @CODCAJA, PCJ.TIPOPAGO
            FROM   PCJ, FPA
            WHERE  PCJ.CODCAJA  = @CODCAJA 
            AND    PCJ.CNSFACJ  = @CNSFACJ
            AND    PCJ.TIPOPAGO = FPA.FORMAPAGO
            AND    FPA.FISICO   = 1 
            AND    TIPOPAGO NOT IN (SELECT FORMAPAGO FROM CAJR WHERE CODCAJA = @CODCAJA )
            
            PRINT 'PRIMER UPDATE'
            UPDATE CAJR SET VALOR = 0 WHERE CODCAJA = @CODCAJA AND VALOR IS NULL
            
            PRINT 'INSERT ANTES...'
            INSERT INTO #TPCJ(TIPOPAGO, VALOR)
            SELECT PCJ.TIPOPAGO, SUM(VALOR) 
            FROM   PCJ, FPA 
            WHERE  PCJ.CODCAJA = @CODCAJA 
            AND    PCJ.CNSFACJ = @CNSFACJ
            AND    PCJ.TIPOPAGO = FPA.FORMAPAGO
            AND    FPA.FISICO   = 1                        
            GROUP BY PCJ.TIPOPAGO
            
            PRINT 'VOY AL CURSOR....'
            DECLARE PCJ_CURSOR CURSOR FOR  
            SELECT TIPOPAGO,VALOR FROM #TPCJ  
            OPEN PCJ_CURSOR  
            FETCH NEXT FROM PCJ_CURSOR  
            INTO @TIPOPAGO, @VALOR  
            WHILE @@FETCH_STATUS = 0  
            BEGIN  
               PRINT 'SUMO FPA='+COALESCE(@TIPOPAGO,'NO TEGNO')+'=$'+STR(COALESCE(@VALOR,0))

               UPDATE CAJR SET VALOR = VALOR + @VALOR 
               WHERE FORMAPAGO = @TIPOPAGO AND CODCAJA = @CODCAJA 
               FETCH NEXT FROM PCJ_CURSOR  
               INTO @TIPOPAGO, @VALOR  
            END  
            CLOSE PCJ_CURSOR  
            DEALLOCATE PCJ_CURSOR     
            
            PRINT 'SALGO DEL CURSOR..'
            INSERT INTO FCJTD (CODCAJA, CODCAJAORI, CNSPCJ, FORMAPAGO, VALOR, BANCO,
                            NUMERODOCUMENTO, NUMEROAUTORIZA, CNSACJ, CONSIGNADO, BANCOCSG,
                            CUENTACSG, FECHACSG, COMPANIA, ASIGNADO )
            SELECT @CODCAJA, @CODCAJA, PCJ.CNSPCJ, PCJ.TIPOPAGO, PCJ.VALOR, PCJ.BANCO,
                   PCJ.NUMERODOCUMENTO, PCJ.NUMEROAUTORIZA, PCJ.CNSACJ, 0, NULL, NULL,
                   NULL, @COMPANIA, 0
            FROM   PCJ, FPA
            WHERE  PCJ.CODCAJA  = @CODCAJA
            AND    PCJ.CNSFACJ  = @CNSFACJ 
            AND    PCJ.TIPOPAGO = FPA.FORMAPAGO
            AND    FPA.REQDOC   = 1 
            AND    FPA.FISICO   = 1
            
            --ASOSA 25.SEPT.2007
            SELECT @CONSECUTIVOCAN= FCJ.NOADMISION
            FROM   FCJ
            WHERE  CNSFACJ = @CNSFACJ
            AND    CODCAJA = @CODCAJA
            
            IF @PROCEDENCIA ='CEM'
            BEGIN
               --ACTUALIZA CITCI PARA MULTAS
               UPDATE CITCI SET CNSFACJ = @CNSFACJ,CODCAJA =@CODCAJA,CITCI.PAGADAMULTA=1
               WHERE CITCI.CONSECUTIVOCAN = @CONSECUTIVOCAN
            END 
            /*
            */
         END
		   ---- 07092015 ---JGOMEZ -SE AGREGAN VARIABLES DEL SISTEMA PARA DISMINUIR EL PAGARE SEGUN EL CONCEPTO DE CAJA 
         /* SE COMENTARIZA POR JJIMENEZ 20180626 YA QUE CON EL NUEVO PROCESO EL PROCESO DE RECUADO SE REALIZA DESDE CARTERA
         IF (SELECT CONCEPTO FROM FCJD WHERE CNSFACJ=@CNSFACJ AND CODCAJA=@CODCAJA)=@DATOPAGARE
		   BEGIN 
		      PRINT 'ENTRE ACTUALIZE'
		      -- SE DISMINUYE LA FORMADEPAGO PAGARE PARA QUE LA CAJA QUEDE AL DIA 
		      UPDATE CAJR SET VALOR= VALOR  - (SELECT SUM (ISNULL(VALORTOTAL,0))  FROM FCJD WHERE  CNSFACJ=@CNSFACJ AND CODCAJA=@CODCAJA AND CONCEPTO=@DATOPAGARE)
		      WHERE CODCAJA=@CODCAJA AND FORMAPAGO=DBO.FNK_VALORVARIABLE('IDFPAPAGARE')
		      PRINT 'SALI DE ACTUALIZAR FORMA DE PAGO'
		   END */
         IF @TIPO = 'CREDITO'
         BEGIN
            SET @CNSCXC=SPACE(20)
            EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@CXC',@CNSCXC OUTPUT
            SELECT @CNSCXC = @SEDE + REPLACE(SPACE(8 - LEN(@CNSCXC))+LTRIM(RTRIM(@CNSCXC)),SPACE(1),0)
            
            SET @F_VENCE=@FECHA+30
            SET @CUENTA=(SELECT CUENTA FROM TTEC WHERE TIPO=DBO.FNK_VALORVARIABLE('IDTERCONTABLEPART'))
              
            EXEC SPK_ADMIN_CXC_CONTAB
                 @CNSCXC,
                 @IDTERCERO,
                 @CNSFACJ,
                 @FECHA,
                 @F_VENCE,
                 @USUARIO,
                 'VENTA A CREDITO EN CAJA',
                 @COMPANIA,
                 '',
                 @VALORTOTAL,     
                 @CCOSTO,
                 @IDAREA,  
                 'INSERT',
                 0,
                 @CUENTA
         END
         /* BEGIN 001_01.MAR.2008 JEDM*/
         SELECT @VALORTOTAL1 = SUM(PCJ.VALOR)
         FROM   PCJ INNER JOIN FPA ON PCJ.TIPOPAGO = FPA.FORMAPAGO
         WHERE  PCJ.CNSFACJ = @CNSFACJ
         AND    PCJ.CODCAJA = @CODCAJA
         AND    FPA.CXC     = 1  

         IF @VALORTOTAL1 > 0 -- ACA DEBO CREAR LA FACTURA DE LO QUE GENERA DOCUMENTO
         BEGIN
            PRINT 'DEBO CREAR FACTURA'


	         DECLARE PCJ_TIPOPAGO CURSOR FOR  
            SELECT PCJ.IDTERCERO,PCJ.TIPOPAGO,PCJ.VALOR,CNSDOC,PCJ.CNSPCJ,PCJ.CUENTA
            FROM   PCJ INNER JOIN FPA ON PCJ.TIPOPAGO = FPA.FORMAPAGO
            WHERE  PCJ.CNSFACJ = @CNSFACJ
            AND    PCJ.CODCAJA = @CODCAJA
            AND    FPA.CXC     = 1                    
	         OPEN PCJ_TIPOPAGO    
	         FETCH NEXT FROM PCJ_TIPOPAGO    
	         INTO @PCJTERCERO,@PCJTIPOPAGO,@VALORTPAGO,@CNSDOCPCJ,@CNSPCJPAGO,@CUENTAPCJ
	         WHILE @@FETCH_STATUS = 0    
	         BEGIN
               IF @PCJTIPOPAGO=DBO.FNK_VALORVARIABLE('IDFPAPAGARE')
               BEGIN
                  UPDATE APAG SET CODCAJA=@CODCAJA, CNSFACJ=@CNSFACJ,ESTADO='EnCaja' WHERE IDPAGARE=@CNSDOCPCJ
               END
               EXEC SPK_CREA_FACTURA_DESDE_CAJA @CNSFACJ,@CODCAJA,@CNSPCJPAGO,@CNSDOCPCJ,@COMPANIA,@SEDE,@USUARIO,@SYS_COMPUTERNAME,@FACTURADOC OUTPUT

               SET @CNSCXC=SPACE(20)
               EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@CXC',@CNSCXC OUTPUT
               SELECT @CNSCXC = @SEDE + REPLACE(SPACE(8 - LEN(@CNSCXC))+LTRIM(RTRIM(@CNSCXC)),SPACE(1),0)
            
               SET @F_VENCE=@FECHA+30  
               SET @CUENTA=(SELECT CUENTA FROM TTEC WHERE TIPO=DBO.FNK_VALORVARIABLE('IDTERCONTABLEPART'))
            
               PRINT 'LLAMO EL SPK'
               EXEC SPK_ADMIN_CXC_CONTAB
                    @CNSCXC,
                    @PCJTERCERO,
                    @FACTURADOC,
                    @FECHA,
                    @F_VENCE,
                    @USUARIO,
                    'PAGO ASUMIDO POR UN TERCERO EN CAJA',
                    @COMPANIA,
                    '',
                    @VALORTPAGO,     
                    @CCOSTO,
                    @IDAREA,  
                    'INSERT',
                    0,
                    @CUENTA  

	         FETCH NEXT FROM PCJ_TIPOPAGO    
	         INTO  @PCJTERCERO,@PCJTIPOPAGO,@VALORTPAGO,@CNSDOCPCJ,@CNSPCJPAGO,@CUENTAPCJ
	         END
	         CLOSE PCJ_TIPOPAGO
	         DEALLOCATE PCJ_TIPOPAGO
         END
         /* END   001_01.MAR.2008 JEDM*/
         SELECT  @DATO = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJDEPOSITO'
         -- ES DEPOSITO PARA FACTURA CREA REGISTRO QXDING
         IF @TIPO = 'INTERNO' AND @PROCEDENCIA = 'CAJA' 
         BEGIN
            INSERT INTO QXDING( NOINGRESO, CODCAJA, CNSFACJ, FECHA, VALOR, IDTERCERO,
                                LEGALIZADO, CODCAJALG, CNSFACJLG, DEVUELTO, CODCAJADV, 
                                CNSFACJDV, PORLEGALIZAR )
            SELECT FCJ.NOADMISION, @CODCAJA, @CNSFACJ, FCJ.FECHA, FCJD.VALORTOTAL, 
                   CASE WHEN ISNULL(FCJ.IDAFILIADO,'')='' THEN FCJ.IDTERCERO ELSE FCJ.IDAFILIADO END, 0, NULL, NULL, 0, NULL, NULL, 0
            FROM  FCJ, FCJD 
            WHERE FCJ.CNSFACJ = FCJD.CNSFACJ
            AND   FCJ.CODCAJA = FCJD.CODCAJA
            AND   FCJ.CNSFACJ = @CNSFACJ
            AND   FCJ.CODCAJA = @CODCAJA  
            AND   FCJD.CONCEPTO = @DATO
         END 
         SELECT  @DATO = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJABONOCP'
         PRINT 'ES ABONO A COPAGO?'
         IF @TIPO = 'INTERNO' AND @PROCEDENCIA = 'CAJA' 
         BEGIN 
            INSERT INTO FCJDL(CODCAJA,    CNSFACJ,    ITEM,      N_RECIBO,   CONCEPTO,  VALORUNITARIO,
                              CANTIDAD,   VALORTOTAL, FECHA,     LEGALIZADO, CODCAJALG, CNSFACJLG,
                              NOADMISION, DEVUELTO,   CODCAJADV, CNSFACJDV,  IDTERCERO)
            SELECT FCJD.CODCAJA, FCJD.CNSFACJ, 1, NULL, FCJD.CONCEPTO, FCJD.VALORUNITARIO,
                FCJD.CANTIDAD, FCJD.VALORTOTAL, FCJ.FECHA, 0, NULL, NULL, FCJ.NOADMISION,
                0, NULL, NULL, CASE WHEN ISNULL(FCJ.IDAFILIADO,'')='' THEN FCJ.IDTERCERO ELSE FCJ.IDAFILIADO END
            FROM FCJ, FCJD 
            WHERE FCJ.CNSFACJ = FCJD.CNSFACJ
            AND   FCJ.CODCAJA = FCJD.CODCAJA
            AND   FCJ.CNSFACJ = @CNSFACJ
            AND   FCJ.CODCAJA = @CODCAJA  
            AND   FCJD.CONCEPTO = @DATO
         END

         UPDATE FCJ SET CERRADA = 1 WHERE CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA
         
         SELECT  @DATO = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJLEGDEPOSITO'     
         /*BEGIN JEDM_01.JUL.2008_001*/
         PRINT 'EMPECE'
         SELECT @G_REINT = 0
         SELECT @TOTREINTEGRO = 0 
         DECLARE PCJ_CURSOR CURSOR FOR  
         SELECT CODCAJADEP, CNSFACJDEP, VALOR, VALORREINTEGRO, CNSPCJ FROM PCJ  
         WHERE  PCJ.TIPOPAGO = @DATO
         AND    PCJ.CODCAJA  = @CODCAJA
         AND    PCJ.CNSFACJ  = @CNSFACJ
         OPEN  PCJ_CURSOR  
         FETCH NEXT FROM PCJ_CURSOR  
         INTO  @CODCAJADEP, @CNSFACJDEP, @VALOR, @VALORREINTEGRO, @CNSPCJAUX
         WHILE @@FETCH_STATUS = 0  
         BEGIN  
            PRINT 'EN EL CURSOR'
            SELECT @VALORDEPORI = VALOR, @NOINGRESODEPORI = NOINGRESO 
            FROM   QXDING 
            WHERE  CODCAJA = @CODCAJADEP AND CNSFACJ = @CNSFACJDEP
            PRINT 'VALOR ORI='+STR(@VALORDEPORI)+ '- VALOR ACT = '+STR(@VALOR)
            
            IF @VALORDEPORI > @VALOR
            BEGIN
               PRINT 'SI ENTRE' 
               UPDATE QXDING SET PORLEGALIZAR = @VALORDEPORI - @VALOR
               WHERE  NOINGRESO = @NOINGRESODEPORI
               AND    CODCAJA   = @CODCAJADEP
               AND    CNSFACJ   = @CNSFACJDEP
            END
         
            IF @VALORREINTEGRO > 0
            BEGIN
            
               IF @G_REINT = 0
               BEGIN
                  EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@TFCJ', @NVOCONSECTFCJ OUTPUT    
                  SELECT @NVOCONSECTFCJ = @SEDE + REPLACE(SPACE(8 - LEN(@NVOCONSECTFCJ))+LTRIM(RTRIM(@NVOCONSECTFCJ)),SPACE(1),0)
				  PRINT 'ENTRE AQUI TFCJ XD'   
                  INSERT INTO TFCJ(CNSFACJ, N_RECIBO, CLASE_FAC, NOADMISION, NOPRESTACION,
                                   IDPLAN, VALORTOTAL, COMPANIA, IDAFILIADO, CERRADA, FECHA, PROCEDENCIA,
                                   N_FACTURA, IDTERCERO, NOMBRECLIENTE,
                                   CNSACJ, TIPO, ESTADO, IMPRESO, MARCACONT, CONTABILIZADA, 
                                   NROCOMPROBANTE, AREAPRESTACION, CCOSTO,
                                   SUBCCOSTO, CLASER, IDENTIFICADOR, USUARIO, SYS_COMPUTERNAME)
                  SELECT @NVOCONSECTFCJ, NULL,  'PAGO', @NOINGRESODEPORI, NULL, IDPLAN, 0, @COMPANIA,
                         @IDAFILIADO, 0, GETDATE(), 'SALUD', 'REINTEGRO', IDTERCERO, NOMBRECLIENTE,  
                         NULL, 'INTERNO', 0, 0, 0, 0, NULL, NULL, NULL, NULL, 'C', 'REINTEGRO',
                         @USUARIO, @SYS_COMPUTERNAME
                  FROM   FCJ 
                  WHERE  CODCAJA = @CODCAJA
                  AND    CNSFACJ = @CNSFACJ 
               END
               SELECT @G_REINT = @G_REINT + 1
               INSERT INTO TFCJD(N_RECIBO, CNSFACJ, ITEM, CONCEPTO, AREAFUNCIONAL, VALORUNITARIO, CANTIDAD, VALORTOTAL, IDSERVICIO,
                            TDESCUENTO, DCTO, VLRDESCUENTO)
               SELECT NULL, @NVOCONSECTFCJ, @G_REINT, DBO.FNK_VALORVARIABLE('IDCJTEDEVOLDEPOSITO'), @IDAREA, @VALORREINTEGRO, 1, @VALORREINTEGRO, '',
                      0, 0, 0
               FROM   PCJ
               WHERE  CNSPCJ = @CNSPCJAUX    
               SELECT @TOTREINTEGRO = @TOTREINTEGRO + @VALORREINTEGRO
            END
            IF @G_REINT > 0
            BEGIN
               UPDATE TFCJ SET  VALORTOTAL = @TOTREINTEGRO WHERE CNSFACJ = @NVOCONSECTFCJ
            END
            FETCH NEXT FROM PCJ_CURSOR  
            INTO @CODCAJADEP, @CNSFACJDEP, @VALOR, @VALORREINTEGRO, @CNSPCJAUX
         END  
         CLOSE PCJ_CURSOR  
         DEALLOCATE PCJ_CURSOR         
              
         /*BEGIN JEDM_01.JUL.2008_001*/
         UPDATE QXDING SET LEGALIZADO = 1, CODCAJALG = @CODCAJA, CNSFACJLG  = @CNSFACJ
         FROM   PCJ
         WHERE  QXDING.CODCAJA = PCJ.CODCAJADEP
         AND    QXDING.CNSFACJ = PCJ.CNSFACJDEP
         AND    PCJ.TIPOPAGO = @DATO
         AND    PCJ.CODCAJA  = @CODCAJA
         AND    PCJ.CNSFACJ  = @CNSFACJ
         
         UPDATE FCJDL SET LEGALIZADO = 1, CODCAJALG = @CODCAJA, CNSFACJLG  = @CNSFACJ
         FROM PCJ
         WHERE  FCJDL.CODCAJA = PCJ.CODCAJADEP
         AND    FCJDL.CNSFACJ = PCJ.CNSFACJDEP
         AND    PCJ.TIPOPAGO = @DATO
         AND    PCJ.CODCAJA  = @CODCAJA
         AND    PCJ.CNSFACJ  = @CNSFACJ

         PRINT 'ANTES NUEVO PROCESO CITAS'
         
         IF @DATOCEHOSP = 'CEHOSP'
         BEGIN
            PRINT '@PROCEDENCIA='+@PROCEDENCIA
            IF @PROCEDENCIA = 'CE'  OR @PROCEDENCIA = 'CITAS'  --JEDM  11.ABR.2005
            BEGIN            
               PRINT 'INGRESE POR CE O CI'
               IF @PROCEDENCIA = 'CE'  
               BEGIN                  
                  UPDATE AUTD SET MARCAPAGO = 1
                  WHERE  AUTD.IDAUT     = @DOC2
                  AND    ISNULL(AUTD.MARCAPAGO,0) = 0
                  AND    (AUTD.IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART')  OR 
                          AUTD.IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART2') OR 
                          AUTD.IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART3') OR 
                          AUTD.IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART4') OR 
                          AUTD.IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART5') )
                  -- SE GENERA UN NUEVO TFCJ PARA LOS PENDIENTES
                  UPDATE AUTD SET AUTORIZADO = 1 
                  WHERE  AUTD.MARCAPAGO = 1 
                  AND    AUTD.IDAUT = @DOC2
				  -- ARREGLO DE TFCJ QUE SE GENERAN NUEVAMENTE CON VALOR EN CERO Y QUE TIENE COPAGOPROPIO				  
				  SELECT @OK = COUNT(*) FROM AUTD  INNER JOIN AUT ON AUT.IDAUT=AUTD.IDAUT
                  WHERE  AUTD.MARCAPAGO = 0  AND  AUT.COPAGOPROPIO=0
                  AND    AUTD.IDAUT     = @DOC2
				    
                  IF @OK > 0
                  BEGIN
                     EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@TFCJ', @NVOCONSEC OUTPUT    
                     SELECT @NVOCONSEC = @SEDE + REPLACE(SPACE(8 - LEN(@NVOCONSEC))+LTRIM(RTRIM(@NVOCONSEC)),SPACE(1),0)   
                     PRINT 'ENTRE AQUI TFCJ XD SEGUNDO'  
                     INSERT INTO TFCJ(CNSFACJ, N_RECIBO, CLASE_FAC, NOADMISION, NOPRESTACION,  
                                 IDPLAN, VALORTOTAL, COMPANIA, IDAFILIADO, CERRADA, FECHA, 
                                 PROCEDENCIA, N_FACTURA, IDTERCERO, NOMBRECLIENTE,  
                                 CNSACJ, TIPO, ESTADO, IMPRESO, MARCACONT, CONTABILIZADA, NROCOMPROBANTE, AREAPRESTACION, CCOSTO,  
                                 SUBCCOSTO, CLASER, IDENTIFICADOR, USUARIO, SYS_COMPUTERNAME)  
                     SELECT @NVOCONSEC, NULL,  'COBRO', AUT.NOAUT, AUT.IDAUT, AUT.IDPLAN, 0, @COMPANIA,  
                            AUT.IDAFILIADO, 0, GETDATE(), 'CE', 'AUT', AUT.IDCONTRATANTE, 
                            LEFT(LTRIM(RTRIM(AFI.PAPELLIDO))+' '+LTRIM(RTRIM(AFI.SAPELLIDO))  
                            +' ' +LTRIM(RTRIM(AFI.PNOMBRE))+' '+ LTRIM(RTRIM(AFI.SNOMBRE)),40),    
                            @CNSACJ, 'INTERNO', 0, 0, 0, 0, NULL, AUT.IDAREA, AUT.CCOSTO, AUT.SUBCCOSTO, 'C', AUT.PREFIJO,  
                            @USUARIO, @SYS_COMPUTERNAME    
                     FROM   AUT, AFI  
                     WHERE  AUT.IDAUT = @DOC2
                     AND    AUT.IDAFILIADO = AFI.IDAFILIADO  
                  
                     SET @ITEM = 1
                     DECLARE OM_CURSOR CURSOR FOR           
                     SELECT AUTD.CODIGOCPCJ, SUM(AUTD.VALORCOPAGO)
                     FROM   AUT, AUTD 
                     WHERE  AUTD.IDAUT = AUT.IDAUT
                     AND    AUT.NOAUT  = @DOC1  
                     AND    AUTD.VALORCOPAGO > 0
                     AND    AUTD.AUTORIZADO = 0
                     GROUP BY AUTD.CODIGOCPCJ
                     OPEN OM_CURSOR  
                     FETCH NEXT FROM OM_CURSOR  
                     INTO  @CODIGOCPCJ, @VALOR
                     WHILE @@FETCH_STATUS = 0             
                     BEGIN         
                        PRINT 'ENTRE'
                        INSERT INTO TFCJD(N_RECIBO, CNSFACJ, ITEM, CONCEPTO, AREAFUNCIONAL, VALORUNITARIO, CANTIDAD, VALORTOTAL, IDSERVICIO,  
                                         TDESCUENTO, TIPODCTO, DCTO, VLRDESCUENTO)  
                        SELECT NULL, @NVOCONSEC, @ITEM, @CODIGOCPCJ, @IDAREA, @VALOR, 1, @VALOR, NULL, 0, 'N', 0, 0  
                     
                        SELECT @ITEM = @ITEM + 1
                        FETCH NEXT FROM OM_CURSOR  
                        INTO  @CODIGOCPCJ, @VALOR
                     END
                     CLOSE OM_CURSOR  
                     DEALLOCATE OM_CURSOR  
                     SELECT @VALOR = SUM(VALORTOTAL) FROM TFCJD WHERE CNSFACJ = @NVOCONSEC
                     UPDATE TFCJ SET VALORTOTAL = @VALOR WHERE CNSFACJ = @NVOCONSEC
                  END
               END
               /*JEDM: REVISAMOS SI ES CE Y PARTICULAR PARA VER SI YA ESTA FACTURADA*/
               PRINT 'REVISAMOS SI ES CE Y PARTICULAR PARA VER SI YA ESTA FACTURADA'
               DECLARE @AUTFACTURADA  INT
               DECLARE @N_FACTURA_AUT VARCHAR(16)
               DECLARE @CNSCXC_AUT    VARCHAR(20)
               DECLARE @OK_AUT        INT 
               
               DECLARE @ITEM_FCXCDV   INT
               DECLARE @CNSFPAG       VARCHAR(20)
               IF @IDPLANFCJ = DBO.FNK_VALORVARIABLE('IDPLANPART')  OR 
                  @IDPLANFCJ = DBO.FNK_VALORVARIABLE('IDPLANPART2') OR
                  @IDPLANFCJ = DBO.FNK_VALORVARIABLE('IDPLANPART3') OR 
                  @IDPLANFCJ = DBO.FNK_VALORVARIABLE('IDPLANPART4') OR 
                  @IDPLANFCJ = DBO.FNK_VALORVARIABLE('IDPLANPART5') 
               BEGIN
                  PRINT 'PART'
                  IF @PROCEDENCIA = 'CE'  
                  BEGIN
                     SELECT @AUTFACTURADA = COALESCE(AUTD.FACTURADA,0), @N_FACTURA_AUT = AUTD.N_FACTURA,
                            @CCOSTO       = AUT.CCOSTO, @IDAREA = AUT.IDAREA 
                     FROM   AUTD INNER JOIN AUT ON AUTD.IDAUT=AUT.IDAUT
                     WHERE AUT.IDAUT = @DOC2
                     AND  AUTD.IDPLAN=@IDPLANFCJ
                  END
                  IF @PROCEDENCIA = 'CITAS'
                  BEGIN  
                     IF DBO.FNK_VALORVARIABLE('IXCOUNTRY')='PERU'
                     BEGIN
                        PRINT 'ESTOY EN PERU,'
                        SELECT @N_FACTURA_AUT=N_FACTURA  FROM FCJ WHERE CODCAJA=@CODCAJA AND CNSFACJ=@CNSFACJ
                        IF COALESCE(@N_FACTURA_AUT,'')<>''
                        BEGIN
                           SELECT @AUTFACTURADA=1, @CCOSTO = CCOSTO, @IDAREA = AREAPRESTACION 
                           FROM   FTRD WHERE N_FACTURA = @N_FACTURA_AUT
                        END
                        ELSE
                        BEGIN
                           SELECT @AUTFACTURADA=0
                        END
                     END
                     ELSE
                     BEGIN
                        SELECT @AUTFACTURADA = COALESCE(CIT.FACTURADA,0), @N_FACTURA_AUT = N_FACTURA,
                               @CCOSTO       = CCOSTO, @IDAREA = IDAREA 
                        FROM   CIT WHERE CONSECUTIVO = @DOC1
                     END
                  END
                  PRINT '@N_FACTURA_AUT='+@N_FACTURA_AUT+'@AUTFACTURADA ='+STR(@AUTFACTURADA)
                  IF @AUTFACTURADA = 1
                  BEGIN
                     PRINT 'FACTURADA'
                     SELECT @VALORTOTAL = VR_TOTAL FROM FTR WHERE N_FACTURA = @N_FACTURA_AUT
                     
                     SELECT @OK_AUT = COALESCE(COUNT(*),0) FROM FCXCD WHERE N_FACTURA = @N_FACTURA_AUT
                   --  SET @FECHA=DBO.FNK_FECHA_SIN_MLS(GETDATE())
                     SET @CUENTA=(SELECT CUENTA FROM TTEC WHERE TIPO=DBO.FNK_VALORVARIABLE('IDTERCONTABLEPART'))
                     
                     IF @OK_AUT = 0
                     BEGIN
                        PRINT '/*NO TIENE CXC GENERADA Y LA GENERO AUTOMATICAMENTE*/'
                        SET @CNSCXC_AUT=SPACE(20)
                        EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@CXC',@CNSCXC_AUT OUTPUT
                        SELECT @CNSCXC_AUT = @SEDE + REPLACE(SPACE(8 - LEN(@CNSCXC_AUT))+LTRIM(RTRIM(@CNSCXC_AUT)),SPACE(1),0)
                        
                        EXEC SPK_ADMIN_CXC_CONTAB
                             @CNSCXC_AUT,
                             @IDTERCERO,
                             @N_FACTURA_AUT,
                             @FECHA,
                             @FECHA,
                             @USUARIO,
                             'CXC GENERADA EN CAJA',
                             @COMPANIA,
                             '',
                             @VALORTOTAL,     
                             @CCOSTO,
                             @IDAREA,  
                             'INSERT',
                             0,
                             @CUENTA    
                                                                 
                         SELECT @ITEM_FCXCDV = ITEM FROM FCXCDV WHERE N_FACTURA = @N_FACTURA_AUT AND TIPO = 'F'
                     END
                     ELSE
                     BEGIN
                        SELECT @CNSCXC_AUT  = CNSCXC FROM FCXCD WHERE N_FACTURA = @N_FACTURA_AUT
                        SELECT @ITEM_FCXCDV = ITEM FROM FCXCDV WHERE N_FACTURA = @N_FACTURA_AUT AND TIPO = 'F'
                     END
                     /*YA TIENE CXC GENERADA Y SE CRUZA AUTOMATICAMENTE EN PAGOS
                       YA SEA POR QUE SE HABIA FACTURADO O PQ ACABAMOS DE HACERLO AQUI*/
                     SET @CNSFPAG=SPACE(20)
                     /*SE ESTABAN GENERANDO LOS CONSECUTIVOS DE LAS CUENTAS POR COBRAR Y NO AUMENTABA EL DE PAGOS @FPAG*/
                     --EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@CXC',@CNSFPAG OUTPUT
                     EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@FPAG',@CNSFPAG OUTPUT
                     SELECT @CNSFPAG = @SEDE + REPLACE(SPACE(8 - LEN(@CNSFPAG))+LTRIM(RTRIM(@CNSFPAG)),SPACE(1),0)
                     
                     SELECT @VALORPAGO=VALORTOTAL  FROM FCJ WHERE CODCAJA=@CODCAJA AND CNSFACJ=@CNSFACJ
                       
                     EXEC SPK_ADMIN_PAGOS 
                          'CXC', 
                          @N_FACTURA_AUT, 
                          @CNSCXC_AUT,
                          @CNSFPAG,
                          'INSERT',
                          @VALORPAGO,
                          @IDTERCERO,
                          @USUARIO,     
                          @SYS_COMPUTERNAME,
                          @COMPANIA,
                          @SEDE,
                          'PAGO REALIZADO EN CAJA',
                          'CAJA',
                          'P',
                          NULL, 
                          @FECHA,
                          @CODCAJA,
                          @CNSFACJ,
                          @CUENTA,
                          'F',
                          NULL
                     INSERT INTO FCJPCXC (CNSFACJ, CODCAJA, CNSCXC, N_FACTURA, ITEM_FCXCDV, IDTERCERO, VALOR, 
                                          VLR_IMPUESTOS, ESTADO, CNSFPAG, TIPOCXC)
                     SELECT @CNSFACJ, @CODCAJA, @CNSCXC_AUT, @N_FACTURA_AUT, @ITEM_FCXCDV, @IDTERCERO,CASE WHEN  @VALORTOTAL<>@VALORTOTAL2 THEN @VALORTOTAL2 ELSE @VALORTOTAL END,
                            0, 'P', @CNSFPAG, 0
                     SELECT @ESPART=1
                  END
               END   
            END
            ELSE   -- HACER CXC DE PARTICULARES ASISTENCIAL 
            BEGIN
               IF @PROCEDENCIA = 'SALUD'
               BEGIN
                  PRINT 'REVISAMOS SI ES ASISTENCIAL Y PARTICULAR PARA VER SI YA ESTA FACTURADA'
                  DECLARE @IDPLANHADM     VARCHAR(6), @HADMFACTURADA INT, @OK_HADM INT, @N_FACTURA_HADM VARCHAR(16), @CNSCXC_HADM VARCHAR(16)
                  IF DBO.FNK_VALORVARIABLE('IXCOUNTRY')='PERU'
                  BEGIN
                     PRINT 'ESTOY EN PERU,'
                     SELECT @N_FACTURA_AUT=N_FACTURA  FROM FCJ WHERE CODCAJA=@CODCAJA AND CNSFACJ=@CNSFACJ
                     IF COALESCE(@N_FACTURA_AUT,'')<>''
                     BEGIN
                        SELECT @IDPLANHADM=FTR.N_FACTURA,@HADMFACTURADA=1,@N_FACTURA_HADM=FTR.N_FACTURA FROM FTR WHERE N_FACTURA=@N_FACTURA_AUT
                     END
                  END
                  ELSE
                  BEGIN
                     SELECT @IDPLANHADM = IDPLAN FROM HADMF WHERE NOADMISION = @DOC1 AND IDTERCERO=@IDTERCERO
                  END                
                  PRINT 'ESTE ES EL PLAN:  '+@IDPLANHADM
                  IF @IDPLANHADM = DBO.FNK_VALORVARIABLE('IDPLANPART')  OR
                     @IDPLANHADM = DBO.FNK_VALORVARIABLE('IDPLANPART2') OR
                     @IDPLANHADM = DBO.FNK_VALORVARIABLE('IDPLANPART3') OR
                     @IDPLANHADM = DBO.FNK_VALORVARIABLE('IDPLANPART4') OR
                     @IDPLANHADM = DBO.FNK_VALORVARIABLE('IDPLANPART5') 
                  BEGIN
                     PRINT 'INGRESE'
                     IF DBO.FNK_VALORVARIABLE('IXCOUNTRY')='PERU'
                     BEGIN
                        SELECT @HADMFACTURADA = COUNT(*) FROM FTR WHERE N_FACTURA=@N_FACTURA_HADM
                     END
                     ELSE
                     BEGIN
                        SELECT @HADMFACTURADA = COUNT(*) FROM FTR WHERE NOREFERENCIA = @DOC1 AND ESTADO <> 'A' AND COALESCE(TIPOANULACION,'') <> 'NC'
                        SELECT @N_FACTURA_HADM = N_FACTURA FROM FTR WHERE NOREFERENCIA = @DOC1 AND ESTADO <> 'A' AND COALESCE(TIPOANULACION,'') <> 'NC'
                     END
                     IF @HADMFACTURADA > 0
                     BEGIN                     
                        PRINT 'FACTURADA'
                        SELECT @VALORTOTAL = VR_TOTAL FROM FTR WHERE N_FACTURA = @N_FACTURA_HADM
                        
                        SELECT @OK_HADM = COALESCE(COUNT(*),0) FROM FCXCD WHERE N_FACTURA = @N_FACTURA_HADM
                        --SET @FECHA=DBO.FNK_FECHA_SIN_MLS(GETDATE())
                        SET @CUENTA=(SELECT CUENTA FROM TTEC WHERE TIPO=DBO.FNK_VALORVARIABLE('IDTERCONTABLEPART'))
                        
                        IF @OK_HADM = 0
                        BEGIN                       
                           /*NO TIENE CXC GENERADA Y LA GENERO AUTOMATICAMENTE*/
                           SET @CNSCXC_HADM=SPACE(20)
                           EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@CXC',@CNSCXC_HADM OUTPUT
                           SELECT @CNSCXC_HADM = @SEDE + REPLACE(SPACE(8 - LEN(@CNSCXC_HADM))+LTRIM(RTRIM(@CNSCXC_HADM)),SPACE(1),0)
                           
                           EXEC SPK_ADMIN_CXC_CONTAB
                             @CNSCXC_HADM,
                             @IDTERCERO,
                             @N_FACTURA_HADM,
                             @FECHA,
                             @FECHA,
                             @USUARIO,
                             'CXC GENERADA EN CAJA',
                             @COMPANIA,
                             '',
                             @VALORTOTAL,     
                             @CCOSTO,
                             @IDAREA,  
                             'INSERT',
                             0,
                             @CUENTA                                        
                           SELECT @ITEM_FCXCDV = ITEM FROM FCXCDV WHERE N_FACTURA = @N_FACTURA_HADM AND TIPO = 'F'
                        END
                        ELSE
                        BEGIN
                           SELECT @CNSCXC_HADM  = CNSCXC FROM FCXCD WHERE N_FACTURA = @N_FACTURA_HADM
                           SELECT @ITEM_FCXCDV = ITEM FROM FCXCDV WHERE N_FACTURA = @N_FACTURA_HADM AND TIPO = 'F'
                        END                   
                        /*YA TIENE CXC GENERADA Y SE CRUZA AUTOMATICAMENTE EN PAGOS
                        YA SEA POR QUE SE HABIA FACTURADO O PQ ACABAMOS DE HACERLO AQUI*/
                        SET @CNSFPAG=SPACE(20)
                    /*SE ESTABAN GENERANDO LOS CONSECUTIVOS DE LAS CUENTAS POR COBRAR Y NO AHUMENTABA EL DE PAGOS @FPAG*/
                      --EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@CXC',@CNSFPAG OUTPUT
                        EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@FPAG',@CNSFPAG OUTPUT
                        SELECT @CNSFPAG = @SEDE + REPLACE(SPACE(8 - LEN(@CNSFPAG))+LTRIM(RTRIM(@CNSFPAG)),SPACE(1),0)
                           
                        EXEC SPK_ADMIN_PAGOS 
                              'CXC', 
                              @N_FACTURA_HADM, 
                              @CNSCXC_HADM,
                              @CNSFPAG,
                              'INSERT',
                              @VALORTOTAL,
                              @IDTERCERO,
                              @USUARIO,     
                              @SYS_COMPUTERNAME,
                              @COMPANIA,
                              @SEDE,
                              'PAGO REALIZADO EN CAJA',
                              'CAJA',
                              'P',
                              NULL, 
                              @FECHA,
                              @CODCAJA,
                              @CNSFACJ,
                              @CUENTA,
                              'F',
                              NULL
                        INSERT INTO FCJPCXC (CNSFACJ, CODCAJA, CNSCXC, N_FACTURA, ITEM_FCXCDV, IDTERCERO, VALOR, 
                                             VLR_IMPUESTOS, ESTADO, CNSFPAG, TIPOCXC)
                        SELECT @CNSFACJ, @CODCAJA, @CNSCXC_HADM, @N_FACTURA_HADM, @ITEM_FCXCDV, @IDTERCERO, CASE WHEN  @VALORTOTAL<>@VALORTOTAL2 THEN @VALORTOTAL2 ELSE @VALORTOTAL END,
                                0, 'P', @CNSFPAG, 0
                        SELECT @ESPART=1
                        SELECT @N_FACTURA_AUT=@N_FACTURA_HADM
                     END
                       
                  END
               END
            END
         END
      END  
      ELSE 
      BEGIN
         UPDATE FCJ SET CERRADA = 1, VALORTOTAL= 0 WHERE CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA
         DELETE FROM FCJD WHERE CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA    
         DELETE FROM PCJ WHERE CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA                
      END  
      
      IF @ESPART=1 AND COALESCE(@N_FACTURA_AUT,'')<>'' AND (SELECT COALESCE(N_FACTURA,'') FROM FCJ WHERE CODCAJA=@CODCAJA AND CNSFACJ=@CNSFACJ)<>@N_FACTURA_AUT
      BEGIN
         UPDATE FCJ SET N_FACTURA=@N_FACTURA_AUT WHERE CODCAJA=@CODCAJA AND CNSFACJ=@CNSFACJ
      END

      PRINT 'REVISO SI ES COPAGO ENVIO A PRESUPUESTO'
      PRINT 'VOY A PRESUPUESTO'
		IF DBO.FNK_VALORVARIABLE('PRESUP_CXC_ACTIVADO')='SI'
		BEGIN
         IF DBO.FNK_VALORVARIABLE('PPTO_CUOTASCOPAGO')='SI' AND @ESPART=0 AND EXISTS(SELECT * FROM PLN WHERE IDPLAN=@IDPLANFCJ AND COALESCE(NORECOCOPA,0)=0)
         BEGIN
            EXEC SPK_ENVIA_PTTO_RECUADO_COPAGO @COMPANIA,@SEDE,@CNSFACJ,@CODCAJA
         END
      END  
      IF EXISTS(SELECT  * FROM    PCJ LEFT JOIN FPA ON PCJ.TIPOPAGO = FPA.FORMAPAGO
            WHERE PCJ.CODCAJA=@CODCAJA
            AND PCJ.CNSFACJ=@CNSFACJ
            AND ( COALESCE(FPA.REQBCO,0)=1 
            AND COALESCE(FPA.DATAFONO,0)=1) )
      BEGIN
         PRINT 'PAGO CON DATAFONO '

         DECLARE PCJ_CURSOR CURSOR FOR  
         SELECT  PCJ.TIPOPAGO, PCJ.VALOR, PCJ.BANCO, PCJ.SUCURSAL, PCJ.CTA_BCO, 
                  PCJ.CNSDOC, PCJ.NUMERODOCUMENTO, COALESCE(FPA.REQBCO,0) 
         FROM    PCJ LEFT JOIN FPA ON PCJ.TIPOPAGO = FPA.FORMAPAGO
         WHERE PCJ.CODCAJA=@CODCAJA
         AND PCJ.CNSFACJ=@CNSFACJ
         AND (COALESCE(FPA.REQBCO,0)=1  
         AND COALESCE(FPA.DATAFONO,0)=1)
         OPEN    PCJ_CURSOR  
         FETCH NEXT FROM PCJ_CURSOR  
         INTO    @TIPOPAGO, @VALOR, @BANCO, @SUCURSAL, @CTA_BCO, @CNSDOC, @NUMERODOCUMENTO, @RECBCO
         WHILE @@FETCH_STATUS = 0  
         BEGIN  
            IF @TIPOPAGO = @DATOEFE
            BEGIN
               BEGIN TRAN
               UPDATE CAJR SET VALOR = VALOR - @VALOR 
               WHERE FORMAPAGO = @TIPOPAGO AND CODCAJA = @CODCAJA          
               COMMIT
            END
            ELSE
            BEGIN
               SELECT @IDOPERACION = DATO FROM USVGS WHERE IDVARIABLE = 'IDBCOPAGOCHEQUE'
               IF @TIPOPAGO=@IDOPERACION
               BEGIN
                  UPDATE BCTDD SET IDTERCERO = @IDTERCERO, N_RECIBO = @N_RECIBO,
                                    UTILIZADO = 1, ESTADO = 'I', USUARIO = @USUARIO,
                                    FECHA = GETDATE(), VALOR = @VALOR,
                                    CNSFACJ=@CNSFACJ, CODCAJA=@CODCAJA 
                  WHERE  BANCO  = @BANCO  AND SUCURSAL    = @SUCURSAL AND CTA_BCO = @CTA_BCO 
                  AND    CNSDOC = @CNSDOC AND NODOCUMENTO = dbo.FNK_LIMPIATEXTO(@NUMERODOCUMENTO, '0-9')
               END
               /* AQUI SE CREA LA OPERACION FINANCIERA EN BANCOS*/
               IF @RECBCO = 1
               BEGIN
                  DECLARE @OBS VARCHAR(1024)
                  SELECT @OBS=OBSERVACION  FROM FCJ WHERE CODCAJA=@CODCAJA AND CNSFACJ=@CNSFACJ
                  
                  SELECT @ITEMBMOV = COALESCE(MAX(ITEM),0)+1 FROM BMOV 
                  WHERE  CTA_BCO = @CTA_BCO AND SUCURSAL=@SUCURSAL 
                  AND    BANCO   = @BANCO 
                  IF  @ITEMBMOV IS NULL
                  SELECT @ITEMBMOV = 1
                  INSERT INTO BMOV(BANCO, SUCURSAL, CTA_BCO, ITEM, FECHAOPERACION,
                                    NODOCUMENTO, NOTRANSFOPER, IDOPERACION, VLROPERACION,
                                    DESCRIPCION, USUARIO, SYS_ComputerName, SALDOANTES,
                                    SALDODESP, TIPOCOBROFIN, PROCEDENCIA, ESTADO, CONTABILIZADA, NROCOMPROBANTE,
                                    CODCAJA, CNSFACJ) 
                  SELECT @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV, @FECHA,
                        @CNSFACJ, NULL, DBO.FNK_VALORVARIABLE('IDOFINCAJADB'), 0, @OBS,
                        @USUARIO, @SYS_COMPUTERNAME, 0, 0, NULL, 'CAJA', 'C', 1, @NROCOMPROBANTE,
                        @CODCAJA, @CNSFACJ
                    
                  INSERT INTO BMOVD(BANCO, SUCURSAL, CTA_BCO, ITEM, RENGLON, FORMAPAGO,
                                    BANCODOC, NODOCUMENTO, VLRITEM, PROCEDENCIA, CODCAJA,
                                    CNSFACJ, IDTERCERO) 
                  SELECT @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV, 1, 
                        @TIPOPAGO, @BANCO, @NODOCUMENTO,  @VALOR, 'CAJA', @CODCAJA, @CNSFACJ, @IDTERCERO
                    
                  EXEC SPK_TOT_BMOV @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV 
                  --EXEC SPK_OK_BMOV @CSGBANCO, @CSGSUCURSAL, @CSGCTA_BCO, @ITEMBMOV,@USUARIO,@SYS_COMPUTERNAME,@COMPANIA,@SEDE,@NROCOMPROBANTE
                  EXEC SPK_OK_BMOV @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV,@USUARIO,@SYS_COMPUTERNAME,@COMPANIA,@SEDE,@NROCOMPROBANTE
               END                
                  
            END
            FETCH NEXT FROM PCJ_CURSOR  
            INTO @TIPOPAGO, @VALOR, @BANCO, @SUCURSAL, @CTA_BCO, @CNSDOC, @NUMERODOCUMENTO, @RECBCO
         END            
         CLOSE PCJ_CURSOR  
         DEALLOCATE PCJ_CURSOR 
      END
      PRINT 'GENERACION DE FACTURA POST - ELECTRONICA'
      IF DBO.FNK_VALORVARIABLE('FACTURAPOS_ACTIVA')='SI' AND COALESCE(@ESPART,0)=0
      BEGIN
         PRINT 'VOY A GENERAR LA FACTURA'
         EXEC SPK_CREA_FACTURA_POS_CAJA @CNSFACJ,@CODCAJA,@COMPANIA,@SEDE,@USUARIO,@SYS_COMPUTERNAME
      END
   END
   ELSE
      BEGIN
      PRINT 'ES TIPO PAGO'
      IF @ESTADO <> 'A' -- OR @ESTADO IS NULL ARREGLAR?
      BEGIN
         
         SELECT @CLASER = CLASER, @TIPO = TIPO, @PROCEDENCIA = PROCEDENCIA, @DOCORIGEN = DOCORIGEN
         FROM FCJ WHERE CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA
         SELECT @DATO1     = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJPART' 
         SELECT @DATO2     = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJTECXP'           
         SELECT @DATO3     = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJTEDEVOLDEPOSITO'           
         SELECT @DATO4     = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJTECONSIGNACION'           
         SELECT @DATO5     = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJTEDEVSALDOS'
         SELECT @DATO6     = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJTETRASLADO'
		 SELECT @DATO7     = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJTETRASLADOPPAL'
         SELECT @DATON     = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJTENOMINA'
         SELECT @DEVDOC    = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJTEDEVOLDOCUMENTO'
         SELECT @DEVREC    = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJTEDEVOLRECIBO'
         SELECT @TRASACAJA = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJTETRASBCOCAJA'
         
         IF @TIPOEGRESO = @DATO2 -- CXP
         BEGIN  
            -- ACTUALIZA SALDO DE LA CXP
           /*SE QUITA EL UPDATE Y SE CORRE EL SPK_CALCULOVALORESCXP PARA RECALCULAR VALORES CXP 
            UPDATE FCXP SET ESTADO=(CASE WHEN FCXP.SALDO - FCXPP.ABONO <= 0 THEN 'P' ELSE 'C' END)
                            --FCXP.SALDO = FCXP.SALDO - FCXPP.ABONO,    -- JEDM 04.12.2009    */ 
	   --IF DBO.FNK_VALORVARIABLE('PRESUP_CXP_ACTIVADO')='SI'
	   --BEGIN
		  -- PRINT 'INGRESANDO LOS PAGOS A PTPAG'
		  -- IF DBO.FNK_VALORVARIABLE('PPTO_CONSICXP')='NO'
		  -- BEGIN
			 --  PRINT 'VERIFICAMOS QUE SI ES DE SALDO INICIAL'
			 --  SELECT @SI=CASE WHEN CNSFCXP LIKE '%'+DBO.FNK_VALORVARIABLE('PPTO_CONSICXP')+'%' THEN 1 ELSE 0 END FROM FCXP WHERE CNSFCXP=@CNSCXP
		  -- END
		  -- ELSE
		  -- BEGIN
			 --  SELECT @SI=0
		  -- END
		  -- IF COALESCE(@SI,0)=0
		  -- BEGIN
    --        IF (SELECT CASE WHEN  @CNSCXP NOT LIKE '%AN%' THEN 1 ELSE 0 END)=0
    --        BEGIN
    --           PRINT 'ME VOY A PRESUPUESTO'
    --           EXEC SPK_ENVIA_PPTO_EGRESOCAJA @CODCAJA,@CNSFACJ,@COMPANIA,@SEDE,@USUARIO,@SYS_COMPUTERNAME
    --        END
    --     END
    --  END

			PRINT '@TIPOEGRESO JOSE='+@DATO2

			PRINT 'PAGO DE CXP.....'

            -- COLOCA EN ESTADO PAGADO LA AUTORIZACION DE PAGO
            UPDATE FCXPP SET ESTADO = 'P'
            FROM   FCJD 
            WHERE  FCXPP.CNSFCXPP = FCJD.IDSERVICIO
            AND    FCJD.CODCAJA   = @CODCAJA   
            AND    FCJD.CNSFACJ   = @CNSFACJ
--query2         
            -- REVISO SI HAY ALGUNO DE CAJA MENOR
            IF (  SELECT COUNT(*)
                  FROM   FCJD INNER JOIN FCXPP ON FCXPP.CNSFCXPP = FCJD.IDSERVICIO
                              INNER JOIN FCXP ON FCXPP.CNSFCXP=FCXP.CNSFCXP
                  WHERE  FCJD.CODCAJA   = @CODCAJA   
                  AND    FCJD.CNSFACJ   = @CNSFACJ    
                  AND FCXP.PROCEDENCIA='CAJAMENOR')>0 AND DBO.FNK_VALORVARIABLE('ING_REEMBOL_CJAMENOR')='SI'
            BEGIN--CAJ
               PRINT ' INICIO EL PROCESO DE REEMBOLSO AUTOMATICO'
	            DECLARE PAG_CAJMENOR_CURSOR CURSOR FOR 
               SELECT DISTINCT  FCXP.CNSFCXP,FCXP.IDTERCERO,FCXPP.ABONO,FCXPP.CNSFCXPP, FCXP.CAJAMENOR
               FROM   FCJD INNER JOIN FCXPP ON FCXPP.CNSFCXPP = FCJD.IDSERVICIO
                           INNER JOIN FCXP ON FCXPP.CNSFCXP=FCXP.CNSFCXP
               WHERE  FCJD.CODCAJA   = @CODCAJA   
               AND    FCJD.CNSFACJ   = @CNSFACJ    
               AND FCXP.PROCEDENCIA='CAJAMENOR'                    
	            OPEN PAG_CAJMENOR_CURSOR    
	            FETCH NEXT FROM PAG_CAJMENOR_CURSOR    
	            INTO @CNSFCXPCJM,@RESPONCJM,@VLRPAGOCJM,@CNSFCXPPM, @CAJAMENOR
	            WHILE @@FETCH_STATUS = 0    
	            BEGIN 
                  PRINT 'Busco caja menor'
                  --SELECT @CAJAMENOR=CODCAJA FROM CAJ WHERE RESPONSABLE=@RESPONCJM AND CLASE='Menor'

                  SELECT @ABIERTA = COALESCE(ABIERTA,0) FROM CAJ
                  WHERE  CODCAJA=@CAJAMENOR
                  IF @ABIERTA=0
                  BEGIN
                     PRINT 'CAJA NO ESTA ABIERTA'
                     CONTINUE
	                  FETCH NEXT FROM PAG_CAJMENOR_CURSOR    
	                  INTO @CNSFCXPCJM,@RESPONCJM,@VLRPAGOCJM,@CNSFCXPPM
                  END
                  SELECT @CNSACJ = CNSACJ FROM ACJ WHERE   CODCAJA  = @CAJAMENOR AND ABIERTA = 1                
                           
                  EXEC SPK_GENCONSECUTIVO @COMPANIA, @CAJAMENOR, '@FCJ',  @NVOCONSEC2 OUTPUT  

                  SELECT @NVOCONSEC2 = REPLACE(SPACE(8 - LEN(@NVOCONSEC2))+LTRIM(RTRIM(@NVOCONSEC2)),SPACE(1),0)
                             
                  INSERT INTO FCJ(CNSFACJ, CODCAJA, CLASE_FAC, NOADMISION, NOPRESTACION, 
                                    IDPLAN, VALORTOTAL, COMPANIA, IDAFILIADO, CERRADA, 
                                    FECHA, TIPO, PROCEDENCIA, N_FACTURA, IDTERCERO, 
                                    NOMBRECLIENTE, CNSACJ, N_RECIBO, ESTADO, IMPRESO, MARCACONT,
                                    CONTABILIZADA, NROCOMPROBANTE, AREAPRESTACION, CCOSTO, 
                                    SUBCCOSTO, CLASER, IDCAUSALANUL, USUARIOANUL, 
                                    SYS_COMPUTERNAMEANUL, FECHAANU, TCNSFACJ, IDENTIFICADOR, 
                                    SYS_COMPUTERNAME, OBSERVACION, RECAUDO, ENPAGOS,
                                    TIPOEGRESO, IMPRESOTRAS, BANCO, SUCURSAL, CTA_BCO, USUARIO, 
                                    DEAPERTURA)
                  SELECT @NVOCONSEC2, @CAJAMENOR, 'COBRO', NOADMISION, NOPRESTACION, IDPLAN, VALORTOTAL, COMPANIA, @CODCAJA,1 CERRADA, 
                           FECHA, 'EXTERNO', PROCEDENCIA, N_FACTURA, @CODCAJA, NOMBRECLIENTE, @CNSACJ, N_RECIBO, 'P', IMPRESO, MARCACONT,
                           CONTABILIZADA, NROCOMPROBANTE, AREAPRESTACION, CCOSTO, SUBCCOSTO, CLASER, IDCAUSALANUL, USUARIOANUL, 
                           SYS_COMPUTERNAMEANUL, FECHAANU, TCNSFACJ, IDENTIFICADOR, SYS_COMPUTERNAME, OBSERVACION, RECAUDO, ENPAGOS,
                           TIPOEGRESO, IMPRESOTRAS, BANCO, SUCURSAL, CTA_BCO, USUARIO, 3
                  FROM   FCJ
                  WHERE  CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA

                  SELECT @CPRECTRAS = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJRECEPCIONTRAS'

                  INSERT INTO FCJD(CNSFACJ, ITEM, CONCEPTO, AREAFUNCIONAL, VALORUNITARIO, 
                                    CANTIDAD, VALORTOTAL, IDSERVICIO, CODCAJA, N_RECIBO, 
                                    TDESCUENTO, TIPODCTO, VLRDESCUENTO, DCTO)
                  SELECT    @NVOCONSEC2, 1, @CPRECTRAS, AREAFUNCIONAL, VALORUNITARIO, 
                           CANTIDAD,    VALORTOTAL,  IDSERVICIO, @CAJAMENOR, N_RECIBO, 
                           TDESCUENTO,  TIPODCTO,    VLRDESCUENTO, DCTO
                  FROM FCJD
                  WHERE  CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA
                  AND IDSERVICIO=@CNSFCXPPM
                           
                           
                  SELECT @CNSPCJ = NULL
                  EXEC SPK_GENCONSECUTIVO @COMPANIA, @CAJAMENOR, '@PCJ', @CNSPCJ OUTPUT  
                     SELECT @CNSPCJ = REPLACE(SPACE(8 - LEN(@CNSPCJ))+LTRIM(RTRIM(@CNSPCJ)),SPACE(1),0)
                              
                     INSERT INTO PCJ(CNSPCJ, CNSFACJ, TIPOPAGO, VALOR, BANCO, 
                                       NUMERODOCUMENTO,
                                       NUMEROAUTORIZA, FECHA, CNSACJ, IDTERCERO, CODCAJA,
                                       IMPRESO, CODCAJADEP, CNSFACJDEP, SUCURSAL, CTA_BCO, 
                                       CNSDOC)
                  SELECT @CNSPCJ, @NVOCONSEC2, @DATOEFE, @VLRPAGOCJM, NULL, NULL, NULL, NULL,
                           @CNSACJ , NULL, @CAJAMENOR, 0, NULL, NULL, NULL, NULL, NULL  
								  
		            UPDATE CAJR SET VALOR=COALESCE(VALOR,0)+@VLRPAGOCJM   WHERE   FORMAPAGO=DBO.FNK_VALORVARIABLE('IDCJFPAEFECTIVO') AND CODCAJA=@CAJAMENOR
		            UPDATE FCJ SET IDTERCERO = DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO') WHERE CNSFACJ=@NVOCONSEC2 AND CODCAJA=@CAJAMENOR
                    UPDATE ACJD SET SALDO= (SELECT COALESCE(VALOR,0) FROM CAJR WHERE   FORMAPAGO=DBO.FNK_VALORVARIABLE('IDCJFPAEFECTIVO') AND CODCAJA=@CAJAMENOR)
                    WHERE CNSACJ=@CNSACJ AND TIPO='Saldo Inicial' AND FORMAPAGO=DBO.FNK_VALORVARIABLE('IDCJFPAEFECTIVO')
	            FETCH NEXT FROM PAG_CAJMENOR_CURSOR    
	            INTO @CNSFCXPCJM,@RESPONCJM,@VLRPAGOCJM,@CNSFCXPPM, @CAJAMENOR
	            END
	            CLOSE PAG_CAJMENOR_CURSOR
	            DEALLOCATE PAG_CAJMENOR_CURSOR    
            END                  

			SELECT @CNSFCXP=FCXP.CNSFCXP FROM FCJD INNER JOIN FCXPP ON FCXPP.CNSFCXPP = FCJD.IDSERVICIO INNER JOIN FCXP ON FCXPP.CNSFCXP=FCXP.CNSFCXP
            WHERE  FCJD.CODCAJA = @CODCAJA AND FCJD.CNSFACJ = @CNSFACJ
            
			EXEC SPK_CALCULOVALORESCXP @CNSFCXP

			-- ACTUALIZA PAGOS MASIVO
            UPDATE FCXPPM SET ESTADO='P'
            WHERE CNSFCXPPM =(SELECT TOP 1 FCXPP.CNSFCXPPM 
                              FROM FCJD,FCXPP 
                              WHERE  FCXPP.CNSFCXPP = FCJD.IDSERVICIO
                              AND    FCJD.CODCAJA   = @CODCAJA   
                              AND    FCJD.CNSFACJ   = @CNSFACJ)

            -- CONTROL DE FORMAS DE PAGO
            INSERT INTO #TPCJ(TIPOPAGO, VALOR, BANCO, SUCURSAL, CTA_BCO, CNSDOC, NUMERODOCUMENTO)
            SELECT TIPOPAGO, VALOR, BANCO, SUCURSAL, CTA_BCO, ISNULL(CNSDOC,''), NUMERODOCUMENTO FROM PCJ 
            WHERE  CODCAJA  = @CODCAJA 
            AND    CNSFACJ  = @CNSFACJ
            DECLARE PCJ_CURSOR CURSOR FOR  
            SELECT  #TPCJ.TIPOPAGO, #TPCJ.VALOR, #TPCJ.BANCO, #TPCJ.SUCURSAL, #TPCJ.CTA_BCO, 
                    #TPCJ.CNSDOC, #TPCJ.NUMERODOCUMENTO, ISNULL(FPA.REQBCO,0) 
            FROM    #TPCJ LEFT JOIN FPA ON #TPCJ.TIPOPAGO = FPA.FORMAPAGO
            OPEN    PCJ_CURSOR  
            FETCH NEXT FROM PCJ_CURSOR  
            INTO    @TIPOPAGO, @VALOR, @BANCO, @SUCURSAL, @CTA_BCO, @CNSDOC, @NUMERODOCUMENTO, @RECBCO
            WHILE @@FETCH_STATUS = 0  
            BEGIN  
               IF @TIPOPAGO = @DATOEFE
               BEGIN
                  BEGIN TRAN
                  UPDATE CAJR SET VALOR = VALOR - @VALOR 
                  WHERE FORMAPAGO = @TIPOPAGO AND CODCAJA = @CODCAJA          
                  COMMIT
               END
               ELSE
               BEGIN
                  UPDATE BCTDD SET IDTERCERO = @IDTERCERO, N_RECIBO = @N_RECIBO,
                                   UTILIZADO = 1, ESTADO = 'I', USUARIO = @USUARIO,
                                   FECHA = GETDATE(), VALOR = @VALOR,
                                   CNSFACJ=@CNSFACJ, CODCAJA=@CODCAJA 
                  WHERE  BANCO  = @BANCO  AND SUCURSAL    = @SUCURSAL AND CTA_BCO = @CTA_BCO 
                  AND    CNSDOC = @CNSDOC AND NODOCUMENTO = dbo.FNK_LIMPIATEXTO(@NUMERODOCUMENTO, '0-9')
                  /* AQUI SE CREA LA OPERACION FINANCIERA EN BANCOS*/
                  IF @RECBCO = 1
                  BEGIN
                    SELECT @IDOPERACION = DATO FROM USVGS WHERE IDVARIABLE = 'IDBCOPAGOCHEQUE'
                    SELECT @ITEMBMOV = COALESCE(MAX(ITEM),0)+1 FROM BMOV 
                    WHERE  CTA_BCO = @CTA_BCO AND SUCURSAL=@SUCURSAL 
                    AND    BANCO   = @BANCO 
                    IF  @ITEMBMOV IS NULL
                    SELECT @ITEMBMOV = 1
                    INSERT INTO BMOV(BANCO, SUCURSAL, CTA_BCO, ITEM, FECHAOPERACION,
                                     NODOCUMENTO, NOTRANSFOPER, IDOPERACION, VLROPERACION,
                                     DESCRIPCION, USUARIO, SYS_ComputerName, SALDOANTES,
                                     SALDODESP, TIPOCOBROFIN, PROCEDENCIA, ESTADO, CONTABILIZADA, NROCOMPROBANTE,
                                     CODCAJA, CNSFACJ) 
                    SELECT @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV, @FECHA,
                           @CNSFACJ, NULL, DBO.FNK_VALORVARIABLE('IDOFINCAJACR'), 0, @OBSERVACION,
                           @USUARIO, @SYS_COMPUTERNAME, 0, 0, NULL, 'CAJA', 'C', 1, @NROCOMPROBANTE,
                           @CODCAJA, @CNSFACJ
                    
                    INSERT INTO BMOVD(BANCO, SUCURSAL, CTA_BCO, ITEM, RENGLON, FORMAPAGO,
                                      BANCODOC, NODOCUMENTO, VLRITEM, PROCEDENCIA, CODCAJA,
                                      CNSFACJ, IDTERCERO) 
                    SELECT @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV, 1, 
                           @TIPOPAGO, @BANCO, @NODOCUMENTO,  @VALOR, 'CAJA', @CODCAJA, @CNSFACJ, @IDTERCERO
                    
                    EXEC SPK_TOT_BMOV @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV 
                    --EXEC SPK_OK_BMOV @CSGBANCO, @CSGSUCURSAL, @CSGCTA_BCO, @ITEMBMOV,@USUARIO,@SYS_COMPUTERNAME,@COMPANIA,@SEDE,@NROCOMPROBANTE
                    EXEC SPK_OK_BMOV @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV,@USUARIO,@SYS_COMPUTERNAME,@COMPANIA,@SEDE,@NROCOMPROBANTE
                  END                
                  
               END
               FETCH NEXT FROM PCJ_CURSOR  
               INTO @TIPOPAGO, @VALOR, @BANCO, @SUCURSAL, @CTA_BCO, @CNSDOC, @NUMERODOCUMENTO, @RECBCO
            END            
            CLOSE PCJ_CURSOR  
            DEALLOCATE PCJ_CURSOR                                         
         END
         ELSE
         BEGIN
            IF @TIPOEGRESO = @DATO3 OR @TIPOEGRESO = @DATO5
            BEGIN             
               print '@TIPOEGRESO JOSE ='+@TIPOEGRESO
               INSERT INTO #TPCJ(TIPOPAGO, VALOR, BANCO, SUCURSAL, CTA_BCO, CNSDOC, 
                           NUMERODOCUMENTO, CODCAJADEP, CNSFACJDEP)
               SELECT TIPOPAGO, VALOR, BANCO, SUCURSAL, CTA_BCO, CNSDOC, NUMERODOCUMENTO, 
                      CODCAJADEP, CNSFACJDEP
               FROM   PCJ 
               WHERE  CODCAJA  = @CODCAJA 
               AND    CNSFACJ  = @CNSFACJ   
               
               DECLARE PCJ_CURSOR CURSOR FOR  
               SELECT TIPOPAGO,VALOR, BANCO, SUCURSAL, CTA_BCO, CNSDOC, NUMERODOCUMENTO,
                      CODCAJADEP, CNSFACJDEP, COALESCE(FPA.REQBCO,0) 
               FROM #TPCJ   LEFT JOIN FPA ON #TPCJ.TIPOPAGO = FPA.FORMAPAGO
               OPEN PCJ_CURSOR  
               FETCH NEXT FROM PCJ_CURSOR  
               INTO @TIPOPAGO, @VALOR, @BANCO, @SUCURSAL, @CTA_BCO, @CNSDOC, @NUMERODOCUMENTO,
                    @CODCAJADEP, @CNSFACJDEP, @RECBCO 
               WHILE @@FETCH_STATUS = 0  
               BEGIN  
                  IF @TIPOPAGO = @DATOEFE
                  BEGIN
                     UPDATE CAJR SET VALOR = VALOR - @VALOR 
                     WHERE FORMAPAGO = @TIPOPAGO AND CODCAJA = @CODCAJA
                  END
                  IF @TIPOPAGO = @DATOCHQ
                  BEGIN
                     IF (@TIPOEGRESO = @DATO3 AND @DOCORIGEN = 0 ) OR (@TIPOEGRESO = @DATO5)
                     BEGIN
                        UPDATE BCTDD SET IDTERCERO = @IDTERCERO, N_RECIBO = @N_RECIBO,
                                         UTILIZADO = 1, ESTADO = 'I', USUARIO = @USUARIO,
                                         FECHA = GETDATE(), VALOR = @VALOR,
                                         CNSFACJ=@CNSFACJ, CODCAJA=@CODCAJA  
                        WHERE  BANCO = @BANCO AND SUCURSAL = @SUCURSAL AND CTA_BCO = @CTA_BCO 
                        AND   CNSDOC = @CNSDOC AND NODOCUMENTO = dbo.FNK_LIMPIATEXTO(@NUMERODOCUMENTO, '0-9')
                     END
                  END
                  ELSE
                  BEGIN
                     IF @RECBCO = 1
                     BEGIN
                        SELECT @ITEMBMOV = COALESCE(MAX(ITEM),0)+1 FROM BMOV 
                        WHERE  CTA_BCO = @CTA_BCO AND SUCURSAL=@SUCURSAL 
                        AND    BANCO   = @BANCO 
                        IF  @ITEMBMOV IS NULL
                        SELECT @ITEMBMOV = 1
                        INSERT INTO BMOV(BANCO, SUCURSAL, CTA_BCO, ITEM, FECHAOPERACION,
                                          NODOCUMENTO, NOTRANSFOPER, IDOPERACION, VLROPERACION,
                                          DESCRIPCION, USUARIO, SYS_ComputerName, SALDOANTES,
                                          SALDODESP, TIPOCOBROFIN, PROCEDENCIA, ESTADO, CONTABILIZADA, NROCOMPROBANTE,
                                          CODCAJA, CNSFACJ) 
                        SELECT @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV, @FECHA,
                              @CNSFACJ, NULL, DBO.FNK_VALORVARIABLE('IDOFINCAJACR'), 0, @OBSERVACION,
                              @USUARIO, @SYS_COMPUTERNAME, 0, 0, NULL, 'CAJA', 'C', 1, @NROCOMPROBANTE,
                              @CODCAJA, @CNSFACJ
                    
                        INSERT INTO BMOVD(BANCO, SUCURSAL, CTA_BCO, ITEM, RENGLON, FORMAPAGO,
                                          BANCODOC, NODOCUMENTO, VLRITEM, PROCEDENCIA, CODCAJA,
                                          CNSFACJ, IDTERCERO) 
                        SELECT @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV, 1, 
                              @TIPOPAGO, @BANCO, @NODOCUMENTO,  @VALOR, 'CAJA', @CODCAJA, @CNSFACJ, @IDTERCERO
                    
                        EXEC SPK_TOT_BMOV @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV 
                        --EXEC SPK_OK_BMOV @CSGBANCO, @CSGSUCURSAL, @CSGCTA_BCO, @ITEMBMOV,@USUARIO,@SYS_COMPUTERNAME,@COMPANIA,@SEDE,@NROCOMPROBANTE
                        EXEC SPK_OK_BMOV @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV,@USUARIO,@SYS_COMPUTERNAME,@COMPANIA,@SEDE,@NROCOMPROBANTE
                     END   
                     ELSE
                     BEGIN						
						  IF @TIPOPAGO <> @DATOEFE
						  BEGIN
							 UPDATE CAJR SET VALOR = VALOR - @VALOR 
							 WHERE FORMAPAGO = @TIPOPAGO AND CODCAJA = @CODCAJA
						  END
                        DELETE FCJTD WHERE CODCAJA = @CODCAJADEP AND FORMAPAGO = @TIPOPAGO
                        AND VALOR = @VALOR AND NUMERODOCUMENTO =  @NUMERODOCUMENTO
                     END   
                  END
                  IF @TIPOEGRESO =  @DATO3
                  BEGIN
                     PRINT ' DEVOLUCION DE DEPOSITOS'
                     UPDATE QXDING SET DEVUELTO = 1, CODCAJADV = @CODCAJA, CNSFACJDV = @CNSFACJ
                     FROM   PCJ
                     WHERE  QXDING.CODCAJA = @CODCAJADEP
                     AND    QXDING.CNSFACJ = @CNSFACJDEP
                        
                     UPDATE FCJDL SET DEVUELTO = 1, CODCAJADV = @CODCAJA, CNSFACJDV = @CNSFACJ
                     FROM   PCJ
                     WHERE  FCJDL.CODCAJA = @CODCAJADEP
                     AND    FCJDL.CNSFACJ = @CNSFACJDEP 
                     PRINT 'SALGO DE DEVOLUCIONES'
                  END
                  ELSE
                  BEGIN
                     UPDATE TFCJ SET CERRADA = 1 WHERE CLASE_FAC = 'PAGO' AND
                     CNSFACJ = @CNSFACJDEP  
                  END
                  FETCH NEXT FROM PCJ_CURSOR  
                  INTO @TIPOPAGO, @VALOR, @BANCO, @SUCURSAL, @CTA_BCO, @CNSDOC, @NUMERODOCUMENTO, @CODCAJADEP, @CNSFACJDEP ,@RECBCO 
               END  
               CLOSE PCJ_CURSOR  
               DEALLOCATE PCJ_CURSOR                  
            END
            ELSE
            BEGIN                
               IF @TIPOEGRESO = @DATO6 OR @TIPOEGRESO = @DATO7
               BEGIN
                  print '@TIPOEGRESO ='+@TIPOEGRESO
                  INSERT INTO #TPCJ(TIPOPAGO, VALOR)
                  SELECT TIPOPAGO, SUM(VALOR) FROM PCJ 
                  WHERE  CODCAJA = @CODCAJA 
                  AND    CNSFACJ = @CNSFACJ
                  GROUP BY TIPOPAGO
                                   
                  DECLARE PCJ_CURSOR CURSOR FOR  
                  SELECT TIPOPAGO, VALOR
                  FROM   #TPCJ  
                  OPEN   PCJ_CURSOR  
                  FETCH NEXT FROM PCJ_CURSOR  
                  INTO @TIPOPAGO, @VALOR
                  WHILE @@FETCH_STATUS = 0  
                  BEGIN  
                     UPDATE CAJR SET VALOR = VALOR - @VALOR 
                     WHERE FORMAPAGO = @TIPOPAGO AND CODCAJA = @CODCAJA                           
                     SELECT @OK = COUNT(*) FROM CAJR WHERE CODCAJA = @IDTERCERO
                     AND FORMAPAGO = @TIPOPAGO 
                     IF @OK = 0
                     BEGIN
                        INSERT INTO CAJR (CODCAJA, FORMAPAGO, VALOR)
                        SELECT @IDTERCERO, @TIPOPAGO , @VALOR 
                     END
                     ELSE
                     BEGIN
                        UPDATE CAJR SET VALOR = VALOR + @VALOR 
                        WHERE FORMAPAGO = @TIPOPAGO AND CODCAJA = @IDTERCERO 
                     END
                     FETCH NEXT FROM PCJ_CURSOR  
                     INTO @TIPOPAGO, @VALOR                    
                  END        
                  CLOSE PCJ_CURSOR  
                  DEALLOCATE PCJ_CURSOR     
                  
                  UPDATE FCJTD SET CODCAJA = @IDTERCERO, ASIGNADO = 0 
                  WHERE CODCAJA = @CODCAJA AND ASIGNADO = 1           
                  PRINT '-- SE CREA EL RECIBO DE INGRESO DE LA CAJA QUE RECIBE EL TRASLADO'
                  
                  SELECT @ABIERTA = ABIERTA FROM CAJ
                  WHERE  CODCAJA  = @IDTERCERO 
                  IF @ABIERTA <> 1
                  BEGIN
                     PRINT 'CAJA A LA QUE SE TRASLADA ESTA SIN ABRIR'
                     RETURN
                  END                    
                  
                  SELECT @OK = COUNT(*) FROM TER WHERE IDTERCERO = @CODCAJA
                  IF @OK = 0
                  BEGIN
                     PRINT 'CREANDO LA CAJA ORIGEN DE TRASLADO COMO TERCERO'
                     INSERT INTO TER(IDTERCERO, NIT, RAZONSOCIAL)
                     SELECT @CODCAJA, @CODCAJA, CAJ.DESCRIPCION FROM CAJ
                     WHERE  CAJ.CODCAJA = @CODCAJA
                     SELECT @DATOCATCAJA = DATO FROM USVGS WHERE IDVARIABLE = 'TERCATCAJA'
                     INSERT INTO TEXCA( IDTERCERO, IDCATEGORIA, ESTADO)
                     SELECT @CODCAJA, @DATOCATCAJA, 'Activo'   
                  END
                     
                  SELECT @CNSACJ = CNSACJ FROM ACJ WHERE   CODCAJA  = @IDTERCERO AND ABIERTA = 1                
                  
                  EXEC SPK_GENCONSECUTIVO @COMPANIA, @IDTERCERO, '@FCJ',  @NVOCONSEC2 OUTPUT  
                  SELECT @NVOCONSEC2 = REPLACE(SPACE(8 - LEN(@NVOCONSEC2))+LTRIM(RTRIM(@NVOCONSEC2)),SPACE(1),0)
                    
                  INSERT INTO FCJ(CNSFACJ, CODCAJA, CLASE_FAC, NOADMISION, NOPRESTACION, 
                                  IDPLAN, VALORTOTAL, COMPANIA, IDAFILIADO, CERRADA, 
                                  FECHA, TIPO, PROCEDENCIA, N_FACTURA, IDTERCERO, 
                                  NOMBRECLIENTE, CNSACJ, N_RECIBO, ESTADO, IMPRESO, MARCACONT,
                                  CONTABILIZADA, NROCOMPROBANTE, AREAPRESTACION, CCOSTO, 
                                  SUBCCOSTO, CLASER, IDCAUSALANUL, USUARIOANUL, 
                                  SYS_COMPUTERNAMEANUL, FECHAANU, TCNSFACJ, IDENTIFICADOR, 
                                  SYS_COMPUTERNAME, OBSERVACION, RECAUDO, ENPAGOS,
                                  TIPOEGRESO, IMPRESOTRAS, BANCO, SUCURSAL, CTA_BCO, USUARIO, 
                                  DEAPERTURA)
                  SELECT @NVOCONSEC2, @IDTERCERO, 'COBRO', NOADMISION, NOPRESTACION, 
                                  IDPLAN, VALORTOTAL, COMPANIA, @CODCAJA, CERRADA, 
                                  FECHA, TIPO, PROCEDENCIA, N_FACTURA, @CODCAJA, 
                                  NOMBRECLIENTE, @CNSACJ, N_RECIBO, ESTADO, IMPRESO, MARCACONT,
                                  CONTABILIZADA, NROCOMPROBANTE, AREAPRESTACION, CCOSTO, 
                                  SUBCCOSTO, CLASER, IDCAUSALANUL, USUARIOANUL, 
                                  SYS_COMPUTERNAMEANUL, FECHAANU, TCNSFACJ, IDENTIFICADOR, 
                                  SYS_COMPUTERNAME, OBSERVACION, RECAUDO, ENPAGOS,
                                  TIPOEGRESO, IMPRESOTRAS, BANCO, SUCURSAL, CTA_BCO, USUARIO,
                                  2
                  FROM   FCJ
                  WHERE  CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA
                  PRINT 'INSERTE FCJ'
                  SELECT @CPRECTRAS = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJRECEPCIONTRAS'
                  INSERT INTO FCJD(CNSFACJ, ITEM, CONCEPTO, AREAFUNCIONAL, VALORUNITARIO, 
                                   CANTIDAD, VALORTOTAL, IDSERVICIO, CODCAJA, N_RECIBO, 
                                   TDESCUENTO, TIPODCTO, VLRDESCUENTO, DCTO)
                  SELECT @NVOCONSEC2, 1, @CPRECTRAS, AREAFUNCIONAL, VALORUNITARIO, 
                         CANTIDAD,    VALORTOTAL,  IDSERVICIO, @IDTERCERO, N_RECIBO, 
                         TDESCUENTO,  TIPODCTO,    VLRDESCUENTO, DCTO
                  FROM FCJD
                  WHERE  CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA
                  PRINT 'INSERTE FCJD'
                  DECLARE PCJ_CURSOR CURSOR FOR  
                  SELECT  TIPOPAGO, VALOR
                  FROM    PCJ
                  WHERE   CNSFACJ = @CNSFACJ
                  AND     CODCAJA = @CODCAJA
                  
                  OPEN    PCJ_CURSOR  
                  FETCH NEXT FROM PCJ_CURSOR  
                  INTO  @TIPOPAGO, @VALOR
                  WHILE @@FETCH_STATUS = 0  
                  BEGIN  
                     SELECT @CNSPCJ = NULL
                     PRINT 'INSERTANDO PCJ @IDTERCERO='+@IDTERCERO
                     EXEC SPK_GENCONSECUTIVO @COMPANIA, @IDTERCERO, '@PCJ', @CNSPCJ OUTPUT  
                     SELECT @CNSPCJ = LTRIM(RTRIM(@IDTERCERO))+REPLACE(SPACE(8 - LEN(@CNSPCJ))+LTRIM(RTRIM(@CNSPCJ)),SPACE(1),0)
                     PRINT '@CNSPCJ ='+@CNSPCJ+'//@NVOCONSEC2='+@NVOCONSEC2
                     INSERT INTO PCJ(CNSPCJ, CNSFACJ, TIPOPAGO, VALOR, BANCO, 
                                     NUMERODOCUMENTO,
                                     NUMEROAUTORIZA, FECHA, CNSACJ, IDTERCERO, CODCAJA,
                                     IMPRESO, CODCAJADEP, CNSFACJDEP, SUCURSAL, CTA_BCO, 
                                     CNSDOC)
                     SELECT @CNSPCJ, @NVOCONSEC2, @TIPOPAGO, @VALOR, NULL, NULL, NULL, NULL,
                            @CNSACJ , NULL, @IDTERCERO, 0, NULL, NULL, NULL, NULL, NULL
                     
                     FETCH NEXT FROM PCJ_CURSOR  
                     INTO  @TIPOPAGO, @VALOR
                  END
                  CLOSE PCJ_CURSOR  
                  DEALLOCATE PCJ_CURSOR                      
               END
               ELSE
               BEGIN
                  IF @TIPOEGRESO = @DEVDOC OR @TIPOEGRESO = @DEVREC
                  BEGIN
                     PRINT 'INGRESE A DEVOLUCION DE DOCUMENTOS'   
                     DELETE FROM #TPCJ    
                     INSERT INTO #TPCJ(TIPOPAGO, VALOR)
                     SELECT TIPOPAGO, SUM(VALOR) FROM PCJ  
                     WHERE  CODCAJA = @CODCAJA 
                     AND    CNSFACJ = @CNSFACJ
                     GROUP BY TIPOPAGO
                                      
                     DECLARE PCJ_CURSOR CURSOR FOR  
                     SELECT TIPOPAGO, VALOR
                     FROM   #TPCJ  
                     OPEN   PCJ_CURSOR  
                     FETCH NEXT FROM PCJ_CURSOR  
                     INTO @TIPOPAGO, @VALOR
                     WHILE @@FETCH_STATUS = 0  
                     BEGIN  
                        UPDATE CAJR SET VALOR = VALOR - @VALOR 
                        WHERE FORMAPAGO = @TIPOPAGO AND CODCAJA = @CODCAJA   
                        
                        FETCH NEXT FROM PCJ_CURSOR  
                        INTO @TIPOPAGO, @VALOR
                     END        
                     CLOSE PCJ_CURSOR  
                     DEALLOCATE PCJ_CURSOR     

                     IF @TIPOEGRESO = @DEVDOC
                     BEGIN
                        DELETE FROM FCJTD WHERE CODCAJA = @CODCAJA AND ASIGNADO = 1           
                     END 
                     ELSE
                     IF @TIPOEGRESO = @DEVREC
                     BEGIN
                        PRINT 'Devolviendo Pago de procedencia SALUD, CE o CITAS ...'
                        DECLARE PCJ_CURSOR CURSOR FOR
                        SELECT CODCAJADEP, CNSFACJDEP
                        FROM PCJ 
                        WHERE CODCAJA = @CODCAJA AND CNSFACJ = @CNSFACJ
                        OPEN PCJ_CURSOR
                        FETCH NEXT FROM PCJ_CURSOR
                        INTO @CODCAJA_DEV, @CNSFACJ_DEV
                        WHILE @@FETCH_STATUS = 0
                        BEGIN
                           SELECT @PROC_DEV = PROCEDENCIA, @NOADMISION_DEV = NOADMISION, @NOPRESTACION_DEV = NOPRESTACION 
                           FROM   FCJ 
                           WHERE  CODCAJA=@CODCAJA_DEV AND CNSFACJ=@CNSFACJ_DEV
                           EXEC DBO.SPK_DEVUELVERECIB_CAJA @CODCAJA_DEV, @CNSFACJ_DEV, @COMPANIA, @SEDE
                           IF @PROC_DEV = 'CE'
                           BEGIN
                              UPDATE AUTD SET AUTORIZADO = 0 WHERE IDAUT = @NOPRESTACION_DEV
                           END   
                           UPDATE PCJ SET VLR_DEVUELTO = VALOR WHERE CODCAJA = @CODCAJA_DEV AND CNSFACJ = @CNSFACJ_DEV
                           FETCH NEXT FROM PCJ_CURSOR
                           INTO @CODCAJA_DEV, @CNSFACJ_DEV
                        END
                        DEALLOCATE PCJ_CURSOR
                     END
                  END
                  ELSE
                  IF @TIPOEGRESO=@DATO4
                  OR (@IDCATEGORIA=DBO.FNK_VALORVARIABLE('TERCATBANCO') AND @TIPOEGRESO NOT IN (SELECT DATO FROM USVGS WHERE IDVARIABLE IN ('IDCJTETRASBCOCAJA','IDCJTETRASLADOBCO'))) 
                  BEGIN
                     PRINT 'INGRESE A CONSIGNACION'   
                     SELECT @IDOPERACION = DATO FROM USVGS WHERE IDVARIABLE = 'IDBCOCONSIGNACION'
                     SELECT @ITEMBMOV = COALESCE(MAX(ITEM),0)+1 FROM BMOV 
                     WHERE  CTA_BCO = @CSGCTA_BCO AND SUCURSAL=@CSGSUCURSAL 
                     AND    BANCO = @CSGBANCO 
                     
                     IF  @ITEMBMOV IS NULL
                         SELECT @ITEMBMOV = 1
                     
                     PRINT  'MAX ITEM EN BMOV ='+STR(@ITEMBMOV)      
                     INSERT INTO BMOV(BANCO, SUCURSAL, CTA_BCO, ITEM, FECHAOPERACION,
                                      NODOCUMENTO, NOTRANSFOPER, IDOPERACION, VLROPERACION,
                                      DESCRIPCION, USUARIO, SYS_ComputerName, SALDOANTES,
                                      SALDODESP, TIPOCOBROFIN, PROCEDENCIA, ESTADO, CONTABILIZADA, NROCOMPROBANTE,
                                      CODCAJA, CNSFACJ)
                     SELECT @CSGBANCO, @CSGSUCURSAL, @CSGCTA_BCO, @ITEMBMOV , @FECHA,
                            @CNSFACJ, NULL, DBO.FNK_VALORVARIABLE('IDOFINCAJADB'), 0, @OBSERVACION,
                            @USUARIO, @SYS_COMPUTERNAME, 0, 0, NULL, 'CAJA', 'C', 1, @NROCOMPROBANTE, 
                            @CODCAJA, @CNSFACJ
                     
                     SELECT @RENGLON = 1
                     
                     DELETE FROM #TPCJ     
                     INSERT INTO #TPCJ(TIPOPAGO, VALOR)
                     SELECT PCJ.TIPOPAGO, SUM(VALOR) FROM PCJ, FPA  
                     WHERE  PCJ.CODCAJA   = @CODCAJA 
                     AND    PCJ.CNSFACJ   = @CNSFACJ
                     AND FPA.FORMAPAGO    = PCJ.TIPOPAGO
                     AND FPA.REQDOC       = 0
                     GROUP BY TIPOPAGO
                     
                     DECLARE PCJ_CURSOR CURSOR FOR  
                     SELECT TIPOPAGO, VALOR
                     FROM   #TPCJ  
                     OPEN   PCJ_CURSOR  
                     FETCH NEXT FROM PCJ_CURSOR  
                     INTO @TIPOPAGO, @VALOR
                     WHILE @@FETCH_STATUS = 0  
                     BEGIN  
                        
                        INSERT INTO BMOVD(BANCO, SUCURSAL, CTA_BCO, ITEM, RENGLON, FORMAPAGO,
                                          BANCODOC, NODOCUMENTO, VLRITEM, PROCEDENCIA, CODCAJA,
                                          CNSFACJ, IDTERCERO) 
                        SELECT @CSGBANCO, @CSGSUCURSAL, @CSGCTA_BCO, @ITEMBMOV, @RENGLON, 
                               @TIPOPAGO, NULL, NULL, @VALOR, 'CAJA', @CODCAJA, @CNSFACJ, @IDTERCERO
                        SELECT @RENGLON = @RENGLON + 1 
                        FETCH NEXT FROM PCJ_CURSOR  
                        INTO @TIPOPAGO, @VALOR
                        
                     END        
                     CLOSE PCJ_CURSOR  
                     DEALLOCATE PCJ_CURSOR                          
                     
                     DELETE FROM #TPCJ    
                     INSERT INTO #TPCJ(TIPOPAGO, VALOR)
                     SELECT TIPOPAGO, SUM(VALOR) FROM PCJ  
                     WHERE  CODCAJA = @CODCAJA 
                     AND    CNSFACJ = @CNSFACJ
                     GROUP BY TIPOPAGO
                                      
                     DECLARE PCJ_CURSOR CURSOR FOR  
                     SELECT TIPOPAGO, VALOR
                     FROM   #TPCJ  
                     OPEN   PCJ_CURSOR  
                     FETCH NEXT FROM PCJ_CURSOR  
                     INTO @TIPOPAGO, @VALOR
                     WHILE @@FETCH_STATUS = 0  
                     BEGIN  
                        
                        UPDATE CAJR SET VALOR = VALOR - @VALOR 
                        WHERE FORMAPAGO = @TIPOPAGO AND CODCAJA = @CODCAJA   
                        
                        FETCH NEXT FROM PCJ_CURSOR  
                        INTO @TIPOPAGO, @VALOR
                     END        
                     CLOSE PCJ_CURSOR  
                     DEALLOCATE PCJ_CURSOR     
                        
                     DECLARE FCJTD_CURSOR CURSOR FOR  
                     SELECT  FORMAPAGO, VALOR, BANCO, NUMERODOCUMENTO
                     FROM    FCJTD 
                     WHERE   CODCAJA = @CODCAJA AND ASIGNADO = 1  AND COALESCE(CONSIGNADO,0)=0         
                     OPEN    FCJTD_CURSOR  
                     FETCH NEXT FROM FCJTD_CURSOR  
                     INTO    @TIPOPAGO, @VALOR, @BANCO, @NODOCUMENTO
                     WHILE @@FETCH_STATUS = 0  
                     BEGIN  
                        
                        INSERT INTO BMOVD(BANCO, SUCURSAL, CTA_BCO, ITEM, RENGLON, FORMAPAGO,
                                          BANCODOC, NODOCUMENTO, VLRITEM, CODCAJA, CNSFACJ, IDTERCERO)
                        SELECT @CSGBANCO, @CSGSUCURSAL, @CSGCTA_BCO, @ITEMBMOV, @RENGLON, 
                               @TIPOPAGO, @BANCO, @NODOCUMENTO, @VALOR, @CODCAJA, @CNSFACJ, @IDTERCERO
                        
                        SELECT @RENGLON = @RENGLON + 1 
                        
                        FETCH NEXT FROM FCJTD_CURSOR  
                        INTO    @TIPOPAGO, @VALOR, @BANCO, @NODOCUMENTO
                     END                        
                     CLOSE FCJTD_CURSOR  
                     DEALLOCATE FCJTD_CURSOR     
                 
                     --DELETE FROM FCJTD 
                     --WHERE  CODCAJA = @CODCAJA AND ASIGNADO = 1 
                     UPDATE FCJTD SET CONSIGNADO=1, BANCOCSG=@CSGBANCO ,CUENTACSG=@CSGCTA_BCO, FECHACSG=@FECHA
                     WHERE  CODCAJA = @CODCAJA 
                     AND ASIGNADO = 1        
                     AND COALESCE(CONSIGNADO,0)=0
                     AND CNSFACJCSG=@CNSFACJ
                  
                     EXEC SPK_TOT_BMOV @CSGBANCO, @CSGSUCURSAL, @CSGCTA_BCO, @ITEMBMOV 
                     EXEC SPK_OK_BMOV @CSGBANCO, @CSGSUCURSAL, @CSGCTA_BCO, @ITEMBMOV,@USUARIO,@SYS_COMPUTERNAME,@COMPANIA,@SEDE,@NROCOMPROBANTE
                                                         
                  END
                  ELSE
                  BEGIN
                     --DESDE AQUI
                     PRINT 'Egreso por Nomina...'
                     IF @TIPOEGRESO = @DATON
                     BEGIN
                        UPDATE BCTDD SET CODCAJA   = @CODCAJA,      CNSFACJ = @CNSFACJ,
                                         IDTERCERO = PCJ.IDTERCERO,   VALOR = PCJ.VALOR
                     
                        FROM   PCJ
                        WHERE  BCTDD.BANCO       = PCJ.BANCO    
                        AND    BCTDD.SUCURSAL    = PCJ.SUCURSAL
                        AND    BCTDD.CTA_BCO     = PCJ.CTA_BCO
                        AND    BCTDD.CNSDOC      = PCJ.CNSDOC
                        AND    BCTDD.NODOCUMENTO = PCJ.NUMERODOCUMENTO                        
                        --
                        AND    PCJ.CODCAJA = @CODCAJA
                        AND    PCJ.CNSFACJ = @CNSFACJ
                        
                        DECLARE CUR_BCO CURSOR FOR
                        SELECT DISTINCT PCJ.BANCO, PCJ.SUCURSAL, PCJ.CTA_BCO
                        FROM PCJ INNER JOIN
                             FPA ON PCJ.TIPOPAGO = FPA.FORMAPAGO
                        WHERE FPA.REQBCO = 1 AND PCJ.CNSFACJ = @CNSFACJ AND PCJ.CODCAJA = @CODCAJA

                        OPEN CUR_BCO

                        FETCH NEXT FROM CUR_BCO
                        INTO @BANCO2, @SUCURSAL2, @CTA_BCO2

                        WHILE @@FETCH_STATUS = 0
                        BEGIN
                         PRINT 'Banco: '+ISNULL(@BANCO2,'')+' Sucursal: '+ISNULL(@SUCURSAL2,'')+'Cuenta: '+ISNULL(@CTA_BCO2,'')
                         SELECT @ITEMBMOV = COALESCE(MAX(ITEM),0)+1 FROM BMOV 
                         WHERE  CTA_BCO = @CTA_BCO2 AND SUCURSAL=@SUCURSAL2 AND BANCO = @BANCO2 
   
                         INSERT INTO BMOV(BANCO, SUCURSAL, CTA_BCO, ITEM, FECHAOPERACION,
                                     NODOCUMENTO, NOTRANSFOPER, IDOPERACION, VLROPERACION,
                                     DESCRIPCION, USUARIO, SYS_COMPUTERNAME, SALDOANTES,
                                     SALDODESP, TIPOCOBROFIN, PROCEDENCIA, ESTADO, CONTABILIZADA, NROCOMPROBANTE,
                                     CODCAJA, CNSFACJ) 
                         SELECT @BANCO2, @SUCURSAL2, @CTA_BCO2, @ITEMBMOV , @FECHA,
                                @CNSFACJ, NULL, DBO.FNK_VALORVARIABLE('IDOFINCAJACR'), 0, @OBSERVACION,
                                @USUARIO, @SYS_COMPUTERNAME, 0, 0, NULL, 'CAJA', 'C', 1, @NROCOMPROBANTE,
                                @CODCAJA, @CNSFACJ

                         DECLARE CUR CURSOR FOR
                         SELECT PCJ.TIPOPAGO, PCJ.VALOR, PCJ.IDTERCERO, PCJ.NUMERODOCUMENTO
                         FROM PCJ INNER JOIN 
                              FPA ON PCJ.TIPOPAGO = FPA.FORMAPAGO
                         WHERE FPA.REQBCO = 1 AND PCJ.CNSFACJ = @CNSFACJ AND PCJ.CODCAJA = @CODCAJA AND
                               PCJ.BANCO=@BANCO2 AND PCJ.SUCURSAL=@SUCURSAL2 AND PCJ.CTA_BCO=@CTA_BCO2
    
                         OPEN CUR
                         
                         FETCH NEXT FROM CUR
                         INTO @TIPOPAGO, @VALOR, @IDTERCERO, @NODOCUMENTO

                         SET @RENGLON = 0
                         WHILE @@FETCH_STATUS = 0
                         BEGIN
                          SET @RENGLON = @RENGLON + 1
                          PRINT ' - ID TERCERO: '+@IDTERCERO+',  Valor: '+STR(@VALOR)
                          INSERT INTO BMOVD(BANCO, SUCURSAL, CTA_BCO, ITEM, RENGLON, FORMAPAGO,
                                      BANCODOC, NODOCUMENTO, VLRITEM, PROCEDENCIA, CODCAJA,
                                      CNSFACJ, IDTERCERO) 
                          SELECT @BANCO2, @SUCURSAL2, @CTA_BCO2, @ITEMBMOV, @RENGLON, 
                                 @TIPOPAGO, @BANCO2, @NODOCUMENTO,  @VALOR, 'CAJA', @CODCAJA, @CNSFACJ, @IDTERCERO

                          FETCH NEXT FROM CUR
                          INTO @TIPOPAGO, @VALOR, @IDTERCERO, @NODOCUMENTO
                         END
                         CLOSE CUR
                         DEALLOCATE CUR
   
                         EXEC SPK_TOT_BMOV @BANCO2, @SUCURSAL2, @CTA_BCO2, @ITEMBMOV 
                         EXEC SPK_OK_BMOV @CSGBANCO, @CSGSUCURSAL, @CSGCTA_BCO, @ITEMBMOV,@USUARIO,@SYS_COMPUTERNAME,@COMPANIA,@SEDE,@NROCOMPROBANTE

                         FETCH NEXT FROM CUR_BCO
                         INTO @BANCO2, @SUCURSAL2, @CTA_BCO2
                        END
                        CLOSE CUR_BCO
                        DEALLOCATE CUR_BCO
                     END
                     ELSE
                     BEGIN
                        PRINT 'ELSE DESPUES DE TODAS LAS VARIABLES'
                        DECLARE PCJ_CURSOR CURSOR FOR  
                        SELECT PCJ.TIPOPAGO, PCJ.VALOR, PCJ.BANCO, PCJ.SUCURSAL, PCJ.CTA_BCO, PCJ.CNSDOC, 
                               PCJ.NUMERODOCUMENTO, ISNULL(FPA.REQBCO,0) 
                        FROM   PCJ LEFT JOIN FPA ON PCJ.TIPOPAGO = FPA.FORMAPAGO
                        WHERE  PCJ.CODCAJA = @CODCAJA 
                        AND    PCJ.CNSFACJ = @CNSFACJ
                        
                        OPEN PCJ_CURSOR  
                        FETCH NEXT FROM PCJ_CURSOR  
                        INTO @TIPOPAGO, @VALOR, @BANCO, @SUCURSAL, @CTA_BCO, @CNSDOC, @NUMERODOCUMENTO, @RECBCO  
                        WHILE @@FETCH_STATUS = 0  
                        BEGIN  
                           --  AQUI VA EL CAMBIO DE CHEQUE
                           IF @TIPOPAGO = @DATOCHQ
                           BEGIN
						   print 'entre aqui tercero '+@IDTERCERO+'este es el recibo: '+ @N_RECIBO
                              UPDATE BCTDD SET IDTERCERO = @IDTERCERO, N_RECIBO = @N_RECIBO,
                                               UTILIZADO = 1, ESTADO = 'I', USUARIO = @USUARIO,
                                            FECHA     = GETDATE(), VALOR = @VALOR, CODCAJA = @CODCAJA,
                                            CNSFACJ   = @CNSFACJ 
                              WHERE  BANCO = @BANCO AND SUCURSAL = @SUCURSAL AND CTA_BCO = @CTA_BCO 
                              AND    CNSDOC =coalesce( @CNSDOC,'') AND NODOCUMENTO = dbo.FNK_LIMPIATEXTO(@NUMERODOCUMENTO, '0-9')
                               
                           END
                           ELSE
                           BEGIN               
                              IF @TIPOEGRESO <> @TRASACAJA
                              BEGIN
                                 UPDATE CAJR SET VALOR = VALOR - @VALOR 
                                 WHERE FORMAPAGO = @TIPOPAGO AND CODCAJA = @CODCAJA                                              
                              END
                           END                   
                           /* AQUI SE CREA LA OPERACION FINANCIERA EN BANCOS*/
                           IF @RECBCO = 1
                           BEGIN
                              SELECT @IDOPERACION = DATO FROM USVGS WHERE IDVARIABLE = 'IDBCOPAGOCHEQUE'
                              SELECT @ITEMBMOV = COALESCE(MAX(ITEM),0)+1 FROM BMOV 
                              WHERE  CTA_BCO = @CTA_BCO AND SUCURSAL=@SUCURSAL 
                              AND    BANCO   = @BANCO 
                              IF  @ITEMBMOV IS NULL
                              BEGIN
                                 SELECT @ITEMBMOV = 1
                              END
                              PRINT 'INSERT BANCO TRASLADO DE BANCO A CAJA'
                              INSERT INTO BMOV(BANCO, SUCURSAL, CTA_BCO, ITEM, FECHAOPERACION,FECHAOK,
                                               NODOCUMENTO, NOTRANSFOPER, IDOPERACION, VLROPERACION,
                                               DESCRIPCION, USUARIO, SYS_ComputerName, SALDOANTES,
                                               SALDODESP, TIPOCOBROFIN, PROCEDENCIA, ESTADO, CONTABILIZADA, NROCOMPROBANTE,
                                                      CODCAJA, CNSFACJ) 
                              SELECT @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV , @FECHA,@FECHA,
                                     @CNSFACJ, NULL, DBO.FNK_VALORVARIABLE('IDOFINCAJACR'), 0, @OBSERVACION,
                                     @USUARIO, @SYS_COMPUTERNAME, 0, 0, NULL, 'CAJA', 'C', 1, @NROCOMPROBANTE, 
                                            @CODCAJA, @CNSFACJ
        	                     
                              INSERT INTO BMOVD(BANCO, SUCURSAL, CTA_BCO, ITEM, RENGLON, FORMAPAGO,
                                                BANCODOC, NODOCUMENTO, VLRITEM, PROCEDENCIA, CODCAJA,
                                                CNSFACJ, IDTERCERO) 
                              SELECT @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV, 1, 
                                     @TIPOPAGO, @BANCO, @NODOCUMENTO,  @VALOR, 'CAJA', @CODCAJA, @CNSFACJ, @IDTERCERO
        	                    
                              EXEC SPK_TOT_BMOV @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV
                              PRINT 'APLICO MOVIMIENTO '
                              IF @TIPOEGRESO = @TRASACAJA
                              BEGIN
                                 EXEC SPK_OK_BMOV  @BANCO, @SUCURSAL, @CTA_BCO, @ITEMBMOV,@USUARIO,@SYS_COMPUTERNAME,@COMPANIA,@SEDE,@NROCOMPROBANTE
                              END
                              ELSE
                              BEGIN
                                 EXEC SPK_OK_BMOV @CSGBANCO, @CSGSUCURSAL, @CSGCTA_BCO, @ITEMBMOV,@USUARIO,@SYS_COMPUTERNAME,@COMPANIA,@SEDE,@NROCOMPROBANTE
                              END
                           END                
                           FETCH NEXT FROM PCJ_CURSOR  
                           INTO @TIPOPAGO, @VALOR, @BANCO, @SUCURSAL, @CTA_BCO, @CNSDOC, @NUMERODOCUMENTO, @RECBCO  
                        END  
                        CLOSE PCJ_CURSOR  
                        DEALLOCATE PCJ_CURSOR     
                        -- TRASLADOS DE BANCOS
                        
                        IF DBO.FNK_VALORVARIABLE('IDCJTETRASLADOBCO') = @TIPOEGRESO
                        BEGIN
                           PRINT 'Iniciando Deposito en Banco por Traslado.'
                           SELECT @BANCO2 = BANCO, @SUCURSAL2 = SUCURSAL, @CTA_BCO2 = CTA_BCO
                           FROM FCJ 
                           WHERE CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA

                           SELECT @ITEMBMOV = COALESCE(MAX(ITEM),0)+1
                           FROM BMOV, FCJ 
                           WHERE BMOV.CTA_BCO = @CTA_BCO2 AND BMOV.SUCURSAL=@SUCURSAL2 AND BMOV.BANCO = @BANCO2
                           IF  @ITEMBMOV IS NULL
                            SELECT @ITEMBMOV = 1
                           INSERT INTO BMOV(BANCO, SUCURSAL, CTA_BCO, ITEM, FECHAOPERACION,
                                            NODOCUMENTO, NOTRANSFOPER, IDOPERACION, VLROPERACION,
                                            DESCRIPCION, USUARIO, SYS_ComputerName, SALDOANTES,
                                            SALDODESP, TIPOCOBROFIN, PROCEDENCIA, ESTADO, CONTABILIZADA, NROCOMPROBANTE,
                                            CODCAJA, CNSFACJ) 
                           SELECT @BANCO2, @SUCURSAL2, @CTA_BCO2, @ITEMBMOV , @FECHA,
                                  @CNSFACJ, NULL, DBO.FNK_VALORVARIABLE('IDOFINCAJADB'), 0, @OBSERVACION,
                                  @USUARIO, @SYS_COMPUTERNAME, 0, 0, NULL, 'CAJA', 'C', 1, @NROCOMPROBANTE,
                                  @CODCAJA, @CNSFACJ

                           DECLARE PCJ_CURSOR CURSOR FOR  
                           SELECT PCJ.TIPOPAGO, PCJ.VALOR, PCJ.CNSDOC, PCJ.NUMERODOCUMENTO, PCJ.BANCO
                           FROM PCJ 
                           WHERE  PCJ.CODCAJA = @CODCAJA AND PCJ.CNSFACJ = @CNSFACJ
                           OPEN PCJ_CURSOR  
                           FETCH NEXT FROM PCJ_CURSOR  
                           INTO @TIPOPAGO, @VALOR, @CNSDOC, @NUMERODOCUMENTO, @BANCO
                           SET @RENGLON = 0
                           WHILE @@FETCH_STATUS = 0  
                           BEGIN  
                              SET @RENGLON = @RENGLON + 1
                              INSERT INTO BMOVD(BANCO, SUCURSAL, CTA_BCO, ITEM, RENGLON, FORMAPAGO, BANCODOC, 
                                                NODOCUMENTO, VLRITEM, PROCEDENCIA, CODCAJA, CNSFACJ, IDTERCERO) 
                              SELECT @BANCO2, @SUCURSAL2, @CTA_BCO2, @ITEMBMOV, @RENGLON, 
                                     @TIPOPAGO, @BANCO, @NODOCUMENTO,  @VALOR, 'CAJA', @CODCAJA, @CNSFACJ, @IDTERCERO
                   
                              FETCH NEXT FROM PCJ_CURSOR  
                              INTO @TIPOPAGO, @VALOR, @CNSDOC, @NUMERODOCUMENTO, @BANCO
                           END
                           CLOSE PCJ_CURSOR  
                           DEALLOCATE PCJ_CURSOR     
                           EXEC SPK_TOT_BMOV @BANCO2, @SUCURSAL2, @CTA_BCO2, @ITEMBMOV 
                           EXEC SPK_OK_BMOV @CSGBANCO, @CSGSUCURSAL, @CSGCTA_BCO, @ITEMBMOV,@USUARIO,@SYS_COMPUTERNAME,@COMPANIA,@SEDE,@NROCOMPROBANTE
                        END
                        /****************************************************/
                        IF @TIPOEGRESO = @TRASACAJA
                        BEGIN
                           PRINT 'TRASLADO DE BANCO A CAJA  CREO EL MOVIMIENTO DE INGRESO'
                           DECLARE @CAJAREP VARCHAR(20)
                           SELECT @CAJAREP=@IDTERCERO
                           SELECT @ABIERTA = ABIERTA FROM CAJ
                           WHERE  CODCAJA  = @CAJAREP 
                           IF @ABIERTA <> 1
                           BEGIN
                              PRINT 'CAJA A LA QUE SE TRASLADA ESTA SIN ABRIR'
                              RETURN
                           END                    
                           
                           --SELECT @OK = COUNT(*) FROM TER WHERE IDTERCERO = @CODCAJA
                           --IF @OK = 0
                           --BEGIN
                           --   PRINT 'CREANDO LA CAJA ORIGEN DE TRASLADO COMO TERCERO'
                           --   INSERT INTO TER(IDTERCERO, NIT, RAZONSOCIAL)
                           --   SELECT @CODCAJA, @CODCAJA, CAJ.DESCRIPCION FROM CAJ
                           --   WHERE  CAJ.CODCAJA = @CODCAJA
                           --   SELECT @DATOCATCAJA = DATO FROM USVGS WHERE IDVARIABLE = 'TERCATCAJA'
                           --   INSERT INTO TEXCA( IDTERCERO, IDCATEGORIA, ESTADO)
                           --   SELECT @CODCAJA, @DATOCATCAJA, 'Activo'   
                           --END
                              
                           SELECT @CNSACJ = CNSACJ FROM ACJ WHERE   CODCAJA  = @CAJAREP AND ABIERTA = 1                
                           
                           EXEC SPK_GENCONSECUTIVO @COMPANIA, @CAJAREP, '@FCJ',  @NVOCONSEC2 OUTPUT  
                           SELECT @NVOCONSEC2 = REPLACE(SPACE(8 - LEN(@NVOCONSEC2))+LTRIM(RTRIM(@NVOCONSEC2)),SPACE(1),0)

                           PRINT ' CNSFACJ ='+@NVOCONSEC2+' @CODCAREP= '+@CAJAREP 
                             
                           INSERT INTO FCJ(CNSFACJ, CODCAJA, CLASE_FAC, NOADMISION, NOPRESTACION, 
                                           IDPLAN, VALORTOTAL, COMPANIA, IDAFILIADO, CERRADA, 
                                           FECHA, TIPO, PROCEDENCIA, N_FACTURA, IDTERCERO, 
                                           NOMBRECLIENTE, CNSACJ, N_RECIBO, ESTADO, IMPRESO, MARCACONT,
                                           CONTABILIZADA, NROCOMPROBANTE, AREAPRESTACION, CCOSTO, 
                                           SUBCCOSTO, CLASER, IDCAUSALANUL, USUARIOANUL, 
                                           SYS_COMPUTERNAMEANUL, FECHAANU, TCNSFACJ, IDENTIFICADOR, 
                                           SYS_COMPUTERNAME, OBSERVACION, RECAUDO, ENPAGOS,
                                           TIPOEGRESO, IMPRESOTRAS, BANCO, SUCURSAL, CTA_BCO, USUARIO, 
                                           DEAPERTURA)
                           SELECT @NVOCONSEC2, @CAJAREP, 'COBRO', NOADMISION, NOPRESTACION, IDPLAN, VALORTOTAL, COMPANIA, @CODCAJA, CERRADA, 
                                  FECHA, 'EXTERNO', PROCEDENCIA, N_FACTURA, @CODCAJA, NOMBRECLIENTE, @CNSACJ, N_RECIBO, ESTADO, IMPRESO, MARCACONT,
                                  CONTABILIZADA, NROCOMPROBANTE, AREAPRESTACION, CCOSTO, SUBCCOSTO, CLASER, IDCAUSALANUL, USUARIOANUL, 
                                  SYS_COMPUTERNAMEANUL, FECHAANU, TCNSFACJ, IDENTIFICADOR, SYS_COMPUTERNAME, OBSERVACION, RECAUDO, ENPAGOS,
                                  TIPOEGRESO, IMPRESOTRAS, BANCO, SUCURSAL, CTA_BCO, USUARIO, 3
                           FROM   FCJ
                           WHERE  CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA

                           SELECT @CPRECTRAS = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJRECEPCIONTRAS'

                           INSERT INTO FCJD(CNSFACJ, ITEM, CONCEPTO, AREAFUNCIONAL, VALORUNITARIO, 
                                            CANTIDAD, VALORTOTAL, IDSERVICIO, CODCAJA, N_RECIBO, 
                                            TDESCUENTO, TIPODCTO, VLRDESCUENTO, DCTO)
                           SELECT @NVOCONSEC2, 1, @CPRECTRAS, AREAFUNCIONAL, VALORUNITARIO, 
                                  CANTIDAD,    VALORTOTAL,  IDSERVICIO, @CAJAREP, N_RECIBO, 
                                  TDESCUENTO,  TIPODCTO,    VLRDESCUENTO, DCTO
                           FROM FCJD
                           WHERE  CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA
                           
                           SELECT  @VALOR = SUM(VALOR)
                           FROM    PCJ
                           WHERE   CNSFACJ = @CNSFACJ
                           AND     CODCAJA = @CODCAJA
                           
                           SELECT @CNSPCJ = NULL
                           EXEC SPK_GENCONSECUTIVO @COMPANIA, @CAJAREP, '@PCJ', @CNSPCJ OUTPUT  
                              SELECT @CNSPCJ = REPLACE(SPACE(8 - LEN(@CNSPCJ))+LTRIM(RTRIM(@CNSPCJ)),SPACE(1),0)
                              
                              INSERT INTO PCJ(CNSPCJ, CNSFACJ, TIPOPAGO, VALOR, BANCO, 
                                              NUMERODOCUMENTO,
                                              NUMEROAUTORIZA, FECHA, CNSACJ, IDTERCERO, CODCAJA,
                                              IMPRESO, CODCAJADEP, CNSFACJDEP, SUCURSAL, CTA_BCO, 
                                              CNSDOC)
                           SELECT @CNSPCJ, @NVOCONSEC2, @DATOEFE, @VALOR, NULL, NULL, NULL, NULL,
                                  @CNSACJ , NULL, @CAJAREP, 0, NULL, NULL, NULL, NULL, NULL  
								  
						   UPDATE CAJR 
						   SET VALOR=VALOR+ISNULL ((SELECT SUM (ISNULL ( VALOR,0)) FROM PCJ WHERE CNSFACJ=@CNSFACJ AND CODCAJA=@CAJAREP) ,0)
                           WHERE   FORMAPAGO=DBO.FNK_VALORVARIABLE('IDCJFPAEFECTIVO') AND CODCAJA=@CAJAREP

						   UPDATE FCJ SET IDTERCERO = DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO') WHERE CNSFACJ=@NVOCONSEC2 AND CODCAJA=@CAJAREP
                           ---AQUI SE CIERRA EL RECIBO DE CAJA DE INGRESO GENERADO POR EL TRASLADO
						   UPDATE FCJ SET CERRADA = 1 WHERE CNSFACJ = @NVOCONSEC2 AND CODCAJA = @CAJAREP
                        END
                        /****************************************************/
                     END  
                  END
               END  
            END   
         END   
         PRINT 'CIERRO EL RECIBO DE CAJA'
         UPDATE FCJ SET CERRADA = 1 WHERE CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA
         -- AQUI DEBE IR EL MOVIMIENTO DE SALDOS DE BANCOS
         /*
          SE COMENTARIZA POR JJIMENEZ
          NO ES NECESARIO YA QUE EL @N_RECIBO SIEMPRE ESTA EN BLANCO
          EL SALDO SE ACTUALIZA CUANDO SE APLICA EL MOVIMIENTO EN EL BANCO
         */
         --IF @TIPOEGRESO<>@DATO2 AND @TIPOEGRESO<>@DATO4 --AND @IDCATEGORIA<>DBO.FNK_VALORVARIABLE('TERCATBANCO')
         --BEGIN
         --   BEGIN TRAN
         --   CREATE TABLE #BCTDD(BANCO    VARCHAR(3)  COLLATE DATABASE_DEFAULT, 
         --                       SUCURSAL VARCHAR(2)  COLLATE DATABASE_DEFAULT, 
         --                       CTA_BCO  VARCHAR(40) COLLATE DATABASE_DEFAULT,
         --                       VALOR    DECIMAL(14,2))
         --   INSERT INTO #BCTDD(BANCO, SUCURSAL, CTA_BCO, VALOR)
         --   SELECT BANCO, SUCURSAL, CTA_BCO, SUM(VALOR)
         --   FROM   BCTDD
         --   WHERE  BCTDD.N_RECIBO  = @N_RECIBO
         --   GROUP BY BANCO, SUCURSAL, CTA_BCO   
            
         --   UPDATE BCT 
         --   SET    BCT.SALDO = BCT.SALDO - #BCTDD.VALOR 
         --   FROM   #BCTDD
         --   WHERE  BCT.BANCO       = #BCTDD.BANCO 
         --   AND    BCT.SUCURSAL    = #BCTDD.SUCURSAL 
         --   AND    BCT.CTA_BCO     = #BCTDD.CTA_BCO 
         --   COMMIT 
         --END
      END
      ELSE
      BEGIN
         UPDATE FCJ SET CERRADA = 1, VALORTOTAL = 0 
         WHERE CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA
         DELETE FROM PCJ WHERE CNSFACJ = @CNSFACJ AND CODCAJA = @CODCAJA   
      END
      IF @TIPOEGRESO = @DATO2 -- CXP
      BEGIN 
	      IF DBO.FNK_VALORVARIABLE('PRESUP_CXP_ACTIVADO')='SI'
	      BEGIN
		      PRINT 'INGRESANDO LOS PAGOS A PTPAG'
		      IF DBO.FNK_VALORVARIABLE('PPTO_CONSICXP')='NO'
		      BEGIN
			      PRINT 'VERIFICAMOS QUE SI ES DE SALDO INICIAL'
			      SELECT @SI=CASE WHEN CNSFCXP LIKE '%'+DBO.FNK_VALORVARIABLE('PPTO_CONSICXP')+'%' THEN 1 ELSE 0 END FROM FCXP WHERE CNSFCXP=@CNSCXP
		      END
		      ELSE
		      BEGIN
			      SELECT @SI=0
		      END
		      IF COALESCE(@SI,0)=0
		      BEGIN
               IF (SELECT CASE WHEN  @CNSCXP NOT LIKE '%AN%' THEN 1 ELSE 0 END)=0
               BEGIN
                  PRINT 'ME VOY A PRESUPUESTO'
                  EXEC SPK_ENVIA_PPTO_EGRESOCAJA @CODCAJA,@CNSFACJ,@COMPANIA,@SEDE,@USUARIO,@SYS_COMPUTERNAME
               END
            END
         END         
      END
   END
END

