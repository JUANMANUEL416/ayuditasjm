IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'SPK_FACTURACE_PERU_COPA' AND XTYPE='P')
BEGIN
   DROP PROCEDURE SPK_FACTURACE_PERU_COPA
END
GO
CREATE  PROCEDURE DBO.SPK_FACTURACE_PERU_COPA
@NOAUT				VARCHAR(16),
@NIT				   VARCHAR(20),
@COMPANIA			VARCHAR(2),
@IDSEDE				VARCHAR(5),
@USUARIO			   VARCHAR(12),
@PRE1				   VARCHAR(6),
@PRE2				   VARCHAR(6),
@PRE3				   VARCHAR(6),
@PRE4				   VARCHAR(6),
@PRE5				   VARCHAR(6),
@PROC				   VARCHAR(2),
@IDTERCEROCA1		VARCHAR(20),
@CETIPOHOSP			VARCHAR(6) = FALSE,  -- PARAM. Que Especifica el tipo de manejo de Planes - Contratos 
@IDPLANPAR			VARCHAR(6) = NULL,    -- EL PLAN EN CEHOSP
@FECHAFAC			DATETIME   = NULL,
@TIPOFAC			   VARCHAR(10)='Boleta',
@IDTERCERO_RUC		VARCHAR(20)= NULL
WITH ENCRYPTION
AS 
DECLARE @IDAUT       VARCHAR(13), @PRE VARCHAR(20), @CONSECFTR INT, @CNSRESOL VARCHAR(50)
DECLARE @NVOCONSEC   VARCHAR(20)
DECLARE @CNSFTR      VARCHAR(20)
DECLARE @CERRADA     SMALLINT
DECLARE @FACTURADA   SMALLINT
DECLARE @FACTURABLE  SMALLINT
DECLARE @TIPOADM     VARCHAR(2)
DECLARE @IDTERCERO   VARCHAR(20)
DECLARE @IDPLAN      VARCHAR(6)
DECLARE @MONEDA      VARCHAR(20)
DECLARE @DATO1       VARCHAR(80)
DECLARE @IDTERCERO1  VARCHAR(20)  
DECLARE @OK          INT
DECLARE @CA          VARCHAR(15)
DECLARE @IDAFILIADO  VARCHAR(20)
DECLARE @IDAFILIADOTER VARCHAR(20)
DECLARE @DV          SMALLINT
DECLARE @TV          VARCHAR(10)
DECLARE @CCOSTO      VARCHAR(20)
DECLARE @IDAREA      VARCHAR(20)
DECLARE @EC          SMALLINT
DECLARE @IDTERCEROF  VARCHAR(20)
DECLARE @IDTERPART   VARCHAR(20)
DECLARE @DESCUENTO   DECIMAL(14,2)
DECLARE @TIPODTO     VARCHAR(1)
DECLARE @VRTOTAL     DECIMAL(14,2)
DECLARE @VRSERV      DECIMAL(14,2)
DECLARE @VRCOPA      DECIMAL(14,2)
DECLARE @VRPACO      DECIMAL(14,2)
DECLARE @VRDTO       DECIMAL(14,2)
DECLARE @VRABONO     DECIMAL(14,2)
DECLARE @VEZ         INT
DECLARE @DATO3             VARCHAR(20)
DECLARE @TTEC              VARCHAR(10)
DECLARE @TIPOFACTURACION   VARCHAR(1)
DECLARE @NODESCUENTACOPAGO SMALLINT
DECLARE @CUENTACXC         VARCHAR(16)
DECLARE @DATOCCOSTO        VARCHAR(80)
DECLARE @SOAT              SMALLINT
DECLARE @CNSHACTRAN        VARCHAR(20)
DECLARE @IDTERCEROCA       VARCHAR(20)
DECLARE @SANDER            DECIMAL (14,2) 
DECLARE @SYS_COMPUTERNAME  VARCHAR(254)
DECLARE @CODUNG VARCHAR(2)
DECLARE @CODPRG VARCHAR(2)
DECLARE @CUENTACXC_RAD     VARCHAR(16)
DECLARE @LIBERADA          SMALLINT
DECLARE @VENCIDA           SMALLINT
DECLARE @IDAFIAUX          VARCHAR(20)
DECLARE @IDCATEGORIA       VARCHAR(10)--CAT
DECLARE @IDFORMATOFTR      VARCHAR(20)
DECLARE @MIVA              SMALLINT
DECLARE @PIVA              DECIMAL(14,2)
DECLARE @VIVA              DECIMAL(14,2)
DECLARE @N_FACTURAORI      VARCHAR(20)
DECLARE @VLRAUTDTOTAL      DECIMAL(14,2)
DECLARE @VARIOS            INT
DECLARE @BASE_IVA_SER      VARCHAR(20)
DECLARE @LIBERTER		   VARCHAR(20)
DECLARE @ESOPTICA		   VARCHAR(2)
DECLARE @OBSERVACION	   VARCHAR(2040)
DECLARE @MONTO             DECIMAL(14,2)
DECLARE @ESPARTPERU   BIT
DECLARE @PREFIJOFAC VARCHAR(20)
DECLARE @IDIMPUESTO	      VARCHAR(10)
DECLARE @IDCLASE		  VARCHAR(10)
DECLARE @CUENTA_FIMPDV    VARCHAR(20)
DECLARE @N_CUOTA		  SMALLINT
DECLARE @REFERENCIA	      VARCHAR(20)
DECLARE @FECHAPRES		  DATETIME
DECLARE @VR_BRUTO		  DECIMAL(14,2)
DECLARE @VENTAPRT     BIT=0
BEGIN

	SELECT  @SYS_COMPUTERNAME = HOST_NAME(),@LIBERADA=0
	-- SACAR DE DONDE SE TOMA EL CCOSTO
	IF @EC IS NULL
			SELECT @EC = 0
         
	SELECT @DATOCCOSTO = DATO FROM USVGS WHERE IDVARIABLE = 'CCOSTOENPRESTACION'
	SELECT @MONEDA = DATO FROM USVGS WHERE IDVARIABLE = 'IDMONEDABASE'
	SELECT @BASE_IVA_SER = DATO FROM USVGS WHERE IDVARIABLE='BASE_IVA_SERVICIOS'
	SELECT @LIBERTER=DATO FROM USVGS WHERE IDVARIABLE='LIBERTER'
	SELECT @ESOPTICA=DATO FROM USVGS WHERE IDVARIABLE='IPS_MAN_OPTICA'
	PRINT 'INGRESE '+@PROC+' @IDSEDE'+@IDSEDE

	IF @PROC = 'CE'
	BEGIN
		SELECT @IDAUT  = IDAUT,@CODUNG=CODUNG, @CODPRG =CODPRG FROM AUT WHERE NOAUT = @NOAUT
      
		IF @CETIPOHOSP = 'CEHOSP'
		BEGIN
			SELECT @IDAFILIADO = AUT.IDAFILIADO
			FROM AUT INNER JOIN AFI ON AUT.IDAFILIADO=AFI.IDAFILIADO 
         WHERE NOAUT = @NOAUT                
            
			SELECT DISTINCT @IDTERCERO = IDAFILIADO
			FROM   AUTD, AUT
			WHERE  AUTD.IDAUT  = AUT.IDAUT
			AND    AUT.NOAUT   = @NOAUT
         
			SELECT @IDPLAN    = @IDPLANPAR
			SELECT @FACTURADA = 0
		END
		ELSE
		BEGIN
			SELECT  @FACTURADA = FACTURADA,  @FACTURABLE = FACTURABLE,
					@IDTERCERO = IDAFILIADO,  @IDPLAN = IDPLAN,
					@IDAFILIADO = IDAFILIADO, @DESCUENTO = DESCUENTO, @TIPODTO = TIPODTO, 
					@CCOSTO=CCOSTO, 
					@IDTERCERO1 = AUT.IDCONTRATANTE, @CA = AUT.IMPUTABLE_A, @SOAT = SOAT,
					@CNSHACTRAN = CNSHACTRAN
			FROM AUT WHERE NOAUT = @NOAUT        
		END
	END   
	ELSE
	BEGIN
		PRINT 'CITAS'
		PRINT '@NOAUT ='+@NOAUT
      PRINT '@LIBERTER'+COALESCE(@LIBERTER,'')

		IF COALESCE(@LIBERTER,'')<>'SI'
		BEGIN 
				IF EXISTS(SELECT * FROM FTR WHERE NOREFERENCIA=COALESCE(@NOAUT,'') AND PROCEDENCIA='CI' AND ESTADO='L' AND COALESCE(CP_CONVENIO,'')='Boleta')
				BEGIN
					PRINT 'SI TENGO LIBREACION'
					SELECT @LIBERADA=1,@NVOCONSEC=N_FACTURA , @CNSFTR=CNSFCT FROM FTR WHERE NOREFERENCIA=@NOAUT AND PROCEDENCIA='CI' AND ESTADO='L'  AND COALESCE(CP_CONVENIO,'')='Boleta'
				END
				SELECT  @FACTURADA = CASE WHEN COALESCE(NFACTURA,'')='' THEN 0 ELSE 1 END,  @FACTURABLE = FACTURABLE,
						@IDTERCERO = IDTERCEROCA,  @IDPLAN = CIT.IDPLAN,
						@IDAFILIADO = CIT.IDAFILIADO, @DESCUENTO = DESCUENTO, @TIPODTO = TIPODTO, 
						@CCOSTO=CCOSTO, @IDTERCERO1 =IDTERCEROCA, @SOAT = SOAT,
						@CNSHACTRAN = CNSHACTRAN 
				FROM    CIT INNER JOIN AFI ON AFI.IDAFILIADO=CIT.IDAFILIADO WHERE CONSECUTIVO = @NOAUT 
				print 'terceroca' + @IDTERCERO 
				PRINT   'facturada='+STR(@FACTURADA)+' - '+@NOAUT
		END 
		ELSE 
		BEGIN
				IF EXISTS(SELECT * FROM FTR WHERE IDTERCERO=@IDAFILIADO AND ESTADO='L'  AND COALESCE(CP_CONVENIO,'')='Boleta')
				BEGIN
	   				PRINT 'SI TENGO LIBREACION POR TERCERO'
				
					SELECT TOP 1  @LIBERADA=1,@NVOCONSEC=N_FACTURA , @CNSFTR=CNSFCT FROM FTR WHERE IDTERCERO=@IDAFILIADO 
					AND ESTADO='L'  AND COALESCE(CP_CONVENIO,'')='Boleta'
				END 
				IF @PROC='CI'
				BEGIN
				SELECT  @FACTURADA =CASE WHEN COALESCE(NFACTURA,'')='' THEN 0 ELSE 1 END,  @FACTURABLE = FACTURABLE,
						@IDTERCERO = CIT.IDAFILIADO,  @IDPLAN = CIT.IDPLAN,
						@IDAFILIADO = CIT.IDAFILIADO, @DESCUENTO = DESCUENTO, @TIPODTO = TIPODTO, 
						@CCOSTO=CCOSTO, @IDTERCERO1 =CIT.IDAFILIADO, @SOAT = SOAT,
						@CNSHACTRAN = CNSHACTRAN 
				FROM    CIT INNER JOIN AFI ON AFI.IDAFILIADO=CIT.IDAFILIADO WHERE CONSECUTIVO = @NOAUT 
					print 'terceroca' + @IDTERCERO 
					PRINT   'facturada='+STR(@FACTURADA)+' - '+@NOAUT
				END 
		END 
	END

	SELECT @DATO3 = LEFT(DATO,20) FROM USVGS WHERE IDVARIABLE = 'IDFDEPFACTURACION'     
	IF @FACTURADA = 1
	BEGIN
		PRINT 'ME DEVUELVO POR QUE YA ESTA FACTURADA'
		RETURN 
	END 
	PRINT 'No esta Facturada'
	IF @FACTURABLE = 0
	BEGIN
		PRINT 'ME DEVUELVO NO ES FACTURABLE'
		RETURN
	END

  -- IF @PROC = 'CI'  --JEDM 20240209   COLOCO ESTE IF PQ ESTABA HACIEN UPDATE A CIT A SI NO VINIERA CON PROCEDENCIA CIT
   
	CREATE TABLE #FTRD1(CNSFTR VARCHAR(40), N_CUOTA	int IDENTITY, FECHA datetime,
				DB_CR varchar(2), AREAPRESTACION varchar(20), UBICACION varchar(16),
				VR_TOTAL float, IMPUTACION varchar(16), CCOSTO varchar (20),
				PREFIJO varchar(6), ANEXO varchar(1024), REFERENCIA varchar(40), 
				IDCIRUGIA varchar(20), CANTIDAD smallint, VALOR decimal(14,2),
				VLR_SERVICI decimal(14,2), VLR_COPAGOS decimal(14,2),
				VLR_PAGCOMP decimal(14,2), IDPROVEEDOR varchar(20),
				NOADMISION varchar(16), NOPRESTACION	varchar(16), NOITEM int,	
				AREAFUNCONT varchar(20), N_FACTURA varchar(16),
				SUBCCOSTO varchar(4), PCOSTO	decimal(14,2), FECHAPREST datetime, IDPLAN VARCHAR(6),
				IDIMPUESTO VARCHAR(10),
				IDCLASE    VARCHAR(10),
				ITEM       SMALLINT,
				VLRIMPUESTO DECIMAL(14,2),
				PIVA        DECIMAL(14,2),
				VIVA        DECIMAL(14,2),
				CUENTA_FIMPDV VARCHAR(20)
				) --FTRD
   
	IF @PROC = 'CE'
	BEGIN           
		IF @CETIPOHOSP = 'CEHOSP' 
		BEGIN
			DECLARE CUR_FTR CURSOR FOR
				SELECT DISTINCT AUT.IDAFILIADO, AUT.IDPLAN,AUTD.NfACTURA
				FROM AUT INNER JOIN AUTD ON AUTD.IDAUT       = AUT.IDAUT 
				WHERE AUT.NOAUT = @NOAUT 
            AND COALESCE(AUTD.NFACTURA,'')=''
		END  
		ELSE 
		BEGIN
			IF @IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART') OR
			@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART2') OR
			@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART3') OR
			@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART4') OR
			@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART5')
			BEGIN
				DECLARE CUR_FTR CURSOR FOR
				SELECT DISTINCT  AUT.IDAFILIADO,AUT.IDPLAN,AUTD.NFACTURA FROM AUTD INNER JOIN AUT ON AUT.IDAUT=AUTD.IDAUT WHERE AUT.NOAUT = @NOAUT
			END
			ELSE
			BEGIN
				print 'ingrese por el tercero'
				DECLARE CUR_FTR CURSOR FOR
				SELECT DISTINCT AUT.IDAFILIADO, AUT.IDPLAN,AUTD.NfACTURA
				FROM AUT INNER JOIN AUTD ON AUTD.IDAUT       = AUT.IDAUT 
				WHERE AUT.NOAUT = @NOAUT 
            AND COALESCE(AUTD.NFACTURA,'')=''
		   END
	   END
   END
	ELSE
		IF @PROC = 'CI'
		BEGIN
			DECLARE CUR_FTR CURSOR FOR
			SELECT IDAFILIADO,CIT.IDPLAN,NFACTURA
			FROM   CIT 
			WHERE  CIT.CONSECUTIVO = @NOAUT AND COALESCE(NFACTURA,'')=''
		END
   
	OPEN CUR_FTR
   
	FETCH NEXT FROM CUR_FTR
	INTO @IDTERCEROCA,@IDPLAN,@N_FACTURAORI
	PRINT 'INICIO EL CURSOR @IDTERCEROCA='+@IDTERCEROCA
	WHILE @@FETCH_STATUS = 0  
	BEGIN  

		PRINT 'INGRESE EL CURSOR PARA FACTURAR.................'
		PRINT '@IDTERCEROCA='+COALESCE(@IDTERCEROCA,'NO TENGO TERCERO')
		PRINT '@IDPLAN='+@IDPLAN

		TRUNCATE TABLE  #FTRD1 

		PRINT @NOAUT + ' ' +CASE WHEN @IDTERCEROCA IS NULL THEN '?' ELSE @IDTERCEROCA END
		PRINT @PROC
		PRINT @NODESCUENTACOPAGO
		PRINT @DATOCCOSTO


		IF @PROC = 'CE'
		BEGIN   
			PRINT 'ES DE CE'
			IF @CETIPOHOSP = 'CEHOSP' 
			BEGIN
				PRINT '@CETIPOHOSP ='+@CETIPOHOSP
				SELECT @VLRAUTDTOTAL=SUM(AUTD.VALORCOPAGO)
				FROM   AUT INNER JOIN AUTD ON AUTD.IDAUT = AUT.IDAUT 
							INNER JOIN SER ON SER.IDSERVICIO = AUTD.IDSERVICIO 
							LEFT JOIN  TER ON TER.IDTERCERO = AUTD.IDTERCEROCA
				WHERE  AUT.NOAUT = @NOAUT
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE1,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE2,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE3,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE4,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE5,'')                  
					AND COALESCE(NFACTURA,'')=''

				INSERT INTO #FTRD1(CNSFTR, FECHA, DB_CR, AREAPRESTACION, UBICACION, VR_TOTAL,
						IMPUTACION, CCOSTO, PREFIJO, ANEXO, REFERENCIA, IDCIRUGIA, CANTIDAD,
						VALOR, VLR_SERVICI, VLR_COPAGOS, VLR_PAGCOMP, IDPROVEEDOR, NOADMISION,
						NOPRESTACION, NOITEM, AREAFUNCONT, N_FACTURA, SUBCCOSTO, PCOSTO, FECHAPREST, IDPLAN,IDIMPUESTO, IDCLASE,ITEM , VLRIMPUESTO, PIVA, VIVA,CUENTA_FIMPDV)
				SELECT @CNSFTR, GETDATE(), 'DB', AUT.IDAREA, NULL, 
						AUTD.VALORCOPAGO, 
						NULL, CASE WHEN @DATOCCOSTO = 'SER:CCOSTO' THEN AUTD.CCOSTO ELSE AUT.CCOSTO END, SER.PREFIJO,
						CASE WHEN dbo.FNK_VALORVARIABLE('MANEJA_GARANTIA_SER') = 'SI' THEN 
							CASE WHEN dbo.FNK_VALORVARIABLE('CLASE_IPS') = 'OPTICA' THEN  CASE WHEN COALESCE(SER.GARANTIA, 0) = 0 THEN COALESCE(SER.DESCSERVICIO, '')+' '+'Producto sin Garantia'
																																ELSE COALESCE(SER.DESCSERVICIO, '')+' '+COALESCE(SER.COMENTARIOS, '')
																																END
																				
																						ELSE SER.DESCSERVICIO
																						END
																					ELSE SER.DESCSERVICIO
																					END, 
						AUTD.IDSERVICIO, NULL, AUTD.CANTIDAD,AUTD.VALORCOPAGO, 
						AUTD.VALORCOPAGO,0, 
						0, AUT.IDPROVEEDOR, @NOAUT,AUTD.IDAUT, AUTD.NO_ITEM, NULL, 
						@NVOCONSEC, AUT.SUBCCOSTO, AUTD.VALORTOTALCOSTO,AUT.FECHA, AUT.IDPLAN,
						CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  SER.IDIMPUESTO ELSE NULL END,
						CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  SER.IDCLASE ELSE NULL END,
						CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  (SELECT ITEM FROM  DBO.FNK_VALOR_IMPUESTO(SER.IDIMPUESTO,SER.IDCLASE,GETDATE(),AUTD.VALORCOPAGO)) ELSE 0 END,
						CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  AUTD.VALORCOPAGO  ELSE 0 END ,
						CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  (SELECT VALOR FROM  DBO.FNK_VALOR_IMPUESTO(SER.IDIMPUESTO,SER.IDCLASE,GETDATE(), AUTD.VALORCOPAGO)) ELSE 0 END,
						CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  (SELECT ROUND(AUTD.VALORCOPAGO*(VALOR/100),2) 
																	FROM  DBO.FNK_VALOR_IMPUESTO(SER.IDIMPUESTO,SER.IDCLASE,GETDATE(),(AUTD.CANTIDAD * AUTD.VALOR))) ELSE 0 END,
						CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  (SELECT CUENTA FROM  DBO.FNK_VALOR_IMPUESTO(SER.IDIMPUESTO,SER.IDCLASE,GETDATE(),AUTD.VALORCOPAGO)) ELSE NULL END
				FROM   AUT INNER JOIN AUTD ON AUTD.IDAUT = AUT.IDAUT 
							INNER JOIN SER ON SER.IDSERVICIO = AUTD.IDSERVICIO 
							LEFT JOIN  TER ON TER.IDTERCERO = AUTD.IDTERCEROCA
				WHERE  AUT.NOAUT = @NOAUT
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE1,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE2,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE3,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE4,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE5,'')                  
					AND (AUTD.FACTURADA=0 OR AUTD.FACTURADA IS NULL OR AUTD.FACTURADA=2)
					--AND (TER.IDTERCERO = @IDTERCEROCA OR (TER.IDTERCERO IS NULL AND @IDTERCEROF=@IDTERCEROCA)) 
					AND AUTD.IDTERCEROCA=@IDTERCEROCA
					AND AUTD.IDPLAN = @IDPLAN
			END
			ELSE
			BEGIN
				PRINT '@EC Y NO ES CEHOSP'+STR(@EC)
				IF @IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART') OR 
					@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART2') OR 
					@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART3') OR 
					@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART4') OR 
					@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART5') OR 
					@EC = 1
				BEGIN
					PRINT 'PARTICULAR'
               SELECT @VENTAPRT=1
					SELECT  @DESCUENTO = 0, -- STORRES SE QUITA SUMA GENERAL Y SOLO SE COLOCA EN EL THEN
							@TIPODTO=CASE WHEN @ESOPTICA = 'SI' OR  COALESCE(@VARIOS,0)>1 THEN AUTD.TIPODTO  ELSE @TIPODTO END
					FROM   AUT INNER JOIN AUTD ON AUTD.IDAUT     = AUT.IDAUT 
								INNER JOIN SER  ON SER.IDSERVICIO = AUTD.IDSERVICIO 
								LEFT  JOIN TER  ON TER.IDTERCERO  = AUTD.IDTERCEROCA
					WHERE  AUT.NOAUT = @NOAUT
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE1,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE2,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE3,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE4,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE5,'')                 
						AND (AUTD.FACTURADA=0 OR AUTD.FACTURADA IS NULL OR AUTD.FACTURADA=2)
						AND AUTD.IDTERCEROCA=@IDTERCEROCA
					PRINT '@IDAFILIADO ANTES DEL INSERT=  :::::::::'+ @IDAFILIADO 

					print 'OMAR'

					INSERT INTO #FTRD1(CNSFTR, FECHA, DB_CR, AREAPRESTACION, UBICACION, VR_TOTAL,
							IMPUTACION, CCOSTO, PREFIJO, ANEXO, REFERENCIA, IDCIRUGIA, CANTIDAD,
							VALOR, VLR_SERVICI, VLR_COPAGOS, VLR_PAGCOMP, IDPROVEEDOR, NOADMISION,
							NOPRESTACION, NOITEM, AREAFUNCONT, N_FACTURA, SUBCCOSTO, PCOSTO, FECHAPREST, IDPLAN,IDIMPUESTO, IDCLASE,ITEM , VLRIMPUESTO, PIVA, VIVA,CUENTA_FIMPDV)
					SELECT @CNSFTR, GETDATE(), 'DB', AUT.IDAREA, NULL, 
							AUTD.VALORCOPAGO, 
							NULL, CASE WHEN @DATOCCOSTO = 'SER:CCOSTO' THEN AUTD.CCOSTO ELSE AUT.CCOSTO END, SER.PREFIJO,
							CASE WHEN dbo.FNK_VALORVARIABLE('MANEJA_GARANTIA_SER') = 'SI' THEN
								CASE WHEN dbo.FNK_VALORVARIABLE('CLASE_IPS') = 'OPTICA' THEN  CASE WHEN COALESCE(SER.GARANTIA, 0) = 0 THEN COALESCE(SER.DESCSERVICIO, '')+' '+'Producto sin Garantia'
																																ELSE COALESCE(SER.DESCSERVICIO, '')+' '+COALESCE(SER.COMENTARIOS, '')
																																END
																						ELSE SER.DESCSERVICIO
																						END
																					ELSE SER.DESCSERVICIO
																					END,
							AUTD.IDSERVICIO, NULL, AUTD.CANTIDAD, AUTD.VALORCOPAGO, 
							--(AUTD.CANTIDAD * CASE WHEN @ESOPTICA='SI' THEN AUTD.VALOR-CASE WHEN COALESCE(DESCUENTO,0)>0 THEN COALESCE(DESCUENTO,0)/AUTD.CANTIDAD ELSE 0 END ELSE AUTD.VALOR END), 
							AUTD.VALORCOPAGO,  
							0, --AUTD.VALORCOPAGO,
							0, AUT.IDPROVEEDOR, @NOAUT, AUTD.IDAUT, AUTD.NO_ITEM, NULL, 
							@NVOCONSEC, AUT.SUBCCOSTO, AUTD.VALORTOTALCOSTO, AUT.FECHA, AUT.IDPLAN,
							CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  SER.IDIMPUESTO ELSE NULL END,
							CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  SER.IDCLASE ELSE NULL END,
							CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  (SELECT ITEM FROM  DBO.FNK_VALOR_IMPUESTO(SER.IDIMPUESTO,SER.IDCLASE,GETDATE(),AUTD.VALORCOPAGO)) ELSE NULL END,
							CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  AUTD.VALORCOPAGO  ELSE NULL END ,
							CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  (SELECT VALOR FROM  DBO.FNK_VALOR_IMPUESTO(SER.IDIMPUESTO,SER.IDCLASE,GETDATE(),AUTD.VALORCOPAGO)) ELSE NULL END,
							CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  (SELECT ROUND(AUTD.VALORCOPAGO*(VALOR/100),2) FROM  DBO.FNK_VALOR_IMPUESTO(SER.IDIMPUESTO,SER.IDCLASE,GETDATE(),AUTD.VALORCOPAGO)) ELSE NULL END,
							CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  (SELECT CUENTA FROM  DBO.FNK_VALOR_IMPUESTO(SER.IDIMPUESTO,SER.IDCLASE,GETDATE(),AUTD.VALORCOPAGO)) ELSE NULL END
					FROM   AUT INNER JOIN AUTD ON AUTD.IDAUT     = AUT.IDAUT 
								INNER JOIN SER  ON SER.IDSERVICIO = AUTD.IDSERVICIO 
								LEFT  JOIN TER  ON TER.IDTERCERO  = AUTD.IDTERCEROCA
					WHERE  AUT.NOAUT = @NOAUT
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE1,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE2,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE3,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE4,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE5,'')                 
						AND AUTD.IDPLAN=@IDPLAN

				END	
				ELSE
				BEGIN
					PRINT 'NO PART'
					SELECT @VLRAUTDTOTAL=SUM(AUTD.VALORCOPAGO),@DESCUENTO = 0, -- STORRES SE QUITA SUMA GENERAL Y SOLO SE COLOCA EN EL THEN
						@TIPODTO=CASE WHEN COALESCE(@VARIOS,0)>1 THEN AUTD.TIPODTO  ELSE @TIPODTO END
					FROM   AUT INNER JOIN AUTD ON AUTD.IDAUT     = AUT.IDAUT 
								INNER JOIN SER  ON SER.IDSERVICIO = AUTD.IDSERVICIO 
								LEFT JOIN TER  ON TER.IDTERCERO  = AUTD.IDTERCEROCA
					WHERE  AUT.NOAUT = @NOAUT
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE1,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE2,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE3,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE4,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE5,'')                
						AND AUTD.IDPLAN=@IDPLAN
						GROUP BY AUTD.TIPODTO

					INSERT INTO #FTRD1(CNSFTR, FECHA, DB_CR, AREAPRESTACION, UBICACION, VR_TOTAL,
							IMPUTACION, CCOSTO, PREFIJO, ANEXO, REFERENCIA, IDCIRUGIA, CANTIDAD,
							VALOR, VLR_SERVICI, VLR_COPAGOS, VLR_PAGCOMP, IDPROVEEDOR, NOADMISION,
							NOPRESTACION, NOITEM, AREAFUNCONT, N_FACTURA, SUBCCOSTO, PCOSTO, FECHAPREST, IDPLAN,IDIMPUESTO, IDCLASE,ITEM , VLRIMPUESTO, PIVA, VIVA,CUENTA_FIMPDV)
					SELECT @CNSFTR, GETDATE(), 'DB', AUT.IDAREA, NULL, 
							AUTD.VALORCOPAGO, 
							NULL, CASE WHEN @DATOCCOSTO = 'SER:CCOSTO' THEN AUTD.CCOSTO ELSE AUT.CCOSTO END, SER.PREFIJO,
							CASE WHEN dbo.FNK_VALORVARIABLE('MANEJA_GARANTIA_SER') = 'SI' THEN 
								CASE WHEN dbo.FNK_VALORVARIABLE('CLASE_IPS') = 'OPTICA' THEN  CASE WHEN COALESCE(SER.GARANTIA, 0) = 0 THEN COALESCE(SER.DESCSERVICIO, '')+' '+'Producto sin Garantia'
																																	ELSE COALESCE(SER.DESCSERVICIO, '')+' '+COALESCE(SER.COMENTARIOS, '')
																																	END
																							ELSE SER.DESCSERVICIO
																							END
																					ELSE SER.DESCSERVICIO
																					END,
							AUTD.IDSERVICIO, NULL, AUTD.CANTIDAD,AUTD.VALORCOPAGO, AUTD.VALORCOPAGO, 
							0,0, AUT.IDPROVEEDOR, @NOAUT, AUTD.IDAUT, AUTD.NO_ITEM, NULL, 
							@NVOCONSEC, AUT.SUBCCOSTO, AUTD.VALORTOTALCOSTO,AUT.FECHA, AUT.IDPLAN,
						CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  SER.IDIMPUESTO ELSE NULL END,
						CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  SER.IDCLASE ELSE NULL END,
						CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  (SELECT ITEM FROM  DBO.FNK_VALOR_IMPUESTO(SER.IDIMPUESTO,SER.IDCLASE,GETDATE(),AUTD.VALORCOPAGO)) ELSE NULL END,
						CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  AUTD.VALORCOPAGO  ELSE NULL END ,
						CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  (SELECT VALOR FROM  DBO.FNK_VALOR_IMPUESTO(SER.IDIMPUESTO,SER.IDCLASE,GETDATE(),AUTD.VALORCOPAGO)) ELSE NULL END,
						CASE WHEN COALESCE(SER.IVA,'')='SER' THEN (SELECT ROUND(AUTD.VALORCOPAGO*(VALOR/100),2) FROM  DBO.FNK_VALOR_IMPUESTO(SER.IDIMPUESTO,SER.IDCLASE,GETDATE(),AUTD.VALORCOPAGO)) ELSE NULL END,
						CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  (SELECT CUENTA FROM  DBO.FNK_VALOR_IMPUESTO(SER.IDIMPUESTO,SER.IDCLASE,GETDATE(),AUTD.VALORCOPAGO))  ELSE NULL END
					FROM   AUT INNER JOIN AUTD ON AUTD.IDAUT     = AUT.IDAUT 
								INNER JOIN SER  ON SER.IDSERVICIO = AUTD.IDSERVICIO 
								LEFT JOIN TER  ON TER.IDTERCERO  = AUTD.IDTERCEROCA
					WHERE  AUT.NOAUT = @NOAUT
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE1,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE2,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE3,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE4,'')
						AND COALESCE(SER.PREFIJO,'')       <>COALESCE( @PRE5,'')                
						AND AUTD.IDPLAN=@IDPLAN
				END
			END
		END
		ELSE
		BEGIN
			PRINT 'ES DE CITAS ========================>'
			IF @IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART') OR 
				@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART2') OR 
				@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART3') OR 
				@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART4') OR 
				@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART5') OR 
				@EC = 1
			BEGIN
				PRINT 'PARTICULAR'
				SELECT @VENTAPRT=1
			 END
			 ELSE
			 BEGIN
				   SELECT @VENTAPRT=0
			 END
			INSERT INTO #FTRD1(CNSFTR, FECHA, DB_CR, AREAPRESTACION, UBICACION, VR_TOTAL, IMPUTACION, CCOSTO, PREFIJO, ANEXO, REFERENCIA, IDCIRUGIA, CANTIDAD,
					 VALOR,  --debe ir sin igv
                VLR_SERVICI, --con igv
                VLR_COPAGOS, 
                VLR_PAGCOMP, 
                IDPROVEEDOR, NOADMISION, NOPRESTACION, NOITEM, AREAFUNCONT, N_FACTURA, SUBCCOSTO, PCOSTO, FECHAPREST, 
                IDPLAN,IDIMPUESTO, IDCLASE,ITEM , 
                VLRIMPUESTO, 
                PIVA, 
                VIVA,
                CUENTA_FIMPDV)
			SELECT @CNSFTR, GETDATE(), 'DB', CIT.IDAREA, NULL, CASE COALESCE(@VENTAPRT,0) WHEN 1 THEN VALORTOTAL ELSE VALORCOPAGO END, 
				    NULL, CIT.CCOSTO, SER.PREFIJO, SER.DESCSERVICIO, CIT.IDSERVICIO, NULL, COALESCE(CIT.CANTIDADC,1) CANTIDAD,
                CASE COALESCE(@VENTAPRT,0) 
                     WHEN 1 THEN CIT.VALORTOTAL/1.18 
                     ELSE VALORCOPAGO/1.18 
                END,
                CASE COALESCE(@VENTAPRT,0) WHEN 1 THEN VALORTOTAL ELSE VALORCOPAGO END,
                0,
				    0, 
                CIT.IDMEDICO, @NOAUT, @NOAUT, 1, NULL, @NVOCONSEC, CIT.SUBCCOSTO, CIT.VALORTOTALCOS, CIT.FECHA, CIT.IDPLAN,
					 CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  SER.IDIMPUESTO ELSE NULL END,
					 CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  SER.IDCLASE ELSE NULL END,
					 CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  (SELECT ITEM FROM  DBO.FNK_VALOR_IMPUESTO(SER.IDIMPUESTO,SER.IDCLASE,GETDATE(),CASE COALESCE(@VENTAPRT,0) WHEN 1 THEN VALORTOTAL ELSE VALORCOPAGO END)) ELSE NULL END,
					 
                NULL, --CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  CIT.VALORCOPAGO ELSE NULL END ,
                CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  (SELECT VALOR FROM  DBO.FNK_VALOR_IMPUESTO(SER.IDIMPUESTO,SER.IDCLASE,GETDATE(),CASE COALESCE(@VENTAPRT,0) WHEN 1 THEN VALORTOTAL ELSE VALORCOPAGO END)) ELSE NULL END,
					 CASE WHEN COALESCE(SER.IVA,'')='SER' THEN CASE COALESCE(@VENTAPRT,0) WHEN 1 THEN VALORTOTAL - (CIT.VALORTOTAL/1.18)
                                                                                      ELSE VALORCOPAGO - (VALORCOPAGO/1.18 )
                                                          END
                                                     ELSE NULL 
                END,
					 CASE WHEN COALESCE(SER.IVA,'')='SER' THEN  (SELECT CUENTA FROM  DBO.FNK_VALOR_IMPUESTO(SER.IDIMPUESTO,SER.IDCLASE,GETDATE(),CASE COALESCE(@VENTAPRT,0) WHEN 1 THEN VALORTOTAL ELSE VALORCOPAGO END))  ELSE NULL END            
			FROM   CIT INNER JOIN SER ON SER.IDSERVICIO = CIT.IDSERVICIO 
						LEFT JOIN TER ON TER.IDTERCERO = CIT.IDTERCEROCA
			WHERE  CIT.CONSECUTIVO   = @NOAUT
			AND    SER.PREFIJO       <> @PRE1
			AND    SER.PREFIJO       <> @PRE2
			AND    SER.PREFIJO       <> @PRE3
			AND    SER.PREFIJO       <> @PRE4
			AND    SER.PREFIJO       <> @PRE5                 

		END
      
		SELECT @OK = COUNT(*) FROM #FTRD1

		IF ISNULL(@DV,0) <= 0
			SET @DV = 30
		
		SELECT @CUENTACXC = CUENTA, @CUENTACXC_RAD=CUENTARAD,@TTEC=TIPO FROM TTEC
		WHERE TIPO = DBO.FNK_VALORVARIABLE('IDTERCONTABLEPART') 
      SELECT @IDTERPART = DATO FROM USVGS WHERE IDVARIABLE = 'IDCJTERCEROEXTERNO'
               
      SELECT @TV = 'Contado' 
      SELECT @EC = 1
      SELECT @IDTERCEROF = @IDAFILIADO
      SELECT @IDCATEGORIA = DBO.FNK_VALORVARIABLE('TERCATAFILIADO')
      PRINT 'Inserta Tercero con SPK_INSERT_TERDEAFI '+@IDAFILIADO+','+@IDCATEGORIA
      EXEC SPK_INSERT_TERDEAFI @IDAFILIADO, @IDCATEGORIA,@PROC,@NOAUT
         
		SELECT @ESPARTPERU = 1
		SELECT @IDTERCEROF=IDTERCERO FROM TER WHERE ESTADO='Activo' AND NIT=( 
		SELECT DOCIDAFILIADO FROM AFI WHERE IDAFILIADO=@IDAFILIADO ) 
      IF NOT EXISTS(SELECT * FROM TER WHERE IDTERCERO=@IDTERCEROF)
      BEGIN
         SELECT @IDTERCEROF=RUC FROM AFI WHERE IDAFILIADO=@IDAFILIADO
      END
      ELSE
      BEGIN
         SELECT @IDTERCERO_RUC=@IDTERCEROF
      END
        
      SELECT @OK = COALESCE(COUNT(*),0) FROM TER WHERE IDTERCERO = @IDTERCEROF
      PRINT 'ANTES DE IF OK = 0'       
      IF @OK = 0
      BEGIN
         SELECT  @IDCATEGORIA = DBO.FNK_VALORVARIABLE('TERCATAFILIADO')
         PRINT 'Inserta Tercero con SPK_INSERT_TERDEAFI '+@IDAFILIADO+','+@IDCATEGORIA
         EXEC SPK_INSERT_TERDEAFI @IDAFILIADO, @IDCATEGORIA
      END
		--SELECT * FROM #FTRD1
		--PRINT 'ME DEVUELVO'
		--RETURN
      
       PRINT 'Valido el Moto Permitido'
       SELECT @MONTO=SUM(COALESCE(VLR_SERVICI,0))  FROM #FTRD1
       IF DBO.FNK_VALIDA_TOPE_FACTURA(CASE WHEN @PROC='CI' THEN 'CITAS' ELSE 'CE' END,@MONTO)=0
       BEGIN
			RAISERROR('El monto a Facturar Sobrepasa el Valor Autorizado, No se Puede Generar la Factura ',16,1)
			FETCH NEXT FROM CUR_FTR
		   INTO @IDTERCEROCA,@IDPLAN,@N_FACTURAORI       
         CONTINUE
       END

		IF @OK > 0 
		BEGIN
			IF @PROC = 'CE'
			BEGIN
				IF COALESCE(@LIBERTER,'')<>'SI'
				BEGIN 
					IF EXISTS(SELECT * FROM FTR WHERE NOREFERENCIA=@NOAUT AND PROCEDENCIA='CE' AND ESTADO='L'  AND COALESCE(CP_CONVENIO,'')='Boleta')
					BEGIN
						SELECT @LIBERADA=1,@NVOCONSEC=N_FACTURA , @CNSFTR=CNSFCT FROM FTR 
						WHERE NOREFERENCIA=@NOAUT 
						AND PROCEDENCIA='CE' AND ESTADO='L' AND N_FACTURA= CASE WHEN COALESCE(@N_FACTURAORI,'')<>'' THEN COALESCE(@N_FACTURAORI,'') ELSE FTR.N_fACTURA END
					END
					ELSE
					BEGIN
						SELECT @LIBERADA=0
					END
				END
				ELSE
				BEGIN 
					IF EXISTS(SELECT * FROM FTR WHERE IDTERCERO=@IDTERCEROCA1 AND ESTADO='L'  AND COALESCE(CP_CONVENIO,'')='Boleta')
					BEGIN
						SELECT TOP 1  @LIBERADA=1,@NVOCONSEC=N_FACTURA , @CNSFTR=CNSFCT FROM FTR WHERE IDTERCERO=@IDTERCEROCA1 
						AND ESTADO='L'  AND COALESCE(CP_CONVENIO,'')='Boleta'
					END 
				END 
			END
			IF  COALESCE(@LIBERADA,0)=0
			BEGIN              
				EXEC SPK_GENCONSECUTIVO @COMPANIA, @IDSEDE, '@CNSFTR',  @CNSFTR OUTPUT  
				SELECT @CNSFTR = @IDSEDE + REPLACE(SPACE(8 - LEN(@CNSFTR))+LTRIM(RTRIM(@CNSFTR)),SPACE(1),0)         

			   PRINT '->>>>>>>>> @IDTERCEROF:  ' +  @IDTERCEROF
			   PRINT '->>>>>>>>> @IDAFILIADO:  ' +  @IDAFILIADO
			   PRINT '->>>>>>>>> @TV:          ' +  @TV
			   PRINT '->>>>>>>>> @ESPARTPERU:  ' 
			   PRINT @ESPARTPERU
            IF @TV = 'Contado'  AND @ESPARTPERU = 1 AND @TIPOFAC='Boleta'
            BEGIN
               PRINT 'AQUI LLAMO A BOLETA @COMPANIA='+COALESCE(@COMPANIA,'SIN COMPANIA')+' @IDSEDE='+COALESCE(@IDSEDE,'SIN SEDE')         
               SET @NVOCONSEC = SPACE(20)
               EXEC SPK_GENNUMERO_BOLETA @COMPANIA, @IDSEDE, NULL, @NVOCONSEC OUTPUT   
 		         PRINT 'REGRESE DE BOLETA'
            END
            ELSE
            BEGIN
               PRINT 'AQUI LLAMO A NUMFACTURA  @COMPANIA='+COALESCE(@COMPANIA,'SIN COMPANIA')+' @IDSEDE='+COALESCE(@IDSEDE,'SIN SEDE')         
               SET @NVOCONSEC = SPACE(20)
               EXEC SPK_GENNUMEROFACTURA @COMPANIA, @IDSEDE, NULL, @NVOCONSEC OUTPUT   
 		        PRINT 'REGRESE DE NUMFACTURA'
            END
            PRINT 'CNSFCT ='+@CNSFTR+' - N_FACTURA = ' + @NVOCONSEC
         END
         PRINT '@NVOCONSEC='+@NVOCONSEC  
         IF COALESCE(@NVOCONSEC,'')=''
         BEGIN
            PRINT 'Me regreso no se genero consecutivo'
		      FETCH NEXT FROM CUR_FTR
		      INTO @IDTERCEROCA,@IDPLAN,@N_FACTURAORI
            CONTINUE
         END
			--IF @PROC = 'CE'
			--BEGIN
			--	SELECT @IDFORMATOFTR=IDFORFTRCE FROM PPT WHERE IDTERCERO=@IDTERCEROCA AND IDPLAN=@IDPLAN
			--END
			--IF @PROC = 'CI'
			--BEGIN
			--	SELECT @IDFORMATOFTR=IDFORFTRCIT FROM PPT WHERE IDTERCERO=@IDTERCEROCA AND IDPLAN=@IDPLAN
			--END
			--IF COALESCE(@IDFORMATOFTR,'')=''
			--BEGIN
				SELECT @IDFORMATOFTR=DBO.FNK_VALORVARIABLE('IDFORMATOFTR_BOLETA')
			--END
			/* SE REVISA SI EL PARAMETRO @FECHAFAC VIENE CON FECHA PARA COLOCARLE ESA FECHA A LA FACTURA SI NO SE COLOCA GETDATE()*/
			IF ISNULL(@FECHAFAC,'') = ''
			BEGIN
				SELECT @FECHAFAC = GETDATE()
			END
			PRINT ' N_FACTURA = '+ CASE WHEN @NVOCONSEC IS NULL THEN 'NO FACTURA' ELSE @NVOCONSEC END

			PRINT 'CNSFCT ='+@CNSFTR+' - N_FACTURA = ' + @NVOCONSEC

	    IF DBO.FNK_VALORVARIABLE('BLOQUEADIAN')='SI'
       BEGIN
         IF DBO.FNK_VALORVARIABLE('FACTSEDE')='SI'
         BEGIN
            PRINT '@IDSEDE='+@IDSEDE
            PRINT '@ESPARTPERU='+STR(@ESPARTPERU)
            PRINT '@TIPOFAC='+@TIPOFAC
            SELECT  @CNSRESOL=CNSRESOL,@PREFIJOFAC=PREFIJO  FROM FDIAN WHERE IDENTIFICADOR=@IDSEDE AND VENCIDA=0 AND PROCEDENCIA= CASE WHEN @ESPARTPERU= 1 AND @TIPOFAC='Boleta' THEN 'BOLE' ELSE 'FTR' END
         END
         ELSE
         BEGIN
            SELECT  @CNSRESOL=CNSRESOL,@PREFIJOFAC=PREFIJO  FROM FDIAN WHERE  VENCIDA=0 AND PROCEDENCIA = CASE WHEN @ESPARTPERU= 1 AND @TIPOFAC='Boleta' THEN 'BOLE' ELSE 'FTR' END
         END
      END
      IF COALESCE(@CNSRESOL,'')=''
      BEGIN
         PRINT 'NO ENCONTRE RESOLUCION ME DEVUELVO'
		   FETCH NEXT FROM CUR_FTR
		   INTO @IDTERCEROCA,@IDPLAN,@N_FACTURAORI
         CONTINUE         
      END
		IF @PREFIJOFAC<>LEFT(@NVOCONSEC,LEN(@PREFIJOFAC))
		BEGIN
         RAISERROR('Inconsistencia entre el prefijo de factura y el nro generado',16,1)
         RETURN			
		END     
			IF  COALESCE(@LIBERADA,0)=0
			BEGIN
				PRINT 'VOY A INSERTAR FTR...'
				PRINT '@DESCUENTO ANTES DEL INSERT=  :::::::::'+STR(@DESCUENTO)
			
				--IF (@IDTERCEROCA = dbo.FNK_VALORVARIABLE('IDTERCEROPARTICULAR') AND EXISTS (SELECT * FROM TER WHERE ESTADO='Activo' AND NIT=@IDAFIAUX ))
				--BEGIN
				--		SELECT @IDAFILIADOTER= IDTERCERO FROM TER WHERE ESTADO='Activo' AND NIT=@IDAFIAUX 
				--END 
				PRINT '@IDAFILIADOTER '+ @IDAFILIADOTER
            PRINT '@IDFORMATOFTR ='+@IDFORMATOFTR
            PRINT '@IDTERCERO_RUC ='+@IDTERCERO_RUC
				INSERT INTO FTR(CNSFCT, COMPANIA, CLASE, IDTERCERO, N_FACTURA, F_FACTURA, F_VENCE,
							VR_TOTAL, COBRADOR, VENDEDOR, MONEDA, OCOMPRA, ESTADO, F_CANCELADO,
							IDAFILIADO, EMPLEADO, NOREFERENCIA, PROCEDENCIA, TIPOFAC, OBSERVACION,
							TIPOVENTA, VALORCOPAGO, DESCUENTO, VALORPCOMP, CREDITO, INDCARTERA,
							INDCXC, MARCACONT, CONTABILIZADA, NROCOMPROBANTE, MARCA, INDASIGCXC,
							IMPRESO, VALORSERVICIOS, CLASEANULACION, CNSLOG, USUARIOFACTURA, FECHAFAC,
							MIVA, PIVA, VR_ABONOS, IDPLAN, FECHAPASOCXC, TIPOFIN, CNSFMAS, IDAREA_ALTA,
							CCOSTO_ALTA, IDDEP, TIPOTTEC, CUENTACXC,CUENTACXC_RAD, CAPITADA,CODUNG, CODPRG, IDSEDE, RDIAN,CNSRESOL,IDFORMATO,CP_CONVENIO)
				SELECT @CNSFTR, @COMPANIA, 'C', CASE WHEN COALESCE(@IDTERCERO_RUC,'')<>'' THEN @IDTERCERO_RUC ELSE  @IDTERCEROF END, 
						@NVOCONSEC, @FECHAFAC, @FECHAFAC + @DV,
						0, NULL, NULL, LEFT(@MONEDA,2), NULL, 'P', NULL, 
						@IDAFILIADO, @USUARIO, @NOAUT,
						@PROC, 'I', REPLACE(COALESCE(@OBSERVACION,''),'@N_FACTURA',@NVOCONSEC), @TV, 0, 0, 0, 0, 0, 0, 0, 0, NULL, 0, 0, 0, 0, NULL, NULL, @USUARIO,
						GETDATE(), 0, 0, 0, @IDPLAN, NULL, CASE WHEN @ESPARTPERU = 1 AND @TIPOFAC='Boleta' THEN 'N' ELSE 'C' END, NULL, @IDAREA, @CCOSTO, @DATO3, @TTEC,
						@CUENTACXC,@CUENTACXC_RAD, 0 ,COALESCE(@CODUNG,''),COALESCE(@CODPRG,''), @IDSEDE,CASE WHEN COALESCE(@CNSRESOL,'')<>'' THEN 1 ELSE 0 END,
                  COALESCE(@CNSRESOL,''),@IDFORMATOFTR,'Boleta'
			END
			ELSE
			BEGIN
				PRINT 'ACTUALIZO FTR FACTURA LIBERADA...........'
				UPDATE FTR SET ESTADO='P',CONTABILIZADA=0,NROCOMPROBANTE=NULL,NOREFERENCIA=@NOAUT, IDAFILIADO=@IDAFILIADO,PROCEDENCIA=@PROC,
					IDTERCERO= CASE WHEN COALESCE(@IDTERCERO_RUC,'')<>'' THEN @IDTERCERO_RUC ELSE  @IDTERCEROF END,
               IDPLAN=@IDPLAN,CUENTACXC= @CUENTACXC, CUENTACXC_RAD=@CUENTACXC_RAD,
					TIPOTTEC=@TTEC, F_FACTURA=@FECHAFAC, F_VENCE=@FECHAFAC + @DV,FECHAFAC=GETDATE(), DESCUENTO = @DESCUENTO --  STORRES SE AGREGA CAMPO DE DESCUENTOPARA QUE SE ACTUALIZE
				WHERE N_FACTURA=@NVOCONSEC AND CNSFCT=@CNSFTR AND ESTADO='L'
			END
			
			UPDATE #FTRD1 SET 
			CANTIDAD    = CASE WHEN CANTIDAD    IS NULL THEN 0 ELSE CANTIDAD    END,
			VALOR       = CASE WHEN VALOR       IS NULL THEN 0 ELSE VALOR       END,
			VLR_SERVICI = CASE WHEN VLR_SERVICI IS NULL THEN 0 ELSE VLR_SERVICI END,
			VR_TOTAL    = CASE WHEN VR_TOTAL    IS NULL THEN 0 ELSE VR_TOTAL    END,
			VLR_COPAGOS = CASE WHEN VLR_COPAGOS IS NULL THEN 0 ELSE VLR_COPAGOS END,
			VLR_PAGCOMP = CASE WHEN VLR_PAGCOMP IS NULL THEN 0 ELSE VLR_PAGCOMP END
         WHERE 1=1
         

         
         
			INSERT INTO FTRD(CNSFTR, N_CUOTA, FECHA, DB_CR, AREAPRESTACION, UBICACION
                         ,VR_TOTAL,
						IMPUTACION, CCOSTO, PREFIJO, ANEXO, REFERENCIA, IDCIRUGIA, CANTIDAD,
						VALOR, VLR_SERVICI, VLR_COPAGOS, VLR_PAGCOMP, IDPROVEEDOR, NOADMISION,
						NOPRESTACION, NOITEM, AREAFUNCONT, N_FACTURA, SUBCCOSTO, PCOSTO, FECHAPREST,
						IDIMPUESTO, IDCLASE,ITEM , VLRIMPUESTO, PIVA, VIVA,CUENTA_FIMPDV)
			SELECT @CNSFTR, N_CUOTA, FECHA, DB_CR, AREAPRESTACION, UBICACION
               ,VR_TOTAL
               ,IMPUTACION ,CCOSTO, PREFIJO, ANEXO, REFERENCIA, IDCIRUGIA, CANTIDAD
               ,VALOR,VLR_SERVICI, VLR_COPAGOS, VLR_PAGCOMP, IDPROVEEDOR, NOADMISION
               ,NOPRESTACION, NOITEM, AREAFUNCONT, @NVOCONSEC, SUBCCOSTO, PCOSTO, FECHAPREST
               ,IDIMPUESTO, IDCLASE,ITEM , VLRIMPUESTO, PIVA, VIVA,CUENTA_FIMPDV        
			FROM   #FTRD1
		--	RETURN
			TRUNCATE TABLE #FTRD1 

			SELECT @VIVA=SUM(COALESCE(VIVA,0)) FROM FTRD WHERE FTRD.N_FACTURA = @NVOCONSEC  
			IF @VIVA>0
			BEGIN
				SELECT TOP 1 @PIVA=PIVA ,@MIVA=1 FROM FTRD WHERE FTRD.N_FACTURA = @NVOCONSEC  AND COALESCE(PIVA,0)<>0            
				UPDATE FTR SET MIVA=@MIVA,PIVA=@PIVA,VIVA=@VIVA WHERE N_FACTURA = @NVOCONSEC
				--UPDATE FTRD SET VALOR=VALOR-CASE WHEN COALESCE(VIVA,0)>0 THEN VIVA ELSE 0 END WHERE N_FACTURA = @NVOCONSEC
			END

			SELECT @VRTOTAL = SUM(VR_TOTAL), @VRSERV = SUM(VLR_SERVICI),@VRCOPA = SUM(VLR_COPAGOS)  ,
				@VRPACO  = SUM(VLR_PAGCOMP)
			FROM FTRD WHERE N_FACTURA = @NVOCONSEC

			PRINT '***********************************VALOR ***********************'
			PRINT @VRTOTAL    
			PRINT @VRSERV 
			IF @VRTOTAL < 0
			BEGIN
				SELECT @VRTOTAL = 0
			END
         
			IF @DESCUENTO IS NULL
				SELECT @DESCUENTO = 0
          
			PRINT '@DESCUENTO=  :::::::::'+STR(@DESCUENTO)

			IF @DESCUENTO > 0
			BEGIN
				IF @TIPODTO = 'P'
					SELECT @VRDTO = ROUND(@VRTOTAL * (COALESCE(@DESCUENTO,0)/100),0)
				ELSE 
					SELECT @VRDTO = COALESCE(@DESCUENTO,0) 
				END           
			ELSE
			BEGIN
				SELECT @VRDTO = 0
			END
         
			IF COALESCE(@VRABONO,0)=0
			BEGIN
				SELECT @VRABONO = 0
			END
         
			UPDATE FTR SET VALORSERVICIOS = @VRSERV, VALORCOPAGO = ROUND(@VRCOPA,0), VALORPCOMP = @VRPACO,
					DESCUENTO = 0
			WHERE N_FACTURA = @NVOCONSEC
         
     
         
			UPDATE FTR SET VR_TOTAL = COALESCE(VALORSERVICIOS,0) - COALESCE(VALORCOPAGO,0) - COALESCE(VALORPCOMP,0) - COALESCE(DESCUENTO,0) - COALESCE(VR_ABONOS,0)--+CASE WHEN @BASE_IVA_SER='CONIVA' THEN 0 ELSE  COALESCE(@VIVA,0) END                      
			WHERE  N_FACTURA = @NVOCONSEC  
         
            
			UPDATE FTR SET VR_TOTAL = 0
			WHERE  VR_TOTAL < 0
			AND    N_FACTURA = @NVOCONSEC  
         

      
			IF @EC <> 1
				EXEC SPK_FAC_IMPDEDUC @NIT, @CNSFTR, @NVOCONSEC, @VRSERV
   
			IF @PROC = 'CE'      
			BEGIN
				IF @CETIPOHOSP = 'CEHOSP'
				BEGIN
					UPDATE AUTD SET NFACTURA=@NVOCONSEC
					FROM   AUTD INNER JOIN 
						AUT ON AUTD.IDAUT = AUT.IDAUT INNER JOIN 
						SER ON SER.IDSERVICIO = AUTD.IDSERVICIO LEFT JOIN
						TER ON TER.IDTERCERO = AUTD.IDTERCEROCA
					WHERE  AUT.NOAUT = @NOAUT
						AND SER.PREFIJO       <> @PRE1
						AND SER.PREFIJO       <> @PRE2
						AND SER.PREFIJO       <> @PRE3
						AND SER.PREFIJO       <> @PRE4
						AND SER.PREFIJO       <> @PRE5                 
						AND (AUTD.FACTURADA=0 OR AUTD.FACTURADA IS NULL OR AUTD.FACTURADA=2)
						AND (TER.IDTERCERO  = @IDTERCEROCA OR (TER.IDTERCERO IS NULL AND @IDTERCEROF=@IDTERCEROCA))                
						AND AUTD.IDPLAN = @IDPLANPAR
				END
				ELSE
				BEGIN
					IF @IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART') OR 
						@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART2') OR 
						@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART3') OR 
						@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART4') OR 
						@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART5') OR 
						@EC = 1
					BEGIN
						UPDATE AUTD SET NFACTURA=@NVOCONSEC
						FROM   AUTD INNER JOIN 
							AUT ON AUTD.IDAUT = AUT.IDAUT INNER JOIN 
							SER ON SER.IDSERVICIO = AUTD.IDSERVICIO LEFT JOIN
							TER ON TER.IDTERCERO = AUTD.IDTERCEROCA
						WHERE  AUT.NOAUT = @NOAUT                
							AND (AUTD.FACTURADA=0 OR AUTD.FACTURADA IS NULL OR AUTD.FACTURADA=2)
							AND (TER.IDTERCERO  = @IDTERCEROCA OR (TER.IDTERCERO IS NULL AND @IDTERCEROF=@IDTERCEROCA))                
					END
					ELSE
					BEGIN   
						UPDATE AUTD SET NFACTURA=@NVOCONSEC
						FROM   AUTD INNER JOIN 
							AUT ON AUTD.IDAUT = AUT.IDAUT INNER JOIN 
							SER ON SER.IDSERVICIO = AUTD.IDSERVICIO LEFT JOIN
							TER ON TER.IDTERCERO = AUTD.IDTERCEROCA
						WHERE  AUT.NOAUT = @NOAUT
							AND SER.PREFIJO       <> @PRE1
							AND SER.PREFIJO       <> @PRE2
							AND SER.PREFIJO       <> @PRE3
							AND SER.PREFIJO       <> @PRE4
							AND SER.PREFIJO       <> @PRE5                 
							AND (AUTD.FACTURADA=0 OR AUTD.FACTURADA IS NULL OR AUTD.FACTURADA=2)
							AND (TER.IDTERCERO  = @IDTERCEROCA OR (TER.IDTERCERO IS NULL AND @IDTERCEROF=@IDTERCEROCA)) 
					END
				END
			END
			ELSE
			BEGIN
            PRINT 'VOY A ACTUALIZAR CIT @NOAUT='+@NOAUT

				UPDATE CIT SET CIT.NFACTURA = @NVOCONSEC,
						CIT.CNSFCT    = @CNSFTR, CIT.VFACTURAS = 0,
							CIT.MARCAFAC  = 0
				WHERE CONSECUTIVO = @NOAUT

				IF @IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART') OR 
					@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART2') OR 
					@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART3') OR 
					@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART4') OR 
					@IDPLAN = DBO.FNK_VALORVARIABLE('IDPLANPART5') OR 
					@EC = 1 OR  COALESCE(@VENTAPRT,0) = 1
				BEGIN 
					UPDATE TFCJ SET VALORTOTAL =( CIT.VALORTOTAL-COALESCE(CIT.DESCUENTO,0))  FROM TFCJ INNER JOIN CIT ON CIT.CONSECUTIVO =TFCJ.NOADMISION 
					WHERE TFCJ.PROCEDENCIA='CITAS' AND CIT.CONSECUTIVO= @NOAUT
						
					UPDATE TFCJD SET VALORTOTAL =( CIT.VALORTOTAL-COALESCE(CIT.DESCUENTO,0)) , VALORUNITARIO=( CIT.VALORTOTAL-COALESCE(CIT.DESCUENTO,0))
													FROM TFCJ INNER JOIN CIT ON CIT.CONSECUTIVO =TFCJ.NOADMISION 
															INNER JOIN TFCJD ON TFCJ.CNSFACJ=TFCJD.CNSFACJ
					WHERE TFCJ.PROCEDENCIA='CITAS' AND CIT.CONSECUTIVO= @NOAUT
               PRINT 'ES PARTICULAR MARCO LA CITA FACTURADA'
               UPDATE CIT SET N_FACTURA=@NVOCONSEC,FACTURADA=1 WHERE CONSECUTIVO = @NOAUT
				END 
			END
		END

		--CONTABILIZA FACTURA
		--EXEC SPK_NC_CONTAB_FTR @NVOCONSEC, @COMPANIA, @USUARIO, @SYS_COMPUTERNAME, @IDSEDE, ''
      IF DBO.FNK_VALORVARIABLE('PROVEEDOR_FACTUELECT')='MIFACT'
      BEGIN
		PRINT 'SPK_GENERA_JSON_PERU_FACTURA ==============================>'
         EXEC SPK_GENERA_JSON_PERU_FACTURA @NVOCONSEC
      END
		PRINT 'REVISO PRESUPUESTO'
		--IF DBO.FNK_VALORVARIABLE('PRESUP_CXC_ACTIVADO')= 'SI'  
		--BEGIN 
		--	PRINT 'ESTOY ACTIVADO'
		--	IF DBO.FNK_VALORVARIABLE('PRESUP_TIPORECO')='DESDEFTR'  
		--	BEGIN
		--		PRINT 'ENVIO AUTOMATICO A PRESUPUESTO FACURA EN PPTO'
		--		EXEC DBO.SPK_ENTREGA_FACTURA_PTTO @NVOCONSEC,@IDSEDE
		--	END
		--END
		FETCH NEXT FROM CUR_FTR
		INTO @IDTERCEROCA,@IDPLAN,@N_FACTURAORI
	END
	CLOSE CUR_FTR
	DEALLOCATE CUR_FTR
	DROP TABLE #FTRD1
	IF @PROC = 'CE'      
	BEGIN
      PRINT 'ACTUALIZO AUTD'
		UPDATE AUTD SET NFACTURA = @NVOCONSEC   WHERE IDAUT=@NOAUT
      IF @VENTAPRT=1
      BEGIN
         IF EXISTS(SELECT * FROM AUT WHERE IDAUT=@NOAUT AND VALORTOTAL=VALORCOPAGO)
         BEGIN
            UPDATE AUT SET FACTURADA=1,N_FACTURA=@NVOCONSEC WHERE  IDAUT=@NOAUT
         END
      END
	END    
END





