IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME='SPK_NC_CONTAB_CXC' AND XTYPE='P')
BEGIN
   DROP PROCEDURE SPK_NC_CONTAB_CXC
END
GO
CREATE PROCEDURE DBO.SPK_NC_CONTAB_CXC 
@CNSFPAG          VARCHAR(20), 
@USUARIO          VARCHAR(12),
@SYS_COMPUTERNAME VARCHAR(254),
@COMPANIA         VARCHAR(2), 
@SEDE             VARCHAR(5),
@NROCOMPROBANTE   VARCHAR(20)
WITH ENCRYPTION
AS 
DECLARE @COM              VARCHAR(6)
DECLARE @NOREFERENCIA     VARCHAR(20)
DECLARE @ANO              VARCHAR(4)
DECLARE @MES              INT
DECLARE @IDMODELOCONT	  VARCHAR(2)
DECLARE @IDPLAN		     VARCHAR(6) 
DECLARE @TIPOTERCONTABLE  VARCHAR(10) 
DECLARE @VALORGLOSAS	     DECIMAL(14,2)
DECLARE @VALORIMPUESTOS	  DECIMAL(14,2)
DECLARE @VLR_DTO_IND  	  DECIMAL(14,2)
DECLARE @PREFIJO_USCXS    VARCHAR(10)
DECLARE @INGRESO          VARCHAR(10)
DECLARE @VLRAJUSTEPESO    DECIMAL(14,2)
DECLARE @VLRDTOFINAN      DECIMAL(14,2)
DECLARE @FECHATRA         DATETIME
DECLARE @CUE_OFIN		  VARCHAR(16), @PCJ_CUENTA VARCHAR(20) 
DECLARE @NROCOMPRORI   VARCHAR(20)
BEGIN
   SELECT * INTO #T FROM FPAG WHERE CNSFPAG=@CNSFPAG
   SELECT * INTO #TH FROM FPAGD WHERE CNSFPAG=@CNSFPAG
   
   SELECT   @ANO            = YEAR(FECHA),
            @MES            = MONTH(FECHA),
            @VALORIMPUESTOS = VLRIMPUESTOS,
            @VALORGLOSAS    = VLRGLOSAS,
            @VLRAJUSTEPESO  = VLRAJUSTEPESO,
            @VLRDTOFINAN    = VLRDTOFINAN,
            @INGRESO        = INGRESO,
            @FECHATRA       = FECHA
   FROM #T
   SELECT @VLR_DTO_IND=SUM(ABS(COALESCE(VLROTROSDCTOS,0)))
   FROM #TH

   IF NOT EXISTS(SELECT COMPANIA,ANO,MES FROM PRI WHERE COMPANIA=@COMPANIA AND ANO=@ANO AND MES=@MES)
   BEGIN
      Print 'Período Contable No Existe'
      RAISERROR('Período Contable No Existe',16,1)
      RETURN
   END  
   IF (SELECT CERRADO FROM PRI WHERE COMPANIA=@COMPANIA AND ANO=@ANO AND MES=@MES) = 1
   BEGIN
      Print 'Período Contable Cerrado'
      RAISERROR('Período Contable Cerrado',16,1)
      RETURN
   END
   
   SET @IDMODELOCONT = DBO.FNK_VALORVARIABLE('IDMODELOCONTABLE')
   PRINT '@NROCOMPROBANTE:' + ISNULL(@NROCOMPROBANTE,'') -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
   IF ISNULL(@NROCOMPROBANTE,'') = '' -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
   BEGIN
      SET @NROCOMPROBANTE = SPACE(20) -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
      EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@MCP',@NROCOMPROBANTE OUTPUT -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD     
      SELECT @NROCOMPROBANTE = @SEDE + REPLACE(SPACE(8 - CASE WHEN LEN(@NROCOMPROBANTE) > 8 THEN 8 ELSE LEN(@NROCOMPROBANTE) END)+LTRIM(RTRIM(@NROCOMPROBANTE)),SPACE(1),0) -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD
      PRINT '@NROCOMPROBANTE:' + ISNULL(@NROCOMPROBANTE,'') -- MODIFICADO POR R.JAY 2009.04.18 PARA ELIMINAR DUPLICIDAD 
      --  IF @INGRESO='CAJA'  
      --     SET @COM=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDCON_TCOM_ICAJ')))
      --  ELSE 
      --SE REVISA SI LOS COMPROBANTES SE TOMAN DE ACUERDO A SEDE
      IF (SELECT DBO.FNK_VALORVARIABLE('COMPROBMULTISEDE')) = 'SI'
      BEGIN
         IF @INGRESO='GLOSAS'
         BEGIN
            SELECT @COM = RTRIM(LTRIM(COMMS.COMPROBANTE)) FROM COMMS WHERE IDSEDE = @SEDE AND COMMS.CLASE = 'CXC' AND TIPO = 'GLOSAS'
         END
         ELSE
         BEGIN
            SELECT @COM = RTRIM(LTRIM(COMMS.COMPROBANTE)) FROM COMMS WHERE IDSEDE = @SEDE AND COMMS.CLASE = 'CXC' AND TIPO = 'OTRAS'
         END
      END
      ELSE
      BEGIN
         IF @INGRESO='GLOSAS'
         BEGIN
            SET @COM=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDCON_TCOM_CXC_GLOSA')))
         END
         ELSE 
         BEGIN
            IF @INGRESO='DEVOLUCION' AND COALESCE ( LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDCON_TCOM_CXC_DEVO'))),'')<>''
            BEGIN 
               SET @COM=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDCON_TCOM_CXC_DEVO')))
            END 
            ELSE 
            BEGIN 
               SET @COM=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDCON_TCOM_CXC')))
            END 
         END
      END
           
      SET @PREFIJO_USCXS='@COM'+@COM
      SET @NOREFERENCIA=SPACE(20)
      EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,@PREFIJO_USCXS,@NOREFERENCIA OUTPUT   
      SELECT @NOREFERENCIA = REPLACE(SPACE(8 - LEN(@NOREFERENCIA))+LTRIM(RTRIM(@NOREFERENCIA)),SPACE(1),0)
      PRINT 'Nuevo Comprobante: '+@COM+' '+@NOREFERENCIA
         
      PRINT 'Comprobanrte Contable (MCP)'
      INSERT INTO MCPE(NROCOMPROBANTE, COMPANIA, PROCEDENCIA, NOREFERENCIA, ANO, MES, FECHACONTABLE, TOTALDEBITO,
                       TOTALCREDITO, REFERENCIA1, REFERENCIA2, USUARIO, FECHA, LOTE, OBSERVACION, IDSEDE, ESTADO,
                       COMPROBANTE, IDTERCERO)
      SELECT @NROCOMPROBANTE, @COMPANIA, 'CXC', @NOREFERENCIA, @ANO, @MES, CAST(STR(DAY(FECHA))+'/'+LTRIM(STR(@MES))+'/'+@ANO AS DATETIME),
              0, 0, CNSFPAG, '', @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()), NULL, 
              'RECAUDOS DE CUENTAS POR COBRAR', @SEDE, 0, @COM, (CASE WHEN #T.IDTERCERO IS NULL THEN '' ELSE #T.IDTERCERO END)
      FROM #T  
   END  
   IF (SELECT COUNT(*) FROM MCP WHERE NROCOMPROBANTE=@NROCOMPROBANTE)>0
   BEGIN
      INSERT INTO MCPE (COMPANIA, NROCOMPROBANTE, PROCEDENCIA, NOREFERENCIA, ANO, MES, FECHACONTABLE, TOTALDEBITO ,TOTALCREDITO, REFERENCIA1, REFERENCIA2,
                       REFERENCIA3, USUARIO, FECHA, LOTE ,OBSERVACION ,IDSEDE ,ESTADO ,ANULADO ,COMPROBANTE ,IDTERCERO, BANCO ,NOCHEQUE, VALOR_CHEQUE,
                       RPT_COMPROBANTE, FECHARADICACION, MARCA, SYS_COMPUTERNAME_MARCA, ESTADOIMP, CBTEINTERNO)
      SELECT COMPANIA, NROCOMPROBANTE, PROCEDENCIA, NOREFERENCIA, ANO, MES, FECHACONTABLE, TOTALDEBITO ,TOTALCREDITO, REFERENCIA1, REFERENCIA2,
                       REFERENCIA3, USUARIO, FECHA, LOTE ,OBSERVACION ,IDSEDE ,ESTADO ,ANULADO ,COMPROBANTE ,IDTERCERO, BANCO ,NOCHEQUE, VALOR_CHEQUE,
                       RPT_COMPROBANTE, FECHARADICACION, MARCA, SYS_COMPUTERNAME_MARCA, ESTADOIMP, CBTEINTERNO
      FROM   MCP
      WHERE  NROCOMPROBANTE = @NROCOMPROBANTE
      --se borran de mcp, mch
      DELETE MCH WHERE NROCOMPROBANTE = @NROCOMPROBANTE
      DELETE MCP WHERE NROCOMPROBANTE = @NROCOMPROBANTE   
   END
   DELETE MCHE WHERE NROCOMPROBANTE=@NROCOMPROBANTE
   IF EXISTS(SELECT * FROM MCPE WHERE LOTE='REV' AND NROCOMPROBANTE=@NROCOMPROBANTE)
   BEGIN
     PRINT 'Es una Reversion de Recuados... Busco el Original...'
     SELECT @NROCOMPRORI=REFERENCIA3 FROM MCPE WHERE NROCOMPROBANTE=@NROCOMPROBANTE
     --SELECT DBO.FNK_COLUMNAS_TABLAS('MCHE')
     INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, REFERENCIA1, REFERENCIA2, REFERENCIA3, N_FACTURA, F_FACTURAREF, F_VENCE, GENERA, CLASE_GENERA, CNSPAGO, ITEMREF, 
                 USUARIO, FECHA, PREFIJO, IDAREA, CLASECONT, ESTADO, PROCESO, VALOR_PORCIMP, BASE_IMP, PROCEDENCIA, REFERENCIA_PRO, CONCILIADO, FECHACONCILIACION, CNSFCXCXP, CODUNG, CODPRG, 
                 ERROR, IDPROVEEDOR, ENPRESUPUESTO, IDOPERACION, ESTADOIMP)
      SELECT @NROCOMPROBANTE, COMPANIA,CASE WHEN TIPO='DB' THEN 'CR' ELSE 'DB' END, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, REFERENCIA1, REFERENCIA2, REFERENCIA3, N_FACTURA, F_FACTURAREF, F_VENCE, GENERA, CLASE_GENERA, CNSPAGO, ITEMREF, 
             USUARIO, FECHA, PREFIJO, IDAREA, CLASECONT, ESTADO, PROCESO, VALOR_PORCIMP, BASE_IMP, PROCEDENCIA, REFERENCIA_PRO, CONCILIADO, FECHACONCILIACION, CNSFCXCXP, CODUNG, CODPRG, 
             ERROR, IDPROVEEDOR, ENPRESUPUESTO, IDOPERACION, ESTADOIMP
      FROM MCH 
      WHERE NROCOMPROBANTE=@NROCOMPRORI

      EXEC SPK_NC_REVISAMCPE @NROCOMPROBANTE, @COMPANIA, @USUARIO, @SEDE, @SYS_COMPUTERNAME 
      EXEC SPK_PASA_MCP_MCPNIIF @NROCOMPROBANTE, @COMPANIA, @USUARIO, @SYS_COMPUTERNAME, @SEDE,@COM,''

      PRINT 'Termino y me Regreso'
      RETURN
   END
   IF @INGRESO='CAJA'
   BEGIN
      PRINT 'Caja...'
      IF EXISTS(SELECT COMPANIA FROM PAR WHERE COMPANIA=@COMPANIA)
      BEGIN
         PRINT ' -Insertando MCH (Con COMPAÑIA en PAR)'
         DECLARE @CODCAJA VARCHAR(10)
         DECLARE @CNSFACJ VARCHAR(20)
         SELECT @CODCAJA=CODCAJA,@CNSFACJ=CNSFACJ FROM #T
		   SELECT @PCJ_CUENTA = CASE WHEN COALESCE(PCJ.CUENTA,'') = '' THEN COALESCE(FPA.CUENTA,'') ELSE PCJ.CUENTA END
         FROM   #T LEFT JOIN PCJ ON PCJ.CNSFACJ=#T.CNSFACJ AND PCJ.CODCAJA=#T.CODCAJA
					LEFT JOIN FPA ON FPA.FORMAPAGO=PCJ.TIPOPAGO
         PRINT 'VALIDO EL ASIENTO CONTABLE'
         IF EXISTS(SELECT * FROM FCJ WHERE COALESCE(N_FACTURAPOS,'')<>'' AND CNSFACJ=@CNSFACJ AND CODCAJA=@CODCAJA)
         BEGIN
            SELECT @PCJ_CUENTA=CUENTA  FROM KCDE WHERE TIPO='FTR_COPAGOS'
         END
         INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
 	                   REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA, 
                     N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
         SELECT @NROCOMPROBANTE, @COMPANIA,'DB', CASE WHEN UPPER(DBO.FNK_VALORVARIABLE('USARCUEPUENTE'))='SI' THEN 
                                                   PAR.CTA_CAJ_REC_NOLEG ELSE @PCJ_CUENTA END,
                #T.IDTERCERO, '' AS CCOSTO, 'DEPOSITO DE CLIENTES EN CAJA, CNSPAGO No. '+#T.CNSFPAG,
 	            CASE WHEN UPPER(DBO.FNK_VALORVARIABLE('CUE_IMP_RECAUDOS'))='SI' THEN (COALESCE(#T.VLRITEMS,0) - @VALORIMPUESTOS) 
 	                 ELSE CASE WHEN  #T.VLRAJUSTEPESO<>0 THEN  COALESCE(#T.VALORPAGO,0) ELSE  COALESCE(#T.VLRITEMS,0) END
 	            END,'',NULL,NULL,@USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()), NULL,
 	            '' AS IDAREA, 'S' AS CLASECONT, 1, 'DEP_CLIENTES', 'Movimiento', RTRIM(#T.CODCAJA)+#T.CNSFACJ,
                DBO.FNK_FECHA_SIN_HORA(FCJ.FECHA), DBO.FNK_FECHA_SIN_HORA(FCJ.FECHA), 'CXC', @CNSFPAG,
                FCJ.CODUNG, FCJ.CODPRG
         FROM #T LEFT JOIN
              FCJ ON FCJ.CNSFACJ=#T.CNSFACJ AND FCJ.CODCAJA=#T.CODCAJA, PAR
         WHERE PAR.COMPANIA=@COMPANIA AND #T.VLRTOTAL>0  
      END
      ELSE
      BEGIN 
         PRINT ' -Insertando Registro MCH Con Error... (No se encontró un COMPA?IA en PAR)'
         INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
 	                       REFERENCIA2,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,PROCESO,GENERA, 
                         N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO)
         SELECT @NROCOMPROBANTE,@COMPANIA,'DB','NO DEF.PAR',#T.IDTERCERO,'' AS CCOSTO,
               'DEPOSITO DE CLIENTES EN CAJA, CNSPAGO No. '+#T.CNSFPAG,
               #T.VALORPAGO,'',NULL,NULL,@USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()),NULL,
               '' AS IDAREA, 'S' AS CLASECONT, 1, 'DEP_CLIENTES', 'Movimiento',RTRIM(#T.CODCAJA)+#T.CNSFACJ,
               (SELECT DBO.FNK_FECHA_SIN_HORA(FECHA) FROM FCJ WHERE CNSFACJ=#T.CNSFACJ AND CODCAJA=#T.CODCAJA),
               (SELECT DBO.FNK_FECHA_SIN_HORA(FECHA) FROM FCJ WHERE CNSFACJ=#T.CNSFACJ AND CODCAJA=#T.CODCAJA),
	              'CXC',@CNSFPAG
         FROM #T WHERE #T.VLRTOTAL>0
      END
   END
   ELSE
   IF @INGRESO='BANCOS'
   BEGIN
      PRINT 'Bancos...'
      PRINT ' -Insertando MCH (Bancos)'
      
      -- ADD. JQUIROGA 20090421
      SELECT @CUE_OFIN = OFIN.CUENTA 
      FROM   #T INNER JOIN BMOV ON BMOV.BANCO    = #T.BANCO 
                                  AND BMOV.SUCURSAL = #T.SUCURSAL 
                                  AND BMOV.CTA_BCO  = #T.CTA_BCO 
                                  AND BMOV.ITEM     = #T.ITEM
	               INNER JOIN OFIN ON OFIN.IDOPERACION = BMOV.IDOPERACION
      
      -- MOD. JQUIROGA 20090421
      INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
                      REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,
                      PROCESO,GENERA, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
      SELECT @NROCOMPROBANTE,@COMPANIA,'DB',
	          CASE 
			             WHEN UPPER(DBO.FNK_VALORVARIABLE('USARCUEPUENTE'))     = 'SI'  THEN PAR.CTA_CAJ_REC_NOLEG 
				          WHEN UPPER(DBO.FNK_VALORVARIABLE('CUEOFIN_CONTABCXC')) = 'SI' THEN @CUE_OFIN 
				          ELSE BMOVD.CUENTA 
             END,
             #T.IDTERCERO,'' AS CCOSTO, 
             'DEPOSITO EN BANCO, CH '+(CASE WHEN #T.NUMERODOCUMENTO IS NULL THEN '' ELSE #T.NUMERODOCUMENTO END)+', '+
             ISNULL(#T.BANCO,'')+' '+UPPER(CASE WHEN UPPER(DBO.FNK_VALORVARIABLE('USARCUEPUENTE'))='SI' THEN CUE.NOMCUENTA 
                                              ELSE CUE2.NOMCUENTA 
                                         END)+', RECAUDO No.'+#T.CNSFPAG +'SEGUN COMPROBANTE: '+MCP.COMPROBANTE+' CNS: '+
                                         MCP.NOREFERENCIA+' FECHA: '+DBO.FNK_FECHA(MCP.FECHACONTABLE),
 	      CASE WHEN UPPER(DBO.FNK_VALORVARIABLE('CUE_IMP_RECAUDOS'))='SI' THEN  CASE WHEN   #T.VLRAJUSTEPESO<>0 THEN  (COALESCE(#T.VALORPAGO,0)) -COALESCE(@VLR_DTO_IND,0)
																						---VLRAJUSTEPESO
																						ELSE   (COALESCE(#T.VLRITEMS,0))-COALESCE(@VLR_DTO_IND,0) END 
																						--+ ABS(VLRAJUSTEPESO)
 	               ELSE CASE WHEN  #T.VLRAJUSTEPESO<>0 THEN  COALESCE(#T.VALORPAGO,0)  -COALESCE(@VLR_DTO_IND,0)ELSE  COALESCE(#T.VLRITEMS,0)-COALESCE(@VLR_DTO_IND,0) END
 	          END, /* JREYES FECHA: 20090512 REQ: 0100001332*/
             #T.BANCO,#T.SUCURSAL,#T.NUMERODOCUMENTO,NULL,@USUARIO,
             DBO.FNK_FECHA_SIN_MLS(GETDATE()),NULL, '' AS IDAREA, 'S' AS CLASECONT, 1, 'DEP_CLIENTES_BANCO', 'Movimiento', 
             'CXC', @CNSFPAG, BMOV.CODUNG, BMOV.CODPRG
      FROM   #T LEFT JOIN PAR   ON #T.CNSFPAG     = #T.CNSFPAG 
              LEFT JOIN CUE   ON CUE.CUENTA     = PAR.CTA_CAJ_REC_NOLEG 
                             AND CUE.COMPANIA   = PAR.COMPANIA 
              LEFT JOIN BMOVD ON BMOVD.BANCO    = #T.BANCO 
                             AND BMOVD.SUCURSAL = #T.SUCURSAL 
                             AND BMOVD.CTA_BCO  = #T.CTA_BCO 
                             AND BMOVD.ITEM     = #T.ITEM 
                             AND BMOVD.RENGLON  = #T.RENGLON 
              LEFT JOIN BMOV  ON BMOV.BANCO     = #T.BANCO 
                             AND BMOV.SUCURSAL  = #T.SUCURSAL 
                             AND BMOV.CTA_BCO   = #T.CTA_BCO 
                             AND BMOV.ITEM      = #T.ITEM 
              LEFT JOIN CUE CUE2 ON BMOVD.CUENTA = CUE2.CUENTA
              LEFT JOIN MCP ON BMOV.NROCOMPROBANTE=MCP.NROCOMPROBANTE  
      WHERE  #T.VLRTOTAL  > 0 
      AND    PAR.COMPANIA = @COMPANIA 
   END 
   ELSE 
   IF @INGRESO='CXP'
   BEGIN
      PRINT 'Ingreso por CXP.'
      PRINT ' -Insertando MCH (CXP)'
      INSERT INTO MCHE(NROCOMPROBANTE,COMPANIA,TIPO,CUENTA,IDTERCERO,CCOSTO,DETALLE,VALOR,REFERENCIA1,
                       REFERENCIA2,REFERENCIA3,ITEMREF,USUARIO,FECHA,PREFIJO,IDAREA,CLASECONT,ESTADO,
                       PROCESO,GENERA,CNSPAGO,N_FACTURA,F_FACTURAREF,F_VENCE,PROCEDENCIA,REFERENCIA_PRO,
                       CODUNG, CODPRG) 
      SELECT @NROCOMPROBANTE,@COMPANIA,'DB',FCXP.CUECREDITO,FCXP.IDTERCERO,'' AS CCOSTO,
             'CRUCE CXP FA: '+FPAGDCXP.NOREFERENCIA+', RECAUDO No.'+#T.CNSFPAG,
             FPAGDCXP.VLRCRUCE,FPAGDCXP.NOREFERENCIA,FPAGDCXP.CNSFCXP,'',NULL,@USUARIO,
             DBO.FNK_FECHA_SIN_MLS(GETDATE()),NULL,'' AS IDAREA, 'S' AS CLASECONT, 1, 'CRUCE_CXP', 'Movimiento',
             FPAGDCXP.CNSFPAG,FPAGDCXP.NOREFERENCIA,DBO.FNK_FECHA_SIN_HORA(FCXP.F_FACTURAREF),
             DBO.FNK_FECHA_SIN_HORA(FCXP.F_VENCE),'CXC', @CNSFPAG, FCXP.CODUNG, FCXP.CODPRG
      FROM #T, FPAGDCXP, FCXP  
      WHERE #T.VLRTOTAL>0 AND #T.CNSFPAG=FPAGDCXP.CNSFPAG AND FPAGDCXP.CNSFCXP=FCXP.CNSFCXP
   END
   ELSE
   IF @INGRESO='CONTAB'
   BEGIN
      PRINT 'Ingreso por Contabilidad'
   END
   ELSE
   IF @INGRESO='GLOSAS'
   BEGIN
      PRINT 'Glosas...?'
   END
   IF @INGRESO='DEVOLUCION'
   BEGIN 
      PRINT'DEVOLUCIONES'    
      INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                      REFERENCIA2, ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO, ESTADO, PROCESO, GENERA,    
                      CLASECONT, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
      SELECT @NROCOMPROBANTE, @COMPANIA, 'DB', ISNULL(TTEC.CUENTA,'NO DEF.TTEC'),  
             #T.IDTERCERO,'' AS CCOSTO,LEFT('DEVOLUCION  FACTURA: '+#TH.N_FACTURA+CASE WHEN COALESCE(#TH.OBSERVACION,'')<>'' THEN ' RAZON O MOTIVO:'+COALESCE(#TH.OBSERVACION,'') ELSE '' END,511),
			 SUM(#TH.VLRGLOSA), NULL, NULL, NULL, @USUARIO, 
             DBO.FNK_FECHA_SIN_MLS(GETDATE()), '' AS IDAREA, '' AS PREFIJO, 1, 
             'CXC_DEVOLUCION', 'Movimiento','S', #TH.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#T.FECHA), 
             DBO.FNK_FECHA_SIN_HORA(#T.FECHA),'CXC',@CNSFPAG, #TH.CODUNG, #TH.CODPRG
      FROM #T INNER JOIN #TH  ON #T.CNSFPAG    = #TH.CNSFPAG 
              LEFT JOIN FTR  ON #TH.N_FACTURA = FTR.N_FACTURA 
              LEFT JOIN TTEC ON TTEC.TIPO     = FTR.TIPOTTEC 
      WHERE #TH.VLRGLOSA>0
      GROUP BY TTEC.CUENTA, #T.IDTERCERO, #TH.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#T.FECHA), 
              #TH.CODUNG, #TH.CODPRG,COALESCE(#TH.OBSERVACION,'')
              
      PRINT 'INSERTANDO CREDITOS' 
      
      INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                      REFERENCIA2, ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO, ESTADO, PROCESO, GENERA,    
                      CLASECONT, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
      SELECT @NROCOMPROBANTE, @COMPANIA, 'CR', ISNULL(TTEC.CUENTARAD,'NO DEF.TTEC'),  
             #T.IDTERCERO,'' AS CCOSTO, 'DEVOLUCION  FACTURA '+#TH.N_FACTURA, SUM(#TH.VLRGLOSA), NULL, NULL, NULL, @USUARIO, 
             DBO.FNK_FECHA_SIN_MLS(GETDATE()), '' AS IDAREA, '' AS PREFIJO, 1, 
             'CXC_DEVOLUCION', 'Movimiento','S', #TH.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#T.FECHA), 
             DBO.FNK_FECHA_SIN_HORA(#T.FECHA),'CXC',@CNSFPAG, #TH.CODUNG, #TH.CODPRG
      FROM #T INNER JOIN #TH  ON #T.CNSFPAG    = #TH.CNSFPAG 
              LEFT JOIN FTR  ON #TH.N_FACTURA = FTR.N_FACTURA 
              LEFT JOIN TTEC ON TTEC.TIPO     = FTR.TIPOTTEC 
      WHERE #TH.VLRGLOSA>0
      GROUP BY TTEC.CUENTARAD, #T.IDTERCERO, #TH.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#T.FECHA), 
              #TH.CODUNG, #TH.CODPRG   
      PRINT 'Poniendo Estado de CONTABILIZADA en La Tabla FPAG'
      
      
      --EXEC SPK_REVISAR_COMPROBANTE @COMPANIA,@NROCOMPROBANTE
      EXEC SPK_NC_REVISAMCPE @NROCOMPROBANTE, @COMPANIA, @USUARIO, @SEDE, @SYS_COMPUTERNAME 
      -- EXEC SPK_SUMA_DBCR @NROCOMPROBANTE
      
      DROP TABLE #T
      DROP TABLE #TH   
      
      RETURN                               
   END
   
   PRINT 'Contabilizando Impuestos...' 
   IF @VALORIMPUESTOS>0
   BEGIN 
      INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                       REFERENCIA2, REFERENCIA3, ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO, ESTADO, PROCESO, GENERA, 
                       CLASECONT, VALOR_PORCIMP, BASE_IMP, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, 
                       CODUNG, CODPRG)
      SELECT @NROCOMPROBANTE, @COMPANIA, 'DB', FIMPDV.CUENTA, #T.IDTERCERO, '' AS CCOSTO, 
	            'IMP POR '+FIMPDV.IDIMPUESTO+' CLASE '+FIMPDV.IDCLASE+' FA ' + #TH.N_FACTURA, 
             SUM(FPAGDI.VLRIMPUESTO), FIMPDV.IDIMPUESTO, FIMPDV.IDCLASE, FIMPDV.ITEM, NULL, @USUARIO, 
             DBO.FNK_FECHA_SIN_MLS(GETDATE()), '' AS IDAREA, '' AS PREFIJO, 1, 'CXC_IMPUESTOS', 
            'Movimiento','S', FIMPDV.VALOR,FPAGDI.BASE,#TH.N_FACTURA,
            DBO.FNK_FECHA_SIN_HORA(#T.FECHA),DBO.FNK_FECHA_SIN_HORA(#T.FECHA),'CXC',@CNSFPAG, #TH.CODUNG, #TH.CODPRG
      FROM   #T, #TH INNER JOIN FPAGDI ON #TH.CNSFPAG       = FPAGDI.CNSFPAG 
                                    AND #TH.N_FACTURA     = FPAGDI.N_FACTURA 
                                    AND #TH.ITEM          = FPAGDI.ITEM 
                    LEFT JOIN FIMPDV ON FPAGDI.IDIMPUESTO = FIMPDV.IDIMPUESTO 
                                    AND FPAGDI.IDCLASE    = FIMPDV.IDCLASE 
                                    AND FIMPDV.ITEM       = FPAGDI.ITEMFIMPDV
      WHERE  FPAGDI.VLRIMPUESTO > 0   
      GROUP BY FIMPDV.CUENTA, IDTERCERO, #TH.N_FACTURA,#T.IDTERCERO,#TH.N_FACTURA,
             FIMPDV.IDIMPUESTO,FIMPDV.IDCLASE,FIMPDV.ITEM,FIMPDV.VALOR,FPAGDI.BASE,
             DBO.FNK_FECHA_SIN_HORA(#T.FECHA), #TH.CODUNG, #TH.CODPRG
   END
   
   IF @VALORGLOSAS>0 AND @INGRESO<>'DEVOLUCION'
   BEGIN 
      IF (SELECT MCUEORDEN_GLOSAS FROM PAR WHERE COMPANIA=@COMPANIA)='Si'
      BEGIN
         PRINT 'Contabilizando DB Glosas con Cuentas de Orden...' 
         INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                         REFERENCIA2, ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO, ESTADO, PROCESO, GENERA,    
                         CLASECONT, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
         SELECT @NROCOMPROBANTE, @COMPANIA, 'DB', ISNULL(TTEC.CUEORDENGLOSADB,''), 
                #T.IDTERCERO,'' AS CCOSTO, 'CUENTA DE ORDEN POR GLOSAS DE FA '+#TH.N_FACTURA, SUM(#TH.VLRGLOSA), #TH.CNSFPAG,#TH.CNSCXC,LTRIM(RTRIM(STR(#TH.ITEM))) , @USUARIO, 
                DBO.FNK_FECHA_SIN_MLS(GETDATE()), '' AS IDAREA, '' AS PREFIJO, 1, 
                'CUEORDENGLOSADB', 'Movimiento','S', #TH.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#T.FECHA), 
                DBO.FNK_FECHA_SIN_HORA(#T.FECHA),'CXC',@CNSFPAG, #TH.CODUNG, #TH.CODPRG
         FROM  #T INNER JOIN #TH  ON #T.CNSFPAG    = #TH.CNSFPAG 
               LEFT JOIN FTR  ON #TH.N_FACTURA = FTR.N_FACTURA 
               LEFT JOIN TTEC ON TTEC.TIPO     = FTR.TIPOTTEC /*LEFT JOIN
               PPT ON PPT.IDTERCERO = #T.IDTERCERO AND PPT.IDPLAN = #TH.IDPLAN LEFT JOIN
               TTEC TTEC2 ON PPT.TIPOTERCONTABLE = TTEC2.TIPO*/
         WHERE #TH.VLRGLOSA>0
         GROUP BY TTEC.CUEORDENGLOSADB, #T.IDTERCERO, #TH.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#T.FECHA), 
                 #TH.CODUNG, #TH.CODPRG,#TH.CNSFPAG,#TH.CNSCXC,LTRIM(RTRIM(STR(#TH.ITEM)))     
               
         PRINT 'Contabilizando CR Glosas con Cuentas de Orden...' 
         INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                         REFERENCIA2, ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO, ESTADO, PROCESO, GENERA,    
                         CLASECONT, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
         SELECT @NROCOMPROBANTE, @COMPANIA, 'CR', ISNULL(TTEC.CUEORDENGLOSACR,''), 
                #T.IDTERCERO,'' AS CCOSTO, 'CUENTA DE ORDEN POR GLOSAS DE FA '+#TH.N_FACTURA, SUM(#TH.VLRGLOSA), #TH.CNSFPAG,#TH.CNSCXC,LTRIM(RTRIM(STR(#TH.ITEM))), @USUARIO, 
                DBO.FNK_FECHA_SIN_MLS(GETDATE()), '' AS IDAREA, '' AS PREFIJO, 1, 
                'CUEORDENGLOSACR', 'Movimiento','S', #TH.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#T.FECHA), 
                DBO.FNK_FECHA_SIN_HORA(#T.FECHA),'CXC',@CNSFPAG, #TH.CODUNG, #TH.CODPRG
         FROM #T  INNER JOIN #TH  ON #T.CNSFPAG    = #TH.CNSFPAG 
                  LEFT JOIN FTR  ON #TH.N_FACTURA = FTR.N_FACTURA 
                  LEFT JOIN TTEC ON TTEC.TIPO     = FTR.TIPOTTEC /*LEFT JOIN
               PPT ON PPT.IDTERCERO = #T.IDTERCERO AND PPT.IDPLAN = #TH.IDPLAN LEFT JOIN
               TTEC TTEC2 ON PPT.TIPOTERCONTABLE = TTEC2.TIPO*/
         WHERE #TH.VLRGLOSA>0
         GROUP BY TTEC.CUEORDENGLOSACR, #T.IDTERCERO, #TH.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#T.FECHA), 
                 #TH.CODUNG, #TH.CODPRG,#TH.CNSFPAG,#TH.CNSCXC,LTRIM(RTRIM(STR(#TH.ITEM)))    
      END
      ELSE
      BEGIN
         IF DBO.FNK_VALORVARIABLE('CONTGLOSA_PORTTEC') = 'SI'
         BEGIN
            PRINT 'Contabilizando Glosas... Por Tercero Contable (TTEC)' 
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                            REFERENCIA2, ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO, ESTADO, PROCESO, GENERA,    
                            CLASECONT, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
            SELECT @NROCOMPROBANTE, @COMPANIA, 'DB', ISNULL(TTEC.CTAGLOSADB,'NO DEF.TTEC'),  
                   #T.IDTERCERO,'' AS CCOSTO, LEFT(('GLOSAS DE FA '+#TH.N_FACTURA+CASE WHEN COALESCE(#TH.OBSERVACION,'')<>'' THEN ' RAZON O MOTIVO:'+COALESCE(#TH.OBSERVACION,'') ELSE '' END),512),
				   SUM(#TH.VLRGLOSA), #TH.CNSFPAG,#TH.CNSCXC,LTRIM(RTRIM(STR(#TH.ITEM))), @USUARIO, 
                   DBO.FNK_FECHA_SIN_MLS(GETDATE()), '' AS IDAREA, '' AS PREFIJO, 1, 
                   'CXC_GLOSAS', 'Movimiento','S', #TH.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#T.FECHA), 
                   DBO.FNK_FECHA_SIN_HORA(#T.FECHA),'CXC',@CNSFPAG, #TH.CODUNG, #TH.CODPRG
            FROM #T INNER JOIN #TH  ON #T.CNSFPAG    = #TH.CNSFPAG 
                    LEFT JOIN FTR  ON #TH.N_FACTURA = FTR.N_FACTURA 
                    LEFT JOIN TTEC ON TTEC.TIPO     = FTR.TIPOTTEC 
            WHERE #TH.VLRGLOSA>0
            GROUP BY TTEC.CTAGLOSADB, #T.IDTERCERO, #TH.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#T.FECHA), 
                    #TH.CODUNG, #TH.CODPRG,#TH.CNSFPAG,#TH.CNSCXC,LTRIM(RTRIM(STR(#TH.ITEM))),
					COALESCE(#TH.OBSERVACION,'')   
         END
         ELSE
         BEGIN
            PRINT 'Contabilizando Glosas... Por Dedicible (KCDE)' 
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                            REFERENCIA2, ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO, ESTADO, PROCESO, GENERA,    
                            CLASECONT, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
            SELECT @NROCOMPROBANTE, @COMPANIA, 'DB', CASE WHEN CUE.CUENTA IS NULL THEN 'NO DEF.KCDE' ELSE CUE.CUENTA END, 
                   IDTERCERO,'' AS CCOSTO, LEFT(('GLOSAS DE FA '+N_FACTURA+CASE WHEN COALESCE(#TH.OBSERVACION,'')<>'' THEN ' RAZON O MOTIVO:'+COALESCE(#TH.OBSERVACION,'') ELSE '' END),512),
				    SUM(#TH.VLRGLOSA), #TH.CNSFPAG,#TH.CNSCXC,LTRIM(RTRIM(STR(#TH.ITEM))), @USUARIO, 
                   DBO.FNK_FECHA_SIN_MLS(GETDATE()), '' AS IDAREA, '' AS PREFIJO, 1, 
                  'CXC_GLOSAS', 'Movimiento','S', N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#T.FECHA), 
                  DBO.FNK_FECHA_SIN_HORA(#T.FECHA),'CXC',@CNSFPAG, #TH.CODUNG, #TH.CODPRG
            FROM #T,#TH LEFT JOIN KCDE ON KCDE.IDMODELOCONT = @IDMODELOCONT AND KCDE.TIPO='CXC_GLOSAS' 
                        LEFT JOIN CUE  ON KCDE.CUENTA       = CUE.CUENTA    AND CUE.COMPANIA=@COMPANIA
            WHERE #TH.VLRGLOSA>0
            GROUP BY CUE.CUENTA, IDTERCERO, N_FACTURA,DBO.FNK_FECHA_SIN_HORA(#T.FECHA), #TH.CODUNG, #TH.CODPRG,#TH.CNSFPAG,#TH.CNSCXC,LTRIM(RTRIM(STR(#TH.ITEM))),
			COALESCE(#TH.OBSERVACION,'')
         END
      END
   END
   --SELECT * FROM FPAGD
   IF @VLRDTOFINAN>0 
   BEGIN
      PRINT 'Descuento financiero...'
      INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                      REFERENCIA2, ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO, ESTADO, PROCESO, GENERA,    
                      CLASECONT, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
      SELECT @NROCOMPROBANTE, @COMPANIA, 'DB',CASE WHEN COALESCE(DBO.FNK_VALORVARIABLE('CTADTOFINANCIERO'),'')=''
                                               THEN 'NO DEF.DTOFIN' ELSE DBO.FNK_VALORVARIABLE('CTADTOFINANCIERO') END, 
             IDTERCERO,'' AS CCOSTO, 'DESCUENTO FINANANCIERO '+N_FACTURA, SUM(#TH.VLRDTOFIN), NULL, NULL, NULL, @USUARIO, 
             DBO.FNK_FECHA_SIN_MLS(GETDATE()), '' AS IDAREA, '' AS PREFIJO, 1, 
             'CXC_DTOFINAN', 'Movimiento','S', N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#T.FECHA), 
             DBO.FNK_FECHA_SIN_HORA(#T.FECHA),'CXC',@CNSFPAG, #TH.CODUNG, #TH.CODPRG
      FROM #T,#TH 
      WHERE #TH.VLRDTOFIN>0
      GROUP BY IDTERCERO, N_FACTURA,DBO.FNK_FECHA_SIN_HORA(#T.FECHA), #TH.CODUNG, #TH.CODPRG    
   END
   IF COALESCE(@VLR_DTO_IND,0)>0
   BEGIN
     PRINT 'Descuentos En recuados...'
      INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                      REFERENCIA2, ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO, ESTADO, PROCESO, GENERA,    
                      CLASECONT, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
      SELECT @NROCOMPROBANTE, @COMPANIA, 'DB',CASE WHEN COALESCE(DBO.FNK_VALORVARIABLE('CTA_DTO_IND_RECA_CXC'),'')=''
                                               THEN 'NO DEF DTO_IND' ELSE DBO.FNK_VALORVARIABLE('CTA_DTO_IND_RECA_CXC') END, 
             IDTERCERO,'' AS CCOSTO, 'DESCUENTOS EN RECAUDOS DE FACTURA: '+N_FACTURA,SUM(ABS(COALESCE(#TH.VLROTROSDCTOS,0))), NULL, NULL, NULL, @USUARIO, 
             DBO.FNK_FECHA_SIN_MLS(GETDATE()), '' AS IDAREA, '' AS PREFIJO, 1, 
             'CXC_DTO_IND', 'Movimiento','S', N_FACTURA, DBO.FNK_FECHA_SIN_HORA(#T.FECHA), 
             DBO.FNK_FECHA_SIN_HORA(#T.FECHA),'CXC',@CNSFPAG, #TH.CODUNG, #TH.CODPRG
      FROM #T,#TH 
      WHERE ABS(COALESCE(#TH.VLROTROSDCTOS,0))>0
      GROUP BY IDTERCERO, N_FACTURA,DBO.FNK_FECHA_SIN_HORA(#T.FECHA), #TH.CODUNG, #TH.CODPRG 
   END
   IF @VLRAJUSTEPESO>0
   BEGIN
      IF @VLRAJUSTEPESO <= convert(decimal(14,2), DBO.FNK_VALORVARIABLE('RECAU_VLLIMITE_APROV')) 
      BEGIN
         IF EXISTS(SELECT TIPO FROM KCDE WHERE TIPO='CXC_AJ_AFAVOR')
         BEGIN
            PRINT 'Contabilizando Ajuste al Peso a Favor...Aprov' 
            --EL VALOR AJUSTE AL PESO ESTA DENTRO DEL VALOR PARA SER CONSIDERADO APROVECHAMIENTO
            
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                             REFERENCIA2, ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO, ESTADO, PROCESO, GENERA, 
                             CLASECONT, PROCEDENCIA, REFERENCIA_PRO)
            SELECT @NROCOMPROBANTE, @COMPANIA, 'CR', KCDE.CUENTA, IDTERCERO,'' AS CCOSTO, 
	                  'AJUSTE AL PESO ', ABS(#T.VLRAJUSTEPESO), NULL, NULL, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()),
	                  '' AS IDAREA, '' AS PREFIJO, 1, 'CXC_AJ_AFAVOR', 'Movimiento','S','CXC',@CNSFPAG
            FROM #T,KCDE
            WHERE KCDE.IDMODELOCONT=@IDMODELOCONT AND KCDE.TIPO='CXC_AJ_AFAVOR' AND #T.VLRAJUSTEPESO>0
         END
         ELSE
         BEGIN
            PRINT 'Contabilizando Ajueste con Error... (No Existe KCDE=CXC_AJ_AFAVOR)' 
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                            REFERENCIA2, ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO, ESTADO, PROCESO, GENERA, 
                            CLASECONT, PROCEDENCIA, REFERENCIA_PRO)
            SELECT @NROCOMPROBANTE, @COMPANIA, 'CR', 'NO DEF.KCDE', IDTERCERO,'' AS CCOSTO, 
	                 'AJUSTE AL PESO ', ABS(#T.VLRAJUSTEPESO), NULL, NULL, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()),
	                 '' AS IDAREA, '' AS PREFIJO, 1, 'CXC_AJ_AFAVOR', 'Movimiento','S','CXC',@CNSFPAG
            FROM #T
            WHERE #T.VLRAJUSTEPESO>0
         END
      END
      ELSE
      BEGIN --ESTA POR ENCIMA DEL LIMITE ENTONCES ES REINTEGRO POR PAGAR
         IF EXISTS(SELECT TIPO FROM KCDE WHERE TIPO='CXC_AJ_AFAVOR_REI')
         BEGIN
            PRINT 'Contabilizando Ajuste al Peso a Favor...Reintegro por Pagar' 
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                            REFERENCIA2, ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO, ESTADO, PROCESO, GENERA, 
                            CLASECONT, PROCEDENCIA, REFERENCIA_PRO)
            SELECT @NROCOMPROBANTE, @COMPANIA, 'CR', KCDE.CUENTA, IDTERCERO,'' AS CCOSTO, 
	                  'AJUSTE AL PESO ', ABS(#T.VLRAJUSTEPESO), NULL, NULL, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()),
	                  '' AS IDAREA, '' AS PREFIJO, 1, 'CXC_AJ_AFAVOR_REI', 'Movimiento','S','CXC',@CNSFPAG
            FROM #T,KCDE
            WHERE KCDE.IDMODELOCONT=@IDMODELOCONT AND KCDE.TIPO='CXC_AJ_AFAVOR_REI' AND #T.VLRAJUSTEPESO>0
         END
         ELSE
         BEGIN
            PRINT 'Contabilizando Ajuste con Error... (No Existe KCDE=CXC_AJ_AFAVOR_REI)' 
            INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                             REFERENCIA2, ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO, ESTADO, PROCESO, GENERA, 
                             CLASECONT, PROCEDENCIA, REFERENCIA_PRO)
            SELECT @NROCOMPROBANTE, @COMPANIA, 'CR', 'NO DEF.KCDE', IDTERCERO,'' AS CCOSTO, 
	                  'AJUSTE AL PESO ', ABS(#T.VLRAJUSTEPESO), NULL, NULL, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()),
	                  '' AS IDAREA, '' AS PREFIJO, 1, 'CXC_AJ_AFAVOR_REI', 'Movimiento','S','CXC',@CNSFPAG
            FROM #T,KCDE
            WHERE #T.VLRAJUSTEPESO>0
         END
      END
   END
   IF @VLRAJUSTEPESO<0
   BEGIN
      IF EXISTS(SELECT TIPO FROM KCDE WHERE TIPO='CXC_AJ_ENCONTRA')
      BEGIN
         PRINT 'Contabilizando Ajuste al Peso En Contra...' 
         INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                         REFERENCIA2, ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO, ESTADO, PROCESO, GENERA, 
                         CLASECONT, PROCEDENCIA, REFERENCIA_PRO)
         SELECT @NROCOMPROBANTE, @COMPANIA, 'DB', KCDE.CUENTA, IDTERCERO,'' AS CCOSTO, 
	        'AJUSTE AL PESO ', ABS(#T.VLRAJUSTEPESO), NULL, NULL, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()),
	        '' AS IDAREA, '' AS PREFIJO, 1, 'CXC_AJ_ENCONTRA', 'Movimiento','S','CXC',@CNSFPAG
         FROM #T,KCDE
         WHERE KCDE.IDMODELOCONT=@IDMODELOCONT AND KCDE.TIPO='CXC_AJ_ENCONTRA' AND #T.VLRAJUSTEPESO<0
      END
      ELSE
      BEGIN
         PRINT 'Contabilizando Ajueste con Error... (No Existe KCDE=CXC_AJ_ENCONTRA)' 
         INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                         REFERENCIA2, ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO, ESTADO, PROCESO, GENERA, 
                         CLASECONT, PROCEDENCIA, REFERENCIA_PRO)
         SELECT @NROCOMPROBANTE, @COMPANIA, 'DB', 'NO DEF.KCDE', IDTERCERO,'' AS CCOSTO, 
	        'AJUSTE AL PESO ', ABS(#T.VLRAJUSTEPESO), NULL, NULL, NULL, @USUARIO, DBO.FNK_FECHA_SIN_MLS(GETDATE()),
	        '' AS IDAREA, '' AS PREFIJO, 1, 'CXC_AJ_ENCONTRA', 'Movimiento','S','CXC',@CNSFPAG
         FROM #T
         WHERE #T.VLRAJUSTEPESO>0
      END
   END
   
   PRINT 'Contabilizando CR a la CxC del Cliente...' 
   
   -- MOD.JQUIROGA 20090523 - REQ.1641
   INSERT INTO MCHE(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR ,REFERENCIA1,
                 	 REFERENCIA2 ,ITEMREF, USUARIO, FECHA, IDAREA, PREFIJO,ESTADO, PROCESO, GENERA, 
                   CLASECONT, N_FACTURA, F_FACTURAREF, F_VENCE, PROCEDENCIA, REFERENCIA_PRO, CODUNG, CODPRG)
   SELECT @NROCOMPROBANTE, @COMPANIA, 'CR', 
          CASE WHEN COALESCE(FTR.CASTIGADA,0)=1 AND TCOBRO='Castigo'  THEN DBO.FNK_VALORVARIABLE('CUENTA_CART_CASTI') 
               WHEN  COALESCE(FTR.CASTIGADA,0)=1 AND TCOBRO='Dificil' THEN (SELECT B.CUEDIFCOB FROM FTR A INNER JOIN TTEC B ON A.TIPOTTEC=B.TIPO
                                                                            WHERE A.N_FACTURA=#TH.N_FACTURA)  ELSE
             CASE WHEN UPPER(DBO.FNK_VALORVARIABLE('CONTABCXC')) = 'NO' THEN
		                     CASE WHEN UPPER(DBO.FNK_VALORVARIABLE('MAN_CTAS_DE_MORA')) = 'SI' THEN 
			                              CASE WHEN DATEDIFF(DAY, FTR.F_VENCE, GETDATE()) <= 360 THEN
		                                         CASE WHEN FCXC.ANTIGUA = 1 THEN 
		                                                   CASE WHEN ISNULL(FCXCD.CUENTA,'')='' THEN
		                                                             ISNULL((SELECT CUENTA FROM TTEC, PPT 
		                                                                     WHERE TTEC.TIPO = PPT.TIPOTERCONTABLE AND PPT.IDPLAN=FCXCD.IDPLAN AND 
		                                                                     PPT.IDTERCERO=FCXC.IDTERCERO),'NO DEF.TTEC')
		                                                        ELSE
		                                                             FCXCD.CUENTA
		                                                    END
		                                              ELSE
		                                                   CASE WHEN ISNULL(FCXCD.CUENTA,'')='' THEN
		                                                         ISNULL(FTR.CUENTACXC,'NO DEF.FTR')
		                                                        ELSE
		                                                        FCXCD.CUENTA
		                                                   END
					                                      END	
				                                  WHEN DATEDIFF(DAY, FTR.F_VENCE, GETDATE()) BETWEEN 360 AND 720 THEN DBO.FNK_VALORVARIABLE('CTA_FPAG_360_a_720')
				                                  WHEN DATEDIFF(DAY, FTR.F_VENCE, GETDATE()) BETWEEN 721 AND 1440 THEN DBO.FNK_VALORVARIABLE('CTA_FPAG_721_a_1440')
				                                  WHEN DATEDIFF(DAY, FTR.F_VENCE, GETDATE()) >= 1441 THEN DBO.FNK_VALORVARIABLE('CTA_FPAG_1441_SUPERI')
				                                  ELSE
					                                 'NO DEF.'
			                              END
		                          ELSE
			                             CASE WHEN FCXC.ANTIGUA = 1 THEN 
				                                      CASE WHEN ISNULL(FCXCD.CUENTA,'')='' THEN
						                                              ISNULL((SELECT CUENTA FROM TTEC, PPT 
						                                              WHERE TTEC.TIPO = PPT.TIPOTERCONTABLE AND PPT.IDPLAN=FCXCD.IDPLAN AND 
									                                           PPT.IDTERCERO=FCXC.IDTERCERO),'NO DEF.TTEC')
					                                          ELSE
						                                             FCXCD.CUENTA
				                                       END
				                                 ELSE
				                                     CASE WHEN ISNULL(FCXCD.CUENTA,'')='' THEN
						                                              ISNULL(FTR.CUENTACXC,'NO DEF.FTR')
					                                          ELSE
						                                             FCXCD.CUENTA
				                                     END
		  	                               END
                       END
             ELSE  
                  CASE   WHEN #TH.CLASE='F' THEN (
                                                   SELECT CASE WHEN @INGRESO='CAJA' AND PROCEDENCIA='CAJA' THEN B.CUENTA ELSE B.CUENTARAD END FROM FTR A INNER JOIN TTEC B ON A.TIPOTTEC=B.TIPO
                                                   WHERE A.N_FACTURA=#TH.N_FACTURA
                                                   ) 
                          WHEN #TH.CLASE='G' THEN (
                                                   SELECT B.CUENTALG FROM FTR A INNER JOIN TTEC B ON A.TIPOTTEC=B.TIPO
                                                   WHERE A.N_FACTURA=#TH.N_FACTURA
                                                   ) 
                          WHEN #TH.CLASE='R' THEN (
                                                   SELECT B.CUENTALG FROM FTR A INNER JOIN TTEC B ON A.TIPOTTEC=B.TIPO
                                                   WHERE A.N_FACTURA=#TH.N_FACTURA
                                                   )  
                          WHEN #TH.CLASE='C' THEN (
                                                   SELECT B.CUENTACG FROM FTR A INNER JOIN TTEC B ON A.TIPOTTEC=B.TIPO
                                                   WHERE A.N_FACTURA=#TH.N_FACTURA
                                                   )                                                                                                                                       
                   END
             END
         END,
         FTR.IDTERCERO, '' AS CCOSTO,
         CASE WHEN FCXC.ANTIGUA = 1 THEN 
               CASE WHEN ISNULL(FCXCD.IDPLAN,'')='' THEN
                    'NO EXISTE EL PLAN EN EL DETALLE DE LA CXC (FCXCD.IDPLAN), FA: '+#TH.N_FACTURA
                    ELSE
                     ISNULL((SELECT RTRIM(TTEC.DETALLE)+' FA: '+#TH.N_FACTURA FROM TTEC,PPT 
                            WHERE TTEC.TIPO = PPT.TIPOTERCONTABLE AND PPT.IDPLAN=FCXCD.IDPLAN AND 
                                 PPT.IDTERCERO=FCXC.IDTERCERO),'NO EXISTE EL PLAN EN EL DETALLE DE LA CXC (FCXCD.IDPLAN)')
               END
             ELSE
              CASE WHEN ISNULL(FTR.TIPOTTEC,'')='' THEN
                    ISNULL((SELECT RTRIM(TTEC.DETALLE)+' FA: '+#TH.N_FACTURA FROM TTEC,PPT 
                           WHERE TTEC.TIPO = PPT.TIPOTERCONTABLE AND PPT.IDPLAN=FCXCD.IDPLAN AND 
                                 PPT.IDTERCERO=FCXC.IDTERCERO),'NO EXISTE O NO HAY RELACION CON TERCEROS CONTABLES DEL PLAN DE LA FACTURA (FTR.IDPLAN)')
                   ELSE
                    ISNULL((SELECT RTRIM(TTEC.DETALLE)+' FA: '+#TH.N_FACTURA FROM TTEC 
                            WHERE TTEC.TIPO = FTR.TIPOTTEC),'NO EXISTE EL TIPO DE TERCERO DE LA FACTURA (FTR.TIPOTTEC)')
              END
        END, 
        CASE WHEN PAR.MCUEORDEN_GLOSAS='Si' THEN  SUM(COALESCE( #TH.VLRFACTURA,0)- COALESCE( #TH.VLRGLOSA,0)+COALESCE(#TH.VLRDTOFIN,0))
        --+COALESCE(#TH.VLROTROSDCTOS,0)) 
        ELSE CASE WHEN #T.INGRESO='GLOSAS' THEN SUM(COALESCE(#TH.VLRGLOSA,0)) ELSE SUM(COALESCE( #TH.VALORPAGO,0))+SUM(COALESCE(#TH.VLRIMPUESTO,0))+SUM(COALESCE(#TH.VLRDTOFIN,0))
        --+SUM(COALESCE(#TH.VLROTROSDCTOS,0))
        END END,
        #TH.CNSFPAG,#TH.CNSCXC,LTRIM(RTRIM(STR(#TH.ITEM))), @USUARIO,DBO.FNK_FECHA_SIN_MLS(GETDATE()), 
        '' AS IDAREA, '' AS PREFIJO, 1, 'CXC_CLIENTE', 'Movimiento','S',
        #TH.N_FACTURA, DBO.FNK_FECHA_SIN_HORA(FCXC.FECHACXC), DBO.FNK_FECHA_SIN_HORA(FCXC.F_VENCE), 'CXC', @CNSFPAG, 
        #TH.CODUNG, #TH.CODPRG
   FROM PAR,#T INNER JOIN #TH ON #T.CNSFPAG=#TH.CNSFPAG 
			   INNER JOIN FTR ON FTR.N_FACTURA = #TH.N_FACTURA
			   INNER JOIN FCXCD ON FCXCD.N_FACTURA=#TH.N_FACTURA
			   INNER JOIN FCXC ON FCXC.CNSCXC = FCXCD.CNSCXC --AND FCXC.IDTERCERO = #T.IDTERCERO
               --INNER JOIN FCXCDV ON #TH.N_fACTURA=FCXCDV.N_FACTURA AND #TH.CNSCXC=FCXCDV.CNSGLO AND #TH.CNSGLO=FCXCDV.CNSGLO AND #TH.CLASE=FCXCDV.TIPO
			   INNER JOIN FCXCDV ON #TH.N_fACTURA=FCXCDV.N_FACTURA AND #TH.CNSCXC=FCXCDV.CNSCXC AND COALESCE(#TH.CNSGLO,'')=COALESCE(FCXCDV.CNSGLO,'') AND #TH.CLASE=FCXCDV.TIPO
			   -- JGOMEZ REALIZA CAMBIO PARA EVITAR DUPLICADOS
			    AND #TH.CNSCXC=FCXC.CNSCXC
   WHERE PAR.COMPANIA=@COMPANIA AND (CASE WHEN #T.INGRESO='GLOSAS' THEN #TH.VLRGLOSA ELSE COALESCE(#TH.VALORPAGO,0)+COALESCE(#TH.VLRIMPUESTO,0)+COALESCE(#TH.VLRDTOFIN,0) END )>0
   GROUP BY FCXC.IDTERCERO, #TH.N_FACTURA, FTR.CUENTACXC, FTR.PROCEDENCIA, FTR.TIPOTTEC, PAR.MCUEORDEN_GLOSAS, 
             DBO.FNK_FECHA_SIN_HORA(FCXC.FECHACXC), DBO.FNK_FECHA_SIN_HORA(FCXC.F_VENCE), FCXCD.CUENTA, FCXC.ANTIGUA,
             FCXCD.IDPLAN, #T.IDTERCERO, FTR.IDTERCERO, #TH.CODUNG, #TH.CODPRG,FTR.F_VENCE,#TH.CLASE, COALESCE(FTR.CASTIGADA,0),
             #TH.CNSFPAG,#TH.CNSCXC,LTRIM(RTRIM(STR(#TH.ITEM))),#T.INGRESO,FCXCDV.TCOBRO
   HAVING CASE WHEN PAR.MCUEORDEN_GLOSAS='Si' THEN SUM(COALESCE( #TH.VLRFACTURA,0)- COALESCE( #TH.VLRGLOSA,0)) ELSE SUM(#TH.VLRFACTURA) END <>0

	--SE GENERA UN NUEVO COMPROBANTE POR FACTURA SI TIENE PAGOS EXTRAS JFRANCO 25/04/2020
	IF (SELECT COUNT(*) FROM #TH WHERE CNSFPAG = @CNSFPAG AND COALESCE(VLREXTRA, 0)> 0 ) > 0
	BEGIN
		PRINT 'Ingreso a Contabilizar Valores Extras'
		EXEC SPK_NC_CONTAB_CXC_VLREXTRA @CNSFPAG, @USUARIO, @SYS_COMPUTERNAME, @COMPANIA, @SEDE
	END

   -- SE BORRA LO QUE ESTABA COMENTARIZADO JJIMENEZ 30-04-14 QUEDA EN BACKUP ANTERIORES  
   PRINT 'Poniendo Estado de CONTABILIZADA en La Tabla FPAG'
  
   
   ----EXEC SPK_REVISAR_COMPROBANTE @COMPANIA,@NROCOMPROBANTE
   EXEC SPK_NC_REVISAMCPE @NROCOMPROBANTE, @COMPANIA, @USUARIO, @SEDE, @SYS_COMPUTERNAME 
   EXEC SPK_PASA_MCP_MCPNIIF @NROCOMPROBANTE, @COMPANIA, @USUARIO, @SYS_COMPUTERNAME, @SEDE,@COM,''
   -- EXEC SPK_SUMA_DBCR @NROCOMPROBANTE
   
   DROP TABLE #T
   DROP TABLE #TH
END






