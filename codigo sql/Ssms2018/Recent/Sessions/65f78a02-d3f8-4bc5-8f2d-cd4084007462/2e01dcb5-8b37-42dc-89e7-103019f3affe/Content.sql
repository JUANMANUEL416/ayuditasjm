CREATE OR ALTER PROCEDURE  DBO.SPQ_FTR_IMPRESION 
@JSON  NVARCHAR(MAX)
WITH ENCRYPTION
AS  
DECLARE	 @PARAMETROS  NVARCHAR(MAX)     
         ,@MODELO    VARCHAR(100)         
         ,@METODO    VARCHAR(100)	
         ,@USUARIO      VARCHAR(12)
DECLARE @EXISTE INT     
DECLARE @N_FACTURA VARCHAR(20)
DECLARE @PROCEDENCIA VARCHAR(10)
DECLARE @IDFORMATOFTR VARCHAR(20)
DECLARE @TIPOFAC    VARCHAR(2)
DECLARE @NOREFERENCIA VARCHAR(20)
DECLARE @IMPRIMEIDALTERNA SMALLINT
DECLARE @NROAFIS SMALLINT
DECLARE @IDSEDE VARCHAR(5)
DECLARE @VLLETRAS VARCHAR(1024)
DECLARE @NROLETRAS SMALLINT
DECLARE @REFERENCIA VARCHAR(20)
DECLARE @NOAUT VARCHAR(20)
DECLARE @VENDEDOR VARCHAR(20)
DECLARE @F_FACTURA  DATETIME
DECLARE @USUFACTURA VARCHAR(20)
DECLARE @NOMBREFACTU VARCHAR(120)
DECLARE @IDFIRMA VARCHAR(20)
DECLARE @EQUIPO VARCHAR(256)
DECLARE @FIMPRESION VARCHAR(70)
DECLARE @ENTERO BIT
DECLARE @IXCOUNTRY VARCHAR(20)
DECLARE @VLR_AFECTO DECIMAL(14,2)
DECLARE @VLR_INAFECTO DECIMAL(14,2)
BEGIN  
	SET DATEFORMAT dmy
   SET LANGUAGE Spanish;
	SELECT *
	INTO #JSON
	FROM OPENJSON (@json)
	WITH (
		MODELO         VARCHAR(100)     '$.MODELO',
		METODO         VARCHAR(100)     '$.METODO',
		USUARIO        VARCHAR(12)      '$.USUARIO',
		PARAMETROS     NVARCHAR(MAX)  AS JSON
	)
	SELECT @MODELO = MODELO , @METODO = METODO , @PARAMETROS = PARAMETROS, @USUARIO = USUARIO
	FROM #JSON
	DECLARE @TBLERRORES TABLE(ERROR VARCHAR(200)); 
   
	SELECT @N_FACTURA =  N_FACTURA
	FROM OPENJSON (@PARAMETROS)
	WITH (N_FACTURA       VARCHAR(20)    '$.N_FACTURA')
   SELECT @IXCOUNTRY = DBO.FNK_VALORVARIABLE('IXCOUNTRY')
   IF @METODO='DATOSFTR'
   BEGIN
      SELECT @PROCEDENCIA=PROCEDENCIA,@IDFORMATOFTR=COALESCE(IDFORMATO,''),@TIPOFAC=TIPOFAC, @NOREFERENCIA=NOREFERENCIA,
             @IMPRIMEIDALTERNA=COALESCE(PPT.IMPRIMEIDALTERNA,0),@IDSEDE=FTR.IDSEDE,
              @VLLETRAS=LTRIM(RTRIM(TRIM(DBO.FNK_DE_VALORES_A_LETRAS(FTR.VR_TOTAL)))),
              @REFERENCIA=NOREFERENCIA,@VENDEDOR=VENDEDOR,@USUFACTURA=FTR.USUARIOFACTURA
      FROM FTR LEFT  JOIN PPT ON FTR.IDTERCERO=PPT.IDTERCERO AND FTR.IDPLAN=PPT.IDPLAN
      WHERE N_FACTURA=@N_FACTURA
      IF CHARINDEX('/100',@VLLETRAS,1)>0 AND @IXCOUNTRY<>'PERU'
      BEGIN 
         SELECT @NROLETRAS=LEN(@VLLETRAS)-8
         SELECT @VLLETRAS=SUBSTRING(@VLLETRAS,0,@NROLETRAS)
      END
      ELSE
      BEGIN 
         IF LEN(@VLLETRAS)<4
         BEGIN
            SELECT @VLLETRAS='Cero.'
         END
         IF  @IXCOUNTRY='PERU'
         BEGIN
            IF CHARINDEX('/100',@VLLETRAS,1)=0
            BEGIN
               SELECT @VLLETRAS=@VLLETRAS+' 00/100 '
            END
         END
      END
      SELECT @IDFIRMA=NULL
      IF DBO.FNK_VALORVARIABLE('IDUSUARIO_REPRE')<>''
      BEGIN
         SELECT @IDFIRMA=IDFIRMA,@NOMBREFACTU=NOMBRE FROM USUSU WHERE USUARIO=LTRIM(RTRIM(DBO.FNK_VALORVARIABLE('IDUSUARIO_REPRE')))
      END
      IF COALESCE(@IDFIRMA,'')=''
      BEGIN
         SELECT @IDFIRMA=IDFIRMA,@NOMBREFACTU=NOMBRE FROM USUSU WHERE USUARIO=@USUFACTURA
      END
      SELECT @ENTERO=CASE WHEN DBO.FNK_VALORVARIABLE('IMP_SIN_DECIMAL_FTR')='SI' THEN 1 ELSE 0 END
      SELECT @EQUIPO=COALESCE(SYS_COMPUTERNAME,HOST_NAME()) FROM USUSU WHERE USUARIO=@USUARIO

      SELECT @FIMPRESION= CAST(DAY(GETDATE())AS VARCHAR(2))+' de '+
          UPPER(DATENAME(MONTH,GETDATE()))+' '+
          CAST(YEAR(GETDATE()) AS VARCHAR(4))+'  Hora:'+RIGHT(CONVERT(VARCHAR(20),GETDATE(),100),7)
      IF @IXCOUNTRY='PERU'
      BEGIN
         SELECT @VLR_AFECTO=SUM(CASE WHEN COALESCE(PIVA,0)>0 THEN (COALESCE(VALOR,0)*COALESCE(CANTIDAD,0))-(COALESCE(FTRD.VLR_COPAGOS,0)) ELSE 0 END), 
         @VLR_INAFECTO=SUM(CASE WHEN COALESCE(PIVA,0)=0 THEN (COALESCE(VALOR,0)*COALESCE(CANTIDAD,0))-(COALESCE(FTRD.VLR_COPAGOS,0)) ELSE 0 END)
         FROM FTRD 
         WHERE FTRD.N_FACTURA=@N_FACTURA
         AND COALESCE(PAQUETE,0)<>2
      END

      IF @TIPOFAC='M'
      BEGIN
         PRINT 'Reviso si son varios afiliados o solo uno '
         IF @PROCEDENCIA='CI' OR @REFERENCIA='UNIWEB' 
         BEGIN
            SELECT @NROAFIS=COUNT(1) 
			FROM (
				SELECT DISTINCT IDAFILIADO
				FROM FTRD INNER JOIN CIT ON FTRD.NOADMISION=CIT.CONSECUTIVO
				WHERE FTRD.N_FACTURA=@N_FACTURA
				GROUP BY CIT.IDAFILIADO 
			) X
            PRINT '@NROAFIS ='+STR(@NROAFIS)
         END
         IF  @PROCEDENCIA='CE' AND COALESCE(@NROAFIS,0)=0
         BEGIN
            SELECT @NROAFIS=COUNT(1) 
			FROM(
				SELECT DISTINCT IDAFILIADO
				FROM FTRD INNER JOIN AUT ON FTRD.NOADMISION=AUT.NOAUT
				WHERE FTRD.N_FACTURA=@N_FACTURA
				GROUP BY AUT.IDAFILIADO 
			) X
            PRINT '@NROAFIS CE='+STR(@NROAFIS)


            SELECT TOP 1 @NOAUT= NOADMISION FROM FTRD WHERE N_FACTURA=@N_FACTURA

         END
      END

      IF @PROCEDENCIA NOT IN('FINANCIERO','INVENTARIO')
      BEGIN
         IF  @TIPOFAC='I' OR @TIPOFAC='M' 
         BEGIN
         
            SELECT 'OK'OK,FTR.N_FACTURA,TER.NIT,TER.TIPO_ID,TER.DV,TER.RAZONSOCIAL,TER.IDALTERNA2,TRIM(TER.DIRECCION) DIRECCION,COALESCE(TER.TELEFONOS,'')TELEFONOS,
                   COALESCE(TER.EMAIL,'')EMAIL,UPPER(CIU.NOMBRE) NOMBRE,UPPER(DEP.NOMBRE) AS DPTO,CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,CONVERT(varchar,FECHAFAC,108)HFACTURA,
				   COALESCE(CONVERT(VARCHAR,FTRE.FECHA,103),'')FECHAVAL,CONVERT(VARCHAR,FTRE.FECHA,108)HVALIDA,
                   CONVERT(VARCHAR,F_VENCE,103)F_VENCE,COALESCE(FTR.IDFORMATO,'')IDFORMATO,
                   FTR.PROCEDENCIA,COALESCE(FTR.FACTE,0)ESTDIAN,FTR.VR_ABONOS,
                   CASE WHEN FTR.ESTADO='A' THEN 'ANULADA' ELSE CASE WHEN COALESCE(TIPOANULACION,'')<>'' THEN 'ANULADA NC' ELSE 'OK' END END ESTADO,
                   AFI.DOCIDAFILIADO,AFI.TIPO_DOC,AFI.NOMBREAFI,AFI.EDAD,DBO.FN_EDAD_PACIENTE(AFI.FNACIMIENTO,FTR.F_FACTURA,'ALL') EDAD1,AFI.DIRECCION AS AFI_DIR,AFI.TELEFONORES AS AFI_TEL,
                   AFI.CELULAR,
                   AFI.TIPOAFILIADO, @EQUIPO EQUIPO,@FIMPRESION FIMPRESION,@USUARIO USUARIO,
                    CASE   WHEN AFI.TIPOAFILIADO = 'C' THEN 'Cotizante'
                           WHEN AFI.TIPOAFILIADO = 'B' THEN 'Beneficiario'
                           WHEN AFI.TIPOAFILIADO = 'J' THEN 'Jubilado'
                           WHEN AFI.TIPOAFILIADO = 'A' THEN 'Adicional'
                           WHEN AFI.TIPOAFILIADO = 'S' THEN 'Sustitución Pensional'
                           WHEN AFI.TIPOAFILIADO = 'Sb' THEN 'Subsidiado'
                           WHEN AFI.TIPOAFILIADO = 'SR' THEN 'Sin régimen'
                           WHEN AFI.TIPOAFILIADO = 'TA' THEN 'Tomador/Amparado'
                           WHEN AFI.TIPOAFILIADO = 'RE' THEN 'Régimen Especial'
                           WHEN AFI.TIPOAFILIADO = 'SN' THEN 'Subsidiado'
                           WHEN AFI.TIPOAFILIADO = 'S/' THEN 'Subsidiado'
                           WHEN AFI.TIPOAFILIADO = 'S/N' THEN 'Subsidiado' ELSE '' END TIPOAFI_NOMBRE,
                   AFI.NIVELSOCIOEC,AFI.SEXO, AFI.SISBENNUMFICHA ,AFI.SISBENNIVEL,
                   FTR.IDPLAN,PLN.DESCPLAN,PLN.TIPOSISTEMA,
                   COALESCE(DBO.FNK_VALORVARIABLE('FTR_IMPNOCONTRATO'),'') FTR_IMPNOCONTRATO,
                   CASE WHEN COALESCE(DBO.FNK_VALORVARIABLE('FTR_IMPNOCONTRATO'),'') = 'SI' THEN CASE WHEN  COALESCE(PPT.NROCONTRATO,'')<>'' THEN COALESCE(PPT.NROCONTRATO,'') WHEN COALESCE(PPT.IDCONTRATO,'')<>'' THEN  COALESCE(PPT.IDCONTRATO,'') ELSE '' END END IDCONTRATO,
                   CASE WHEN COALESCE(@NOAUT,'')<>'' THEN @NOAUT ELSE  FTR.NOREFERENCIA END NOREFERENCIA,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTR.VALORSERVICIOS  AS MONEY), 1))VALORSERVICIOS,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTR.VALORCOPAGO  AS MONEY), 1))VALORCOPAGO,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTR.DESCUENTO  AS MONEY), 1))DESCUENTO,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTR.VR_TOTAL  AS MONEY), 1))VR_TOTAL,
                   FTR.VALORSERVICIOS AS VSERVICIOS,FTR.VALORCOPAGO AS VCOPAGO,FTR.DESCUENTO AS VDESCUENTO,FTR.VR_TOTAL AS VTOTAL,
                   FTR.VIVA,COALESCE(@VLR_AFECTO,0)AFECTO,COALESCE(@VLR_INAFECTO,0)INAFECTO,
                    @VLLETRAS+CASE WHEN @IXCOUNTRY='PERU' THEN ' SOLES ' ELSE ' PESOS M/CTE. ' END AS LETRAS,
                  --dbo.FNK_MontoEscrito(FTR.VR_TOTAL)LETRAS,
                   CASE WHEN COALESCE(@NOMBREFACTU,'')<>'' THEN @NOMBREFACTU ELSE USUSU.NOMBRE END AS NFACTURADOR,USUSU.CARGO,
                   CASE WHEN @IXCOUNTRY='PERU' THEN (SELECT CUFE FROM FTRE WHERE FTRN_FACTURA=FTR.N_FACTURA) ELSE COALESCE(FTR.CUFE,'') END CUFE,
                   REPLACE(REPLACE(LTRIM(RTRIM(COALESCE(DBO.FNK_RTF(FDIAN.TITULO),''))),CHAR(13),''),CHAR(10),'')RESOL,
                   CASE WHEN @IXCOUNTRY='PERU' THEN (SELECT CUFE FROM FTRE WHERE FTRN_FACTURA=FTR.N_FACTURA) ELSE COALESCE(DBO.FNK_QRCODE(FTR.N_FACTURA),'') END CODQR,
                   CASE WHEN EXISTS(SELECT DICOM FROM ARCHIVOS WHERE ID =@IDFIRMA ) 
                        THEN  (SELECT DICOM FROM ARCHIVOS WHERE ID =@IDFIRMA)
                        ELSE '' END DICOM,
                   COALESCE(SED.LEGAL,'')+COALESCE(SED.LEGAL2,'') AS LEGAL,
                   COALESCE(SED.LEGAL3,'')+COALESCE(SED.LEGAL4,'') AS LEGAL1,
                   (SELECT NOMBRE FROM USUSU WHERE USUARIO=@USUARIO)IMPRESO,
                   CASE WHEN @IXCOUNTRY='PERU' THEN CASE WHEN TIPOFIN='N' THEN 'CONTADO' ELSE 'CREDITO A '+CAST(CASE WHEN COALESCE(PPT.DIASVTO,30)<=0 THEN 30 ELSE PPT.DIASVTO END  AS VARCHAR(4))+' Dias' END ELSE 'Forma de Pago:'+CASE WHEN COALESCE(TER.ENVIODICAJA,0)=1 THEN 'Contado' ELSE 'Credito '+CAST(COALESCE(PPT.DIASVTO,30) AS VARCHAR(4))+' Dias' END END FPAGO,
                   (SELECT 'PROVEEDOR ELECTRÓNICO: '+LTRIM(RTRIM(TER.RAZONSOCIAL))+', NIT:'+LTRIM(RTRIM(NIT))+'-'+LTRIM(RTRIM(STR(DV)))  
                     FROM TER WHERE IDTERCERO=DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO'))PROFE,
                   (SELECT IDALTERNA2 FROM TER WHERE IDTERCERO=DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO'))CODHABILITA,CASE WHEN @TIPOFAC='M' THEN @NROAFIS ELSE 1 END NROAFI,
                   DBO.FNK_VALORVARIABLE('FTR_03F_NOAUT') FTR_03F_NOAUT ,FTR.USUARIOFACTURA,USUSU.NOMBRE AS NUSUFACTURA,
                   @ENTERO AS ENTERO,CASE TIPOFIN WHEN 'N' THEN 'B' ELSE 'F' END TIPOFACT
            FROM FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
                     INNER JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
                     LEFT  JOIN AFI ON FTR.IDAFILIADO=AFI.IDAFILIADO
                     LEFT  JOIN CIU ON TER.CIUDAD=CIU.CIUDAD
                     LEFT  JOIN CIU CIUF ON AFI.CIUDAD=CIUF.CIUDAD
                     LEFT  JOIN DEP ON CIU.DPTO=DEP.DPTO
                     LEFT  JOIN PPT ON FTR.IDTERCERO=PPT.IDTERCERO AND FTR.IDPLAN=PPT.IDPLAN
                     LEFT JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
                     LEFT JOIN ARCHIVOS ON USUSU.IDFIRMA=ARCHIVOS.ID
                     LEFT JOIN FDIAN ON FTR.CNSRESOL=FDIAN.CNSRESOL
                     LEFT JOIN FTRE  ON FTR.N_FACTURA=FTRE.FTRN_FACTURA AND FTR.PREFIJODIANFE=FTRE.PREFIJO AND FTR.CNSDIANFE=FTRE.N_FACTURA
                     LEFT JOIN CNT   ON PPT.IDCONTRATO=CNT.IDCONTRATO
                     LEFT JOIN SED   ON FTR.IDSEDE=SED.IDSEDE
            WHERE FTR.N_FACTURA=@N_FACTURA

            IF @PROCEDENCIA='CI' OR ( @REFERENCIA='UNIWEB' AND @PROCEDENCIA<>'CE')
            BEGIN
               IF @TIPOFAC='I'
               BEGIN
                  PRINT 'INGRESO ACA J @NOREFERENCIA='+@NOREFERENCIA
                  SELECT MED.NOMBRE,MES.DESCRIPCION,COALESCE(CIT.NOAUTORIZACION,'') NOAUTORIZACION,CONVERT(VARCHAR,FECHA,103)FECHAING,CONVERT(VARCHAR,FECHA,103)FECHAEGR,
                         CASE COALESCE(CIT.MODALIDAD,'Presencial') WHEN 'Virtual' THEN 'Virtual' ELSE 'Presencial' END MODALIDAD,
                         CASE WHEN COALESCE(COPA_VAR_PORC,0)=0 THEN '100%' ELSE CAST(COALESCE(COPA_VAR_PORC,0) AS VARCHAR(10))+'%' END COBERTURA
                  FROM CIT LEFT JOIN MED ON CIT.IDMEDICO=MED.IDMEDICO
                           LEFT JOIN MES ON CASE WHEN COALESCE(CIT.IDEMEDICA,'')='' THEN MED.IDEMEDICA ELSE COALESCE(CIT.IDEMEDICA,'') END=MES.IDEMEDICA
                  WHERE CONSECUTIVO=@NOREFERENCIA
               END
               ELSE
               BEGIN
                  SELECT TOP 1 MED.NOMBRE,MES.DESCRIPCION,COALESCE(CIT.NOAUTORIZACION,'')NOAUTORIZACION,CONVERT(VARCHAR,MIN(CIT.FECHA),103)FECHAING,CONVERT(VARCHAR,MAX(CIT.FECHA),103)FECHAEGR
                  FROM FTRD LEFT JOIN CIT ON FTRD.NOADMISION=CIT.CONSECUTIVO
                            LEFT JOIN MED ON CIT.IDMEDICO=MED.IDMEDICO
                            LEFT JOIN MES ON CASE WHEN COALESCE(CIT.IDEMEDICA,'')='' THEN MED.IDEMEDICA ELSE COALESCE(CIT.IDEMEDICA,'') END=MES.IDEMEDICA
                  WHERE FTRD.N_FACTURA=@N_FACTURA
                  GROUP BY MED.NOMBRE,MES.DESCRIPCION,COALESCE(CIT.NOAUTORIZACION,'')
               END
               IF @TIPOFAC='M'
               BEGIN
                  PRINT 'DEBERIA INGRESSAR ACA'
                  IF @IDFORMATOFTR='03F'
                  BEGIN        
                     SELECT FTRD.PREFIJO,PRE.NOM_PREFIJO,
                     CASE  @IMPRIMEIDALTERNA 
                        WHEN 0 THEN FTRD.REFERENCIA
                        WHEN 1 THEN SER.IDALTERNA
                        WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE COALESCE(SER.CODCUM,SER.IDALTERNA) END --CUM
                        WHEN 3 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END --ATC
                        WHEN 4 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --ADRES
                        WHEN 5 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDSERVICIO END--SAVIA
                        WHEN 6 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.CODSISPRO END -- SISPRO
                        WHEN 7 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --INVINA
                        WHEN 8 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END -- SOLOCUPS
                        WHEN 9 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END --CUM CUPS
                        WHEN 10 THEN CASE WHEN SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END -- CODIGO SOAT
                     END IDSERVICIO,
                     CASE  @IMPRIMEIDALTERNA    
                        WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS=1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE '' END --CUM
                        ELSE SER.CODCUPS
                     END CODCUPS,
                     CASE  WHEN @IMPRIMEIDALTERNA IN (8,9) THEN SER.DESCRIPCION_CUPS
                           ELSE FTRD.ANEXO
                     END ANEXO,
                     (SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=1) ANEXO1,
                     COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=2),'') ANEXO2,
                     FTRD.CANTIDAD AS CANTIDAD,FTRD.VALOR AS VLR_UNI,FTRD.VLR_COPAGOS AS VLR_COPA,VR_TOTAL AS VLRTOTAL,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST((FTRD.VALOR)  AS MONEY), 1))VALOR,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST((FTRD.VLR_COPAGOS)  AS MONEY), 1))VLR_COPAGOS,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST((FTRD.VR_TOTAL)  AS MONEY), 1))VR_TOTAL,
                     CONVERT(VARCHAR,FTRD.FECHAPREST,103)FECHAPREST
                     FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                               INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
                     WHERE N_FACTURA=@N_FACTURA
                     ORDER BY FTRD.FECHAPREST,PRE.PREFIJO,SER.IDSERVICIO
                  END
                  ELSE
                  BEGIN
                     SELECT FTRD.PREFIJO,PRE.NOM_PREFIJO,
                     CASE  @IMPRIMEIDALTERNA 
                        WHEN 0 THEN FTRD.REFERENCIA
                        WHEN 1 THEN SER.IDALTERNA
                        WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE COALESCE(SER.CODCUM,SER.IDALTERNA) END --CUM
                        WHEN 3 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END --ATC
                        WHEN 4 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --ADRES
                        WHEN 5 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDSERVICIO END--SAVIA
                        WHEN 6 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.CODSISPRO END -- SISPRO
                        WHEN 7 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --INVINA
                        WHEN 8 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END -- SOLOCUPS
                        WHEN 9 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END --CUM CUPS
                        WHEN 10 THEN CASE WHEN SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END -- CODIGO SOAT
                     END IDSERVICIO,
                     CASE  @IMPRIMEIDALTERNA    
                        WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS=1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE '' END --CUM
                        ELSE SER.CODCUPS
                     END CODCUPS,
                     CASE  WHEN @IMPRIMEIDALTERNA IN (8,9) THEN SER.DESCRIPCION_CUPS
                           ELSE FTRD.ANEXO
                     END ANEXO,
                     (SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=1) ANEXO1,
                     COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=2),'') ANEXO2,
                     SUM(FTRD.CANTIDAD)CANTIDAD,SUM(FTRD.VALOR) VLR_UNI,SUM(FTRD.VLR_COPAGOS) VLR_COPA,SUM(VR_TOTAL) VLRTOTAL,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(SUM(FTRD.VALOR)  AS MONEY), 1))VALOR,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(SUM(FTRD.VLR_COPAGOS)  AS MONEY), 1))VLR_COPAGOS,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(SUM(FTRD.VR_TOTAL)  AS MONEY), 1))VR_TOTAL
                     FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                               INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
                     WHERE N_FACTURA=@N_FACTURA
                     AND FTRD.VALOR>0
                     GROUP BY FTRD.PREFIJO,PRE.NOM_PREFIJO,FTRD.REFERENCIA,SER.IDALTERNA,SER.MEDICAMENTOS,SER.CODCUPS,
                     SER.CODCUM,SER.IDSERVICIO,SER.CODSISPRO,FTRD.ANEXO,PRE.PREFIJO, SER.DESCRIPCION_CUPS
                     ORDER BY PRE.PREFIJO,SER.IDSERVICIO
                  END
               END
               ELSE 
               BEGIN
                  IF @IDFORMATOFTR='01'
                  BEGIN
                     SELECT FTRD.AREAPRESTACION,AFU.DESCRIPCION,FTRD.PREFIJO,PRE.NOM_PREFIJO,SUM(FTRD.VLR_SERVICI) VLR_SERVICI
                     FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                               INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
                               LEFT  JOIN AFU ON FTRD.AREAPRESTACION=AFU.IDAREA
                     WHERE N_FACTURA= @N_FACTURA
                     AND FTRD.VALOR>0
                     GROUP BY FTRD.AREAPRESTACION,AFU.DESCRIPCION,FTRD.PREFIJO,PRE.NOM_PREFIJO
                     ORDER BY  FTRD.AREAPRESTACION,FTRD.PREFIJO               
                  END
                  ELSE
                  BEGIN
                     SELECT FTRD.PREFIJO,PRE.NOM_PREFIJO,FTRD.AREAPRESTACION,AFU.DESCRIPCION, FORMAT(FTRD.FECHAPREST, 'dd/MM/yyyy') FECHAPREST,
                     CASE  @IMPRIMEIDALTERNA 
                        WHEN 0 THEN FTRD.REFERENCIA
                        WHEN 1 THEN SER.IDALTERNA
                        WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE COALESCE(SER.CODCUM,SER.IDALTERNA) END --CUM
                        WHEN 3 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END --ATC
                        WHEN 4 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --ADRES
                        WHEN 5 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDSERVICIO END--SAVIA
                        WHEN 6 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.CODSISPRO END -- SISPRO
                        WHEN 7 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --INVINA
                        WHEN 8 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END -- SOLOCUPS
                        WHEN 9 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END --CUM CUPS
                        WHEN 10 THEN CASE WHEN SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END -- CODIGO SOAT
                     END IDSERVICIO,
                     CASE  @IMPRIMEIDALTERNA    
                        WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS=1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE '' END --CUM
                        ELSE SER.CODCUPS
                     END CODCUPS,
                     CASE  WHEN @IMPRIMEIDALTERNA IN (8,9) THEN SER.DESCRIPCION_CUPS
                           ELSE FTRD.ANEXO
                     END ANEXO,
                     (SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=1) ANEXO1,
                     COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=3),'') ANEXO2,
                     FTRD.CANTIDAD,FTRD.VALOR VLR_UNI,FTRD.VLR_COPAGOS VLR_COPA,VR_TOTAL VLRTOTAL, FTRD.VLR_SERVICI VLRSERV,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VALOR  AS MONEY), 1))VALOR,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VLR_COPAGOS  AS MONEY), 1))VLR_COPAGOS,
                     CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VR_TOTAL  AS MONEY), 1))VR_TOTAL,
                     FTRD.VLR_SERVICI
                     FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                               INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
                               LEFT  JOIN AFU ON FTRD.AREAPRESTACION=AFU.IDAREA
                     WHERE N_FACTURA=@N_FACTURA
                     AND FTRD.VALOR>0
                     ORDER BY PRE.PREFIJO,SER.IDSERVICIO
                  END
               END
            END
            IF @PROCEDENCIA='CE'
            BEGIN
               IF @TIPOFAC='I'
               BEGIN
                  SELECT COALESCE(MED.NOMBRE,'')NOMBRE,COALESCE(MES.DESCRIPCION,'')DESCRIPCION,COALESCE(AUT.NUMAUTORIZA,'')NOAUTORIZACION,CONVERT(VARCHAR,FECHA,103)FECHAING,CONVERT(VARCHAR,FECHA,103)FECHAEGR
                  FROM AUT LEFT JOIN MED ON AUT.IDSOLICITANTE=MED.IDMEDICO
                           LEFT JOIN MES ON MED.IDEMEDICA=MES.IDEMEDICA
                  WHERE NOAUT=@NOREFERENCIA  
               END
               ELSE
               BEGIN
                  SELECT COALESCE(MED.NOMBRE,'')NOMBRE,COALESCE(MES.DESCRIPCION,'')DESCRIPCION,COALESCE(AUT.NUMAUTORIZA,'')NOAUTORIZACION
                        ,CONVERT(VARCHAR,FECHA,103)FECHAING,CONVERT(VARCHAR,FECHA,103)FECHAEGR
                  FROM AUT LEFT JOIN MED ON AUT.IDSOLICITANTE=MED.IDMEDICO
                           LEFT JOIN MES ON MED.IDEMEDICA=MES.IDEMEDICA
                  WHERE NOAUT=@NOAUT   
                  UNION ALL
                  SELECT TOP 1 MED.NOMBRE,MES.DESCRIPCION,COALESCE(CIT.NOAUTORIZACION,'')NOAUTORIZACION,CONVERT(VARCHAR,MIN(CIT.FECHA),103)FECHAING,CONVERT(VARCHAR,MAX(CIT.FECHA),103)FECHAEGR
                  FROM FTRD LEFT JOIN CIT ON FTRD.NOADMISION=CIT.CONSECUTIVO
                            LEFT JOIN MED ON CIT.IDMEDICO=MED.IDMEDICO
                            LEFT JOIN MES ON COALESCE(CIT.IDEMEDICA,MED.IDEMEDICA)=MES.IDEMEDICA
                  WHERE FTRD.N_FACTURA=@N_FACTURA
                  GROUP BY MED.NOMBRE,MES.DESCRIPCION,COALESCE(CIT.NOAUTORIZACION,'')
               
               END
			   IF @IDFORMATOFTR='01'
               BEGIN
                  SELECT FTRD.AREAPRESTACION,AFU.DESCRIPCION,FTRD.PREFIJO,PRE.NOM_PREFIJO,SUM(FTRD.VLR_SERVICI) VLR_SERVICI
                  FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                            INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
                            LEFT  JOIN AFU ON FTRD.AREAPRESTACION=AFU.IDAREA
                  WHERE N_FACTURA= @N_FACTURA
                  AND FTRD.VALOR>0
                  GROUP BY FTRD.AREAPRESTACION,AFU.DESCRIPCION,FTRD.PREFIJO,PRE.NOM_PREFIJO
                  ORDER BY  FTRD.AREAPRESTACION,FTRD.PREFIJO               
               END
			   ELSE
				  BEGIN
					SELECT FTRD.PREFIJO,PRE.NOM_PREFIJO, FORMAT(FTRD.FECHAPREST, 'dd/MM/yyyy') FECHAPREST,
					CASE  @IMPRIMEIDALTERNA    
						WHEN 0 THEN FTRD.REFERENCIA
						WHEN 1 THEN SER.IDALTERNA
						WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE COALESCE(SER.CODCUM,SER.IDALTERNA) END --CUM
						WHEN 3 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END --ATC
						WHEN 4 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --ADRES
						WHEN 5 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDSERVICIO END--SAVIA
						WHEN 6 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.CODSISPRO END -- SISPRO
						WHEN 7 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.IDSERVICIO ELSE SER.IDALTERNA END --INVINA
						WHEN 8 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.IDALTERNA END -- SOLOCUPS
						WHEN 9 THEN CASE WHEN  SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END --CUM CUPS
						WHEN 10 THEN CASE WHEN SER.MEDICAMENTOS<>1 THEN  SER.CODCUPS ELSE SER.CODCUM END -- CODIGO SOAT
						ELSE FTRD.REFERENCIA
					END IDSERVICIO,
					CASE  @IMPRIMEIDALTERNA    
						WHEN 2 THEN CASE WHEN  SER.MEDICAMENTOS=1 THEN  COALESCE(SER.CODCUPS,SER.IDSERVICIO) ELSE '' END --CUM
						ELSE SER.CODCUPS
					END CODCUPS,
					CASE  WHEN @IMPRIMEIDALTERNA IN (8,9) THEN SER.DESCRIPCION_CUPS
							ELSE FTRD.ANEXO
					END ANEXO,

					(SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=1) ANEXO1,
					COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=2),'') ANEXO2,
					FTRD.CANTIDAD,FTRD.VALOR VLR_UNI,FTRD.VLR_COPAGOS VLR_COPA,VR_TOTAL VLRTOTAL,FTRD.VLR_SERVICI VLRSERV,
					CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VALOR  AS MONEY), 1))VALOR,
					CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VLR_COPAGOS  AS MONEY), 1))VLR_COPAGOS,
					CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VR_TOTAL  AS MONEY), 1))VR_TOTAL,
					FTRD.VLR_SERVICI
					FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
								INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
					WHERE N_FACTURA=@N_FACTURA
					AND FTRD.VALOR>0
					ORDER BY PRE.PREFIJO,SER.IDSERVICIO
				END
            END
            IF @PROCEDENCIA='CAJA'
            BEGIN
               SELECT 'OK'
               SELECT FTRD.PREFIJO,'',FTRD.REFERENCIA AS  IDSERVICIO,FTRD.ANEXO,
               (SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=1) ANEXO1,
               COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(FTRD.ANEXO,' ',55,'') WHERE VEZ=2),'') ANEXO2,
               FTRD.CANTIDAD,FTRD.VALOR VLR_UNI,FTRD.VLR_COPAGOS VLR_COPA,VR_TOTAL VLRTOTAL,
               CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VALOR  AS MONEY), 1))VALOR,
               CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VLR_COPAGOS  AS MONEY), 1))VLR_COPAGOS,
               CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VR_TOTAL  AS MONEY), 1))VR_TOTAL
               FROM FTRD
               WHERE N_FACTURA=@N_FACTURA
               AND FTRD.VALOR>0
               ORDER BY FTRD.PREFIJO
            END
         END
         IF @PROCEDENCIA='SALUD'
         BEGIN
            IF DBO.FNK_VALORVARIABLE('FTR_FECHAS')='HPRE'
            BEGIN
               DECLARE @FECHAPRE_INI DATETIME
               DECLARE @FECHAPRE_FIN DATETIME

               SELECT @FECHAPRE_INI= COALESCE(MIN(HPRE.FECHA),MAX(HADM.FECHAALTAMED)) 
               FROM HPRED INNER JOIN HPRE ON HPRED.NOPRESTACION=HPRE.NOPRESTACION
                          INNER JOIN HADM ON HPRE.NOADMISION=HADM.NOADMISION 
               WHERE HPRED.N_FACTURA=@N_FACTURA

               SELECT @FECHAPRE_FIN=COALESCE(MAX(HPRE.FECHA),MAX(HADM.FECHAALTAMED)) 
               FROM HPRED INNER JOIN HPRE ON HPRED.NOPRESTACION=HPRE.NOPRESTACION
                          INNER JOIN HADM ON HPRE.NOADMISION=HADM.NOADMISION 
               WHERE HPRED.N_FACTURA=@N_FACTURA

            END
            SELECT COALESCE(MED.NOMBRE,'')NOMBRE,COALESCE(MES.DESCRIPCION,'')DESCRIPCION,
            COALESCE(CASE WHEN COALESCE(@VENDEDOR,'')<>'' THEN @VENDEDOR ELSE HADM.NOAUTORIZACION END,'')NOAUTORIZACION,
            COALESCE(CONVERT(VARCHAR,CASE WHEN COALESCE(@VENDEDOR,'')<>'' THEN HADMAUT.F_INICIAL ELSE 
            CASE  WHEN DBO.FNK_VALORVARIABLE('FTR_FECHAS')='HPRE' THEN @FECHAPRE_INI ELSE HADM.FECHA END END,103),'')FECHAING,
            COALESCE(CONVERT(VARCHAR,CASE WHEN COALESCE(@VENDEDOR,'')<>'' THEN HADMAUT.F_FINAL ELSE 
            CASE  WHEN DBO.FNK_VALORVARIABLE('FTR_FECHAS')='HPRE' THEN @FECHAPRE_FIN ELSE  COALESCE(HADM.FECHAALTAMED,HADM.FECHAALTAENF,HADM.FECHAALTA,@F_FACTURA,GETDATE()) END END,103),'')FECHAEGR,
            CASE WHEN COALESCE(@VENDEDOR,'')<>'' THEN COALESCE(DATEDIFF(DAY,HADMAUT.F_INICIAL,COALESCE(HADMAUT.F_FINAL,GETDATE())),0)+1
                 ELSE CASE  WHEN DBO.FNK_VALORVARIABLE('FTR_FECHAS')='HPRE' THEN  COALESCE(DATEDIFF(DAY,@FECHAPRE_INI,@FECHAPRE_FIN),0)
                 ELSE COALESCE(DATEDIFF(DAY,HADM.FECHA,COALESCE(HADM.FECHAALTAMED,HADM.FECHAALTAENF,HADM.FECHAALTA,@F_FACTURA,GETDATE())),0) END END DIASEST,
                 COALESCE(STUFF((SELECT '|'+AUTORIZACION FROM HADMAUT WHERE NOADMISION=@NOREFERENCIA AND COALESCE(N_FACTURA,'')='' FOR XML PATH('')),1,1,''),'')NROADICIONAL,
            CASE WHEN HADM.TIPOADM=DBO.FNK_VALORVARIABLE('IDTARIFASOAT') THEN HACTRAN.NOPOLIZA ELSE '' END POLIZA
            FROM HADM LEFT JOIN MED ON COALESCE(HADM.IDMEDICOALTA,HADM.IDMEDICOTRA,HADM.IDMEDICOING) =MED.IDMEDICO
                      LEFT JOIN MES ON MED.IDEMEDICA=MES.IDEMEDICA
                      LEFT JOIN HADMAUT ON HADM.NOADMISION=HADMAUT.NOADMISION AND HADMAUT.AUTORIZACION=@VENDEDOR
                      LEFT JOIN HACTRAN ON HADM.CNSHACTRAN=HACTRAN.CNSHACTRAN
            WHERE HADM.NOADMISION=@NOREFERENCIA

            IF @IDFORMATOFTR='01'
            BEGIN
               SELECT FTRD.AREAPRESTACION,AFU.DESCRIPCION,FTRD.PREFIJO,PRE.NOM_PREFIJO,SUM(FTRD.VLR_SERVICI)VLR_SERVICI
               FROM FTRD INNER JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                           INNER JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
                           LEFT  JOIN AFU ON FTRD.AREAPRESTACION=AFU.IDAREA
               WHERE N_FACTURA= @N_FACTURA
               AND FTRD.VALOR>0
               GROUP BY FTRD.AREAPRESTACION,AFU.DESCRIPCION,FTRD.PREFIJO,PRE.NOM_PREFIJO
               ORDER BY  FTRD.AREAPRESTACION,FTRD.PREFIJO               
            END
            ELSE
            BEGIN
               --SELECT TOP 1 * FROM HADM
               DECLARE @CNSRPDX VARCHAR(20)
               DECLARE @FECHA   DATETIME =DBO.FNK_GETDATE()
               EXEC SPK_GENCONSECUTIVO '01',@IDSEDE,'@RPDX',@CNSRPDX OUTPUT   
               SELECT @CNSRPDX = @IDSEDE +REPLACE(SPACE(8 - LEN(@CNSRPDX))+LTRIM(RTRIM(@CNSRPDX)),SPACE(1),0)

               PRINT '@CNSRPDX='+COALESCE(@CNSRPDX,'NADA RPDX')
         
               EXEC SPK_RPT_ANEXO_PREFAC @NOREFERENCIA,@N_FACTURA, 0, @CNSRPDX, 3, @FECHA
               SELECT * FROM (
               SELECT CASE WHEN IDTERCERO='SERVICIOS' THEN  RPDX.ID1 ELSE RPDX.ID4 END PREFIJO,
                CASE WHEN IDTERCERO='SERVICIOS' THEN  PRE.NOM_PREFIJO ELSE RPDX.STRINGGRANDE1 END NOM_PREFIJO ,
                LTRIM(RTRIM(RPDX.ID2)) IDSERVICIO,REPLACE(REPLACE(COALESCE(RPDX.NOMBRE,''),CHAR(13),''),CHAR(10),'')ANEXO,
                  (SELECT DESCR FROM DBO.FNK_SPLIT_PMA(RPDX.NOMBRE,' ',75,'') WHERE VEZ=1) ANEXO1,
                  COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(RPDX.NOMBRE,' ',75,'') WHERE VEZ=2),'') ANEXO2,
               RPDX.VALOR2 CANTIDAD ,RPDX.VALOR1 VLR_UNI,RPDX.VALOR3 VLR_COPA,RPDX.VALOR4 VLRTOTAL,RPDX.IDTERCERO AS CLASESER,
                  COALESCE(CONVERT(VARCHAR,RPDX.FECHA1,103),'')FECHAQX,COALESCE(SER.DESCSERVICIO,'')N_PROCE,
               CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(RPDX.VALOR1  AS MONEY), 1))VALOR,
               CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(RPDX.VALOR3  AS MONEY), 1))VLR_COPAGOS,
               CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(RPDX.VALOR4  AS MONEY), 1))VR_TOTAL
               FROM RPDX LEFT JOIN PRE ON RPDX.ID1=PRE.PREFIJO
                            LEFT JOIN SER ON RPDX.ID4=SER.IDSERVICIO
               WHERE RPDX.CNS=@CNSRPDX
               AND COALESCE(RPDX.VALOR1,0)>0 
                ) DATOS
               ORDER BY PREFIJO
            END 
         END
      END
      ELSE
      BEGIN
         IF @PROCEDENCIA='FINANCIERO'
         BEGIN

            SELECT 'OK'OK,FTR.N_FACTURA,FTR.IDSEDE,TER.TIPO_ID,TER.NIT,TER.DV,TER.RAZONSOCIAL,TER.IDALTERNA2,TER.DIRECCION,TER.TELEFONOS,TER.EMAIL,CIU.NOMBRE,
                   CONVERT(VARCHAR,F_FACTURA,103)F_FACTURA,COALESCE(CONVERT(VARCHAR,FTRE.FECHA,103),'') AS FECHAVAL,CONVERT(VARCHAR,F_VENCE,103)F_VENCE,COALESCE(FTR.IDFORMATO,'01')IDFORMATO,COALESCE(FTR.FACTE,0)ESTDIAN,
                   FTR.IDPLAN,PLN.DESCPLAN,PLN.TIPOSISTEMA,COALESCE(PPT.NROCONTRATO,CNT.IDALTERNA,PPT.IDCONTRATO,'')IDCONTRATO,COALESCE(FTR.NOREFERENCIA,'')NOREFERENCIA,FTR.PROCEDENCIA,
                   CASE WHEN FTR.ESTADO='A' THEN 'ANULADA' ELSE CASE WHEN COALESCE(TIPOANULACION,'')<>'' THEN 'ANULADA NC' ELSE 'OK' END END ESTADO,
                   REPLACE(LTRIM(RTRIM(FTR.OBSERVACION)),CHAR(13),'')OBSERVACION,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTR.VALORSERVICIOS  AS MONEY), 1))VALORSERVICIOS,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(CASE WHEN COALESCE(FTR.CAPITADA,0)=1 AND COALESCE(FTR.COPAPROPIO,0)=1 THEN COALESCE(FTR.CP_VLR_COPAGOS,0) ELSE COALESCE(FTR.VALORCOPAGO,0) END AS MONEY), 1))VALORCOPAGO,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(COALESCE(FTR.DESCUENTO,0)  AS MONEY), 1))DESCUENTO,
                  -- CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(COALESCE(FTR.VIVA,0)  AS MONEY), 1))VIVA,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(COALESCE(FTR.VR_TOTAL,0)  AS MONEY), 1))VR_TOTAL,
                   FTR.VALORSERVICIOS AS VSERVICIOS,FTR.VALORCOPAGO AS VCOPAGO,FTR.DESCUENTO AS VDESCUENTO,FTR.VR_TOTAL AS VTOTAL,
                   @VLLETRAS+CASE WHEN @IXCOUNTRY='PERU' THEN ' SOLES ' ELSE ' PESOS M/CTE. ' END AS LETRAS,
                   USUSU.NOMBRE AS NFACTURADOR,USUSU.CARGO,
                   COALESCE(FTR.CUFE,'')CUFE,COALESCE(DBO.FNK_RTF(FDIAN.TITULO),'')RESOL,
                   COALESCE(DBO.FNK_QRCODE(FTR.N_FACTURA),'') CODQR,
                   CASE WHEN EXISTS(SELECT DICOM FROM ARCHIVOS WHERE ID = USUSU.IDFIRMA ) 
                        THEN  (SELECT DICOM FROM ARCHIVOS WHERE ID = USUSU.IDFIRMA)
                        ELSE '' END DICOM
					,COALESCE(CONVERT(VARCHAR,FECHACAP_INI,103),'')FECHACAP_INI,
                        COALESCE(CONVERT(VARCHAR,FECHACAP_FIN,103),'')FECHACAP_FIN,
					FTR.VALORMODERADORA  
					, CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(COALESCE(FTR.VALORMODERADORA,0)  AS MONEY), 1))VALORMODERADORACRR 
					, USUSU.USUARIO USUARIOFACTURA,USUSU.NOMBRE AS NUSUFACTURA,@ENTERO AS ENTERO,
               FTR.VIVA,COALESCE(@VLR_AFECTO,0)AFECTO,COALESCE(@VLR_INAFECTO,0)INAFECTO,
               CASE WHEN @IXCOUNTRY='PERU' THEN CASE WHEN TIPOFIN='N' THEN 'CONTADO' ELSE 'CREDITO A '+CAST(CASE WHEN COALESCE(PPT.DIASVTO,30)<=0 THEN 30 ELSE COALESCE(PPT.DIASVTO,30) END  AS VARCHAR(4))+' Dias' END ELSE 'Forma de Pago:'+
               CASE WHEN COALESCE(TER.ENVIODICAJA,0)=1 THEN 'Contado' ELSE CASE TIPOFIN WHEN 'N' THEN 'Contado' ELSE  'Credito '+CAST(COALESCE(PPT.DIASVTO,30) AS VARCHAR(4))+' Dias' END END END FPAGO,
               CASE TIPOFIN WHEN 'N' THEN 'B' ELSE 'F' END TIPOFACT,
                CASE WHEN @IXCOUNTRY='PERU' AND VR_TOTAL>700 THEN ROUND((VR_TOTAL*0.12),2) ELSE 0 END VR_DETRA
            FROM FTR INNER JOIN TER ON FTR.IDTERCERO=TER.IDTERCERO
                     INNER JOIN PLN ON FTR.IDPLAN=PLN.IDPLAN
                     LEFT  JOIN CIU ON TER.CIUDAD=CIU.CIUDAD
                     LEFT  JOIN PPT ON FTR.IDTERCERO=PPT.IDTERCERO AND FTR.IDPLAN=PPT.IDPLAN
                     LEFT JOIN USUSU ON FTR.USUARIOFACTURA=USUSU.USUARIO
                     LEFT JOIN ARCHIVOS ON USUSU.IDFIRMA=ARCHIVOS.ID
                     LEFT JOIN FDIAN ON FTR.CNSRESOL=FDIAN.CNSRESOL
                     LEFT JOIN FTRE ON FTR.N_FACTURA=FTRE.FTRN_FACTURA
                     LEFT JOIN CNT  ON PPT.IDCONTRATO=CNT.IDCONTRATO
            WHERE FTR.N_FACTURA=@N_FACTURA    
         
            SELECT 'OK'
            SELECT 'Item '+REPLACE(SPACE(2-LEN(FTRD.N_CUOTA)),SPACE(1),'0')+LTRIM(RTRIM(CAST(FTRD.N_CUOTA AS VARCHAR(3))))ITEM,
                   LTRIM(RTRIM(FTRD.REFERENCIA))IDSERVICIO,
                      (SELECT DESCR FROM DBO.FNK_SPLIT_PMA(LTRIM(RTRIM(FTRD.ANEXO)),' ',25,'') WHERE VEZ=1) ANEXO,
                      COALESCE((SELECT DESCR FROM DBO.FNK_SPLIT_PMA(LTRIM(RTRIM(FTRD.ANEXO)),' ',25,'') WHERE VEZ=2),'') ANEXO1,
                      REPLACE(REPLACE(COALESCE(ANEXO,''),CHAR(13),''),CHAR(10),'')ANEXOT,
                   FTRD.CANTIDAD,FTRD.VALOR VLR_UNI,FTRD.VLR_SERVICI,COALESCE(FTRD.VLR_COPAGOS,0) VLR_COPA,VR_TOTAL VLRTOTAL,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VALOR  AS MONEY), 1))VALOR,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(COALESCE(FTRD.VLR_COPAGOS,0)  AS MONEY), 1))VLR_COPAGOS,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(0  AS MONEY), 1))VLR_DESCUENTO,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(COALESCE(FTRD.VIVA,0)  AS MONEY), 1))VIVA,
                   CONVERT(VARCHAR, CONVERT(VARCHAR, CAST(FTRD.VLR_SERVICI  AS MONEY), 1))VR_TOTAL

            FROM FTRD LEFT JOIN SER ON FTRD.REFERENCIA=SER.IDSERVICIO
                        LEFT JOIN PRE ON FTRD.PREFIJO=PRE.PREFIJO
            WHERE N_FACTURA=@N_FACTURA
            AND FTRD.VALOR>0
            ORDER BY PRE.PREFIJO,SER.IDSERVICIO
         END
      END
      IF DBO.FNK_VALORVARIABLE('FACTSEDE')='SI' OR DBO.FNK_VALORVARIABLE('DATOSPROPIETARIO')='SEDE'
      BEGIN
         SELECT CASE WHEN DBO.FNK_VALORVARIABLE('RAZONSOCIALENSEDES')='TER' THEN (SELECT RAZONSOCIAL FROM TER WHERE IDTERCERO=DBO.FNK_VALORVARIABLE('IDTERCEROINSTALADO'))ELSE
              COALESCE(SED.DESCRIPCION,TER.RAZONSOCIAL) END RAZONSOCIAL,TER.NIT,COALESCE(SED.DIRECCION,TER.DIRECCION)DIRECCION,COALESCE(SED.TELEFONOS,TER.TELEFONOS)TELEFONOS,
         CIU.NOMBRE CIUDAD,COALESCE(SED.EMAIL,TER.EMAIL)EMAIL,SED.CODHABILITA
         FROM SED INNER JOIN TER ON SED.NIT=TER.NIT
                    INNER JOIN CIU ON COALESCE(SED.CIUDAD,TER.CIUDAD)=CIU.CIUDAD
         WHERE IDSEDE=@IDSEDE
      END
      ELSE
      BEGIN
         SELECT 'SIN SEDE'
      END
      IF @IXCOUNTRY='PERU' AND EXISTS(SELECT * FROM FCJ WHERE N_FACTURA=@N_FACTURA)
      BEGIN
         SELECT FPA.DESCRIPCION,PCJ.VALOR
         FROM FCJ INNER JOIN PCJ ON FCJ.CNSFACJ=PCJ.CNSFACJ AND FCJ.CODCAJA=PCJ.CODCAJA
                  INNER JOIN FPA ON PCJ.TIPOPAGO=FPA.FORMAPAGO
         WHERE FCJ.N_FACTURA=@N_FACTURA
      END
      ELSE
      BEGIN 
         SELECT 'DE OTRAS IPS'PAGOS
      END 
      IF @IXCOUNTRY='PERU'
      BEGIN
         SELECT BCO.DESCRIPCION,BCO.CODACH,BCT.CTA_BCO
         FROM BCT INNER JOIN BCO ON BCT.BANCO=BCO.BANCO
         WHERE BCT.IDSEDE=@IDSEDE
      END
      ELSE
      BEGIN
         SELECT 'CUENTAS'CUENTAS
      END
   END
END




