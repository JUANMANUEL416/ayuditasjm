
DROP TABLE #A
DROP TABLE #B

SELECT MCP.ANOMES,SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END) DEBITO,SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END)CREDITO,
SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END)-SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END) DIFE INTO #A
FROM MCP INNER JOIN MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE
WHERE ANO='2021'
AND MCP.ESTADO=2
AND COALESCE(ANULADO,0)<>1
GROUP BY MCP.ANOMES



SELECT  ANO,MES,SUM(DB)DB,SUM(CR)CR  INTO #B FROM SALDOMES WHERE ANO='2020' AND LEN(CUENTA)=1
GROUP BY ANO,MES


SELECT * FROM #A
SELECT * FROM #B

ALTER TABLE #B ADD ANOMES VARCHAR(6)


UPDATE #B SET ANOMES=CONCAT(ANO,CASE WHEN MES<10 THEN '0'+CAST(MES AS VARCHAR(1)) ELSE CAST(MES AS VARCHAR(2))END)


SELECT *
FROM #A INNER JOIN #B ON #A.ANOMES COLLATE Modern_Spanish_CI_AS =#B.ANOMES COLLATE Modern_Spanish_CI_AS
WHERE #A.DEBITO<>#B.DB

DROP TABLE #C
DROP TABLE #D

SELECT MCH.CUENTA,SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END) DEBITO,SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END)CREDITO INTO #C
FROM MCP INNER JOIN MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE
WHERE ANO='2020'
AND MCP.ESTADO=2
AND MES=3
AND COALESCE(ANULADO,0)<>1
GROUP BY MCH.CUENTA

SELECT '201903'ANOMES, SALDOMESTERFAC.CUENTA ,SUM(DB)DB,SUM(CR)CR  INTO #D
FROM SALDOMESTERFAC INNER JOIN CUE ON SALDOMESTERFAC.CUENTA=CUE.CUENTA
WHERE ANOMES='201903'
AND CUE.TIPO='Detalle'
GROUP BY SALDOMESTERFAC.CUENTA

SELECT  * FROM #C WHERE NOT EXISTS(SELECT  * FROM #D WHERE #C.CUENTA=#D.CUENTA)
SELECT  * FROM #D WHERE NOT EXISTS(SELECT  * FROM #C WHERE #C.CUENTA=#D.CUENTA)


SELECT * FROM #C INNER JOIN #D ON #C.CUENTA=#D.CUENTA
WHERE (#C.DEBITO<>#D.DB OR #C.CREDITO<>#D.CR)

DROP TABLE #F
DROP TABLE #G
SELECT CUENTA,MCH.IDTERCERO,MCH.N_FACTURA,SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END) DEBITO,SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END)CREDITO INTO #F
FROM MCP INNER JOIN MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE
WHERE ANO='2021'
AND MCP.ESTADO<>2
--AND COALESCE(ANULADO,0)<>1
AND MES=3
AND MCH.CUENTA='11050205'
GROUP BY CUENTA,MCH.IDTERCERO,MCH.N_FACTURA


SELECT CUENTA,IDTERCERO,N_FACTURA,SUM(DB)DB,SUM(CR)CR INTO #G
FROM SALDOMESTERFAC WHERE ANOMES='202103'
AND CUENTA='11050205'
GROUP BY CUENTA,IDTERCERO,N_FACTURA

DELETE #G WHERE DB=0 AND CR=0

SELECT * FROM #F WHERE NOT EXISTS(SELECT * FROM #G WHERE #F.CUENTA=#G.CUENTA AND #F.IDTERCERO=#G.IDTERCERO AND #F.N_FACTURA=#G.N_FACTURA)
SELECT * FROM #G WHERE NOT EXISTS(SELECT * FROM #F WHERE #F.CUENTA=#G.CUENTA AND #F.IDTERCERO=#G.IDTERCERO AND #F.N_FACTURA=#G.N_FACTURA)

SELECT SUM(DB),SUM(CR)  FROM #G 
SELECT SUM(DEBITO),SUM(CREDITO)  FROM #F

SELECT 74170189.73-74165533.02

ORDER BY DB DESC

SELECT  * FROM MCP INNER JOIN MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE
WHERE MCP.ANOMES='202103'
AND MCH.CUENTA='11050205'

SELECT  DISTINCT CUENTA FROM MCH WHERE NROCOMPROBANTE='0235800001838432'

SELECT #F.CUENTA,SUM(DEBITO),SUM(CREDITO),SUM(DB),SUM(CR) FROM #F INNER JOIN #G ON  #F.CUENTA=#G.CUENTA --AND #F.IDTERCERO=#G.IDTERCERO AND #F.N_FACTURA=#G.N_FACTURA
GROUP BY #F.CUENTA

--WHERE #F.DEBITO<>#G.DB OR #F.CREDITO<>#G.CR

SELECT 2142521310.69-14881.837.212.09

SELECT *
FROM MCP INNER JOIN MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE
WHERE ANO='2019'
--AND MES=3
AND MCP.ESTADO<>2
--AND COALESCE(ANULADO,0)<>1
AND CUENTA='15180103'
--AND MCH.N_FACTURA=''
--AND MCH.TIPO='CR'
AND MCH.VALOR=4656.71

SELECT * FROM MCH WHERE NROCOMPROBANTE='0287000001305576'
SELECT * FROM MCH WHERE NROCOMPROBANTE='0216000001308511'
SELECT * FROM MCH WHERE NROCOMPROBANTE='0213400001307177'

SELECT * INTO #Y FROM MCH WHERE NROCOMPROBANTE='0213400001307177'

UPDATE #Y SET NROCOMPROBANTE='0213400001307177-1'
INSERT INTO MCP
SELECT * FROM #X

SELECT DBO.FNK_COLUMNAS_TABLAS('MCH')

INSERT INTO MCP(COMPANIA, NROCOMPROBANTE, PROCEDENCIA, NOREFERENCIA, ANO, MES, FECHACONTABLE, TOTALDEBITO, TOTALCREDITO, REFERENCIA1, REFERENCIA2, REFERENCIA3, USUARIO, FECHA, LOTE, OBSERVACION, IDSEDE,  ESTADO, ANULADO, COMPROBANTE, IDTERCERO, BANCO, NOCHEQUE, VALOR_CHEQUE, RPT_COMPROBANTE, FECHARADICACION, MARCA, SYS_COMPUTERNAME_MARCA, ESTADOIMP, CBTEINTERNO, CLASECONT, ENVNIIF,  NROCOMPROBANTENIIF, TREVERSION, NROCOMPROBANTEREVER)
SELECT COMPANIA, NROCOMPROBANTE, PROCEDENCIA, NOREFERENCIA, ANO, MES, FECHACONTABLE, TOTALDEBITO, TOTALCREDITO, REFERENCIA1, REFERENCIA2, REFERENCIA3, USUARIO, FECHA, LOTE, OBSERVACION, IDSEDE,  ESTADO, ANULADO, COMPROBANTE, IDTERCERO, BANCO, NOCHEQUE, VALOR_CHEQUE, RPT_COMPROBANTE, FECHARADICACION, MARCA, SYS_COMPUTERNAME_MARCA, ESTADOIMP, CBTEINTERNO, CLASECONT, ENVNIIF,  NROCOMPROBANTENIIF, TREVERSION, NROCOMPROBANTEREVER
FROM #X

INSERT INTO MCH(NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, REFERENCIA1, REFERENCIA2, REFERENCIA3, N_FACTURA, F_FACTURAREF, F_VENCE, GENERA, CLASE_GENERA, CNSPAGO, ITEMREF,  USUARIO, FECHA, PREFIJO, IDAREA, CLASECONT, ESTADO, PROCESO, VALOR_PORCIMP, BASE_IMP, PROCEDENCIA, REFERENCIA_PRO, CONCILIADO, CNSFCXCXP, CODUNG, CODPRG, ERROR, IDOPERACION,  FECHACONCILIACION, IDPROVEEDOR, ENPRESUPUESTO, ESTADOIMP)
SELECT NROCOMPROBANTE, COMPANIA, TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, REFERENCIA1, REFERENCIA2, REFERENCIA3, N_FACTURA, F_FACTURAREF, F_VENCE, GENERA, CLASE_GENERA, CNSPAGO, ITEMREF,  USUARIO, FECHA, PREFIJO, IDAREA, CLASECONT, ESTADO, PROCESO, VALOR_PORCIMP, BASE_IMP, PROCEDENCIA, REFERENCIA_PRO, CONCILIADO, CNSFCXCXP, CODUNG, CODPRG, ERROR, IDOPERACION,  FECHACONCILIACION, IDPROVEEDOR, ENPRESUPUESTO, ESTADOIMP
FROM #Y

UPDATE MCP SET ENVNIIF=0,NROCOMPROBANTENIIF=NULL WHERE NROCOMPROBANTE='0213400001307177-1'

EXEC SPK_PASA_MCP_MCPNIIF '0213400001307177-1','01','SOPORTE','SOPORTE','02','04',''

ALTER TABLE MCP ENABLE TRIGGER ALL 

UPDATE MCP SET ANO='2018', MES=11 WHERE NROCOMPROBANTE='0216500001287033'


SELECT * FROM MCPNIIF WHERE NROCOMPROBANTEMCP='0216500001287033'

UPDATE  MCP SET ANULADO=0 WHERE NROCOMPROBANTE='0213400001307177'
UPDATE  MCPNIIF SET ANULADO=0 WHERE NROCOMPROBANTEMCP='0213400001307177'

----
SELECT  * FROM MCPNIIF WHERE NOT EXISTS(SELECT * FROM MCP WHERE MCP.NROCOMPROBANTE=MCPNIIF.NROCOMPROBANTEMCP AND MCP.ANO='2020' AND ESTADO=2 AND COALESCE(ANULADO,0)<>1)
AND ANO='2020' AND ESTADO=2 AND COALESCE(ANULADO,0)<>1


SELECT MCPNIIF.NROCOMPROBANTEMCP,SUM(MCPNIIF.TOTALDEBITO),SUM(MCP.TOTALDEBITO)
FROM  MCPNIIF INNER JOIN MCP ON MCPNIIF.NROCOMPROBANTEMCP=MCP.NROCOMPROBANTE
WHERE MCP.ANO='2021' AND MCP.ESTADO=2 AND COALESCE(MCP.ANULADO,0)<>1 AND MES=3
GROUP BY  MCPNIIF.NROCOMPROBANTEMCP
HAVING SUM(MCPNIIF.TOTALDEBITO)-SUM(MCP.TOTALDEBITO)<>0

SELECT A.NROCOMPROBANTE,SUM(CASE WHEN B.TIPO='DB' THEN VALOR ELSE 0 END),SUM(CASE WHEN B.TIPO='CR' THEN VALOR ELSE 0 END),
SUM(CASE WHEN B.TIPO='DB' THEN VALOR ELSE 0 END)-SUM(CASE WHEN B.TIPO='CR' THEN VALOR ELSE 0 END)
FROM MCPNIIF A INNER JOIN MCHNIIF B ON A.NROCOMPROBANTE=B.NROCOMPROBANTE
WHERE A.ANO='2021'
AND MES=3
AND A.ESTADO=2
AND COALESCE(A.ANULADO,0)<>1
GROUP BY A.NROCOMPROBANTE
HAVING SUM(CASE WHEN B.TIPO='DB' THEN VALOR ELSE 0 END)-SUM(CASE WHEN B.TIPO='CR' THEN VALOR ELSE 0 END)<>0

DROP TABLE #R

SELECT A.NROCOMPROBANTE,A.NROCOMPROBANTEMCP,B.CUENTA  INTO #R
FROM MCPNIIF A INNER JOIN MCHNIIF B ON A.NROCOMPROBANTE=B.NROCOMPROBANTE
WHERE A.ANO='2020'
AND A.ESTADO=2
AND COALESCE(A.ANULADO,0)<>1
AND NOT EXISTS(SELECT  * FROM CUENIIF X WHERE X.CUENTA=B.CUENTA AND X.TIPO='Detalle')
AND B.CUENTA='12211601'

SELECT DISTINCT CUENTA FROM MCH WHERE NROCOMPROBANTE='22700001673233'
SELECT DISTINCT CUENTA FROM MCHNIIF WHERE NROCOMPROBANTE='0202046448'

SELECT  * FROM MC


SELECT *
FROM MCPNIIF INNER JOIN MCHNIIF ON MCPNIIF.NROCOMPROBANTEMCP=MCHNIIF.NROCOMPROBANTE
			 LEFT JOIN CUENIIF ON MCHNIIF.CUENTA=CUENIIF.CUENTA
			 LEFT JOIN CUE ON CUENIIF.CUENTA=CUE.CUENTANIIF
WHERE NOT EXISTS(SELECT  * FROM CUENIIF X WHERE X.CUENTA=MCHNIIF.CUENTA AND X.TIPO='Detalle')


ROLLBACK
COMMIT
ALTER TABLE MCHNIIF DISABLE TRIGGER ALL
BEGIN TRAN 
UPDATE MCHNIIF SET CUENTA='1133010101'
FROM MCPNIIF A INNER JOIN MCHNIIF B ON A.NROCOMPROBANTE=B.NROCOMPROBANTE
WHERE A.ANO='2019'
AND A.ESTADO=2
AND COALESCE(A.ANULADO,0)<>1
AND NOT EXISTS(SELECT  * FROM CUENIIF X WHERE X.CUENTA=B.CUENTA AND X.TIPO='Detalle')
AND B.CUENTA='12210201'

SELECT DISTINCT CUENTA FROM MCH WHERE NROCOMPROBANTE='0247100001410266'
SELECT DISTINCT CUENTA FROM MCHNIIF WHERE NROCOMPROBANTE='0202046441'


--1133010101

DROP TABLE #M
DROP TABLE #N

SELECT MCP.ANOMES,SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END) DEBITO,SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END)CREDITO,
SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END)-SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END) DIFE INTO #M
FROM MCP INNER JOIN MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE
WHERE ANO='2021'
AND MCP.ESTADO=2
AND COALESCE(ANULADO,0)<>1
GROUP BY MCP.ANOMES
ORDER BY MCP.ANOMES

SELECT MCP.ANOMES,SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END) DEBITO,SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END)CREDITO,
SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END)-SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END) DIFE INTO #N
FROM MCPNIIF MCP INNER JOIN MCHNIIF MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE
WHERE ANO='2021'
AND MCP.ESTADO=2
AND COALESCE(ANULADO,0)<>1
GROUP BY MCP.ANOMES
ORDER BY MCP.ANOMES

	SELECT *
	FROM #M INNER JOIN #N ON #M.ANOMES=#N.ANOMES
	WHERE #M.DEBITO<>#N.DEBITO OR #M.CREDITO<>#N.CREDITO


/*
POR COMPROBANTES
*/
DROP TABLE #O
DROP TABLE #P

SELECT MCP.NROCOMPROBANTE,SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END) DEBITO,SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END)CREDITO,
SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END)-SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END) DIFE INTO #O
FROM MCP INNER JOIN MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE
WHERE ANO='2021'
AND MCP.MES=9
AND MCP.ESTADO=2
AND COALESCE(ANULADO,0)<>1
GROUP BY MCP.NROCOMPROBANTE
ORDER BY MCP.NROCOMPROBANTE

SELECT MCP.NROCOMPROBANTEMCP , SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END) DEBITO,SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END)CREDITO,
SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END)-SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END) DIFE INTO #P
FROM MCPNIIF MCP INNER JOIN MCHNIIF MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE
WHERE ANO='2021'
AND MCP.MES=9
AND MCP.ESTADO=2
AND COALESCE(ANULADO,0)<>1
GROUP BY MCP.NROCOMPROBANTEMCP
ORDER BY MCP.NROCOMPROBANTEMCP

--166739
DROP TABLE #R
SELECT 
*
--NROCOMPROBANTE INTO #R
FROM #O LEFT JOIN #P ON #O.NROCOMPROBANTE=#P.NROCOMPROBANTEMCP
WHERE #O.DEBITO<>COALESCE(#P.DEBITO,0) OR #O.CREDITO<>COALESCE(#P.CREDITO,0)

SELECT NROCOMPROBANTEMCP INTO #A  FROM #P WHERE NOT EXISTS(SELECT * FROM #O WHERE #O.NROCOMPROBANTE=#P.NROCOMPROBANTEMCP )


SELECT  * FROM MCP WHERE NROCOMPROBANTE IN(SELECT  * FROM #A)

UPDATE MCPNIIF SET ESTADO=0, ANULADO=1 WHERE NROCOMPROBANTEMCP  IN(SELECT  * FROM #A)

SELECT * FROM MCPNIIF WHERE NROCOMPROBANTEMCP='0211400001918047'

SELECT *
FROM #P LEFT JOIN #O ON #P.NROCOMPROBANTEMCP=#O.NROCOMPROBANTE
WHERE (#O.DEBITO<>#P.DEBITO OR #O.CREDITO<>#P.CREDITO)

SELECT SUM(DEBITO),SUM(CREDITO) FROM #O
SELECT SUM(DEBITO),SUM(CREDITO) FROM #P

SELECT #O.NROCOMPROBANTE,#P.NROCOMPROBANTEMCP,SUM(COALESCE(#O.DEBITO,0)),SUM(COALESCE(#P.DEBITO,0)),
SUM(COALESCE(#O.DEBITO,0))-SUM(COALESCE(#P.DEBITO,0))
FROM  #O LEFT JOIN #P ON #O.NROCOMPROBANTE=#P.NROCOMPROBANTEMCP
GROUP BY  #O.NROCOMPROBANTE,#P.NROCOMPROBANTEMCP
HAVING SUM(COALESCE(#O.DEBITO,0))-SUM(COALESCE(#P.DEBITO,0))<>0

DROP TABLE  #K
SELECT * FROM #O WHERE NOT EXISTS(SELECT * FROM #P WHERE #O.NROCOMPROBANTE=#P.NROCOMPROBANTEMCP)
SELECT *
--NROCOMPROBANTEMCP INTO #R
FROM #P WHERE NOT EXISTS(SELECT * FROM #O WHERE #P.NROCOMPROBANTEMCP=#O.NROCOMPROBANTE)


SELECT  * FROM MCP WHERE NROCOMPROBANTE='0275100001881677'
SELECT  * FROM MCPNIIF WHERE NROCOMPROBANTEMCP='0275100001881677'

UPDATE MCPNIIF SET ANULADO=1 WHERE NROCOMPROBANTEMCP IN(SELECT * FROM #K)

DELETE MCHNIIF WHERE NROCOMPROBANTE='0202172920'
DELETE MCPNIIF WHERE NROCOMPROBANTE='0202172920'
--A NIVEL DE CUENTAS

DROP TABLE #J
DROP TABLE #I

SELECT MCP.NROCOMPROBANTE,COALESCE(CUE.CUENTANIIF,'NADA') AS CUENTA, MCH.CUENTA AS CCOLGAB,SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END) DEBITO,SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END)CREDITO,
SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END)-SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END) DIFE INTO #J
FROM MCP INNER JOIN MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE
		 INNER JOIN CUE ON MCH.CUENTA=CUE.CUENTA
WHERE ANO='2021'
AND MES=4
AND MCP.ESTADO=2
AND COALESCE(ANULADO,0)<>1
GROUP BY MCP.NROCOMPROBANTE,CUE.CUENTANIIF,MCH.CUENTA
ORDER BY MCP.NROCOMPROBANTE


SELECT MCP.NROCOMPROBANTE,COALESCE(CUE.CUENTANIIF,'NADA') AS CUENTA,SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END) DEBITO,SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END)CREDITO,
SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END)-SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END) DIFE INTO #J
FROM MCP INNER JOIN MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE
		 INNER JOIN CUE ON MCH.CUENTA=CUE.CUENTA
WHERE ANO='2021'
AND MES=9
AND MCP.ESTADO=2
AND COALESCE(ANULADO,0)<>1
GROUP BY MCP.NROCOMPROBANTE,CUE.CUENTANIIF
ORDER BY MCP.NROCOMPROBANTE

SELECT MCP.NROCOMPROBANTEMCP,MCH.CUENTA , SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END) DEBITO,SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END)CREDITO,
SUM(CASE WHEN MCH.TIPO='DB' THEN VALOR ELSE 0 END)-SUM(CASE WHEN MCH.TIPO='CR' THEN VALOR ELSE 0 END) DIFE INTO #I
FROM MCPNIIF MCP INNER JOIN MCHNIIF MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE
WHERE ANO='2021'
AND MES=9
AND MCP.ESTADO=2
AND COALESCE(ANULADO,0)<>1
GROUP BY MCP.NROCOMPROBANTEMCP,MCH.CUENTA
ORDER BY MCP.NROCOMPROBANTEMCP

DROP TABLE #R
SELECT 
*
-- J.NROCOMPROBANTE INTO #R
FROM #J J LEFT JOIN #I I ON J.NROCOMPROBANTE=I.NROCOMPROBANTEMCP AND J.CUENTA=COALESCE(I.CUENTA,'')
WHERE J.DEBITO<>COALESCE(I.DEBITO,0) OR J.CREDITO<>COALESCE(I.CREDITO,0)

SELECT * FROM #J WHERE LEFT(CUENTA,1)<>LEFT(CCOLGAB,1)

SELECT  MCH.CUENTA,CUENTANIIF FROM MCH LEFT JOIN CUE ON MCH.CUENTA=CUE.CUENTA
WHERE EXISTS(SELECT  * FROM MCP WHERE ANO='2021' AND ESTADO=2 AND COALESCE(ANULADO,0)<>1 AND MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE)
AND COALESCE(CUE.CUENTANIIF,'')=''

SELECT  * FROM MCPNIIF WHERE  NROCOMPROBANTEMCP='0251000001867420'
SELECT  * FROM MCP WHERE  NROCOMPROBANTE='0251000001867420'


SELECT  * FROM MCHNIIF WHERE  NROCOMPROBANTE='0202188251'
SELECT  * FROM MCH WHERE  NROCOMPROBANTE='0251000001867420'


UPDATE MCPNIIF SET ESTADO=0,ANULADO=1 WHERE NROCOMPROBANTEMCP='0259600001877616'

DELETE MCHNIIF WHERE NROCOMPROBANTE='0202177859'
DELETE MCPNIIF WHERE NROCOMPROBANTE='0202177859'

UPDATE MCP SET ENVNIIF=0,NROCOMPROBANTENIIF=NULL WHERE NROCOMPROBANTE='0259600001877616'

UPDATE MCP SET ENVNIIF=0,NROCOMPROBANTENIIF=NULL WHERE NROCOMPROBANTE='0259600001877616'

DROP TABLE #S
SELECT  MCPNIIF.NROCOMPROBANTE INTO #S FROM #R INNER JOIN MCPNIIF ON #R.NROCOMPROBANTE=MCPNIIF.NROCOMPROBANTEMCP

DELETE MCHNIIF WHERE NROCOMPROBANTE IN(SELECT NROCOMPROBANTE FROM #S)
DELETE MCPNIIF WHERE NROCOMPROBANTE IN(SELECT NROCOMPROBANTE FROM #S)

ALTER TABLE MCP ENABLE TRIGGER ALL
UPDATE MCP SET ENVNIIF=0,NROCOMPROBANTENIIF=NULL WHERE NROCOMPROBANTE IN(SELECT NROCOMPROBANTE FROM #R)

SELECT DISTINCT MCH.NROCOMPROBANTE, MCH.CUENTA,CUE.NOMCUENTA,CUE.CUENTANIIF FROM MCH INNER JOIN CUE ON MCH.CUENTA=CUE.CUENTA
WHERE NROCOMPROBANTE IN(SELECT NROCOMPROBANTEMCP FROM #R)
AND NOT EXISTS(SELECT  *FROM CUENIIF WHERE CUE.CUENTANIIF=CUENIIF.CUENTA AND TIPO='Detalle')

ALTER TABLE MCP DISABLE TRIGGER ALL
SELECT DISTINCT 'EXEC SPK_PASA_MCP_MCPNIIF '''+NROCOMPROBANTE+''',''01'',''SOPORTE'',''SOPORTE'',''02'','''+COMPROBANTE+''',''''' FROM MCP
WHERE NROCOMPROBANTE IN(SELECT NROCOMPROBANTE FROM #R)

SELECT  * FROM MCP WHERE NROCOMPROBANTE='0220000001727267'

--revisar terceros 
UPDATE MCH SET IDTERCERO=REPLACE(IDTERCERO,CHAR(31),'') WHERE IDTERCERO like '%[^!-~ ]%' 

SELECT  'EXEC SPK_PASA_MCP_MCPNIIF '''+NROCOMPROBANTE+''',''01'',''SOPORTE'','''+USUARIO+''',''02'','''+COMPROBANTE+''','''''  FROM MCP WHERE NROCOMPROBANTE='0259600001877616'

SELECT  'EXEC SPK_PASA_MCP_MCPNIIF '''+NROCOMPROBANTE+''',''01'',''SOPORTE'','''+USUARIO+''',''02'','''+COMPROBANTE+''','''''  
FROM MCP WHERE NOT EXISTS(SELECT  * FROM MCPNIIF WHERE MCPNIIF.NROCOMPROBANTEMCP=MCP.NROCOMPROBANTE AND ESTADO=2 AND COALESCE(ANULADO,0)<>1 AND ANO='2021')
AND MCP.ESTADO=2
AND COALESCE(ANULADO,0)<>1
AND ANO='2021'
ORDER BY ANOMES,COMPROBANTE

SELECT  * FROM MCPNIIF WHERE NROCOMPROBANTEMCP='0256500001753996'
SELECT CUE.CUENTANIIF,MCH.TIPO,MCH.VALOR FROM MCH INNER JOIN CUE ON MCH.CUENTA=CUE.CUENTA WHERE NROCOMPROBANTE='0256500001753996'
SELECT  CUENTA,TIPO,VALOR FROM MCHNIIF WHERE NROCOMPROBANTE='0201285495'

EXEC SPK_PASA_MCP_MCPNIIF '0259600001877616','01','SOPORTE','PEREZE','02','20',''

--cerramos los periodos de niif

EXEC SPK_CIERRA_PERIODOCONTABLE_NIIF '2020',1,'SOPORTE'
GO
EXEC SPK_CIERRA_PERIODOCONTABLE_NIIF '2020',2,'SOPORTE'
GO
EXEC SPK_CIERRA_PERIODOCONTABLE_NIIF '2020',3,'SOPORTE'
GO
EXEC SPK_CIERRA_PERIODOCONTABLE_NIIF '2020',4,'SOPORTE'
GO
EXEC SPK_CIERRA_PERIODOCONTABLE_NIIF '2020',5,'SOPORTE'
GO
EXEC SPK_CIERRA_PERIODOCONTABLE_NIIF '2020',6,'SOPORTE'
GO
EXEC SPK_CIERRA_PERIODOCONTABLE_NIIF '2020',7,'SOPORTE'
GO
EXEC SPK_CIERRA_PERIODOCONTABLE_NIIF '2020',8,'SOPORTE'
GO
EXEC SPK_CIERRA_PERIODOCONTABLE_NIIF '2020',9,'SOPORTE'
GO
EXEC SPK_CIERRA_PERIODOCONTABLE_NIIF '2020',10,'SOPORTE'
GO
EXEC SPK_CIERRA_PERIODOCONTABLE_NIIF '2020',11,'SOPORTE'
GO
EXEC SPK_CIERRA_PERIODOCONTABLE_NIIF '2020',12,'SOPORTE'


SELECT  * FROM CUENIIF ORDER BY CUENTA

UPDATE CUENIIF SET NOMCUENTA=UPPER(NOMCUENTA) WHERE TIPO='SUMA'

UPDATE CUENIIF SET NOMCUENTA=LOWER(NOMCUENTA) WHERE TIPO='Detalle'