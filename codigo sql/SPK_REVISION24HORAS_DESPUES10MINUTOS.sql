IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME = 'SPK_REVISION24HORAS_DESPUES10MINUTOS' AND TYPE = 'P')
BEGIN
   DROP PROCEDURE SPK_REVISION24HORAS_DESPUES10MINUTOS
END
GO
CREATE PROCEDURE DBO.SPK_REVISION24HORAS_DESPUES10MINUTOS 
WITH ENCRYPTION
AS  
DECLARE @EXISTE INT
DECLARE @ERROR INT
DECLARE @HOY DATETIME
DECLARE @CONSECUTIVO VARCHAR (20)
BEGIN  
   UPDATE HBALIDD SET FECHA=DATEADD(DAY,-1,HBALIDD.FECHA)
   FROM HBALIDD
   WHERE HBALIDD.FECHA>
      CASE WHEN LEFT(CONVERT(TIME,GETDATE()),2)<DBO.FNK_VALORVARIABLE('HORAULTIMADOSIS')+1 
           THEN DATEADD(HOUR,CONVERT(INT,DBO.FNK_VALORVARIABLE('HORAULTIMADOSIS')),CONVERT(DATETIME,CONVERT(DATE,GETDATE())))
           ELSE DATEADD(HOUR,CONVERT(INT,DBO.FNK_VALORVARIABLE('HORAULTIMADOSIS'))+24,CONVERT(DATETIME,CONVERT(DATE,GETDATE()))) 
      END

   SELECT @ERROR = COUNT (*) 
   FROM HHOM
   WHERE FRECUENCIA < 1 AND RAZONNEC <> 1
   AND EXISTS (SELECT *
               FROM HADM
               WHERE HHOM.NOADMISION = HADM.NOADMISION
               AND COALESCE(CERRADA,0) = 0 AND COALESCE(FACTURABLE,0) = 1)

   IF COALESCE(@ERROR,0) > 0
      BEGIN 
         UPDATE HHOM
         SET FRECUENCIA = 24
         WHERE FRECUENCIA < 1 AND RAZONNEC <> 1
         AND EXISTS (SELECT *
                     FROM HADM
                     WHERE HHOM.NOADMISION = HADM.NOADMISION
                     AND COALESCE(CERRADA,0) = 0 AND COALESCE(FACTURABLE,0) = 1)
      END




   DELETE  HHOM WHERE  EXISTS( SELECT A.NOADMISION
                              FROM HHAB A INNER JOIN HADM B ON A.NOADMISION=B.NOADMISION 
                              WHERE B.CERRADA=0
                              AND A.NOADMISION=HHOM.NOADMISION)
   AND NOT EXISTS(
   SELECT HCATD.CONSECUTIVO,Y.NOADMISION, HCATD.IDSERVICIO,SER.DESCSERVICIO,HCATD.CANTIDAD,COALESCE(HCATD.IDSERVICIOMEZCLA,'')IDSERVICIOMEZCLA,COALESCE(HCATD.QMEZCLA,0)QMEZCLA,COALESCE(HCATD.DOSISUNICA,0)DOSISUNICA
   FROM HCATD INNER JOIN (
                           SELECT CONSECUTIVO,HCA.NOADMISION
                           FROM HCA INNER JOIN (
                                                   SELECT NOADMISION,MAX(FECHA)FECHA FROM HCA INNER JOIN MPL ON HCA.CLASEPLANTILLA=MPL.CLASEPLANTILLA
                                                   WHERE EXISTS(
                                                   SELECT A.NOADMISION
                                                   FROM HHAB A INNER JOIN HADM B ON A.NOADMISION=B.NOADMISION 
                                                   WHERE B.CERRADA=0
                                                   AND HCA.NOADMISION=A.NOADMISION)
                                                   AND HCA.CLASE='HC'AND PROCEDENCIA='QX'
                                                   AND COALESCE(MPL.TIENEOM,0)=0
                                                   GROUP BY NOADMISION ) X ON HCA.NOADMISION=X.NOADMISION AND DBO.FNK_FECHA_SIN_MLS(HCA.FECHA)=DBO.FNK_FECHA_SIN_MLS(X.FECHA)
                           WHERE CLASE='HC'AND PROCEDENCIA='QX'
                           GROUP BY CONSECUTIVO,HCA.NOADMISION ) Y ON HCATD.CONSECUTIVO=Y.CONSECUTIVO
               INNER JOIN SER ON HCATD.IDSERVICIO=SER.IDSERVICIO
   WHERE SER.MEDICAMENTOS=1
   AND COALESCE(HCATD.DOSISUNICA,0)=0
   AND HHOM.NOADMISION=Y.NOADMISION
   AND HCATD.CLASE IN('I','C')
   AND HHOM.IDSERVICIO=HCATD.IDSERVICIO
   AND COALESCE(HHOM.IDSERVICIOMEZCLA,'')=COALESCE(HCATD.IDSERVICIOMEZCLA,''))
   AND HHOM.CODOM<>DBO.FNK_VALORVARIABLE('OMCODNUTRICIONP')


   PRINT 'INSERTO FALTANTES SI HAY LUGAR'

   INSERT INTO HHOM
   SELECT Y.NOADMISION,(SELECT COALESCE(MAX(ITEM),0) FROM HHOM WHERE HHOM.NOADMISION=Y.NOADMISION)+ROW_NUMBER() OVER(ORDER  BY Y.NOADMISION  DESC),HCATD.IDSERVICIO,HCATD.CANTIDAD,'A',Y.FECHA,Y.IDMEDICO,HCATD.FRECUENCIA,HCATD.DURACION,HCATD.CONSECUTIVO,Y.ITEMRED,
   HCATD.CODOM,NULL,NULL,NULL,0,Y.IDMEDICO,Y.FECHA,1,NULL,HCATD.IDSERVICIOMEZCLA,HCATD.QMEZCLA,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL
   FROM HCATD INNER JOIN (
                           SELECT CONSECUTIVO,HCA.NOADMISION,HCA.FECHA,HCA.IDMEDICO,HCA.ITEMRED
                           FROM HCA INNER JOIN (
                                                   SELECT NOADMISION,MAX(FECHA)FECHA FROM HCA INNER JOIN MPL ON HCA.CLASEPLANTILLA=MPL.CLASEPLANTILLA
                                                   WHERE EXISTS(
                                                   SELECT A.NOADMISION
                                                   FROM HHAB A INNER JOIN HADM B ON A.NOADMISION=B.NOADMISION 
                                                   WHERE B.CERRADA=0
                                                   AND HCA.NOADMISION=A.NOADMISION)
                                                   AND HCA.CLASE='HC'AND PROCEDENCIA='QX'
                                                   AND COALESCE(MPL.TIENEOM,0)=0
                                                   GROUP BY NOADMISION ) X ON HCA.NOADMISION=X.NOADMISION AND DBO.FNK_FECHA_SIN_MLS(HCA.FECHA)=DBO.FNK_FECHA_SIN_MLS(X.FECHA)
                           WHERE CLASE='HC'AND PROCEDENCIA='QX'
                           AND EXISTS(  SELECT A.NOADMISION
                                        FROM HHAB A INNER JOIN HADM B ON A.NOADMISION=B.NOADMISION 
                                        WHERE B.CERRADA=0
                                        AND A.NOADMISION=HCA.NOADMISION
                                      )
                           GROUP BY CONSECUTIVO,HCA.NOADMISION,HCA.FECHA,HCA.IDMEDICO,HCA.ITEMRED ) Y ON HCATD.CONSECUTIVO=Y.CONSECUTIVO
               INNER JOIN SER ON HCATD.IDSERVICIO=SER.IDSERVICIO
   WHERE SER.MEDICAMENTOS=1
   AND COALESCE(HCATD.DOSISUNICA,0)=0
   AND HCATD.CLASE IN('I','C')
   AND HCATD.CODOM<>DBO.FNK_VALORVARIABLE('OMCODNUTRICIONP')
   AND NOT EXISTS( 
       SELECT * FROM HHOM 
       WHERE Y.NOADMISION=HHOM.NOADMISION 
       AND   HHOM.IDSERVICIO=HCATD.IDSERVICIO
       AND   COALESCE(HHOM.IDSERVICIOMEZCLA,'')=COALESCE(HCATD.IDSERVICIOMEZCLA,'')
      
   )


   PRINT 'Voy A Generar 24 horas'


   SELECT @HOY = DBO.FNK_FECHA_SIN_HORA(GETDATE())

   PRINT 'CAPTURO CONSECUTIVO '
   SELECT @CONSECUTIVO = CNSIZSOLM FROM IZSOLM WHERE DBO.FNK_FECHA_SIN_HORA(FECHA) = DBO.FNK_FECHA_SIN_HORA(GETDATE())
   PRINT 'CONSECUTIVO....  '+@CONSECUTIVO
   EXEC SPK_IZSOL_OME24 @CONSECUTIVO, '01', 'Autimatico'
   PRINT 'REVISO ALGUN FALTANTE'
   EXEC SPK_IZSOL_OME24_FALTANTES @CONSECUTIVO, '01', 'Autimatico'
   PRINT 'REVISO IZSOLD'
   EXEC SPK_IZSOL_OME24_FALTANTES_IZSOLD @CONSECUTIVO, '01', 'Autimatico'
   PRINT 'ACTULIZO LO ULTIMO'
   UPDATE IZSOLD SET CANTIDADSOL=CEILING(B.CANTIDAD/CASE WHEN COALESCE(C.EQUICC,0)<=0 THEN 1 ELSE C.EQUICC END)*(DURACION/FRECUENCIA)
   FROM IZSOL A INNER JOIN IZSOLD B ON A.CNSIZSOL=B.CNSIZSOL
			   INNER JOIN SER    C ON B.IDSERVICIO=C.IDSERVICIO
   WHERE B.CANTIDADSOL<=0
   AND CNSIZSOLM=@CONSECUTIVO
   PRINT 'ACTULIZO EL ESTAO DE IZSOLM'
   UPDATE IZSOLM SET ESTADO=1 WHERE CNSIZSOLM=@CONSECUTIVO
   PRINT 'ORDENES 24 HORAS TERMINADA'

END
