
DROP TABLE #VENTA

SELECT A.IDAREA,A.CCOSTO,B.IDSERVICIO,C.DESCSERVICIO,D.IDARTICULO,D.IDITAR,SUM(B.CANTIDAD)CANTIDAD,ROUND(AVG(E.PCOSTO),2)PCOSTO INTO #VENTA
FROM HPRE A INNER JOIN HPRED B ON A.NOPRESTACION=B.NOPRESTACION
            INNER JOIN SER   C ON B.IDSERVICIO=C.IDSERVICIO
            INNER JOIN IART  D ON C.IDARTICULO=D.IDARTICULO
            INNER JOIN (SELECT IDSERVICIO,AVG(PCOSTO)PCOSTO FROM IART GROUP BY IDSERVICIO)  E ON D.IDSERVICIO=E.IDSERVICIO
WHERE A.FECHA>='01/10/2015' AND A.FECHA<'01/11/2015'
AND COALESCE(C.IDARTICULO,'')<>'NA'
--AND COALESCE(B.NOCOBRABLE,0)=CASE WHEN D.IDITAR='26' THEN 0 ELSE B.NOCOBRABLE END
GROUP BY A.IDAREA,A.CCOSTO,B.IDSERVICIO,C.DESCSERVICIO,D.IDARTICULO,D.IDITAR
                                                                                   

SELECT * FROM #VENTA  WHERE IDITAR='10'   

ALTER TABLE #VENTA ADD PCOSTOT DECIMAL(14,2)            
ALTER TABLE #VENTA ADD CUEDEBITO VARCHAR(20)            
ALTER TABLE #VENTA ADD CUECREDITO  VARCHAR(20)              

UPDATE #VENTA SET PCOSTOT=  COALESCE(CANTIDAD,0)*COALESCE(PCOSTO,1)  
UPDATE #VENTA SET CCOSTO='103' WHERE COALESCE(CCOSTO,'')='' OR NOT EXISTS(SELECT * FROM CEN WHERE #VENTA.CCOSTO=CEN.CCOSTO)  
UPDATE #VENTA SET IDAREA=DBO.FNK_AREADELCCOSTO(CCOSTO) 
UPDATE #VENTA SET CUEDEBITO=DBO.FNK_CUENTA_KMCOM('01','MOV_INVENTARIO','DB','02',IDAREA,CCOSTO,'P',IDITAR),CUECREDITO=DBO.FNK_CUENTA_KMCOM('01','MOV_INVENTARIO','CR','02',IDAREA,CCOSTO,'P',IDITAR)        

SELECT IDAREA,CCOSTO,IDITAR FROM #VENTA WHERE COALESCE(CUEDEBITO,'')='NO DEF.KMCOM' 

UPDATE #VENTA SET IDAREA='4105',CCOSTO='103' WHERE  COALESCE(CUEDEBITO,'')='NO DEF.KMCOM' 

SELECT #VENTA.IDITAR,ITAR.DESCRIPCION,IDAREA,CCOSTO,CUEDEBITO,CUECREDITO,SUM(PCOSTOT)PCOSTO FROM #VENTA INNER JOIN ITAR ON #VENTA.IDITAR=ITAR.IDITAR 
GROUP BY #VENTA.IDITAR,ITAR.DESCRIPCION,IDAREA,CCOSTO,CUEDEBITO,CUECREDITO



SELECT IDAREA,CCOSTO,IDITAR FROM #VENTA WHERE COALESCE(CUEDEBITO,'')='NO DEF.KMCOM' 

UPDATE #VENTA SET IDAREA='4105',CCOSTO='103' WHERE  COALESCE(CUEDEBITO,'')='NO DEF.KMCOM' 


-- QUITAR LOS MOVIMIENTOS DE SALIDA Y ENTREDA POR DEVOLUCIONES DE MCP Y MCH

DROP TABLE #A

SELECT DISTINCT CNSMOV,NROCOMPROBANTE INTO #A
FROM IMOV WHERE IDTIPOMOV IN('02','20')
AND FECHAMOV>='01/10/2015' AND FECHAMOV<'01/11/2015'
AND ESTADO=1 
AND COALESCE(CONTABILIZADA,0)<>0
AND COALESCE(NROCOMPROBANTE,'')<>''


SELECT  *
FROM MCP INNER JOIN MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE
         INNER JOIN #A V ON MCP.NROCOMPROBANTE=V.NROCOMPROBANTE AND MCP.REFERENCIA1=V.CNSMOV

UPDATE MCP SET ESTADO=0
FROM MCP INNER JOIN MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE
         INNER JOIN #A V ON MCP.NROCOMPROBANTE=V.NROCOMPROBANTE AND MCP.REFERENCIA1=V.CNSMOV


DELETE MCH
FROM MCP INNER JOIN MCH ON MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE
         INNER JOIN #A V ON MCP.NROCOMPROBANTE=V.NROCOMPROBANTE AND MCP.REFERENCIA1=V.CNSMOV


DELETE MCP  FROM MCP INNER JOIN #A V ON MCP.NROCOMPROBANTE=V.NROCOMPROBANTE AND MCP.REFERENCIA1=V.CNSMOV

-- INSERT DE MCP Y MCH
--0104683452

SELECT DBO.FNK_COLUMNAS_TABLAS('MCH')

SELECT TOP 1 * FROM #VENTA

SELECT TOP 1 * FROM MCH

INSERT INTO MCH(NROCOMPROBANTE, COMPANIA,  TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, REFERENCIA1, REFERENCIA2, REFERENCIA3, N_FACTURA, F_FACTURAREF, F_VENCE, GENERA, CLASE_GENERA,                 CNSPAGO, ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, CLASECONT, ESTADO, PROCESO, VALOR_PORCIMP, BASE_IMP, PROCEDENCIA, REFERENCIA_PRO, CONCILIADO, CNSFCXCXP, CODUNG, CODPRG, ERROR,                 IDOPERACION, FECHACONCILIACION, IDPROVEEDOR, ENPRESUPUESTO, ESTADOIMP)SELECT '0104683495', '01',  'CR', CUECREDITO, '900008328',CEN.CCOSTO,' COSTOS DE:'+ITAR.DESCRIPCION+' CCOSTO :'+CEN.DESCRIPCION , PCOSTOT, ITAR.IDITAR, NULL, NULL, NULL, '31/07/2015', '31/07/2015', 'Movimiento', 'Otros',                 NULL, ROW_NUMBER() OVER(ORDER  BY #VENTA.CCOSTO  DESC), 'SOPORTE', '31/07/2015', ITAR.IDITAR, #VENTA.IDAREA, 'P', 0, 'MANUAL', NULL, NULL, 'MANUAL', 'MANUAL', 0, NULL, NULL, NULL, 0,                 NULL, NULL, NULL, NULL, NULLFROM #VENTA INNER JOIN ITAR ON #VENTA.IDITAR=ITAR.IDITAR            INNER JOIN CEN  ON #VENTA.CCOSTO=CEN.CCOSTOWHERE PCOSTOT>0INSERT INTO MCH(NROCOMPROBANTE, COMPANIA,  TIPO, CUENTA, IDTERCERO, CCOSTO, DETALLE, VALOR, REFERENCIA1, REFERENCIA2, REFERENCIA3, N_FACTURA, F_FACTURAREF, F_VENCE, GENERA, CLASE_GENERA,                 CNSPAGO, ITEMREF, USUARIO, FECHA, PREFIJO, IDAREA, CLASECONT, ESTADO, PROCESO, VALOR_PORCIMP, BASE_IMP, PROCEDENCIA, REFERENCIA_PRO, CONCILIADO, CNSFCXCXP, CODUNG, CODPRG, ERROR,                 IDOPERACION, FECHACONCILIACION, IDPROVEEDOR, ENPRESUPUESTO, ESTADOIMP)SELECT '0104683495', '01',  'DB', CUEDEBITO, '900008328',CEN.CCOSTO,' COSTOS DE:'+ITAR.DESCRIPCION+' CCOSTO :'+CEN.DESCRIPCION , PCOSTOT, ITAR.IDITAR, NULL, NULL, NULL, '31/07/2015', '31/07/2015', 'Movimiento', 'Otros',                 NULL, ROW_NUMBER() OVER(ORDER  BY #VENTA.CCOSTO  DESC), 'SOPORTE', '31/07/2015', ITAR.IDITAR, #VENTA.IDAREA, 'P', 0, 'MANUAL', NULL, NULL, 'MANUAL', 'MANUAL', 0, NULL, NULL, NULL, 0,                 NULL, NULL, NULL, NULL, NULLFROM #VENTA INNER JOIN ITAR ON #VENTA.IDITAR=ITAR.IDITAR            INNER JOIN CEN  ON #VENTA.CCOSTO=CEN.CCOSTOWHERE PCOSTOT>0EXEC SPK_SUMA_DBCR '0104683495'EXEC SPK_REVISAR_COMPROBANTE '01','0104683495'DELETE MCH WHERE NROCOMPROBANTE='0104683452' AND COALESCE(VALOR,0)<=0