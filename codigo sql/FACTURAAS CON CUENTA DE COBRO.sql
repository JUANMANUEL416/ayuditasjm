 IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_FACTURAS_CUENTADECOBRO' AND TYPE='V')
BEGIN
 DROP VIEW VWK_FACTURAS_CUENTADECOBRO
END
GO
CREATE VIEW VWK_FACTURAS_CUENTADECOBRO
AS
 SELECT  A.CNSCXC,A.N_FACTURA, B.F_FACTURA, B.TIPOTTEC, C.F_RECIBIDO, COALESCE(VK.GLOSA,'')GLOSA,COALESCE(VK.RESPUESTAG,'')RESPUESTAG,COALESCE(VK.RADICADOG,'')RADICADOG, 
 COALESCE(VK.RATIFICA,'')RATIFICA,COALESCE(VK.RESPUESTAR,'')RESPUESTAR,COALESCE(VK.RADICADOR,'')RADICADOR,CASE WHEN COALESCE(B.CASTIGADA,0)=1 THEN 'Si' ELSE '' END CASTIGADA,
 B.IDTERCERO,TER.RAZONSOCIAL,B.VALORSERVICIOS,A.VALORFACTURA,B.VALORCOPAGO,A.SALDONETO,A.DEDUCCIONES, 
(SELECT TOP 1 CONVERT(VARCHAR,FPAG.FECHAPAGO,101) FROM FPAG INNER JOIN FPAGD ON FPAG.CNSFPAG=FPAGD.CNSFPAG WHERE INGRESO='GLOSAS' AND FPAG.CERRADO=1 AND FPAGD.CLASE='F' AND FPAGD.N_FACTURA=A.N_FACTURA AND FPAGD.CNSCXC=A.CNSCXC )F_GLASOINI,
(SELECT TOP 1 FPAGD.VLRGLOSA FROM FPAG INNER JOIN FPAGD ON FPAG.CNSFPAG=FPAGD.CNSFPAG WHERE INGRESO='GLOSAS' AND FPAG.CERRADO=1 AND FPAGD.CLASE='F' AND FPAGD.N_FACTURA=A.N_FACTURA AND FPAGD.CNSCXC=A.CNSCXC )VRGLOSA ,
 A.VLRGLOSAS,A.VLRGLOSAS_R,A.VLRPAGOS,A.VLRNOTADB,A.VLRNOTACR,A.VLRLEVANTADO, 
( SELECT TOP 1 CONVERT(VARCHAR,FCONCI.FECHACONC,101)  FROM FCONCI INNER JOIN FCONCID ON FCONCI.IDFCONCI=FCONCID.IDFCONCI WHERE FCONCID.N_FACTURA=A.N_FACTURA AND FCONCID.CNSCXC=A.CNSCXC) F_CONCILIA, 
 A.VLRFCES,B.IDAFILIADO,AFI.TIPO_DOC,AFI.PAPELLIDO,COALESCE(AFI.SAPELLIDO,'')SAPELLIDO,AFI.PNOMBRE,COALESCE(AFI.SNOMBRE,'')SNOMBRE,
 CASE B.PROCEDENCIA WHEN 'CI' THEN CIT.FECHA WHEN 'CE' THEN AUT.FECHA WHEN 'SALUD' THEN HADM.FECHA ELSE B.F_FACTURA END F_INGRESO,
 CASE B.PROCEDENCIA WHEN 'CI' THEN CIT.FECHA WHEN 'CE' THEN AUT.FECHA WHEN 'SALUD' THEN HADM.FECHAALTAENF ELSE B.F_FACTURA END F_EGRESO  
 FROM FCXCD A INNER JOIN FTR B ON A.N_FACTURA=B.N_FACTURA 
              INNER JOIN FCXC C ON A.CNSCXC=C.CNSCXC 
              LEFT JOIN AFI     ON  B.IDAFILIADO=AFI.IDAFILIADO 
              LEFT JOIN TER     ON  B.IDTERCERO=TER.IDTERCERO 
              LEFT JOIN VWK_ESTADO_FACTURAS_AUDI VK ON A.CNSCXC=VK.CNSCXC AND A.N_FACTURA=VK.N_FACTURA 
                 LEFT JOIN CIT ON CIT.CONSECUTIVO=B.NOREFERENCIA AND B.PROCEDENCIA='CI' 
              LEFT JOIN AUT ON AUT.NOAUT=B.NOREFERENCIA AND B.PROCEDENCIA='CE' 
              LEFT JOIN HADM ON HADM.NOADMISION=B.NOREFERENCIA AND B.PROCEDENCIA='SALUD'
 WHERE   A.SALDONETO >=0