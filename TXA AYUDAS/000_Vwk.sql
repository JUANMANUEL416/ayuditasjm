-- DEL.LSAEZ.09.AGO.2006.VWK_SXT
-- MOD.LSAEZ.11.AGO.2006.VWK_CXC
-- MOD.LSAEZ.11.AGO.2006.VWK_CXCDIASVTO
-- MOD.LSAEZ.11.AGO.2006.VWK_VCTOS
-- MOD.LSAEZ.11.AGO.2006.VWK_CXCDV_TTEC
-- MOD.LSAEZ.11.AGO.2006.VWK_VCTOS_TTEC
-- MOD.CRISTIAN 09092008. VWK_VCTOS EN EL WHERE.   EL PEOR SQL DE TODOS LOS TIEMPOS ESTO ERA LO QUE HACIA LENTISISISISMA LA VISTA
-------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_HC' AND TYPE='V')
BEGIN
   DROP VIEW VWK_HC
END
GO
-------------------------------------------
CREATE VIEW DBO.VWK_HC
AS
SELECT * FROM HCA
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VW_MOVTOINV' AND TYPE='V')
BEGIN
 DROP VIEW VW_MOVTOINV
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VW_MOVTOINV WITH SCHEMABINDING      
AS      
SELECT DBO.IMOV.CNSMOV,DBO.IMOV.IDTERCERO,DBO.imov.fechamov,DBO.imovh.idarticulo,DBO.imovh.cantidad,      
       DBO.itmo.tipo,DBO.imov.idtipomov,DBO.iart.idclase,DBO.iart.idsubclase,      
       DBO.iart.idgrupo,DBO.iart.idprinactivo,DBO.iart.IDforfarm,DBO.iart.IDconcentra,      
       DBO.IMOV.IDAREA,DBO.IMOV.IDBODEGA,DBO.ITMO.AFECTAPROM,DBO.IMOV.FECHACONF,imovh.pcosto     
FROM   DBO.IMOV,DBO.itmo,DBO.imovh,DBO.IART    
WHERE  DBO.imov.cnsmov     = DBO.imovh.cnsmov      
AND    DBO.IMOV.IDTIPOMOV  = DBO.ITMO.IDTIPOMOV      
and    DBO.IART.IDARTICULO = DBO.IMOVH.IDARTICULO      
and    DBO.imovh.estado    = 1    
AND    DBO.IMOVH.CANTIDAD > 0
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_TERDIR' AND TYPE='V')
BEGIN
 DROP VIEW VWK_TERDIR
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VWK_TERDIR AS  
SELECT HADM.FECHA, HADM.IDTERCERO, HADM.CERRADA, HADM.FACTURADA, HPRE.CIRUGIA, HPRE.PREFIJO,  
       HPRED.IDPROVEEDOR, HPRED.IDCIRUGIA, HPRED.IDSERVICIO, HPRED.CANTIDAD,  
       HPRED.VALOR, HPRED.VALOR*HPRED.CANTIDAD AS VALORNETO, HPRED.VALORCOPAGO,  
       HPRED.VALORPCOMP,HPRED.VALOREXCEDENTE,HPRE.FECHA AS FECHAPREST, HPRE.IDAREA, HPRE.NOADMISION,
       HPRE.NOPRESTACION, 'QX' AS PROCEDENCIA  
FROM   HADM,HPRE,HPRED  
WHERE  HADM.NOADMISION   = HPRE.NOADMISION  
AND    HPRE.NOPRESTACION = HPRED.NOPRESTACION  
AND    HADM.FACTURABLE   = 1  
AND    HADM.CLASEING     = 'A'
AND    LEN(HPRED.IDPROVEEDOR) > 0  
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_TEXCA' AND TYPE='V')
BEGIN
 DROP VIEW VWK_TEXCA
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VWK_TEXCA AS  
SELECT TER.IDTERCERO, TER.RAZONSOCIAL, TEXCA.IDCATEGORIA, TEXCA.ESTADO, TER.CIUDAD  
FROM   TER,TEXCA  
WHERE  TER.IDTERCERO = TEXCA.IDTERCERO  
AND    TER.ESTADO = 'Activo'  
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VW_MOVTOINVCE' AND TYPE='V')
BEGIN
 DROP VIEW VW_MOVTOINVCE
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VW_MOVTOINVCE WITH SCHEMABINDING  
AS  
SELECT DBO.IMOV.CNSMOV,DBO.AUT.IDCONTRATANTE,DBO.IMOV.FECHAMOV,DBO.IMOVH.IDARTICULO,DBO.IMOVH.CANTIDAD,  
       DBO.ITMO.TIPO,DBO.IMOV.IDTIPOMOV,DBO.IART.IDCLASE,DBO.IART.IDSUBCLASE,  
       DBO.IART.IDGRUPO,DBO.IART.IDPRINACTIVO,DBO.IART.IDFORFARM,DBO.IART.IDCONCENTRA,  
       DBO.IMOV.IDAREA  
FROM DBO.IMOV,DBO.AUT,DBO.ITMO,DBO.IMOVH,DBO.IART  
WHERE DBO.IMOV.NODOCUMENTO = DBO.AUT.NOAUT  
AND DBO.IMOV.CNSMOV     = DBO.IMOVH.CNSMOV  
AND DBO.IMOV.IDTIPOMOV  = DBO.ITMO.IDTIPOMOV  
AND DBO.IART.IDARTICULO = DBO.IMOVH.IDARTICULO  
AND DBO.IMOVH.ESTADO = 1  
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_EXISBODEGA' AND TYPE='V')
BEGIN
 DROP VIEW VWK_EXISBODEGA
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VWK_EXISBODEGA AS  
SELECT IEXI.IDBODEGA,IEXI.IDARTICULO,IART.DESCRIPCION,SUM(IEXI.EXISLOTE) AS EXISTENCIA,
       IART.IDITAR, IART.ESTRANSFORMABLE 
FROM IEXI,IART  
WHERE IEXI.IDARTICULO = IART.IDARTICULO  
GROUP BY IEXI.IDBODEGA,IEXI.IDARTICULO,IART.DESCRIPCION ,IART.IDITAR, IART.ESTRANSFORMABLE  
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_SERTARIFA' AND TYPE='V')
BEGIN
 DROP VIEW VWK_SERTARIFA  
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VWK_SERTARIFA  
AS  
SELECT    TARD.IDTARIFA,SER.PREFIJO,SER.IDSERVICIO,SER.DESCSERVICIO FROM SER,TARD  
WHERE     TARD.IDSERVICIO = SER.IDSERVICIO  
AND       TARD.CIRUGIA = 0  
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VW_EPICRISIS' AND TYPE='V')
BEGIN
 DROP VIEW VW_EPICRISIS
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VW_EPICRISIS  
AS  
SELECT HPRE.NOADMISION,HPRE.NOPRESTACION,SER.PREFIJO,HPRE.FECHA,HPRED.IDSERVICIO,HPRED.CANTIDAD,HPRED.VALOR,  
(HPRED.VALOR * HPRED.CANTIDAD) AS VALORTOTAL,HPRED.VALORCOPAGO,HPRED.VALORPCOMP,HPRED.VALOREXCEDENTE,HPRED.IDCIRUGIA,HPRED.TIPOSERCIRUGIA  
FROM HPRED,HPRE,SER  
WHERE HPRED.NOPRESTACION = HPRE.NOPRESTACION AND  
      HPRED.IDSERVICIO   = SER.IDSERVICIO  
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VW_INFCX' AND TYPE='V')
BEGIN
 DROP VIEW VW_INFCX
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VW_INFCX 
AS  
SELECT HADM.IDTERCERO,HADM.NOADMISION,HADM.VIAINGRESO,HADM.IDAFILIADO,HADM.IDPLAN,HADM.TIPOADM,HADM.DXINGRESO,HADM.FECHA,HADM.FECHAALTA,  
       HADM.CERRADA,HADM.FACTURADA,HADM.N_FACTURA,  
((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) AS EDAD,AFI.SEXO,  
CASE   
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) < 1 THEN 'A'  
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) >= 1 AND ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) < 5 THEN 'B'  
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) >= 5 AND ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) < 15 THEN 'C'  
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) >= 15 AND ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) < 45 THEN 'D'  
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) >= 45 AND ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) < 60 THEN 'E'  
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) >= 60 THEN 'F'  
END  
AS GRUPO_ETAREO,  
CASE   
WHEN HADM.TIPOADM = '01' THEN 0  
WHEN HADM.TIPOADM = '02' THEN ROUND(DATEDIFF(DAY,HADM.FECHA,HADM.FECHAALTA),0) + 1  
WHEN HADM.TIPOADM = '03' THEN 0  
WHEN HADM.TIPOADM = '04' THEN ROUND(DATEDIFF(DAY,HADM.FECHA,HADM.FECHAALTA),0) + 1  
WHEN HADM.TIPOADM = '05' THEN 0  
END  
AS ESTANCIA ,  
QXPCXD.IDSERVICIO,QXPCXD.TIPOCIRUGIA  
from HADM,AFI,HPRE,QXPCXD,QXPCX  
WHERE HADM.FACTURABLE = 1   
AND HADM.IDAFILIADO   = AFI.IDAFILIADO  
AND HADM.CLASEING     = 'A' 
AND HPRE.NOADMISION   = HADM.NOADMISION  
AND HPRE.CIRUGIA      = 'SI'  
AND HPRE.CONSECUTIVO  = QXPCXD.CONSECUTIVO   
AND QXPCX.CONSECUTIVO = QXPCXD.CONSECUTIVO  
AND QXPCX.LIQ_ADC = 1  
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VW_INFDX' AND TYPE='V')
BEGIN
 DROP VIEW VW_INFDX
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VW_INFDX AS  
SELECT HADM.IDTERCERO,HADM.NOADMISION,HADM.VIAINGRESO,HADM.IDAFILIADO,HADM.IDPLAN,HADM.TIPOADM,HADM.DXINGRESO,HADM.FECHA, HADM.FECHAALTA,  
       HADM.CERRADA,HADM.FACTURADA,HADM.N_FACTURA,HADM.NOADMISIONCONT,  
((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) AS EDAD,AFI.SEXO,  
CASE   
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) < 1 THEN 'A'  
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) >= 1 AND ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) < 5 THEN 'B'  
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) >= 5 AND ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) < 15 THEN 'C'  
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) >= 15 AND ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) < 45 THEN 'D'  
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) >= 45 AND ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) < 60 THEN 'E'  
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) >= 60 THEN 'F'  
END  
AS GRUPO_ETAREO,  
ROUND(DATEDIFF(DAY,HADM.FECHA,HADM.FECHAALTA),0) AS ESTANCIA , 
HADM.IDMEDICOING, HADM.IDMEDICOTRA  ,
SUM(HPRE.VALOREXEDENTE) AS VALORADORA,  
SUM(HPRE.VALORPCOMP) AS VALORPCOMP,  
SUM(HPRE.VALORCOPAGO) AS VALORCOPAGO,  
SUM(HPRE.VALORTOTAL) AS VALORTOTAL
from  HADM,AFI,HPRE, HTAD  
WHERE HADM.FACTURABLE = 1   
AND   HADM.IDAFILIADO = AFI.IDAFILIADO  
AND   HPRE.NOADMISION = HADM.NOADMISION  
AND   HADM.TIPOADM    = HTAD.TIPOADM
AND   HTAD.REQHABCAMA = 1
AND   HADM.CLASEING   = 'A' 
/*AND ROUND(DATEDIFF(DAY,HADM.FECHA,HADM.FECHAALTA),0) > 0*/
GROUP BY HADM.IDTERCERO,HADM.NOADMISION,HADM.VIAINGRESO,HADM.IDAFILIADO,HADM.IDPLAN,  
         HADM.TIPOADM,HADM.DXINGRESO,HADM.FECHA,HADM.FECHAALTA,  
         HADM.CERRADA,HADM.FACTURADA,HADM.N_FACTURA,HADM.NOADMISIONCONT,  
         ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25),AFI.SEXO,  
         CASE   
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) < 1 THEN 'A'  
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) >= 1 AND ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) < 5 THEN 'B'  
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) >= 5 AND ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) < 15 THEN 'C'  
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) >= 15 AND ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) < 45 THEN 'D'  
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) >= 45 AND ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) < 60 THEN 'E'  
WHEN ((DATEDIFF(day,AFI.FNACIMIENTO,HADM.FECHA)) / 365.25) >= 60 THEN 'F'  
END  
,ROUND(DATEDIFF(DAY,HADM.FECHA,HADM.FECHAALTA),0) ,HADM.IDMEDICOING, HADM.IDMEDICOTRA  
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VW_PRE_HADM' AND TYPE='V')
BEGIN
 DROP VIEW VW_PRE_HADM  
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VW_PRE_HADM  
AS  
SELECT FMAS.CNSFMAS,HPRE.NOADMISION,HPRE.NOPRESTACION,PRE.PREFIJO,HPRED.IDSERVICIO,HPRED.VALOR,HPRED.CANTIDAD,  
(HPRED.VALOR * HPRED.CANTIDAD) AS VALORTOTAL,HPRED.VALORCOPAGO,HPRED.VALORPCOMP,HPRED.VALOREXCEDENTE,HPRED.IDCIRUGIA,HPRED.TIPOSERCIRUGIA  
FROM PRE,HPRED,HPRE,SER,FMAS,FMASD  
WHERE HPRED.IDSERVICIO = SER.IDSERVICIO  
AND SER.PREFIJO        = PRE.PREFIJO  
AND HPRED.NOPRESTACION = HPRE.NOPRESTACION  
AND HPRE.NOADMISION    = FMASD.NOADMISION  
AND FMAS.CNSFMAS       = FMASD.CNSFMAS  
GO
-- ---------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'SERTOT_PAQNOR' AND XTYPE='V')
BEGIN
   DROP VIEW SERTOT_PAQNOR
END   
-- ----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'SERPRO_PAQNOR' AND XTYPE='V')
BEGIN
   DROP VIEW SERPRO_PAQNOR
END   
-----------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VW_NOMBASCIT' AND XTYPE='V')
BEGIN
   DROP VIEW VW_NOMBASCIT
END
GO 
-----------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VW_NOMBAS1' AND XTYPE='V')
BEGIN
   DROP VIEW VW_NOMBAS1
END
GO 
-----------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VW_NOMBAS' AND XTYPE='V')
BEGIN
   DROP VIEW VW_NOMBAS
END
GO 
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'SERTOT1' AND TYPE='V')
BEGIN
   DROP VIEW SERTOT1
END
GO
-----------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'SERTOT' AND TYPE='V')
BEGIN
   DROP VIEW SERTOT
END
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'SERPRO' AND TYPE='V')
BEGIN
   DROP VIEW SERPRO
END
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'SERETPPAR' AND TYPE='V')
BEGIN
   DROP VIEW SERETPPAR
END
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'SERETP' AND TYPE='V')
BEGIN
   DROP VIEW SERETP
END
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'SERESP' AND TYPE='V')
BEGIN
   DROP VIEW SERESP
END
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'SERESP1' AND TYPE='V')
BEGIN
   DROP VIEW SERESP1
END
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VW_CXPPROTOT' AND XTYPE='V')
   BEGIN
     DROP VIEW VW_CXPPROTOT
   END
GO
-----------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VW_CXPPROSER1' AND XTYPE='V')
   BEGIN
     DROP VIEW VW_CXPPROSER1
   END
GO
-----------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VW_CXPPROSER' AND XTYPE='V')
   BEGIN
      DROP VIEW VW_CXPPROSER
   END
GO
-----------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VW_CXPPROPRE' AND XTYPE='V')
   BEGIN
     DROP VIEW VW_CXPPROPRE
   END
GO
---------------------------------------------------------------------------------------
/* SERETPPAR*/
CREATE VIEW DBO.SERETPPAR WITH SCHEMABINDING    
AS     
SELECT DISTINCT DBO.ETP.IDPROVEEDOR AS IDTERCERO, DBO.ETP.IDTARIFA, DBO.ETP.PREFIJO,    
       DBO.SER.IDSERVICIO,DBO.SER.DESCSERVICIO,DBO.SER.SEXO,DBO.TARDV.VALOR,    
       DBO.ETP.FACTOR,DBO.ETP.IDPLAN,    
       CASE DBO.TARD.CIRUGIA    
            WHEN 1 THEN DBO.TARDV.VALOR    
            ELSE    
            CASE DBO.TARF.REDONDEO
               WHEN 'Unidad' THEN round(DBO.TARDV.VALOR*DBO.ETP.FACTOR*DBO.TARF.FACTORDINERO,0)
               WHEN 'Decena' THEN round(DBO.TARDV.VALOR*DBO.ETP.FACTOR*DBO.TARF.FACTORDINERO,-1)
               WHEN 'Centena' THEN round(DBO.TARDV.VALOR*DBO.ETP.FACTOR*DBO.TARF.FACTORDINERO,-2)
               WHEN 'Millar' THEN round(DBO.TARDV.VALOR*DBO.ETP.FACTOR*DBO.TARF.FACTORDINERO,-3)
               WHEN 'Dos Dec.' THEN round(DBO.TARDV.VALOR*DBO.ETP.FACTOR*DBO.TARF.FACTORDINERO,2)
               WHEN 'SIN' THEN (DBO.TARDV.VALOR*DBO.ETP.FACTOR*DBO.TARF.FACTORDINERO)
               ELSE round(DBO.TARDV.VALOR*DBO.ETP.FACTOR*DBO.TARF.FACTORDINERO,0)    
            END     
       END AS VLRSERVICIO ,DBO.TARD.CIRUGIA,DBO.ETP.PAQUETE,DBO.ETP.TIPOCONTRATO, 
       DBO.TARF.FECHAINI AS FECHAINIFD ,DBO.TARF.FECHAFIN  AS FECHAFINFD,
       DBO.SER.NIVELFUNCIONARIO,DBO.SER.NIVELSEDE,DBO.SER.MOBSOBLIGATORIA,DBO.SER.POS,
       DBO.SER.REQAUTORIZACION,DBO.SER.TIPOAUTORIZACION, 'NA' AS IDACUMULADOR, DBO.SER.MEDICAMENTOS,
       DBO.SER.IDARTICULO, DBO.SER.NIVELATENCION, DBO.SER.IDGENERICO, DBO.TARDV.FECHAINI, DBO.TARDV.FECHAFIN
FROM   DBO.ETP,DBO.SER,DBO.PPT,DBO.TARD,DBO.TAR,DBO.TARF, DBO.TARDV
WHERE  DBO.ETP.PREFIJO = DBO.SER.PREFIJO    
AND    DBO.SER.ESTADO <> 'Inactivo'     
AND    (DBO.ETP.IDPROVEEDOR = DBO.PPT.IDTERCERO AND DBO.ETP.IDPLAN = DBO.PPT.IDPLAN)    
AND    (DBO.ETP.IDTARIFA = DBO.TARD.IDTARIFA AND DBO.TARD.IDSERVICIO = DBO.SER.IDSERVICIO)    
AND    DBO.ETP.FACTOR > 0    
AND    DBO.TARD.IDTARIFA     = DBO.TAR.IDTARIFA    
AND    DBO.TAR.IDTARIFA      = DBO.TARF.IDTARIFA
AND    DBO.TARDV.IDTARIFA    = DBO.TARD.IDTARIFA
AND    DBO.TARDV.IDSERVICIO  = DBO.TARD.IDSERVICIO
AND    DBO.ETP.NIVELATENCION = DBO.SER.NIVELATENCION -- OJO
GO     
-----------------------------------------------
CREATE VIEW DBO.SERPRO WITH SCHEMABINDING    
AS     
SELECT DISTINCT DBO.PPT.IDTERCERO, DBO.PPT.IDTARIFA, DBO.SER.PREFIJO, DBO.TARD.IDSERVICIO,    
       DBO.SER.DESCSERVICIO, DBO.SER.SEXO, DBO.TARDV.VALOR, DBO.PPT.FACTOR, DBO.PPT.IDPLAN,    
       CASE DBO.TARD.CIRUGIA    
            WHEN 1 THEN DBO.TARDV.VALOR    
            ELSE    
               CASE DBO.TARF.REDONDEO
               WHEN 'Unidad'   THEN round(DBO.TARDV.VALOR*DBO.PPT.FACTOR*DBO.TARF.FACTORDINERO,0)
               WHEN 'Decena'   THEN round(DBO.TARDV.VALOR*DBO.PPT.FACTOR*DBO.TARF.FACTORDINERO,-1)
               WHEN 'Centena'  THEN round(DBO.TARDV.VALOR*DBO.PPT.FACTOR*DBO.TARF.FACTORDINERO,-2)
               WHEN 'Millar'   THEN round(DBO.TARDV.VALOR*DBO.PPT.FACTOR*DBO.TARF.FACTORDINERO,-3)
               WHEN 'Dos Dec.' THEN round(DBO.TARDV.VALOR*DBO.PPT.FACTOR*DBO.TARF.FACTORDINERO,2)
               WHEN 'SIN'      THEN (DBO.TARDV.VALOR*DBO.PPT.FACTOR*DBO.TARF.FACTORDINERO)
               ELSE round(DBO.TARDV.VALOR*DBO.PPT.FACTOR*DBO.TARF.FACTORDINERO,0)    
               END     
       END AS VLRSERVICIO , DBO.TARD.CIRUGIA , 0 AS PAQUETE,  
       CASE DBO.PPT.CAPITADO    
            WHEN 1 THEN 'Capitado'  
            ELSE 'Evento'  
       END AS TIPOCONTRATO, DBO.TARF.FECHAINI AS FECHAINIFD, DBO.TARF.FECHAFIN AS FECHAFINFD,
       DBO.SER.NIVELFUNCIONARIO,DBO.SER.NIVELSEDE,DBO.SER.MOBSOBLIGATORIA,DBO.SER.POS,
       DBO.SER.REQAUTORIZACION,DBO.SER.TIPOAUTORIZACION, 'NA' AS IDACUMULADOR, DBO.SER.MEDICAMENTOS,
       DBO.SER.IDARTICULO, DBO.SER.NIVELATENCION, DBO.SER.IDGENERICO, DBO.TARDV.FECHAINI, 
       DBO.TARDV.FECHAFIN, DBO.TAR.CODIFICACION, DBO.SER.CODCUPS
FROM   DBO.TARD,DBO.SER,DBO.PPT, DBO.TARF, DBO.TARDV, DBO.TAR
WHERE  DBO.PPT.IDTARIFA   = DBO.TARD.IDTARIFA    
AND    DBO.TAR.IDTARIFA   = DBO.TARD.IDTARIFA    
AND    DBO.TARD.IDSERVICIO   = DBO.SER.IDSERVICIO    
AND    DBO.SER.ESTADO        <> 'Inactivo'     
AND    DBO.PPT.FACTOR        > 0    
AND    DBO.TARD.IDTARIFA     = DBO.TARF.IDTARIFA
AND    DBO.TARDV.IDTARIFA    = DBO.TARD.IDTARIFA
AND    DBO.TARDV.IDSERVICIO  = DBO.TARD.IDSERVICIO
AND    DBO.SER.IDSERVICIO NOT IN    
       (SELECT DBO.SERETPPAR.IDSERVICIO    
        FROM   DBO.SERETPPAR    
        WHERE  DBO.SERETPPAR.IDTERCERO = DBO.PPT.IDTERCERO    
        AND    DBO.SERETPPAR.IDPLAN    = DBO.PPT.IDPLAN )    
AND    DBO.TARD.IDSERVICIO NOT IN    
       (SELECT DBO.ESP.IDSERVICIO    
        FROM   DBO.ESP    
        WHERE  DBO.ESP.IDPROVEEDOR = DBO.PPT.IDTERCERO    
        AND    DBO.ESP.IDPLAN=DBO.PPT.IDPLAN)  
GO 
-----------------------------------------------------------------------------
-- SERETP --
CREATE VIEW DBO.SERETP WITH SCHEMABINDING    
AS     
SELECT DISTINCT DBO.ETP.IDPROVEEDOR AS IDTERCERO,DBO.ETP.IDTARIFA,DBO.ETP.PREFIJO,    
       DBO.SER.IDSERVICIO,DBO.SER.DESCSERVICIO,DBO.SER.SEXO,DBO.TARDV.VALOR,    
       DBO.ETP.FACTOR,DBO.ETP.IDPLAN,    
       CASE DBO.TARD.CIRUGIA    
            WHEN 1 THEN DBO.TARDV.VALOR    
            ELSE     
            CASE DBO.TARF.REDONDEO
               WHEN 'Unidad'   THEN round(DBO.TARDV.VALOR*DBO.ETP.FACTOR*DBO.TARF.FACTORDINERO,0)
               WHEN 'Decena'   THEN round(DBO.TARDV.VALOR*DBO.ETP.FACTOR*DBO.TARF.FACTORDINERO,-1)
               WHEN 'Centena'  THEN round(DBO.TARDV.VALOR*DBO.ETP.FACTOR*DBO.TARF.FACTORDINERO,-2)
               WHEN 'Millar'   THEN round(DBO.TARDV.VALOR*DBO.ETP.FACTOR*DBO.TARF.FACTORDINERO,-3)
               WHEN 'Dos Dec.' THEN round(DBO.TARDV.VALOR*DBO.ETP.FACTOR*DBO.TARF.FACTORDINERO,2)
               WHEN 'SIN'      THEN (DBO.TARDV.VALOR*DBO.ETP.FACTOR*DBO.TARF.FACTORDINERO)
               ELSE round(DBO.TARDV.VALOR*DBO.ETP.FACTOR*DBO.TARF.FACTORDINERO,0)    
               END     
       END AS VLRSERVICIO ,DBO.TARD.CIRUGIA,DBO.ETP.PAQUETE,DBO.ETP.TIPOCONTRATO, 
       DBO.TARF.FECHAINI AS FECHAINIFD ,DBO.TARF.FECHAFIN  AS FECHAFINFD,
       DBO.SER.NIVELFUNCIONARIO,DBO.SER.NIVELSEDE,DBO.SER.MOBSOBLIGATORIA,DBO.SER.POS,
       DBO.SER.REQAUTORIZACION,DBO.SER.TIPOAUTORIZACION, 'NA' AS IDACUMULADOR, DBO.SER.MEDICAMENTOS,
       DBO.SER.IDARTICULO, DBO.SER.NIVELATENCION, DBO.SER.IDGENERICO, DBO.TARDV.FECHAINI, 
       DBO.TARDV.FECHAFIN, DBO.TAR.CODIFICACION, DBO.SER.CODCUPS
FROM   DBO.ETP,DBO.SER,DBO.PPT,DBO.TARD,DBO.TAR ,DBO.TARF, DBO.TARDV
WHERE  DBO.ETP.PREFIJO = DBO.SER.PREFIJO    
AND    DBO.SER.ESTADO <> 'Inactivo'     
AND    (DBO.ETP.IDPROVEEDOR = DBO.PPT.IDTERCERO AND DBO.ETP.IDPLAN = DBO.PPT.IDPLAN)    
AND    (DBO.ETP.IDTARIFA = DBO.TARD.IDTARIFA AND DBO.TARD.IDSERVICIO = DBO.SER.IDSERVICIO)    
AND    DBO.ETP.FACTOR > 0    
AND    DBO.TARD.IDTARIFA     = DBO.TAR.IDTARIFA    
AND    DBO.TAR.IDTARIFA      = DBO.TARF.IDTARIFA
AND    DBO.ETP.NIVELATENCION = DBO.SER.NIVELATENCION    -- OJO
AND    DBO.TARDV.IDTARIFA    = DBO.TARD.IDTARIFA
AND    DBO.TARDV.IDSERVICIO  = DBO.TARD.IDSERVICIO
AND    DBO.SER.IDSERVICIO NOT IN    
( SELECT DBO.ESP.IDSERVICIO    
  FROM DBO.ESP    
  WHERE DBO.ESP.IDPROVEEDOR = DBO.ETP.IDPROVEEDOR    
  AND DBO.ESP.IDPLAN=DBO.ETP.IDPLAN )    
GO
--------------------------------
/* SERESP*/
CREATE VIEW DBO.SERESP WITH SCHEMABINDING    
AS     
SELECT DISTINCT DBO.ESP.IDPROVEEDOR AS IDTERCERO,DBO.ESP.IDTARIFA,DBO.SER.PREFIJO AS PREFIJO,DBO.ESP.IDSERVICIO,
       DBO.SER.DESCSERVICIO,DBO.SER.SEXO,DBO.ESP.VALOR,DBO.ESP.FACTOR,DBO.ESP.IDPLAN,    
       CASE DBO.TARD.CIRUGIA    
       WHEN 1 THEN DBO.TARDV.VALOR    
       ELSE    
                   CASE DBO.TARF.REDONDEO
                        WHEN 'Unidad'   THEN round(DBO.TARDV.VALOR*DBO.ESP.FACTOR*DBO.TARF.FACTORDINERO,0)
                        WHEN 'Decena'   THEN round(DBO.TARDV.VALOR*DBO.ESP.FACTOR*DBO.TARF.FACTORDINERO,-1)
                        WHEN 'Centena'  THEN round(DBO.TARDV.VALOR*DBO.ESP.FACTOR*DBO.TARF.FACTORDINERO,-2)
                        WHEN 'Millar'   THEN round(DBO.TARDV.VALOR*DBO.ESP.FACTOR*DBO.TARF.FACTORDINERO,-3)
                        WHEN 'Dos Dec.' THEN round(DBO.TARDV.VALOR*DBO.ESP.FACTOR*DBO.TARF.FACTORDINERO,2)
                        WHEN 'SIN'      THEN (DBO.TARDV.VALOR*DBO.ESP.FACTOR*DBO.TARF.FACTORDINERO)
                        ELSE round(DBO.TARDV.VALOR*DBO.ESP.FACTOR*DBO.TARF.FACTORDINERO,0)    
                   END     
       END AS VLRSERVICIO ,
       DBO.TARD.CIRUGIA, DBO.ESP.PAQUETE, DBO.ESP.TIPOCONTRATO,
       DBO.TARF.FECHAINI AS FECHAINIFD, DBO.TARF.FECHAFIN AS FECHAFINFD,
       DBO.SER.NIVELFUNCIONARIO, DBO.SER.NIVELSEDE, DBO.SER.MOBSOBLIGATORIA, DBO.SER.POS,
       DBO.SER.REQAUTORIZACION, DBO.SER.TIPOAUTORIZACION, DBO.ESP.IDACUMULADOR, DBO.SER.MEDICAMENTOS,
       DBO.SER.IDARTICULO, DBO.SER.NIVELATENCION, DBO.SER.IDGENERICO, DBO.TARDV.FECHAINI, 
       DBO.TARDV.FECHAFIN, DBO.TAR.CODIFICACION, DBO.SER.CODCUPS 
FROM   DBO.ESP, DBO.SER, DBO.TARF, DBO.TAR, DBO.TARD, DBO.TARDV
WHERE  DBO.SER.IDSERVICIO      = DBO.ESP.IDSERVICIO    
AND    DBO.ESP.IDSERVICIO      = TARD.IDSERVICIO
AND    DBO.ESP.IDTARIFA        = TAR.IDTARIFA
AND    DBO.TARD.IDTARIFA       = DBO.TAR.IDTARIFA    
AND    DBO.TAR.IDTARIFA        = DBO.TARF.IDTARIFA
AND    DBO.TARDV.IDTARIFA      = DBO.TARD.IDTARIFA
AND    DBO.TARDV.IDSERVICIO    = DBO.TARD.IDSERVICIO
AND    DBO.ESP.TIPORESTRICCION = 'Tarifa'    
GO
-----------------------------------------------------------------------------------------------------
/*SERESP1*/ 
CREATE VIEW DBO.SERESP1 WITH SCHEMABINDING    
AS     
SELECT DISTINCT DBO.ESP.IDPROVEEDOR AS IDTERCERO,DBO.ESP.IDTARIFA,DBO.SER.PREFIJO AS PREFIJO,DBO.ESP.IDSERVICIO,    
       DBO.SER.DESCSERVICIO,DBO.SER.SEXO,DBO.ESP.VALOR,DBO.ESP.FACTOR,DBO.ESP.IDPLAN,    
       DBO.esp.valor AS VLRSERVICIO ,
       CASE DBO.ESP.PAQUETE
       WHEN 1 THEN 1
       ELSE 0
       END AS CIRUGIA,
       DBO.ESP.PAQUETE,DBO.ESP.TIPOCONTRATO,
       '01/01/2002' AS FECHAINIFD,'31/12/2012 23:59:59.999' AS FECHAFINFD,
       DBO.SER.NIVELFUNCIONARIO,DBO.SER.NIVELSEDE,DBO.SER.MOBSOBLIGATORIA,DBO.SER.POS,
       DBO.SER.REQAUTORIZACION,DBO.SER.TIPOAUTORIZACION, DBO.ESP.IDACUMULADOR, DBO.SER.MEDICAMENTOS,
       DBO.SER.IDARTICULO, DBO.SER.NIVELATENCION, DBO.SER.IDGENERICO, '01/01/2002' AS FECHAINI,
       '31/12/2012 23:59:59.999' AS FECHAFIN, DBO.SER.CODCUPS
FROM   DBO.ESP,DBO.SER
WHERE  DBO.SER.IDSERVICIO = DBO.ESP.IDSERVICIO    
AND    DBO.ESP.TIPORESTRICCION = 'Valor'    
GO
----------------------------------------------------------------------------------
/*SERTOT*/
 CREATE VIEW DBO.SERTOT WITH SCHEMABINDING AS    
   SELECT DBO.SERPRO.IDTERCERO,DBO.SERPRO.IDTARIFA,DBO.SERPRO.PREFIJO,DBO.SERPRO.IDSERVICIO,    
          DBO.SERPRO.DESCSERVICIO,DBO.SERPRO.SEXO,DBO.SERPRO.VALOR,    
          DBO.SERPRO.FACTOR,DBO.SERPRO.IDPLAN, CAST(DBO.SERPRO.VLRSERVICIO AS DECIMAL(37,11)) AS VLRSERVICIO,
          DBO.SERPRO.CIRUGIA,DBO.SERPRO.PAQUETE,  
          DBO.SERPRO.TIPOCONTRATO,DBO.SERPRO.FECHAINIFD,DBO.SERPRO.FECHAFINFD,
          DBO.SERPRO.NIVELFUNCIONARIO,DBO.SERPRO.NIVELSEDE,DBO.SERPRO.MOBSOBLIGATORIA,DBO.SERPRO.POS,
          DBO.SERPRO.REQAUTORIZACION,DBO.SERPRO.TIPOAUTORIZACION, DBO.SERPRO.IDACUMULADOR, DBO.SERPRO.MEDICAMENTOS,
          DBO.SERPRO.IDARTICULO, DBO.SERPRO.NIVELATENCION, DBO.SERPRO.IDGENERICO,
          DBO.SERPRO.FECHAINI, DBO.SERPRO.FECHAFIN, '00000000000000000000' AS IDTERCEROCA, 
          '000000' AS IDPLANCA, 0 AS REQAUTORIZACIONCA,
          '00000000000000000000' AS IDAREACA, DBO.SERPRO.CODIFICACION, DBO.SERPRO.CODCUPS
   FROM DBO.SERPRO    
UNION ALL    
   SELECT DBO.SERETP.IDTERCERO,DBO.SERETP.IDTARIFA,DBO.SERETP.PREFIJO,DBO.SERETP.IDSERVICIO,    
          DBO.SERETP.DESCSERVICIO,DBO.SERETP.SEXO,DBO.SERETP.VALOR,    
          DBO.SERETP.FACTOR,DBO.SERETP.IDPLAN, CAST(DBO.SERETP.VLRSERVICIO AS DECIMAL(37,11)) AS VALORSERVICIO, 
          DBO.SERETP.CIRUGIA,DBO.SERETP.PAQUETE,  
          DBO.SERETP.TIPOCONTRATO,DBO.SERETP.FECHAINIFD,DBO.SERETP.FECHAFINFD,
          DBO.SERETP.NIVELFUNCIONARIO,DBO.SERETP.NIVELSEDE,DBO.SERETP.MOBSOBLIGATORIA,DBO.SERETP.POS,
          DBO.SERETP.REQAUTORIZACION,DBO.SERETP.TIPOAUTORIZACION, DBO.SERETP.IDACUMULADOR, DBO.SERETP.MEDICAMENTOS,
          DBO.SERETP.IDARTICULO, DBO.SERETP.NIVELATENCION, DBO.SERETP.IDGENERICO,
          DBO.SERETP.FECHAINI, DBO.SERETP.FECHAFIN, '00000000000000000000' AS IDTERCEROCA, 
          '000000' AS IDPLANCA, 0 AS REQAUTORIZACIONCA,
          '00000000000000000000' AS IDAREACA, DBO.SERETP.CODIFICACION, DBO.SERETP.CODCUPS 
   FROM DBO.SERETP    
UNION ALL    
   SELECT DBO.SERESP.IDTERCERO,DBO.SERESP.IDTARIFA,DBO.SERESP.PREFIJO,DBO.SERESP.IDSERVICIO,    
          DBO.SERESP.DESCSERVICIO,DBO.SERESP.SEXO,DBO.SERESP.VALOR,    
          DBO.SERESP.FACTOR,DBO.SERESP.IDPLAN, CAST(DBO.SERESP.VLRSERVICIO AS DECIMAL(37,11)) AS VALORSERVICIO,
          DBO.SERESP.CIRUGIA,DBO.SERESP.PAQUETE,  
          DBO.SERESP.TIPOCONTRATO,DBO.SERESP.FECHAINIFD,DBO.SERESP.FECHAFINFD,
          DBO.SERESP.NIVELFUNCIONARIO,DBO.SERESP.NIVELSEDE,DBO.SERESP.MOBSOBLIGATORIA,DBO.SERESP.POS,
          DBO.SERESP.REQAUTORIZACION,DBO.SERESP.TIPOAUTORIZACION, DBO.SERESP.IDACUMULADOR, DBO.SERESP.MEDICAMENTOS,
          DBO.SERESP.IDARTICULO, DBO.SERESP.NIVELATENCION, DBO.SERESP.IDGENERICO,
          DBO.SERESP.FECHAINI, DBO.SERESP.FECHAFIN, '00000000000000000000' AS IDTERCEROCA, 
          '000000' AS IDPLANCA, 0 AS REQAUTORIZACIONCA,
          '00000000000000000000' AS IDAREACA, DBO.SERESP.CODIFICACION, DBO.SERESP.CODCUPS 
   FROM DBO.SERESP    
UNION ALL    
   SELECT DBO.SERESP1.IDTERCERO,DBO.SERESP1.IDTARIFA,DBO.SERESP1.PREFIJO,DBO.SERESP1.IDSERVICIO,    
          DBO.SERESP1.DESCSERVICIO,DBO.SERESP1.SEXO,DBO.SERESP1.VALOR,    
          DBO.SERESP1.FACTOR,DBO.SERESP1.IDPLAN, CAST(DBO.SERESP1.VLRSERVICIO AS DECIMAL(37,11)) AS VALORSERVICIO,
          DBO.SERESP1.CIRUGIA,DBO.SERESP1.PAQUETE,  
          DBO.SERESP1.TIPOCONTRATO,DBO.SERESP1.FECHAINIFD,DBO.SERESP1.FECHAFINFD,
          DBO.SERESP1.NIVELFUNCIONARIO,DBO.SERESP1.NIVELSEDE,DBO.SERESP1.MOBSOBLIGATORIA,DBO.SERESP1.POS,
          DBO.SERESP1.REQAUTORIZACION,DBO.SERESP1.TIPOAUTORIZACION, DBO.SERESP1.IDACUMULADOR, DBO.SERESP1.MEDICAMENTOS,
          DBO.SERESP1.IDARTICULO, DBO.SERESP1.NIVELATENCION, DBO.SERESP1.IDGENERICO,
          DBO.SERESP1.FECHAINI, DBO.SERESP1.FECHAFIN, '00000000000000000000' AS IDTERCEROCA, 
          '000000' AS IDPLANCA, 0 AS REQAUTORIZACIONCA,
          '00000000000000000000' AS IDAREACA, '' AS CODIFICACION, DBO.SERESP1.CODCUPS 
   FROM DBO.SERESP1    
GO
-----------------------------------------------
CREATE VIEW DBO.VW_CXPPROPRE WITH SCHEMABINDING    
AS     
SELECT DISTINCT DBO.PXS.IDTERCERO, DBO.PXS.IDADMINISTRADORA, DBO.PXS.PREFIJO, DBO.TARD.IDSERVICIO, 
       DBO.SER.DESCSERVICIO, DBO.PXS.IDTARIFA,  DBO.PXS.FACTOR, DBO.PXS.IDPLAN, DBO.TARDV.VALOR,
       CASE DBO.TARD.CIRUGIA    
            WHEN 1 THEN DBO.TARDV.VALOR    
            ELSE    
               CASE DBO.TARF.REDONDEO
               WHEN 'Unidad'   THEN round(DBO.TARDV.VALOR*DBO.PXS.FACTOR*DBO.TARF.FACTORDINERO,0)
               WHEN 'Decena'   THEN round(DBO.TARDV.VALOR*DBO.PXS.FACTOR*DBO.TARF.FACTORDINERO,-1)
               WHEN 'Centena'  THEN round(DBO.TARDV.VALOR*DBO.PXS.FACTOR*DBO.TARF.FACTORDINERO,-2)
               WHEN 'Millar'   THEN round(DBO.TARDV.VALOR*DBO.PXS.FACTOR*DBO.TARF.FACTORDINERO,-3)
               WHEN 'Dos Dec.' THEN ROUND(DBO.TARDV.VALOR*DBO.PXS.FACTOR*DBO.TARF.FACTORDINERO,2)
               WHEN 'SIN'      THEN (DBO.TARDV.VALOR*DBO.PXS.FACTOR*DBO.TARF.FACTORDINERO)
               ELSE round(DBO.TARDV.VALOR*DBO.PXS.FACTOR*DBO.TARF.FACTORDINERO,0)    
               END     
       END AS VLRSERVICIO , DBO.TARD.CIRUGIA , 0 AS PAQUETE,  
       DBO.TARF.FECHAINI AS FECHAINIFD,DBO.TARF.FECHAFIN AS FECHAFINFD, DBO.SER.IDGENERICO,
       DBO.TARDV.FECHAINI, DBO.TARDV.FECHAFIN , SER.NIVELATENCION
FROM   DBO.PXS, DBO.SER, DBO.TARD, DBO.TARF, DBO.TARDV
WHERE  DBO.TARD.IDTARIFA  = DBO.PXS.IDTARIFA
AND    DBO.SER.IDSERVICIO = DBO.TARD.IDSERVICIO
AND    DBO.SER.PREFIJO    = DBO.PXS.PREFIJO
AND    DBO.SER.ESTADO <> 'Inactivo'     
AND    DBO.PXS.FACTOR > 0    
AND    DBO.TARD.IDTARIFA     = DBO.TARF.IDTARIFA
AND    DBO.TARDV.IDTARIFA    = DBO.TARD.IDTARIFA
AND    DBO.TARDV.IDSERVICIO  = DBO.TARD.IDSERVICIO
--     ARREGLOS PARA NO TENER EN CUENTA EL NIVEL DE ATENCION
--AND    DBO.PXS.NIVELATENCION = SER.NIVELATENCION
AND    DBO.TARD.IDSERVICIO NOT IN    
 (SELECT DBO.PXSE.IDSERVICIO    
  FROM   DBO.PXSE    
  WHERE  DBO.PXSE.IDTERCERO = DBO.PXS.IDTERCERO    
  AND    DBO.PXSE.IDPLAN    = DBO.PXS.IDPLAN
  AND    DBO.PXSE.IDADMINISTRADORA = DBO.PXS.IDADMINISTRADORA)    
GO
-----------------------------------------------
CREATE VIEW DBO.VW_CXPPROSER WITH SCHEMABINDING    
AS     
SELECT DISTINCT DBO.PXSE.IDTERCERO, DBO.PXSE.IDADMINISTRADORA, DBO.SER.PREFIJO, DBO.TARD.IDSERVICIO, 
       DBO.SER.DESCSERVICIO, DBO.PXSE.IDTARIFA,  DBO.PXSE.FACTOR, DBO.PXSE.IDPLAN, 
       DBO.TARD.VALOR,
       CASE DBO.TARD.CIRUGIA    
            WHEN 1 THEN DBO.TARDV.VALOR    
            ELSE    
               CASE DBO.TARF.REDONDEO
               WHEN 'Unidad'   THEN round(DBO.TARDV.VALOR*DBO.PXSE.FACTOR*DBO.TARF.FACTORDINERO,0)
               WHEN 'Decena'   THEN round(DBO.TARDV.VALOR*DBO.PXSE.FACTOR*DBO.TARF.FACTORDINERO,-1)
               WHEN 'Centena'  THEN round(DBO.TARDV.VALOR*DBO.PXSE.FACTOR*DBO.TARF.FACTORDINERO,-2)
               WHEN 'Millar'   THEN round(DBO.TARDV.VALOR*DBO.PXSE.FACTOR*DBO.TARF.FACTORDINERO,-3)
               WHEN 'Dos Dec.' THEN round(DBO.TARDV.VALOR*DBO.PXSE.FACTOR*DBO.TARF.FACTORDINERO,2)
               WHEN 'SIN'      THEN (DBO.TARDV.VALOR*DBO.PXSE.FACTOR*DBO.TARF.FACTORDINERO)
               ELSE round(DBO.TARDV.VALOR*DBO.PXSE.FACTOR*DBO.TARF.FACTORDINERO,0)    
               END     
       END AS VLRSERVICIO , DBO.TARD.CIRUGIA , 0 AS PAQUETE,  
       DBO.TARF.FECHAINI AS FECHAINIFD,DBO.TARF.FECHAFIN AS FECHAFINFD, DBO.SER.IDGENERICO,
       DBO.TARDV.FECHAINI, DBO.TARDV.FECHAFIN, SER.NIVELATENCION
FROM DBO.PXSE,DBO.SER,DBO.TARF,DBO.TAR,DBO.TARD, DBO.TARDV
WHERE DBO.SER.IDSERVICIO = DBO.PXSE.IDSERVICIO    
AND DBO.PXSE.IDSERVICIO = TARD.IDSERVICIO
AND DBO.PXSE.IDTARIFA = TAR.IDTARIFA
AND DBO.TARD.IDTARIFA = DBO.TAR.IDTARIFA    
AND DBO.TAR.IDTARIFA = DBO.TARF.IDTARIFA
AND DBO.TARDV.IDTARIFA    = DBO.TARD.IDTARIFA
AND DBO.TARDV.IDSERVICIO  = DBO.TARD.IDSERVICIO
AND DBO.PXSE.TIPORESTRICCION = 'Tarifa'    
GO
-----------------------------------------------
CREATE VIEW DBO.VW_CXPPROSER1 WITH SCHEMABINDING    
AS     
SELECT DISTINCT DBO.PXSE.IDTERCERO, DBO.PXSE.IDADMINISTRADORA, DBO.SER.PREFIJO, DBO.SER.IDSERVICIO, 
       DBO.SER.DESCSERVICIO, DBO.PXSE.IDTARIFA,  DBO.PXSE.FACTOR, DBO.PXSE.IDPLAN, 
       DBO.PXSE.VALOR, DBO.PXSE.VALOR AS VLRSERVICIO , DBO.SER.CIRUGIA , 0 AS PAQUETE,  
       '01/01/2002' AS FECHAINIFD,'31/12/2012 23:59:59.999' AS FECHAFINFD, DBO.SER.IDGENERICO,
       '01/01/2002' AS FECHAINI,'31/12/2012 23:59:59.999' AS FECHAFIN  , SER.NIVELATENCION
FROM   DBO.PXSE,DBO.SER
WHERE  DBO.SER.IDSERVICIO = DBO.PXSE.IDSERVICIO    
AND    DBO.PXSE.TIPORESTRICCION = 'Valor'    
GO
-----------------------------------------------
CREATE VIEW DBO.VW_CXPPROTOT WITH SCHEMABINDING    
AS     
SELECT DBO.VW_CXPPROPRE.IDTERCERO, DBO.VW_CXPPROPRE.IDADMINISTRADORA,
       DBO.VW_CXPPROPRE.PREFIJO, DBO.VW_CXPPROPRE.IDSERVICIO, DBO.VW_CXPPROPRE.DESCSERVICIO,
       DBO.VW_CXPPROPRE.IDTARIFA, DBO.VW_CXPPROPRE.FACTOR, DBO.VW_CXPPROPRE.IDPLAN,
       DBO.VW_CXPPROPRE.VALOR, DBO.VW_CXPPROPRE.VLRSERVICIO, DBO.VW_CXPPROPRE.CIRUGIA,
       DBO.VW_CXPPROPRE.PAQUETE, DBO.VW_CXPPROPRE.FECHAINIFD, DBO.VW_CXPPROPRE.FECHAFINFD,
       DBO.VW_CXPPROPRE.IDGENERICO, DBO.VW_CXPPROPRE.FECHAINI, DBO.VW_CXPPROPRE.FECHAFIN,
       DBO.VW_CXPPROPRE.NIVELATENCION
FROM   DBO.VW_CXPPROPRE 
UNION ALL
SELECT DBO.VW_CXPPROSER.IDTERCERO, DBO.VW_CXPPROSER.IDADMINISTRADORA,
       DBO.VW_CXPPROSER.PREFIJO, DBO.VW_CXPPROSER.IDSERVICIO, DBO.VW_CXPPROSER.DESCSERVICIO,
       DBO.VW_CXPPROSER.IDTARIFA, DBO.VW_CXPPROSER.FACTOR, DBO.VW_CXPPROSER.IDPLAN,
       DBO.VW_CXPPROSER.VALOR, DBO.VW_CXPPROSER.VLRSERVICIO, DBO.VW_CXPPROSER.CIRUGIA,
       DBO.VW_CXPPROSER.PAQUETE, DBO.VW_CXPPROSER.FECHAINIFD, DBO.VW_CXPPROSER.FECHAFINFD,
       DBO.VW_CXPPROSER.IDGENERICO, DBO.VW_CXPPROSER.FECHAINI, DBO.VW_CXPPROSER.FECHAFIN,
       DBO.VW_CXPPROSER.NIVELATENCION
FROM   DBO.VW_CXPPROSER
UNION ALL
SELECT DBO.VW_CXPPROSER1.IDTERCERO, DBO.VW_CXPPROSER1.IDADMINISTRADORA,
       DBO.VW_CXPPROSER1.PREFIJO, DBO.VW_CXPPROSER1.IDSERVICIO, DBO.VW_CXPPROSER1.DESCSERVICIO,
       DBO.VW_CXPPROSER1.IDTARIFA, DBO.VW_CXPPROSER1.FACTOR, DBO.VW_CXPPROSER1.IDPLAN,
       DBO.VW_CXPPROSER1.VALOR, DBO.VW_CXPPROSER1.VLRSERVICIO, DBO.VW_CXPPROSER1.CIRUGIA,
       DBO.VW_CXPPROSER1.PAQUETE, DBO.VW_CXPPROSER1.FECHAINIFD, DBO.VW_CXPPROSER1.FECHAFINFD,
       DBO.VW_CXPPROSER1.IDGENERICO, DBO.VW_CXPPROSER1.FECHAINI, DBO.VW_CXPPROSER1.FECHAFIN,
       DBO.VW_CXPPROSER1.NIVELATENCION
FROM   DBO.VW_CXPPROSER1
GO
-----------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VW_NOMBAS' AND TYPE='V')
BEGIN
   DROP VIEW VW_NOMBAS
END
GO
-----------------------------------------------
CREATE VIEW DBO.VW_NOMBAS WITH SCHEMABINDING      
AS       
SELECT DISTINCT DBO.SERTOT.IDTERCERO AS IDADMINISTRADORA, DBO.SERTOT.IDPLAN, DBO.SERTOT.IDSERVICIO,   
       DBO.SERTOT.DESCSERVICIO,   
       CASE DBO.SERTOT.CIRUGIA  
       WHEN 1 THEN  
            (SELECT CASE DBO.TARF.REDONDEO  
                     WHEN 'Unidad'   THEN round(DBO.SERTOT.VALOR*DBO.SERTOT.FACTOR*DBO.TARF.FACTORDINERO,0)  
                     WHEN 'Decena'   THEN round(DBO.SERTOT.VALOR*DBO.SERTOT.FACTOR*DBO.TARF.FACTORDINERO,-1)  
                     WHEN 'Centena'  THEN round(DBO.SERTOT.VALOR*DBO.SERTOT.FACTOR*DBO.TARF.FACTORDINERO,-2)  
                     WHEN 'Millar'   THEN round(DBO.SERTOT.VALOR*DBO.SERTOT.FACTOR*DBO.TARF.FACTORDINERO,-3)  
                     WHEN 'Dos Dec.' THEN round(DBO.SERTOT.VALOR*DBO.SERTOT.FACTOR*DBO.TARF.FACTORDINERO,2)  
                     WHEN 'SIN'      THEN (DBO.SERTOT.VALOR*DBO.SERTOT.FACTOR*DBO.TARF.FACTORDINERO)  
                     ELSE round(DBO.SERTOT.VALOR*DBO.SERTOT.FACTOR*DBO.TARF.FACTORDINERO,0)      
                    END   
               FROM  DBO.TARF    
               WHERE TARF.IDTARIFA = DBO.SERTOT.IDTARIFA AND 
               /* Inicio 13/08/2005 By LSaez */TARF.FECHAINI=DBO.SERTOT.FECHAINIFD AND TARF.FECHAFIN=SERTOT.FECHAFINFD) /* Fin. 13/08/2005 By LSaez */
       ELSE DBO.SERTOT.VLRSERVICIO  
       END AS VLRSERVICIO,  
       DBO.SERTOT.SEXO,   
       DBO.SERTOT.FECHAINIFD AS FECHAINIADM, DBO.SERTOT.FECHAFINFD AS FECHAFINADM,   
       DBO.SERTOT.NIVELFUNCIONARIO, DBO.SERTOT.NIVELSEDE,   
       DBO.VW_CXPPROTOT.VLRSERVICIO AS VLRCXP, DBO.VW_CXPPROTOT.IDTERCERO AS IDPROVEEDOR,  
       DBO.VW_CXPPROTOT.FECHAINIFD AS FECHAINIPRO, DBO.VW_CXPPROTOT.FECHAFINFD AS FECHAFINPRO,  
       DBO.SERTOT.IDACUMULADOR, DBO.SERTOT.REQAUTORIZACION, DBO.SERTOT.PREFIJO,  
          DBO.SERTOT.TIPOAUTORIZACION, DBO.SERTOT.FECHAINI AS FECHAINIADMSER,   
       DBO.SERTOT.FECHAFIN AS FECHAFINADMSER, DBO.VW_CXPPROTOT.FECHAINI AS FECHAINIPROSER,  
       DBO.VW_CXPPROTOT.FECHAFIN AS FECHAFINPROSER,   
       DBO.SERTOT.IDTERCEROCA,DBO.SERTOT.IDPLANCA,DBO.SERTOT.REQAUTORIZACIONCA,DBO.SERTOT.IDAREACA  
FROM   DBO.SERTOT INNER JOIN  DBO.VW_CXPPROTOT  
       ON     DBO.SERTOT.IDSERVICIO = DBO.VW_CXPPROTOT.IDSERVICIO  
       AND    DBO.SERTOT.IDTERCERO  = DBO.VW_CXPPROTOT.IDADMINISTRADORA  
GO 
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VW_NOMBASCIT' AND TYPE='V')
BEGIN
   DROP VIEW VW_NOMBASCIT
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VW_NOMBASCIT WITH SCHEMABINDING    
AS
SELECT DBO.SERTOT.IDTERCERO AS IDADMINISTRADORA, DBO.SERTOT.IDPLAN, DBO.SERTOT.IDSERVICIO, 
       DBO.SERTOT.DESCSERVICIO, DBO.SERTOT.VLRSERVICIO, DBO.SERTOT.SEXO, 
       DBO.SERTOT.FECHAINIFD AS FECHAINIADM, DBO.SERTOT.FECHAFINFD AS FECHAFINADM, 
       DBO.SERTOT.NIVELFUNCIONARIO, DBO.SERTOT.NIVELSEDE,
       DBO.SERTOT.IDACUMULADOR, DBO.SERTOT.REQAUTORIZACION, DBO.SERTOT.PREFIJO,
       DBO.SERTOT.TIPOAUTORIZACION, DBO.SERTOT.FECHAINI AS FECHAINIADMSER, 
       DBO.SERTOT.FECHAFIN AS FECHAFINADMSER, DBO.SERTOT.IDTERCEROCA, DBO.SERTOT.IDPLANCA, 
       DBO.SERTOT.REQAUTORIZACIONCA, DBO.SERTOT.IDAREACA, DBO.MESS.IDEMEDICA   
FROM   DBO.SERTOT INNER JOIN DBO.MESS ON DBO.SERTOT.IDSERVICIO = DBO.MESS.IDSERVICIO
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'SERTOT1' AND TYPE='V')
BEGIN
   DROP VIEW SERTOT1
END
GO 
-- -----------------------------------------
CREATE VIEW DBO.SERTOT1 WITH SCHEMABINDING    
AS
SELECT DBO.SERTOT.IDTERCERO, DBO.SERTOT.IDTARIFA, DBO.SERTOT.PREFIJO, DBO.SERTOT.IDSERVICIO, DBO.SERTOT.DESCSERVICIO, 
       DBO.SERTOT.SEXO, DBO.SERTOT.VALOR, DBO.SERTOT.FACTOR, SERTOT.IDPLAN , SERTOT.VLRSERVICIO ,SERTOT.CIRUGIA,
       DBO.SERTOT.PAQUETE, DBO.SERTOT.TIPOCONTRATO, DBO.SERTOT.FECHAINIFD, DBO.SERTOT.FECHAFINFD, 
       DBO.SERTOT.NIVELFUNCIONARIO, DBO.SERTOT.NIVELSEDE, DBO.SERTOT.MOBSOBLIGATORIA, DBO.SERTOT.POS, 
       DBO.SERTOT.REQAUTORIZACION, DBO.SERTOT.TIPOAUTORIZACION, DBO.SERTOT.IDACUMULADOR, DBO.SERTOT.MEDICAMENTOS, 
       DBO.SERTOT.IDARTICULO, DBO.SERTOT.NIVELATENCION, DBO.SERTOT.IDGENERICO, DBO.SERTOT.FECHAINI, 
       DBO.SERTOT.FECHAFIN, CPPAF.IDTERCEROCA, CPPAF.IDPLANCA, 
       CPPAF.REQAUTORIZACION AS REQAUTORIZACIONCA, CPPAF.IDAREA AS IDAREACA, DBO.SERTOT.CODIFICACION, DBO.SERTOT.CODCUPS
FROM   DBO.SERTOT, DBO.CPPAF
WHERE  DBO.SERTOT.IDPLAN     = DBO.CPPAF.IDPLAN
AND    DBO.SERTOT.IDSERVICIO = DBO.CPPAF.IDSERVICIO      
GO 
/*      CAJA DE COMPENSACION 

CREATE VIEW DBO.SERTOT1 WITH SCHEMABINDING    
AS
SELECT DBO.SERTOT.IDTERCERO, DBO.SERTOT.IDTARIFA, DBO.SERTOT.PREFIJO, DBO.SERTOT.IDSERVICIO, DBO.SERTOT.DESCSERVICIO, 
       DBO.SERTOT.SEXO, DBO.SERTOT.VALOR, DBO.SERTOT.FACTOR, SERTOT.IDPLAN , SERTOT.VLRSERVICIO ,SERTOT.CIRUGIA,
       DBO.SERTOT.PAQUETE, DBO.SERTOT.TIPOCONTRATO, DBO.SERTOT.FECHAINIFD, DBO.SERTOT.FECHAFINFD, 
       DBO.SERTOT.NIVELFUNCIONARIO, DBO.SERTOT.NIVELSEDE, DBO.SERTOT.MOBSOBLIGATORIA, DBO.SERTOT.POS, 
       DBO.SERTOT.REQAUTORIZACION, DBO.SERTOT.TIPOAUTORIZACION, DBO.SERTOT.IDACUMULADOR, DBO.SERTOT.MEDICAMENTOS, 
       DBO.SERTOT.IDARTICULO, DBO.SERTOT.NIVELATENCION, DBO.SERTOT.IDGENERICO, DBO.SERTOT.FECHAINI, 
       DBO.SERTOT.FECHAFIN, DBO.SERTOT.IDTERCERO AS IDTERCEROCA, DBO.SERTOT.IDPLAN AS IDPLANCA, 
       0 AS REQAUTORIZACIONCA, AFU.IDAREA AS IDAREACA
FROM   DBO.SERTOT, DBO.AFU
GO */
 
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VW_NOMBAS1' AND TYPE='V')
BEGIN
   DROP VIEW VW_NOMBAS1
END
GO
-----------------------------------------------
CREATE VIEW DBO.VW_NOMBAS1 WITH SCHEMABINDING    
AS     
SELECT DISTINCT DBO.SERTOT1.IDTERCERO AS IDADMINISTRADORA, DBO.SERTOT1.IDPLAN, DBO.SERTOT1.IDSERVICIO, 
       DBO.SERTOT1.DESCSERVICIO, DBO.SERTOT1.VLRSERVICIO, DBO.SERTOT1.SEXO, 
       DBO.SERTOT1.FECHAINIFD AS FECHAINIADM, DBO.SERTOT1.FECHAFINFD AS FECHAFINADM, 
       DBO.SERTOT1.NIVELFUNCIONARIO, DBO.SERTOT1.NIVELSEDE, 
       DBO.VW_CXPPROTOT.VLRSERVICIO AS VLRCXP, DBO.VW_CXPPROTOT.IDTERCERO AS IDPROVEEDOR,
       DBO.VW_CXPPROTOT.FECHAINIFD AS FECHAINIPRO, DBO.VW_CXPPROTOT.FECHAFINFD AS FECHAFINPRO,
       DBO.SERTOT1.IDACUMULADOR, DBO.SERTOT1.REQAUTORIZACION, DBO.SERTOT1.PREFIJO,
       DBO.SERTOT1.TIPOAUTORIZACION, DBO.SERTOT1.FECHAINI AS FECHAINIADMSER, 
       DBO.SERTOT1.FECHAFIN AS FECHAFINADMSER, DBO.VW_CXPPROTOT.FECHAINI AS FECHAINIPROSER,
       DBO.VW_CXPPROTOT.FECHAFIN AS FECHAFINPROSER, 
       DBO.VW_CXPPROTOT.NIVELATENCION, DBO.SERTOT1.IDTERCEROCA, DBO.SERTOT1.IDPLANCA,
       DBO.SERTOT1.REQAUTORIZACIONCA, DBO.SERTOT1.IDAREACA
FROM   DBO.SERTOT1, DBO.VW_CXPPROTOT
WHERE  DBO.SERTOT1.IDSERVICIO = DBO.VW_CXPPROTOT.IDSERVICIO
AND    DBO.SERTOT1.IDTERCERO  = DBO.VW_CXPPROTOT.IDADMINISTRADORA
-- -----------------------------------------
GO 
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VW_PXS' AND TYPE='V')
BEGIN
   DROP VIEW VW_PXS
END
GO 
-- -----------------------------------------
CREATE VIEW DBO.VW_PXS AS  
SELECT DISTINCT PXS.IDSEDE, PXS.IDPLAN, PXS.PREFIJO, PXS.PRIORIDAD, PXS.IDTERCERO, PXS.UMBRAL, PXS.EXCOBROPC,  
       PXS.IDADMINISTRADORA, PXS.LIQUIDARPC, PXS.COBRARPC, PXS.TIPOTARIFA, PXS.IDTARIFA, PXS.FACTOR, TER.RAZONSOCIAL 
FROM   PXS,TER
WHERE  PXS.IDTERCERO = TER.IDTERCERO  
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_REPOSER' AND TYPE='V')
BEGIN
 DROP VIEW VWK_REPOSER
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VWK_REPOSER AS
SELECT IBOD.IDBODEGA,SER.IDSERVICIO,SER.DESCSERVICIO,IBOD.IDBODEGAPIDE
FROM   IBOD,SER
WHERE  IBOD.RPEDIDOAUT = 1
AND    SER.IDSERVICIO NOT IN (SELECT IDSERVICIO FROM IBODEX
                             WHERE IBODEX.IDBODEGA = IBOD.IDBODEGA)
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_REPOEX' AND TYPE='V')
BEGIN
 DROP VIEW VWK_REPOEX
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VWK_REPOEX AS
SELECT IBODEX.IDBODEGA,SER.IDSERVICIO,SER.DESCSERVICIO,IBODEX.IDBODEGAPIDE
FROM  IBODEX,SER
WHERE IBODEX.IDSERVICIO = SER.IDSERVICIO
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_REPOSICION' AND TYPE='V')
BEGIN
 DROP VIEW VWK_REPOSICION
END
GO

-- -----------------------------------------
CREATE VIEW DBO.VWK_REPOSICION AS
   SELECT VWK_REPOSER.IDBODEGA,VWK_REPOSER.IDSERVICIO,VWK_REPOSER.DESCSERVICIO,
          VWK_REPOSER.IDBODEGAPIDE
   FROM VWK_REPOSER
UNION ALL    
   SELECT VWK_REPOEX.IDBODEGA, VWK_REPOEX.IDSERVICIO,VWK_REPOEX.DESCSERVICIO,
          VWK_REPOEX.IDBODEGAPIDE
   FROM VWK_REPOEX
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VW_INVCONSUMO' AND TYPE='V')
BEGIN
 DROP VIEW VW_INVCONSUMO
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VW_INVCONSUMO WITH SCHEMABINDING      
AS      
SELECT DBO.IMOV.CNSMOV,DBO.imov.fechamov,DBO.imovh.idarticulo,DBO.imovh.cantidad,      
       DBO.imov.idtipomov,DBO.iart.idclase,DBO.iart.idsubclase,      
       DBO.iart.idgrupo,DBO.iart.idprinactivo,DBO.iart.IDforfarm,DBO.iart.IDconcentra,      
       DBO.IMOV.IDAREA,DBO.IMOV.IDBODEGA,IMOVH.pcosto,IMOVH.pventa    
FROM DBO.IMOV,DBO.itmo,DBO.imovh,DBO.IART    
WHERE DBO.imov.cnsmov     = DBO.imovh.cnsmov      
AND DBO.IMOV.IDTIPOMOV  = DBO.ITMO.IDTIPOMOV      
and DBO.IART.IDARTICULO = DBO.IMOVH.IDARTICULO      
and DBO.imovh.estado    = 1    
and DBO.ITMO.AFECTAPROM = 1    
AND DBO.ITMO.TIPO = 'Debito'    
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VW_GRUR' AND TYPE='V')
BEGIN
 DROP VIEW VW_GRUR
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VW_GRUR AS
SELECT USGRUR.GRUPO,USGRUR.IDREPORTE,USREP.DESCREPORTE,USREP.NOMBREREPORTE,USREP.TITULOVENTANA,
USREP.FORMULASELECCION,USREP.FORMULAGRUPO,USREP.SALIDAREPORTE,USREP.NIVELAUTORIZACION,USREP.OBS
FROM USGRUR,USREP
WHERE USREP.IDREPORTE = USGRUR.IDREPORTE
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VW_LOGAUDITORIA' AND TYPE='V')
BEGIN
 DROP VIEW VW_LOGAUDITORIA
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VW_LOGAUDITORIA
AS
SELECT USLOG.CNSLOG,USLOG.COMPANIA,USLOG.NOADMISION,USLOG.PROCESO,USLOG.REQUEST,USLOG.REFERENCIA,USLOG.USUARIO,USLOG.FECHA,USLOG.SYS_COMPUTERNAME,
USLOGH.ITEM,USLOGH.CAMPO,USLOGH.VALORANT,USLOGH.VALORNVO
 FROM USLOG,USLOGH
WHERE USLOG.CNSLOG=USLOGH.CNSLOG
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_PREGR' AND TYPE='V')
BEGIN
 DROP VIEW VWK_PREGR 
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VWK_PREGR 
AS 
SELECT PREGR.GRUPO,PREGR.PREFIJO,PRE.NOM_PREFIJO,PRE.CIRUGIA, PRE.FINALIDAD, IDPROVEEDORDEF
FROM   PREGR,PRE 
WHERE  PRE.PREFIJO = PREGR.PREFIJO
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_CXC' AND TYPE='V')
BEGIN
 DROP VIEW VWK_CXC 
END
GO
-- -----------------------------------------    
CREATE VIEW DBO.VWK_CXC AS  
SELECT ANO=YEAR(GETDATE()), MES=MONTH(GETDATE()), FCXC.CNSCXC, FCXC.IDTERCERO, FCXC.FECHACXC, FCXC.INDRECIBIDO, FCXCD.N_FACTURA,   
       FCXCD.VALORFACTURA, FCXCD.VLRPAGOS, FCXC.VLRNOTADB, FCXCD.VLRNOTACR, FCXCD.SALDO,   
       FCXCDV.SALDONETO, FCXCDV.MARCAPAGO, FCXCDV.TIPO, FCXCDV.CNSGLO, FTR.MIVA, FTR.VALORSERVICIOS, NORADICADA = 0
FROM   FCXC, FCXCDV, FCXCD LEFT OUTER JOIN FTR ON  FTR.N_FACTURA    = FCXCD.N_FACTURA
WHERE  FCXC.CNSCXC      = FCXCD.CNSCXC  
AND    FCXCDV.CNSCXC    = FCXCD.CNSCXC  
AND    FCXCDV.N_FACTURA = FCXCD.N_FACTURA
UNION ALL
SELECT FCXC.ANO, FCXC.MES, FCXC.CNSCXC, FCXC.IDTERCERO, FCXC.FECHACXC, FCXC.INDRECIBIDO, FCXCD.N_FACTURA,   
       FCXCD.VALORFACTURA, FCXCD.VLRPAGOS, FCXC.VLRNOTADB, FCXCD.VLRNOTACR, FCXCD.SALDO,   
       FCXCDV.SALDONETO, FCXCDV.MARCAPAGO, FCXCDV.TIPO, FCXCDV.CNSGLO, FTR.MIVA, FTR.VALORSERVICIOS, NORADICADA = 0  
FROM   FCXCH FCXC, FCXCDVH FCXCDV, FCXCDH FCXCD LEFT OUTER JOIN FTR ON  FTR.N_FACTURA = FCXCD.N_FACTURA
WHERE  FCXC.CNSCXC = FCXCD.CNSCXC AND FCXC.ANO=FCXCD.ANO AND FCXC.MES=FCXCD.MES AND 
       FCXCD.CNSCXC = FCXCDV.CNSCXC AND FCXCD.N_FACTURA=FCXCDV.N_FACTURA AND FCXCD.ANO=FCXCDV.ANO AND FCXCD.MES=FCXCDV.MES AND    
       FCXC.FECHACORTE < GETDATE()
UNION ALL
SELECT ANO=YEAR(GETDATE()), MES=MONTH(GETDATE()), CNSCXC='NO RADICADA', FTR.IDTERCERO, FECHACXC = FTR.F_FACTURA, INDRECIBIDO=0, FTR.N_FACTURA,   
       VALORFACTURA = FTR.VR_TOTAL, VLRPAGOS = 0, VLRNOTADB = 0, VLRNOTACR = 0, SALDO = FTR.VR_TOTAL,   
       SALDONETO = FTR.VR_TOTAL, MARCAPAGO = 0, TIPO = '', CNSGLO = '', FTR.MIVA, FTR.VALORSERVICIOS, NORADICADA = FTR.VR_TOTAL  
FROM   FTR 
WHERE  ISNULL(FTR.INDCXC,0) = 0 AND FTR.ESTADO<>'A'  AND COALESCE(FTR.TIPOANULACION,'') <> 'NC'
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_CXC1' AND TYPE='V')
BEGIN
   DROP VIEW VWK_CXC1 
END
GO 
-- -----------------------------------------    
CREATE VIEW DBO.VWK_CXC1 AS  
SELECT FCXC.CNSCXC, FCXC.IDTERCERO, FCXC.FECHACXC, FCXC.INDRECIBIDO, FCXCD.N_FACTURA,   
       FCXCD.VALORFACTURA, FCXCD.VLRPAGOS, FCXC.VLRNOTADB, FCXCD.VLRNOTACR, FCXCD.SALDO,   
       FCXCDV.SALDONETO, FCXCDV.MARCAPAGO, FCXCDV.TIPO, FCXCDV.CNSGLO, FTR.MIVA, FTR.VALORSERVICIOS, NORADICADA = 0, HADM.IDSEDE
FROM   FCXC, FCXCDV, FCXCD LEFT OUTER JOIN FTR ON  FTR.N_FACTURA    = FCXCD.N_FACTURA LEFT JOIN HADM ON FTR.NOREFERENCIA = HADM.NOADMISION
WHERE  FCXC.CNSCXC      = FCXCD.CNSCXC  
AND    FCXCDV.CNSCXC    = FCXCD.CNSCXC  
AND    FCXCDV.N_FACTURA = FCXCD.N_FACTURA
GO 
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_CXCDIASVTO' AND TYPE='V')
BEGIN
   DROP VIEW VWK_CXCDIASVTO
END
GO
-- -----------------------------------------             
CREATE VIEW DBO.VWK_CXCDIASVTO 
AS            
   SELECT ANO = YEAR(GETDATE()), MES = MONTH(GETDATE()), FCXC.IDTERCERO, FCXCDV.CNSCXC, FCXCDV.N_FACTURA, FCXCDV.ITEM, 
          FCXCDV.CNSGLO, FCXCDV.TIPO, FCXCDV.SALDONETO, FCXCDV.FECHA, FCXCDV.F_VENCE, FCXCDV.F_RECIBIDO, FCXCDV.SALDOINICIAL, 
          FCXCDV.MARCAPAGO, DATEDIFF(DAY, FCXCDV.F_VENCE,  GETDATE()) AS DIASVENCE,
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) < 0 THEN  FCXCDV.SALDONETO ELSE 0 END AS PORVENCER,
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) < -360 THEN  FCXCDV.SALDONETO ELSE 0 END AS DM361_MAS,
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN -360 AND -181 THEN  FCXCDV.SALDONETO ELSE 0 END AS DM181_360,  
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN -180 AND -151 THEN  FCXCDV.SALDONETO ELSE 0 END AS DM151_180,  
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN -150 AND -121 THEN  FCXCDV.SALDONETO ELSE 0 END AS DM121_150,  
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN -120 AND  -91 THEN  FCXCDV.SALDONETO ELSE 0 END AS DM91_120,  
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN  -90 AND  -61 THEN  FCXCDV.SALDONETO ELSE 0 END AS DM61_90,  
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN  -60 AND  -31 THEN  FCXCDV.SALDONETO ELSE 0 END AS DM31_60,  
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN  -30 AND   -1 THEN  FCXCDV.SALDONETO ELSE 0 END AS DM0_30,  
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN    0 AND   30 THEN  FCXCDV.SALDONETO ELSE 0 END AS D0_30,
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   31 AND   60 THEN  FCXCDV.SALDONETO ELSE 0 END AS D31_60,
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   61 AND   90 THEN  FCXCDV.SALDONETO ELSE 0 END AS D61_90,
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   91 AND  120 THEN  FCXCDV.SALDONETO ELSE 0 END AS D91_120,
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN  121 AND  150 THEN  FCXCDV.SALDONETO ELSE 0 END AS D121_150,
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN  151 AND  180 THEN  FCXCDV.SALDONETO ELSE 0 END AS D151_180,
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN  181 AND  360 THEN  FCXCDV.SALDONETO ELSE 0 END AS D181_360,
          CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) > 360 THEN  FCXCDV.SALDONETO ELSE 0 END AS D361_MAS,
          CASE WHEN FCXC.PROCEDENCIA = '' OR FCXC.PROCEDENCIA IS NULL THEN 'OTROS' ELSE FCXC.PROCEDENCIA END PROCEDENCIA,
          IDPLAN = ISNULL(FCXCD.IDPLAN, ''),
          NORADICADA = 0, PARTICULAR = TER.ENVIODICAJA, RAD = 'SI'
   FROM   FCXC INNER JOIN  FCXCD ON FCXC.CNSCXC    = FCXCD.CNSCXC
               INNER JOIN FCXCDV ON FCXCD.CNSCXC   = FCXCDV.CNSCXC AND FCXCD.N_FACTURA  = FCXCDV.N_FACTURA
               LEFT  JOIN    TER ON FCXC.IDTERCERO = TER.IDTERCERO
   WHERE  FCXCDV.SALDONETO > 0 
   AND    ((FCXC.INDRECIBIDO = 1 AND FCXCDV.TIPO = 'F') OR (FCXC.INDRECIBIDO = 1 AND (FCXCDV.TIPO = 'G' OR FCXCDV.TIPO = 'R') AND COALESCE(FCXCDV.F_RECIBIDO,'') <> '' ))   
   UNION ALL
   SELECT FCXCH.ANO, FCXCH.MES, FCXCH.IDTERCERO, FCXCDVH.CNSCXC, FCXCDVH.N_FACTURA, FCXCDVH.ITEM, FCXCDVH.CNSGLO, FCXCDVH.TIPO, FCXCDVH.SALDONETO,
          FCXCDVH.FECHA, FCXCDVH.F_VENCE, FCXCDVH.F_RECIBIDO, FCXCDVH.SALDOINICIAL, FCXCDVH.MARCAPAGO, 
          DATEDIFF(DAY, FCXCDVH.F_VENCE,  DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) AS DIASVENCE,
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) < 0 THEN  FCXCDVH.SALDONETO ELSE 0 END AS PORVENCER,
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) < -360 THEN  FCXCDVH.SALDONETO ELSE 0 END AS DM361_MAS,
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) BETWEEN   -360 AND  -181 THEN  FCXCDVH.SALDONETO ELSE 0 END AS DM181_360,  
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) BETWEEN   -180 AND  -151 THEN  FCXCDVH.SALDONETO ELSE 0 END AS DM151_180,  
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) BETWEEN   -150 AND  -121 THEN  FCXCDVH.SALDONETO ELSE 0 END AS DM121_150,  
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) BETWEEN   -120 AND  -91 THEN  FCXCDVH.SALDONETO ELSE 0 END AS DM91_120,  
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) BETWEEN   -90 AND  -61 THEN  FCXCDVH.SALDONETO ELSE 0 END AS DM61_90,  
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) BETWEEN   -60 AND  -31 THEN  FCXCDVH.SALDONETO ELSE 0 END AS DM31_60,  
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) BETWEEN   -30 AND  -1 THEN  FCXCDVH.SALDONETO ELSE 0 END AS DM0_30,  
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) BETWEEN   0 AND  30 THEN  FCXCDVH.SALDONETO ELSE 0 END AS D0_30,
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) BETWEEN   31 AND  60 THEN  FCXCDVH.SALDONETO ELSE 0 END AS D31_60,
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) BETWEEN   61 AND  90 THEN  FCXCDVH.SALDONETO ELSE 0 END AS D61_90,
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) BETWEEN   91 AND  120 THEN  FCXCDVH.SALDONETO ELSE 0 END AS D91_120,
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) BETWEEN   121 AND  150 THEN  FCXCDVH.SALDONETO ELSE 0 END AS D121_150,
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) BETWEEN   151 AND  180 THEN  FCXCDVH.SALDONETO ELSE 0 END AS D151_180,
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) BETWEEN   181 AND  360 THEN  FCXCDVH.SALDONETO ELSE 0 END AS D181_360,
          CASE WHEN DATEDIFF(DAY, FCXCDVH.F_VENCE, DBO.FNK_DIA_DEL_MES(FCXCH.ANO, FCXCH.MES,'ULTIMO')) > 360 THEN  FCXCDVH.SALDONETO ELSE 0 END AS D361_MAS,
          CASE WHEN ISNULL(FCXCH.PROCEDENCIA,'') = '' THEN 'OTROS' ELSE FCXCH.PROCEDENCIA END PROCEDENCIA,
          IDPLAN = ISNULL(FCXCDH.IDPLAN,''),
          NORADICADA = 0, PARTICULAR = TER.ENVIODICAJA, RAD = 'SI'
   /*   FROM  FCXCH FCXC, FCXCDH FCXCD, FCXCDVH FCXCDV */
   FROM  FCXCH INNER JOIN  FCXCDH ON FCXCH.CNSCXC    = FCXCDH.CNSCXC
               INNER JOIN FCXCDVH ON FCXCDH.CNSCXC   = FCXCDVH.CNSCXC AND FCXCDH.N_FACTURA  = FCXCDVH.N_FACTURA
               LEFT  JOIN    TER ON FCXCH.IDTERCERO = TER.IDTERCERO
   WHERE FCXCH.ANO         = FCXCDH.ANO 
   AND   FCXCH.MES         = FCXCDH.MES  
   AND   FCXCDH.ANO        = FCXCDVH.ANO 
   AND   FCXCDH.MES        = FCXCDVH.MES   
   AND   FCXCDVH.SALDONETO > 0 
   AND   FCXCH.FECHACORTE  < GETDATE()    
   AND    ((FCXCH.INDRECIBIDO = 1 AND FCXCDVH.TIPO = 'F') OR (FCXCH.INDRECIBIDO = 1 AND (FCXCDVH.TIPO = 'G' OR FCXCDVH.TIPO='R') AND FCXCDVH.F_RECIBIDO IS NOT NULL))   
   UNION ALL
   -- Facturas No Radicadas
   SELECT ANO = YEAR(GETDATE()), MES = MONTH(GETDATE()), FTR.IDTERCERO, CNSCXC = 'NO RADICADA', FTR.N_FACTURA, ITEM = 0, 
          CNSGLO = '', TIPO = 'F', SALDONETO = FTR.VR_TOTAL + ISNULL(FNOT.VR_NOTAS,0), FECHA = FTR.F_FACTURA, FTR.F_VENCE, F_RECIBIDO = FTR.F_VENCE, SALDOINICIAL = FTR.VR_TOTAL, 
          MARCAPAGO = 0, DATEDIFF(DAY, FTR.F_VENCE,  GETDATE()) AS DIASVENCE,
          0 AS PORVENCER,
          0 AS DM361_MAS,
          0 AS DM181_360,  
          0 AS DM151_180,  
          0 AS DM121_150,  
          0 AS DM91_120,  
          0 AS DM61_90,  
          0 AS DM31_60,  
          0 AS DM0_30,  
          0 AS D0_30,
          0 AS D31_60,
          0 AS D61_90,
          0 AS D91_120,
          0 AS D121_150,
          0 AS D151_180,
          0 AS D181_360,
          0 AS D361_MAS,
          'CARTERA' AS PROCEDENCIA,
          ISNULL(FTR.IDPLAN,'') AS IDPLAN,
          NORADICADA = FTR.VR_TOTAL + ISNULL(FNOT.VR_NOTAS,0), 
          PARTICULAR = TER.ENVIODICAJA, 
          RAD = 'NO'
   FROM   FTR LEFT JOIN TER ON FTR.IDTERCERO = TER.IDTERCERO 
              LEFT JOIN (SELECT N_FACTURA,VR_NOTAS=SUM(CASE WHEN CLASE='D' THEN VR_TOTAL ELSE VR_TOTAL*-1 END) 
                         FROM   FNOT 
                         WHERE  CERRADA=1 
                         GROUP BY N_FACTURA) FNOT ON FTR.N_FACTURA=FNOT.N_FACTURA  
   WHERE ISNULL(FTR.INDCXC,0) = 0 AND FTR.ESTADO<>'A' AND COALESCE (FTR.TIPOANULACION,'') <> 'NC'
   UNION ALL
   SELECT ANO = YEAR(GETDATE()), MES = MONTH(GETDATE()), FCXC.IDTERCERO, CNSCXC = 'GLOSA NO RADICADA', FCXCDV.N_FACTURA, FCXCDV.ITEM, 
          FCXCDV.CNSGLO, FCXCDV.TIPO, FCXCDV.SALDONETO, FCXCDV.FECHA, FCXCDV.F_VENCE, FCXCDV.F_RECIBIDO, FCXCDV.SALDOINICIAL, 
          FCXCDV.MARCAPAGO, DATEDIFF(DAY, FCXCDV.F_VENCE,  GETDATE()) AS DIASVENCE,
          0 AS PORVENCER,
          0 AS DM361_MAS,
          0 AS DM181_360,  
          0 AS DM151_180,  
          0 AS DM121_150,  
          0 AS DM91_120,  
          0 AS DM61_90,  
          0 AS DM31_60,  
          0 AS DM0_30,  
          0 AS D0_30,
          0 AS D31_60,
          0 AS D61_90,
          0 AS D91_120,
          0 AS D121_150,
          0 AS D151_180,
          0 AS D181_360,
          0 AS D361_MAS,
          'CARTERA' AS PROCEDENCIA,
          IDPLAN = ISNULL(FCXCD.IDPLAN, ''),
          NORADICADA = FCXCDV.SALDONETO, PARTICULAR = TER.ENVIODICAJA, RAD = 'NO'
   FROM   FCXC INNER JOIN  FCXCD ON FCXC.CNSCXC    = FCXCD.CNSCXC
               INNER JOIN FCXCDV ON FCXCD.CNSCXC   = FCXCDV.CNSCXC AND FCXCD.N_FACTURA  = FCXCDV.N_FACTURA
               LEFT  JOIN    TER ON FCXC.IDTERCERO = TER.IDTERCERO
   WHERE  FCXCDV.SALDONETO > 0 
   AND    (FCXCDV.TIPO = 'G'  OR FCXCDV.TIPO='R')
   AND    COALESCE(FCXCDV.F_RECIBIDO,'') = ''
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_VCTOS' AND TYPE='V')
BEGIN
   DROP VIEW VWK_VCTOS
END
GO 
-- -----------------------------------------             
CREATE VIEW DBO.VWK_VCTOS 
AS                         
	SELECT VWK.ANO, VWK.MES, VWK.PROCEDENCIA, VWK.IDTERCERO, VWK.PARTICULAR, SUM(VWK.SALDONETO) AS SALDOTOT, SUM(VWK.PORVENCER) AS PORVENCER,
	       SUM(D0_30)    AS SALDO_0_30,    SUM(D31_60)   AS SALDO_31_60,   
	       SUM(D61_90)   AS SALDO_61_90,   SUM(D91_120)  AS SALDO_91_120,  
	       SUM(D121_150) AS SALDO_121_150, SUM(D151_180) AS SALDO_151_180, 
	       SUM(D181_360) AS SALDO_181_360, SUM(D361_MAS) AS SALDO_361_MAS,
	       VWK.IDPLAN,
	       SUM(NORADICADA) AS NORADICADA, RAD, PPT.TIPOTERCONTABLE
   FROM VWK_CXCDIASVTO  VWK LEFT JOIN  PPT ON VWK.IDTERCERO = PPT.IDTERCERO AND VWK.IDPLAN = PPT.IDPLAN ------SJUNCO 270209
   GROUP BY VWK.ANO, VWK.MES, VWK.PROCEDENCIA, VWK.IDTERCERO, VWK.PARTICULAR, VWK.IDPLAN, VWK.RAD,PPT.TIPOTERCONTABLE 
GO
-- -------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_TEADCON' AND TYPE='V')
BEGIN
 DROP VIEW VWK_TEADCON
END
GO
----------------------------------------------------------------------------
CREATE VIEW DBO.VWK_TEADCON
AS
SELECT DISTINCT HADM.NOADMISION, HPRED.IDTERCEROCA, HADM.IDAFILIADO , TER.RAZONSOCIAL,
       HADM.CERRADA, HPRED.IDPLAN
FROM   HPRED,  TER, HADM, HPRE
WHERE  HADM.NOADMISION   = HPRE.NOADMISION
AND    HPRE.NOPRESTACION = HPRED.NOPRESTACION
AND    HADM.FACTURABLE   = 1
AND    HADM.CLASEING     = 'A'
AND    HPRED.IDTERCEROCA = TER.IDTERCERO
AND    (SELECT COUNT(*) FROM HPRED, HPRE WHERE HPRE.NOPRESTACION = HPRED.NOPRESTACION
          AND HPRE.NOADMISION = HADM.NOADMISION) > 0
GO
-- --------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_TEADSIN' AND TYPE='V')
BEGIN
 DROP VIEW VWK_TEADSIN
END
GO
-----------------------------------------------------------------------------
CREATE VIEW DBO.VWK_TEADSIN
AS
SELECT HADM.NOADMISION, HADM.IDTERCERO AS IDTERCEROCA, HADM.IDAFILIADO, 
            TER.RAZONSOCIAL, HADM.CERRADA, HADM.IDPLAN
FROM    HADM, TER
WHERE   HADM.IDTERCERO =  TER.IDTERCERO
AND     HADM.CLASEING  = 'A'
AND     (SELECT COUNT(*) FROM HPRED, HPRE WHERE HPRE.NOPRESTACION = HPRED.NOPRESTACION
            AND HPRE.NOADMISION = HADM.NOADMISION) = 0
GO
-- -------------------------------------------------------------------------             
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_TERXHADM' AND TYPE='V')
BEGIN
   DROP VIEW VWK_TERXHADM
END
GO
----------------------------------------------------------------------------
CREATE VIEW DBO.VWK_TERXHADM
AS 
SELECT VWK_TEADCON.NOADMISION, VWK_TEADCON.IDTERCEROCA, VWK_TEADCON.IDAFILIADO,
            VWK_TEADCON.RAZONSOCIAL, VWK_TEADCON.CERRADA, VWK_TEADCON.IDPLAN
FROM   VWK_TEADCON
UNION ALL
SELECT VWK_TEADSIN.NOADMISION, VWK_TEADSIN.IDTERCEROCA, VWK_TEADSIN.IDAFILIADO,
            VWK_TEADSIN.RAZONSOCIAL, VWK_TEADSIN.CERRADA, VWK_TEADSIN.IDPLAN
FROM  VWK_TEADSIN
go
--UNION ALL
--SELECT A.NOADMISION, A.IDAFILIADO, A.IDAFILIADO, 
--       ISNULL(RTRIM(PAPELLIDO),'')+' '+ISNULL(RTRIM(SAPELLIDO),'')+' '+ISNULL(RTRIM(PNOMBRE),'')+' '+ISNULL(RTRIM(SNOMBRE),'') RAZONSOCIAL,
--       A.CERRADA
--FROM   HADM A INNER JOIN
--       AFI  B ON A.IDAFILIADO=B.IDAFILIADO
--GO     
-- -----------------------------------------------------------------------------------1
IF EXISTS (SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_CXP_ANEST' AND TYPE='V')
BEGIN
   DROP VIEW VWK_CXP_ANEST
END
GO
-- -----------------------------------------             
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_CTCX_NPQ' AND TYPE='V')
BEGIN
 DROP VIEW VWK_CTCX_NPQ
END
GO
-- -----------------------------------------             
CREATE VIEW DBO.VWK_CTCX_NPQ
AS
SELECT QXPCXD.CONSECUTIVO, QXPCXD.ITEM, QXPCX.FECHA, QXPCXD.IDSERVICIO, QXPCX.DURACION, 
       QXPCXR.IDMEDICO, MED.NOMBRE, MED.TIPOVINCULACION, QXPCXD.PAQUETE, HADM.IDPLAN,
       HPRED.VALOR, HADM.IDTERCERO, PPT.IDTARIFA, TARD.VALOR AS UVR, 
       'ANESTESIOLOGIA' AS SERVICIO,
       CASE HADM.IDPLAN
       WHEN 'POS' THEN HPRED.VALOR
       ELSE 
          CASE. MED.TIPOVINCULACION
          WHEN  'EMPLEADO' THEN 1500 * TARD.VALOR
          WHEN  'TERCERO'  THEN 
                CASE 
                WHEN QXPCX.DURACION <= 30 THEN 45000 + (1500 * 30)
                WHEN QXPCX.DURACION > 30  THEN 45000 + (1500 * QXPCX.DURACION)
                END                      
          END
       END AS CXP, HADM.NOADMISION
FROM   QXPCXD, QXPCX, QXPCXR, MED, HADM, HPRE, HPRED, PPT, TARD
WHERE  QXPCXD.CONSECUTIVO   = QXPCX.CONSECUTIVO
AND    QXPCXR.CONSECUTIVO   = QXPCXD.CONSECUTIVO
AND    QXPCXR.ITEM          = QXPCXD.ITEM
AND    QXPCXR.TIPORH        = 'Anestesiologo'
AND    QXPCXR.IDMEDICO      = MED.IDMEDICO
AND    QXPCX.LIQ_ADC        = 1
AND    QXPCXD.ANESTESIOLOGO = 1
AND    QXPCX.NOADMISION     = HADM.NOADMISION
AND    HPRE.CIRUGIA         = 'SI'
AND    HPRE.CONSECUTIVO     = QXPCX.CONSECUTIVO
AND    HPRED.NOPRESTACION   = HPRE.NOPRESTACION
AND    HPRED.TIPOSERCIRUGIA = 'Anestesiologo' 
AND    HPRED.ITEMCIRUGIA    = QXPCXD.ITEM
AND    QXPCX.FECHA         >= '01/10/2003'
AND    QXPCXD.PAQUETE       = 0
AND    PPT.IDTERCERO        = HADM.IDTERCERO
AND    PPT.IDPLAN           = HADM.IDPLAN
AND    TARD.IDTARIFA        = PPT.IDTARIFA
AND    TARD.IDSERVICIO      = QXPCXD.IDSERVICIO
AND    HADM.CLASEING        = 'A'
GO
-- -----------------------------------------             
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_CTCX_PQ' AND TYPE='V')
BEGIN
 DROP VIEW VWK_CTCX_PQ
END
GO
-- -----------------------------------------             
CREATE VIEW DBO.VWK_CTCX_PQ
AS
SELECT QXPCXD.CONSECUTIVO, QXPCXD.ITEM, QXPCX.FECHA, QXPCXD.IDSERVICIO, QXPCX.DURACION, 
       QXPCXR.IDMEDICO, MED.NOMBRE, 
       MED.TIPOVINCULACION, QXPCXD.PAQUETE, HADM.IDPLAN, HPRED.VALOR,
       HADM.IDTERCERO, PPT.IDTARIFA, TARD.VALOR AS UVR, 
       'ANESTESIOLOGIA' AS SERVICIO,
       HPRED.VALOR *.25 AS CXP, HADM.NOADMISION  
FROM   QXPCXD, QXPCX, QXPCXR, MED, HADM, HPRE, HPRED, PPT, TARD
WHERE  QXPCXD.CONSECUTIVO   = QXPCX.CONSECUTIVO
AND    QXPCXR.CONSECUTIVO   = QXPCXD.CONSECUTIVO
AND    QXPCXR.ITEM          = QXPCXD.ITEM
AND    QXPCXR.TIPORH        = 'Anestesiologo'
AND    QXPCXR.IDMEDICO      = MED.IDMEDICO
AND    QXPCX.LIQ_ADC        = 1
AND    QXPCXD.ANESTESIOLOGO = 1
AND    QXPCX.NOADMISION     = HADM.NOADMISION
AND    HPRE.CIRUGIA         = 'SI'
AND    HPRE.CONSECUTIVO     = QXPCX.CONSECUTIVO
AND    HPRED.NOPRESTACION   = HPRE.NOPRESTACION
AND    HPRED.ITEMCIRUGIA    = QXPCXD.ITEM
AND    QXPCX.FECHA         >= '01/10/2003'
AND    QXPCXD.PAQUETE       = 1
AND    PPT.IDTERCERO        = HADM.IDTERCERO
AND    PPT.IDPLAN           = HADM.IDPLAN
AND    TARD.IDTARIFA        = PPT.IDTARIFA
AND    TARD.IDSERVICIO      = QXPCXD.IDSERVICIO
AND    HADM.CLASEING        = 'A'
GO
-- -----------------------------------------             
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_CTCX_CN' AND TYPE='V')
BEGIN
 DROP VIEW VWK_CTCX_CN
END
GO
-- -----------------------------------------             
CREATE VIEW DBO.VWK_CTCX_CN
AS
SELECT HPRED.NOPRESTACION, HPRED.NOITEM, HPRE.FECHA, HPRED.IDSERVICIO, 0 AS DURACION, 
       HPRED.IDPROVEEDOR, MED.NOMBRE, MED.TIPOVINCULACION, 0 AS PAQUETE, HADM.IDPLAN,
       HPRED.VALOR, HADM.IDTERCERO, PPT.IDTARIFA, TARD.VALOR AS UVR, 
       'CONSULTA' AS SERVICIO, SERTOT.VALOR AS CXP, HADM.NOADMISION 
FROM   HPRED, HPRE, MED, HADM, PPT, TARD , SERTOT
WHERE  HPRED.IDSERVICIO    = '39139'
AND    HPRED.NOPRESTACION  = HPRE.NOPRESTACION
AND    HPRE.NOADMISION     = HADM.NOADMISION
AND    HPRED.IDPROVEEDOR   = MED.IDMEDICO
AND    PPT.IDTERCERO       = HADM.IDTERCERO
AND    PPT.IDPLAN          = HADM.IDPLAN
AND    TARD.IDTARIFA       = PPT.IDTARIFA
AND    TARD.IDSERVICIO     = HPRED.IDSERVICIO
AND    HPRE.FECHA         >= '01/10/2003'    
AND    SERTOT.IDTERCERO    = HADM.IDTERCERO
AND    SERTOT.IDPLAN       = HADM.IDPLAN
AND    SERTOT.IDSERVICIO   = HPRED.IDSERVICIO
AND    SERTOT.FECHAINIFD  <= HPRE.FECHA
AND    SERTOT.FECHAFINFD  >= HPRE.FECHA
AND    SERTOT.FECHAINI    <= HPRE.FECHA
AND    SERTOT.FECHAFIN    >= HPRE.FECHA
AND    HADM.CLASEING       = 'A'
GO
-- -----------------------------
CREATE VIEW DBO.VWK_CXP_ANEST 
AS
   SELECT * FROM VWK_CTCX_NPQ
UNION ALL    
   SELECT * FROM VWK_CTCX_PQ
UNION ALL    
   SELECT * FROM VWK_CTCX_CN
GO
-- ----------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_NOM_ANEST' AND TYPE='V')
BEGIN
   DROP VIEW VWK_NOM_ANEST
END
GO
-- -----------------------------------------             
CREATE VIEW DBO.VWK_NOM_ANEST
AS
SELECT DISTINCT IDMEDICO, NOMBRE FROM VWK_CXP_ANEST
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_RCJ_LEG' AND TYPE='V')
BEGIN
 DROP VIEW VWK_RCJ_LEG
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VWK_RCJ_LEG
AS
 SELECT NOINGRESO, CODCAJA, CNSFACJ, FECHA, VALOR, LEGALIZADO, CODCAJALG,
        CNSFACJLG, IDTERCERO, 'DEPOSITO A FACTURA' AS CLASE, DEVUELTO, CODCAJADV,
        CNSFACJDV, PORLEGALIZAR 
 FROM   QXDING
 UNION ALL
 SELECT NOADMISION, CODCAJA, CNSFACJ, FECHA, VALORTOTAL, LEGALIZADO, CODCAJALG, 
        CNSFACJLG, IDTERCERO, 'ABONO A COPAGO' AS CLASE, DEVUELTO, CODCAJADV,
        CNSFACJDV, 0 AS PORLEGALIZAR
 FROM FCJDL
GO
--------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_RC_BASE' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_RC_BASE
   END
GO
-----------------------------------------------
CREATE VIEW DBO.VWK_RC_BASE
AS
SELECT FPAG.CNSFPAG, FPAG.IDTERCERO, CAST('01/'+CAST(MONTH(FPAG.FECHAPAGO) AS VARCHAR(2))+'/'+CAST(YEAR(FPAG.FECHAPAGO) AS VARCHAR(4)) AS DATETIME) AS F1PAGO ,
       FPAG.FECHAPAGO, CAST('01/'+CAST(MONTH(FCXC.F_RECIBIDO) AS VARCHAR(2))+'/'+CAST(YEAR(FCXC.F_RECIBIDO) AS VARCHAR(4)) AS DATETIME)AS F1RAD ,
       FCXC.F_RECIBIDO, FPAGD.CNSCXC, FPAGD.VALORPAGO, 
       FPAGD.VLRGLOSA, FPAGD.VLRIMPUESTO, FPAGD.VLRDTOFIN
FROM FPAG, FPAGD, FCXC
WHERE FPAG.CNSFPAG = FPAGD.CNSFPAG
AND   FCXC.CNSCXC = FPAGD.CNSCXC
AND   FPAG.CERRADO = 1
GO
--------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_RC_MES_P' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_RC_MES_P
   END
GO
-----------------------------------------------
CREATE VIEW DBO.VWK_RC_MES_P
AS            
SELECT CNSFPAG, IDTERCERO, F1PAGO, F1RAD, YEAR(F1PAGO) AS ANOPAGO, MONTH(F1PAGO) AS MESPAGO,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 0 THEN VALORPAGO ELSE 0 END AS P0,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 1 THEN VALORPAGO ELSE 0 END AS P1,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 2 THEN VALORPAGO ELSE 0 END AS P2,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 3 THEN VALORPAGO ELSE 0 END AS P3,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 4 THEN VALORPAGO ELSE 0 END AS P4,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 5 THEN VALORPAGO ELSE 0 END AS P5,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 6 THEN VALORPAGO ELSE 0 END AS P6,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 7 THEN VALORPAGO ELSE 0 END AS P7,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 8 THEN VALORPAGO ELSE 0 END AS P8,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 9 THEN VALORPAGO ELSE 0 END AS P9,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 10 THEN VALORPAGO ELSE 0 END AS P10,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 11 THEN VALORPAGO ELSE 0 END AS P11,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  > 11 THEN VALORPAGO ELSE 0 END AS P12
FROM VWK_RC_BASE
WHERE VALORPAGO > 0
GO
--------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_RC_MES_G' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_RC_MES_G
   END
GO
-----------------------------------------------
CREATE VIEW DBO.VWK_RC_MES_G
AS            
SELECT CNSFPAG, IDTERCERO, F1PAGO, F1RAD, YEAR(F1PAGO) AS ANOPAGO, MONTH(F1PAGO) AS MESPAGO,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 0 THEN VLRGLOSA ELSE 0 END AS P0,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 1 THEN VLRGLOSA ELSE 0 END AS P1,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 2 THEN VLRGLOSA ELSE 0 END AS P2,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 3 THEN VLRGLOSA ELSE 0 END AS P3,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 4 THEN VLRGLOSA ELSE 0 END AS P4,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 5 THEN VLRGLOSA ELSE 0 END AS P5,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 6 THEN VLRGLOSA ELSE 0 END AS P6,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 7 THEN VLRGLOSA ELSE 0 END AS P7,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 8 THEN VLRGLOSA ELSE 0 END AS P8,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 9 THEN VLRGLOSA ELSE 0 END AS P9,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 10 THEN VLRGLOSA ELSE 0 END AS P10,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  = 11 THEN VLRGLOSA ELSE 0 END AS P11,
       CASE  WHEN  DATEDIFF(MONTH, F1RAD, F1PAGO)  > 11 THEN VLRGLOSA ELSE 0 END AS P12
FROM VWK_RC_BASE
WHERE VLRGLOSA > 0
GO
--------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_RC_P_RS' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_RC_P_RS
   END
GO
-----------------------------------------------
-- vista resumen de recaudos pagos
CREATE VIEW DBO.VWK_RC_P_RS
AS
SELECT VWK_RC_MES_P.IDTERCERO, TER.RAZONSOCIAL, ANOPAGO, MESPAGO, SUM(P0) AS P0,
       SUM(P1) AS P1, SUM(P2) AS P2, SUM(P3) AS P3, SUM(P4) AS P4, SUM(P5) AS P5, 
       SUM(P6) AS P6, SUM(P7) AS P7, SUM(P8) AS P8, SUM(P9) AS P9, SUM(P10) AS P10, 
       SUM(P11) AS P11, SUM(P12) AS P12, 
       SUM(P0+P1+P2+P3+P4+P5+P6+P7+P8+P9+P10+P11+P12) AS PTOTAL 
FROM   VWK_RC_MES_P, TER
WHERE  VWK_RC_MES_P.IDTERCERO = TER.IDTERCERO
GROUP BY VWK_RC_MES_P.IDTERCERO, TER.RAZONSOCIAL, ANOPAGO, MESPAGO
GO
--------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_RC_G_RS' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_RC_G_RS
   END
GO
-----------------------------------------------
-- vista resumen de recaudos GLOSAS
CREATE VIEW DBO.VWK_RC_G_RS
AS
SELECT VWK_RC_MES_G.IDTERCERO, TER.RAZONSOCIAL, ANOPAGO, MESPAGO, SUM(P0) AS P0,
       SUM(P1) AS P1, SUM(P2) AS P2, SUM(P3) AS P3, SUM(P4) AS P4, SUM(P5) AS P5, 
       SUM(P6) AS P6, SUM(P7) AS P7, SUM(P8) AS P8, SUM(P9) AS P9, SUM(P10) AS P10, 
       SUM(P11) AS P11, SUM(P12) AS P12, 
       SUM(P0+P1+P2+P3+P4+P5+P6+P7+P8+P9+P10+P11+P12) AS PTOTAL 
FROM   VWK_RC_MES_G, TER
WHERE  VWK_RC_MES_G.IDTERCERO = TER.IDTERCERO
GROUP BY VWK_RC_MES_G.IDTERCERO, TER.RAZONSOCIAL, ANOPAGO, MESPAGO
GO
--------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_RD_BASE' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_RD_BASE
   END
GO
-----------------------------------------------
CREATE VIEW DBO.VWK_RD_BASE
AS
SELECT FCXC.CNSCXC, FCXC.IDTERCERO, CAST('01/'+CAST(MONTH(FCXC.F_RECIBIDO) AS VARCHAR(2))+'/'+CAST(YEAR(FCXC.F_RECIBIDO) AS VARCHAR(4)) AS DATETIME) AS F1RAD ,
       FCXC.F_RECIBIDO, CAST('01/'+CAST(MONTH(FTR.F_FACTURA) AS VARCHAR(2))+'/'+CAST(YEAR(FTR.F_FACTURA) AS VARCHAR(4)) AS DATETIME) AS F1FAC ,
       FTR.F_FACTURA, FCXCD.VALORFACTURA
FROM   FCXC, FCXCD, FTR
WHERE  FCXC.CNSCXC      = FCXCD.CNSCXC
AND    FTR.N_FACTURA    = FCXCD.N_FACTURA 
AND    FCXC.INDRECIBIDO = 1
GO
--------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_RD_MES' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_RD_MES
   END
GO
-----------------------------------------------
CREATE VIEW DBO.VWK_RD_MES
AS            
SELECT CNSCXC, IDTERCERO, F1RAD, F1FAC,  YEAR(F1RAD) AS ANORAD, MONTH(F1RAD) AS MESRAD,
       CASE  WHEN  DATEDIFF(MONTH, F1FAC, F1RAD)  = 0 THEN VALORFACTURA ELSE 0 END AS P0,
       CASE  WHEN  DATEDIFF(MONTH, F1FAC, F1RAD)  = 1  THEN VALORFACTURA ELSE 0 END AS P1,
       CASE  WHEN  DATEDIFF(MONTH, F1FAC, F1RAD)  = 2  THEN VALORFACTURA ELSE 0 END AS P2,
       CASE  WHEN  DATEDIFF(MONTH, F1FAC, F1RAD)  = 3  THEN VALORFACTURA ELSE 0 END AS P3,
       CASE  WHEN  DATEDIFF(MONTH, F1FAC, F1RAD)  = 4  THEN VALORFACTURA ELSE 0 END AS P4,
       CASE  WHEN  DATEDIFF(MONTH, F1FAC, F1RAD)  = 5  THEN VALORFACTURA ELSE 0 END AS P5,
       CASE  WHEN  DATEDIFF(MONTH, F1FAC, F1RAD)  = 6  THEN VALORFACTURA ELSE 0 END AS P6,
       CASE  WHEN  DATEDIFF(MONTH, F1FAC, F1RAD)  = 7  THEN VALORFACTURA ELSE 0 END AS P7,
       CASE  WHEN  DATEDIFF(MONTH, F1FAC, F1RAD)  = 8  THEN VALORFACTURA ELSE 0 END AS P8,
       CASE  WHEN  DATEDIFF(MONTH, F1FAC, F1RAD)  = 9  THEN VALORFACTURA ELSE 0 END AS P9,
       CASE  WHEN  DATEDIFF(MONTH, F1FAC, F1RAD)  = 10 THEN VALORFACTURA ELSE 0 END AS P10,
       CASE  WHEN  DATEDIFF(MONTH, F1FAC, F1RAD)  = 11 THEN VALORFACTURA ELSE 0 END AS P11,
       CASE  WHEN  DATEDIFF(MONTH, F1FAC, F1RAD)  > 11 THEN VALORFACTURA ELSE 0 END AS P12
FROM   VWK_RD_BASE
WHERE  VALORFACTURA > 0
GO
--------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_RD_RS' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_RD_RS
   END
GO
-----------------------------------------------
-- vista resumen de RADICACION DE CXC
CREATE VIEW DBO.VWK_RD_RS
AS
SELECT VWK_RD_MES.IDTERCERO, TER.RAZONSOCIAL, ANORAD, MESRAD, SUM(P0) AS P0,
       SUM(P1) AS P1, SUM(P2) AS P2, SUM(P3) AS P3, SUM(P4) AS P4, SUM(P5) AS P5, 
       SUM(P6) AS P6, SUM(P7) AS P7, SUM(P8) AS P8, SUM(P9) AS P9, SUM(P10) AS P10, 
       SUM(P11) AS P11, SUM(P12) AS P12, 
       SUM(P0+P1+P2+P3+P4+P5+P6+P7+P8+P9+P10+P11+P12) AS PTOTAL 
FROM   VWK_RD_MES, TER
WHERE  VWK_RD_MES.IDTERCERO = TER.IDTERCERO
GROUP BY VWK_RD_MES.IDTERCERO, TER.RAZONSOCIAL, ANORAD, MESRAD
GO
--------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_CJCPT' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_CJCPT
   END
GO
-----------------------------------------------
CREATE VIEW DBO.VWK_CJCPT
AS
SELECT FCJ.CNSACJ, FCJ.CODCAJA, FCJD.ITEM, FCJDD.RENGLON, FCJ.CNSFACJ, FCJ.IDAFILIADO, 
       LTRIM(RTRIM(AFI.PAPELLIDO))+ ' ' +
       LTRIM(RTRIM(AFI.SAPELLIDO))+ ' ' + LTRIM(RTRIM(AFI.PNOMBRE))+ ' ' +
       LTRIM(RTRIM(AFI.SNOMBRE)) AS NOMAFILIADO, FCJ.IDTERCERO, TER.RAZONSOCIAL,
       CASE FCJ.CLASER
       WHEN 'C' THEN FCJD.CONCEPTO 
       WHEN 'S' THEN FCJD.IDSERVICIO
       END AS CONCEPTO, 
       CASE FCJ.CLASER
       WHEN 'C' THEN (SELECT DESCRIPCION FROM CPCJ WHERE CPCJ.CODIGO = FCJD.CONCEPTO)
       WHEN 'S' THEN (SELECT DESCSERVICIO FROM SER WHERE SER.IDSERVICIO = FCJD.IDSERVICIO)
       END AS NOMCONCEPTO,
       FCJDD.PREFIJO, PRE.NOM_PREFIJO, FCJDD.VALORTOTAL, FCJ.CLASE_FAC  
FROM   FCJ, FCJD, AFI, TER, FCJDD, PRE 
WHERE  FCJ.CODCAJA = FCJD.CODCAJA
AND    FCJ.CNSFACJ = FCJD.CNSFACJ
AND    AFI.IDAFILIADO = FCJ.IDAFILIADO
AND    TER.IDTERCERO  = FCJ.IDTERCERO
AND    FCJDD.CODCAJA = FCJD.CODCAJA
AND    FCJDD.CNSFACJ = FCJD.CNSFACJ
AND    FCJDD.ITEM    = FCJD.ITEM
AND    PRE.PREFIJO   = FCJDD.PREFIJO
AND    FCJ.ESTADO <> 'A'
GO
--------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_COSTOS_CX' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_COSTOS_CX
   END
GO
-----------------------------------------------
CREATE VIEW DBO.VWK_COSTOS_CX AS
SELECT HADM.NOADMISION,HADM.FECHA AS FECHAADMISION,QXPCX.CONSECUTIVO,QXPCX.FECHA,QXPCX.DURACION,
QXPCX.DURACIONREC AS DURACIONRECUPERACION,QXPCX.IDAREAH,
QXPCX.IDAREA,QXPCX.TIPOANESTESIA,QXPCX.COMPLEJIDAD,QXPCX.SUBCCOSTO,
QXPCXD.ITEM,QXPCXD.IDTERCEROCA,TER.RAZONSOCIAL,QXPCXD.IDSERVICIO,SER.DESCSERVICIO,QXPCXD.TIPOCIRUGIA,
QXPCXD.ANESTESIOLOGO,QXPCXD.AYUDANTIA,QXPCXD.CIRUJANO,QXPCXD.TIPOCIRUJANO,QXPCXD.DERECHOSALA,
QXPCXD.MATYMED AS MATYMEDICAMENTOS,QXPCXD.PAQUETE,
QXPCXT.ITEMCOSTOCX,QXPCXT.VALOR FROM QXPCX,QXPCXD,QXPCXT,SER,HADM,TER
WHERE QXPCXD.CONSECUTIVO = QXPCX.CONSECUTIVO AND
      TER.IDTERCERO      = QXPCXD.IDTERCEROCA AND
      SER.IDSERVICIO     = QXPCXD.IDSERVICIO AND
      HADM.NOADMISION    = QXPCX.NOADMISION AND
      QXPCXT.CONSECUTIVO = QXPCXD.CONSECUTIVO AND
      QXPCXT.ITEM        = QXPCXD.ITEM
GO
--------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_F_FCCR' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_F_FCCR
   END
GO
-----------------------------------------------
CREATE VIEW DBO.VWK_F_FCCR 
AS
SELECT IDTERCERO, N_FACTURA,  VR_TOTAL, F_FACTURA,
       CAST(YEAR(F_FACTURA) AS VARCHAR(4)) AS ANOFTR,
       CASE
       WHEN MONTH(F_FACTURA) < 10 THEN '0'+ CAST(MONTH(F_FACTURA) AS VARCHAR(1)) 
       ELSE CAST(MONTH(F_FACTURA) AS VARCHAR(2)) 
       END  AS MESFTR,
       FECHAPASOCXC, 
       CAST(YEAR(FECHAPASOCXC) AS VARCHAR(4)) AS ANOPASO,
       CASE
       WHEN MONTH(FECHAPASOCXC) < 10 THEN '0'+ CAST(MONTH(FECHAPASOCXC) AS VARCHAR(1)) 
       ELSE CAST(MONTH(FECHAPASOCXC) AS VARCHAR(2)) 
       END  AS MESPASO
FROM   FTR 
WHERE  FECHAPASOCXC IS NOT NULL
AND    ESTADO <> 'A'
GO
--------------------------------------------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_F_FCCR_R' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_F_FCCR_R
   END
GO 
-----------------------------------------------
CREATE VIEW DBO.VWK_F_FCCR_R
AS
SELECT   VWK_F_FCCR.IDTERCERO, TER.RAZONSOCIAL, VWK_F_FCCR.ANOFTR, VWK_F_FCCR.MESFTR, 
         VWK_F_FCCR.ANOPASO, VWK_F_FCCR.MESPASO, COUNT(*) AS CANTFACTURAS, 
         SUM(VR_TOTAL) AS TOTALFTR
FROM     VWK_F_FCCR LEFT OUTER JOIN TER
ON       VWK_F_FCCR.IDTERCERO = TER.IDTERCERO
GROUP BY VWK_F_FCCR.IDTERCERO, TER.RAZONSOCIAL, VWK_F_FCCR.ANOFTR, VWK_F_FCCR.MESFTR, 
         VWK_F_FCCR.ANOPASO, VWK_F_FCCR.MESPASO 
GO
-----------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_RECAUD' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_RECAUD
   END
GO 
-----------------------------------------------
CREATE VIEW DBO.VWK_RECAUD
AS
SELECT DBO.FCJ.CODCAJA AS BANCOCAJA, NULL AS SUCURSAL, DBO.FCJ.CNSFACJ AS NORECCTA, 
       DBO.FCJ.FECHA AS FECHAOPERACION, DBO.FCJ.ENPAGOS , 'CAJA' AS PROCEDENCIA,
       NULL AS ITEM, NULL AS RENGLON, DBO.FCJ.IDTERCERO
FROM   DBO.FCJ WHERE RECAUDO = 1 AND DBO.FCJ.CERRADA = 1 AND DBO.FCJ.ESTADO <> 'A' 
UNION
SELECT DBO.BMOVD.BANCO AS BANCOCAJA, DBO.BMOVD.SUCURSAL, DBO.BMOVD.CTA_BCO AS NORECCTA, 
       DBO.BMOV.FECHAOPERACION, DBO.BMOVD.ENPAGOS, 'BANCO' AS PROCEDENCIA,
       DBO.BMOVD.ITEM, DBO.BMOVD.RENGLON, DBO.BMOVD.IDTERCERO
FROM   DBO.BMOV, DBO.BMOVD
WHERE  DBO.BMOVD.BANCO    = DBO.BMOV.BANCO
AND    DBO.BMOVD.SUCURSAL = DBO.BMOV.SUCURSAL
AND    DBO.BMOVD.CTA_BCO  = DBO.BMOV.CTA_BCO
AND    DBO.BMOVD.RECAUDO  = 1
AND    DBO.BMOVD.PROCEDENCIA <> 'CAJA'  
GO
-----------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_GT_HBDT' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_GT_HBDT
   END
GO 
-----------------------------------------------
CREATE VIEW DBO.VWK_GT_HBDT
AS
SELECT HADM.HABCAMA, HADM.IDTERCERO, HADM.IDPLAN, HADM.FACTURADA, HPRE.FECHA, 
       HPRE.IDAREA, HPRE.CCOSTO, HPRE.VALORTOTAL,
       HPRE.VALORCOPAGO, HPRE.VALORPCOMP, HPRE.VALOREXEDENTE
FROM   HPRE, HADM, HTAD 
WHERE  HPRE.NOADMISION = HADM.NOADMISION
AND    HTAD.TIPOADM    = HADM.TIPOADM
AND    HTAD.REQHABCAMA = 1 
AND    HADM.CLASEING   = 'A'
GO
-----------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_GT_HBT' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_GT_HBT
   END
GO 
-----------------------------------------------
CREATE VIEW DBO.VWK_GT_HBT
AS 
SELECT VWK_GT_HBDT.HABCAMA, CAST(YEAR(VWK_GT_HBDT.FECHA) AS VARCHAR(4)) AS ANO, 
       CASE
       WHEN MONTH(VWK_GT_HBDT.FECHA) < 10 THEN '0'+CAST(MONTH(VWK_GT_HBDT.FECHA) AS VARCHAR(1))
       ELSE CAST(MONTH(VWK_GT_HBDT.FECHA) AS VARCHAR(2))
       END AS MES, 
       VWK_GT_HBDT.IDAREA, VWK_GT_HBDT.CCOSTO, 
       SUM(VWK_GT_HBDT.VALORTOTAL) AS VALORTOTAL, SUM(VWK_GT_HBDT.VALORCOPAGO) AS VALORCOPAGO, 
       SUM(VWK_GT_HBDT.VALORPCOMP) AS VALORPCOMP, SUM(VWK_GT_HBDT.VALOREXEDENTE) AS VALOREXEDENTE
FROM VWK_GT_HBDT
GROUP BY HABCAMA, CAST(YEAR(VWK_GT_HBDT.FECHA) AS VARCHAR(4)), 
CASE
WHEN MONTH(VWK_GT_HBDT.FECHA) < 10 THEN '0'+CAST(MONTH(VWK_GT_HBDT.FECHA) AS VARCHAR(1))
ELSE CAST(MONTH(VWK_GT_HBDT.FECHA) AS VARCHAR(2))
END, IDAREA, CCOSTO
GO
-----------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_PPT' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_PPT
   END
GO 
-----------------------------------------------
CREATE VIEW DBO.VWK_PPT
AS
SELECT TER.IDTERCERO, TER.RAZONSOCIAL, PPT.IDPLAN, PLN.DESCPLAN
FROM   PPT, TER, PLN
WHERE  PPT.IDTERCERO = TER.IDTERCERO
AND    PLN.IDPLAN    = PPT.IDPLAN
GO
-----------------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME = 'VWK_CAJA' AND XTYPE='V')
   BEGIN
     DROP VIEW VWK_CAJA
   END
GO 
-----------------------------------------------
CREATE VIEW DBO.VWK_CAJA
AS
SELECT FCJ.ESTADO, FCJ.CERRADA, FCJ.CNSACJ, FCJ.CODCAJA, FCJ.CNSFACJ, FCJ.CLASE_FAC, 
FCJ.IDTERCERO, FCJ.IDAFILIADO, FCJ.FECHA, FCJ.TIPOEGRESO, FCJ.N_RECIBO,
CASE
WHEN CLASE_FAC = 'COBRO' THEN 'INGRESO'
WHEN CLASE_FAC = 'PAGO'  THEN (SELECT DESCRIPCION FROM CJTE 
                               WHERE  FCJ.TIPOEGRESO = CJTE.TIPOEGRESO)
END AS TIPO_CP, PCJ.TIPOPAGO, FPA.DESCRIPCION , PCJ.VALOR AS VALORPAGO, PCJ.CNSPCJ, 
PCJ.BANCO, PCJ.SUCURSAL, PCJ.CTA_BCO, PCJ.CNSDOC, PCJ.NUMERODOCUMENTO, FCJ.CLASER, 
CASE
WHEN FCJ.CLASER = 'C' THEN FCJD.CONCEPTO
WHEN FCJ.CLASER = 'S' THEN FCJD.IDSERVICIO  
END AS CODIGODETALLE,
CASE
WHEN FCJ.CLASER = 'C' AND FCJD.CONCEPTO <> '' THEN (SELECT CPCJ.DESCRIPCION FROM CPCJ WHERE
                                                    CPCJ.CODIGO = FCJD.CONCEPTO)
WHEN FCJ.CLASER = 'S' THEN (SELECT SER.DESCSERVICIO FROM SER 
                            WHERE SER.IDSERVICIO = FCJD.IDSERVICIO)
WHEN FCJ.CLASER = 'C' AND FCJD.CONCEPTO = '' THEN 
     (SELECT 'CXP No.:'+ FCXPP.CNSFCXP+'- Fecha:'+CONVERT(VARCHAR(10), FCXPP.FECHA, 103)+'-No. Ref:'+FCXP.NOREFERENCIA
      FROM   FCXP, FCXPP
      WHERE  FCXPP.CNSFCXPP = FCJD.IDSERVICIO
      AND    FCXP.CNSFCXP   = FCXPP.CNSFCXP)     
END AS DESCRIPCIONDETALLE,
FCJD.VALORUNITARIO, FCJD.CANTIDAD, FCJD.VALORTOTAL 
FROM   PCJ, FPA, FCJ, FCJD
WHERE  FPA.FORMAPAGO = PCJ.TIPOPAGO
AND    FCJ.CODCAJA   = PCJ.CODCAJA
AND    FCJ.CNSFACJ   = PCJ.CNSFACJ
AND    FCJD.CODCAJA  = PCJ.CODCAJA
AND    FCJD.CNSFACJ  = PCJ.CNSFACJ
GO

-- -----------------------------------------------------------------------------
-- VISTA PARA VTOS DE FACTURAS DE ACUERDO AL TIPO DETERCERO CONTABLE
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_CXCDV_TTEC' AND TYPE='V')
BEGIN
 DROP VIEW VWK_CXCDV_TTEC
END
GO
CREATE VIEW DBO.VWK_CXCDV_TTEC  
AS              
 SELECT ANO=YEAR(GETDATE()), MES=MONTH(GETDATE()), ISNULL(TTEC.TIPO,'SIN PLAN') AS TIPOTTEC, FCXC.IDTERCERO, 
        FCXCDV.CNSCXC, FCXCDV.N_FACTURA, FCXCDV.ITEM, FCXCDV.CNSGLO, FCXCDV.TIPO, FCXCDV.SALDONETO, 
        FCXCDV.FECHA, FCXCDV.F_VENCE, FCXCDV.F_RECIBIDO, FCXCDV.SALDOINICIAL, FCXCDV.MARCAPAGO, 
        DATEDIFF(DAY, FCXCDV.F_VENCE,  GETDATE()) AS DIASVENCE,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) < 0 THEN  FCXCDV.SALDONETO ELSE 0 END AS PORVENCER,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   0 AND  30 THEN  FCXCDV.SALDONETO ELSE 0 END AS D0_30,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   31 AND  60 THEN  FCXCDV.SALDONETO ELSE 0 END AS D31_60,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   61 AND  90 THEN  FCXCDV.SALDONETO ELSE 0 END AS D61_90,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   91 AND  120 THEN  FCXCDV.SALDONETO ELSE 0 END AS D91_120,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   121 AND  150 THEN  FCXCDV.SALDONETO ELSE 0 END AS D121_150,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   151 AND  180 THEN  FCXCDV.SALDONETO ELSE 0 END AS D151_180,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   181 AND  360 THEN  FCXCDV.SALDONETO ELSE 0 END AS D181_360,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) > 360 THEN  FCXCDV.SALDONETO ELSE 0 END AS D361_MAS,
        NORADICADA = 0  
 FROM  FCXCDV INNER JOIN 
       FCXCD ON FCXCDV.CNSCXC = FCXCD.CNSCXC AND FCXCDV.N_FACTURA = FCXCD.N_FACTURA INNER JOIN
       FCXC ON FCXC.CNSCXC = FCXCD.CNSCXC LEFT JOIN
       PPT ON FCXC.IDTERCERO = PPT.IDTERCERO AND FCXCD.IDPLAN = PPT.IDPLAN LEFT JOIN
       TTEC ON PPT.TIPOTERCONTABLE = TTEC.TIPO      
 WHERE FCXC.INDRECIBIDO=1 AND FCXCDV.SALDONETO > 0 AND FCXC.PROCEDENCIA='CARTERA'
 UNION ALL
 SELECT FCXC.ANO, FCXC.MES, ISNULL(TTEC.TIPO,'SIN PLAN') AS TIPOTTEC, FCXC.IDTERCERO, 
        FCXCDV.CNSCXC, FCXCDV.N_FACTURA, FCXCDV.ITEM, FCXCDV.CNSGLO, FCXCDV.TIPO, FCXCDV.SALDONETO, 
        FCXCDV.FECHA, FCXCDV.F_VENCE, FCXCDV.F_RECIBIDO, FCXCDV.SALDOINICIAL, FCXCDV.MARCAPAGO, 
        DATEDIFF(DAY, FCXCDV.F_VENCE,  GETDATE()) AS DIASVENCE,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) < 0 THEN  FCXCDV.SALDONETO ELSE 0 END AS PORVENCER,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   0 AND  30 THEN  FCXCDV.SALDONETO ELSE 0 END AS D0_30,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   31 AND  60 THEN  FCXCDV.SALDONETO ELSE 0 END AS D31_60,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   61 AND  90 THEN  FCXCDV.SALDONETO ELSE 0 END AS D61_90,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   91 AND  120 THEN  FCXCDV.SALDONETO ELSE 0 END AS D91_120,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   121 AND  150 THEN  FCXCDV.SALDONETO ELSE 0 END AS D121_150,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   151 AND  180 THEN  FCXCDV.SALDONETO ELSE 0 END AS D151_180,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) BETWEEN   181 AND  360 THEN  FCXCDV.SALDONETO ELSE 0 END AS D181_360,  
        CASE WHEN DATEDIFF(DAY, FCXCDV.F_VENCE, GETDATE()) > 360 THEN  FCXCDV.SALDONETO ELSE 0 END AS D361_MAS,
        NORADICADA = 0  
 FROM  FCXCDVH FCXCDV INNER JOIN 
       FCXCDH FCXCD ON FCXCDV.CNSCXC = FCXCD.CNSCXC AND FCXCDV.N_FACTURA = FCXCD.N_FACTURA AND FCXCDV.ANO=FCXCD.ANO AND FCXCDV.MES = FCXCD.MES INNER JOIN
       FCXCH FCXC ON FCXC.CNSCXC = FCXCD.CNSCXC AND FCXC.ANO=FCXCD.ANO AND FCXC.MES = FCXCD.MES LEFT JOIN
       PPT ON FCXC.IDTERCERO = PPT.IDTERCERO AND FCXCD.IDPLAN = PPT.IDPLAN LEFT JOIN
       TTEC ON PPT.TIPOTERCONTABLE = TTEC.TIPO      
 WHERE FCXC.INDRECIBIDO=1 AND FCXCDV.SALDONETO > 0 AND FCXC.PROCEDENCIA='CARTERA' AND FCXC.FECHACORTE < GETDATE()
 UNION ALL
 SELECT ANO=YEAR(GETDATE()), MES=MONTH(GETDATE()), ISNULL(TTEC.TIPO,'SIN PLAN') AS TIPOTTEC, FTR.IDTERCERO, 
        CNSCXC='NO RADICADA', FTR.N_FACTURA, ITEM = 0, CNSGLO = 0, TIPO = '', SALDONETO = FTR.VR_TOTAL, 
        FECHA = FTR.F_FACTURA, FTR.F_VENCE, F_RECIBIDO = NULL, SALDOINICIAL = FTR.VR_TOTAL, MARCAPAGO = 0, 
        DATEDIFF(DAY, FTR.F_VENCE,  GETDATE()) AS DIASVENCE,  
        0 AS PORVENCER,  
        0 AS D0_30,  
        0 AS D31_60,  
        0 AS D61_90,  
        0 AS D91_120,  
        0 AS D121_150,  
        0 AS D151_180,  
        0 AS D181_360,  
        0 AS D361_MAS,
        NORADICADA = FTR.VR_TOTAL  
 FROM  FTR LEFT JOIN 
       PPT ON FTR.IDTERCERO = PPT.IDTERCERO AND FTR.IDPLAN = PPT.IDPLAN LEFT JOIN
       TTEC ON PPT.TIPOTERCONTABLE = TTEC.TIPO      
 WHERE ISNULL(FTR.INDCXC,0) = 0 AND FTR.ESTADO<>'A' AND COALESCE (FTR.TIPOANULACION,'') <> 'NC'
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_VCTOS_TTEC' AND TYPE='V')
BEGIN
 DROP VIEW VWK_VCTOS_TTEC
END
GO
-- -----------------------------------------             
CREATE VIEW DBO.VWK_VCTOS_TTEC 
AS                         
SELECT ANO, MES, TIPOTTEC, SUM(SALDONETO) AS SALDOTOT, SUM(PORVENCER) AS PORVENCER, 
       SUM(D0_30)    AS SALDO_0_30,    SUM(D31_60)   AS SALDO_31_60,   
       SUM(D61_90)   AS SALDO_61_90,   SUM(D91_120)  AS SALDO_91_120,  
       SUM(D121_150) AS SALDO_121_150, SUM(D151_180) AS SALDO_151_180, 
       SUM(D181_360) AS SALDO_181_360, SUM(D361_MAS) AS SALDO_361_MAS,
       SUM(NORADICADA) AS NORADICADA
FROM VWK_CXCDV_TTEC
GROUP BY ANO, MES, TIPOTTEC
GO

-- -----------------------------------------             
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_RECAUDOS' AND TYPE='V')
BEGIN
 DROP VIEW VWK_RECAUDOS
END
GO
-- -----------------------------------------             
CREATE VIEW DBO.VWK_RECAUDOS
AS     
SELECT FPAG.FECHAPAGO, FPAG.IDTERCERO, FPAGD.N_FACTURA, FPAGD.VALORPAGO, FPAGD.VLRIMPUESTO, 
       FPAGD.VLRDTOFIN, FPAGD.VLRGLOSA, FPAGD.SINPAGO,
       FTR.TIPOTTEC, FPAG.CERRADO, FPAGD.CNSFPAG, FPAGD.ITEM, 
       YEAR(FPAG.FECHAPAGO) AS ANOREC, MONTH(FPAG.FECHAPAGO)AS MESREC
FROM   FPAG, FPAGD LEFT OUTER JOIN FTR ON FTR.N_FACTURA = FPAGD.N_FACTURA
WHERE  FPAGD.CNSFPAG = FPAG.CNSFPAG
AND    FPAG.CERRADO  = 1
AND    (FPAG.INGRESO = 'CAJA' OR FPAG.INGRESO = 'BANCOS')
GO     
-- -----------------------------------------             
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_PAGOS_BCO' AND TYPE='V')
BEGIN
   DROP VIEW VWK_PAGOS_BCO
END
GO
-- -----------------------------------------             
CREATE VIEW DBO.VWK_PAGOS_BCO
AS
SELECT BMOV.FECHAOPERACION, BMOVD.IDTERCERO, BMOV.BANCO, BMOV.SUCURSAL, BMOV.CTA_BCO,
       BMOV.ITEM, BMOV.IDOPERACION,
       BMOVD.BANCO AS BANCODOC, BMOVD.FORMAPAGO, BMOVD.VLRITEM, BMOVD.ENPAGOS 
FROM   BMOVD, BMOV
WHERE  BMOVD.BANCO    = BMOV.BANCO
AND    BMOVD.SUCURSAL = BMOV.SUCURSAL
AND    BMOVD.CTA_BCO  = BMOV.CTA_BCO
AND    BMOVD.ITEM     = BMOV.ITEM
AND    BMOVD.RECAUDO  = 1
GO
-- -----------------------------------------             
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_PAGOS_CAJA' AND TYPE='V')
BEGIN
   DROP VIEW VWK_PAGOS_CAJA
END
GO
-- -----------------------------------------             
CREATE VIEW DBO.VWK_PAGOS_CAJA
AS
--	MOD. JQUIROGA 20090402 - Ingresado CASE para IDTERCERO
	SELECT	FCJ.FECHA,	CASE WHEN	FCJ.TIPO = 'INTERNO' AND UPPER(DBO.FnK_ValorVariable('CAJRPT_IMPIDAFILIADO')) = 'SI' 
							THEN FCJ.IDAFILIADO 
							ELSE FCJ.IDTERCERO 
						END AS IDTERCERO,
			FCJ.CODCAJA, FCJ.CNSFACJ, FCJ.VALORTOTAL, FCJ.ENPAGOS
	FROM   FCJ
	WHERE  FCJ.CLASE_FAC = 'COBRO'
	AND    FCJ.CERRADA   = 1
	AND    FCJ.RECAUDO   = 1
	AND    FCJ.ESTADO <> 'A'
GO
-- -----------------------------------------             
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_LIQ_IMP_1' AND TYPE='V')
BEGIN
   DROP VIEW VWK_LIQ_IMP_1
END
GO
-- -----------------------------------------             
CREATE VIEW DBO.VWK_LIQ_IMP_1
AS
SELECT MCP.ANO,
       MCP.MES,
       MCH.IDTERCERO,
       (SELECT RAZONSOCIAL FROM TER WHERE MCH.IDTERCERO=TER.IDTERCERO) AS RAZONSOACIAL,
       MCH.CUENTA,
       CUE.NOMCUENTA,
       SUM(MCH.BASE_IMP) AS BASE,
       CASE WHEN MCH.TIPO='DB' THEN SUM(MCH.VALOR) ELSE 0 END AS DEBITOS,  
       CASE WHEN MCH.TIPO='CR' THEN SUM(MCH.VALOR) ELSE 0 END AS CREDITOS
FROM   MCP,MCH,CUE
WHERE  MCP.NROCOMPROBANTE=MCH.NROCOMPROBANTE AND MCH.CUENTA=CUE.CUENTA AND MCP.ESTADO=2 AND
       CUE.IMPUESTO=1 AND CUE.COMPANIA='01' AND NOT (BASE_IMP IS NULL OR BASE_IMP=0)
GROUP BY MCP.ANO,
       MCP.MES,
       MCH.IDTERCERO,
       MCH.CUENTA,
       CUE.NOMCUENTA,
       MCH.TIPO
GO
-- -----------------------------------------             
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_LIQ_IMP' AND TYPE='V')
BEGIN
   DROP VIEW VWK_LIQ_IMP
END
GO
-- -----------------------------------------   
CREATE VIEW DBO.VWK_LIQ_IMP
AS
SELECT VWK_LIQ_IMP_1.ANO,
       VWK_LIQ_IMP_1.MES,
       VWK_LIQ_IMP_1.IDTERCERO,
       VWK_LIQ_IMP_1.RAZONSOACIAL,
       VWK_LIQ_IMP_1.CUENTA,
       VWK_LIQ_IMP_1.NOMCUENTA,
       SUM(VWK_LIQ_IMP_1.BASE) AS BASE,
       SUM(VWK_LIQ_IMP_1.DEBITOS) AS DEBITOS,
       SUM(VWK_LIQ_IMP_1.CREDITOS) AS CREDITOS,
       CASE NTZ.TIPO
	WHEN 'DB' THEN SUM(VWK_LIQ_IMP_1.DEBITOS-VWK_LIQ_IMP_1.CREDITOS)
	WHEN 'CR' THEN SUM(VWK_LIQ_IMP_1.CREDITOS-VWK_LIQ_IMP_1.DEBITOS)
       END AS VALOR
FROM   VWK_LIQ_IMP_1,NTZ
WHERE  NTZ.N_INICIAL=LEFT(VWK_LIQ_IMP_1.CUENTA,1)
GROUP BY VWK_LIQ_IMP_1.ANO,
       VWK_LIQ_IMP_1.MES,
       VWK_LIQ_IMP_1.IDTERCERO,
       VWK_LIQ_IMP_1.RAZONSOACIAL,
       VWK_LIQ_IMP_1.CUENTA,
       VWK_LIQ_IMP_1.NOMCUENTA,
       NTZ.TIPO
GO
-- -----------------------------------------             
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_CTNORAD' AND TYPE='V')
BEGIN
   DROP VIEW VWK_CTNORAD
END
GO
-- -----------------------------------------   
CREATE VIEW DBO.VWK_CTNORAD
AS
SELECT FTR.N_FACTURA, FCXCD.CNSCXC, FTR.F_FACTURA,FTR.INDCXC, FTR.INDCARTERA, 
       FTR.INDASIGCXC, FTR.VR_TOTAL, FTR.IDDEP, FTR.IDPLAN, FTR.IDTERCERO
FROM   FTR LEFT JOIN FCXCD ON FTR.N_FACTURA = FCXCD.N_FACTURA
WHERE  FTR.INDCXC = 0
AND    FTR.ESTADO <> 'A' AND COALESCE (FTR.TIPOANULACION,'') <> 'NC'
GO
-- -----------------------------------------             
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_CTNORAD_RS' AND TYPE='V')
BEGIN
   DROP VIEW VWK_CTNORAD_RS
END
GO
-- -----------------------------------------   
CREATE VIEW DBO.VWK_CTNORAD_RS
AS
SELECT VWK_CTNORAD.IDDEP, FDEP.NOMBRE, SUM(VWK_CTNORAD.VR_TOTAL) AS TOTAL
FROM   VWK_CTNORAD LEFT OUTER JOIN FDEP
       ON VWK_CTNORAD.IDDEP = FDEP.IDDEP
GROUP BY VWK_CTNORAD.IDDEP, FDEP.NOMBRE
GO
-- -----------------------------------------             
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_TRATAMIENTO_O' AND TYPE='V')
BEGIN
   DROP VIEW VWK_TRATAMIENTO_O
END
GO
-- -----------------------------------------   
CREATE VIEW DBO.VWK_TRATAMIENTO_O
AS
SELECT HCAT.NOADMISION, HCA.FECHA, HCAT.CONSECUTIVO, HCAT.CODOM, HCCOM.DESCRIPCION, HCA.IDMEDICO, MED.NOMBRE,
       HCATD.IDSERVICIO, HCATD.CANTIDAD, HCATD.VIA, HCATD.ENCARGOS
FROM   HCA, HCAT, MPL, MED, HCCOM, HCATD
WHERE  HCAT.CONSECUTIVO   = HCA.CONSECUTIVO 
AND    HCAT.TIPOHISTORIA  = 'O' 
AND    HCA.CLASE          = 'HC' 
AND    HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
AND    MPL.AMBITO         = 'QX'
AND    MED.IDMEDICO       = HCA.IDMEDICO
AND    HCAT.CODOM         = HCCOM.CODOM
AND    HCATD.CONSECUTIVO  = HCAT.CONSECUTIVO
AND    HCATD.CODOM        = HCAT.CODOM
GO
-- -----------------------------------------             
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_TRATAMIENTO_E' AND TYPE='V')
BEGIN
   DROP VIEW VWK_TRATAMIENTO_E
END
GO
-- -----------------------------------------   
CREATE VIEW DBO.VWK_TRATAMIENTO_E
AS
SELECT HCAT.NOADMISION, HRED.FECHA, HCAT.CONSECUTIVO, HCAT.CODOM, HCCOM.DESCRIPCION, HRED.IDMEDICO, MED.NOMBRE,
       HCATD.IDSERVICIO, HCATD.CANTIDAD, HCATD.VIA, HCATD.ENCARGOS
FROM   HCA, HRED, HCAT, MPL, HCCOM, MED, HCATD
WHERE  HCAT.CONSECUTIVO   = HCA.CONSECUTIVO 
AND    HCAT.TIPOHISTORIA  = 'E' 
AND    HCA.CLASE          = 'HC' 
AND    HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
AND    MPL.AMBITO         = 'QX'
AND    HRED.CONSECUTIVO   = HCAT.CONSECUTIVO
AND    HRED.ITEMRED       = HCAT.ITEMRED
AND    HCCOM.CODOM        = HCAT.CODOM
AND    MED.IDMEDICO       = HRED.IDMEDICO
AND    HCATD.CONSECUTIVO  = HCAT.CONSECUTIVO
AND    HCATD.ITEMRED      = HCAT.ITEMRED
AND    HCATD.CODOM        = HCAT.CODOM
GO
-- -----------------------------------------
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_AUT_FTR' AND TYPE='V')
BEGIN
   DROP VIEW VWK_AUT_FTR
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VWK_AUT_FTR WITH ENCRYPTION AS
SELECT DISTINCT AUT.IDAUT, AUT.NOAUT, AUT.FECHA, AUT.FECHAVENCE, AUT.IDAFILIADO, AUT.NUMCARNET, AUTD.IDPLAN, AUT.PREFIJO,
       AUT.IDSEDE, AUT.TIPOAUTORIZACION, AUT.ALTOCOSTO, AUT.ATENCION, AUT.URGENCIA, AUT.IMPUTABLE_A, AUT.IDSOLICITANTE,
       AUT.IDPROVEEDOR, AUT.ESTADO, AUT.CONSANULADO, AUT.IDOPERADORANULA, AUT.FECHAANULA, AUT.CAUSALANULA, 
       AUT.NO_ITEMES, AUT.VALORTOTAL, AUT.VALORCOPAGO, AUT.VALORBENEFICIO, AUT.VALOREXEDENTE, AUT.VALORTOTALCOSTO,
       AUT.VALORCOPAGOCOSTO, AUT.IMPRESO, AUT.CXPGEN, AUT.CXCGEN, AUT.AUTORIZADOPOR, AUT.NUMAUTORIZA, AUT.FECHAAUTORIZA,
       AUT.AUTORIZADO, AUT.IDPESPECIAL, AUT.IDESTADOE, AUT.USUARIO, AUT.RECOBRARA, AUT.FUENTE, AUT.IDCAUSAEXT, 
       AUT.AMBITO, AUT.FINALIDAD, AUT.PERSONAL_AT, AUT.DXPPAL, AUT.DXRELACIONADO, AUT.COMPLICACION, AUT.FORMAQX,
       AUT.TIPOURGENCIA, AUT.SPD, AUT.NORECIBOCAJA, AUT.CLASEORDEN, AUT.GENEROCAJA, AUTD.IDTERCEROCA AS IDCONTRATANTE, 
       AUT.TIPOCOPAGO, AUT.PEDIDOINV, AUT.ENVIO, AUT.OBS, AUT.ESCONTINUACION, AUT.NOAUTORIGEN, AUT.IDSEDEORIGEN, 
       AUT.SEMANASCOT,
       AUT.LIQUIDAPC, AUT.OBSDX, AUT.COMITE, AUT.CERTIFICACION, AUT.IDCLASEAUT, AUT.CLASECONT, AUT.ESDEINV, 
       AUT.NOGENERACIONOPS, AUT.FECHAGEN, AUT.IDAREA, AUT.NIVELATENCION, AUT.CNSAFIAA, AUT.SUBCCOSTO, AUT.CCOSTO,
       AUT.PROCEDENCIA, AUT.IDAREAH, AUTD.FACTURADA, AUTD.N_FACTURA, AUTD.CNSFCT, AUT.VFACTURAS, AUT.FACTURABLE,
       AUT.DESCUENTO, AUT.TIPODTO, AUT.MARCAFAC, AUT.IDIPS, AUT.CLASECONTRATO, AUT.ENPAQUETE, AUT.IDCIRUGIA,
       AUT.SOAT, AUT.NOADMISION, AUT.IDCONTRATO, AUT.RUBRO, AUT.CLASERUBRO, AUT.FECHASOL, AUT.PERIODICIDAD, 
       AUT.CNSFACT, AUT.CONTINUACION, AUT.VLRUTOTRA, AUT.TIPOCONT, AUT.DXRELACIONADO2, AUT.FECHACOMITE,
       AUT.IDALTERNA, AUT.MARCAENV, AUT.COPAGOPROPIO, AUT.CNSHACTRAN, AUT.ESDELAB, AUT.ENLAB, AUT.COBRARA, 
       AUTD.IDTERCEROCA, AUT.CONSECUTIVOHCA, AUT.RAZONANULACION, AUT.FECHAREALIZACION, AUT.IDGRUPOSER, AUT.PEXTERNA,
       AUT.PIDECCOSTO, AUT.CODCAJA, AUT.TIPOCAJA, AUT.CERRADA    
FROM   AUT INNER JOIN AUTD ON AUT.IDAUT = AUTD.IDAUT
--WHERE  AUTD.FACTURADA = 0 OR AUTD.FACTURADA IS NULL
GO
/********************************************************************************************************************/
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'SERTOT_PAQNOR' AND TYPE='V')
BEGIN
   DROP VIEW SERTOT_PAQNOR
END
GO
/********************************************************************************************************************/
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'SERPRO_PAQNOR' AND TYPE='V')
BEGIN
   DROP VIEW SERPRO_PAQNOR
END
GO
/********************************************************************************************************************/
CREATE VIEW DBO.SERPRO_PAQNOR WITH SCHEMABINDING    
AS     
SELECT DISTINCT DBO.PPT.IDTERCERO, DBO.PPT.IDTARIFA, DBO.SER.PREFIJO, DBO.TARD.IDSERVICIO,    
       DBO.SER.DESCSERVICIO, DBO.SER.SEXO, DBO.TARDV.VALOR, DBO.PPT.FACTOR, DBO.PPT.IDPLAN,    
       CASE DBO.TARD.CIRUGIA    
            WHEN 1 THEN DBO.TARDV.VALOR    
            ELSE    
               CASE DBO.TARF.REDONDEO
               WHEN 'Unidad'   THEN round(DBO.TARDV.VALOR*DBO.PPT.FACTOR*DBO.TARF.FACTORDINERO,0)
               WHEN 'Decena'   THEN round(DBO.TARDV.VALOR*DBO.PPT.FACTOR*DBO.TARF.FACTORDINERO,-1)
               WHEN 'Centena'  THEN round(DBO.TARDV.VALOR*DBO.PPT.FACTOR*DBO.TARF.FACTORDINERO,-2)
               WHEN 'Millar'   THEN round(DBO.TARDV.VALOR*DBO.PPT.FACTOR*DBO.TARF.FACTORDINERO,-3)
               WHEN 'Dos Dec.' THEN round(DBO.TARDV.VALOR*DBO.PPT.FACTOR*DBO.TARF.FACTORDINERO,2)
               WHEN 'SIN'      THEN (DBO.TARDV.VALOR*DBO.PPT.FACTOR*DBO.TARF.FACTORDINERO)
               ELSE round(DBO.TARDV.VALOR*DBO.PPT.FACTOR*DBO.TARF.FACTORDINERO,0)    
               END     
       END AS VLRSERVICIO , DBO.TARD.CIRUGIA , 0 AS PAQUETE,  
       CASE DBO.PPT.CAPITADO    
            WHEN 1 THEN 'Capitado'  
            ELSE 'Evento'  
       END AS TIPOCONTRATO, DBO.TARF.FECHAINI AS FECHAINIFD, DBO.TARF.FECHAFIN AS FECHAFINFD,
       DBO.SER.NIVELFUNCIONARIO,DBO.SER.NIVELSEDE,DBO.SER.MOBSOBLIGATORIA,DBO.SER.POS,
       DBO.SER.REQAUTORIZACION,DBO.SER.TIPOAUTORIZACION, 'NA' AS IDACUMULADOR, DBO.SER.MEDICAMENTOS,
       DBO.SER.IDARTICULO, DBO.SER.NIVELATENCION, DBO.SER.IDGENERICO, DBO.TARDV.FECHAINI, 
       DBO.TARDV.FECHAFIN, DBO.TAR.CODIFICACION 
FROM   DBO.TARD,DBO.SER,DBO.PPT, DBO.TARF, DBO.TARDV, DBO.TAR
WHERE  DBO.PPT.IDTARIFA = DBO.TARD.IDTARIFA    
AND    DBO.TAR.IDTARIFA   = DBO.TARD.IDTARIFA    
AND    DBO.TARD.IDSERVICIO   = DBO.SER.IDSERVICIO    
AND    DBO.SER.ESTADO        <> 'Inactivo'     
AND    DBO.PPT.FACTOR        > 0    
AND    DBO.TARD.IDTARIFA     = DBO.TARF.IDTARIFA
AND    DBO.TARDV.IDTARIFA    = DBO.TARD.IDTARIFA
AND    DBO.TARDV.IDSERVICIO  = DBO.TARD.IDSERVICIO
AND    DBO.SER.IDSERVICIO NOT IN    
       (SELECT DBO.SERETPPAR.IDSERVICIO    
        FROM   DBO.SERETPPAR    
        WHERE  DBO.SERETPPAR.IDTERCERO = DBO.PPT.IDTERCERO    
        AND    DBO.SERETPPAR.IDPLAN    = DBO.PPT.IDPLAN )    
AND    DBO.TARD.IDSERVICIO NOT IN    
       (SELECT DBO.ESP.IDSERVICIO    
        FROM   DBO.ESP    
        WHERE  DBO.ESP.IDPROVEEDOR = DBO.PPT.IDTERCERO    
        AND    DBO.ESP.IDPLAN      = DBO.PPT.IDPLAN
        AND    ISNULL(DBO.ESP.PAQUETE,0)     = 0)  
GO 
/********************************************************************************************************************/
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'SERESP_PAQNOR' AND TYPE='V')
BEGIN
   DROP VIEW SERESP_PAQNOR
END
GO
/********************************************************************************************************************/
CREATE VIEW DBO.SERESP_PAQNOR WITH SCHEMABINDING    
AS     
SELECT DISTINCT DBO.ESP.IDPROVEEDOR AS IDTERCERO,DBO.ESP.IDTARIFA,DBO.SER.PREFIJO AS PREFIJO,DBO.ESP.IDSERVICIO,    
       DBO.SER.DESCSERVICIO,DBO.SER.SEXO,DBO.ESP.VALOR,DBO.ESP.FACTOR,DBO.ESP.IDPLAN,    
       DBO.esp.valor AS VLRSERVICIO ,
       CASE ISNULL(DBO.ESP.PAQUETE,0)
       WHEN 1 THEN 1
       ELSE 0
       END AS CIRUGIA,
       DBO.ESP.PAQUETE,DBO.ESP.TIPOCONTRATO,
       '01/01/2002' AS FECHAINIFD,'31/12/2010' AS FECHAFINFD,
       DBO.SER.NIVELFUNCIONARIO,DBO.SER.NIVELSEDE,DBO.SER.MOBSOBLIGATORIA,DBO.SER.POS,
       DBO.SER.REQAUTORIZACION,DBO.SER.TIPOAUTORIZACION, DBO.ESP.IDACUMULADOR, DBO.SER.MEDICAMENTOS,
       DBO.SER.IDARTICULO, DBO.SER.NIVELATENCION, DBO.SER.IDGENERICO, '01/01/2002' AS FECHAINI,
       '31/12/2010' AS FECHAFIN
FROM   DBO.ESP,DBO.SER
WHERE  DBO.SER.IDSERVICIO      = DBO.ESP.IDSERVICIO    
AND    DBO.ESP.TIPORESTRICCION = 'Valor'    
AND    ISNULL(DBO.ESP.PAQUETE,0) = 0
GO
/********************************************************************************************************************/
 CREATE VIEW DBO.SERTOT_PAQNOR WITH SCHEMABINDING AS    
   SELECT DBO.SERPRO_PAQNOR.IDTERCERO,DBO.SERPRO_PAQNOR.IDTARIFA,DBO.SERPRO_PAQNOR.PREFIJO,DBO.SERPRO_PAQNOR.IDSERVICIO,    
          DBO.SERPRO_PAQNOR.DESCSERVICIO,DBO.SERPRO_PAQNOR.SEXO,DBO.SERPRO_PAQNOR.VALOR,    
          DBO.SERPRO_PAQNOR.FACTOR,DBO.SERPRO_PAQNOR.IDPLAN, CAST(DBO.SERPRO_PAQNOR.VLRSERVICIO AS DECIMAL(37,11)) AS VLRSERVICIO,
          DBO.SERPRO_PAQNOR.CIRUGIA,DBO.SERPRO_PAQNOR.PAQUETE,  
          DBO.SERPRO_PAQNOR.TIPOCONTRATO,DBO.SERPRO_PAQNOR.FECHAINIFD,SERPRO_PAQNOR.FECHAFINFD,
          DBO.SERPRO_PAQNOR.NIVELFUNCIONARIO,DBO.SERPRO_PAQNOR.NIVELSEDE,DBO.SERPRO_PAQNOR.MOBSOBLIGATORIA,DBO.SERPRO_PAQNOR.POS,
          DBO.SERPRO_PAQNOR.REQAUTORIZACION,DBO.SERPRO_PAQNOR.TIPOAUTORIZACION, DBO.SERPRO_PAQNOR.IDACUMULADOR, DBO.SERPRO_PAQNOR.MEDICAMENTOS,
          DBO.SERPRO_PAQNOR.IDARTICULO, DBO.SERPRO_PAQNOR.NIVELATENCION, DBO.SERPRO_PAQNOR.IDGENERICO,
          DBO.SERPRO_PAQNOR.FECHAINI, DBO.SERPRO_PAQNOR.FECHAFIN, '00000000000000000000' AS IDTERCEROCA, 
          '000000' AS IDPLANCA, 0 AS REQAUTORIZACIONCA,
          '00000000000000000000' AS IDAREACA, DBO.SERPRO_PAQNOR.CODIFICACION
   FROM DBO.SERPRO_PAQNOR
UNION ALL    
   SELECT DBO.SERETP.IDTERCERO,DBO.SERETP.IDTARIFA,DBO.SERETP.PREFIJO,DBO.SERETP.IDSERVICIO,    
          DBO.SERETP.DESCSERVICIO,DBO.SERETP.SEXO,DBO.SERETP.VALOR,    
          DBO.SERETP.FACTOR,DBO.SERETP.IDPLAN, CAST(DBO.SERETP.VLRSERVICIO AS DECIMAL(37,11)) AS VALORSERVICIO, 
          DBO.SERETP.CIRUGIA,DBO.SERETP.PAQUETE,  
          DBO.SERETP.TIPOCONTRATO,DBO.SERETP.FECHAINIFD,DBO.SERETP.FECHAFINFD,
          DBO.SERETP.NIVELFUNCIONARIO,DBO.SERETP.NIVELSEDE,DBO.SERETP.MOBSOBLIGATORIA,DBO.SERETP.POS,
          DBO.SERETP.REQAUTORIZACION,DBO.SERETP.TIPOAUTORIZACION, DBO.SERETP.IDACUMULADOR, DBO.SERETP.MEDICAMENTOS,
          DBO.SERETP.IDARTICULO, DBO.SERETP.NIVELATENCION, DBO.SERETP.IDGENERICO,
          DBO.SERETP.FECHAINI, DBO.SERETP.FECHAFIN, '00000000000000000000' AS IDTERCEROCA, 
          '000000' AS IDPLANCA, 0 AS REQAUTORIZACIONCA,
          '00000000000000000000' AS IDAREACA, DBO.SERETP.CODIFICACION 
   FROM DBO.SERETP    
UNION ALL    
   SELECT DBO.SERESP.IDTERCERO,DBO.SERESP.IDTARIFA,DBO.SERESP.PREFIJO,DBO.SERESP.IDSERVICIO,    
          DBO.SERESP.DESCSERVICIO,DBO.SERESP.SEXO,DBO.SERESP.VALOR,    
          DBO.SERESP.FACTOR,DBO.SERESP.IDPLAN, CAST(DBO.SERESP.VLRSERVICIO AS DECIMAL(37,11)) AS VALORSERVICIO,
          DBO.SERESP.CIRUGIA,DBO.SERESP.PAQUETE,  
          DBO.SERESP.TIPOCONTRATO,DBO.SERESP.FECHAINIFD,DBO.SERESP.FECHAFINFD,
          DBO.SERESP.NIVELFUNCIONARIO,DBO.SERESP.NIVELSEDE,DBO.SERESP.MOBSOBLIGATORIA,DBO.SERESP.POS,
          DBO.SERESP.REQAUTORIZACION,DBO.SERESP.TIPOAUTORIZACION, DBO.SERESP.IDACUMULADOR, DBO.SERESP.MEDICAMENTOS,
          DBO.SERESP.IDARTICULO, DBO.SERESP.NIVELATENCION, DBO.SERESP.IDGENERICO,
          DBO.SERESP.FECHAINI, DBO.SERESP.FECHAFIN, '00000000000000000000' AS IDTERCEROCA, 
          '000000' AS IDPLANCA, 0 AS REQAUTORIZACIONCA,
          '00000000000000000000' AS IDAREACA, DBO.SERESP.CODIFICACION 
   FROM DBO.SERESP    
UNION ALL
   SELECT DBO.SERESP_PAQNOR.IDTERCERO,DBO.SERESP_PAQNOR.IDTARIFA,DBO.SERESP_PAQNOR.PREFIJO,DBO.SERESP_PAQNOR.IDSERVICIO,    
          DBO.SERESP_PAQNOR.DESCSERVICIO,DBO.SERESP_PAQNOR.SEXO,DBO.SERESP_PAQNOR.VALOR,    
          DBO.SERESP_PAQNOR.FACTOR,DBO.SERESP_PAQNOR.IDPLAN, CAST(DBO.SERESP_PAQNOR.VLRSERVICIO AS DECIMAL(37,11)) AS VALORSERVICIO,
          DBO.SERESP_PAQNOR.CIRUGIA,DBO.SERESP_PAQNOR.PAQUETE,  
          DBO.SERESP_PAQNOR.TIPOCONTRATO,DBO.SERESP_PAQNOR.FECHAINIFD,DBO.SERESP_PAQNOR.FECHAFINFD,
          DBO.SERESP_PAQNOR.NIVELFUNCIONARIO,DBO.SERESP_PAQNOR.NIVELSEDE,DBO.SERESP_PAQNOR.MOBSOBLIGATORIA,DBO.SERESP_PAQNOR.POS,
          DBO.SERESP_PAQNOR.REQAUTORIZACION,DBO.SERESP_PAQNOR.TIPOAUTORIZACION, DBO.SERESP_PAQNOR.IDACUMULADOR, DBO.SERESP_PAQNOR.MEDICAMENTOS,
          DBO.SERESP_PAQNOR.IDARTICULO, DBO.SERESP_PAQNOR.NIVELATENCION, DBO.SERESP_PAQNOR.IDGENERICO,
          DBO.SERESP_PAQNOR.FECHAINI, DBO.SERESP_PAQNOR.FECHAFIN, '00000000000000000000' AS IDTERCEROCA, 
          '000000' AS IDPLANCA, 0 AS REQAUTORIZACIONCA,
          '00000000000000000000' AS IDAREACA, '' AS CODIFICACION 
   FROM DBO.SERESP_PAQNOR
GO 

/*******************************************************************************************/
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME ='VWK_MOVIMIENTOS_DE_FACTURA' AND XTYPE='V')
 DROP VIEW VWK_MOVIMIENTOS_DE_FACTURA
GO
-- ---------------------------------------------------
CREATE VIEW [dbo].[VWK_MOVIMIENTOS_DE_FACTURA]
AS
SELECT     dbo.FCXCD.CNSCXC, 'FACTURACION' AS PROCEDENCIA, dbo.FTR.N_FACTURA, dbo.FTR.IDTERCERO, dbo.TER.RAZONSOCIAL, 
                      dbo.FTR.NROCOMPROBANTE, dbo.FTR.VR_TOTAL, dbo.FTR.F_FACTURA, 
                      CASE WHEN FTR.ESTADO = 'P' THEN 'ACTIVA' ELSE 'ANULADA' END AS ESTADO
FROM         dbo.FTR INNER JOIN
                      dbo.TER ON dbo.FTR.IDTERCERO = dbo.TER.IDTERCERO LEFT OUTER JOIN
                      dbo.FCXCD ON dbo.FTR.N_FACTURA = dbo.FCXCD.N_FACTURA
UNION ALL
SELECT     FCXCD_1.CNSCXC, 'NOTA' + '' + dbo.FNOT.CLASE AS Expr1, dbo.FNOT.N_FACTURA, dbo.FNOT.IDTERCERO, TER_3.RAZONSOCIAL, 
                      dbo.FNOT.NROCOMPROBANTE, dbo.FNOT.VR_TOTAL, dbo.FNOT.F_NOTA, 
                      CASE WHEN FNOT.ESTADO = 'O' THEN 'APLICADA' ELSE 'SIN APLICAR' END AS ESTADO
FROM         dbo.FNOT INNER JOIN
                      dbo.TER AS TER_3 ON dbo.FNOT.IDTERCERO = TER_3.IDTERCERO LEFT OUTER JOIN
                      dbo.FCXCD AS FCXCD_1 ON dbo.FNOT.N_FACTURA = FCXCD_1.N_FACTURA
WHERE     (dbo.FNOT.CERRADA = 1)
UNION ALL
SELECT     dbo.FPAGD.CNSCXC, 'PAGO' AS Expr1, dbo.FPAGD.N_FACTURA, dbo.FPAG.IDTERCERO, TER_2.RAZONSOCIAL, dbo.FPAG.NROCOMPROBANTE, 
                      dbo.FPAGD.VALORPAGO, dbo.FPAG.FECHA, CASE WHEN FPAGD.CERRADO = 1 THEN 'APLICADO' ELSE 'SIN APLICAR' END AS ESTADO
FROM         dbo.FPAG INNER JOIN
                      dbo.TER AS TER_2 ON dbo.FPAG.IDTERCERO = TER_2.IDTERCERO INNER JOIN
                      dbo.FPAGD ON dbo.FPAG.CNSFPAG = dbo.FPAGD.CNSFPAG
WHERE     (dbo.FPAGD.VALORPAGO > 0)
UNION ALL
SELECT     dbo.FGLO.CNSCXC, 'GLOSA' AS Expr1, dbo.FGLO.N_FACTURA, dbo.FGLO.IDTERCERO, TER_1.RAZONSOCIAL, dbo.FGLO.NROCOMPROBANTE, 
                      dbo.FGLO.VLRGLOSA, dbo.FGLO.FECHAAUD, CASE WHEN FGLO.ESTADO = 'O' AND 
                      CERRADA = 1 THEN 'APLICADA RESP.' ELSE 'SIN APLICAR' END AS ESTADO
FROM         dbo.FGLO INNER JOIN
                      dbo.TER AS TER_1 ON dbo.FGLO.IDTERCERO = TER_1.IDTERCERO
GO
/*********************************************************************************/
-- ADD.JQUIROGA 20090621 - Libro de Ventas JCURCIO en Contabilidad
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_LIBRO_VENTAS' AND TYPE='V')
BEGIN
 DROP VIEW VWK_LIBRO_VENTAS
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VWK_LIBRO_VENTAS WITH SCHEMABINDING      
AS  
	SELECT	dbo.FTR.PROCEDENCIA, '' AS No_OPER, dbo.FTR.F_FACTURA AS FECHA_FACTURA,
			CASE WHEN  dbo.FTR.N_FACTURA NOT IN (SELECT dbo.FNOT.N_FACTURA FROM dbo.FNOT)
							 THEN dbo.FTR.N_FACTURA ELSE '' END AS NUMERO_DE_FACTURA, 
			ISNULL(dbo.FTR.NROCONTROL, '') AS NROCONTROL,
			CASE WHEN  dbo.FTR.ESTADO = 'P' AND dbo.FTR.PROCEDENCIA = 'SALUD' THEN dbo.FTR.IDAFILIADO
							 WHEN  dbo.FTR.ESTADO = 'P' AND dbo.FTR.PROCEDENCIA = 'FINANCIERO' THEN dbo.FTR.IDTERCERO 
								WHEN  dbo.FTR.ESTADO = 'A' THEN 'ANULADA' ELSE '' END AS CEDULA_RIF, 
			CASE WHEN  dbo.FTR.ESTADO = 'P' AND dbo.FTR.PROCEDENCIA = 'SALUD'
							 THEN  LTRIM(RTRIM(dbo.AFI.PAPELLIDO))+ ' '  + LTRIM(RTRIM(dbo.AFI.SAPELLIDO)) + ' ' + 
														LTRIM(RTRIM(dbo.AFI.PNOMBRE))  + ' '  + LTRIM(RTRIM(dbo.AFI.SNOMBRE))
							 WHEN  dbo.FTR.ESTADO = 'P' AND FTR.PROCEDENCIA = 'FINANCIERO'
								THEN dbo.TER.RAZONSOCIAL END AS NOMBRE_O_RAZON_SOCIAL,
			CASE WHEN dbo.FNOT.CLASE = 'D' THEN dbo.FNOT.CNSFNOT ELSE '' END AS NO_NOTA_DEBITO,
			CASE WHEN dbo.FNOT.CLASE = 'C' THEN dbo.FNOT.CNSFNOT ELSE '' END AS NO_NOTA_CREDITO,
			'01-REG' AS TIPO_TRANSACCION,
			CASE WHEN dbo.FTR.N_FACTURA IN (SELECT dbo.FNOT.N_FACTURA FROM dbo.FNOT)
							 THEN dbo.FTR.N_FACTURA ELSE '' END AS NUMERO_FACTURA_AFECTADA, 
			(SELECT SUM(X.VR_TOTAL) FROM dbo.FTRD X WHERE X.PREFIJO NOT IN ('17','20','30','40','50','60','70','80')
						AND X.N_FACTURA = FTR.N_FACTURA GROUP BY X.N_FACTURA) AS TOTAL_VENTAS_INCLUYENDO_IVA,
			CASE WHEN FTR.ESTADO = 'P' AND FTR.PROCEDENCIA = 'SALUD'
							 THEN dbo.FTR.VALORSERVICIOS
							 WHEN dbo.FTR.ESTADO = 'P' AND dbo.FTR.PROCEDENCIA = 'FINANCIERO' AND dbo.FTR.IDPLAN = 'CMAD'
								THEN dbo.FTR.VR_TOTAL END AS VALOR_FACTURADO_INCLUYENDO_IVA,
			ISNULL((SELECT SUM(X.VR_TOTAL) FROM dbo.FTRD X WHERE X.PREFIJO NOT IN ('CA','17','20','30','40','50','60','70','80')
							 AND X.N_FACTURA = dbo.FTR.N_FACTURA GROUP BY X.N_FACTURA),'') AS VENTAS_INTERNAS_NO_GRAVADAS,
			ISNULL((SELECT SUM(X.VR_TOTAL) FROM dbo.FTRD X WHERE X.PREFIJO IN ('17','20','30','40','50','60','70','80')
							 AND X.N_FACTURA = dbo.FTR.N_FACTURA GROUP BY X.N_FACTURA), '') AS VENTAS_POR_CUENTA_DE_TERCEROS,
			CASE WHEN dbo.FTR.PROCEDENCIA = 'FINANCIERO' AND FTR.VIVA != 0 AND FTR.IDPLAN = 'CMAD'
							 THEN dbo.FTR.VR_TOTAL - dbo.FTR.VIVA ELSE 0 END AS VENTAS_INTERNAS_GRAVADAS,
			'12%' AS ALICUOTA,
		CASE WHEN dbo.FTR.ESTADO = 'P' AND dbo.FTR.PROCEDENCIA = 'FINANCIERO' AND dbo.FTR.IDPLAN = 'CMAD'
								THEN dbo.FTR.VIVA END AS IVA,
			'-' AS No_DE_COMPROBANTE, '0.00' AS IMPUESTO_RETENIDO
FROM				dbo.FTR LEFT  JOIN dbo.AFI  ON dbo.FTR.IDAFILIADO = dbo.AFI.IDAFILIADO
												LEFT  JOIN dbo.TER  ON dbo.FTR.IDTERCERO = dbo.TER.IDTERCERO
												LEFT  JOIN dbo.FNOT ON dbo.FTR.N_FACTURA = dbo.FNOT.N_FACTURA
GO
/*********************************************************************************/
-- ADD.JQUIROGA 20090621 - Libro de Compras JALFARO en Contabilidad
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_LIBRO_COMPRAS' AND TYPE='V')
BEGIN
 DROP VIEW VWK_LIBRO_COMPRAS
END
GO
-- -----------------------------------------
CREATE VIEW DBO.VWK_LIBRO_COMPRAS WITH SCHEMABINDING      
AS  
	SELECT dbo.TER.RAZONSOCIAL, dbo.FCXP.IDTERCERO AS RIF,NATJURIDICA AS TIPODEPROVEEDOR,
	'2009060000  ' + CAST (RIGHT (FCXP.CNSFCXP,4) AS VARCHAR (60)) AS NoDECOMPROBANTE,
	dbo.FCXP.FECHA AS FECHA_APLIC_RET,
	'' AS NROPLANTILLAIMPORT,
	'' AS NROEXPEDIENTEIMPORT,
	dbo.FCXP.NOREFERENCIA AS NoDEDOCUMENTO, FACCONTROL AS NoDECONTROL,
	'' AS NOTADEBITO,'' AS NOTACREDITO,'01-REG' AS TIPODETRANSACCION, '' AS N_FACTURA,
	VLR_NETO AS VLRCOMPRAS,
	CASE WHEN VLR_IVA = 0 THEN   VLR_NETO  ELSE 0 END AS VLRSINDERECHO,
	CASE WHEN VLR_IVA <> 0 THEN   dbo.FCXP.VALOR  ELSE 0 END AS BASEIMPONIBLE,
	CASE WHEN VLR_IVA > 0 THEN   '12'  ELSE 0 END AS ALIC,
	VLR_IVA AS MONTODELIMPUESTO,
	CASE WHEN VLR_IVA > 0 THEN   dbo.FCXPI.VALOR ELSE 0 END AS MONTORETENIDO,
	0 AS ANTIVAIMPORT
	FROM dbo.FCXP INNER JOIN dbo.TER ON dbo.FCXP.IDTERCERO = dbo.TER.IDTERCERO LEFT JOIN dbo.FCXPI ON dbo.FCXP.CNSFCXP = dbo.FCXPI.CNSFCXP
	WHERE dbo.FCXP.PROCEDENCIA ='Compras'
GO
/*********************************************************************************/
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_HTXADM' AND TYPE='V')
BEGIN
 DROP VIEW VWK_HTXADM
END
GO
/*********************************************************************************/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW DBO.VWK_HTXADM WITH SCHEMABINDING
AS
   SELECT DBO.HTX.NOADMISION, DBO.HTX.IDSERVICIO, DBO.SER.DESCSERVICIO, COUNT_BIG(*) VECES
   FROM   DBO.HTX INNER JOIN DBO.SER ON DBO.HTX.IDSERVICIO = DBO.SER.IDSERVICIO
   GROUP BY DBO.HTX.NOADMISION, DBO.HTX.IDSERVICIO, DBO.SER.DESCSERVICIO
GO

CREATE UNIQUE CLUSTERED INDEX  VHTXADM_NOADMISION ON DBO.VWK_HTXADM(NOADMISION, IDSERVICIO)
GO
CREATE UNIQUE INDEX  VHTXADM_IDSERVICIO ON DBO.VWK_HTXADM(IDSERVICIO, NOADMISION)
GO
CREATE UNIQUE INDEX  VHTXADM_DESC ON DBO.VWK_HTXADM(DESCSERVICIO, IDSERVICIO, NOADMISION)
GO
/*********************************************************************************/
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_PAQ' AND TYPE='V')
BEGIN
 DROP VIEW VWK_PAQ
END
GO
/*********************************************************************************/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW DBO.VWK_PAQ WITH SCHEMABINDING
AS
   SELECT DBO.ESP.IDSERVICIO, DBO.SER.DESCSERVICIO, DBO.ESP.IDPROVEEDOR, DBO.ESP.IDPLAN, DBO.ESP.VALOR
   FROM   DBO.ESP INNER JOIN DBO.SER ON DBO.ESP.IDSERVICIO = DBO.SER.IDSERVICIO
   WHERE  dbo.ESP.PAQUETE = 1
GO

CREATE UNIQUE CLUSTERED INDEX  VWK_PAQIDPROVEEDOR ON DBO.VWK_PAQ(IDPROVEEDOR, IDPLAN, IDSERVICIO)
GO
CREATE UNIQUE INDEX  VWK_PAQIDSERVICIO ON DBO.VWK_PAQ(IDSERVICIO, IDPROVEEDOR, IDPLAN)
GO
CREATE UNIQUE INDEX  VWK_PAQDESC ON DBO.VWK_PAQ(DESCSERVICIO, IDSERVICIO, IDPROVEEDOR, IDPLAN)
GO
/*********************************************************************************/
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_HCADM' AND TYPE='V')
BEGIN
 DROP VIEW VWK_HCADM
END
GO
/*********************************************************************************/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE VIEW DBO.VWK_HCADM WITH SCHEMABINDING
AS
   SELECT DBO.HCA.NOADMISION, DBO.HCA.CLASEPLANTILLA, DBO.MPL.DESCPLANTILLA, COUNT_BIG(*) VECES
   FROM   DBO.HCA INNER JOIN DBO.MPL ON DBO.HCA.CLASEPLANTILLA= DBO.MPL.CLASEPLANTILLA
   WHERE  DBO.HCA.CLASE = 'HC'
   GROUP BY DBO.HCA.NOADMISION, DBO.HCA.CLASEPLANTILLA, DBO.MPL.DESCPLANTILLA
GO

CREATE UNIQUE CLUSTERED INDEX  VWK_HCADM_NOADMISION ON DBO.VWK_HCADM(NOADMISION, CLASEPLANTILLA)
GO
CREATE UNIQUE INDEX  VWK_HCADM_CLASEPLANTILLA ON DBO.VWK_HCADM(CLASEPLANTILLA, NOADMISION)
GO
CREATE UNIQUE INDEX  VWK_HCADM_DESC ON DBO.VWK_HCADM(DESCPLANTILLA, CLASEPLANTILLA, NOADMISION)
GO
/*************************************************************************************/
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_HCHRED' AND TYPE='V')
BEGIN
   DROP VIEW VWK_HCHRED
END
GO
/*************************************************************************************/
CREATE VIEW DBO.VWK_HCHRED
--WITH ENCRYPTION
AS 
   SELECT HCA.NOADMISION, 'OTRAS' AS CLASE, HCA.CONSECUTIVO, HCA.FECHA, NULL AS ITEMRED
   FROM   HCA INNER JOIN MPL ON HCA.CLASEPLANTILLA = MPL.CLASEPLANTILLA
   WHERE  MPL.ENEPICRISIS = 1 
   AND    HCA.ENEPICRISIS = 1 
   AND    MPL.CLASEPLANTILLA <> dbo.FNK_VALORVARIABLE('HCPLANTILLARED')  
   UNION       
   SELECT HRED.NOADMISION, 'EVO' AS CLASE, HRED.CONSECUTIVO, HRED.FECHA, HRED.ITEMRED
   FROM   HRED
   WHERE  HRED.ENEPICRISIS = 1  
GO 
/*************************************************************************************/
IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME= 'VWK_CXCDV_TTEC_GRUOP' AND TYPE='V')
BEGIN
   DROP VIEW VWK_CXCDV_TTEC_GRUOP
END
GO
/*************************************************************************************/
IF EXISTS (SELECT * FROM sys.objects WHERE name = 'VWK_CXCDV_TTEC_GRUOP' AND type = 'V')
BEGIN
   DROP VIEW VWK_CXCDV_TTEC_GRUOP
END
GO
CREATE VIEW DBO.VWK_CXCDV_TTEC_GRUOP
AS
   SELECT   A.ANO, A.MES,A.TIPOTTEC, A.IDTERCERO,
            SUM(A.SALDONETO) SALDONETO, SUM(A.PORVENCER) PORVENCER, SUM(A.D0_30) D0_30,       SUM(A.D31_60) D31_60,
            SUM(A.D61_90)    D61_90,    SUM(A.D91_120)   D91_120,   SUM(A.D121_150) D121_150, SUM(A.D151_180) D151_180,
            SUM(A.D181_360)  D181_360,  SUM(A.D361_MAS)  D361_MAS,  SUM(A.NORADICADA) NORADICADA
   FROM     VWK_CXCDV_TTEC A
   GROUP BY A.ANO, A.MES, A.TIPOTTEC, A.IDTERCERO
GO
