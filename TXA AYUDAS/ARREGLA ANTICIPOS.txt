DECLARE @ENCONTRADO    DECIMAL(9,2)
DECLARE @AFECTACOSTO   SMALLINT
DECLARE @CNSITRA       VARCHAR(20)
DECLARE @S             VARCHAR(1)
DECLARE @CNS           VARCHAR(20)
DECLARE @LONG          SMALLINT
DECLARE @P             SMALLINT
DECLARE @CONTADOR      SMALLINT  
DECLARE @CNSFCOM       VARCHAR(20)
DECLARE @CNSCTZ        VARCHAR(20)
DECLARE @IDTERCERO     VARCHAR(20)
DECLARE @IDITAR        VARCHAR(2)
DECLARE @IDTIPOMOV     VARCHAR(2)
DECLARE @SECONTABILIZA SMALLINT
DECLARE @CNSFCXP       VARCHAR(20)
DECLARE @IDCATEGORIA   VARCHAR(10) 

DECLARE @NOLOTE_CUR_DETALLE       VARCHAR(20)
DECLARE @IDARTICULO_CUR_DETALLE   VARCHAR(20)
DECLARE @CANTIDAD_CUR_DETALLE     DECIMAL(14,2)
DECLARE @PCOSTO_CUR_DETALLE       DECIMAL(16,3)
DECLARE @FECHAVENCE_CUR_DETALLE   DATETIME
DECLARE @NOLOTEPEDIDO_CUR_DETALLE VARCHAR(20)
DECLARE @DETALLE_CUR_DETALLE      VARCHAR(254)    
DECLARE @CNSFCOM_CUR_DETALLE      VARCHAR(20)  
DECLARE @TIPOACTIVO        VARCHAR(80)    
DECLARE @IDACTIVO          VARCHAR(20)    
DECLARE @VECES             DECIMAL(14,2)    
DECLARE @CANTIDAD          DECIMAL(14,2)    
DECLARE @IDARTICULO        VARCHAR(20)    
DECLARE @DESCRIPCION       VARCHAR(512)    
DECLARE @PCOSTO            DECIMAL(16,3)    
DECLARE @IDEVENTO          VARCHAR(10)    
DECLARE @CNSIACTH          VARCHAR(20)    
DECLARE @IDESTADOPENDIENTE VARCHAR(20)
DECLARE @NOLOTE            VARCHAR(20)
DECLARE @CCOSTO            VARCHAR(20) 
DECLARE @IDAREA            VARCHAR(20)
DECLARE @VIDAUTIL          INT
DECLARE @NODOCUMENTO       VARCHAR(20)
DECLARE @CUENTA            VARCHAR(16)
DECLARE @ESTADO            INT
DECLARE @NROCOMPROBANTE    VARCHAR(20)
DECLARE @FECHAMOV          DATETIME
DECLARE @TIPOBODEGA        VARCHAR(20)
DECLARE @ANO               VARCHAR(10) 
DECLARE @MES               VARCHAR(10) 
DECLARE @CERRADO           VARCHAR(10)       
DECLARE @EXCEPCION_CONT    INT
DECLARE @T_ANTICIPOS       DECIMAL(14,2)
DECLARE @CNSANT            VARCHAR(20)
DECLARE @ESTADO_ANT        VARCHAR(1)
DECLARE @RINVIMA           VARCHAR(20)
DECLARE @SELLOCALIDAD      VARCHAR(20)
DECLARE @CAPACIDAD         DECIMAL(14,2)
DECLARE @VLR_ANT_LEGAL DECIMAL(14,2)
DECLARE @VL_SALDO DECIMAL(14,2)
DECLARE @CNSMOV           VARCHAR(20) 
DECLARE 	@USUARIO          VARCHAR(12),
	@COMPANIA         VARCHAR(2),
	@SEDE             VARCHAR(5)


SELECT  @CNSMOV='0100882370',@SEDE='01',@COMPANIA='01',@CNSFCXP='01CM005283'

		SELECT @CNSFCOM = CNSFCOM FROM IMOV WHERE CNSMOV = @CNSMOV
		SELECT @T_ANTICIPOS = COALESCE(SUM(VALOR), 0) FROM FCXP WHERE CNSFCOM = @CNSFCOM AND PROCEDENCIA = 'Anticipos' AND ESTADO<>'A'
      SELECT @VLR_ANT_LEGAL =COALESCE(SUM(VALOR_LEG),0) FROM ANT WHERE CNSFCOM=@CNSFCOM AND ESTADO<>'A'
      SELECT @VL_SALDO=COALESCE(SALDO,0) FROM FCXP WHERE CNSFCXP=@CNSFCXP
      IF @VLR_ANT_LEGAL IS NULL
      SET @VLR_ANT_LEGAL=0
      IF @VL_SALDO IS NULL
      SET @VL_SALDO=0


      PRINT '@T_ANTICIPOS='+STR(@T_ANTICIPOS)
      PRINT '@VLR_ANT_LEGAL='+STR(@VLR_ANT_LEGAL)
      PRINT '@VL_SALDO='+STR(@VL_SALDO)

      SELECT @T_ANTICIPOS=COALESCE(@T_ANTICIPOS,0)-COALESCE(@VLR_ANT_LEGAL,0)

      IF @VL_SALDO<@T_ANTICIPOS AND COALESCE(@VLR_ANT_LEGAL,0)>0
      BEGIN
         SELECT @T_ANTICIPOS=@VL_SALDO
      END


      IF @T_ANTICIPOS IS NULL
      BEGIN 
         SELECT @T_ANTICIPOS=0
      END
		UPDATE FCXP SET VLR_ABONOS = VLR_ABONOS+@T_ANTICIPOS WHERE CNSFCXP = @CNSFCXP 
        
		PRINT 'VALOR QUE VA ='+LTRIM(RTRIM(STR((@T_ANTICIPOS- COALESCE(@VLR_ANT_LEGAL,0)))))

		IF  (@T_ANTICIPOS- COALESCE(@VLR_ANT_LEGAL,0)) > 0
		BEGIN
			
			SET @CNSANT=SPACE(20)  
			EXEC SPK_GENCONSECUTIVO @COMPANIA,@SEDE,'@NAT',@CNSANT OUTPUT
			SELECT @CNSANT = @SEDE + 'CM' + REPLACE(SPACE(6 - LEN(@CNSANT))+LTRIM(RTRIM(@CNSANT)),SPACE(1),0)
			
			PRINT '@CNSANT='+@CNSANT

			INSERT INTO ANT (CNSANT, CNSFCOM, DESCRIPCION, FECHA, VALORCXP, VALOR_LEG, NOREFERENCIA, F_FACTURAREF, F_VENCE, USUARIO, 
							ESTADO, CNSFCXP, CONTABILIZADO, NROCOMPROBANTE)
			SELECT @CNSANT, @CNSFCOM, 'Legalizaci√≥n A: '+TER.RAZONSOCIAL+' Ref. '+FCXP.NOREFERENCIA, GETDATE(), @T_ANTICIPOS, @T_ANTICIPOS, FCXP.NOREFERENCIA,
					FCXP.F_FACTURAREF, FCXP.F_VENCE, @USUARIO, 'I', @CNSFCXP, 0, ''
			FROM FCXP INNER JOIN TER ON TER.IDTERCERO = FCXP.IDTERCERO
			WHERE FCXP.CNSFCXP = @CNSFCXP
          
			PRINT 'DESPUES DEL INSERT'
			SELECT @ESTADO_ANT = ESTADO FROM ANT WHERE CNSANT = @CNSANT

			IF @ESTADO_ANT = 'I'
			BEGIN
				EXEC SPK_ANTICIPO_LEG_CXP @CNSFCOM, @CNSANT, @COMPANIA, @USUARIO, @SEDE
			END
		END
      EXEC SPK_CALCULOVALORESCXP @CNSFCXP
	